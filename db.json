{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/hexo-theme-matery/source/favicon.png","path":"favicon.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/gitment.css","path":"css/gitment.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/my-gitalk.css","path":"css/my-gitalk.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/matery.css","path":"css/matery.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/my.css","path":"css/my.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/matery.js","path":"js/matery.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/search.js","path":"js/search.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/avatar.jpg","path":"medias/avatar.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/logo.png","path":"medias/logo.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.css","path":"libs/aplayer/APlayer.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/animate/animate.min.css","path":"libs/animate/animate.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.css","path":"libs/aos/aos.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.js","path":"libs/aos/aos.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.css","path":"libs/dplayer/DPlayer.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/cryptojs/crypto-js.min.js","path":"libs/cryptojs/crypto-js.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.css","path":"libs/gitalk/gitalk.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment-default.css","path":"libs/gitment/gitment-default.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud-1.0.4.min.js","path":"libs/jqcloud/jqcloud-1.0.4.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud.css","path":"libs/jqcloud/jqcloud.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/masonry/masonry.pkgd.min.js","path":"libs/masonry/masonry.pkgd.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/busuanzi.pure.mini.js","path":"libs/others/busuanzi.pure.mini.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/clicklove.js","path":"libs/others/clicklove.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.css","path":"libs/tocbot/tocbot.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/scrollprogress/scrollProgress.min.js","path":"libs/scrollprogress/scrollProgress.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.min.js","path":"libs/tocbot/tocbot.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/cover.jpg","path":"medias/cover.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/13.jpg","path":"medias/featureimages/13.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/15.jpg","path":"medias/featureimages/15.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/16.jpg","path":"medias/featureimages/16.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/2.jpg","path":"medias/featureimages/2.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/22.jpg","path":"medias/featureimages/22.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/23.jpg","path":"medias/featureimages/23.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/21.jpg","path":"medias/featureimages/21.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/5.jpg","path":"medias/featureimages/5.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/7.jpg","path":"medias/featureimages/7.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/8.jpg","path":"medias/featureimages/8.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/reward/alipay.jpg","path":"medias/reward/alipay.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/reward/wechat.png","path":"medias/reward/wechat.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.js","path":"libs/aplayer/APlayer.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.js","path":"libs/dplayer/DPlayer.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment.js","path":"libs/gitment/gitment.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jquery/jquery-2.2.0.min.js","path":"libs/jquery/jquery-2.2.0.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/valine/Valine.min.js","path":"libs/valine/Valine.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/0.jpg","path":"medias/banner/0.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/2.jpg","path":"medias/banner/2.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/0.jpg","path":"medias/featureimages/0.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/10.jpg","path":"medias/featureimages/10.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/11.jpg","path":"medias/featureimages/11.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/1.jpg","path":"medias/featureimages/1.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/12.jpg","path":"medias/featureimages/12.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/14.jpg","path":"medias/featureimages/14.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/17.jpg","path":"medias/featureimages/17.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/18.jpg","path":"medias/featureimages/18.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/19.jpg","path":"medias/featureimages/19.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/3.jpg","path":"medias/featureimages/3.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/20.jpg","path":"medias/featureimages/20.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/4.jpg","path":"medias/featureimages/4.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/6.jpg","path":"medias/featureimages/6.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/9.jpg","path":"medias/featureimages/9.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.min.js","path":"libs/gitalk/gitalk.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/css/lightgallery.min.css","path":"libs/lightGallery/css/lightgallery.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.eot","path":"libs/lightGallery/fonts/lg.eot","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.ttf","path":"libs/lightGallery/fonts/lg.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.svg","path":"libs/lightGallery/fonts/lg.svg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.woff","path":"libs/lightGallery/fonts/lg.woff","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/loading.gif","path":"libs/lightGallery/img/loading.gif","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/video-play.png","path":"libs/lightGallery/img/video-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/youtube-play.png","path":"libs/lightGallery/img/youtube-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/vimeo-play.png","path":"libs/lightGallery/img/vimeo-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.css","path":"libs/materialize/materialize.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.eot","path":"libs/share/fonts/iconfont.eot","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.svg","path":"libs/share/fonts/iconfont.svg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.woff","path":"libs/share/fonts/iconfont.woff","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.ttf","path":"libs/share/fonts/iconfont.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/css/share.min.css","path":"libs/share/css/share.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/js/jquery.share.min.js","path":"libs/share/js/jquery.share.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/js/social-share.min.js","path":"libs/share/js/social-share.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/valine/av-min.js","path":"libs/valine/av-min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/1.jpg","path":"medias/banner/1.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/3.jpg","path":"medias/banner/3.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/5.jpg","path":"medias/banner/5.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/6.jpg","path":"medias/banner/6.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/js/lightgallery-all.min.js","path":"libs/lightGallery/js/lightgallery-all.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.js","path":"libs/materialize/materialize.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/FontAwesome.otf","path":"libs/awesome/fonts/FontAwesome.otf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.woff","path":"libs/awesome/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.woff2","path":"libs/awesome/fonts/fontawesome-webfont.woff2","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/font-awesome.min.css","path":"libs/awesome/css/font-awesome.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/4.jpg","path":"medias/banner/4.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.ttf","path":"libs/awesome/fonts/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.eot","path":"libs/awesome/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.svg","path":"libs/awesome/fonts/fontawesome-webfont.svg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/echarts/echarts.min.js","path":"libs/echarts/echarts.min.js","modified":1,"renderable":1}],"Cache":[{"_id":"themes/hexo-theme-matery/.gitignore","hash":"eaa3d84cb77d92a21b111fd1e37f53edc1ff9de0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/LICENSE","hash":"7df059597099bb7dcf25d2a9aedfaf4465f72d8d","modified":1556891842000},{"_id":"themes/hexo-theme-matery/README.md","hash":"7e1c881e66f218cda85e86761a4853ed6b68e33c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/README_CN.md","hash":"8919b255c5a59f2c894134d2d51cf36c5b619196","modified":1556891842000},{"_id":"themes/hexo-theme-matery/_config.yml","hash":"dcf7400d63b7dc514d00e2a6a3af56b1c08c94e6","modified":1556897228855},{"_id":"source/_data/friends.json","hash":"27895f6c03445bdf145e6aa92e280065cf68736f","modified":1556893103641},{"_id":"source/friends/index.md","hash":"2be114a59665f3f4e39e39e1db1173e98d7b84c4","modified":1556893079218},{"_id":"source/categories/index.md","hash":"57974cb8107db54818077da09cd4851bfdac9716","modified":1556892969618},{"_id":"source/about/index.md","hash":"a6af6b4554f3b1eb8bd952f734ba135fead32316","modified":1556893051666},{"_id":"source/tags/index.md","hash":"6c223043ba32b7c76c33eafceeff9ed879520bfb","modified":1556892990485},{"_id":"themes/hexo-theme-matery/languages/default.yml","hash":"2c4d4e72f0fb3431260643dcb85af11655fabe13","modified":1556891842000},{"_id":"themes/hexo-theme-matery/languages/zh-CN.yml","hash":"db4b71662d408255eebd633fa3ded8d039122df3","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/about.ejs","hash":"ee639d0310867976b3e5fb9f92c215a17a433703","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/archive.ejs","hash":"3148f475a51aea398765b4114906d24f5c9316f2","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/categories.ejs","hash":"8e54665cc25d7c333da7d9f312987190be6215da","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/category.ejs","hash":"1963cae03c384d75b04a02e23b4c4e9917b15adb","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/friends.ejs","hash":"89c47cf1eb2cf1feb8a8d06f4eb7c76b713f79c0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/index.ejs","hash":"fe1208a55b41529cf6df2991211800a071b4c7fd","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/layout.ejs","hash":"10f20cf017af6f46c035e5f7080fa4b70a9dd239","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/post.ejs","hash":"f9662a96d0f497a3b2731472b8ad871c7cbdf13a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/tag.ejs","hash":"f29bc13f05f4aa3a3826c1fa7fe9f52b5a06583b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/tags.ejs","hash":"cf9517aa6a0111355121f44615d6923e312283c7","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/favicon.png","hash":"20674c497b75fc889194b47fd18ecea12303d8ec","modified":1556891842000},{"_id":"source/_posts/golang/怎么用Gin去构建一个RESTful API Golang Service.md","hash":"d6e263123ea1e14e72c6f12f4420e141457d8b56","modified":1556896042024},{"_id":"source/_posts/laravel/Laravel简单分组统计.md","hash":"594cbcbd947d9daf1e59e72432fc4a726f7db3e0","modified":1556895821463},{"_id":"source/_posts/linux/LAMP学习之Apache添加SSL证书.md","hash":"d181b89cf7ca91459aa816ab165fe4cacfe4c83e","modified":1556897195477},{"_id":"themes/hexo-theme-matery/layout/_partial/back-top.ejs","hash":"8c91d2088c9bb323246b054d4940bde6cead6828","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/bg-cover-content.ejs","hash":"2d9a44f6fbed4d117bbc403095d9a810cb05303c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/bg-cover.ejs","hash":"02191109712f61c0e487b8f0b8466597181a9004","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/disqus.ejs","hash":"a0f53d1a9b579d52e52ccad8c6e330bf3b89547e","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/footer.ejs","hash":"7cc83cfe629ce3049382a5e943aa860133efe58d","modified":1556893819427},{"_id":"themes/hexo-theme-matery/layout/_partial/gitalk.ejs","hash":"e4c5bf28ddc29519eee8debe79cce45bf279adeb","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/github-link.ejs","hash":"3aeb581bd78ab8e15b858e4c44c03bcf92f20b9e","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/gitment.ejs","hash":"0abfb51dc80ad063fb2118bee28de6bb8d99ed4e","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/google-analytics.ejs","hash":"5f4992205617da5f8cc5863c62b5ec46e414e2fb","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/head.ejs","hash":"1f337fe1343f87fc958eded799a9ac93fc194e87","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/header.ejs","hash":"e253c813b3ee5ed924700a95133741802e58adc5","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/index-cover.ejs","hash":"6583c00323d891a03343b6a621a0484a68d74f8a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/mobile-nav.ejs","hash":"b70a2d40677d64d6b56fc51ac1331ad3a50e777c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/livere.ejs","hash":"9c3401b42ea7f26410a5593bae93ada7e57b43be","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/navigation.ejs","hash":"20216e7ad6b48d4a4f8d11d6881e667e5186820f","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/paging.ejs","hash":"68a24cad2b2049c4dc3a250aa30bf4256f9e50cb","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/post-cover.ejs","hash":"5b423384b9c0fe77acc4247a8a85304022e5bd2a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/post-detail-toc.ejs","hash":"d4114c22126704cc1754d6d28cb00aec020b428b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/post-detail.ejs","hash":"4f326331ad93293bf11f7e80e9918b572bd92843","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/post-statis.ejs","hash":"2b2fe8e8e94e65c52a4dbd454168e9b9df6baf10","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/prev-next.ejs","hash":"1e3d523ff4c3234cf311c895767b0d7ce0d63a0d","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/reward.ejs","hash":"3dff4f6a73973b0b32f40604244255f3c2a5bb78","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/search.ejs","hash":"942609b9240d5c8c09b24562fc8fb31eabe1cae4","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/share.ejs","hash":"34f8e4250bb66012026aa50686a7c89a0414ca1b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/social-link.ejs","hash":"62e10bf4577946190e9c31dcdc2799a4ad1d00dd","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_partial/valine.ejs","hash":"90527186fc8ed906eb1f20b59bc7f86caab9087b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/category-cloud.ejs","hash":"a5a10d6fa66a389d0253d7a52e0a646af6e8e9be","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/category-radar.ejs","hash":"f5561dd7d53d68897a33090bf677719213459b19","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/music.ejs","hash":"8eafddbd73fed80e85c66d49837c1a241b087258","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/dream.ejs","hash":"684450f0b42f89ab70370c5248b34e55b7adf6fc","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/my-gallery.ejs","hash":"f81eb2891bea326908057029e2a063001371ba9b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/my-projects.ejs","hash":"b9bf70ec5d97b0e14bb1b4f60f92db7680be5949","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/my-skills.ejs","hash":"bd0edf8dad95b2255890d59fb6d6ed6f2eab9c2f","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/post-calendar.ejs","hash":"0b0a3eb6af29bf0d55d535958c44b01c0f18d10d","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/post-charts.ejs","hash":"af0604623db37ef800bb7ad48028d18d99efbbc3","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/tag-cloud.ejs","hash":"a3725f0e3a405acb595b04630a27765b537fb580","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/recommend.ejs","hash":"babaa0cb32146870785449c70748721235e4eff0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/tag-wordcloud.ejs","hash":"cb7a0151cd20e90351e151c22bca9d4c3112f234","modified":1556891842000},{"_id":"themes/hexo-theme-matery/layout/_widget/video.ejs","hash":"bda810cc135b52f834f1c1ccf52defccacace714","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/css/gitment.css","hash":"2bd15cc17dca35ac3ecc0acf167a23a1dd362acd","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/css/my-gitalk.css","hash":"eeda46a83d0db1cc239a9cd27d544faf663f9883","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/css/matery.css","hash":"1ce9cc774997abba3436f8dbed4380c6a1fb8226","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/css/my.css","hash":"497e50351f7838f8546cac76850a42e7e380a110","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/js/matery.js","hash":"92f07106944f5ef7cd72e84bb3534513d00eebe1","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/js/search.js","hash":"499e11786efbb04815b54a1de317cc8606a37555","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/avatar.jpg","hash":"b7f8ca0c682f95d93f002c845aafbcb508ec2b0f","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/logo.png","hash":"4050259723bd418648ec40028a8020364e57a6a3","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/animate/animate.min.css","hash":"97afa151569f046b2e01f27c1871646e9cd87caf","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.css","hash":"191a3705a8f63e589a50a0ff2f2c5559f1a1b6b2","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.js","hash":"02bfb40b0c4b6e9b0b4081218357145cbb327d74","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.css","hash":"f7d19655f873b813ffba5d1a17145c91f82631b8","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/cryptojs/crypto-js.min.js","hash":"5989527a378b55011a59522f41eeb3981518325c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.css","hash":"3aac1db83b0135c521187254ff302d125cc30706","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment-default.css","hash":"2903c59ee06b965bef32e937bd69f5b0b2190717","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud-1.0.4.min.js","hash":"257eaae3020599e4939f50d5008a743827f25b8c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud.css","hash":"20d9f11a19d95c70e27cb922e0d6dccbec4eae89","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/masonry/masonry.pkgd.min.js","hash":"ff940b4ea68368ca0e4d5560cbb79fb147dfc3c5","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/others/busuanzi.pure.mini.js","hash":"6e41f31100ae7eb3a6f23f2c168f6dd56e7f7a9a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/others/clicklove.js","hash":"6a39b8c683ba5dcd92f70c6ab45d1cfac3213e8e","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.css","hash":"15601837bf8557c2fd111e4450ed4c8495fd11a0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/scrollprogress/scrollProgress.min.js","hash":"777ffe5d07e85a14fbe97d846f45ffc0087251cc","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.min.js","hash":"5ec27317f0270b8cf6b884c6f12025700b9a565c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/cover.jpg","hash":"d4957ff7cc5e88555cd840f2956ab0561e6f1ccf","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/13.jpg","hash":"66706dfde7d910182c2f1dbadd0e9e917630b8dd","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/15.jpg","hash":"5cf9fc64d5d74ab6ba69bb8bff580fdc22ba32d0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/16.jpg","hash":"9cac6b80b0cc8959fc8aabfbd1adcab79ebebfc9","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/2.jpg","hash":"16f1d89cdba4dce935ac0f12599e0fcfda543a93","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/22.jpg","hash":"bf5b59d193e5ca089a7fff034c222bfa2c4dc41f","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/23.jpg","hash":"ed5ac9f616d3b99af5188a10b1761884c37e93e5","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/21.jpg","hash":"d70b088850c3565e5b5bb9eb8fe4abe688c964cf","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/5.jpg","hash":"c3c1f36a1b1886037db604f151f335cd4599e970","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/7.jpg","hash":"a0246a4a560438938489cdd154e35f172b3f31b0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/8.jpg","hash":"5a46ca4ab4c4ab2101a2af77a31a8878bccc483c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/reward/alipay.jpg","hash":"1abc719b95d1b26f1f898e6b0a9b7609146e332f","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/reward/wechat.png","hash":"fe93385aa92fe328e01c8221a80b039be9e4e140","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.js","hash":"c3bad7b265574fab0ae4d45867422ea1cb9d6599","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment.js","hash":"28c02c45ce568e084cd1041dc493f83f9c6c88c6","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/jquery/jquery-2.2.0.min.js","hash":"5d7e5bbfa540f0e53bd599e4305e1a4e815b5dd1","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/valine/Valine.min.js","hash":"031c1a5640d64ab3b829395ad5a7596b9fb122e6","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/0.jpg","hash":"1f2ec55fe7825475fde2601573bb622f0bf2acba","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/2.jpg","hash":"8d3c8391ff161eec70f66d69e5545a9468cc52ef","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/0.jpg","hash":"2066cdda98ad0035071cd4aa7bd696eb078c0b6d","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/10.jpg","hash":"838e704942de076c60894d14e5f280e2724b6f68","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/11.jpg","hash":"9ed45f95b83626e3d91d6c405eb8bfe6fcb9736a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/1.jpg","hash":"d16e28bd23ea3a63643826dde5eea6b7a9bdda5d","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/12.jpg","hash":"047be4239dd7e0be83243ee6b49a392a61f16b9a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/14.jpg","hash":"8aeb816faca2d5eaea4cce9e881d6ff87b8c7cf1","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/17.jpg","hash":"f168ca5b046d10a878a7b0bcfab540e2c4428887","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/18.jpg","hash":"ae23fdfaa59bc57b7ed49e90c5d59e4b68e1eea5","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/19.jpg","hash":"57bc7c804b78b5cceb4eb1f9e51b734b75151b71","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/3.jpg","hash":"5e879652e032f02961a331b598a50b60ebe80a39","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/20.jpg","hash":"8271c4a327632b566ea62f546c083d08a0528e72","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/4.jpg","hash":"4eea5bdb5724ef1ed65790e481eda0d2fb176bf0","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/6.jpg","hash":"c63ff64bdd5f6c82da8804c7248fc519d23eaf0b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/9.jpg","hash":"815c84778b721e3606c2bd7c099c7de7c53251ba","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.min.js","hash":"734f56442e62fe55f677e8ccae7f175445667767","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/css/lightgallery.min.css","hash":"1b7227237f9785c66062a4811508916518e4132c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.eot","hash":"54caf05a81e33d7bf04f2e420736ce6f1de5f936","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.ttf","hash":"f6421c0c397311ae09f9257aa58bcd5e9720f493","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.svg","hash":"9a732790adc004b22022cc60fd5f77ec4c8e3e5a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.woff","hash":"3048de344dd5cad4624e0127e58eaae4b576f574","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/loading.gif","hash":"15a76af2739482d8de7354abc6d8dc4fca8d145e","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/video-play.png","hash":"fbfdbe06aebf7d0c00da175a4810cf888d128f11","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/youtube-play.png","hash":"39150b45ec5fc03155b7ebeaa44f1829281788e2","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/vimeo-play.png","hash":"1142b47de219dddfba2e712cd3189dec0c8b7bee","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.css","hash":"80ae4aa0dba3634dd9bf59586d541d2dd8d8191c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.eot","hash":"00ff749c8e202401190cc98d56087cdda716abe4","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.svg","hash":"f0a1b849868a6bf351ff98dc3924a4e7254eb88b","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.woff","hash":"2e3fce1dcfbd6e2114e7bfbeaf72d3c62e15a1bd","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.ttf","hash":"afd898f59d363887418669520b24d175f966a083","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/css/share.min.css","hash":"8a778a86f3ce9a042df6be63a9f1039631e351a5","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/js/jquery.share.min.js","hash":"16ce82901ca0e302cf47a35fb10f59009a5e7eb9","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/share/js/social-share.min.js","hash":"4df722bafde2c5d8faaace0d1f894798385a8793","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/valine/av-min.js","hash":"2577e72b52b736d99649f9e95be8976d58563333","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/1.jpg","hash":"c3d5ab183b39a7140941b8375e29498f9d24f343","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/3.jpg","hash":"d4957ff7cc5e88555cd840f2956ab0561e6f1ccf","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/5.jpg","hash":"4a08deec1dd5b4f1490e8fc23adfb75a0f88b0c4","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/6.jpg","hash":"62e9586a8cec91a160f147c424a3d1d1aea360f9","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/js/lightgallery-all.min.js","hash":"9f5ef4bc8a0a3c746ca4f3c3e6d64493b1a977d8","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.js","hash":"c8b4c65651921d888cf5f27430dfe2ad190d35bf","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/medias/banner/4.jpg","hash":"56850c3139cbd72a0eff0c35d8fac32c9c66dd6a","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1556891842000},{"_id":"themes/hexo-theme-matery/source/libs/echarts/echarts.min.js","hash":"9496f386a0da4601cad22c479cc5543913a4d67f","modified":1556891842000}],"Category":[{"name":"Laravel","_id":"cjv88f7bn0006i0cdp04w8h1y"},{"name":"Linux","_id":"cjv88f7br0008i0cdhcnnswiy"},{"name":"Golang","_id":"cjv88f7cc000ni0cdk2koyfxz"},{"name":"Oracle","_id":"cjv88jaul000zi0cd8vi2pbvq"}],"Data":[{"_id":"friends","data":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}],"Page":[{"title":"categories","date":"2018-09-30T09:25:30.000Z","type":"categories","layout":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2018-09-30 17:25:30\ntype: \"categories\"\nlayout: \"categories\"\n---","updated":"2019-05-03T14:16:09.618Z","path":"categories/index.html","comments":1,"_id":"cjv88f79e0000i0cdpqfvctsa","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"about","date":"2018-09-30T09:25:30.000Z","type":"about","layout":"about","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2018-09-30 17:25:30\ntype: \"about\"\nlayout: \"about\"\n---","updated":"2019-05-03T14:17:31.666Z","path":"about/index.html","comments":1,"_id":"cjv88f79i0001i0cdm7gwv7uf","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"friends","date":"2018-12-12T13:25:30.000Z","type":"friends","layout":"friends","_content":"","source":"friends/index.md","raw":"---\ntitle: friends\ndate: 2018-12-12 21:25:30\ntype: \"friends\"\nlayout: \"friends\"\n---","updated":"2019-05-03T14:17:59.218Z","path":"friends/index.html","comments":1,"_id":"cjv88f79j0002i0cdrff12vlk","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"tags","date":"2018-09-30T10:23:38.000Z","type":"tags","layout":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2018-09-30 18:23:38\ntype: \"tags\"\nlayout: \"tags\"\n---","updated":"2019-05-03T14:16:30.485Z","path":"tags/index.html","comments":1,"_id":"cjv88f79k0003i0cddxgv16fj","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":""}],"Post":[{"title":"Laravel简单的分组统计","date":"2018-09-07T01:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n## 问题描述\n\n> 最近在开发博客的时候需要对分类进行一个简单的数量统计，以此片文章来记录学习过程\n\n![博客分类](http://oss.anonycurse.cn/article/images/20180926/YdmZ31Y85Y9WKqz7mhe8SLIh8hVxrDecB4hRPVzj.png)\n\n## 解决方法\n> laravel 的DB 支持各种查询，最开始不怎么会，最后各种百度还是搞定了\n\n### 数据库表\n![文章表](http://oss.anonycurse.cn/article/images/20180926/l8LWYNe2oPrQb6HNUPDbuK971OM8jKApPDEDUfZm.png)\n![分类表](http://oss.anonycurse.cn/article/images/20180926/RxBuEJN65Yy63SijYlkgoez0wrZUjyf8gsbBobO1.png)\n\n### 查询语句\n```PHP\n$article_groups = DB::table('article_group')\n\t->select([\n\t\t'article_group.name as name',\n\t\tDB::raw('count(`blog_article`.`id`) as count'),\n\n\t])\n\t->leftJoin('article','article_group.id','=','article.g_id')\n\t->groupBy('article_group.id')\n\t->get();\ndump($article_groups);\n```\n### 查询结果\n![查询结果](http://oss.anonycurse.cn/article/images/20180926/qb06QCqFjjYOiBwOyjhWNDFSoroU71UyPVNcAOTi.png)\n\n### SQL\n```SQL\nSELECT \n\tblog_article_group.id as id,\n\tblog_article_group.name as name,\n\tcount(blog_article.id) AS count\nFROM blog_article_group\nLEFT JOIN blog_article ON blog_article_group.id = blog_article.g_id\nGROUP BY blog_article_group.id\n```\n\n## 总结讨论\n\n每种语言都会遇到类似的情况，在学习Golang的时候也会遇到类似的情况\n\n## 相关资源\n[Laravel 一条 SQL 如何 count 多个字段，Laravel 一条 sql 查询每个分类的数量](https://laravel-china.org/articles/4692/laravel-a-sql-how-to-count-multiple-fields-laravel-a-sql-query-the-number-of-each-category)","source":"_posts/laravel/Laravel简单分组统计.md","raw":"---\ntitle: Laravel简单的分组统计\ndate: 2018-09-07 09:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Laravel\ntags:\n  - PHP\n  - Laravel\n  - MySQL\n---\n\n\n## 问题描述\n\n> 最近在开发博客的时候需要对分类进行一个简单的数量统计，以此片文章来记录学习过程\n\n![博客分类](http://oss.anonycurse.cn/article/images/20180926/YdmZ31Y85Y9WKqz7mhe8SLIh8hVxrDecB4hRPVzj.png)\n\n## 解决方法\n> laravel 的DB 支持各种查询，最开始不怎么会，最后各种百度还是搞定了\n\n### 数据库表\n![文章表](http://oss.anonycurse.cn/article/images/20180926/l8LWYNe2oPrQb6HNUPDbuK971OM8jKApPDEDUfZm.png)\n![分类表](http://oss.anonycurse.cn/article/images/20180926/RxBuEJN65Yy63SijYlkgoez0wrZUjyf8gsbBobO1.png)\n\n### 查询语句\n```PHP\n$article_groups = DB::table('article_group')\n\t->select([\n\t\t'article_group.name as name',\n\t\tDB::raw('count(`blog_article`.`id`) as count'),\n\n\t])\n\t->leftJoin('article','article_group.id','=','article.g_id')\n\t->groupBy('article_group.id')\n\t->get();\ndump($article_groups);\n```\n### 查询结果\n![查询结果](http://oss.anonycurse.cn/article/images/20180926/qb06QCqFjjYOiBwOyjhWNDFSoroU71UyPVNcAOTi.png)\n\n### SQL\n```SQL\nSELECT \n\tblog_article_group.id as id,\n\tblog_article_group.name as name,\n\tcount(blog_article.id) AS count\nFROM blog_article_group\nLEFT JOIN blog_article ON blog_article_group.id = blog_article.g_id\nGROUP BY blog_article_group.id\n```\n\n## 总结讨论\n\n每种语言都会遇到类似的情况，在学习Golang的时候也会遇到类似的情况\n\n## 相关资源\n[Laravel 一条 SQL 如何 count 多个字段，Laravel 一条 sql 查询每个分类的数量](https://laravel-china.org/articles/4692/laravel-a-sql-how-to-count-multiple-fields-laravel-a-sql-query-the-number-of-each-category)","slug":"laravel/Laravel简单分组统计","published":1,"updated":"2019-05-03T15:03:41.463Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjv88f7bd0004i0cde0o4q5sn","content":"<h2 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h2><blockquote>\n<p>最近在开发博客的时候需要对分类进行一个简单的数量统计，以此片文章来记录学习过程</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20180926/YdmZ31Y85Y9WKqz7mhe8SLIh8hVxrDecB4hRPVzj.png\" alt=\"博客分类\"></p>\n<h2 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h2><blockquote>\n<p>laravel 的DB 支持各种查询，最开始不怎么会，最后各种百度还是搞定了</p>\n</blockquote>\n<h3 id=\"数据库表\"><a href=\"#数据库表\" class=\"headerlink\" title=\"数据库表\"></a>数据库表</h3><p><img src=\"http://oss.anonycurse.cn/article/images/20180926/l8LWYNe2oPrQb6HNUPDbuK971OM8jKApPDEDUfZm.png\" alt=\"文章表\"><br><img src=\"http://oss.anonycurse.cn/article/images/20180926/RxBuEJN65Yy63SijYlkgoez0wrZUjyf8gsbBobO1.png\" alt=\"分类表\"></p>\n<h3 id=\"查询语句\"><a href=\"#查询语句\" class=\"headerlink\" title=\"查询语句\"></a>查询语句</h3><pre class=\" language-PHP\"><code class=\"language-PHP\">$article_groups = DB::table('article_group')\n    ->select([\n        'article_group.name as name',\n        DB::raw('count(`blog_article`.`id`) as count'),\n\n    ])\n    ->leftJoin('article','article_group.id','=','article.g_id')\n    ->groupBy('article_group.id')\n    ->get();\ndump($article_groups);\n</code></pre>\n<h3 id=\"查询结果\"><a href=\"#查询结果\" class=\"headerlink\" title=\"查询结果\"></a>查询结果</h3><p><img src=\"http://oss.anonycurse.cn/article/images/20180926/qb06QCqFjjYOiBwOyjhWNDFSoroU71UyPVNcAOTi.png\" alt=\"查询结果\"></p>\n<h3 id=\"SQL\"><a href=\"#SQL\" class=\"headerlink\" title=\"SQL\"></a>SQL</h3><pre class=\" language-SQL\"><code class=\"language-SQL\">SELECT \n    blog_article_group.id as id,\n    blog_article_group.name as name,\n    count(blog_article.id) AS count\nFROM blog_article_group\nLEFT JOIN blog_article ON blog_article_group.id = blog_article.g_id\nGROUP BY blog_article_group.id\n</code></pre>\n<h2 id=\"总结讨论\"><a href=\"#总结讨论\" class=\"headerlink\" title=\"总结讨论\"></a>总结讨论</h2><p>每种语言都会遇到类似的情况，在学习Golang的时候也会遇到类似的情况</p>\n<h2 id=\"相关资源\"><a href=\"#相关资源\" class=\"headerlink\" title=\"相关资源\"></a>相关资源</h2><p><a href=\"https://laravel-china.org/articles/4692/laravel-a-sql-how-to-count-multiple-fields-laravel-a-sql-query-the-number-of-each-category\" target=\"_blank\" rel=\"noopener\">Laravel 一条 SQL 如何 count 多个字段，Laravel 一条 sql 查询每个分类的数量</a></p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h2><blockquote>\n<p>最近在开发博客的时候需要对分类进行一个简单的数量统计，以此片文章来记录学习过程</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20180926/YdmZ31Y85Y9WKqz7mhe8SLIh8hVxrDecB4hRPVzj.png\" alt=\"博客分类\"></p>\n<h2 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h2><blockquote>\n<p>laravel 的DB 支持各种查询，最开始不怎么会，最后各种百度还是搞定了</p>\n</blockquote>\n<h3 id=\"数据库表\"><a href=\"#数据库表\" class=\"headerlink\" title=\"数据库表\"></a>数据库表</h3><p><img src=\"http://oss.anonycurse.cn/article/images/20180926/l8LWYNe2oPrQb6HNUPDbuK971OM8jKApPDEDUfZm.png\" alt=\"文章表\"><br><img src=\"http://oss.anonycurse.cn/article/images/20180926/RxBuEJN65Yy63SijYlkgoez0wrZUjyf8gsbBobO1.png\" alt=\"分类表\"></p>\n<h3 id=\"查询语句\"><a href=\"#查询语句\" class=\"headerlink\" title=\"查询语句\"></a>查询语句</h3><pre><code class=\"PHP\">$article_groups = DB::table(&#39;article_group&#39;)\n    -&gt;select([\n        &#39;article_group.name as name&#39;,\n        DB::raw(&#39;count(`blog_article`.`id`) as count&#39;),\n\n    ])\n    -&gt;leftJoin(&#39;article&#39;,&#39;article_group.id&#39;,&#39;=&#39;,&#39;article.g_id&#39;)\n    -&gt;groupBy(&#39;article_group.id&#39;)\n    -&gt;get();\ndump($article_groups);\n</code></pre>\n<h3 id=\"查询结果\"><a href=\"#查询结果\" class=\"headerlink\" title=\"查询结果\"></a>查询结果</h3><p><img src=\"http://oss.anonycurse.cn/article/images/20180926/qb06QCqFjjYOiBwOyjhWNDFSoroU71UyPVNcAOTi.png\" alt=\"查询结果\"></p>\n<h3 id=\"SQL\"><a href=\"#SQL\" class=\"headerlink\" title=\"SQL\"></a>SQL</h3><pre><code class=\"SQL\">SELECT \n    blog_article_group.id as id,\n    blog_article_group.name as name,\n    count(blog_article.id) AS count\nFROM blog_article_group\nLEFT JOIN blog_article ON blog_article_group.id = blog_article.g_id\nGROUP BY blog_article_group.id\n</code></pre>\n<h2 id=\"总结讨论\"><a href=\"#总结讨论\" class=\"headerlink\" title=\"总结讨论\"></a>总结讨论</h2><p>每种语言都会遇到类似的情况，在学习Golang的时候也会遇到类似的情况</p>\n<h2 id=\"相关资源\"><a href=\"#相关资源\" class=\"headerlink\" title=\"相关资源\"></a>相关资源</h2><p><a href=\"https://laravel-china.org/articles/4692/laravel-a-sql-how-to-count-multiple-fields-laravel-a-sql-query-the-number-of-each-category\" target=\"_blank\" rel=\"noopener\">Laravel 一条 SQL 如何 count 多个字段，Laravel 一条 sql 查询每个分类的数量</a></p>\n"},{"title":"LAMP学习之Apache添加SSL证书","date":"2019-04-07T01:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"cover":false,"<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n## LAMP学习之Apache添加SSL证书\n\n## 环境装备\n- 已经安装好了的一套Lamp环境，和\n- 阅读过Httpd所有官方文档的的自信。\n\n## 开始安装\n### 1.下载证书\n\n> 进入阿里云域名管理，再点击右边的SSL\n\n![进入SSL](http://oss.anonycurse.cn/article/images/20181016/mYcEkWLm1bhlJeFDGxXcsBsci3tMKWLhNFEvhBRs.png \"进入SSL\")\n\n> 申请完证书后记得点击左上角返回列表下载证书\n![申请SSL](http://oss.anonycurse.cn/article/images/20181016/LA9MaQ3IqD4QMrB5OhAhPxXPG1PUYssGOfOh5qcn.png \"申请SSL\")\n\n\n\n![下载证书](http://oss.anonycurse.cn/article/images/20181016/W9fdbI03VOMYjSJszyHRM0bGlwKA9jT4ukwV2jkZ.png \"下载证书\")\n\n\n![下载证书2](http://oss.anonycurse.cn/article/images/20181016/muxi4oUZfjctSdoYw4CiLr9z2eRbBzv6uuksYZCR.png \"下载证书2\")\n\n### 上传证书\n> 我在网上看见有人把SSL证书直接放在项目里面，对于这种举动我感觉还是有点小怕，\n最后我觉得证书放在在apache 的conf目录下\n\n![证书路径](http://oss.anonycurse.cn/article/images/20181016/1njDCGjbCdHEEuBHLTpxbZHshGTQuuCNRuu1TNbQ.png \"证书路径\")\n\n### 修改配置\n- 1.httpd.conf\n\n```apache\n#1. 开启必要的module\nLoadModule socache_shmcb_module modules/mod_socache_shmcb.so\nLoadModule ssl_module modules/mod_ssl.so\n\n#2.开启SSL配置文件\nInclude conf/extra/httpd-ssl.conf\n\n#3.导入外部主机配置文件\n#注意，我安装Apache的时候是给每个网站添加一个配置文件，所以会有一个vhosts专门存放网站主机配置文件\n# Virtual hosts\nInclude conf/vhosts/*.conf\n```\n- conf/extra/httpd-ssl.conf\n> 这个配置文件和httpd.conf有点类型，存放了一些关于HTTPS的配置，包括一些全局配置和一个默认的虚拟主机配置，这个我喜欢删掉默认想虚拟主机，只保留一些全局配置就好\n\n```apache\nListen 443\n\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n\nSSLProtocol all -SSLv2 -SSLv3\nSSLProxyProtocol all -SSLv3\n\nSSLPassPhraseDialog  builtin\n\nSSLSessionCache        \"shmcb:/web/bin/apache/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\n```\n- conf/vhosts/www.angexinjia.com.conf\n\n```apache\n#默认HTTP主机\n<VirtualHost *:80>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com www.anonycurse.com\n\n#    ErrorLog logs/www.anonycurse.com.error.log\n    CustomLog logs/www.anonycurse.com.access.log common\n\n# Laravel 项目配置【开启HTTPS后可以注释掉】\n#    <Directory \"/web/www/www.anonycurse.com/public\">\n#        AllowOverride All\n#        Require all granted\n#        DirectoryIndex index.php\n#    </Directory>\n\n# 开启后HTTP跳转HTTPS配置\n    RewriteEngine on\n    RewriteCond   %{HTTPS} !=on\n    RewriteRule   ^(.*)  https://www.anonycurse.com$1 [R=permanent,L]\n\n\n</VirtualHost>\n\n<VirtualHost *:443>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n#  因为是HTTPS单域名所以不需要太多Alias    \n\tServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com\n\n    ErrorLog logs/www.anonycurse.com.ssl.error.log\n    CustomLog logs/www.anonycurse.com.access.ssl.log common\n\n#\tHTTPS Laravel 配置\n    <Directory \"/web/www/www.anonycurse.com/public\">\n        AllowOverride All\n        Require all granted\n        DirectoryIndex index.php\n        SSLOptions +StdEnvVars\n    </Directory>\n#\t证书配置\n    SSLEngine on\n    SSLCertificateFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/public.pem\n    SSLCertificateKeyFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/1541114560394.key\n    SSLCertificateChainFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/chain.pem\n\n    <FilesMatch \"\\.(cgi|shtml|phtml|php)$\">\n        SSLOptions +StdEnvVars\n    </FilesMatch>\n\n    BrowserMatch \"MSIE [2-5]\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n\n    CustomLog \"/web/bin/apache/logs/ssl_request_log\" \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n</VirtualHost>\n```","source":"_posts/linux/LAMP学习之Apache添加SSL证书.md","raw":"---\ntitle: LAMP学习之Apache添加SSL证书\ndate: 2019-04-07 09:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\ncover: false\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Linux\ntags:\n  - Linux\n  - Apache\n  - SSL\n---\n\n\n## LAMP学习之Apache添加SSL证书\n\n## 环境装备\n- 已经安装好了的一套Lamp环境，和\n- 阅读过Httpd所有官方文档的的自信。\n\n## 开始安装\n### 1.下载证书\n\n> 进入阿里云域名管理，再点击右边的SSL\n\n![进入SSL](http://oss.anonycurse.cn/article/images/20181016/mYcEkWLm1bhlJeFDGxXcsBsci3tMKWLhNFEvhBRs.png \"进入SSL\")\n\n> 申请完证书后记得点击左上角返回列表下载证书\n![申请SSL](http://oss.anonycurse.cn/article/images/20181016/LA9MaQ3IqD4QMrB5OhAhPxXPG1PUYssGOfOh5qcn.png \"申请SSL\")\n\n\n\n![下载证书](http://oss.anonycurse.cn/article/images/20181016/W9fdbI03VOMYjSJszyHRM0bGlwKA9jT4ukwV2jkZ.png \"下载证书\")\n\n\n![下载证书2](http://oss.anonycurse.cn/article/images/20181016/muxi4oUZfjctSdoYw4CiLr9z2eRbBzv6uuksYZCR.png \"下载证书2\")\n\n### 上传证书\n> 我在网上看见有人把SSL证书直接放在项目里面，对于这种举动我感觉还是有点小怕，\n最后我觉得证书放在在apache 的conf目录下\n\n![证书路径](http://oss.anonycurse.cn/article/images/20181016/1njDCGjbCdHEEuBHLTpxbZHshGTQuuCNRuu1TNbQ.png \"证书路径\")\n\n### 修改配置\n- 1.httpd.conf\n\n```apache\n#1. 开启必要的module\nLoadModule socache_shmcb_module modules/mod_socache_shmcb.so\nLoadModule ssl_module modules/mod_ssl.so\n\n#2.开启SSL配置文件\nInclude conf/extra/httpd-ssl.conf\n\n#3.导入外部主机配置文件\n#注意，我安装Apache的时候是给每个网站添加一个配置文件，所以会有一个vhosts专门存放网站主机配置文件\n# Virtual hosts\nInclude conf/vhosts/*.conf\n```\n- conf/extra/httpd-ssl.conf\n> 这个配置文件和httpd.conf有点类型，存放了一些关于HTTPS的配置，包括一些全局配置和一个默认的虚拟主机配置，这个我喜欢删掉默认想虚拟主机，只保留一些全局配置就好\n\n```apache\nListen 443\n\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n\nSSLProtocol all -SSLv2 -SSLv3\nSSLProxyProtocol all -SSLv3\n\nSSLPassPhraseDialog  builtin\n\nSSLSessionCache        \"shmcb:/web/bin/apache/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\n```\n- conf/vhosts/www.angexinjia.com.conf\n\n```apache\n#默认HTTP主机\n<VirtualHost *:80>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com www.anonycurse.com\n\n#    ErrorLog logs/www.anonycurse.com.error.log\n    CustomLog logs/www.anonycurse.com.access.log common\n\n# Laravel 项目配置【开启HTTPS后可以注释掉】\n#    <Directory \"/web/www/www.anonycurse.com/public\">\n#        AllowOverride All\n#        Require all granted\n#        DirectoryIndex index.php\n#    </Directory>\n\n# 开启后HTTP跳转HTTPS配置\n    RewriteEngine on\n    RewriteCond   %{HTTPS} !=on\n    RewriteRule   ^(.*)  https://www.anonycurse.com$1 [R=permanent,L]\n\n\n</VirtualHost>\n\n<VirtualHost *:443>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n#  因为是HTTPS单域名所以不需要太多Alias    \n\tServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com\n\n    ErrorLog logs/www.anonycurse.com.ssl.error.log\n    CustomLog logs/www.anonycurse.com.access.ssl.log common\n\n#\tHTTPS Laravel 配置\n    <Directory \"/web/www/www.anonycurse.com/public\">\n        AllowOverride All\n        Require all granted\n        DirectoryIndex index.php\n        SSLOptions +StdEnvVars\n    </Directory>\n#\t证书配置\n    SSLEngine on\n    SSLCertificateFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/public.pem\n    SSLCertificateKeyFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/1541114560394.key\n    SSLCertificateChainFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/chain.pem\n\n    <FilesMatch \"\\.(cgi|shtml|phtml|php)$\">\n        SSLOptions +StdEnvVars\n    </FilesMatch>\n\n    BrowserMatch \"MSIE [2-5]\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n\n    CustomLog \"/web/bin/apache/logs/ssl_request_log\" \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n</VirtualHost>\n```","slug":"linux/LAMP学习之Apache添加SSL证书","published":1,"updated":"2019-05-03T15:26:35.477Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjv88f7bl0005i0cdvdngg1bl","content":"<h2 id=\"LAMP学习之Apache添加SSL证书\"><a href=\"#LAMP学习之Apache添加SSL证书\" class=\"headerlink\" title=\"LAMP学习之Apache添加SSL证书\"></a>LAMP学习之Apache添加SSL证书</h2><h2 id=\"环境装备\"><a href=\"#环境装备\" class=\"headerlink\" title=\"环境装备\"></a>环境装备</h2><ul>\n<li>已经安装好了的一套Lamp环境，和</li>\n<li>阅读过Httpd所有官方文档的的自信。</li>\n</ul>\n<h2 id=\"开始安装\"><a href=\"#开始安装\" class=\"headerlink\" title=\"开始安装\"></a>开始安装</h2><h3 id=\"1-下载证书\"><a href=\"#1-下载证书\" class=\"headerlink\" title=\"1.下载证书\"></a>1.下载证书</h3><blockquote>\n<p>进入阿里云域名管理，再点击右边的SSL</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/mYcEkWLm1bhlJeFDGxXcsBsci3tMKWLhNFEvhBRs.png\" alt=\"进入SSL\" title=\"进入SSL\"></p>\n<blockquote>\n<p>申请完证书后记得点击左上角返回列表下载证书<br><img src=\"http://oss.anonycurse.cn/article/images/20181016/LA9MaQ3IqD4QMrB5OhAhPxXPG1PUYssGOfOh5qcn.png\" alt=\"申请SSL\" title=\"申请SSL\"></p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/W9fdbI03VOMYjSJszyHRM0bGlwKA9jT4ukwV2jkZ.png\" alt=\"下载证书\" title=\"下载证书\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/muxi4oUZfjctSdoYw4CiLr9z2eRbBzv6uuksYZCR.png\" alt=\"下载证书2\" title=\"下载证书2\"></p>\n<h3 id=\"上传证书\"><a href=\"#上传证书\" class=\"headerlink\" title=\"上传证书\"></a>上传证书</h3><blockquote>\n<p>我在网上看见有人把SSL证书直接放在项目里面，对于这种举动我感觉还是有点小怕，<br>最后我觉得证书放在在apache 的conf目录下</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/1njDCGjbCdHEEuBHLTpxbZHshGTQuuCNRuu1TNbQ.png\" alt=\"证书路径\" title=\"证书路径\"></p>\n<h3 id=\"修改配置\"><a href=\"#修改配置\" class=\"headerlink\" title=\"修改配置\"></a>修改配置</h3><ul>\n<li>1.httpd.conf</li>\n</ul>\n<pre class=\" language-apache\"><code class=\"language-apache\">#1. 开启必要的module\nLoadModule socache_shmcb_module modules/mod_socache_shmcb.so\nLoadModule ssl_module modules/mod_ssl.so\n\n#2.开启SSL配置文件\nInclude conf/extra/httpd-ssl.conf\n\n#3.导入外部主机配置文件\n#注意，我安装Apache的时候是给每个网站添加一个配置文件，所以会有一个vhosts专门存放网站主机配置文件\n# Virtual hosts\nInclude conf/vhosts/*.conf\n</code></pre>\n<ul>\n<li>conf/extra/httpd-ssl.conf<blockquote>\n<p>这个配置文件和httpd.conf有点类型，存放了一些关于HTTPS的配置，包括一些全局配置和一个默认的虚拟主机配置，这个我喜欢删掉默认想虚拟主机，只保留一些全局配置就好</p>\n</blockquote>\n</li>\n</ul>\n<pre class=\" language-apache\"><code class=\"language-apache\">Listen 443\n\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n\nSSLProtocol all -SSLv2 -SSLv3\nSSLProxyProtocol all -SSLv3\n\nSSLPassPhraseDialog  builtin\n\nSSLSessionCache        \"shmcb:/web/bin/apache/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\n</code></pre>\n<ul>\n<li>conf/vhosts/<a href=\"http://www.angexinjia.com.conf\" target=\"_blank\" rel=\"noopener\">www.angexinjia.com.conf</a></li>\n</ul>\n<pre class=\" language-apache\"><code class=\"language-apache\">#默认HTTP主机\n<VirtualHost *:80>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com www.anonycurse.com\n\n#    ErrorLog logs/www.anonycurse.com.error.log\n    CustomLog logs/www.anonycurse.com.access.log common\n\n# Laravel 项目配置【开启HTTPS后可以注释掉】\n#    <Directory \"/web/www/www.anonycurse.com/public\">\n#        AllowOverride All\n#        Require all granted\n#        DirectoryIndex index.php\n#    </Directory>\n\n# 开启后HTTP跳转HTTPS配置\n    RewriteEngine on\n    RewriteCond   %{HTTPS} !=on\n    RewriteRule   ^(.*)  https://www.anonycurse.com$1 [R=permanent,L]\n\n\n</VirtualHost>\n\n<VirtualHost *:443>\n    DocumentRoot \"/web/www/www.anonycurse.com/public\"\n#  因为是HTTPS单域名所以不需要太多Alias    \n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com\n\n    ErrorLog logs/www.anonycurse.com.ssl.error.log\n    CustomLog logs/www.anonycurse.com.access.ssl.log common\n\n#    HTTPS Laravel 配置\n    <Directory \"/web/www/www.anonycurse.com/public\">\n        AllowOverride All\n        Require all granted\n        DirectoryIndex index.php\n        SSLOptions +StdEnvVars\n    </Directory>\n#    证书配置\n    SSLEngine on\n    SSLCertificateFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/public.pem\n    SSLCertificateKeyFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/1541114560394.key\n    SSLCertificateChainFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/chain.pem\n\n    <FilesMatch \"\\.(cgi|shtml|phtml|php)$\">\n        SSLOptions +StdEnvVars\n    </FilesMatch>\n\n    BrowserMatch \"MSIE [2-5]\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n\n    CustomLog \"/web/bin/apache/logs/ssl_request_log\" \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n</VirtualHost>\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"LAMP学习之Apache添加SSL证书\"><a href=\"#LAMP学习之Apache添加SSL证书\" class=\"headerlink\" title=\"LAMP学习之Apache添加SSL证书\"></a>LAMP学习之Apache添加SSL证书</h2><h2 id=\"环境装备\"><a href=\"#环境装备\" class=\"headerlink\" title=\"环境装备\"></a>环境装备</h2><ul>\n<li>已经安装好了的一套Lamp环境，和</li>\n<li>阅读过Httpd所有官方文档的的自信。</li>\n</ul>\n<h2 id=\"开始安装\"><a href=\"#开始安装\" class=\"headerlink\" title=\"开始安装\"></a>开始安装</h2><h3 id=\"1-下载证书\"><a href=\"#1-下载证书\" class=\"headerlink\" title=\"1.下载证书\"></a>1.下载证书</h3><blockquote>\n<p>进入阿里云域名管理，再点击右边的SSL</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/mYcEkWLm1bhlJeFDGxXcsBsci3tMKWLhNFEvhBRs.png\" alt=\"进入SSL\" title=\"进入SSL\"></p>\n<blockquote>\n<p>申请完证书后记得点击左上角返回列表下载证书<br><img src=\"http://oss.anonycurse.cn/article/images/20181016/LA9MaQ3IqD4QMrB5OhAhPxXPG1PUYssGOfOh5qcn.png\" alt=\"申请SSL\" title=\"申请SSL\"></p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/W9fdbI03VOMYjSJszyHRM0bGlwKA9jT4ukwV2jkZ.png\" alt=\"下载证书\" title=\"下载证书\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/muxi4oUZfjctSdoYw4CiLr9z2eRbBzv6uuksYZCR.png\" alt=\"下载证书2\" title=\"下载证书2\"></p>\n<h3 id=\"上传证书\"><a href=\"#上传证书\" class=\"headerlink\" title=\"上传证书\"></a>上传证书</h3><blockquote>\n<p>我在网上看见有人把SSL证书直接放在项目里面，对于这种举动我感觉还是有点小怕，<br>最后我觉得证书放在在apache 的conf目录下</p>\n</blockquote>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181016/1njDCGjbCdHEEuBHLTpxbZHshGTQuuCNRuu1TNbQ.png\" alt=\"证书路径\" title=\"证书路径\"></p>\n<h3 id=\"修改配置\"><a href=\"#修改配置\" class=\"headerlink\" title=\"修改配置\"></a>修改配置</h3><ul>\n<li>1.httpd.conf</li>\n</ul>\n<pre><code class=\"apache\">#1. 开启必要的module\nLoadModule socache_shmcb_module modules/mod_socache_shmcb.so\nLoadModule ssl_module modules/mod_ssl.so\n\n#2.开启SSL配置文件\nInclude conf/extra/httpd-ssl.conf\n\n#3.导入外部主机配置文件\n#注意，我安装Apache的时候是给每个网站添加一个配置文件，所以会有一个vhosts专门存放网站主机配置文件\n# Virtual hosts\nInclude conf/vhosts/*.conf\n</code></pre>\n<ul>\n<li>conf/extra/httpd-ssl.conf<blockquote>\n<p>这个配置文件和httpd.conf有点类型，存放了一些关于HTTPS的配置，包括一些全局配置和一个默认的虚拟主机配置，这个我喜欢删掉默认想虚拟主机，只保留一些全局配置就好</p>\n</blockquote>\n</li>\n</ul>\n<pre><code class=\"apache\">Listen 443\n\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n\nSSLProtocol all -SSLv2 -SSLv3\nSSLProxyProtocol all -SSLv3\n\nSSLPassPhraseDialog  builtin\n\nSSLSessionCache        &quot;shmcb:/web/bin/apache/logs/ssl_scache(512000)&quot;\nSSLSessionCacheTimeout  300\n</code></pre>\n<ul>\n<li>conf/vhosts/<a href=\"http://www.angexinjia.com.conf\" target=\"_blank\" rel=\"noopener\">www.angexinjia.com.conf</a></li>\n</ul>\n<pre><code class=\"apache\">#默认HTTP主机\n&lt;VirtualHost *:80&gt;\n    DocumentRoot &quot;/web/www/www.anonycurse.com/public&quot;\n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com www.anonycurse.com\n\n#    ErrorLog logs/www.anonycurse.com.error.log\n    CustomLog logs/www.anonycurse.com.access.log common\n\n# Laravel 项目配置【开启HTTPS后可以注释掉】\n#    &lt;Directory &quot;/web/www/www.anonycurse.com/public&quot;&gt;\n#        AllowOverride All\n#        Require all granted\n#        DirectoryIndex index.php\n#    &lt;/Directory&gt;\n\n# 开启后HTTP跳转HTTPS配置\n    RewriteEngine on\n    RewriteCond   %{HTTPS} !=on\n    RewriteRule   ^(.*)  https://www.anonycurse.com$1 [R=permanent,L]\n\n\n&lt;/VirtualHost&gt;\n\n&lt;VirtualHost *:443&gt;\n    DocumentRoot &quot;/web/www/www.anonycurse.com/public&quot;\n#  因为是HTTPS单域名所以不需要太多Alias    \n    ServerName www.anonycurse.com\n    ServerAlias www.anonycurse.com\n\n    ErrorLog logs/www.anonycurse.com.ssl.error.log\n    CustomLog logs/www.anonycurse.com.access.ssl.log common\n\n#    HTTPS Laravel 配置\n    &lt;Directory &quot;/web/www/www.anonycurse.com/public&quot;&gt;\n        AllowOverride All\n        Require all granted\n        DirectoryIndex index.php\n        SSLOptions +StdEnvVars\n    &lt;/Directory&gt;\n#    证书配置\n    SSLEngine on\n    SSLCertificateFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/public.pem\n    SSLCertificateKeyFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/1541114560394.key\n    SSLCertificateChainFile /web/bin/apache/conf/ssl-key/www.anonycurse.com/chain.pem\n\n    &lt;FilesMatch &quot;\\.(cgi|shtml|phtml|php)$&quot;&gt;\n        SSLOptions +StdEnvVars\n    &lt;/FilesMatch&gt;\n\n    BrowserMatch &quot;MSIE [2-5]&quot; \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n\n    CustomLog &quot;/web/bin/apache/logs/ssl_request_log&quot; \\\n          &quot;%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\&quot;%r\\&quot; %b&quot;\n\n&lt;/VirtualHost&gt;\n</code></pre>\n"},{"title":"怎么用Gin去构建一个RESTful API Golang Service【翻译】","date":"2018-09-07T01:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"cover":false,"<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# 怎么用Gin去构建一个RESTful API Golang Service【翻译】\n\n##前言\n\n[![Cover](http://oss.anonycurse.cn/article/images/20181105/531wGkj4qxe98UALsFO6vy9kRhdLLqVQZY0jnNhE.png \"Cover\")](\"Cover\")\n\nToday I’m going to build a simple API for todo application with the golang programming language. I’m going to use golang simplest/fastest framework gin-gonic and a beautiful ORM gorm for our database work. To install these packages go to your workspace $GOPATH/src and run these command below:\n\n\n```go\n$ go get gopkg.in/gin-gonic/gin.v1\n$ go get -u github.com/jinzhu/gorm\n$ go get github.com/go-sql-driver/mysql\n```\n## In generic crud application we need the API’s as follows:\n- POST todos/\n- GET todos/\n- GET todos/{id}\n- PUT todos/{id}\n- DELETE todos/{id}\n\nLet’s start coding, go to your $GOPATH/src and make a directory todo. Inside the todo directory create a file main.go. Import the “gin framework” to our project and create the routes like below inside main function. I like to add a prefix of the apis like “api/v1/”, that’s why we’ll use the router Group method\n\n```go\npackage main\n\nimport (\n       \"github.com/gin-gonic/gin\"\n)\nfunc main() {\nrouter := gin.Default()\nv1 := router.Group(\"/api/v1/todos\")\n {\n  v1.POST(\"/\", createTodo)\n  v1.GET(\"/\", fetchAllTodo)\n  v1.GET(\"/:id\", fetchSingleTodo)\n  v1.PUT(\"/:id\", updateTodo)\n  v1.DELETE(\"/:id\", deleteTodo)\n }\n router.Run()\n}\n```\n\nWe have created five routes and they handle some functions like `createTodo`, `fetchAllTodo` etc. We’ll discuss about them soon.\n\nNow we need to setup a database connection. To use database pull the gorm package and mysql dialects in our code. Follow the code below:\n\n```go\npackage main\n\nimport (\n       \"github.com/gin-gonic/gin\"\n       \"github.com/jinzhu/gorm\"\n       _ \"github.com/jinzhu/gorm/dialects/mysql\"\n)\n\nvar db *gorm.DB\nfunc init() {\n //open a db connection\n var err error\n db, err = gorm.Open(\"mysql\", \"root:12345@/demo?charset=utf8&parseTime=True&loc=Local\")\n if err != nil {\n  panic(\"failed to connect database\")\n }\n//Migrate the schema\n db.AutoMigrate(&todoModel{})\n}\n```\n\nIn the above code “mysql” is our database driver, “root” is database username, “12345” password and “demo” is database name. Please change these information as your needs.\n\nWe’ll use the Database function to get the database connection. Lets make a todoModel and transformedTodo struct. The first struct will represent the original Todo and the second one will hold the transformed todo for response to the api. Here we transformed the todo response because we don’t expose some database fields (updated_at, created_at) to the consumer.\n\n```go\ntype (\n // todoModel describes a todoModel type\n todoModel struct {\n  gorm.Model\n  Title     string `json:\"title\"`\n  Completed int    `json:\"completed\"`\n }\n// transformedTodo represents a formatted todo\n transformedTodo struct {\n  ID        uint   `json:\"id\"`\n  Title     string `json:\"title\"`\n  Completed bool   `json:\"completed\"`\n }\n)\n```\n\nTodo struct has one field extra gorm.Model what does it mean? well, this field will embed a Model struct for us which contains four fields “ID, CreatedAt, UpdatedAt, DeletedAt”\n\nGorm has migration facilities, we already used it in init function. When we run the application first it’ll create a connection and then the migration.\n```go\n//Migrate the schema\n db.AutoMigrate(&todoModel{})\n```\n\n\n![Migrate ](http://oss.anonycurse.cn/article/images/20181105/bhwTdjLFSN57B6kkl8CE8NVaZ7zeXGsYHhh7D0c0.png \"Migrate \")\n\n\nCan you remember the five routes we wrote a minute earlier? Lets implement the five methods one by one.\n\nWhen a user send a POST request to the path ‘api/v1/todos/’ with ‘title and completed’ field it’ll be handled by this route v1.POST(“/”, createTodo)\n\nLets Implement the createTodo function\n\n```go\n// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n completed, _ := strconv.Atoi(c.PostForm(\"completed\"))\n todo := todoModel{Title: c.PostForm(\"title\"), Completed: completed}\n db.Save(&todo)\n c.JSON(http.StatusCreated, gin.H{\"status\": http.StatusCreated, \"message\": \"Todo item created successfully!\", \"resourceId\": todo.ID})\n}\n```\nIn the above code we use gin Context to receive the posted data and gorm database connection to save the todo. After saving the resource we send the resource id with a good & meaningful response to the user.\n\nLets implement the rest of the functions\n\n```go\n// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n var todos []todoModel\n var _todos []transformedTodo\ndb.Find(&todos)\nif len(todos) <= 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\n//transforms the todos for building a good response\n for _, item := range todos {\n  completed := false\n  if item.Completed == 1 {\n   completed = true\n  } else {\n   completed = false\n  }\n  _todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n }\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todos})\n}\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ncompleted := false\n if todo.Completed == 1 {\n  completed = true\n } else {\n  completed = false\n }\n_todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todo})\n}\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ndb.Model(&todo).Update(\"title\", c.PostForm(\"title\"))\n completed, _ := strconv.Atoi(c.PostForm(\"completed\"))\n db.Model(&todo).Update(\"completed\", completed)\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo updated successfully!\"})\n}\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ndb.Delete(&todo)\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo deleted successfully!\"})\n}\n```\nIn the fetchAllTodo function we fetched all the todos and and build a transformed response with id, title, completed . We removed the CreatedAt, UpdatedAt, DeletedAt fields and cast the integer value to bool.\n\nWell, we write enough code, let try to build the app and test it, I’m going test it using chrome extension Postman (you can use any REST client like curl to test).\n\nTo build the app open your terminal and go the the project directory\n\n```go\n$ go build main.go\n```\n\nThe command will build a binary file main and to run the file us this command $ ./main . Wow, our simple todo app is running on port: 8080. It’ll display the debug log, because by default gin run’s in debug mode and port 8080.\n\nTo test the api run postman and test the api sequentially\n\n![Create a todo](http://oss.anonycurse.cn/article/images/20181105/wVld5PMtLBFEsVXjcE6pY9FhQSM5MuQB6hAJCtWe.png \"Create a todo\")\n\n![Fetch all todos](http://oss.anonycurse.cn/article/images/20181105/KVYw3KtSm1CqkS1R9jaTdxBXwue69Rv68F0eD4gL.png \"Fetch all todos\")\n\n\n![Fetch a single todo](http://oss.anonycurse.cn/article/images/20181105/Iye2ekzbzEPkO8ScOwqnV0tLSun07itdPsXannpm.png \"Fetch a single todo\")\n\n![Update a todo](http://oss.anonycurse.cn/article/images/20181105/Y5VFuzWRyiocmO6JERjrZw5hvn9B7OBiQbAi4U0S.png \"Update a todo\")\n\n![Delete a todo](http://oss.anonycurse.cn/article/images/20181105/8b3CN4i3tfZbtsOvFglwi3DLtpHCPlmwfHuuBsWb.png \"Delete a todo\")\n\n## Need full source code?\n```go\npackage main\n\nimport (\n\t\"net/http\"\n\t\"strconv\"\n\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/jinzhu/gorm\"\n\t_ \"github.com/jinzhu/gorm/dialects/mysql\"\n)\n\nvar db *gorm.DB\n\nfunc init() {\n\t//open a db connection\n\tvar err error\n\tdb, err = gorm.Open(\"mysql\", \"root:12345@/demo?charset=utf8&parseTime=True&loc=Local\")\n\tif err != nil {\n\t\tpanic(\"failed to connect database\")\n\t}\n\n\t//Migrate the schema\n\tdb.AutoMigrate(&todoModel{})\n}\n\nfunc main() {\n\n\trouter := gin.Default()\n\n\tv1 := router.Group(\"/api/v1/todos\")\n\t{\n\t\tv1.POST(\"/\", createTodo)\n\t\tv1.GET(\"/\", fetchAllTodo)\n\t\tv1.GET(\"/:id\", fetchSingleTodo)\n\t\tv1.PUT(\"/:id\", updateTodo)\n\t\tv1.DELETE(\"/:id\", deleteTodo)\n\t}\n\trouter.Run()\n\n}\n\ntype (\n\t// todoModel describes a todoModel type\n\ttodoModel struct {\n\t\tgorm.Model\n\t\tTitle     string `json:\"title\"`\n\t\tCompleted int    `json:\"completed\"`\n\t}\n\n\t// transformedTodo represents a formatted todo\n\ttransformedTodo struct {\n\t\tID        uint   `json:\"id\"`\n\t\tTitle     string `json:\"title\"`\n\t\tCompleted bool   `json:\"completed\"`\n\t}\n)\n\n// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n\tcompleted, _ := strconv.Atoi(c.PostForm(\"completed\"))\n\ttodo := todoModel{Title: c.PostForm(\"title\"), Completed: completed}\n\tdb.Save(&todo)\n\tc.JSON(http.StatusCreated, gin.H{\"status\": http.StatusCreated, \"message\": \"Todo item created successfully!\", \"resourceId\": todo.ID})\n}\n\n// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n\tvar todos []todoModel\n\tvar _todos []transformedTodo\n\n\tdb.Find(&todos)\n\n\tif len(todos) <= 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\t//transforms the todos for building a good response\n\tfor _, item := range todos {\n\t\tcompleted := false\n\t\tif item.Completed == 1 {\n\t\t\tcompleted = true\n\t\t} else {\n\t\t\tcompleted = false\n\t\t}\n\t\t_todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n\t}\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todos})\n}\n\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tcompleted := false\n\tif todo.Completed == 1 {\n\t\tcompleted = true\n\t} else {\n\t\tcompleted = false\n\t}\n\n\t_todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todo})\n}\n\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tdb.Model(&todo).Update(\"title\", c.PostForm(\"title\"))\n\tcompleted, _ := strconv.Atoi(c.PostForm(\"completed\"))\n\tdb.Model(&todo).Update(\"completed\", completed)\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo updated successfully!\"})\n}\n\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tdb.Delete(&todo)\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo deleted successfully!\"})\n}\n```\n\n> Note: When you are using code production you must take care of the steps below:\n\n- Do not fetch all the data select * from todos , use pagination\n- Do not trust user input. You must validate the inputs, there are severals tools to validate input. Read the article for validation process\n- Check every possible error\n- You should use logging and authentication as your need\n- I am really sorry for my BAD English and Writing flow. If you notice any mistake in the article please feel free to write a comment.","source":"_posts/golang/怎么用Gin去构建一个RESTful API Golang Service.md","raw":"---\ntitle: 怎么用Gin去构建一个RESTful API Golang Service【翻译】\ndate: 2018-09-07 09:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\ncover: false\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Golang\ntags:\n  - Golang\n  - Gin\n---\n\n\n# 怎么用Gin去构建一个RESTful API Golang Service【翻译】\n\n##前言\n\n[![Cover](http://oss.anonycurse.cn/article/images/20181105/531wGkj4qxe98UALsFO6vy9kRhdLLqVQZY0jnNhE.png \"Cover\")](\"Cover\")\n\nToday I’m going to build a simple API for todo application with the golang programming language. I’m going to use golang simplest/fastest framework gin-gonic and a beautiful ORM gorm for our database work. To install these packages go to your workspace $GOPATH/src and run these command below:\n\n\n```go\n$ go get gopkg.in/gin-gonic/gin.v1\n$ go get -u github.com/jinzhu/gorm\n$ go get github.com/go-sql-driver/mysql\n```\n## In generic crud application we need the API’s as follows:\n- POST todos/\n- GET todos/\n- GET todos/{id}\n- PUT todos/{id}\n- DELETE todos/{id}\n\nLet’s start coding, go to your $GOPATH/src and make a directory todo. Inside the todo directory create a file main.go. Import the “gin framework” to our project and create the routes like below inside main function. I like to add a prefix of the apis like “api/v1/”, that’s why we’ll use the router Group method\n\n```go\npackage main\n\nimport (\n       \"github.com/gin-gonic/gin\"\n)\nfunc main() {\nrouter := gin.Default()\nv1 := router.Group(\"/api/v1/todos\")\n {\n  v1.POST(\"/\", createTodo)\n  v1.GET(\"/\", fetchAllTodo)\n  v1.GET(\"/:id\", fetchSingleTodo)\n  v1.PUT(\"/:id\", updateTodo)\n  v1.DELETE(\"/:id\", deleteTodo)\n }\n router.Run()\n}\n```\n\nWe have created five routes and they handle some functions like `createTodo`, `fetchAllTodo` etc. We’ll discuss about them soon.\n\nNow we need to setup a database connection. To use database pull the gorm package and mysql dialects in our code. Follow the code below:\n\n```go\npackage main\n\nimport (\n       \"github.com/gin-gonic/gin\"\n       \"github.com/jinzhu/gorm\"\n       _ \"github.com/jinzhu/gorm/dialects/mysql\"\n)\n\nvar db *gorm.DB\nfunc init() {\n //open a db connection\n var err error\n db, err = gorm.Open(\"mysql\", \"root:12345@/demo?charset=utf8&parseTime=True&loc=Local\")\n if err != nil {\n  panic(\"failed to connect database\")\n }\n//Migrate the schema\n db.AutoMigrate(&todoModel{})\n}\n```\n\nIn the above code “mysql” is our database driver, “root” is database username, “12345” password and “demo” is database name. Please change these information as your needs.\n\nWe’ll use the Database function to get the database connection. Lets make a todoModel and transformedTodo struct. The first struct will represent the original Todo and the second one will hold the transformed todo for response to the api. Here we transformed the todo response because we don’t expose some database fields (updated_at, created_at) to the consumer.\n\n```go\ntype (\n // todoModel describes a todoModel type\n todoModel struct {\n  gorm.Model\n  Title     string `json:\"title\"`\n  Completed int    `json:\"completed\"`\n }\n// transformedTodo represents a formatted todo\n transformedTodo struct {\n  ID        uint   `json:\"id\"`\n  Title     string `json:\"title\"`\n  Completed bool   `json:\"completed\"`\n }\n)\n```\n\nTodo struct has one field extra gorm.Model what does it mean? well, this field will embed a Model struct for us which contains four fields “ID, CreatedAt, UpdatedAt, DeletedAt”\n\nGorm has migration facilities, we already used it in init function. When we run the application first it’ll create a connection and then the migration.\n```go\n//Migrate the schema\n db.AutoMigrate(&todoModel{})\n```\n\n\n![Migrate ](http://oss.anonycurse.cn/article/images/20181105/bhwTdjLFSN57B6kkl8CE8NVaZ7zeXGsYHhh7D0c0.png \"Migrate \")\n\n\nCan you remember the five routes we wrote a minute earlier? Lets implement the five methods one by one.\n\nWhen a user send a POST request to the path ‘api/v1/todos/’ with ‘title and completed’ field it’ll be handled by this route v1.POST(“/”, createTodo)\n\nLets Implement the createTodo function\n\n```go\n// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n completed, _ := strconv.Atoi(c.PostForm(\"completed\"))\n todo := todoModel{Title: c.PostForm(\"title\"), Completed: completed}\n db.Save(&todo)\n c.JSON(http.StatusCreated, gin.H{\"status\": http.StatusCreated, \"message\": \"Todo item created successfully!\", \"resourceId\": todo.ID})\n}\n```\nIn the above code we use gin Context to receive the posted data and gorm database connection to save the todo. After saving the resource we send the resource id with a good & meaningful response to the user.\n\nLets implement the rest of the functions\n\n```go\n// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n var todos []todoModel\n var _todos []transformedTodo\ndb.Find(&todos)\nif len(todos) <= 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\n//transforms the todos for building a good response\n for _, item := range todos {\n  completed := false\n  if item.Completed == 1 {\n   completed = true\n  } else {\n   completed = false\n  }\n  _todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n }\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todos})\n}\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ncompleted := false\n if todo.Completed == 1 {\n  completed = true\n } else {\n  completed = false\n }\n_todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todo})\n}\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ndb.Model(&todo).Update(\"title\", c.PostForm(\"title\"))\n completed, _ := strconv.Atoi(c.PostForm(\"completed\"))\n db.Model(&todo).Update(\"completed\", completed)\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo updated successfully!\"})\n}\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(\"id\")\ndb.First(&todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n  return\n }\ndb.Delete(&todo)\n c.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo deleted successfully!\"})\n}\n```\nIn the fetchAllTodo function we fetched all the todos and and build a transformed response with id, title, completed . We removed the CreatedAt, UpdatedAt, DeletedAt fields and cast the integer value to bool.\n\nWell, we write enough code, let try to build the app and test it, I’m going test it using chrome extension Postman (you can use any REST client like curl to test).\n\nTo build the app open your terminal and go the the project directory\n\n```go\n$ go build main.go\n```\n\nThe command will build a binary file main and to run the file us this command $ ./main . Wow, our simple todo app is running on port: 8080. It’ll display the debug log, because by default gin run’s in debug mode and port 8080.\n\nTo test the api run postman and test the api sequentially\n\n![Create a todo](http://oss.anonycurse.cn/article/images/20181105/wVld5PMtLBFEsVXjcE6pY9FhQSM5MuQB6hAJCtWe.png \"Create a todo\")\n\n![Fetch all todos](http://oss.anonycurse.cn/article/images/20181105/KVYw3KtSm1CqkS1R9jaTdxBXwue69Rv68F0eD4gL.png \"Fetch all todos\")\n\n\n![Fetch a single todo](http://oss.anonycurse.cn/article/images/20181105/Iye2ekzbzEPkO8ScOwqnV0tLSun07itdPsXannpm.png \"Fetch a single todo\")\n\n![Update a todo](http://oss.anonycurse.cn/article/images/20181105/Y5VFuzWRyiocmO6JERjrZw5hvn9B7OBiQbAi4U0S.png \"Update a todo\")\n\n![Delete a todo](http://oss.anonycurse.cn/article/images/20181105/8b3CN4i3tfZbtsOvFglwi3DLtpHCPlmwfHuuBsWb.png \"Delete a todo\")\n\n## Need full source code?\n```go\npackage main\n\nimport (\n\t\"net/http\"\n\t\"strconv\"\n\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/jinzhu/gorm\"\n\t_ \"github.com/jinzhu/gorm/dialects/mysql\"\n)\n\nvar db *gorm.DB\n\nfunc init() {\n\t//open a db connection\n\tvar err error\n\tdb, err = gorm.Open(\"mysql\", \"root:12345@/demo?charset=utf8&parseTime=True&loc=Local\")\n\tif err != nil {\n\t\tpanic(\"failed to connect database\")\n\t}\n\n\t//Migrate the schema\n\tdb.AutoMigrate(&todoModel{})\n}\n\nfunc main() {\n\n\trouter := gin.Default()\n\n\tv1 := router.Group(\"/api/v1/todos\")\n\t{\n\t\tv1.POST(\"/\", createTodo)\n\t\tv1.GET(\"/\", fetchAllTodo)\n\t\tv1.GET(\"/:id\", fetchSingleTodo)\n\t\tv1.PUT(\"/:id\", updateTodo)\n\t\tv1.DELETE(\"/:id\", deleteTodo)\n\t}\n\trouter.Run()\n\n}\n\ntype (\n\t// todoModel describes a todoModel type\n\ttodoModel struct {\n\t\tgorm.Model\n\t\tTitle     string `json:\"title\"`\n\t\tCompleted int    `json:\"completed\"`\n\t}\n\n\t// transformedTodo represents a formatted todo\n\ttransformedTodo struct {\n\t\tID        uint   `json:\"id\"`\n\t\tTitle     string `json:\"title\"`\n\t\tCompleted bool   `json:\"completed\"`\n\t}\n)\n\n// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n\tcompleted, _ := strconv.Atoi(c.PostForm(\"completed\"))\n\ttodo := todoModel{Title: c.PostForm(\"title\"), Completed: completed}\n\tdb.Save(&todo)\n\tc.JSON(http.StatusCreated, gin.H{\"status\": http.StatusCreated, \"message\": \"Todo item created successfully!\", \"resourceId\": todo.ID})\n}\n\n// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n\tvar todos []todoModel\n\tvar _todos []transformedTodo\n\n\tdb.Find(&todos)\n\n\tif len(todos) <= 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\t//transforms the todos for building a good response\n\tfor _, item := range todos {\n\t\tcompleted := false\n\t\tif item.Completed == 1 {\n\t\t\tcompleted = true\n\t\t} else {\n\t\t\tcompleted = false\n\t\t}\n\t\t_todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n\t}\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todos})\n}\n\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tcompleted := false\n\tif todo.Completed == 1 {\n\t\tcompleted = true\n\t} else {\n\t\tcompleted = false\n\t}\n\n\t_todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"data\": _todo})\n}\n\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tdb.Model(&todo).Update(\"title\", c.PostForm(\"title\"))\n\tcompleted, _ := strconv.Atoi(c.PostForm(\"completed\"))\n\tdb.Model(&todo).Update(\"completed\", completed)\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo updated successfully!\"})\n}\n\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n\tvar todo todoModel\n\ttodoID := c.Param(\"id\")\n\n\tdb.First(&todo, todoID)\n\n\tif todo.ID == 0 {\n\t\tc.JSON(http.StatusNotFound, gin.H{\"status\": http.StatusNotFound, \"message\": \"No todo found!\"})\n\t\treturn\n\t}\n\n\tdb.Delete(&todo)\n\tc.JSON(http.StatusOK, gin.H{\"status\": http.StatusOK, \"message\": \"Todo deleted successfully!\"})\n}\n```\n\n> Note: When you are using code production you must take care of the steps below:\n\n- Do not fetch all the data select * from todos , use pagination\n- Do not trust user input. You must validate the inputs, there are severals tools to validate input. Read the article for validation process\n- Check every possible error\n- You should use logging and authentication as your need\n- I am really sorry for my BAD English and Writing flow. If you notice any mistake in the article please feel free to write a comment.","slug":"golang/怎么用Gin去构建一个RESTful API Golang Service","published":1,"updated":"2019-05-03T15:07:22.024Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjv88f7ca000mi0cdrb8colqu","content":"<h1 id=\"怎么用Gin去构建一个RESTful-API-Golang-Service【翻译】\"><a href=\"#怎么用Gin去构建一个RESTful-API-Golang-Service【翻译】\" class=\"headerlink\" title=\"怎么用Gin去构建一个RESTful API Golang Service【翻译】\"></a>怎么用Gin去构建一个RESTful API Golang Service【翻译】</h1><p>##前言</p>\n<p><a href=\"&quot;Cover&quot;\"><img src=\"http://oss.anonycurse.cn/article/images/20181105/531wGkj4qxe98UALsFO6vy9kRhdLLqVQZY0jnNhE.png\" alt=\"Cover\" title=\"Cover\"></a></p>\n<p>Today I’m going to build a simple API for todo application with the golang programming language. I’m going to use golang simplest/fastest framework gin-gonic and a beautiful ORM gorm for our database work. To install these packages go to your workspace $GOPATH/src and run these command below:</p>\n<pre class=\" language-go\"><code class=\"language-go\">$ <span class=\"token keyword\">go</span> get gopkg<span class=\"token punctuation\">.</span>in<span class=\"token operator\">/</span>gin<span class=\"token operator\">-</span>gonic<span class=\"token operator\">/</span>gin<span class=\"token punctuation\">.</span>v1\n$ <span class=\"token keyword\">go</span> get <span class=\"token operator\">-</span>u github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jinzhu<span class=\"token operator\">/</span>gorm\n$ <span class=\"token keyword\">go</span> get github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span><span class=\"token keyword\">go</span><span class=\"token operator\">-</span>sql<span class=\"token operator\">-</span>driver<span class=\"token operator\">/</span>mysql\n</code></pre>\n<h2 id=\"In-generic-crud-application-we-need-the-API’s-as-follows\"><a href=\"#In-generic-crud-application-we-need-the-API’s-as-follows\" class=\"headerlink\" title=\"In generic crud application we need the API’s as follows:\"></a>In generic crud application we need the API’s as follows:</h2><ul>\n<li>POST todos/</li>\n<li>GET todos/</li>\n<li>GET todos/{id}</li>\n<li>PUT todos/{id}</li>\n<li>DELETE todos/{id}</li>\n</ul>\n<p>Let’s start coding, go to your $GOPATH/src and make a directory todo. Inside the todo directory create a file main.go. Import the “gin framework” to our project and create the routes like below inside main function. I like to add a prefix of the apis like “api/v1/”, that’s why we’ll use the router Group method</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n       <span class=\"token string\">\"github.com/gin-gonic/gin\"</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\nrouter <span class=\"token operator\">:=</span> gin<span class=\"token punctuation\">.</span><span class=\"token function\">Default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nv1 <span class=\"token operator\">:=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">Group</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/v1/todos\"</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">{</span>\n  v1<span class=\"token punctuation\">.</span><span class=\"token function\">POST</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> createTodo<span class=\"token punctuation\">)</span>\n  v1<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> fetchAllTodo<span class=\"token punctuation\">)</span>\n  v1<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> fetchSingleTodo<span class=\"token punctuation\">)</span>\n  v1<span class=\"token punctuation\">.</span><span class=\"token function\">PUT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> updateTodo<span class=\"token punctuation\">)</span>\n  v1<span class=\"token punctuation\">.</span><span class=\"token function\">DELETE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> deleteTodo<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span>\n router<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>We have created five routes and they handle some functions like <code>createTodo</code>, <code>fetchAllTodo</code> etc. We’ll discuss about them soon.</p>\n<p>Now we need to setup a database connection. To use database pull the gorm package and mysql dialects in our code. Follow the code below:</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n       <span class=\"token string\">\"github.com/gin-gonic/gin\"</span>\n       <span class=\"token string\">\"github.com/jinzhu/gorm\"</span>\n       <span class=\"token boolean\">_</span> <span class=\"token string\">\"github.com/jinzhu/gorm/dialects/mysql\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> db <span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB\n<span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token comment\" spellcheck=\"true\">//open a db connection</span>\n <span class=\"token keyword\">var</span> err <span class=\"token builtin\">error</span>\n db<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> gorm<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mysql\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"root:12345@/demo?charset=utf8&amp;parseTime=True&amp;loc=Local\"</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to connect database\"</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//Migrate the schema</span>\n db<span class=\"token punctuation\">.</span><span class=\"token function\">AutoMigrate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todoModel<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>In the above code “mysql” is our database driver, “root” is database username, “12345” password and “demo” is database name. Please change these information as your needs.</p>\n<p>We’ll use the Database function to get the database connection. Lets make a todoModel and transformedTodo struct. The first struct will represent the original Todo and the second one will hold the transformed todo for response to the api. Here we transformed the todo response because we don’t expose some database fields (updated_at, created_at) to the consumer.</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> <span class=\"token punctuation\">(</span>\n <span class=\"token comment\" spellcheck=\"true\">// todoModel describes a todoModel type</span>\n todoModel <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n  gorm<span class=\"token punctuation\">.</span>Model\n  Title     <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"title\"`</span>\n  Completed <span class=\"token builtin\">int</span>    <span class=\"token string\">`json:\"completed\"`</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// transformedTodo represents a formatted todo</span>\n transformedTodo <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n  ID        <span class=\"token builtin\">uint</span>   <span class=\"token string\">`json:\"id\"`</span>\n  Title     <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"title\"`</span>\n  Completed <span class=\"token builtin\">bool</span>   <span class=\"token string\">`json:\"completed\"`</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>Todo struct has one field extra gorm.Model what does it mean? well, this field will embed a Model struct for us which contains four fields “ID, CreatedAt, UpdatedAt, DeletedAt”</p>\n<p>Gorm has migration facilities, we already used it in init function. When we run the application first it’ll create a connection and then the migration.</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token comment\" spellcheck=\"true\">//Migrate the schema</span>\n db<span class=\"token punctuation\">.</span><span class=\"token function\">AutoMigrate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todoModel<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/bhwTdjLFSN57B6kkl8CE8NVaZ7zeXGsYHhh7D0c0.png\" alt=\"Migrate \" title=\"Migrate \"></p>\n<p>Can you remember the five routes we wrote a minute earlier? Lets implement the five methods one by one.</p>\n<p>When a user send a POST request to the path ‘api/v1/todos/’ with ‘title and completed’ field it’ll be handled by this route v1.POST(“/”, createTodo)</p>\n<p>Lets Implement the createTodo function</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token comment\" spellcheck=\"true\">// createTodo add a new todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">createTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n completed<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Atoi</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n todo <span class=\"token operator\">:=</span> todoModel<span class=\"token punctuation\">{</span>Title<span class=\"token punctuation\">:</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span>\n db<span class=\"token punctuation\">.</span><span class=\"token function\">Save</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span>\n c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusCreated<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusCreated<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo item created successfully!\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"resourceId\"</span><span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>In the above code we use gin Context to receive the posted data and gorm database connection to save the todo. After saving the resource we send the resource id with a good &amp; meaningful response to the user.</p>\n<p>Lets implement the rest of the functions</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token comment\" spellcheck=\"true\">// fetchAllTodo fetch all todos</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">fetchAllTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">var</span> todos <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>todoModel\n <span class=\"token keyword\">var</span> _todos <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>transformedTodo\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todos<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//transforms the todos for building a good response</span>\n <span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> item <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> todos <span class=\"token punctuation\">{</span>\n  completed <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token keyword\">if</span> item<span class=\"token punctuation\">.</span>Completed <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n   completed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n   completed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n  _todos <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>_todos<span class=\"token punctuation\">,</span> transformedTodo<span class=\"token punctuation\">{</span>ID<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span> Title<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>Title<span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span>\n c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> _todos<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// fetchSingleTodo fetch a single todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">fetchSingleTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">var</span> todo todoModel\n todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span>\n <span class=\"token punctuation\">}</span>\ncompleted <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span>\n <span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>Completed <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n  completed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  completed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n <span class=\"token punctuation\">}</span>\n_todo <span class=\"token operator\">:=</span> transformedTodo<span class=\"token punctuation\">{</span>ID<span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span> Title<span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>Title<span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span>\n c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> _todo<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// updateTodo update a todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">updateTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">var</span> todo todoModel\n todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span>\n <span class=\"token punctuation\">}</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">Model</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n completed<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Atoi</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n db<span class=\"token punctuation\">.</span><span class=\"token function\">Model</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">,</span> completed<span class=\"token punctuation\">)</span>\n c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo updated successfully!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// deleteTodo remove a todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">deleteTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">var</span> todo todoModel\n todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span>\n <span class=\"token punctuation\">}</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span>\n c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo deleted successfully!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>In the fetchAllTodo function we fetched all the todos and and build a transformed response with id, title, completed . We removed the CreatedAt, UpdatedAt, DeletedAt fields and cast the integer value to bool.</p>\n<p>Well, we write enough code, let try to build the app and test it, I’m going test it using chrome extension Postman (you can use any REST client like curl to test).</p>\n<p>To build the app open your terminal and go the the project directory</p>\n<pre class=\" language-go\"><code class=\"language-go\">$ <span class=\"token keyword\">go</span> build main<span class=\"token punctuation\">.</span><span class=\"token keyword\">go</span>\n</code></pre>\n<p>The command will build a binary file main and to run the file us this command $ ./main . Wow, our simple todo app is running on port: 8080. It’ll display the debug log, because by default gin run’s in debug mode and port 8080.</p>\n<p>To test the api run postman and test the api sequentially</p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/wVld5PMtLBFEsVXjcE6pY9FhQSM5MuQB6hAJCtWe.png\" alt=\"Create a todo\" title=\"Create a todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/KVYw3KtSm1CqkS1R9jaTdxBXwue69Rv68F0eD4gL.png\" alt=\"Fetch all todos\" title=\"Fetch all todos\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/Iye2ekzbzEPkO8ScOwqnV0tLSun07itdPsXannpm.png\" alt=\"Fetch a single todo\" title=\"Fetch a single todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/Y5VFuzWRyiocmO6JERjrZw5hvn9B7OBiQbAi4U0S.png\" alt=\"Update a todo\" title=\"Update a todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/8b3CN4i3tfZbtsOvFglwi3DLtpHCPlmwfHuuBsWb.png\" alt=\"Delete a todo\" title=\"Delete a todo\"></p>\n<h2 id=\"Need-full-source-code\"><a href=\"#Need-full-source-code\" class=\"headerlink\" title=\"Need full source code?\"></a>Need full source code?</h2><pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"net/http\"</span>\n    <span class=\"token string\">\"strconv\"</span>\n\n    <span class=\"token string\">\"github.com/gin-gonic/gin\"</span>\n    <span class=\"token string\">\"github.com/jinzhu/gorm\"</span>\n    <span class=\"token boolean\">_</span> <span class=\"token string\">\"github.com/jinzhu/gorm/dialects/mysql\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> db <span class=\"token operator\">*</span>gorm<span class=\"token punctuation\">.</span>DB\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//open a db connection</span>\n    <span class=\"token keyword\">var</span> err <span class=\"token builtin\">error</span>\n    db<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> gorm<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mysql\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"root:12345@/demo?charset=utf8&amp;parseTime=True&amp;loc=Local\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to connect database\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//Migrate the schema</span>\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">AutoMigrate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todoModel<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    router <span class=\"token operator\">:=</span> gin<span class=\"token punctuation\">.</span><span class=\"token function\">Default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    v1 <span class=\"token operator\">:=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">Group</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/v1/todos\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        v1<span class=\"token punctuation\">.</span><span class=\"token function\">POST</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> createTodo<span class=\"token punctuation\">)</span>\n        v1<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> fetchAllTodo<span class=\"token punctuation\">)</span>\n        v1<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> fetchSingleTodo<span class=\"token punctuation\">)</span>\n        v1<span class=\"token punctuation\">.</span><span class=\"token function\">PUT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> updateTodo<span class=\"token punctuation\">)</span>\n        v1<span class=\"token punctuation\">.</span><span class=\"token function\">DELETE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:id\"</span><span class=\"token punctuation\">,</span> deleteTodo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    router<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token comment\" spellcheck=\"true\">// todoModel describes a todoModel type</span>\n    todoModel <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n        gorm<span class=\"token punctuation\">.</span>Model\n        Title     <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"title\"`</span>\n        Completed <span class=\"token builtin\">int</span>    <span class=\"token string\">`json:\"completed\"`</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">// transformedTodo represents a formatted todo</span>\n    transformedTodo <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n        ID        <span class=\"token builtin\">uint</span>   <span class=\"token string\">`json:\"id\"`</span>\n        Title     <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"title\"`</span>\n        Completed <span class=\"token builtin\">bool</span>   <span class=\"token string\">`json:\"completed\"`</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// createTodo add a new todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">createTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    completed<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Atoi</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    todo <span class=\"token operator\">:=</span> todoModel<span class=\"token punctuation\">{</span>Title<span class=\"token punctuation\">:</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span>\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">Save</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusCreated<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusCreated<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo item created successfully!\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"resourceId\"</span><span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// fetchAllTodo fetch all todos</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">fetchAllTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> todos <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>todoModel\n    <span class=\"token keyword\">var</span> _todos <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>transformedTodo\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todos<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//transforms the todos for building a good response</span>\n    <span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> item <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> todos <span class=\"token punctuation\">{</span>\n        completed <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span>\n        <span class=\"token keyword\">if</span> item<span class=\"token punctuation\">.</span>Completed <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n            completed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            completed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span>\n        _todos <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>_todos<span class=\"token punctuation\">,</span> transformedTodo<span class=\"token punctuation\">{</span>ID<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span> Title<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>Title<span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> _todos<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// fetchSingleTodo fetch a single todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">fetchSingleTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> todo todoModel\n    todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    completed <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>Completed <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n        completed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        completed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n\n    _todo <span class=\"token operator\">:=</span> transformedTodo<span class=\"token punctuation\">{</span>ID<span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span> Title<span class=\"token punctuation\">:</span> todo<span class=\"token punctuation\">.</span>Title<span class=\"token punctuation\">,</span> Completed<span class=\"token punctuation\">:</span> completed<span class=\"token punctuation\">}</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> _todo<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// updateTodo update a todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">updateTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> todo todoModel\n    todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">Model</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    completed<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Atoi</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">PostForm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">Model</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">,</span> completed<span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo updated successfully!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// deleteTodo remove a todo</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">deleteTodo</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>gin<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> todo todoModel\n    todoID <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">,</span> todoID<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> todo<span class=\"token punctuation\">.</span>ID <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusNotFound<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"No todo found!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>todo<span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> gin<span class=\"token punctuation\">.</span>H<span class=\"token punctuation\">{</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Todo deleted successfully!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>Note: When you are using code production you must take care of the steps below:</p>\n</blockquote>\n<ul>\n<li>Do not fetch all the data select * from todos , use pagination</li>\n<li>Do not trust user input. You must validate the inputs, there are severals tools to validate input. Read the article for validation process</li>\n<li>Check every possible error</li>\n<li>You should use logging and authentication as your need</li>\n<li>I am really sorry for my BAD English and Writing flow. If you notice any mistake in the article please feel free to write a comment.</li>\n</ul>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"怎么用Gin去构建一个RESTful-API-Golang-Service【翻译】\"><a href=\"#怎么用Gin去构建一个RESTful-API-Golang-Service【翻译】\" class=\"headerlink\" title=\"怎么用Gin去构建一个RESTful API Golang Service【翻译】\"></a>怎么用Gin去构建一个RESTful API Golang Service【翻译】</h1><p>##前言</p>\n<p><a href=\"&quot;Cover&quot;\"><img src=\"http://oss.anonycurse.cn/article/images/20181105/531wGkj4qxe98UALsFO6vy9kRhdLLqVQZY0jnNhE.png\" alt=\"Cover\" title=\"Cover\"></a></p>\n<p>Today I’m going to build a simple API for todo application with the golang programming language. I’m going to use golang simplest/fastest framework gin-gonic and a beautiful ORM gorm for our database work. To install these packages go to your workspace $GOPATH/src and run these command below:</p>\n<pre><code class=\"go\">$ go get gopkg.in/gin-gonic/gin.v1\n$ go get -u github.com/jinzhu/gorm\n$ go get github.com/go-sql-driver/mysql\n</code></pre>\n<h2 id=\"In-generic-crud-application-we-need-the-API’s-as-follows\"><a href=\"#In-generic-crud-application-we-need-the-API’s-as-follows\" class=\"headerlink\" title=\"In generic crud application we need the API’s as follows:\"></a>In generic crud application we need the API’s as follows:</h2><ul>\n<li>POST todos/</li>\n<li>GET todos/</li>\n<li>GET todos/{id}</li>\n<li>PUT todos/{id}</li>\n<li>DELETE todos/{id}</li>\n</ul>\n<p>Let’s start coding, go to your $GOPATH/src and make a directory todo. Inside the todo directory create a file main.go. Import the “gin framework” to our project and create the routes like below inside main function. I like to add a prefix of the apis like “api/v1/”, that’s why we’ll use the router Group method</p>\n<pre><code class=\"go\">package main\n\nimport (\n       &quot;github.com/gin-gonic/gin&quot;\n)\nfunc main() {\nrouter := gin.Default()\nv1 := router.Group(&quot;/api/v1/todos&quot;)\n {\n  v1.POST(&quot;/&quot;, createTodo)\n  v1.GET(&quot;/&quot;, fetchAllTodo)\n  v1.GET(&quot;/:id&quot;, fetchSingleTodo)\n  v1.PUT(&quot;/:id&quot;, updateTodo)\n  v1.DELETE(&quot;/:id&quot;, deleteTodo)\n }\n router.Run()\n}\n</code></pre>\n<p>We have created five routes and they handle some functions like <code>createTodo</code>, <code>fetchAllTodo</code> etc. We’ll discuss about them soon.</p>\n<p>Now we need to setup a database connection. To use database pull the gorm package and mysql dialects in our code. Follow the code below:</p>\n<pre><code class=\"go\">package main\n\nimport (\n       &quot;github.com/gin-gonic/gin&quot;\n       &quot;github.com/jinzhu/gorm&quot;\n       _ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;\n)\n\nvar db *gorm.DB\nfunc init() {\n //open a db connection\n var err error\n db, err = gorm.Open(&quot;mysql&quot;, &quot;root:12345@/demo?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;)\n if err != nil {\n  panic(&quot;failed to connect database&quot;)\n }\n//Migrate the schema\n db.AutoMigrate(&amp;todoModel{})\n}\n</code></pre>\n<p>In the above code “mysql” is our database driver, “root” is database username, “12345” password and “demo” is database name. Please change these information as your needs.</p>\n<p>We’ll use the Database function to get the database connection. Lets make a todoModel and transformedTodo struct. The first struct will represent the original Todo and the second one will hold the transformed todo for response to the api. Here we transformed the todo response because we don’t expose some database fields (updated_at, created_at) to the consumer.</p>\n<pre><code class=\"go\">type (\n // todoModel describes a todoModel type\n todoModel struct {\n  gorm.Model\n  Title     string `json:&quot;title&quot;`\n  Completed int    `json:&quot;completed&quot;`\n }\n// transformedTodo represents a formatted todo\n transformedTodo struct {\n  ID        uint   `json:&quot;id&quot;`\n  Title     string `json:&quot;title&quot;`\n  Completed bool   `json:&quot;completed&quot;`\n }\n)\n</code></pre>\n<p>Todo struct has one field extra gorm.Model what does it mean? well, this field will embed a Model struct for us which contains four fields “ID, CreatedAt, UpdatedAt, DeletedAt”</p>\n<p>Gorm has migration facilities, we already used it in init function. When we run the application first it’ll create a connection and then the migration.</p>\n<pre><code class=\"go\">//Migrate the schema\n db.AutoMigrate(&amp;todoModel{})\n</code></pre>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/bhwTdjLFSN57B6kkl8CE8NVaZ7zeXGsYHhh7D0c0.png\" alt=\"Migrate \" title=\"Migrate \"></p>\n<p>Can you remember the five routes we wrote a minute earlier? Lets implement the five methods one by one.</p>\n<p>When a user send a POST request to the path ‘api/v1/todos/’ with ‘title and completed’ field it’ll be handled by this route v1.POST(“/”, createTodo)</p>\n<p>Lets Implement the createTodo function</p>\n<pre><code class=\"go\">// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n completed, _ := strconv.Atoi(c.PostForm(&quot;completed&quot;))\n todo := todoModel{Title: c.PostForm(&quot;title&quot;), Completed: completed}\n db.Save(&amp;todo)\n c.JSON(http.StatusCreated, gin.H{&quot;status&quot;: http.StatusCreated, &quot;message&quot;: &quot;Todo item created successfully!&quot;, &quot;resourceId&quot;: todo.ID})\n}\n</code></pre>\n<p>In the above code we use gin Context to receive the posted data and gorm database connection to save the todo. After saving the resource we send the resource id with a good &amp; meaningful response to the user.</p>\n<p>Lets implement the rest of the functions</p>\n<pre><code class=\"go\">// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n var todos []todoModel\n var _todos []transformedTodo\ndb.Find(&amp;todos)\nif len(todos) &lt;= 0 {\n  c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n  return\n }\n//transforms the todos for building a good response\n for _, item := range todos {\n  completed := false\n  if item.Completed == 1 {\n   completed = true\n  } else {\n   completed = false\n  }\n  _todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n }\n c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;data&quot;: _todos})\n}\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(&quot;id&quot;)\ndb.First(&amp;todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n  return\n }\ncompleted := false\n if todo.Completed == 1 {\n  completed = true\n } else {\n  completed = false\n }\n_todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;data&quot;: _todo})\n}\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(&quot;id&quot;)\ndb.First(&amp;todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n  return\n }\ndb.Model(&amp;todo).Update(&quot;title&quot;, c.PostForm(&quot;title&quot;))\n completed, _ := strconv.Atoi(c.PostForm(&quot;completed&quot;))\n db.Model(&amp;todo).Update(&quot;completed&quot;, completed)\n c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;message&quot;: &quot;Todo updated successfully!&quot;})\n}\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n var todo todoModel\n todoID := c.Param(&quot;id&quot;)\ndb.First(&amp;todo, todoID)\nif todo.ID == 0 {\n  c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n  return\n }\ndb.Delete(&amp;todo)\n c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;message&quot;: &quot;Todo deleted successfully!&quot;})\n}\n</code></pre>\n<p>In the fetchAllTodo function we fetched all the todos and and build a transformed response with id, title, completed . We removed the CreatedAt, UpdatedAt, DeletedAt fields and cast the integer value to bool.</p>\n<p>Well, we write enough code, let try to build the app and test it, I’m going test it using chrome extension Postman (you can use any REST client like curl to test).</p>\n<p>To build the app open your terminal and go the the project directory</p>\n<pre><code class=\"go\">$ go build main.go\n</code></pre>\n<p>The command will build a binary file main and to run the file us this command $ ./main . Wow, our simple todo app is running on port: 8080. It’ll display the debug log, because by default gin run’s in debug mode and port 8080.</p>\n<p>To test the api run postman and test the api sequentially</p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/wVld5PMtLBFEsVXjcE6pY9FhQSM5MuQB6hAJCtWe.png\" alt=\"Create a todo\" title=\"Create a todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/KVYw3KtSm1CqkS1R9jaTdxBXwue69Rv68F0eD4gL.png\" alt=\"Fetch all todos\" title=\"Fetch all todos\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/Iye2ekzbzEPkO8ScOwqnV0tLSun07itdPsXannpm.png\" alt=\"Fetch a single todo\" title=\"Fetch a single todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/Y5VFuzWRyiocmO6JERjrZw5hvn9B7OBiQbAi4U0S.png\" alt=\"Update a todo\" title=\"Update a todo\"></p>\n<p><img src=\"http://oss.anonycurse.cn/article/images/20181105/8b3CN4i3tfZbtsOvFglwi3DLtpHCPlmwfHuuBsWb.png\" alt=\"Delete a todo\" title=\"Delete a todo\"></p>\n<h2 id=\"Need-full-source-code\"><a href=\"#Need-full-source-code\" class=\"headerlink\" title=\"Need full source code?\"></a>Need full source code?</h2><pre><code class=\"go\">package main\n\nimport (\n    &quot;net/http&quot;\n    &quot;strconv&quot;\n\n    &quot;github.com/gin-gonic/gin&quot;\n    &quot;github.com/jinzhu/gorm&quot;\n    _ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;\n)\n\nvar db *gorm.DB\n\nfunc init() {\n    //open a db connection\n    var err error\n    db, err = gorm.Open(&quot;mysql&quot;, &quot;root:12345@/demo?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;)\n    if err != nil {\n        panic(&quot;failed to connect database&quot;)\n    }\n\n    //Migrate the schema\n    db.AutoMigrate(&amp;todoModel{})\n}\n\nfunc main() {\n\n    router := gin.Default()\n\n    v1 := router.Group(&quot;/api/v1/todos&quot;)\n    {\n        v1.POST(&quot;/&quot;, createTodo)\n        v1.GET(&quot;/&quot;, fetchAllTodo)\n        v1.GET(&quot;/:id&quot;, fetchSingleTodo)\n        v1.PUT(&quot;/:id&quot;, updateTodo)\n        v1.DELETE(&quot;/:id&quot;, deleteTodo)\n    }\n    router.Run()\n\n}\n\ntype (\n    // todoModel describes a todoModel type\n    todoModel struct {\n        gorm.Model\n        Title     string `json:&quot;title&quot;`\n        Completed int    `json:&quot;completed&quot;`\n    }\n\n    // transformedTodo represents a formatted todo\n    transformedTodo struct {\n        ID        uint   `json:&quot;id&quot;`\n        Title     string `json:&quot;title&quot;`\n        Completed bool   `json:&quot;completed&quot;`\n    }\n)\n\n// createTodo add a new todo\nfunc createTodo(c *gin.Context) {\n    completed, _ := strconv.Atoi(c.PostForm(&quot;completed&quot;))\n    todo := todoModel{Title: c.PostForm(&quot;title&quot;), Completed: completed}\n    db.Save(&amp;todo)\n    c.JSON(http.StatusCreated, gin.H{&quot;status&quot;: http.StatusCreated, &quot;message&quot;: &quot;Todo item created successfully!&quot;, &quot;resourceId&quot;: todo.ID})\n}\n\n// fetchAllTodo fetch all todos\nfunc fetchAllTodo(c *gin.Context) {\n    var todos []todoModel\n    var _todos []transformedTodo\n\n    db.Find(&amp;todos)\n\n    if len(todos) &lt;= 0 {\n        c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n        return\n    }\n\n    //transforms the todos for building a good response\n    for _, item := range todos {\n        completed := false\n        if item.Completed == 1 {\n            completed = true\n        } else {\n            completed = false\n        }\n        _todos = append(_todos, transformedTodo{ID: item.ID, Title: item.Title, Completed: completed})\n    }\n    c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;data&quot;: _todos})\n}\n\n// fetchSingleTodo fetch a single todo\nfunc fetchSingleTodo(c *gin.Context) {\n    var todo todoModel\n    todoID := c.Param(&quot;id&quot;)\n\n    db.First(&amp;todo, todoID)\n\n    if todo.ID == 0 {\n        c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n        return\n    }\n\n    completed := false\n    if todo.Completed == 1 {\n        completed = true\n    } else {\n        completed = false\n    }\n\n    _todo := transformedTodo{ID: todo.ID, Title: todo.Title, Completed: completed}\n    c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;data&quot;: _todo})\n}\n\n// updateTodo update a todo\nfunc updateTodo(c *gin.Context) {\n    var todo todoModel\n    todoID := c.Param(&quot;id&quot;)\n\n    db.First(&amp;todo, todoID)\n\n    if todo.ID == 0 {\n        c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n        return\n    }\n\n    db.Model(&amp;todo).Update(&quot;title&quot;, c.PostForm(&quot;title&quot;))\n    completed, _ := strconv.Atoi(c.PostForm(&quot;completed&quot;))\n    db.Model(&amp;todo).Update(&quot;completed&quot;, completed)\n    c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;message&quot;: &quot;Todo updated successfully!&quot;})\n}\n\n// deleteTodo remove a todo\nfunc deleteTodo(c *gin.Context) {\n    var todo todoModel\n    todoID := c.Param(&quot;id&quot;)\n\n    db.First(&amp;todo, todoID)\n\n    if todo.ID == 0 {\n        c.JSON(http.StatusNotFound, gin.H{&quot;status&quot;: http.StatusNotFound, &quot;message&quot;: &quot;No todo found!&quot;})\n        return\n    }\n\n    db.Delete(&amp;todo)\n    c.JSON(http.StatusOK, gin.H{&quot;status&quot;: http.StatusOK, &quot;message&quot;: &quot;Todo deleted successfully!&quot;})\n}\n</code></pre>\n<blockquote>\n<p>Note: When you are using code production you must take care of the steps below:</p>\n</blockquote>\n<ul>\n<li>Do not fetch all the data select * from todos , use pagination</li>\n<li>Do not trust user input. You must validate the inputs, there are severals tools to validate input. Read the article for validation process</li>\n<li>Check every possible error</li>\n<li>You should use logging and authentication as your need</li>\n<li>I am really sorry for my BAD English and Writing flow. If you notice any mistake in the article please feel free to write a comment.</li>\n</ul>\n"},{"title":"Oracle11GR2 RAC DataGuard容灾实施与维护手册","date":"2018-10-07T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle11gR2RAC DataGuard容灾实施与维护\n\n[Oracle 11G R2 官方文档][1] \n\n\n## 1.DataGuard的概述\n\n\n## 2.应用规划\n\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  RAC 双机+ASM   |  单实例+ASM   |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   16G  |   8G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  11.2.0.3   |   11.2.0.3  |\n|     |     |     |\n|     |     |     |\n|     |     |     |\n\n## 3.案列一（文件系统到文件系统）\n### 3.1 系统架构\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  单实例文件系统   |  单实例文件系统    |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   16G  |   8G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  11.2.0.3   |   11.2.0.3  |\n|     |     |     |\n\n### 3.2  安装步骤1（准备）\n* 1.安装相关的软件包\n* 2.准备OGG安装的环境变量\n* 3.上传并安装OGG软件\n* 4.准备测试数据\n\n#### 3.2.1 安装相关的软件包\n\n#### 3.2.1 准备OGG安装的环境变量\n\n#### 3.2.1 上传并安装OGG软件\n\n#### 3.2.1 准备测试数据\n```sql\n\ncreate tablespace itpux01 datafile '/u01/app/oracle/oradata/orcl/itpux01.dbf' size 100m autoextend off;\ncreate user itpux01 identified by itpux01 default tablespace itpux01 temporary tablespace temp;\ngrant dba to itpux01;   \n\n\ncreate tablespace itpux02 datafile '/u01/app/oracle/oradata/orcl/itpux02.dbf' size 100m autoextend off;\ncreate user itpux02 identified by itpux02 default tablespace itpux02 temporary tablespace temp;\ngrant dba to itpux02;   \n\n\ncreate tablespace itpux03 datafile '/u01/app/oracle/oradata/orcl/itpux03.dbf' size 100m autoextend off;\ncreate user itpux03 identified by itpux03 default tablespace itpux03 temporary tablespace temp;\ngrant dba to itpux03;  \n\n\n【源库导出、导入数据结构】\ncreate directory itpuxbak as '/home/oracle';\ngrant read,write on directory itpuxbak to system; \ngrant create any directory to system;\n\nexpdp system/jia directory=itpuxbak dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log content=metadata_only\n\n--expdp system/jia  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log schemas=itpux01,itpux02,itpux03\n\n\nimpdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log full=y\n\n--impdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp expdp_itpux010203.dmp schemas=itpux01,itpux02,itpux03\n\n```\n\n\n### 3.3 安装步骤2（配置环境）\n* 1.源端打开归档，目标端一般不需要\n* 2.源端数据库打开补充日志\n* 3.源端是数据库开启FORCE_LOGGING\n* 4.关闭回收站功能\n* 5.源和目标的网络通信正常\n* 6.创建专用的GoldenGate用户来同步数据\n* 7.修改数据库参数（源和目标端）\n\n#### 3.3.1 源端打开归档，目标端一般不需要\n> &emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.\n\n* 开启归档 \n\n```sql\n-- 1.确定当前没有开启归档\nSQL> archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n\n--2.创建归档目录\n\n--3.重启数据库到MOUNT\nSHUTDOWN IMMEDIATE\nSTARTUP MOUNT\n--4.修改归档路径并开启归档\nALTER SYSTEM SET  db_recovery_file_dest='/u01/backup' scope=spfile;\nALTER DATABASE ARCHIVELOG;\n--5.重启数据库\nSHUTDOWN IMMEDIATE\nSTARTUP\n```\n\n* 关闭归档\n\n```sql\n--1.确定当前为归档\nSQL> archive log list;\nDatabase log mode              Archive Mode\nAutomatic archival             Enabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nNext log sequence to archive   21\nCurrent log sequence           21\n\n--2.重启数据库到MOUNT\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area 2137886720 bytes\nFixed Size                  2254952 bytes\nVariable Size             570427288 bytes\nDatabase Buffers         1560281088 bytes\nRedo Buffers                4923392 bytes\nDatabase mounted.\n\n--3.关闭归档并打开数据库\nSQL>  alter database noarchivelog;\n\nDatabase altered.\nSQL> alter database open;\n\nDatabase altered.\n\nSQL> archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n```\n\n#### 3.3.2 源端数据库打开补充日志\n```sql\n--1.查看是否打开最小日志记录\nSELECT SUPPLEMENTAL_LOG_DATA_MIN FROM v$database;\n\n--2.开启最小日志记录\nALTER DATABASE ADD SUPPLEMENTAL LOG DATA;\n\n--3.切换归档\nALTER SYSTEM SWITCH LOGFILE;\n\n```\n#### 3.3.3 源端是数据库开启FORCE_LOGGING\n```sql\n--1.查询是否开启强制日志模式\nforce_logging from v$database;\n\n--2.打开\nalter database force logging;\nalter system switch logfile;\n```\n\n#### 3.3.4 关闭回收站功能\n> &emsp;&emsp;官方没有要求关闭回收站，但是我们一般都会关闭。关闭回收站必须重启生效。\n```sql\n--1.查看回收是否关闭\nshow parameter recyclebin\n\n--2.关闭回收站\nalter system set recyclebin=off scope=spfile;\n\n--3.重启数据库\n```\n#### 3.3.5 源和目标的网络通信正常\n```sql\n\n```\n\n#### 3.3.6 创建专用的GoldenGate用户来同步数据\n\n#### 3.3.7 修改数据库参数（源和目标端）\n```sql\nalter system set enable_goldengate_replication=true scope=both;\nshow paramteter enable_goldengate_replication;\n```\n\n### 3.4 安装步骤（配置OGG）\n```sql\n1.创建文件目录\ncreate subdirs\n\n01.配置配置管理进程mgr\nggsci> edit params mgr\nport 7809\nautostart er *\nautorestart er *,waitminutes 3,retries 15\npurgeoldextracts ./dirdat/*,usecheckpoints,minkeepdays 7*/\n\n02\nalter system set enable_goldengate_replication=true scope=both;\n\n\n```\n\n\n\n## 4.案列二（ASM到文件系统）\n\n## 5.案列三（RAC ASM 到 单机ASN）\n### 3.1 系统架构\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  RAC   |  单实例ASM    |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   4G  |   4G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  12.1.0.3   |   12.1.0.3  |\n|     |     |     |\n\n### 3.2  安装步骤（准备）\n* 1.安装相关的软件包\n* 2.准备OGG安装的环境变量\n* 3.上传并安装OGG软件\n* 4.准备测试数据\n\n#### 3.2.1 安装相关的软件包\n\n#### 3.2.1 准备OGG安装的环境变量\n\n#### 3.2.1 上传并安装OGG软件\n\n#### 3.2.1 准备测试数据\n\n\n### 3.3 安装步骤（配置环境）\n* 1.源端打开归档，目标端一般不需要\n* 2.源端数据库打开补充日志\n* 3.源端是数据库开启FORCE_LOGGING\n* 4.关闭回收站功能\n* 5.源和目标的网络通信正常\n* 6.创建专用的GoldenGate用户来同步数据\n\n#### 3.3.1 源端打开归档，目标端一般不需要\n> &emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.\n\n\n#### 3.3.2 源端数据库打开补充日志\n#### 3.3.3 源端是数据库开启FORCE_LOGGING\n#### 3.3.4 关闭回收站功能\n#### 3.3.5 源和目标的网络通信正常\n#### 3.3.6 创建专用的GoldenGate用户来同步数据\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle11GR2 RAC DataGuard容灾实施与维护手册.md","raw":"---\ntitle: Oracle11GR2 RAC DataGuard容灾实施与维护手册\ndate: 2018-10-07 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - RAC\n  - DataGuard\n  - 备份容灾\n---\n\n\n# Oracle11gR2RAC DataGuard容灾实施与维护\n\n[Oracle 11G R2 官方文档][1] \n\n\n## 1.DataGuard的概述\n\n\n## 2.应用规划\n\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  RAC 双机+ASM   |  单实例+ASM   |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   16G  |   8G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  11.2.0.3   |   11.2.0.3  |\n|     |     |     |\n|     |     |     |\n|     |     |     |\n\n## 3.案列一（文件系统到文件系统）\n### 3.1 系统架构\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  单实例文件系统   |  单实例文件系统    |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   16G  |   8G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  11.2.0.3   |   11.2.0.3  |\n|     |     |     |\n\n### 3.2  安装步骤1（准备）\n* 1.安装相关的软件包\n* 2.准备OGG安装的环境变量\n* 3.上传并安装OGG软件\n* 4.准备测试数据\n\n#### 3.2.1 安装相关的软件包\n\n#### 3.2.1 准备OGG安装的环境变量\n\n#### 3.2.1 上传并安装OGG软件\n\n#### 3.2.1 准备测试数据\n```sql\n\ncreate tablespace itpux01 datafile '/u01/app/oracle/oradata/orcl/itpux01.dbf' size 100m autoextend off;\ncreate user itpux01 identified by itpux01 default tablespace itpux01 temporary tablespace temp;\ngrant dba to itpux01;   \n\n\ncreate tablespace itpux02 datafile '/u01/app/oracle/oradata/orcl/itpux02.dbf' size 100m autoextend off;\ncreate user itpux02 identified by itpux02 default tablespace itpux02 temporary tablespace temp;\ngrant dba to itpux02;   \n\n\ncreate tablespace itpux03 datafile '/u01/app/oracle/oradata/orcl/itpux03.dbf' size 100m autoextend off;\ncreate user itpux03 identified by itpux03 default tablespace itpux03 temporary tablespace temp;\ngrant dba to itpux03;  \n\n\n【源库导出、导入数据结构】\ncreate directory itpuxbak as '/home/oracle';\ngrant read,write on directory itpuxbak to system; \ngrant create any directory to system;\n\nexpdp system/jia directory=itpuxbak dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log content=metadata_only\n\n--expdp system/jia  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log schemas=itpux01,itpux02,itpux03\n\n\nimpdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log full=y\n\n--impdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp expdp_itpux010203.dmp schemas=itpux01,itpux02,itpux03\n\n```\n\n\n### 3.3 安装步骤2（配置环境）\n* 1.源端打开归档，目标端一般不需要\n* 2.源端数据库打开补充日志\n* 3.源端是数据库开启FORCE_LOGGING\n* 4.关闭回收站功能\n* 5.源和目标的网络通信正常\n* 6.创建专用的GoldenGate用户来同步数据\n* 7.修改数据库参数（源和目标端）\n\n#### 3.3.1 源端打开归档，目标端一般不需要\n> &emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.\n\n* 开启归档 \n\n```sql\n-- 1.确定当前没有开启归档\nSQL> archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n\n--2.创建归档目录\n\n--3.重启数据库到MOUNT\nSHUTDOWN IMMEDIATE\nSTARTUP MOUNT\n--4.修改归档路径并开启归档\nALTER SYSTEM SET  db_recovery_file_dest='/u01/backup' scope=spfile;\nALTER DATABASE ARCHIVELOG;\n--5.重启数据库\nSHUTDOWN IMMEDIATE\nSTARTUP\n```\n\n* 关闭归档\n\n```sql\n--1.确定当前为归档\nSQL> archive log list;\nDatabase log mode              Archive Mode\nAutomatic archival             Enabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nNext log sequence to archive   21\nCurrent log sequence           21\n\n--2.重启数据库到MOUNT\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area 2137886720 bytes\nFixed Size                  2254952 bytes\nVariable Size             570427288 bytes\nDatabase Buffers         1560281088 bytes\nRedo Buffers                4923392 bytes\nDatabase mounted.\n\n--3.关闭归档并打开数据库\nSQL>  alter database noarchivelog;\n\nDatabase altered.\nSQL> alter database open;\n\nDatabase altered.\n\nSQL> archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n```\n\n#### 3.3.2 源端数据库打开补充日志\n```sql\n--1.查看是否打开最小日志记录\nSELECT SUPPLEMENTAL_LOG_DATA_MIN FROM v$database;\n\n--2.开启最小日志记录\nALTER DATABASE ADD SUPPLEMENTAL LOG DATA;\n\n--3.切换归档\nALTER SYSTEM SWITCH LOGFILE;\n\n```\n#### 3.3.3 源端是数据库开启FORCE_LOGGING\n```sql\n--1.查询是否开启强制日志模式\nforce_logging from v$database;\n\n--2.打开\nalter database force logging;\nalter system switch logfile;\n```\n\n#### 3.3.4 关闭回收站功能\n> &emsp;&emsp;官方没有要求关闭回收站，但是我们一般都会关闭。关闭回收站必须重启生效。\n```sql\n--1.查看回收是否关闭\nshow parameter recyclebin\n\n--2.关闭回收站\nalter system set recyclebin=off scope=spfile;\n\n--3.重启数据库\n```\n#### 3.3.5 源和目标的网络通信正常\n```sql\n\n```\n\n#### 3.3.6 创建专用的GoldenGate用户来同步数据\n\n#### 3.3.7 修改数据库参数（源和目标端）\n```sql\nalter system set enable_goldengate_replication=true scope=both;\nshow paramteter enable_goldengate_replication;\n```\n\n### 3.4 安装步骤（配置OGG）\n```sql\n1.创建文件目录\ncreate subdirs\n\n01.配置配置管理进程mgr\nggsci> edit params mgr\nport 7809\nautostart er *\nautorestart er *,waitminutes 3,retries 15\npurgeoldextracts ./dirdat/*,usecheckpoints,minkeepdays 7*/\n\n02\nalter system set enable_goldengate_replication=true scope=both;\n\n\n```\n\n\n\n## 4.案列二（ASM到文件系统）\n\n## 5.案列三（RAC ASM 到 单机ASN）\n### 3.1 系统架构\n|   参数  |  主库   |  备库   |\n:---:|:---:|:---:\n|系统架构     |  RAC   |  单实例ASM    |\n|  数据库版本   |  11.2.0.4   |   11.2.0.4  |\n|   内存  |   4G  |   4G  |\n|  CPU   |  4   |  4   |\n|   GoldenGate  |  12.1.0.3   |   12.1.0.3  |\n|     |     |     |\n\n### 3.2  安装步骤（准备）\n* 1.安装相关的软件包\n* 2.准备OGG安装的环境变量\n* 3.上传并安装OGG软件\n* 4.准备测试数据\n\n#### 3.2.1 安装相关的软件包\n\n#### 3.2.1 准备OGG安装的环境变量\n\n#### 3.2.1 上传并安装OGG软件\n\n#### 3.2.1 准备测试数据\n\n\n### 3.3 安装步骤（配置环境）\n* 1.源端打开归档，目标端一般不需要\n* 2.源端数据库打开补充日志\n* 3.源端是数据库开启FORCE_LOGGING\n* 4.关闭回收站功能\n* 5.源和目标的网络通信正常\n* 6.创建专用的GoldenGate用户来同步数据\n\n#### 3.3.1 源端打开归档，目标端一般不需要\n> &emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.\n\n\n#### 3.3.2 源端数据库打开补充日志\n#### 3.3.3 源端是数据库开启FORCE_LOGGING\n#### 3.3.4 关闭回收站功能\n#### 3.3.5 源和目标的网络通信正常\n#### 3.3.6 创建专用的GoldenGate用户来同步数据\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle11GR2 RAC DataGuard容灾实施与维护手册","published":1,"updated":"2019-05-03T15:40:04.341Z","_id":"cjv88taa5001ai0cdmu793yqw","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle11gR2RAC-DataGuard容灾实施与维护\"><a href=\"#Oracle11gR2RAC-DataGuard容灾实施与维护\" class=\"headerlink\" title=\"Oracle11gR2RAC DataGuard容灾实施与维护\"></a>Oracle11gR2RAC DataGuard容灾实施与维护</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-DataGuard的概述\"><a href=\"#1-DataGuard的概述\" class=\"headerlink\" title=\"1.DataGuard的概述\"></a>1.DataGuard的概述</h2><h2 id=\"2-应用规划\"><a href=\"#2-应用规划\" class=\"headerlink\" title=\"2.应用规划\"></a>2.应用规划</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">RAC 双机+ASM</td>\n<td>单实例+ASM</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">16G</td>\n<td>8G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">11.2.0.3</td>\n<td>11.2.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"3-案列一（文件系统到文件系统）\"><a href=\"#3-案列一（文件系统到文件系统）\" class=\"headerlink\" title=\"3.案列一（文件系统到文件系统）\"></a>3.案列一（文件系统到文件系统）</h2><h3 id=\"3-1-系统架构\"><a href=\"#3-1-系统架构\" class=\"headerlink\" title=\"3.1 系统架构\"></a>3.1 系统架构</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">单实例文件系统</td>\n<td>单实例文件系统</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">16G</td>\n<td>8G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">11.2.0.3</td>\n<td>11.2.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-2-安装步骤1（准备）\"><a href=\"#3-2-安装步骤1（准备）\" class=\"headerlink\" title=\"3.2  安装步骤1（准备）\"></a>3.2  安装步骤1（准备）</h3><ul>\n<li>1.安装相关的软件包</li>\n<li>2.准备OGG安装的环境变量</li>\n<li>3.上传并安装OGG软件</li>\n<li>4.准备测试数据</li>\n</ul>\n<h4 id=\"3-2-1-安装相关的软件包\"><a href=\"#3-2-1-安装相关的软件包\" class=\"headerlink\" title=\"3.2.1 安装相关的软件包\"></a>3.2.1 安装相关的软件包</h4><h4 id=\"3-2-1-准备OGG安装的环境变量\"><a href=\"#3-2-1-准备OGG安装的环境变量\" class=\"headerlink\" title=\"3.2.1 准备OGG安装的环境变量\"></a>3.2.1 准备OGG安装的环境变量</h4><h4 id=\"3-2-1-上传并安装OGG软件\"><a href=\"#3-2-1-上传并安装OGG软件\" class=\"headerlink\" title=\"3.2.1 上传并安装OGG软件\"></a>3.2.1 上传并安装OGG软件</h4><h4 id=\"3-2-1-准备测试数据\"><a href=\"#3-2-1-准备测试数据\" class=\"headerlink\" title=\"3.2.1 准备测试数据\"></a>3.2.1 准备测试数据</h4><pre class=\" language-sql\"><code class=\"language-sql\">\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">tablespace</span> itpux01 datafile <span class=\"token string\">'/u01/app/oracle/oradata/orcl/itpux01.dbf'</span> size 100m autoextend <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">user</span> itpux01 identified <span class=\"token keyword\">by</span> itpux01 <span class=\"token keyword\">default</span> <span class=\"token keyword\">tablespace</span> itpux01 <span class=\"token keyword\">temporary</span> <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">temp</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token number\">dba</span> <span class=\"token keyword\">to</span> itpux01<span class=\"token punctuation\">;</span>   \n\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">tablespace</span> itpux02 datafile <span class=\"token string\">'/u01/app/oracle/oradata/orcl/itpux02.dbf'</span> size 100m autoextend <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">user</span> itpux02 identified <span class=\"token keyword\">by</span> itpux02 <span class=\"token keyword\">default</span> <span class=\"token keyword\">tablespace</span> itpux02 <span class=\"token keyword\">temporary</span> <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">temp</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token number\">dba</span> <span class=\"token keyword\">to</span> itpux02<span class=\"token punctuation\">;</span>   \n\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">tablespace</span> itpux03 datafile <span class=\"token string\">'/u01/app/oracle/oradata/orcl/itpux03.dbf'</span> size 100m autoextend <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">user</span> itpux03 identified <span class=\"token keyword\">by</span> itpux03 <span class=\"token keyword\">default</span> <span class=\"token keyword\">tablespace</span> itpux03 <span class=\"token keyword\">temporary</span> <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">temp</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token number\">dba</span> <span class=\"token keyword\">to</span> itpux03<span class=\"token punctuation\">;</span>  \n\n\n【源库导出、导入数据结构】\n<span class=\"token keyword\">create</span> directory itpuxbak <span class=\"token keyword\">as</span> <span class=\"token string\">'/home/oracle'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">read</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">write</span> <span class=\"token keyword\">on</span> directory itpuxbak <span class=\"token keyword\">to</span> system<span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">any</span> directory <span class=\"token keyword\">to</span> system<span class=\"token punctuation\">;</span>\n\nexpdp system<span class=\"token operator\">/</span>jia directory<span class=\"token operator\">=</span>itpuxbak <span class=\"token keyword\">dumpfile</span><span class=\"token operator\">=</span>expdp_full_db01<span class=\"token punctuation\">.</span>dmp logfile<span class=\"token operator\">=</span>expdp_full_db01<span class=\"token punctuation\">.</span>log content<span class=\"token operator\">=</span>metadata_only\n\n<span class=\"token comment\" spellcheck=\"true\">--expdp system/jia  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log schemas=itpux01,itpux02,itpux03</span>\n\n\nimpdp system<span class=\"token operator\">/</span>oracle  directory<span class=\"token operator\">=</span>itpuxbak <span class=\"token keyword\">dumpfile</span><span class=\"token operator\">=</span>expdp_itpux010203<span class=\"token punctuation\">.</span>dmp logfile<span class=\"token operator\">=</span>expdp_itpux010203<span class=\"token punctuation\">.</span>log <span class=\"token keyword\">full</span><span class=\"token operator\">=</span>y\n\n<span class=\"token comment\" spellcheck=\"true\">--impdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp expdp_itpux010203.dmp schemas=itpux01,itpux02,itpux03</span>\n\n</code></pre>\n<h3 id=\"3-3-安装步骤2（配置环境）\"><a href=\"#3-3-安装步骤2（配置环境）\" class=\"headerlink\" title=\"3.3 安装步骤2（配置环境）\"></a>3.3 安装步骤2（配置环境）</h3><ul>\n<li>1.源端打开归档，目标端一般不需要</li>\n<li>2.源端数据库打开补充日志</li>\n<li>3.源端是数据库开启FORCE_LOGGING</li>\n<li>4.关闭回收站功能</li>\n<li>5.源和目标的网络通信正常</li>\n<li>6.创建专用的GoldenGate用户来同步数据</li>\n<li>7.修改数据库参数（源和目标端）</li>\n</ul>\n<h4 id=\"3-3-1-源端打开归档，目标端一般不需要\"><a href=\"#3-3-1-源端打开归档，目标端一般不需要\" class=\"headerlink\" title=\"3.3.1 源端打开归档，目标端一般不需要\"></a>3.3.1 源端打开归档，目标端一般不需要</h4><blockquote>\n<p>&emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.</p>\n</blockquote>\n<ul>\n<li>开启归档 </li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">-- 1.确定当前没有开启归档</span>\nSQL<span class=\"token operator\">></span> archive log list<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> log mode              <span class=\"token keyword\">No</span> Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     <span class=\"token number\">19</span>\n<span class=\"token keyword\">Current</span> log sequence           <span class=\"token number\">21</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.创建归档目录</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.重启数据库到MOUNT</span>\n<span class=\"token keyword\">SHUTDOWN</span> IMMEDIATE\nSTARTUP MOUNT\n<span class=\"token comment\" spellcheck=\"true\">--4.修改归档路径并开启归档</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span>  db_recovery_file_dest<span class=\"token operator\">=</span><span class=\"token string\">'/u01/backup'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> ARCHIVELOG<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--5.重启数据库</span>\n<span class=\"token keyword\">SHUTDOWN</span> IMMEDIATE\nSTARTUP\n</code></pre>\n<ul>\n<li>关闭归档</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.确定当前为归档</span>\nSQL<span class=\"token operator\">></span> archive log list<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> log mode              Archive Mode\nAutomatic archival             Enabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     <span class=\"token number\">19</span>\n<span class=\"token keyword\">Next</span> log sequence <span class=\"token keyword\">to</span> archive   <span class=\"token number\">21</span>\n<span class=\"token keyword\">Current</span> log sequence           <span class=\"token number\">21</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.重启数据库到MOUNT</span>\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> closed<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">Database</span> dismounted<span class=\"token punctuation\">.</span>\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area <span class=\"token number\">2137886720</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2254952</span> bytes\nVariable Size             <span class=\"token number\">570427288</span> bytes\n<span class=\"token keyword\">Database</span> Buffers         <span class=\"token number\">1560281088</span> bytes\nRedo Buffers                <span class=\"token number\">4923392</span> bytes\n<span class=\"token keyword\">Database</span> mounted<span class=\"token punctuation\">.</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.关闭归档并打开数据库</span>\nSQL<span class=\"token operator\">></span>  <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> noarchivelog<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> archive log list<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> log mode              <span class=\"token keyword\">No</span> Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     <span class=\"token number\">19</span>\n<span class=\"token keyword\">Current</span> log sequence           <span class=\"token number\">21</span>\n</code></pre>\n<h4 id=\"3-3-2-源端数据库打开补充日志\"><a href=\"#3-3-2-源端数据库打开补充日志\" class=\"headerlink\" title=\"3.3.2 源端数据库打开补充日志\"></a>3.3.2 源端数据库打开补充日志</h4><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.查看是否打开最小日志记录</span>\n<span class=\"token keyword\">SELECT</span> SUPPLEMENTAL_LOG_DATA_MIN <span class=\"token keyword\">FROM</span> v$<span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.开启最小日志记录</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token keyword\">ADD</span> SUPPLEMENTAL LOG <span class=\"token keyword\">DATA</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.切换归档</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM SWITCH LOGFILE<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h4 id=\"3-3-3-源端是数据库开启FORCE-LOGGING\"><a href=\"#3-3-3-源端是数据库开启FORCE-LOGGING\" class=\"headerlink\" title=\"3.3.3 源端是数据库开启FORCE_LOGGING\"></a>3.3.3 源端是数据库开启FORCE_LOGGING</h4><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.查询是否开启强制日志模式</span>\nforce_logging <span class=\"token keyword\">from</span> v$<span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.打开</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">force</span> logging<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> system switch logfile<span class=\"token punctuation\">;</span>\n</code></pre>\n<h4 id=\"3-3-4-关闭回收站功能\"><a href=\"#3-3-4-关闭回收站功能\" class=\"headerlink\" title=\"3.3.4 关闭回收站功能\"></a>3.3.4 关闭回收站功能</h4><blockquote>\n<p>&emsp;&emsp;官方没有要求关闭回收站，但是我们一般都会关闭。关闭回收站必须重启生效。<br><code>`</code>sql<br>–1.查看回收是否关闭<br>show parameter recyclebin</p>\n</blockquote>\n<p>–2.关闭回收站<br>alter system set recyclebin=off scope=spfile;</p>\n<p>–3.重启数据库</p>\n<pre><code>#### 3.3.5 源和目标的网络通信正常\n```sql\n\n</code></pre><h4 id=\"3-3-6-创建专用的GoldenGate用户来同步数据\"><a href=\"#3-3-6-创建专用的GoldenGate用户来同步数据\" class=\"headerlink\" title=\"3.3.6 创建专用的GoldenGate用户来同步数据\"></a>3.3.6 创建专用的GoldenGate用户来同步数据</h4><h4 id=\"3-3-7-修改数据库参数（源和目标端）\"><a href=\"#3-3-7-修改数据库参数（源和目标端）\" class=\"headerlink\" title=\"3.3.7 修改数据库参数（源和目标端）\"></a>3.3.7 修改数据库参数（源和目标端）</h4><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> enable_goldengate_replication<span class=\"token operator\">=</span><span class=\"token boolean\">true</span> scope<span class=\"token operator\">=</span>both<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">show</span> paramteter enable_goldengate_replication<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"3-4-安装步骤（配置OGG）\"><a href=\"#3-4-安装步骤（配置OGG）\" class=\"headerlink\" title=\"3.4 安装步骤（配置OGG）\"></a>3.4 安装步骤（配置OGG）</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>创建文件目录\n<span class=\"token keyword\">create</span> subdirs\n\n<span class=\"token number\">01</span><span class=\"token punctuation\">.</span>配置配置管理进程mgr\nggsci<span class=\"token operator\">></span> edit params mgr\nport <span class=\"token number\">7809</span>\nautostart er <span class=\"token operator\">*</span>\nautorestart er <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>waitminutes <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>retries <span class=\"token number\">15</span>\npurgeoldextracts <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token comment\" spellcheck=\"true\">/*,usecheckpoints,minkeepdays 7*/</span>\n\n<span class=\"token number\">02</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> enable_goldengate_replication<span class=\"token operator\">=</span><span class=\"token boolean\">true</span> scope<span class=\"token operator\">=</span>both<span class=\"token punctuation\">;</span>\n\n\n</code></pre>\n<h2 id=\"4-案列二（ASM到文件系统）\"><a href=\"#4-案列二（ASM到文件系统）\" class=\"headerlink\" title=\"4.案列二（ASM到文件系统）\"></a>4.案列二（ASM到文件系统）</h2><h2 id=\"5-案列三（RAC-ASM-到-单机ASN）\"><a href=\"#5-案列三（RAC-ASM-到-单机ASN）\" class=\"headerlink\" title=\"5.案列三（RAC ASM 到 单机ASN）\"></a>5.案列三（RAC ASM 到 单机ASN）</h2><h3 id=\"3-1-系统架构-1\"><a href=\"#3-1-系统架构-1\" class=\"headerlink\" title=\"3.1 系统架构\"></a>3.1 系统架构</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">RAC</td>\n<td>单实例ASM</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">4G</td>\n<td>4G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">12.1.0.3</td>\n<td>12.1.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-2-安装步骤（准备）\"><a href=\"#3-2-安装步骤（准备）\" class=\"headerlink\" title=\"3.2  安装步骤（准备）\"></a>3.2  安装步骤（准备）</h3><ul>\n<li>1.安装相关的软件包</li>\n<li>2.准备OGG安装的环境变量</li>\n<li>3.上传并安装OGG软件</li>\n<li>4.准备测试数据</li>\n</ul>\n<h4 id=\"3-2-1-安装相关的软件包-1\"><a href=\"#3-2-1-安装相关的软件包-1\" class=\"headerlink\" title=\"3.2.1 安装相关的软件包\"></a>3.2.1 安装相关的软件包</h4><h4 id=\"3-2-1-准备OGG安装的环境变量-1\"><a href=\"#3-2-1-准备OGG安装的环境变量-1\" class=\"headerlink\" title=\"3.2.1 准备OGG安装的环境变量\"></a>3.2.1 准备OGG安装的环境变量</h4><h4 id=\"3-2-1-上传并安装OGG软件-1\"><a href=\"#3-2-1-上传并安装OGG软件-1\" class=\"headerlink\" title=\"3.2.1 上传并安装OGG软件\"></a>3.2.1 上传并安装OGG软件</h4><h4 id=\"3-2-1-准备测试数据-1\"><a href=\"#3-2-1-准备测试数据-1\" class=\"headerlink\" title=\"3.2.1 准备测试数据\"></a>3.2.1 准备测试数据</h4><h3 id=\"3-3-安装步骤（配置环境）\"><a href=\"#3-3-安装步骤（配置环境）\" class=\"headerlink\" title=\"3.3 安装步骤（配置环境）\"></a>3.3 安装步骤（配置环境）</h3><ul>\n<li>1.源端打开归档，目标端一般不需要</li>\n<li>2.源端数据库打开补充日志</li>\n<li>3.源端是数据库开启FORCE_LOGGING</li>\n<li>4.关闭回收站功能</li>\n<li>5.源和目标的网络通信正常</li>\n<li>6.创建专用的GoldenGate用户来同步数据</li>\n</ul>\n<h4 id=\"3-3-1-源端打开归档，目标端一般不需要-1\"><a href=\"#3-3-1-源端打开归档，目标端一般不需要-1\" class=\"headerlink\" title=\"3.3.1 源端打开归档，目标端一般不需要\"></a>3.3.1 源端打开归档，目标端一般不需要</h4><blockquote>\n<p>&emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.</p>\n</blockquote>\n<h4 id=\"3-3-2-源端数据库打开补充日志-1\"><a href=\"#3-3-2-源端数据库打开补充日志-1\" class=\"headerlink\" title=\"3.3.2 源端数据库打开补充日志\"></a>3.3.2 源端数据库打开补充日志</h4><h4 id=\"3-3-3-源端是数据库开启FORCE-LOGGING-1\"><a href=\"#3-3-3-源端是数据库开启FORCE-LOGGING-1\" class=\"headerlink\" title=\"3.3.3 源端是数据库开启FORCE_LOGGING\"></a>3.3.3 源端是数据库开启FORCE_LOGGING</h4><h4 id=\"3-3-4-关闭回收站功能-1\"><a href=\"#3-3-4-关闭回收站功能-1\" class=\"headerlink\" title=\"3.3.4 关闭回收站功能\"></a>3.3.4 关闭回收站功能</h4><h4 id=\"3-3-5-源和目标的网络通信正常\"><a href=\"#3-3-5-源和目标的网络通信正常\" class=\"headerlink\" title=\"3.3.5 源和目标的网络通信正常\"></a>3.3.5 源和目标的网络通信正常</h4><h4 id=\"3-3-6-创建专用的GoldenGate用户来同步数据-1\"><a href=\"#3-3-6-创建专用的GoldenGate用户来同步数据-1\" class=\"headerlink\" title=\"3.3.6 创建专用的GoldenGate用户来同步数据\"></a>3.3.6 创建专用的GoldenGate用户来同步数据</h4>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle11gR2RAC-DataGuard容灾实施与维护\"><a href=\"#Oracle11gR2RAC-DataGuard容灾实施与维护\" class=\"headerlink\" title=\"Oracle11gR2RAC DataGuard容灾实施与维护\"></a>Oracle11gR2RAC DataGuard容灾实施与维护</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-DataGuard的概述\"><a href=\"#1-DataGuard的概述\" class=\"headerlink\" title=\"1.DataGuard的概述\"></a>1.DataGuard的概述</h2><h2 id=\"2-应用规划\"><a href=\"#2-应用规划\" class=\"headerlink\" title=\"2.应用规划\"></a>2.应用规划</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">RAC 双机+ASM</td>\n<td>单实例+ASM</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">16G</td>\n<td>8G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">11.2.0.3</td>\n<td>11.2.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"3-案列一（文件系统到文件系统）\"><a href=\"#3-案列一（文件系统到文件系统）\" class=\"headerlink\" title=\"3.案列一（文件系统到文件系统）\"></a>3.案列一（文件系统到文件系统）</h2><h3 id=\"3-1-系统架构\"><a href=\"#3-1-系统架构\" class=\"headerlink\" title=\"3.1 系统架构\"></a>3.1 系统架构</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">单实例文件系统</td>\n<td>单实例文件系统</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">16G</td>\n<td>8G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">11.2.0.3</td>\n<td>11.2.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-2-安装步骤1（准备）\"><a href=\"#3-2-安装步骤1（准备）\" class=\"headerlink\" title=\"3.2  安装步骤1（准备）\"></a>3.2  安装步骤1（准备）</h3><ul>\n<li>1.安装相关的软件包</li>\n<li>2.准备OGG安装的环境变量</li>\n<li>3.上传并安装OGG软件</li>\n<li>4.准备测试数据</li>\n</ul>\n<h4 id=\"3-2-1-安装相关的软件包\"><a href=\"#3-2-1-安装相关的软件包\" class=\"headerlink\" title=\"3.2.1 安装相关的软件包\"></a>3.2.1 安装相关的软件包</h4><h4 id=\"3-2-1-准备OGG安装的环境变量\"><a href=\"#3-2-1-准备OGG安装的环境变量\" class=\"headerlink\" title=\"3.2.1 准备OGG安装的环境变量\"></a>3.2.1 准备OGG安装的环境变量</h4><h4 id=\"3-2-1-上传并安装OGG软件\"><a href=\"#3-2-1-上传并安装OGG软件\" class=\"headerlink\" title=\"3.2.1 上传并安装OGG软件\"></a>3.2.1 上传并安装OGG软件</h4><h4 id=\"3-2-1-准备测试数据\"><a href=\"#3-2-1-准备测试数据\" class=\"headerlink\" title=\"3.2.1 准备测试数据\"></a>3.2.1 准备测试数据</h4><pre><code class=\"sql\">\ncreate tablespace itpux01 datafile &#39;/u01/app/oracle/oradata/orcl/itpux01.dbf&#39; size 100m autoextend off;\ncreate user itpux01 identified by itpux01 default tablespace itpux01 temporary tablespace temp;\ngrant dba to itpux01;   \n\n\ncreate tablespace itpux02 datafile &#39;/u01/app/oracle/oradata/orcl/itpux02.dbf&#39; size 100m autoextend off;\ncreate user itpux02 identified by itpux02 default tablespace itpux02 temporary tablespace temp;\ngrant dba to itpux02;   \n\n\ncreate tablespace itpux03 datafile &#39;/u01/app/oracle/oradata/orcl/itpux03.dbf&#39; size 100m autoextend off;\ncreate user itpux03 identified by itpux03 default tablespace itpux03 temporary tablespace temp;\ngrant dba to itpux03;  \n\n\n【源库导出、导入数据结构】\ncreate directory itpuxbak as &#39;/home/oracle&#39;;\ngrant read,write on directory itpuxbak to system; \ngrant create any directory to system;\n\nexpdp system/jia directory=itpuxbak dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log content=metadata_only\n\n--expdp system/jia  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log schemas=itpux01,itpux02,itpux03\n\n\nimpdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp logfile=expdp_itpux010203.log full=y\n\n--impdp system/oracle  directory=itpuxbak dumpfile=expdp_itpux010203.dmp expdp_itpux010203.dmp schemas=itpux01,itpux02,itpux03\n\n</code></pre>\n<h3 id=\"3-3-安装步骤2（配置环境）\"><a href=\"#3-3-安装步骤2（配置环境）\" class=\"headerlink\" title=\"3.3 安装步骤2（配置环境）\"></a>3.3 安装步骤2（配置环境）</h3><ul>\n<li>1.源端打开归档，目标端一般不需要</li>\n<li>2.源端数据库打开补充日志</li>\n<li>3.源端是数据库开启FORCE_LOGGING</li>\n<li>4.关闭回收站功能</li>\n<li>5.源和目标的网络通信正常</li>\n<li>6.创建专用的GoldenGate用户来同步数据</li>\n<li>7.修改数据库参数（源和目标端）</li>\n</ul>\n<h4 id=\"3-3-1-源端打开归档，目标端一般不需要\"><a href=\"#3-3-1-源端打开归档，目标端一般不需要\" class=\"headerlink\" title=\"3.3.1 源端打开归档，目标端一般不需要\"></a>3.3.1 源端打开归档，目标端一般不需要</h4><blockquote>\n<p>&emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.</p>\n</blockquote>\n<ul>\n<li>开启归档 </li>\n</ul>\n<pre><code class=\"sql\">-- 1.确定当前没有开启归档\nSQL&gt; archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n\n--2.创建归档目录\n\n--3.重启数据库到MOUNT\nSHUTDOWN IMMEDIATE\nSTARTUP MOUNT\n--4.修改归档路径并开启归档\nALTER SYSTEM SET  db_recovery_file_dest=&#39;/u01/backup&#39; scope=spfile;\nALTER DATABASE ARCHIVELOG;\n--5.重启数据库\nSHUTDOWN IMMEDIATE\nSTARTUP\n</code></pre>\n<ul>\n<li>关闭归档</li>\n</ul>\n<pre><code class=\"sql\">--1.确定当前为归档\nSQL&gt; archive log list;\nDatabase log mode              Archive Mode\nAutomatic archival             Enabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nNext log sequence to archive   21\nCurrent log sequence           21\n\n--2.重启数据库到MOUNT\nSQL&gt; shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL&gt; startup mount;\nORACLE instance started.\n\nTotal System Global Area 2137886720 bytes\nFixed Size                  2254952 bytes\nVariable Size             570427288 bytes\nDatabase Buffers         1560281088 bytes\nRedo Buffers                4923392 bytes\nDatabase mounted.\n\n--3.关闭归档并打开数据库\nSQL&gt;  alter database noarchivelog;\n\nDatabase altered.\nSQL&gt; alter database open;\n\nDatabase altered.\n\nSQL&gt; archive log list;\nDatabase log mode              No Archive Mode\nAutomatic archival             Disabled\nArchive destination            USE_DB_RECOVERY_FILE_DEST\nOldest online log sequence     19\nCurrent log sequence           21\n</code></pre>\n<h4 id=\"3-3-2-源端数据库打开补充日志\"><a href=\"#3-3-2-源端数据库打开补充日志\" class=\"headerlink\" title=\"3.3.2 源端数据库打开补充日志\"></a>3.3.2 源端数据库打开补充日志</h4><pre><code class=\"sql\">--1.查看是否打开最小日志记录\nSELECT SUPPLEMENTAL_LOG_DATA_MIN FROM v$database;\n\n--2.开启最小日志记录\nALTER DATABASE ADD SUPPLEMENTAL LOG DATA;\n\n--3.切换归档\nALTER SYSTEM SWITCH LOGFILE;\n\n</code></pre>\n<h4 id=\"3-3-3-源端是数据库开启FORCE-LOGGING\"><a href=\"#3-3-3-源端是数据库开启FORCE-LOGGING\" class=\"headerlink\" title=\"3.3.3 源端是数据库开启FORCE_LOGGING\"></a>3.3.3 源端是数据库开启FORCE_LOGGING</h4><pre><code class=\"sql\">--1.查询是否开启强制日志模式\nforce_logging from v$database;\n\n--2.打开\nalter database force logging;\nalter system switch logfile;\n</code></pre>\n<h4 id=\"3-3-4-关闭回收站功能\"><a href=\"#3-3-4-关闭回收站功能\" class=\"headerlink\" title=\"3.3.4 关闭回收站功能\"></a>3.3.4 关闭回收站功能</h4><blockquote>\n<p>&emsp;&emsp;官方没有要求关闭回收站，但是我们一般都会关闭。关闭回收站必须重启生效。<br><code>`</code>sql<br>–1.查看回收是否关闭<br>show parameter recyclebin</p>\n</blockquote>\n<p>–2.关闭回收站<br>alter system set recyclebin=off scope=spfile;</p>\n<p>–3.重启数据库</p>\n<pre><code>#### 3.3.5 源和目标的网络通信正常\n```sql\n\n</code></pre><h4 id=\"3-3-6-创建专用的GoldenGate用户来同步数据\"><a href=\"#3-3-6-创建专用的GoldenGate用户来同步数据\" class=\"headerlink\" title=\"3.3.6 创建专用的GoldenGate用户来同步数据\"></a>3.3.6 创建专用的GoldenGate用户来同步数据</h4><h4 id=\"3-3-7-修改数据库参数（源和目标端）\"><a href=\"#3-3-7-修改数据库参数（源和目标端）\" class=\"headerlink\" title=\"3.3.7 修改数据库参数（源和目标端）\"></a>3.3.7 修改数据库参数（源和目标端）</h4><pre><code class=\"sql\">alter system set enable_goldengate_replication=true scope=both;\nshow paramteter enable_goldengate_replication;\n</code></pre>\n<h3 id=\"3-4-安装步骤（配置OGG）\"><a href=\"#3-4-安装步骤（配置OGG）\" class=\"headerlink\" title=\"3.4 安装步骤（配置OGG）\"></a>3.4 安装步骤（配置OGG）</h3><pre><code class=\"sql\">1.创建文件目录\ncreate subdirs\n\n01.配置配置管理进程mgr\nggsci&gt; edit params mgr\nport 7809\nautostart er *\nautorestart er *,waitminutes 3,retries 15\npurgeoldextracts ./dirdat/*,usecheckpoints,minkeepdays 7*/\n\n02\nalter system set enable_goldengate_replication=true scope=both;\n\n\n</code></pre>\n<h2 id=\"4-案列二（ASM到文件系统）\"><a href=\"#4-案列二（ASM到文件系统）\" class=\"headerlink\" title=\"4.案列二（ASM到文件系统）\"></a>4.案列二（ASM到文件系统）</h2><h2 id=\"5-案列三（RAC-ASM-到-单机ASN）\"><a href=\"#5-案列三（RAC-ASM-到-单机ASN）\" class=\"headerlink\" title=\"5.案列三（RAC ASM 到 单机ASN）\"></a>5.案列三（RAC ASM 到 单机ASN）</h2><h3 id=\"3-1-系统架构-1\"><a href=\"#3-1-系统架构-1\" class=\"headerlink\" title=\"3.1 系统架构\"></a>3.1 系统架构</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">主库</th>\n<th>备库</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">系统架构</td>\n<td style=\"text-align:center\">RAC</td>\n<td>单实例ASM</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">数据库版本</td>\n<td style=\"text-align:center\">11.2.0.4</td>\n<td>11.2.0.4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">内存</td>\n<td style=\"text-align:center\">4G</td>\n<td>4G</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">CPU</td>\n<td style=\"text-align:center\">4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">GoldenGate</td>\n<td style=\"text-align:center\">12.1.0.3</td>\n<td>12.1.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-2-安装步骤（准备）\"><a href=\"#3-2-安装步骤（准备）\" class=\"headerlink\" title=\"3.2  安装步骤（准备）\"></a>3.2  安装步骤（准备）</h3><ul>\n<li>1.安装相关的软件包</li>\n<li>2.准备OGG安装的环境变量</li>\n<li>3.上传并安装OGG软件</li>\n<li>4.准备测试数据</li>\n</ul>\n<h4 id=\"3-2-1-安装相关的软件包-1\"><a href=\"#3-2-1-安装相关的软件包-1\" class=\"headerlink\" title=\"3.2.1 安装相关的软件包\"></a>3.2.1 安装相关的软件包</h4><h4 id=\"3-2-1-准备OGG安装的环境变量-1\"><a href=\"#3-2-1-准备OGG安装的环境变量-1\" class=\"headerlink\" title=\"3.2.1 准备OGG安装的环境变量\"></a>3.2.1 准备OGG安装的环境变量</h4><h4 id=\"3-2-1-上传并安装OGG软件-1\"><a href=\"#3-2-1-上传并安装OGG软件-1\" class=\"headerlink\" title=\"3.2.1 上传并安装OGG软件\"></a>3.2.1 上传并安装OGG软件</h4><h4 id=\"3-2-1-准备测试数据-1\"><a href=\"#3-2-1-准备测试数据-1\" class=\"headerlink\" title=\"3.2.1 准备测试数据\"></a>3.2.1 准备测试数据</h4><h3 id=\"3-3-安装步骤（配置环境）\"><a href=\"#3-3-安装步骤（配置环境）\" class=\"headerlink\" title=\"3.3 安装步骤（配置环境）\"></a>3.3 安装步骤（配置环境）</h3><ul>\n<li>1.源端打开归档，目标端一般不需要</li>\n<li>2.源端数据库打开补充日志</li>\n<li>3.源端是数据库开启FORCE_LOGGING</li>\n<li>4.关闭回收站功能</li>\n<li>5.源和目标的网络通信正常</li>\n<li>6.创建专用的GoldenGate用户来同步数据</li>\n</ul>\n<h4 id=\"3-3-1-源端打开归档，目标端一般不需要-1\"><a href=\"#3-3-1-源端打开归档，目标端一般不需要-1\" class=\"headerlink\" title=\"3.3.1 源端打开归档，目标端一般不需要\"></a>3.3.1 源端打开归档，目标端一般不需要</h4><blockquote>\n<p>&emsp;&emsp; 因为有OGG所以只要源端开启归档，目标端不用开启归档,下面将介绍文件系统单实例怎么开启关闭归档.</p>\n</blockquote>\n<h4 id=\"3-3-2-源端数据库打开补充日志-1\"><a href=\"#3-3-2-源端数据库打开补充日志-1\" class=\"headerlink\" title=\"3.3.2 源端数据库打开补充日志\"></a>3.3.2 源端数据库打开补充日志</h4><h4 id=\"3-3-3-源端是数据库开启FORCE-LOGGING-1\"><a href=\"#3-3-3-源端是数据库开启FORCE-LOGGING-1\" class=\"headerlink\" title=\"3.3.3 源端是数据库开启FORCE_LOGGING\"></a>3.3.3 源端是数据库开启FORCE_LOGGING</h4><h4 id=\"3-3-4-关闭回收站功能-1\"><a href=\"#3-3-4-关闭回收站功能-1\" class=\"headerlink\" title=\"3.3.4 关闭回收站功能\"></a>3.3.4 关闭回收站功能</h4><h4 id=\"3-3-5-源和目标的网络通信正常\"><a href=\"#3-3-5-源和目标的网络通信正常\" class=\"headerlink\" title=\"3.3.5 源和目标的网络通信正常\"></a>3.3.5 源和目标的网络通信正常</h4><h4 id=\"3-3-6-创建专用的GoldenGate用户来同步数据-1\"><a href=\"#3-3-6-创建专用的GoldenGate用户来同步数据-1\" class=\"headerlink\" title=\"3.3.6 创建专用的GoldenGate用户来同步数据\"></a>3.3.6 创建专用的GoldenGate用户来同步数据</h4>"},{"title":"Oracle SQL之常用函数","date":"2018-10-04T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# OracleSQL语言之常用函数\n\n## 注意\n\n[Oracle 11G R2 官方文档][1] \n\n## 1. 聚合函数-数据统计\n```sql\n--01.max 取列和表达式的最大值\n\nSELECT MAX (salary) FROM employees;\nSELECT MAX (DISTINCT salary) FROM employees;\n\n--02.min 取列和表达式的最小值\n\nSELECT MIN (salary) FROM employees;\nSELECT MIN (DISTINCT salary) FROM employees;\n\n--03.avg 取列和表达式的平均值\n\nSELECT AVG (salary) FROM employees;\nSELECT AVG (DISTINCT salary) FROM employees;\nSELECT * FROM employees;\n\n--04.sum 求列和表达式的总和\n\nSELECT SUM (salary) FROM employees;\nSELECT SUM (salary + 1000) FROM employees;\nSELECT SUM ((salary + 1000) - salary) FROM employees;\n\nSELECT department_id, SUM (salary)\n    FROM employees\nGROUP BY department_id\nORDER BY 2 DESC;\n\n--05.count 求行数总和\n\nSELECT COUNT (*) FROM employees;\n\nSELECT COUNT (*)\n  FROM employees\n WHERE manager_id = 120;\n\nSELECT COUNT (email) FROM employees;\n\nSELECT COUNT (DISTINCT manager_id) FROM employees;\n\n--06.other\n--stddev 标准差,variance 协方差，median 求中位数\n\nSELECT STDDEV (salary) FROM employees;\nSELECT VARIANCE (salary) FROM employees;\nSELECT MEDIAN (salary) FROM employees;\n```\n\n## 2. 分组函数-使用group by 与having\n```sql\n-01.简单的分组函数应用\n--统计各个国家名字的长度\n--length,avg,round\n\n  SELECT country_name, LENGTH (country_name)\n    FROM countries\nGROUP BY country_name;\n\nSELECT ROUND (AVG (LENGTH (country_name))) FROM countries;\n\n--工资\n\n  SELECT manager_id, MIN (salary) min_sal, MAX (salary) max_sal\n    FROM employees\nGROUP BY manager_id;\n\n--02.多列分组数据\n--统计简历表中每年辞职的员工数\n--to_char,count\n\nSELECT * FROM jl;\n\n  SELECT TO_CHAR (end_date, 'yyyy') year, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, 'yyyy')\nORDER BY 1;\n\n  SELECT TO_CHAR (end_date, 'yyyy') year, job_id, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, 'yyyy'), job_id\nORDER BY 1;\n\n--03.使用having 子句\n--限制：1.对行进行分组，2.应用组函数，3.显示符合having 子句条件的组\n--查招聘多于等于15 个员工在星期几。\n\nSELECT * FROM employees;\n\n--to_char,count\n\n  SELECT TO_CHAR (hire_date, 'Day') 星期几, COUNT (*)\n    FROM employees\nGROUP BY TO_CHAR (hire_date, 'Day')\n  HAVING COUNT (*) >= 15;\n\n--统计部门里最大工资大于10000 的\n--max\n\nSELECT department_id, MAX (salary)\n    FROM employees\nGROUP BY department_id\n  HAVING MAX (salary) > 10000\nORDER BY 2;\n\n```\n## 3. 字符函数-运算与截取\n```sql\n--01.round（n,[m]） 四舍五入\n--m=0 整数，m<0 小数点的前m 位,m>0 小数点的后m 位\n--四舍\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, ROUND (salary + 0.2) FROM employees;\nSELECT salary, ROUND ((salary + 0.2), 0) FROM employees;\n\n--五入\n\nSELECT salary, salary + 0.8 FROM employees;\nSELECT salary, ROUND (salary + 0.8) FROM employees;\n\n--小数位\n\nSELECT salary, salary + 0.842 FROM employees;\nSELECT salary, ROUND (salary + 0.842) FROM employees;\nSELECT salary, ROUND ((salary + 0.842), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -3) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -4) FROM employees;\n\n--02.trunc(n,[m]) 截取数字.\n--m=0 去掉小数位，m<0 小数点的前m 位,m>0 小数点的后m 位\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, TRUNC (salary + 0.2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.2), 0) FROM employees;\nSELECT salary, TRUNC (salary + 0.842) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), 2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -3) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -4) FROM employees;\n\n--03.ceil(n) 返回>=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, CEIL (salary + 0.8567) FROM employees;\nSELECT salary, CEIL (salary + 0.2567) FROM employees;\n\n--04.floor(n) 返回<=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, FLOOR (salary + 0.8567) FROM employees;\nSELECT salary, FLOOR (salary + 0.2567) FROM employees;\n\n--05.length(n) 返回字符串的长度\n\nSELECT country_name, LENGTH (country_name) FROM countries;\n```\n## 4. 转换函数-大小写转换\n```sql\n--01.lower 转换为小写\nSELECT * FROM employees;\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name LIKE '%li%';\n\n--Li,lI,LI,li\n\nSELECT first_name, last_name\n  FROM employees\n WHERE LOWER (first_name) LIKE '%li%';\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name = LOWER ('ITPUX01');\n\nSELECT LOWER (first_name), last_name FROM employees;\n\n--02.upper 转换为大写\n\nSELECT UPPER (first_name), last_name FROM employees;\n\n--03.initcap 将第一个字母大写，其余的小写。\n\nSELECT first_name, last_name FROM employees;\n\nSELECT INITCAP (first_name), last_name FROM employees;\n\n--04.综合运用\n\nSELECT UPPER (first_name), LOWER (last_name), INITCAP (job_id) FROM employees;\n```\n## 5. 转换函数-日期字符数字转换\n```sql\n--01.to_date 字符串>日期类型\n--Year: yy 16,yyy 016, yyyy 2016\n--Month: mm 11,mon 11 月/nov,month 11 月/november\n--Day: dd 当月第几天02, ddd 当年第几天02, dy 当周第几天星期五/fri,day 当周第几天星期五/friday\n--Hour: hh 12 小时进制01，hh24 24 小时进制13\n--24 小时的时间范围： 0:00:00 - 23:59:59,12 小时时间范围:1:00:00-12:59:59\n--Minute: mi 60 进制45\n--Second: ss 60 进制25\n--其它: Q 季度4， WW 当年第几周44，W 当月第几周1\n\nSELECT TO_DATE ('2016-12-18 19:02:02', 'YYYY-MM-DD HH24:MI:SS') FROM DUAL;\nSELECT TO_DATE ('2016-12-18 19:02', 'YYYY-MM-DD HH24:MI') FROM DUAL;\nSELECT TO_DATE ('2016-12-18 19', 'YYYY-MM-DD HH24') FROM DUAL;\nSELECT TO_DATE ('2016-12-18', 'YYYY-MM-DD') FROM DUAL;\nSELECT TO_DATE ('2016-12', 'YYYY-MM') FROM DUAL;\nSELECT TO_DATE ('2016', 'YYYY') FROM DUAL;\nSELECT TO_DATE ('20161218', 'YYYY-MM-DD') FROM DUAL;\n\n--02.to_char 日期/数字>字符串\n\nSELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd hh24:mi:ss') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyy') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'dd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'hh24') FROM DUAL;\nSELECT TO_CHAR ('23432.4') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyymmdd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'mmdd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyymm') FROM DUAL;\n\n--03.to_number 字符>数字\n\nSELECT SYSDATE - (TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) / 365 FROM DUAL;\nSELECT TRUNC (TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) / 365) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 * 60 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 * 60 * 60 FROM DUAL;\n\n```\n## 6. 日期函数-使用日期函数使用\n```sql\n--01.sysdate\n\nSELECT SYSDATE FROM DUAL;\n\n--02.add_months 增加/减去月份\n\nSELECT ADD_MONTHS (SYSDATE, -1) FROM DUAL;\n\nSELECT ADD_MONTHS (SYSDATE, +1) FROM DUAL;\n\n--03.last_day 返回日期的最后一天\n\nSELECT LAST_DAY (SYSDATE) FROM DUAL;\nSELECT LAST_DAY (ADD_MONTHS (SYSDATE, -1)) FROM DUAL;\n\n--04.months_between 时间2-时间1 的月份\n\nSELECT MONTHS_BETWEEN (TO_DATE ('2016/11/30', 'YYYY-MM-DD'),\n                       TO_DATE ('2016/05/30', 'YYYY-MM-DD'))\n    FROM DUAL;\n\n--05.next_day\n--星期日=1，一=2 二=3，三=4，四=5，五=6，六=7\n\nSELECT NEXT_DAY (SYSDATE, 5) FROM DUAL;\nSELECT NEXT_DAY (SYSDATE, 1) FROM DUAL;\n\n--06.current_date 当前日期\n\nSELECT CURRENT_DATE FROM DUAL;\n\n--07.current_timestamp 当前日期\n\nSELECT CURRENT_TIMESTAMP FROM DUAL;\n\n--08.sessiontimezone 时区\n\nSELECT SESSIONTIMEZONE FROM DUAL;\n\n--09.trunc( for date)\n\nSELECT TRUNC (SYSDATE, 'YYYY') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'MM') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'D') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'DD') FROM DUAL;\n```\n\n* 字符串与日期转换\n\n```sql\nselect to_char(sysdate,'yyyy-MM-dd HH24:mi:ss') from dual;\nselect to_date('2018-02-12 16:35:36','yyyy-MM-dd HH24:mi:ss') from dual;\n```\n## 7. 集合函数-合并两张表的数据\n```sql\n--01.union (无重并集，去重排序)\nSELECT * FROM employees;\nSELECT * FROM scott.salgrade;\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01;\nSELECT * FROM sql06;\nCREATE TABLE sql06\nAS\n    SELECT * FROM sql01;\n    \nDELETE FROM sql06\n      WHERE sql01_id = 3;\n\nCOMMIT;\n\nSELECT * FROM sql01\nUNION\nSELECT * FROM sql06;\n\n--02.union all（有重并集，不去重排序）\n\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION ALL\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01\nUNION ALL\nSELECT * FROM sql06;\n\n--03.intersect （交集,显示相同的）\n\nSELECT * FROM sql01\nINTERSECT\nSELECT * FROM sql06;\n\n--04.minus （差集，显示不同的）\n\nSELECT * FROM sql01\nMINUS\nSELECT * FROM sql06;\n```\n## 8. 分析函数-使用DECODE 函数\n```sql\n--decode (条件,值1，返回值1，值2，返回值2,...，缺省值）\nSELECT * FROM employees;\n\n  SELECT DECODE (job_id,  'AD_PRES', 'CEO',  'HR_PEP', 'HR',  'SA') JOB,\n         COUNT (*)                                                JOB_COUNT\n    FROM employees\nGROUP BY DECODE (job_id,  'AD_PRES', 'CEO',  'HR_PEP', 'HR',  'SA');\n\n--判断输出\n\nSELECT *\n  FROM employees\n WHERE salary IN (3100, 2800);\n\nSELECT DECODE (salary, 3100, 'yes', 'no'), DECODE (salary, 2800, 'yes', 'no')\n  FROM employees\n WHERE salary IN (3100, 2800);\n```\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle SQL之常用函数.md","raw":"---\ntitle: Oracle SQL之常用函数\ndate: 2018-10-04 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - SQL\n---\n\n\n# OracleSQL语言之常用函数\n\n## 注意\n\n[Oracle 11G R2 官方文档][1] \n\n## 1. 聚合函数-数据统计\n```sql\n--01.max 取列和表达式的最大值\n\nSELECT MAX (salary) FROM employees;\nSELECT MAX (DISTINCT salary) FROM employees;\n\n--02.min 取列和表达式的最小值\n\nSELECT MIN (salary) FROM employees;\nSELECT MIN (DISTINCT salary) FROM employees;\n\n--03.avg 取列和表达式的平均值\n\nSELECT AVG (salary) FROM employees;\nSELECT AVG (DISTINCT salary) FROM employees;\nSELECT * FROM employees;\n\n--04.sum 求列和表达式的总和\n\nSELECT SUM (salary) FROM employees;\nSELECT SUM (salary + 1000) FROM employees;\nSELECT SUM ((salary + 1000) - salary) FROM employees;\n\nSELECT department_id, SUM (salary)\n    FROM employees\nGROUP BY department_id\nORDER BY 2 DESC;\n\n--05.count 求行数总和\n\nSELECT COUNT (*) FROM employees;\n\nSELECT COUNT (*)\n  FROM employees\n WHERE manager_id = 120;\n\nSELECT COUNT (email) FROM employees;\n\nSELECT COUNT (DISTINCT manager_id) FROM employees;\n\n--06.other\n--stddev 标准差,variance 协方差，median 求中位数\n\nSELECT STDDEV (salary) FROM employees;\nSELECT VARIANCE (salary) FROM employees;\nSELECT MEDIAN (salary) FROM employees;\n```\n\n## 2. 分组函数-使用group by 与having\n```sql\n-01.简单的分组函数应用\n--统计各个国家名字的长度\n--length,avg,round\n\n  SELECT country_name, LENGTH (country_name)\n    FROM countries\nGROUP BY country_name;\n\nSELECT ROUND (AVG (LENGTH (country_name))) FROM countries;\n\n--工资\n\n  SELECT manager_id, MIN (salary) min_sal, MAX (salary) max_sal\n    FROM employees\nGROUP BY manager_id;\n\n--02.多列分组数据\n--统计简历表中每年辞职的员工数\n--to_char,count\n\nSELECT * FROM jl;\n\n  SELECT TO_CHAR (end_date, 'yyyy') year, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, 'yyyy')\nORDER BY 1;\n\n  SELECT TO_CHAR (end_date, 'yyyy') year, job_id, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, 'yyyy'), job_id\nORDER BY 1;\n\n--03.使用having 子句\n--限制：1.对行进行分组，2.应用组函数，3.显示符合having 子句条件的组\n--查招聘多于等于15 个员工在星期几。\n\nSELECT * FROM employees;\n\n--to_char,count\n\n  SELECT TO_CHAR (hire_date, 'Day') 星期几, COUNT (*)\n    FROM employees\nGROUP BY TO_CHAR (hire_date, 'Day')\n  HAVING COUNT (*) >= 15;\n\n--统计部门里最大工资大于10000 的\n--max\n\nSELECT department_id, MAX (salary)\n    FROM employees\nGROUP BY department_id\n  HAVING MAX (salary) > 10000\nORDER BY 2;\n\n```\n## 3. 字符函数-运算与截取\n```sql\n--01.round（n,[m]） 四舍五入\n--m=0 整数，m<0 小数点的前m 位,m>0 小数点的后m 位\n--四舍\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, ROUND (salary + 0.2) FROM employees;\nSELECT salary, ROUND ((salary + 0.2), 0) FROM employees;\n\n--五入\n\nSELECT salary, salary + 0.8 FROM employees;\nSELECT salary, ROUND (salary + 0.8) FROM employees;\n\n--小数位\n\nSELECT salary, salary + 0.842 FROM employees;\nSELECT salary, ROUND (salary + 0.842) FROM employees;\nSELECT salary, ROUND ((salary + 0.842), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -3) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -4) FROM employees;\n\n--02.trunc(n,[m]) 截取数字.\n--m=0 去掉小数位，m<0 小数点的前m 位,m>0 小数点的后m 位\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, TRUNC (salary + 0.2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.2), 0) FROM employees;\nSELECT salary, TRUNC (salary + 0.842) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), 2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -3) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -4) FROM employees;\n\n--03.ceil(n) 返回>=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, CEIL (salary + 0.8567) FROM employees;\nSELECT salary, CEIL (salary + 0.2567) FROM employees;\n\n--04.floor(n) 返回<=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, FLOOR (salary + 0.8567) FROM employees;\nSELECT salary, FLOOR (salary + 0.2567) FROM employees;\n\n--05.length(n) 返回字符串的长度\n\nSELECT country_name, LENGTH (country_name) FROM countries;\n```\n## 4. 转换函数-大小写转换\n```sql\n--01.lower 转换为小写\nSELECT * FROM employees;\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name LIKE '%li%';\n\n--Li,lI,LI,li\n\nSELECT first_name, last_name\n  FROM employees\n WHERE LOWER (first_name) LIKE '%li%';\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name = LOWER ('ITPUX01');\n\nSELECT LOWER (first_name), last_name FROM employees;\n\n--02.upper 转换为大写\n\nSELECT UPPER (first_name), last_name FROM employees;\n\n--03.initcap 将第一个字母大写，其余的小写。\n\nSELECT first_name, last_name FROM employees;\n\nSELECT INITCAP (first_name), last_name FROM employees;\n\n--04.综合运用\n\nSELECT UPPER (first_name), LOWER (last_name), INITCAP (job_id) FROM employees;\n```\n## 5. 转换函数-日期字符数字转换\n```sql\n--01.to_date 字符串>日期类型\n--Year: yy 16,yyy 016, yyyy 2016\n--Month: mm 11,mon 11 月/nov,month 11 月/november\n--Day: dd 当月第几天02, ddd 当年第几天02, dy 当周第几天星期五/fri,day 当周第几天星期五/friday\n--Hour: hh 12 小时进制01，hh24 24 小时进制13\n--24 小时的时间范围： 0:00:00 - 23:59:59,12 小时时间范围:1:00:00-12:59:59\n--Minute: mi 60 进制45\n--Second: ss 60 进制25\n--其它: Q 季度4， WW 当年第几周44，W 当月第几周1\n\nSELECT TO_DATE ('2016-12-18 19:02:02', 'YYYY-MM-DD HH24:MI:SS') FROM DUAL;\nSELECT TO_DATE ('2016-12-18 19:02', 'YYYY-MM-DD HH24:MI') FROM DUAL;\nSELECT TO_DATE ('2016-12-18 19', 'YYYY-MM-DD HH24') FROM DUAL;\nSELECT TO_DATE ('2016-12-18', 'YYYY-MM-DD') FROM DUAL;\nSELECT TO_DATE ('2016-12', 'YYYY-MM') FROM DUAL;\nSELECT TO_DATE ('2016', 'YYYY') FROM DUAL;\nSELECT TO_DATE ('20161218', 'YYYY-MM-DD') FROM DUAL;\n\n--02.to_char 日期/数字>字符串\n\nSELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd hh24:mi:ss') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyy') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'dd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'hh24') FROM DUAL;\nSELECT TO_CHAR ('23432.4') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyymmdd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'mmdd') FROM DUAL;\nSELECT TO_CHAR (SYSDATE, 'yyyymm') FROM DUAL;\n\n--03.to_number 字符>数字\n\nSELECT SYSDATE - (TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) / 365 FROM DUAL;\nSELECT TRUNC (TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) / 365) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 * 60 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE ('2006-11-02 15:55:55', 'yyyy-mm-dd hh24:mi:ss')) * 24 * 60 * 60 FROM DUAL;\n\n```\n## 6. 日期函数-使用日期函数使用\n```sql\n--01.sysdate\n\nSELECT SYSDATE FROM DUAL;\n\n--02.add_months 增加/减去月份\n\nSELECT ADD_MONTHS (SYSDATE, -1) FROM DUAL;\n\nSELECT ADD_MONTHS (SYSDATE, +1) FROM DUAL;\n\n--03.last_day 返回日期的最后一天\n\nSELECT LAST_DAY (SYSDATE) FROM DUAL;\nSELECT LAST_DAY (ADD_MONTHS (SYSDATE, -1)) FROM DUAL;\n\n--04.months_between 时间2-时间1 的月份\n\nSELECT MONTHS_BETWEEN (TO_DATE ('2016/11/30', 'YYYY-MM-DD'),\n                       TO_DATE ('2016/05/30', 'YYYY-MM-DD'))\n    FROM DUAL;\n\n--05.next_day\n--星期日=1，一=2 二=3，三=4，四=5，五=6，六=7\n\nSELECT NEXT_DAY (SYSDATE, 5) FROM DUAL;\nSELECT NEXT_DAY (SYSDATE, 1) FROM DUAL;\n\n--06.current_date 当前日期\n\nSELECT CURRENT_DATE FROM DUAL;\n\n--07.current_timestamp 当前日期\n\nSELECT CURRENT_TIMESTAMP FROM DUAL;\n\n--08.sessiontimezone 时区\n\nSELECT SESSIONTIMEZONE FROM DUAL;\n\n--09.trunc( for date)\n\nSELECT TRUNC (SYSDATE, 'YYYY') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'MM') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'D') FROM DUAL;\nSELECT TRUNC (SYSDATE, 'DD') FROM DUAL;\n```\n\n* 字符串与日期转换\n\n```sql\nselect to_char(sysdate,'yyyy-MM-dd HH24:mi:ss') from dual;\nselect to_date('2018-02-12 16:35:36','yyyy-MM-dd HH24:mi:ss') from dual;\n```\n## 7. 集合函数-合并两张表的数据\n```sql\n--01.union (无重并集，去重排序)\nSELECT * FROM employees;\nSELECT * FROM scott.salgrade;\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01;\nSELECT * FROM sql06;\nCREATE TABLE sql06\nAS\n    SELECT * FROM sql01;\n    \nDELETE FROM sql06\n      WHERE sql01_id = 3;\n\nCOMMIT;\n\nSELECT * FROM sql01\nUNION\nSELECT * FROM sql06;\n\n--02.union all（有重并集，不去重排序）\n\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION ALL\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01\nUNION ALL\nSELECT * FROM sql06;\n\n--03.intersect （交集,显示相同的）\n\nSELECT * FROM sql01\nINTERSECT\nSELECT * FROM sql06;\n\n--04.minus （差集，显示不同的）\n\nSELECT * FROM sql01\nMINUS\nSELECT * FROM sql06;\n```\n## 8. 分析函数-使用DECODE 函数\n```sql\n--decode (条件,值1，返回值1，值2，返回值2,...，缺省值）\nSELECT * FROM employees;\n\n  SELECT DECODE (job_id,  'AD_PRES', 'CEO',  'HR_PEP', 'HR',  'SA') JOB,\n         COUNT (*)                                                JOB_COUNT\n    FROM employees\nGROUP BY DECODE (job_id,  'AD_PRES', 'CEO',  'HR_PEP', 'HR',  'SA');\n\n--判断输出\n\nSELECT *\n  FROM employees\n WHERE salary IN (3100, 2800);\n\nSELECT DECODE (salary, 3100, 'yes', 'no'), DECODE (salary, 2800, 'yes', 'no')\n  FROM employees\n WHERE salary IN (3100, 2800);\n```\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle SQL之常用函数","published":1,"updated":"2019-05-03T15:43:29.368Z","_id":"cjv88xbb1001ki0cdl4yxl2eh","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"OracleSQL语言之常用函数\"><a href=\"#OracleSQL语言之常用函数\" class=\"headerlink\" title=\"OracleSQL语言之常用函数\"></a>OracleSQL语言之常用函数</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-聚合函数-数据统计\"><a href=\"#1-聚合函数-数据统计\" class=\"headerlink\" title=\"1. 聚合函数-数据统计\"></a>1. 聚合函数-数据统计</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.max 取列和表达式的最大值</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">MAX</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">MAX</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.min 取列和表达式的最小值</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">MIN</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">MIN</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.avg 取列和表达式的平均值</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">AVG</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">AVG</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--04.sum 求列和表达式的总和</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> department_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> department_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">2</span> <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--05.count 求行数总和</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> manager_id <span class=\"token operator\">=</span> <span class=\"token number\">120</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> manager_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--06.other</span>\n<span class=\"token comment\" spellcheck=\"true\">--stddev 标准差,variance 协方差，median 求中位数</span>\n\n<span class=\"token keyword\">SELECT</span> STDDEV <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> VARIANCE <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> MEDIAN <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"2-分组函数-使用group-by-与having\"><a href=\"#2-分组函数-使用group-by-与having\" class=\"headerlink\" title=\"2. 分组函数-使用group by 与having\"></a>2. 分组函数-使用group by 与having</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token punctuation\">.</span>简单的分组函数应用\n<span class=\"token comment\" spellcheck=\"true\">--统计各个国家名字的长度</span>\n<span class=\"token comment\" spellcheck=\"true\">--length,avg,round</span>\n\n  <span class=\"token keyword\">SELECT</span> country_name<span class=\"token punctuation\">,</span> LENGTH <span class=\"token punctuation\">(</span>country_name<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> countries\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> country_name<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token function\">AVG</span> <span class=\"token punctuation\">(</span>LENGTH <span class=\"token punctuation\">(</span>country_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> countries<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--工资</span>\n\n  <span class=\"token keyword\">SELECT</span> manager_id<span class=\"token punctuation\">,</span> <span class=\"token function\">MIN</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> min_sal<span class=\"token punctuation\">,</span> <span class=\"token function\">MAX</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> max_sal\n    <span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> manager_id<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.多列分组数据</span>\n<span class=\"token comment\" spellcheck=\"true\">--统计简历表中每年辞职的员工数</span>\n<span class=\"token comment\" spellcheck=\"true\">--to_char,count</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> jl<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>end_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy'</span><span class=\"token punctuation\">)</span> year<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> job_history\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> TO_CHAR <span class=\"token punctuation\">(</span>end_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>end_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy'</span><span class=\"token punctuation\">)</span> year<span class=\"token punctuation\">,</span> job_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> job_history\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> TO_CHAR <span class=\"token punctuation\">(</span>end_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> job_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.使用having 子句</span>\n<span class=\"token comment\" spellcheck=\"true\">--限制：1.对行进行分组，2.应用组函数，3.显示符合having 子句条件的组</span>\n<span class=\"token comment\" spellcheck=\"true\">--查招聘多于等于15 个员工在星期几。</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--to_char,count</span>\n\n  <span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>hire_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'Day'</span><span class=\"token punctuation\">)</span> 星期几<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> TO_CHAR <span class=\"token punctuation\">(</span>hire_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'Day'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">HAVING</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">15</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--统计部门里最大工资大于10000 的</span>\n<span class=\"token comment\" spellcheck=\"true\">--max</span>\n\n<span class=\"token keyword\">SELECT</span> department_id<span class=\"token punctuation\">,</span> <span class=\"token function\">MAX</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> department_id\n  <span class=\"token keyword\">HAVING</span> <span class=\"token function\">MAX</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">10000</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"3-字符函数-运算与截取\"><a href=\"#3-字符函数-运算与截取\" class=\"headerlink\" title=\"3. 字符函数-运算与截取\"></a>3. 字符函数-运算与截取</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.round（n,[m]） 四舍五入</span>\n<span class=\"token comment\" spellcheck=\"true\">--m=0 整数，m&lt;0 小数点的前m 位,m>0 小数点的后m 位</span>\n<span class=\"token comment\" spellcheck=\"true\">--四舍</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--五入</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--小数位</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.842</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.842</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.842</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> <span class=\"token function\">ROUND</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.trunc(n,[m]) 截取数字.</span>\n<span class=\"token comment\" spellcheck=\"true\">--m=0 去掉小数位，m&lt;0 小数点的前m 位,m>0 小数点的后m 位</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.842</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> TRUNC <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.867</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.ceil(n) 返回>=数字n 的最小整数</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8567</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> CEIL <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8567</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> CEIL <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2567</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--04.floor(n) 返回&lt;=数字n 的最小整数</span>\n\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8567</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> FLOOR <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.8567</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> salary<span class=\"token punctuation\">,</span> FLOOR <span class=\"token punctuation\">(</span>salary <span class=\"token operator\">+</span> <span class=\"token number\">0.2567</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--05.length(n) 返回字符串的长度</span>\n\n<span class=\"token keyword\">SELECT</span> country_name<span class=\"token punctuation\">,</span> LENGTH <span class=\"token punctuation\">(</span>country_name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> countries<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"4-转换函数-大小写转换\"><a href=\"#4-转换函数-大小写转换\" class=\"headerlink\" title=\"4. 转换函数-大小写转换\"></a>4. 转换函数-大小写转换</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.lower 转换为小写</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> first_name<span class=\"token punctuation\">,</span> last_name\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> first_name <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%li%'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--Li,lI,LI,li</span>\n\n<span class=\"token keyword\">SELECT</span> first_name<span class=\"token punctuation\">,</span> last_name\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> LOWER <span class=\"token punctuation\">(</span>first_name<span class=\"token punctuation\">)</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%li%'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> first_name<span class=\"token punctuation\">,</span> last_name\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> first_name <span class=\"token operator\">=</span> LOWER <span class=\"token punctuation\">(</span><span class=\"token string\">'ITPUX01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> LOWER <span class=\"token punctuation\">(</span>first_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> last_name <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.upper 转换为大写</span>\n\n<span class=\"token keyword\">SELECT</span> UPPER <span class=\"token punctuation\">(</span>first_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> last_name <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.initcap 将第一个字母大写，其余的小写。</span>\n\n<span class=\"token keyword\">SELECT</span> first_name<span class=\"token punctuation\">,</span> last_name <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> INITCAP <span class=\"token punctuation\">(</span>first_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> last_name <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--04.综合运用</span>\n\n<span class=\"token keyword\">SELECT</span> UPPER <span class=\"token punctuation\">(</span>first_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LOWER <span class=\"token punctuation\">(</span>last_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> INITCAP <span class=\"token punctuation\">(</span>job_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"5-转换函数-日期字符数字转换\"><a href=\"#5-转换函数-日期字符数字转换\" class=\"headerlink\" title=\"5. 转换函数-日期字符数字转换\"></a>5. 转换函数-日期字符数字转换</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.to_date 字符串>日期类型</span>\n<span class=\"token comment\" spellcheck=\"true\">--Year: yy 16,yyy 016, yyyy 2016</span>\n<span class=\"token comment\" spellcheck=\"true\">--Month: mm 11,mon 11 月/nov,month 11 月/november</span>\n<span class=\"token comment\" spellcheck=\"true\">--Day: dd 当月第几天02, ddd 当年第几天02, dy 当周第几天星期五/fri,day 当周第几天星期五/friday</span>\n<span class=\"token comment\" spellcheck=\"true\">--Hour: hh 12 小时进制01，hh24 24 小时进制13</span>\n<span class=\"token comment\" spellcheck=\"true\">--24 小时的时间范围： 0:00:00 - 23:59:59,12 小时时间范围:1:00:00-12:59:59</span>\n<span class=\"token comment\" spellcheck=\"true\">--Minute: mi 60 进制45</span>\n<span class=\"token comment\" spellcheck=\"true\">--Second: ss 60 进制25</span>\n<span class=\"token comment\" spellcheck=\"true\">--其它: Q 季度4， WW 当年第几周44，W 当月第几周1</span>\n\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016-12-18 19:02:02'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016-12-18 19:02'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD HH24:MI'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016-12-18 19'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD HH24'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016-12-18'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016-12'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'20161218'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.to_char 日期/数字>字符串</span>\n\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'dd'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'hh24'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span><span class=\"token string\">'23432.4'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyymmdd'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'mmdd'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_CHAR <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyymm'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.to_number 字符>数字</span>\n\n<span class=\"token keyword\">SELECT</span> SYSDATE <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">365</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TRUNC <span class=\"token punctuation\">(</span>TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">365</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TO_NUMBER <span class=\"token punctuation\">(</span>SYSDATE <span class=\"token operator\">-</span> TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2006-11-02 15:55:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy-mm-dd hh24:mi:ss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"6-日期函数-使用日期函数使用\"><a href=\"#6-日期函数-使用日期函数使用\" class=\"headerlink\" title=\"6. 日期函数-使用日期函数使用\"></a>6. 日期函数-使用日期函数使用</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.sysdate</span>\n\n<span class=\"token keyword\">SELECT</span> SYSDATE <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.add_months 增加/减去月份</span>\n\n<span class=\"token keyword\">SELECT</span> ADD_MONTHS <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> ADD_MONTHS <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.last_day 返回日期的最后一天</span>\n\n<span class=\"token keyword\">SELECT</span> LAST_DAY <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> LAST_DAY <span class=\"token punctuation\">(</span>ADD_MONTHS <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--04.months_between 时间2-时间1 的月份</span>\n\n<span class=\"token keyword\">SELECT</span> MONTHS_BETWEEN <span class=\"token punctuation\">(</span>TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016/11/30'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                       TO_DATE <span class=\"token punctuation\">(</span><span class=\"token string\">'2016/05/30'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY-MM-DD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--05.next_day</span>\n<span class=\"token comment\" spellcheck=\"true\">--星期日=1，一=2 二=3，三=4，四=5，五=6，六=7</span>\n\n<span class=\"token keyword\">SELECT</span> NEXT_DAY <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> NEXT_DAY <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--06.current_date 当前日期</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">CURRENT_DATE</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--07.current_timestamp 当前日期</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--08.sessiontimezone 时区</span>\n\n<span class=\"token keyword\">SELECT</span> SESSIONTIMEZONE <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--09.trunc( for date)</span>\n\n<span class=\"token keyword\">SELECT</span> TRUNC <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'YYYY'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TRUNC <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'MM'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TRUNC <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'D'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> TRUNC <span class=\"token punctuation\">(</span>SYSDATE<span class=\"token punctuation\">,</span> <span class=\"token string\">'DD'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> DUAL<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>字符串与日期转换</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> to_char<span class=\"token punctuation\">(</span>sysdate<span class=\"token punctuation\">,</span><span class=\"token string\">'yyyy-MM-dd HH24:mi:ss'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2018-02-12 16:35:36'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'yyyy-MM-dd HH24:mi:ss'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"7-集合函数-合并两张表的数据\"><a href=\"#7-集合函数-合并两张表的数据\" class=\"headerlink\" title=\"7. 集合函数-合并两张表的数据\"></a>7. 集合函数-合并两张表的数据</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.union (无重并集，去重排序)</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> scott<span class=\"token punctuation\">.</span>salgrade<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> y<span class=\"token punctuation\">.</span>salary\n          <span class=\"token keyword\">FROM</span> employees y\n        <span class=\"token keyword\">UNION</span>\n        <span class=\"token keyword\">SELECT</span> s<span class=\"token punctuation\">.</span>hisal\n          <span class=\"token keyword\">FROM</span> scott<span class=\"token punctuation\">.</span>salgrade s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql06<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> sql06\n<span class=\"token keyword\">AS</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> sql06\n      <span class=\"token keyword\">WHERE</span> sql01_id <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01\n<span class=\"token keyword\">UNION</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql06<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--02.union all（有重并集，不去重排序）</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span> <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> y<span class=\"token punctuation\">.</span>salary\n          <span class=\"token keyword\">FROM</span> employees y\n        <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span>\n        <span class=\"token keyword\">SELECT</span> s<span class=\"token punctuation\">.</span>hisal\n          <span class=\"token keyword\">FROM</span> scott<span class=\"token punctuation\">.</span>salgrade s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01\n<span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql06<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--03.intersect （交集,显示相同的）</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01\n<span class=\"token keyword\">INTERSECT</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql06<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--04.minus （差集，显示不同的）</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01\nMINUS\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql06<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"8-分析函数-使用DECODE-函数\"><a href=\"#8-分析函数-使用DECODE-函数\" class=\"headerlink\" title=\"8. 分析函数-使用DECODE 函数\"></a>8. 分析函数-使用DECODE 函数</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--decode (条件,值1，返回值1，值2，返回值2,...，缺省值）</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> employees<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">SELECT</span> DECODE <span class=\"token punctuation\">(</span>job_id<span class=\"token punctuation\">,</span>  <span class=\"token string\">'AD_PRES'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'CEO'</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">'HR_PEP'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'HR'</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">'SA'</span><span class=\"token punctuation\">)</span> JOB<span class=\"token punctuation\">,</span>\n         <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>                                                JOB_COUNT\n    <span class=\"token keyword\">FROM</span> employees\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> DECODE <span class=\"token punctuation\">(</span>job_id<span class=\"token punctuation\">,</span>  <span class=\"token string\">'AD_PRES'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'CEO'</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">'HR_PEP'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'HR'</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">'SA'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--判断输出</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> salary <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2800</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> DECODE <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">,</span> <span class=\"token number\">3100</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'no'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> DECODE <span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">,</span> <span class=\"token number\">2800</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'no'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> employees\n <span class=\"token keyword\">WHERE</span> salary <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2800</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"OracleSQL语言之常用函数\"><a href=\"#OracleSQL语言之常用函数\" class=\"headerlink\" title=\"OracleSQL语言之常用函数\"></a>OracleSQL语言之常用函数</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-聚合函数-数据统计\"><a href=\"#1-聚合函数-数据统计\" class=\"headerlink\" title=\"1. 聚合函数-数据统计\"></a>1. 聚合函数-数据统计</h2><pre><code class=\"sql\">--01.max 取列和表达式的最大值\n\nSELECT MAX (salary) FROM employees;\nSELECT MAX (DISTINCT salary) FROM employees;\n\n--02.min 取列和表达式的最小值\n\nSELECT MIN (salary) FROM employees;\nSELECT MIN (DISTINCT salary) FROM employees;\n\n--03.avg 取列和表达式的平均值\n\nSELECT AVG (salary) FROM employees;\nSELECT AVG (DISTINCT salary) FROM employees;\nSELECT * FROM employees;\n\n--04.sum 求列和表达式的总和\n\nSELECT SUM (salary) FROM employees;\nSELECT SUM (salary + 1000) FROM employees;\nSELECT SUM ((salary + 1000) - salary) FROM employees;\n\nSELECT department_id, SUM (salary)\n    FROM employees\nGROUP BY department_id\nORDER BY 2 DESC;\n\n--05.count 求行数总和\n\nSELECT COUNT (*) FROM employees;\n\nSELECT COUNT (*)\n  FROM employees\n WHERE manager_id = 120;\n\nSELECT COUNT (email) FROM employees;\n\nSELECT COUNT (DISTINCT manager_id) FROM employees;\n\n--06.other\n--stddev 标准差,variance 协方差，median 求中位数\n\nSELECT STDDEV (salary) FROM employees;\nSELECT VARIANCE (salary) FROM employees;\nSELECT MEDIAN (salary) FROM employees;\n</code></pre>\n<h2 id=\"2-分组函数-使用group-by-与having\"><a href=\"#2-分组函数-使用group-by-与having\" class=\"headerlink\" title=\"2. 分组函数-使用group by 与having\"></a>2. 分组函数-使用group by 与having</h2><pre><code class=\"sql\">-01.简单的分组函数应用\n--统计各个国家名字的长度\n--length,avg,round\n\n  SELECT country_name, LENGTH (country_name)\n    FROM countries\nGROUP BY country_name;\n\nSELECT ROUND (AVG (LENGTH (country_name))) FROM countries;\n\n--工资\n\n  SELECT manager_id, MIN (salary) min_sal, MAX (salary) max_sal\n    FROM employees\nGROUP BY manager_id;\n\n--02.多列分组数据\n--统计简历表中每年辞职的员工数\n--to_char,count\n\nSELECT * FROM jl;\n\n  SELECT TO_CHAR (end_date, &#39;yyyy&#39;) year, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, &#39;yyyy&#39;)\nORDER BY 1;\n\n  SELECT TO_CHAR (end_date, &#39;yyyy&#39;) year, job_id, COUNT (*)\n    FROM job_history\nGROUP BY TO_CHAR (end_date, &#39;yyyy&#39;), job_id\nORDER BY 1;\n\n--03.使用having 子句\n--限制：1.对行进行分组，2.应用组函数，3.显示符合having 子句条件的组\n--查招聘多于等于15 个员工在星期几。\n\nSELECT * FROM employees;\n\n--to_char,count\n\n  SELECT TO_CHAR (hire_date, &#39;Day&#39;) 星期几, COUNT (*)\n    FROM employees\nGROUP BY TO_CHAR (hire_date, &#39;Day&#39;)\n  HAVING COUNT (*) &gt;= 15;\n\n--统计部门里最大工资大于10000 的\n--max\n\nSELECT department_id, MAX (salary)\n    FROM employees\nGROUP BY department_id\n  HAVING MAX (salary) &gt; 10000\nORDER BY 2;\n\n</code></pre>\n<h2 id=\"3-字符函数-运算与截取\"><a href=\"#3-字符函数-运算与截取\" class=\"headerlink\" title=\"3. 字符函数-运算与截取\"></a>3. 字符函数-运算与截取</h2><pre><code class=\"sql\">--01.round（n,[m]） 四舍五入\n--m=0 整数，m&lt;0 小数点的前m 位,m&gt;0 小数点的后m 位\n--四舍\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, ROUND (salary + 0.2) FROM employees;\nSELECT salary, ROUND ((salary + 0.2), 0) FROM employees;\n\n--五入\n\nSELECT salary, salary + 0.8 FROM employees;\nSELECT salary, ROUND (salary + 0.8) FROM employees;\n\n--小数位\n\nSELECT salary, salary + 0.842 FROM employees;\nSELECT salary, ROUND (salary + 0.842) FROM employees;\nSELECT salary, ROUND ((salary + 0.842), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), 2) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -3) FROM employees;\nSELECT salary, ROUND ((salary + 0.867), -4) FROM employees;\n\n--02.trunc(n,[m]) 截取数字.\n--m=0 去掉小数位，m&lt;0 小数点的前m 位,m&gt;0 小数点的后m 位\n\nSELECT salary, salary + 0.2 FROM employees;\nSELECT salary, TRUNC (salary + 0.2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.2), 0) FROM employees;\nSELECT salary, TRUNC (salary + 0.842) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), 2) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -3) FROM employees;\nSELECT salary, TRUNC ((salary + 0.867), -4) FROM employees;\n\n--03.ceil(n) 返回&gt;=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, CEIL (salary + 0.8567) FROM employees;\nSELECT salary, CEIL (salary + 0.2567) FROM employees;\n\n--04.floor(n) 返回&lt;=数字n 的最小整数\n\nSELECT salary, salary + 0.8567 FROM employees;\nSELECT salary, FLOOR (salary + 0.8567) FROM employees;\nSELECT salary, FLOOR (salary + 0.2567) FROM employees;\n\n--05.length(n) 返回字符串的长度\n\nSELECT country_name, LENGTH (country_name) FROM countries;\n</code></pre>\n<h2 id=\"4-转换函数-大小写转换\"><a href=\"#4-转换函数-大小写转换\" class=\"headerlink\" title=\"4. 转换函数-大小写转换\"></a>4. 转换函数-大小写转换</h2><pre><code class=\"sql\">--01.lower 转换为小写\nSELECT * FROM employees;\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name LIKE &#39;%li%&#39;;\n\n--Li,lI,LI,li\n\nSELECT first_name, last_name\n  FROM employees\n WHERE LOWER (first_name) LIKE &#39;%li%&#39;;\n\nSELECT first_name, last_name\n  FROM employees\n WHERE first_name = LOWER (&#39;ITPUX01&#39;);\n\nSELECT LOWER (first_name), last_name FROM employees;\n\n--02.upper 转换为大写\n\nSELECT UPPER (first_name), last_name FROM employees;\n\n--03.initcap 将第一个字母大写，其余的小写。\n\nSELECT first_name, last_name FROM employees;\n\nSELECT INITCAP (first_name), last_name FROM employees;\n\n--04.综合运用\n\nSELECT UPPER (first_name), LOWER (last_name), INITCAP (job_id) FROM employees;\n</code></pre>\n<h2 id=\"5-转换函数-日期字符数字转换\"><a href=\"#5-转换函数-日期字符数字转换\" class=\"headerlink\" title=\"5. 转换函数-日期字符数字转换\"></a>5. 转换函数-日期字符数字转换</h2><pre><code class=\"sql\">--01.to_date 字符串&gt;日期类型\n--Year: yy 16,yyy 016, yyyy 2016\n--Month: mm 11,mon 11 月/nov,month 11 月/november\n--Day: dd 当月第几天02, ddd 当年第几天02, dy 当周第几天星期五/fri,day 当周第几天星期五/friday\n--Hour: hh 12 小时进制01，hh24 24 小时进制13\n--24 小时的时间范围： 0:00:00 - 23:59:59,12 小时时间范围:1:00:00-12:59:59\n--Minute: mi 60 进制45\n--Second: ss 60 进制25\n--其它: Q 季度4， WW 当年第几周44，W 当月第几周1\n\nSELECT TO_DATE (&#39;2016-12-18 19:02:02&#39;, &#39;YYYY-MM-DD HH24:MI:SS&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;2016-12-18 19:02&#39;, &#39;YYYY-MM-DD HH24:MI&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;2016-12-18 19&#39;, &#39;YYYY-MM-DD HH24&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;2016-12-18&#39;, &#39;YYYY-MM-DD&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;2016-12&#39;, &#39;YYYY-MM&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;2016&#39;, &#39;YYYY&#39;) FROM DUAL;\nSELECT TO_DATE (&#39;20161218&#39;, &#39;YYYY-MM-DD&#39;) FROM DUAL;\n\n--02.to_char 日期/数字&gt;字符串\n\nSELECT TO_CHAR (SYSDATE, &#39;yyyy-mm-dd hh24:mi:ss&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;yyyy&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;dd&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;hh24&#39;) FROM DUAL;\nSELECT TO_CHAR (&#39;23432.4&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;yyyymmdd&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;mmdd&#39;) FROM DUAL;\nSELECT TO_CHAR (SYSDATE, &#39;yyyymm&#39;) FROM DUAL;\n\n--03.to_number 字符&gt;数字\n\nSELECT SYSDATE - (TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) / 365 FROM DUAL;\nSELECT TRUNC (TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) / 365) FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) * 24 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) * 24 * 60 FROM DUAL;\nSELECT TO_NUMBER (SYSDATE - TO_DATE (&#39;2006-11-02 15:55:55&#39;, &#39;yyyy-mm-dd hh24:mi:ss&#39;)) * 24 * 60 * 60 FROM DUAL;\n\n</code></pre>\n<h2 id=\"6-日期函数-使用日期函数使用\"><a href=\"#6-日期函数-使用日期函数使用\" class=\"headerlink\" title=\"6. 日期函数-使用日期函数使用\"></a>6. 日期函数-使用日期函数使用</h2><pre><code class=\"sql\">--01.sysdate\n\nSELECT SYSDATE FROM DUAL;\n\n--02.add_months 增加/减去月份\n\nSELECT ADD_MONTHS (SYSDATE, -1) FROM DUAL;\n\nSELECT ADD_MONTHS (SYSDATE, +1) FROM DUAL;\n\n--03.last_day 返回日期的最后一天\n\nSELECT LAST_DAY (SYSDATE) FROM DUAL;\nSELECT LAST_DAY (ADD_MONTHS (SYSDATE, -1)) FROM DUAL;\n\n--04.months_between 时间2-时间1 的月份\n\nSELECT MONTHS_BETWEEN (TO_DATE (&#39;2016/11/30&#39;, &#39;YYYY-MM-DD&#39;),\n                       TO_DATE (&#39;2016/05/30&#39;, &#39;YYYY-MM-DD&#39;))\n    FROM DUAL;\n\n--05.next_day\n--星期日=1，一=2 二=3，三=4，四=5，五=6，六=7\n\nSELECT NEXT_DAY (SYSDATE, 5) FROM DUAL;\nSELECT NEXT_DAY (SYSDATE, 1) FROM DUAL;\n\n--06.current_date 当前日期\n\nSELECT CURRENT_DATE FROM DUAL;\n\n--07.current_timestamp 当前日期\n\nSELECT CURRENT_TIMESTAMP FROM DUAL;\n\n--08.sessiontimezone 时区\n\nSELECT SESSIONTIMEZONE FROM DUAL;\n\n--09.trunc( for date)\n\nSELECT TRUNC (SYSDATE, &#39;YYYY&#39;) FROM DUAL;\nSELECT TRUNC (SYSDATE, &#39;MM&#39;) FROM DUAL;\nSELECT TRUNC (SYSDATE, &#39;D&#39;) FROM DUAL;\nSELECT TRUNC (SYSDATE, &#39;DD&#39;) FROM DUAL;\n</code></pre>\n<ul>\n<li>字符串与日期转换</li>\n</ul>\n<pre><code class=\"sql\">select to_char(sysdate,&#39;yyyy-MM-dd HH24:mi:ss&#39;) from dual;\nselect to_date(&#39;2018-02-12 16:35:36&#39;,&#39;yyyy-MM-dd HH24:mi:ss&#39;) from dual;\n</code></pre>\n<h2 id=\"7-集合函数-合并两张表的数据\"><a href=\"#7-集合函数-合并两张表的数据\" class=\"headerlink\" title=\"7. 集合函数-合并两张表的数据\"></a>7. 集合函数-合并两张表的数据</h2><pre><code class=\"sql\">--01.union (无重并集，去重排序)\nSELECT * FROM employees;\nSELECT * FROM scott.salgrade;\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01;\nSELECT * FROM sql06;\nCREATE TABLE sql06\nAS\n    SELECT * FROM sql01;\n\nDELETE FROM sql06\n      WHERE sql01_id = 3;\n\nCOMMIT;\n\nSELECT * FROM sql01\nUNION\nSELECT * FROM sql06;\n\n--02.union all（有重并集，不去重排序）\n\nSELECT COUNT (1), SUM (salary)\n  FROM (SELECT y.salary\n          FROM employees y\n        UNION ALL\n        SELECT s.hisal\n          FROM scott.salgrade s);\n\nSELECT * FROM sql01\nUNION ALL\nSELECT * FROM sql06;\n\n--03.intersect （交集,显示相同的）\n\nSELECT * FROM sql01\nINTERSECT\nSELECT * FROM sql06;\n\n--04.minus （差集，显示不同的）\n\nSELECT * FROM sql01\nMINUS\nSELECT * FROM sql06;\n</code></pre>\n<h2 id=\"8-分析函数-使用DECODE-函数\"><a href=\"#8-分析函数-使用DECODE-函数\" class=\"headerlink\" title=\"8. 分析函数-使用DECODE 函数\"></a>8. 分析函数-使用DECODE 函数</h2><pre><code class=\"sql\">--decode (条件,值1，返回值1，值2，返回值2,...，缺省值）\nSELECT * FROM employees;\n\n  SELECT DECODE (job_id,  &#39;AD_PRES&#39;, &#39;CEO&#39;,  &#39;HR_PEP&#39;, &#39;HR&#39;,  &#39;SA&#39;) JOB,\n         COUNT (*)                                                JOB_COUNT\n    FROM employees\nGROUP BY DECODE (job_id,  &#39;AD_PRES&#39;, &#39;CEO&#39;,  &#39;HR_PEP&#39;, &#39;HR&#39;,  &#39;SA&#39;);\n\n--判断输出\n\nSELECT *\n  FROM employees\n WHERE salary IN (3100, 2800);\n\nSELECT DECODE (salary, 3100, &#39;yes&#39;, &#39;no&#39;), DECODE (salary, 2800, &#39;yes&#39;, &#39;no&#39;)\n  FROM employees\n WHERE salary IN (3100, 2800);\n</code></pre>\n"},{"title":"Oracle Goldengate数据库复制与容灾实施","date":"2018-09-07T01:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n# OracleGoldengate数据库复制与容灾实施\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.GoldenGate 文件系统-文件系统\n\n### 1.1 安装OGG软件(源端-目标端)\n\n```sql\n\n```\n\n### 1.2 创建OGG用户(源端-目标端)\n\n* 源端\n\n```sql\nCREATE TABLESPACE ogg_tbs\n\tDATAFILE '/u01/oradata/orcl/ogg_tbs.dbf'\n\t\tSIZE 100 M\n\t    AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege('GOLDENGATE','*',TRUE)\n```\n\n* 目标端\n\n```sql\nCREATE TABLESPACE ogg_tbs\n\t\tDATAFILE '/u01/oradata/itpux/ogg_tbs.dbf'\n\t\tSIZE 100 M\n    AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege('GOLDENGATE','*',TRUE)\n```\n\n### 1.3 创建测试用户(源端-目标端)\n* 源端\n\n```sql\nCREATE  TABLESPACE \"KYLE\"\n    DATAFILE '/u01/app/oracle/oradata/orcl/kyle01.dbf'\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER \"KYLE\"\n    PROFILE \"DEFAULT\" \n    IDENTIFIED BY \"kyle\" \n    DEFAULT TABLESPACE \"KYLE\" \n    TEMPORARY TABLESPACE \"TEMP\" \n    ACCOUNT UNLOCK;\n\n--测试数据\nSELECT table_name FROM user_tables;\n\nCREATE SEQUENCE seq_kyle START WITH 1 INCREMENT BY 1;\nCREATE TABLE kyle01 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle02 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle03 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\n\nINSERT INTO kyle01 VALUES(1,1,'Kyle01');\nINSERT INTO kyle01 VALUES(2,2,'Kyle02');\nINSERT INTO kyle01 VALUES(3,3,'Kyle03');\nINSERT INTO kyle01 VALUES(4,4,'Kyle04');\n\nDECLARE\n  rnd number(9,2);\nBEGIN\n   for i in 1..20000 loop\n     IF MOD(i,2000)=0 THEN\n     \tcommit;\n     ELSE\n     \tinsert into kyle03 values(seq_kyle.nextval,i*dbms_random.value,'Kyle Is Testing');\n     END IF;\n   END LOOP;\nEND;\n/\n\nBEGIN\n   LOOP\n    delete from kyle03 where rownum=1;\n     commit;\n     insert into kyle03 values(seq_kyle.nextval,200000*dbms_random.value,'MACLEAN IS UPDATING');\n     commit;\n\t insert into kyle03 values(seq_kyle.nextval,300000*dbms_random.value,'MACLEAN IS UPDATING');\n\t commit;\n\tupdate kyle03 set rand=rand+10 where rownum=1;\n\tcommit;\n     dbms_lock.sleep(1);\n     END loop;\nEND;\n\n/\n\n\t\n```\n* 目标端\n\n```sql\nCREATE  TABLESPACE \"KYLE\"\n    DATAFILE '/u01/oradata/itpux/kyle01.dbf'\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER \"KYLE\"\n    PROFILE \"DEFAULT\" \n    IDENTIFIED BY \"kyle\" \n    DEFAULT TABLESPACE \"KYLE\" \n    TEMPORARY TABLESPACE \"TEMP\" \n    ACCOUNT UNLOCK;\n```\n### 1.4 数据导入导出\n```sql\ncreate directory bakdir as '/home/oracle';\ngrant read,write on directory bakdir to system;\ngrant create any directory to system;\n\n--导出结构\nCREATE DIRECTORY BAKDIR AS '/home/oracle';\nGRANT READ,WRITE ON DIRECTORY BAKDIR TO SYSTEM;\nGRANT CREATE ANY DIRECTORY TO SYSTEM;\n--导出某个或多个schema\nexpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log SCHEMAS=kyle\nimpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log TABLE_EXISTS_ACTION=truncate SCHEMAS=kyle\nscp /home/oracle/expdp_schema_kyle.dmp orcl-122:/home/oracle/\n```\n\n### 1.5 配置环境变量\n```sql\nalias sqlplus=\"rlwrap sqlplus\"\nalias ggsci=\"rlwrap ggsci\"\nalias rman=\"rlwrap rman\"\nalias asmcmd=\"rlwrap asmcmd\"\n\nLD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib; export LD_LIBRARY_PATH\nCLASSPATH=/ggs:$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib; export CLASSPATH\nOGG_PATH=/u01/ggs export OGG_PATH\nPATH=.:$PATH:$OGG_PATH:$HOME/bin:$ORACLE_BASE/product/11.2.0/db_1/bin:$ORACLE_HOME/bin; export PATH\n```\n\n### 1.6 修改系统参数开启归档\n```sql\nALTER SYSTEM SET ENABLE_GOLDENGATE_REPLICATION = TRUE SCOPE=BOTH;\nalter database add supplemental log data;\nalter database force logging;\n```\n\n### 1.7 配置OGG(源端)\n* 1.创建目录\n\n```sql\ncreate subdirs\n```\n* 2.配置MGR\n\n```sql\nGGSCI>\nEDIT PARAMS mgr\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\n--端口 7809\n--自动启动 ER(EXTARCT REPLACT)\n\n```\n\n* 3.配置检查点\n\n```sql\n--GLOBALS储存了运行的一些信息\nGGSCI> EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI> dblogin userid goldengate,password goldengate\nGGSCI> ADD CHECKPOINTTABLE goldengate.checkpoint\n```\n\n* 4.添加补充日志\n\n```sql\n--ADD TRANDATA itpux.*\nADD SCHEMATRANDATA kyle\n--配置ddl 的时候，一定要用ADD SCHEMATRANDATA\n--如果不用ddl,可以用ADD TRANDATA\ninfo SCHEMATRANDATA kyle\n```\n\n* 5.配置extract进程\n\n```sql\n--建立EXTRACT目录\nmkdir -p ./dirdat/rkyle\nmkdir -p ./dirrpt/rkyle\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI>\nEDIT PARAMS ekyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"itpux\")\nEXTRACT ekyle\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nUSERID goldengate, PASSWORD goldengate\nEXTTRAIL ./dirdat/ekyle/ex\nTRANLOGOPTIONS excludeuser goldengate\nTRANLOGOPTIONS convertucs2clobs\nWARNLONGTRANS 12h,CHECKINTERVAL 30m\nDISCARDFILE ./dirrpt/ekyle/ekyle.dsc, APPEND, MEGABYTES 200\nTABLE kyle.*;\n\n--设置语言\n--设置SID\n--设置EXTRACT名称不能操作过8个字符\n--抽取所有的DDL操作\n--\n--定义OGG使用用户\n--设置抽取目录\n--排除用于管理抽取的OGG用户\n--某某参数，可以传输大字段\n--设置告警阈值\n--配置文件存放位置\n--抽取的表\n\n--添加一个抽取进程\n--THREADS 2表示源端有2个RAC节点\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW, THREADS 2\n--添加一个队列文件\nGGSCI>\nADD EXTTRAIL ./dirdat/ekyle/ex, EXTRACT ekyle, MEGABYTES 200\n\n--启动停止测试\nGGSCI>\nSTART ekyle\nSTOP ekyle\nVIEW REPORT ekyle\n```\n\n* 6.配置PUMP进程\n\n```sql\ncd /u01/ggs\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI>\nEDIT PARAMS pkyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"orcl\")\nEXTRACT pkyle\nUSERID goldengate,PASSWORD goldengate\nPASSTHRU\t\t\t\t\t\t\nRMTHOST 172.17.0.122,MGRPORT 7809\nRMTTRAIL ./dirdat/rkyle/re\nDISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200\nTABLE ekyle.*;\n\n--\n--\n--\n-- 禁止extract与数据库交互，适合于PUMP传输进程\n-- 远端的IP,端口\n-- 指定写入到远程目标端的哪个队列\n-- 指定报错输出文件\n-- 指定传输表\n\n\n--增加pump 进程(指定本地trail 文件)\nGGSCI>\nADD EXTRACT pkyle,EXTTRAILSOURCE ./dirdat/ekyle/ex\n\n--增加rmttail 文件\nGGSCI>\nADD RMTTRAIL ./dirdat/rkyle/re, EXTRACT pkyle, MEGABYTES 200\n--检查:\nGGSCI>\nINFO  pkyle\n```\n\n### 1.8 配置OGG(目标端)\n* 1.配置mgr\n\n```sql\nGGSCI> EDIT PARAMS MGR\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\nGGSCI>\nSTART MGR\nSTOP MGR\n```\n\n* 2.配置检查点\n\n```sql\nGGSCI> EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI> dblogin userid goldengate,password goldengate\nGGSCI> ADD CHECKPOINTTABLE goldengate.checkpoint\n```\n* 3.配置replicat进程\n```sql\ncd /u01/ggs\nmkdir -p ./dirdat/rkyle\nmkdir -p ./dirrpt/rkyle\n\nggsci> edit params rkyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"itpux\")\nREPLICAT rkyle\nUSERID goldengate,PASSWORD goldengate\nhandlecollisions\nassumetargetdefs\nDISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200\nMAP kyle.*, target kyle.*;\n\n--添加replicat 进程\nGGSCI>\nADD REPLICAT rkyle EXTTRAIL ./dirdat/rkyle/re, CHECKPOINTTABLE goldengate.checkpoint\n--启动相关进程(目标)\nGGSCI>\nSTART rkyle\nVIEW REPORT rkyle\nINFO ALL\n--启动相关进程(源端)\nGGSCI>\nSTART rkyle\nSTART pkyle\nVIEW REPORT rkyle\nVIEW REPORT pkyle\nINFO ALL\n```\n\n### 1.9 disable 目标库所有的trigger、cascading delete、check、job\n```sql\nSET PAGESIZE 2000\nSET LINESIZE 100\n--Foreign key Constraints/Cascading Deletes\nSELECT    'alter table '\n       || owner\n       || '.'\n       || table_name\n       || ' DISABLE CONSTRAINT '\n       || constraint_name\n       || ';'\n  FROM dba_constraints\n WHERE     constraint_type = 'R'\n       AND delete_rule = 'CASCADE'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n\n--查找生成并disable 约束(Check)：\nSELECT    'alter table '\n       || owner\n       || '.'\n       || table_name\n       || ' DISABLE CONSTRAINT '\n       || constraint_name\n       || ';'\n  FROM dba_constraints\n WHERE     constraint_type = 'C'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n--查找生成并disable trigger：\nSELECT 'alter trigger ' || owner || '.' || object_name || ' disable;'\n  FROM dba_objects\n WHERE     object_type = 'TRIGGER'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n\n--查找并disable job\nSELECT job,\n       next_date,\n       next_sec,\n       failures,\n       broken\n  FROM dba_jobs\n WHERE SCHEMA_USER IN ('KYLE',\n                       'KYLE01');\n\nBEGIN\n    sys.DBMS_JOB.broken (job => 21, broken => TRUE);\n    COMMIT;\nEND;\n\n\n--生成结果如下，然后在目标数据库中执行：\nalter table ... DISABLE CONSTRAINT SYS_C0017353;\nalter table ... DISABLE CONSTRAINT SYS_C0017355;…\n…\nalter trigger ... disable;\nalter trigger ... disable;\nalter trigger ... disable;\n--确认外键已经被禁用\nSELECT OWNER,\n       CONSTRAINT_NAME,\n       CONSTRAINT_TYPE,\n       STATUS\n  FROM dba_CONSTRAINTS\n WHERE     CONSTRAINT_TYPE = 'R'\n       AND status = 'ENABLED'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n--确认目标端目标表的主键可用:\nSELECT T1.STATUS,\n       T1.VALIDATED,\n       T2.status,\n       T1.constraint_name,\n       T1.owner\n  FROM dba_constraints T1, dba_objects T2\n WHERE     T2.OBJECT_NAME = T1.constraint_name\n       AND T1.OWNER IN ('KYLE',\n                        'KYLE01');\n\n--验证job 确实被禁用\nSELECT job,\n       LOG_USER,\n       PRIV_USER,\n       SCHEMA_USER,\n       broken\n  FROM dba_jobs\n WHERE schema_user IN ('KYLE',\n                       'KYLE01');\n\nSELECT OWNER, JOB_NAME, STATE\n  FROM DBA_SCHEDULER_JOBS\n WHERE OWNER IN ('KYLE',\n                 'KYLE01');\n\n--确认trigger 已经全部关闭\nSELECT DISTINCT status\n  FROM dba_triggers\n WHERE owner IN ('KYLE',\n                 'KYLE01');\n```\n\n## 2,.添加DDL功能与加密\n\n### 2.1 添加DDL功能\n* 1.关闭所有OGG进程\n\n```sql\nSTOP ekyle\nSTOP pkyle\nSTOP rkyle\n```\n* 2.用户的默认表空间不能自动SYSTEM表空间\n\n```sql\nset PAGRSIZE 200\nset LINESIZE 200\ncol USERNAME format A20\ncol DEFAULT_TABLESPACE format A20 \n\nSELECT username, default_tablespace FROM dba_users;\n```\n\n* 3.关闭回收站并清空回收站\n\n```sql\n--11G可以启动回收站，10G必须关闭回收站\nALTER SYSTEM SET recyclebin = off SCOPE = SPFILE;\nPURGE DBA_RECYCLEBIN;\n```\n\n* 4.指明支持DDL的对象放在那个SCHEMA下载\n\n```sql\nggsci> edit params ./GLOBALS\nGGSCHEMA goldengate\n```\n\n* 5.添加相关权限\n\n```sql\nGRANT EXECUTE ON UTL_FILE TO goldengate;\nGRANT RESTRICTED SESSION TO goldengate;\nGRANT CREATE TABLE, CREATE SEQUENCE TO goldengate;\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n```\n\n* 6.执行脚本（源目标）\n\n```sql\ncd /ggs\nsqlplus \"/as sysdba\"\n@marker_setup.sql\n@ddl_setup.sql\n@role_setup.sql\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n@ddl_enable.sql\n@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n@ddl_pin.sql goldengate\n```\n\n* 7.修改参数，增加DDL复制参数\n\n```sql\nggsci >edit params eitpux01\n--DDL INCLUDE OBJNAME \"ITPUX01.*\"\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\n\nggsci >edit params ritpux01\n--DDL INCLUDE OBJNAME \"ITPUX01.*\"\nDDL INCLUDE ALL\nDDLERROR default ignore retryop\n```\n* 8.启动进程\n\n```sql\nSTART ekyle\nSTART pkyle\nSTART ryle\n```\n* DDL其他功能\n\n```sql\n--开启\nddl_enable.sql\n--关闭\nddl_disable.sql\n\n--清空DDL trace ggs_ddl_trace.log\nddl_cleartrace.sql\n\n--ddl 参数：\noptype alert\nobjtype \"table\"\nojbname \"user.tab*\"\ninclude mapped object \"*\";\nexclude mapped object \"itpux.itux*\"\nDDL 环境重配（删除就是1-5，12，去掉参数中的DDL）:\n1.停止所有的OGG ex/pump/rp 进程\n2.@ddl_disable.sql\n3.@ddl_remove.sql\n4.@marker_remove.sql\n5.@marker_setup.sql\n6.@ddl_setup.sql\n7.@role_setup.sql\n8.GRANT GGS_GGSUSER_ROLE TO goldengate;\n9.@ddl_enable.sql\n10.@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n11.@ddl_pin.sql goldengate\n12.运行所有的OGG ex/pump/rp 进程\n```\n\n### 2.2 加密\n* 1.生成加密的KEY \n\n```sql\n[oracle@orcl:/u01/ggs]$keygen 256 1\n0x1673D6197E05DA1009B1451420A73134BDF868246D6AC878FBFC69193231C355\n```\n\n* 2.将KEY存到本地指定文件\n\n```sql\n[oracle@orcl:/u01/ggs]$cat ENCKEYS \nKYLE_KEY 0xE9E07156ACC2411F97E78D117B55C444E935E27A034CBD389CF2F432F8B5F417\n```\n\n* 3.设置登录用的的KEY\n\n```sql\n\nGGSCI (orcl) 109> ENCRYPT PASSWORD goldengate AES256 ENCRYPTKEY KYLE_KEY\nEncrypted password:  AADAAAAAAAAAAAKABIXBCASDGBHCGFNGMHJIFFMDXFGBRCLHTGJGVIECPCGEUAJEXDSEFBUCGATGKGUGBGCCVFKBBENDYBSAPDZBACQCQILIRHYH\nAlgorithm used:  AES256\n```\n\n* 添加KEY到相应文件\n\n```sql\nextract eitpux01\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nuserid goldengate,password AADAAAAAAAAAAAKACAHHWIRDTBQDNBUJYFUCXCGEVBCDHBCEGFOIQFSEGFKCBGLDPGUGAIIHZDJATJSJYBPBSJSJUFSBJCUBYCXBFBPJPDSBVGBJ,AES256,ENCRYPTKEY KYLE_KEY\nexttrail ./dirdat/eitpux01/ex\ntranlogoptions excludeuser goldengate\ntranlogoptions convertucs2clobs\nwarnlongtrans 12h,checkinterval 30m\ndiscardfile ./dirrpt/eitpux01/eitpux01.dsc,append,megabytes 200\nTABLE itpux.*;\n--TABLE itpux01.*;\n--TABLE itpux02.*;\n--TABLE itpux03.*;\n```\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle GoldenGate复制与容灾实施手册.md","raw":"---\ntitle: Oracle Goldengate数据库复制与容灾实施\ndate: 2018-09-07 09:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - GoldenGate\n  - 备份容灾\n---\n\n# OracleGoldengate数据库复制与容灾实施\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.GoldenGate 文件系统-文件系统\n\n### 1.1 安装OGG软件(源端-目标端)\n\n```sql\n\n```\n\n### 1.2 创建OGG用户(源端-目标端)\n\n* 源端\n\n```sql\nCREATE TABLESPACE ogg_tbs\n\tDATAFILE '/u01/oradata/orcl/ogg_tbs.dbf'\n\t\tSIZE 100 M\n\t    AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege('GOLDENGATE','*',TRUE)\n```\n\n* 目标端\n\n```sql\nCREATE TABLESPACE ogg_tbs\n\t\tDATAFILE '/u01/oradata/itpux/ogg_tbs.dbf'\n\t\tSIZE 100 M\n    AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege('GOLDENGATE','*',TRUE)\n```\n\n### 1.3 创建测试用户(源端-目标端)\n* 源端\n\n```sql\nCREATE  TABLESPACE \"KYLE\"\n    DATAFILE '/u01/app/oracle/oradata/orcl/kyle01.dbf'\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER \"KYLE\"\n    PROFILE \"DEFAULT\" \n    IDENTIFIED BY \"kyle\" \n    DEFAULT TABLESPACE \"KYLE\" \n    TEMPORARY TABLESPACE \"TEMP\" \n    ACCOUNT UNLOCK;\n\n--测试数据\nSELECT table_name FROM user_tables;\n\nCREATE SEQUENCE seq_kyle START WITH 1 INCREMENT BY 1;\nCREATE TABLE kyle01 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle02 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle03 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\n\nINSERT INTO kyle01 VALUES(1,1,'Kyle01');\nINSERT INTO kyle01 VALUES(2,2,'Kyle02');\nINSERT INTO kyle01 VALUES(3,3,'Kyle03');\nINSERT INTO kyle01 VALUES(4,4,'Kyle04');\n\nDECLARE\n  rnd number(9,2);\nBEGIN\n   for i in 1..20000 loop\n     IF MOD(i,2000)=0 THEN\n     \tcommit;\n     ELSE\n     \tinsert into kyle03 values(seq_kyle.nextval,i*dbms_random.value,'Kyle Is Testing');\n     END IF;\n   END LOOP;\nEND;\n/\n\nBEGIN\n   LOOP\n    delete from kyle03 where rownum=1;\n     commit;\n     insert into kyle03 values(seq_kyle.nextval,200000*dbms_random.value,'MACLEAN IS UPDATING');\n     commit;\n\t insert into kyle03 values(seq_kyle.nextval,300000*dbms_random.value,'MACLEAN IS UPDATING');\n\t commit;\n\tupdate kyle03 set rand=rand+10 where rownum=1;\n\tcommit;\n     dbms_lock.sleep(1);\n     END loop;\nEND;\n\n/\n\n\t\n```\n* 目标端\n\n```sql\nCREATE  TABLESPACE \"KYLE\"\n    DATAFILE '/u01/oradata/itpux/kyle01.dbf'\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER \"KYLE\"\n    PROFILE \"DEFAULT\" \n    IDENTIFIED BY \"kyle\" \n    DEFAULT TABLESPACE \"KYLE\" \n    TEMPORARY TABLESPACE \"TEMP\" \n    ACCOUNT UNLOCK;\n```\n### 1.4 数据导入导出\n```sql\ncreate directory bakdir as '/home/oracle';\ngrant read,write on directory bakdir to system;\ngrant create any directory to system;\n\n--导出结构\nCREATE DIRECTORY BAKDIR AS '/home/oracle';\nGRANT READ,WRITE ON DIRECTORY BAKDIR TO SYSTEM;\nGRANT CREATE ANY DIRECTORY TO SYSTEM;\n--导出某个或多个schema\nexpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log SCHEMAS=kyle\nimpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log TABLE_EXISTS_ACTION=truncate SCHEMAS=kyle\nscp /home/oracle/expdp_schema_kyle.dmp orcl-122:/home/oracle/\n```\n\n### 1.5 配置环境变量\n```sql\nalias sqlplus=\"rlwrap sqlplus\"\nalias ggsci=\"rlwrap ggsci\"\nalias rman=\"rlwrap rman\"\nalias asmcmd=\"rlwrap asmcmd\"\n\nLD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib; export LD_LIBRARY_PATH\nCLASSPATH=/ggs:$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib; export CLASSPATH\nOGG_PATH=/u01/ggs export OGG_PATH\nPATH=.:$PATH:$OGG_PATH:$HOME/bin:$ORACLE_BASE/product/11.2.0/db_1/bin:$ORACLE_HOME/bin; export PATH\n```\n\n### 1.6 修改系统参数开启归档\n```sql\nALTER SYSTEM SET ENABLE_GOLDENGATE_REPLICATION = TRUE SCOPE=BOTH;\nalter database add supplemental log data;\nalter database force logging;\n```\n\n### 1.7 配置OGG(源端)\n* 1.创建目录\n\n```sql\ncreate subdirs\n```\n* 2.配置MGR\n\n```sql\nGGSCI>\nEDIT PARAMS mgr\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\n--端口 7809\n--自动启动 ER(EXTARCT REPLACT)\n\n```\n\n* 3.配置检查点\n\n```sql\n--GLOBALS储存了运行的一些信息\nGGSCI> EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI> dblogin userid goldengate,password goldengate\nGGSCI> ADD CHECKPOINTTABLE goldengate.checkpoint\n```\n\n* 4.添加补充日志\n\n```sql\n--ADD TRANDATA itpux.*\nADD SCHEMATRANDATA kyle\n--配置ddl 的时候，一定要用ADD SCHEMATRANDATA\n--如果不用ddl,可以用ADD TRANDATA\ninfo SCHEMATRANDATA kyle\n```\n\n* 5.配置extract进程\n\n```sql\n--建立EXTRACT目录\nmkdir -p ./dirdat/rkyle\nmkdir -p ./dirrpt/rkyle\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI>\nEDIT PARAMS ekyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"itpux\")\nEXTRACT ekyle\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nUSERID goldengate, PASSWORD goldengate\nEXTTRAIL ./dirdat/ekyle/ex\nTRANLOGOPTIONS excludeuser goldengate\nTRANLOGOPTIONS convertucs2clobs\nWARNLONGTRANS 12h,CHECKINTERVAL 30m\nDISCARDFILE ./dirrpt/ekyle/ekyle.dsc, APPEND, MEGABYTES 200\nTABLE kyle.*;\n\n--设置语言\n--设置SID\n--设置EXTRACT名称不能操作过8个字符\n--抽取所有的DDL操作\n--\n--定义OGG使用用户\n--设置抽取目录\n--排除用于管理抽取的OGG用户\n--某某参数，可以传输大字段\n--设置告警阈值\n--配置文件存放位置\n--抽取的表\n\n--添加一个抽取进程\n--THREADS 2表示源端有2个RAC节点\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW, THREADS 2\n--添加一个队列文件\nGGSCI>\nADD EXTTRAIL ./dirdat/ekyle/ex, EXTRACT ekyle, MEGABYTES 200\n\n--启动停止测试\nGGSCI>\nSTART ekyle\nSTOP ekyle\nVIEW REPORT ekyle\n```\n\n* 6.配置PUMP进程\n\n```sql\ncd /u01/ggs\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI>\nEDIT PARAMS pkyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"orcl\")\nEXTRACT pkyle\nUSERID goldengate,PASSWORD goldengate\nPASSTHRU\t\t\t\t\t\t\nRMTHOST 172.17.0.122,MGRPORT 7809\nRMTTRAIL ./dirdat/rkyle/re\nDISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200\nTABLE ekyle.*;\n\n--\n--\n--\n-- 禁止extract与数据库交互，适合于PUMP传输进程\n-- 远端的IP,端口\n-- 指定写入到远程目标端的哪个队列\n-- 指定报错输出文件\n-- 指定传输表\n\n\n--增加pump 进程(指定本地trail 文件)\nGGSCI>\nADD EXTRACT pkyle,EXTTRAILSOURCE ./dirdat/ekyle/ex\n\n--增加rmttail 文件\nGGSCI>\nADD RMTTRAIL ./dirdat/rkyle/re, EXTRACT pkyle, MEGABYTES 200\n--检查:\nGGSCI>\nINFO  pkyle\n```\n\n### 1.8 配置OGG(目标端)\n* 1.配置mgr\n\n```sql\nGGSCI> EDIT PARAMS MGR\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\nGGSCI>\nSTART MGR\nSTOP MGR\n```\n\n* 2.配置检查点\n\n```sql\nGGSCI> EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI> dblogin userid goldengate,password goldengate\nGGSCI> ADD CHECKPOINTTABLE goldengate.checkpoint\n```\n* 3.配置replicat进程\n```sql\ncd /u01/ggs\nmkdir -p ./dirdat/rkyle\nmkdir -p ./dirrpt/rkyle\n\nggsci> edit params rkyle\n\nsetenv(NLS_LANG=\"AMERICAN_AMERICA.ZHS16GBK\")\nsetenv(ORACLE_SID=\"itpux\")\nREPLICAT rkyle\nUSERID goldengate,PASSWORD goldengate\nhandlecollisions\nassumetargetdefs\nDISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200\nMAP kyle.*, target kyle.*;\n\n--添加replicat 进程\nGGSCI>\nADD REPLICAT rkyle EXTTRAIL ./dirdat/rkyle/re, CHECKPOINTTABLE goldengate.checkpoint\n--启动相关进程(目标)\nGGSCI>\nSTART rkyle\nVIEW REPORT rkyle\nINFO ALL\n--启动相关进程(源端)\nGGSCI>\nSTART rkyle\nSTART pkyle\nVIEW REPORT rkyle\nVIEW REPORT pkyle\nINFO ALL\n```\n\n### 1.9 disable 目标库所有的trigger、cascading delete、check、job\n```sql\nSET PAGESIZE 2000\nSET LINESIZE 100\n--Foreign key Constraints/Cascading Deletes\nSELECT    'alter table '\n       || owner\n       || '.'\n       || table_name\n       || ' DISABLE CONSTRAINT '\n       || constraint_name\n       || ';'\n  FROM dba_constraints\n WHERE     constraint_type = 'R'\n       AND delete_rule = 'CASCADE'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n\n--查找生成并disable 约束(Check)：\nSELECT    'alter table '\n       || owner\n       || '.'\n       || table_name\n       || ' DISABLE CONSTRAINT '\n       || constraint_name\n       || ';'\n  FROM dba_constraints\n WHERE     constraint_type = 'C'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n--查找生成并disable trigger：\nSELECT 'alter trigger ' || owner || '.' || object_name || ' disable;'\n  FROM dba_objects\n WHERE     object_type = 'TRIGGER'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n\n\n--查找并disable job\nSELECT job,\n       next_date,\n       next_sec,\n       failures,\n       broken\n  FROM dba_jobs\n WHERE SCHEMA_USER IN ('KYLE',\n                       'KYLE01');\n\nBEGIN\n    sys.DBMS_JOB.broken (job => 21, broken => TRUE);\n    COMMIT;\nEND;\n\n\n--生成结果如下，然后在目标数据库中执行：\nalter table ... DISABLE CONSTRAINT SYS_C0017353;\nalter table ... DISABLE CONSTRAINT SYS_C0017355;…\n…\nalter trigger ... disable;\nalter trigger ... disable;\nalter trigger ... disable;\n--确认外键已经被禁用\nSELECT OWNER,\n       CONSTRAINT_NAME,\n       CONSTRAINT_TYPE,\n       STATUS\n  FROM dba_CONSTRAINTS\n WHERE     CONSTRAINT_TYPE = 'R'\n       AND status = 'ENABLED'\n       AND owner IN ('KYLE',\n                     'KYLE01');\n--确认目标端目标表的主键可用:\nSELECT T1.STATUS,\n       T1.VALIDATED,\n       T2.status,\n       T1.constraint_name,\n       T1.owner\n  FROM dba_constraints T1, dba_objects T2\n WHERE     T2.OBJECT_NAME = T1.constraint_name\n       AND T1.OWNER IN ('KYLE',\n                        'KYLE01');\n\n--验证job 确实被禁用\nSELECT job,\n       LOG_USER,\n       PRIV_USER,\n       SCHEMA_USER,\n       broken\n  FROM dba_jobs\n WHERE schema_user IN ('KYLE',\n                       'KYLE01');\n\nSELECT OWNER, JOB_NAME, STATE\n  FROM DBA_SCHEDULER_JOBS\n WHERE OWNER IN ('KYLE',\n                 'KYLE01');\n\n--确认trigger 已经全部关闭\nSELECT DISTINCT status\n  FROM dba_triggers\n WHERE owner IN ('KYLE',\n                 'KYLE01');\n```\n\n## 2,.添加DDL功能与加密\n\n### 2.1 添加DDL功能\n* 1.关闭所有OGG进程\n\n```sql\nSTOP ekyle\nSTOP pkyle\nSTOP rkyle\n```\n* 2.用户的默认表空间不能自动SYSTEM表空间\n\n```sql\nset PAGRSIZE 200\nset LINESIZE 200\ncol USERNAME format A20\ncol DEFAULT_TABLESPACE format A20 \n\nSELECT username, default_tablespace FROM dba_users;\n```\n\n* 3.关闭回收站并清空回收站\n\n```sql\n--11G可以启动回收站，10G必须关闭回收站\nALTER SYSTEM SET recyclebin = off SCOPE = SPFILE;\nPURGE DBA_RECYCLEBIN;\n```\n\n* 4.指明支持DDL的对象放在那个SCHEMA下载\n\n```sql\nggsci> edit params ./GLOBALS\nGGSCHEMA goldengate\n```\n\n* 5.添加相关权限\n\n```sql\nGRANT EXECUTE ON UTL_FILE TO goldengate;\nGRANT RESTRICTED SESSION TO goldengate;\nGRANT CREATE TABLE, CREATE SEQUENCE TO goldengate;\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n```\n\n* 6.执行脚本（源目标）\n\n```sql\ncd /ggs\nsqlplus \"/as sysdba\"\n@marker_setup.sql\n@ddl_setup.sql\n@role_setup.sql\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n@ddl_enable.sql\n@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n@ddl_pin.sql goldengate\n```\n\n* 7.修改参数，增加DDL复制参数\n\n```sql\nggsci >edit params eitpux01\n--DDL INCLUDE OBJNAME \"ITPUX01.*\"\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\n\nggsci >edit params ritpux01\n--DDL INCLUDE OBJNAME \"ITPUX01.*\"\nDDL INCLUDE ALL\nDDLERROR default ignore retryop\n```\n* 8.启动进程\n\n```sql\nSTART ekyle\nSTART pkyle\nSTART ryle\n```\n* DDL其他功能\n\n```sql\n--开启\nddl_enable.sql\n--关闭\nddl_disable.sql\n\n--清空DDL trace ggs_ddl_trace.log\nddl_cleartrace.sql\n\n--ddl 参数：\noptype alert\nobjtype \"table\"\nojbname \"user.tab*\"\ninclude mapped object \"*\";\nexclude mapped object \"itpux.itux*\"\nDDL 环境重配（删除就是1-5，12，去掉参数中的DDL）:\n1.停止所有的OGG ex/pump/rp 进程\n2.@ddl_disable.sql\n3.@ddl_remove.sql\n4.@marker_remove.sql\n5.@marker_setup.sql\n6.@ddl_setup.sql\n7.@role_setup.sql\n8.GRANT GGS_GGSUSER_ROLE TO goldengate;\n9.@ddl_enable.sql\n10.@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n11.@ddl_pin.sql goldengate\n12.运行所有的OGG ex/pump/rp 进程\n```\n\n### 2.2 加密\n* 1.生成加密的KEY \n\n```sql\n[oracle@orcl:/u01/ggs]$keygen 256 1\n0x1673D6197E05DA1009B1451420A73134BDF868246D6AC878FBFC69193231C355\n```\n\n* 2.将KEY存到本地指定文件\n\n```sql\n[oracle@orcl:/u01/ggs]$cat ENCKEYS \nKYLE_KEY 0xE9E07156ACC2411F97E78D117B55C444E935E27A034CBD389CF2F432F8B5F417\n```\n\n* 3.设置登录用的的KEY\n\n```sql\n\nGGSCI (orcl) 109> ENCRYPT PASSWORD goldengate AES256 ENCRYPTKEY KYLE_KEY\nEncrypted password:  AADAAAAAAAAAAAKABIXBCASDGBHCGFNGMHJIFFMDXFGBRCLHTGJGVIECPCGEUAJEXDSEFBUCGATGKGUGBGCCVFKBBENDYBSAPDZBACQCQILIRHYH\nAlgorithm used:  AES256\n```\n\n* 添加KEY到相应文件\n\n```sql\nextract eitpux01\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nuserid goldengate,password AADAAAAAAAAAAAKACAHHWIRDTBQDNBUJYFUCXCGEVBCDHBCEGFOIQFSEGFKCBGLDPGUGAIIHZDJATJSJYBPBSJSJUFSBJCUBYCXBFBPJPDSBVGBJ,AES256,ENCRYPTKEY KYLE_KEY\nexttrail ./dirdat/eitpux01/ex\ntranlogoptions excludeuser goldengate\ntranlogoptions convertucs2clobs\nwarnlongtrans 12h,checkinterval 30m\ndiscardfile ./dirrpt/eitpux01/eitpux01.dsc,append,megabytes 200\nTABLE itpux.*;\n--TABLE itpux01.*;\n--TABLE itpux02.*;\n--TABLE itpux03.*;\n```\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle GoldenGate复制与容灾实施手册","published":1,"updated":"2019-05-03T15:43:45.067Z","_id":"cjv8901zt001si0cdfpulodj2","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"OracleGoldengate数据库复制与容灾实施\"><a href=\"#OracleGoldengate数据库复制与容灾实施\" class=\"headerlink\" title=\"OracleGoldengate数据库复制与容灾实施\"></a>OracleGoldengate数据库复制与容灾实施</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-GoldenGate-文件系统-文件系统\"><a href=\"#1-GoldenGate-文件系统-文件系统\" class=\"headerlink\" title=\"1.GoldenGate 文件系统-文件系统\"></a>1.GoldenGate 文件系统-文件系统</h2><h3 id=\"1-1-安装OGG软件-源端-目标端\"><a href=\"#1-1-安装OGG软件-源端-目标端\" class=\"headerlink\" title=\"1.1 安装OGG软件(源端-目标端)\"></a>1.1 安装OGG软件(源端-目标端)</h3><pre class=\" language-sql\"><code class=\"language-sql\">\n</code></pre>\n<h3 id=\"1-2-创建OGG用户-源端-目标端\"><a href=\"#1-2-创建OGG用户-源端-目标端\" class=\"headerlink\" title=\"1.2 创建OGG用户(源端-目标端)\"></a>1.2 创建OGG用户(源端-目标端)</h3><ul>\n<li>源端</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLESPACE</span> ogg_tbs\n    DATAFILE <span class=\"token string\">'/u01/oradata/orcl/ogg_tbs.dbf'</span>\n        SIZE <span class=\"token number\">100</span> M\n        AUTOEXTEND <span class=\"token keyword\">ON</span> <span class=\"token keyword\">NEXT</span> <span class=\"token number\">10</span> M MAXSIZE <span class=\"token number\">500</span> M\n    LOGGING\n    EXTENT MANAGEMENT <span class=\"token keyword\">LOCAL</span>\n    SEGMENT SPACE MANAGEMENT AUTO<span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> goldengate IDENTIFIED <span class=\"token keyword\">BY</span> goldengate <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">TABLESPACE</span> ogg_tbs <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">temp</span> QUOTA UNLIMITED <span class=\"token keyword\">ON</span> users<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CONNECT</span><span class=\"token punctuation\">,</span>RESOURCE <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">LOCK</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ANY</span> DICTIONARY <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> FLASHBACK <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> UNLIMITED <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">EXECUTE</span> <span class=\"token keyword\">on</span> DBMS_FLASHBACK <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">EXECUTE</span> <span class=\"token keyword\">on</span> DBMS_GOLDENGATE_AUTH <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> DBA <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">EXEC</span> dbms_goldengate_auth<span class=\"token punctuation\">.</span>grant_admin_privilege<span class=\"token punctuation\">(</span><span class=\"token string\">'GOLDENGATE'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<ul>\n<li>目标端</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLESPACE</span> ogg_tbs\n        DATAFILE <span class=\"token string\">'/u01/oradata/itpux/ogg_tbs.dbf'</span>\n        SIZE <span class=\"token number\">100</span> M\n    AUTOEXTEND <span class=\"token keyword\">ON</span> <span class=\"token keyword\">NEXT</span> <span class=\"token number\">10</span> M MAXSIZE <span class=\"token number\">500</span> M\n    LOGGING\n    EXTENT MANAGEMENT <span class=\"token keyword\">LOCAL</span>\n    SEGMENT SPACE MANAGEMENT AUTO<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> goldengate IDENTIFIED <span class=\"token keyword\">BY</span> goldengate <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">TABLESPACE</span> ogg_tbs <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">temp</span> QUOTA UNLIMITED <span class=\"token keyword\">ON</span> users<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CONNECT</span><span class=\"token punctuation\">,</span>RESOURCE <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">LOCK</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ANY</span> DICTIONARY <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> FLASHBACK <span class=\"token keyword\">ANY</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> UNLIMITED <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">EXECUTE</span> <span class=\"token keyword\">on</span> DBMS_FLASHBACK <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">EXECUTE</span> <span class=\"token keyword\">on</span> DBMS_GOLDENGATE_AUTH <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> DBA <span class=\"token keyword\">TO</span> GOLDENGATE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">EXEC</span> dbms_goldengate_auth<span class=\"token punctuation\">.</span>grant_admin_privilege<span class=\"token punctuation\">(</span><span class=\"token string\">'GOLDENGATE'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h3 id=\"1-3-创建测试用户-源端-目标端\"><a href=\"#1-3-创建测试用户-源端-目标端\" class=\"headerlink\" title=\"1.3 创建测试用户(源端-目标端)\"></a>1.3 创建测试用户(源端-目标端)</h3><ul>\n<li>源端</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span>  <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"KYLE\"</span>\n    DATAFILE <span class=\"token string\">'/u01/app/oracle/oradata/orcl/kyle01.dbf'</span>\n        SIZE <span class=\"token number\">100</span> M\n        AUTOEXTEND <span class=\"token keyword\">ON</span> <span class=\"token keyword\">NEXT</span> <span class=\"token number\">10</span> M MAXSIZE <span class=\"token number\">500</span> M\n    LOGGING\n    EXTENT MANAGEMENT <span class=\"token keyword\">LOCAL</span>\n    SEGMENT SPACE MANAGEMENT AUTO<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token string\">\"KYLE\"</span>\n    PROFILE <span class=\"token string\">\"DEFAULT\"</span> \n    IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">\"kyle\"</span> \n    <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"KYLE\"</span> \n    <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"TEMP\"</span> \n    ACCOUNT UNLOCK<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--测试数据</span>\n<span class=\"token keyword\">SELECT</span> table_name <span class=\"token keyword\">FROM</span> user_tables<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> SEQUENCE seq_kyle <span class=\"token keyword\">START</span> <span class=\"token keyword\">WITH</span> <span class=\"token number\">1</span> INCREMENT <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> kyle01 <span class=\"token punctuation\">(</span>id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> rand <span class=\"token keyword\">INT</span> <span class=\"token punctuation\">,</span> name VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> kyle02 <span class=\"token punctuation\">(</span>id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> rand <span class=\"token keyword\">INT</span> <span class=\"token punctuation\">,</span> name VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> kyle03 <span class=\"token punctuation\">(</span>id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> rand <span class=\"token keyword\">INT</span> <span class=\"token punctuation\">,</span> name VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> kyle01 <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Kyle01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> kyle01 <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Kyle02'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> kyle01 <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Kyle03'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> kyle01 <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Kyle04'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DECLARE</span>\n  rnd number<span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">BEGIN</span>\n   <span class=\"token keyword\">for</span> i <span class=\"token operator\">in</span> <span class=\"token number\">1</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token number\">20000</span> loop\n     <span class=\"token keyword\">IF</span> MOD<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span>\n         <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">ELSE</span>\n         <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> kyle03 <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span>seq_kyle<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span>i<span class=\"token operator\">*</span>dbms_random<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Kyle Is Testing'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">END</span> LOOP<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n\n<span class=\"token keyword\">BEGIN</span>\n   LOOP\n    <span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> kyle03 <span class=\"token keyword\">where</span> rownum<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> kyle03 <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span>seq_kyle<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span><span class=\"token number\">200000</span><span class=\"token operator\">*</span>dbms_random<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'MACLEAN IS UPDATING'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> kyle03 <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span>seq_kyle<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span><span class=\"token number\">300000</span><span class=\"token operator\">*</span>dbms_random<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'MACLEAN IS UPDATING'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">update</span> kyle03 <span class=\"token keyword\">set</span> rand<span class=\"token operator\">=</span>rand<span class=\"token operator\">+</span><span class=\"token number\">10</span> <span class=\"token keyword\">where</span> rownum<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n     dbms_lock<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">END</span> loop<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">/</span>\n\n\n</code></pre>\n<ul>\n<li>目标端</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span>  <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"KYLE\"</span>\n    DATAFILE <span class=\"token string\">'/u01/oradata/itpux/kyle01.dbf'</span>\n        SIZE <span class=\"token number\">100</span> M\n        AUTOEXTEND <span class=\"token keyword\">ON</span> <span class=\"token keyword\">NEXT</span> <span class=\"token number\">10</span> M MAXSIZE <span class=\"token number\">500</span> M\n    LOGGING\n    EXTENT MANAGEMENT <span class=\"token keyword\">LOCAL</span>\n    SEGMENT SPACE MANAGEMENT AUTO<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token string\">\"KYLE\"</span>\n    PROFILE <span class=\"token string\">\"DEFAULT\"</span> \n    IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">\"kyle\"</span> \n    <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"KYLE\"</span> \n    <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token string\">\"TEMP\"</span> \n    ACCOUNT UNLOCK<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"1-4-数据导入导出\"><a href=\"#1-4-数据导入导出\" class=\"headerlink\" title=\"1.4 数据导入导出\"></a>1.4 数据导入导出</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> directory bakdir <span class=\"token keyword\">as</span> <span class=\"token string\">'/home/oracle'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">read</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">write</span> <span class=\"token keyword\">on</span> directory bakdir <span class=\"token keyword\">to</span> system<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">any</span> directory <span class=\"token keyword\">to</span> system<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--导出结构</span>\n<span class=\"token keyword\">CREATE</span> DIRECTORY BAKDIR <span class=\"token keyword\">AS</span> <span class=\"token string\">'/home/oracle'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">READ</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">WRITE</span> <span class=\"token keyword\">ON</span> DIRECTORY BAKDIR <span class=\"token keyword\">TO</span> SYSTEM<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">ANY</span> DIRECTORY <span class=\"token keyword\">TO</span> SYSTEM<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--导出某个或多个schema</span>\nexpdp system<span class=\"token operator\">/</span>jia  DIRECTORY<span class=\"token operator\">=</span>bakdir <span class=\"token keyword\">DUMPFILE</span><span class=\"token operator\">=</span>expdp_schema_kyle<span class=\"token punctuation\">.</span>dmp LOGFILE<span class=\"token operator\">=</span>expdp_schema_kyle<span class=\"token punctuation\">.</span>log SCHEMAS<span class=\"token operator\">=</span>kyle\nimpdp system<span class=\"token operator\">/</span>jia  DIRECTORY<span class=\"token operator\">=</span>bakdir <span class=\"token keyword\">DUMPFILE</span><span class=\"token operator\">=</span>expdp_schema_kyle<span class=\"token punctuation\">.</span>dmp LOGFILE<span class=\"token operator\">=</span>expdp_schema_kyle<span class=\"token punctuation\">.</span>log TABLE_EXISTS_ACTION<span class=\"token operator\">=</span><span class=\"token keyword\">truncate</span> SCHEMAS<span class=\"token operator\">=</span>kyle\nscp <span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>expdp_schema_kyle<span class=\"token punctuation\">.</span>dmp orcl<span class=\"token number\">-122</span>:<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>\n</code></pre>\n<h3 id=\"1-5-配置环境变量\"><a href=\"#1-5-配置环境变量\" class=\"headerlink\" title=\"1.5 配置环境变量\"></a>1.5 配置环境变量</h3><pre class=\" language-sql\"><code class=\"language-sql\">alias sqlplus<span class=\"token operator\">=</span><span class=\"token string\">\"rlwrap sqlplus\"</span>\nalias ggsci<span class=\"token operator\">=</span><span class=\"token string\">\"rlwrap ggsci\"</span>\nalias rman<span class=\"token operator\">=</span><span class=\"token string\">\"rlwrap rman\"</span>\nalias asmcmd<span class=\"token operator\">=</span><span class=\"token string\">\"rlwrap asmcmd\"</span>\n\nLD_LIBRARY_PATH<span class=\"token operator\">=</span>$ORACLE_HOME<span class=\"token operator\">/</span>lib:<span class=\"token operator\">/</span>lib:<span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>lib<span class=\"token punctuation\">;</span> export LD_LIBRARY_PATH\nCLASSPATH<span class=\"token operator\">=</span><span class=\"token operator\">/</span>ggs:$ORACLE_HOME<span class=\"token operator\">/</span>JRE:$ORACLE_HOME<span class=\"token operator\">/</span>jlib:$ORACLE_HOME<span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>jlib<span class=\"token punctuation\">;</span> export CLASSPATH\nOGG_PATH<span class=\"token operator\">=</span><span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>ggs export OGG_PATH\nPATH<span class=\"token operator\">=</span><span class=\"token punctuation\">.</span>:$PATH:$OGG_PATH:$HOME<span class=\"token operator\">/</span>bin:$ORACLE_BASE<span class=\"token operator\">/</span>product<span class=\"token operator\">/</span><span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token operator\">/</span>db_1<span class=\"token operator\">/</span>bin:$ORACLE_HOME<span class=\"token operator\">/</span>bin<span class=\"token punctuation\">;</span> export PATH\n</code></pre>\n<h3 id=\"1-6-修改系统参数开启归档\"><a href=\"#1-6-修改系统参数开启归档\" class=\"headerlink\" title=\"1.6 修改系统参数开启归档\"></a>1.6 修改系统参数开启归档</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> ENABLE_GOLDENGATE_REPLICATION <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span> SCOPE<span class=\"token operator\">=</span>BOTH<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> supplemental log <span class=\"token keyword\">data</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">force</span> logging<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"1-7-配置OGG-源端\"><a href=\"#1-7-配置OGG-源端\" class=\"headerlink\" title=\"1.7 配置OGG(源端)\"></a>1.7 配置OGG(源端)</h3><ul>\n<li>1.创建目录</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> subdirs\n</code></pre>\n<ul>\n<li>2.配置MGR</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">GGSCI<span class=\"token operator\">></span>\nEDIT PARAMS mgr\nPORT <span class=\"token number\">7809</span>\nAUTOSTART ER <span class=\"token operator\">*</span> \nAUTORESTART ER <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> RETRIES <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> WAITMINUTES <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> RESETMINUTES <span class=\"token number\">15</span>\nPURGEOLDEXTRACTS <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token comment\" spellcheck=\"true\">/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/</span>\n<span class=\"token comment\" spellcheck=\"true\">--端口 7809</span>\n<span class=\"token comment\" spellcheck=\"true\">--自动启动 ER(EXTARCT REPLACT)</span>\n\n</code></pre>\n<ul>\n<li>3.配置检查点</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--GLOBALS储存了运行的一些信息</span>\nGGSCI<span class=\"token operator\">></span> EDIT PARAMS <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>GLOBALS\nCHECKPOINTTABLE goldengate<span class=\"token punctuation\">.</span><span class=\"token keyword\">checkpoint</span>\nGGSCI<span class=\"token operator\">></span> dblogin userid goldengate<span class=\"token punctuation\">,</span>password goldengate\nGGSCI<span class=\"token operator\">></span> <span class=\"token keyword\">ADD</span> CHECKPOINTTABLE goldengate<span class=\"token punctuation\">.</span><span class=\"token keyword\">checkpoint</span>\n</code></pre>\n<ul>\n<li>4.添加补充日志</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--ADD TRANDATA itpux.*</span>\n<span class=\"token keyword\">ADD</span> SCHEMATRANDATA kyle\n<span class=\"token comment\" spellcheck=\"true\">--配置ddl 的时候，一定要用ADD SCHEMATRANDATA</span>\n<span class=\"token comment\" spellcheck=\"true\">--如果不用ddl,可以用ADD TRANDATA</span>\ninfo SCHEMATRANDATA kyle\n</code></pre>\n<ul>\n<li>5.配置extract进程</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--建立EXTRACT目录</span>\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>rkyle\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>rkyle\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>ekyle\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>ekyle\n\nGGSCI<span class=\"token operator\">></span>\nEDIT PARAMS ekyle\n\nsetenv<span class=\"token punctuation\">(</span>NLS_LANG<span class=\"token operator\">=</span><span class=\"token string\">\"AMERICAN_AMERICA.ZHS16GBK\"</span><span class=\"token punctuation\">)</span>\nsetenv<span class=\"token punctuation\">(</span>ORACLE_SID<span class=\"token operator\">=</span><span class=\"token string\">\"itpux\"</span><span class=\"token punctuation\">)</span>\nEXTRACT ekyle\nDDL INCLUDE <span class=\"token keyword\">ALL</span>\nDDLOPTIONS ADDTRANDATA<span class=\"token punctuation\">,</span>REPORT\nUSERID goldengate<span class=\"token punctuation\">,</span> PASSWORD goldengate\nEXTTRAIL <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>ekyle<span class=\"token operator\">/</span>ex\nTRANLOGOPTIONS excludeuser goldengate\nTRANLOGOPTIONS convertucs2clobs\nWARNLONGTRANS 12h<span class=\"token punctuation\">,</span>CHECKINTERVAL 30m\nDISCARDFILE <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>ekyle<span class=\"token operator\">/</span>ekyle<span class=\"token punctuation\">.</span>dsc<span class=\"token punctuation\">,</span> APPEND<span class=\"token punctuation\">,</span> MEGABYTES <span class=\"token number\">200</span>\n<span class=\"token keyword\">TABLE</span> kyle<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--设置语言</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置SID</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置EXTRACT名称不能操作过8个字符</span>\n<span class=\"token comment\" spellcheck=\"true\">--抽取所有的DDL操作</span>\n<span class=\"token comment\" spellcheck=\"true\">--</span>\n<span class=\"token comment\" spellcheck=\"true\">--定义OGG使用用户</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置抽取目录</span>\n<span class=\"token comment\" spellcheck=\"true\">--排除用于管理抽取的OGG用户</span>\n<span class=\"token comment\" spellcheck=\"true\">--某某参数，可以传输大字段</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置告警阈值</span>\n<span class=\"token comment\" spellcheck=\"true\">--配置文件存放位置</span>\n<span class=\"token comment\" spellcheck=\"true\">--抽取的表</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--添加一个抽取进程</span>\n<span class=\"token comment\" spellcheck=\"true\">--THREADS 2表示源端有2个RAC节点</span>\n<span class=\"token keyword\">ADD</span> EXTRACT ekyle<span class=\"token punctuation\">,</span> TRANLOG<span class=\"token punctuation\">,</span> <span class=\"token keyword\">BEGIN</span> NOW\n<span class=\"token keyword\">ADD</span> EXTRACT ekyle<span class=\"token punctuation\">,</span> TRANLOG<span class=\"token punctuation\">,</span> <span class=\"token keyword\">BEGIN</span> NOW<span class=\"token punctuation\">,</span> THREADS <span class=\"token number\">2</span>\n<span class=\"token comment\" spellcheck=\"true\">--添加一个队列文件</span>\nGGSCI<span class=\"token operator\">></span>\n<span class=\"token keyword\">ADD</span> EXTTRAIL <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>ekyle<span class=\"token operator\">/</span>ex<span class=\"token punctuation\">,</span> EXTRACT ekyle<span class=\"token punctuation\">,</span> MEGABYTES <span class=\"token number\">200</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--启动停止测试</span>\nGGSCI<span class=\"token operator\">></span>\n<span class=\"token keyword\">START</span> ekyle\nSTOP ekyle\n<span class=\"token keyword\">VIEW</span> REPORT ekyle\n</code></pre>\n<ul>\n<li>6.配置PUMP进程</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">cd</span> <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>ggs\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>ekyle\nmkdir <span class=\"token operator\">-</span>p <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>ekyle\n\nGGSCI<span class=\"token operator\">></span>\nEDIT PARAMS pkyle\n\nsetenv<span class=\"token punctuation\">(</span>NLS_LANG<span class=\"token operator\">=</span><span class=\"token string\">\"AMERICAN_AMERICA.ZHS16GBK\"</span><span class=\"token punctuation\">)</span>\nsetenv<span class=\"token punctuation\">(</span>ORACLE_SID<span class=\"token operator\">=</span><span class=\"token string\">\"orcl\"</span><span class=\"token punctuation\">)</span>\nEXTRACT pkyle\nUSERID goldengate<span class=\"token punctuation\">,</span>PASSWORD goldengate\nPASSTHRU                        \nRMTHOST <span class=\"token number\">172.17</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.122</span><span class=\"token punctuation\">,</span>MGRPORT <span class=\"token number\">7809</span>\nRMTTRAIL <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>rkyle<span class=\"token operator\">/</span>re\nDISCARDFILE <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>rkyle<span class=\"token operator\">/</span>rkyle<span class=\"token punctuation\">.</span>dsc<span class=\"token punctuation\">,</span> APPEND<span class=\"token punctuation\">,</span> MEGABYTES <span class=\"token number\">200</span>\n<span class=\"token keyword\">TABLE</span> ekyle<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--</span>\n<span class=\"token comment\" spellcheck=\"true\">--</span>\n<span class=\"token comment\" spellcheck=\"true\">--</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 禁止extract与数据库交互，适合于PUMP传输进程</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 远端的IP,端口</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 指定写入到远程目标端的哪个队列</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 指定报错输出文件</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 指定传输表</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">--增加pump 进程(指定本地trail 文件)</span>\nGGSCI<span class=\"token operator\">></span>\n<span class=\"token keyword\">ADD</span> EXTRACT pkyle<span class=\"token punctuation\">,</span>EXTTRAILSOURCE <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>ekyle<span class=\"token operator\">/</span>ex\n\n<span class=\"token comment\" spellcheck=\"true\">--增加rmttail 文件</span>\nGGSCI<span class=\"token operator\">></span>\n<span class=\"token keyword\">ADD</span> RMTTRAIL <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>rkyle<span class=\"token operator\">/</span>re<span class=\"token punctuation\">,</span> EXTRACT pkyle<span class=\"token punctuation\">,</span> MEGABYTES <span class=\"token number\">200</span>\n<span class=\"token comment\" spellcheck=\"true\">--检查:</span>\nGGSCI<span class=\"token operator\">></span>\nINFO  pkyle\n</code></pre>\n<h3 id=\"1-8-配置OGG-目标端\"><a href=\"#1-8-配置OGG-目标端\" class=\"headerlink\" title=\"1.8 配置OGG(目标端)\"></a>1.8 配置OGG(目标端)</h3><ul>\n<li>1.配置mgr</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">GGSCI<span class=\"token operator\">></span> EDIT PARAMS MGR\nPORT <span class=\"token number\">7809</span>\nAUTOSTART ER <span class=\"token operator\">*</span> \nAUTORESTART ER <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> RETRIES <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> WAITMINUTES <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> RESETMINUTES <span class=\"token number\">15</span>\nPURGEOLDEXTRACTS <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token comment\" spellcheck=\"true\">/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/</span>\nGGSCI<span class=\"token operator\">></span>\n<span class=\"token keyword\">START</span> MGR\nSTOP MGR\n</code></pre>\n<ul>\n<li>2.配置检查点</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">GGSCI<span class=\"token operator\">></span> EDIT PARAMS <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>GLOBALS\nCHECKPOINTTABLE goldengate<span class=\"token punctuation\">.</span><span class=\"token keyword\">checkpoint</span>\nGGSCI<span class=\"token operator\">></span> dblogin userid goldengate<span class=\"token punctuation\">,</span>password goldengate\nGGSCI<span class=\"token operator\">></span> <span class=\"token keyword\">ADD</span> CHECKPOINTTABLE goldengate<span class=\"token punctuation\">.</span><span class=\"token keyword\">checkpoint</span>\n</code></pre>\n<ul>\n<li>3.配置replicat进程<br><code>`</code>sql<br>cd /u01/ggs<br>mkdir -p ./dirdat/rkyle<br>mkdir -p ./dirrpt/rkyle</li>\n</ul>\n<p>ggsci&gt; edit params rkyle</p>\n<p>setenv(NLS_LANG=”AMERICAN_AMERICA.ZHS16GBK”)<br>setenv(ORACLE_SID=”itpux”)<br>REPLICAT rkyle<br>USERID goldengate,PASSWORD goldengate<br>handlecollisions<br>assumetargetdefs<br>DISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200<br>MAP kyle.<em>, target kyle.</em>;</p>\n<p>–添加replicat 进程<br>GGSCI&gt;<br>ADD REPLICAT rkyle EXTTRAIL ./dirdat/rkyle/re, CHECKPOINTTABLE goldengate.checkpoint<br>–启动相关进程(目标)<br>GGSCI&gt;<br>START rkyle<br>VIEW REPORT rkyle<br>INFO ALL<br>–启动相关进程(源端)<br>GGSCI&gt;<br>START rkyle<br>START pkyle<br>VIEW REPORT rkyle<br>VIEW REPORT pkyle<br>INFO ALL</p>\n<pre><code>\n### 1.9 disable 目标库所有的trigger、cascading delete、check、job\n```sql\nSET PAGESIZE 2000\nSET LINESIZE 100\n--Foreign key Constraints/Cascading Deletes\nSELECT    &#39;alter table &#39;\n       || owner\n       || &#39;.&#39;\n       || table_name\n       || &#39; DISABLE CONSTRAINT &#39;\n       || constraint_name\n       || &#39;;&#39;\n  FROM dba_constraints\n WHERE     constraint_type = &#39;R&#39;\n       AND delete_rule = &#39;CASCADE&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n\n--查找生成并disable 约束(Check)：\nSELECT    &#39;alter table &#39;\n       || owner\n       || &#39;.&#39;\n       || table_name\n       || &#39; DISABLE CONSTRAINT &#39;\n       || constraint_name\n       || &#39;;&#39;\n  FROM dba_constraints\n WHERE     constraint_type = &#39;C&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n--查找生成并disable trigger：\nSELECT &#39;alter trigger &#39; || owner || &#39;.&#39; || object_name || &#39; disable;&#39;\n  FROM dba_objects\n WHERE     object_type = &#39;TRIGGER&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n\n--查找并disable job\nSELECT job,\n       next_date,\n       next_sec,\n       failures,\n       broken\n  FROM dba_jobs\n WHERE SCHEMA_USER IN (&#39;KYLE&#39;,\n                       &#39;KYLE01&#39;);\n\nBEGIN\n    sys.DBMS_JOB.broken (job =&gt; 21, broken =&gt; TRUE);\n    COMMIT;\nEND;\n\n\n--生成结果如下，然后在目标数据库中执行：\nalter table ... DISABLE CONSTRAINT SYS_C0017353;\nalter table ... DISABLE CONSTRAINT SYS_C0017355;…\n…\nalter trigger ... disable;\nalter trigger ... disable;\nalter trigger ... disable;\n--确认外键已经被禁用\nSELECT OWNER,\n       CONSTRAINT_NAME,\n       CONSTRAINT_TYPE,\n       STATUS\n  FROM dba_CONSTRAINTS\n WHERE     CONSTRAINT_TYPE = &#39;R&#39;\n       AND status = &#39;ENABLED&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n--确认目标端目标表的主键可用:\nSELECT T1.STATUS,\n       T1.VALIDATED,\n       T2.status,\n       T1.constraint_name,\n       T1.owner\n  FROM dba_constraints T1, dba_objects T2\n WHERE     T2.OBJECT_NAME = T1.constraint_name\n       AND T1.OWNER IN (&#39;KYLE&#39;,\n                        &#39;KYLE01&#39;);\n\n--验证job 确实被禁用\nSELECT job,\n       LOG_USER,\n       PRIV_USER,\n       SCHEMA_USER,\n       broken\n  FROM dba_jobs\n WHERE schema_user IN (&#39;KYLE&#39;,\n                       &#39;KYLE01&#39;);\n\nSELECT OWNER, JOB_NAME, STATE\n  FROM DBA_SCHEDULER_JOBS\n WHERE OWNER IN (&#39;KYLE&#39;,\n                 &#39;KYLE01&#39;);\n\n--确认trigger 已经全部关闭\nSELECT DISTINCT status\n  FROM dba_triggers\n WHERE owner IN (&#39;KYLE&#39;,\n                 &#39;KYLE01&#39;);\n</code></pre><h2 id=\"2-添加DDL功能与加密\"><a href=\"#2-添加DDL功能与加密\" class=\"headerlink\" title=\"2,.添加DDL功能与加密\"></a>2,.添加DDL功能与加密</h2><h3 id=\"2-1-添加DDL功能\"><a href=\"#2-1-添加DDL功能\" class=\"headerlink\" title=\"2.1 添加DDL功能\"></a>2.1 添加DDL功能</h3><ul>\n<li>1.关闭所有OGG进程</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">STOP ekyle\nSTOP pkyle\nSTOP rkyle\n</code></pre>\n<ul>\n<li>2.用户的默认表空间不能自动SYSTEM表空间</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">set</span> PAGRSIZE <span class=\"token number\">200</span>\n<span class=\"token keyword\">set</span> LINESIZE <span class=\"token number\">200</span>\ncol USERNAME format A20\ncol DEFAULT_TABLESPACE format A20 \n\n<span class=\"token keyword\">SELECT</span> username<span class=\"token punctuation\">,</span> default_tablespace <span class=\"token keyword\">FROM</span> dba_users<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>3.关闭回收站并清空回收站</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--11G可以启动回收站，10G必须关闭回收站</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> recyclebin <span class=\"token operator\">=</span> <span class=\"token keyword\">off</span> SCOPE <span class=\"token operator\">=</span> SPFILE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">PURGE</span> DBA_RECYCLEBIN<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>4.指明支持DDL的对象放在那个SCHEMA下载</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">ggsci<span class=\"token operator\">></span> edit params <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>GLOBALS\nGGSCHEMA goldengate\n</code></pre>\n<ul>\n<li>5.添加相关权限</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">EXECUTE</span> <span class=\"token keyword\">ON</span> UTL_FILE <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> RESTRICTED <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">CREATE</span> SEQUENCE <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> GGS_GGSUSER_ROLE <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>6.执行脚本（源目标）</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">cd</span> <span class=\"token operator\">/</span>ggs\nsqlplus <span class=\"token string\">\"/as sysdba\"</span>\n<span class=\"token variable\">@marker_setup.sql</span>\n<span class=\"token variable\">@ddl_setup.sql</span>\n<span class=\"token variable\">@role_setup.sql</span>\n<span class=\"token keyword\">GRANT</span> GGS_GGSUSER_ROLE <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@ddl_enable.sql</span>\n<span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmspool<span class=\"token punctuation\">.</span>sql\n<span class=\"token variable\">@ddl_pin.sql</span> goldengate\n</code></pre>\n<ul>\n<li>7.修改参数，增加DDL复制参数</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">ggsci <span class=\"token operator\">></span>edit params eitpux01\n<span class=\"token comment\" spellcheck=\"true\">--DDL INCLUDE OBJNAME \"ITPUX01.*\"</span>\nDDL INCLUDE <span class=\"token keyword\">ALL</span>\nDDLOPTIONS ADDTRANDATA<span class=\"token punctuation\">,</span>REPORT\n\nggsci <span class=\"token operator\">></span>edit params ritpux01\n<span class=\"token comment\" spellcheck=\"true\">--DDL INCLUDE OBJNAME \"ITPUX01.*\"</span>\nDDL INCLUDE <span class=\"token keyword\">ALL</span>\nDDLERROR <span class=\"token keyword\">default</span> <span class=\"token keyword\">ignore</span> retryop\n</code></pre>\n<ul>\n<li>8.启动进程</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">START</span> ekyle\n<span class=\"token keyword\">START</span> pkyle\n<span class=\"token keyword\">START</span> ryle\n</code></pre>\n<ul>\n<li>DDL其他功能</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--开启</span>\nddl_enable<span class=\"token punctuation\">.</span>sql\n<span class=\"token comment\" spellcheck=\"true\">--关闭</span>\nddl_disable<span class=\"token punctuation\">.</span>sql\n\n<span class=\"token comment\" spellcheck=\"true\">--清空DDL trace ggs_ddl_trace.log</span>\nddl_cleartrace<span class=\"token punctuation\">.</span>sql\n\n<span class=\"token comment\" spellcheck=\"true\">--ddl 参数：</span>\noptype alert\nobjtype <span class=\"token string\">\"table\"</span>\nojbname <span class=\"token string\">\"user.tab*\"</span>\ninclude mapped object <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">;</span>\nexclude mapped object <span class=\"token string\">\"itpux.itux*\"</span>\nDDL 环境重配（删除就是<span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">5</span>，<span class=\"token number\">12</span>，去掉参数中的DDL）:\n<span class=\"token number\">1</span><span class=\"token punctuation\">.</span>停止所有的OGG ex<span class=\"token operator\">/</span>pump<span class=\"token operator\">/</span>rp 进程\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@ddl_disable.sql</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@ddl_remove.sql</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@marker_remove.sql</span>\n<span class=\"token number\">5</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@marker_setup.sql</span>\n<span class=\"token number\">6</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@ddl_setup.sql</span>\n<span class=\"token number\">7</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@role_setup.sql</span>\n<span class=\"token number\">8</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">GRANT</span> GGS_GGSUSER_ROLE <span class=\"token keyword\">TO</span> goldengate<span class=\"token punctuation\">;</span>\n<span class=\"token number\">9</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@ddl_enable.sql</span>\n<span class=\"token number\">10</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmspool<span class=\"token punctuation\">.</span>sql\n<span class=\"token number\">11</span><span class=\"token punctuation\">.</span><span class=\"token variable\">@ddl_pin.sql</span> goldengate\n<span class=\"token number\">12</span><span class=\"token punctuation\">.</span>运行所有的OGG ex<span class=\"token operator\">/</span>pump<span class=\"token operator\">/</span>rp 进程\n</code></pre>\n<h3 id=\"2-2-加密\"><a href=\"#2-2-加密\" class=\"headerlink\" title=\"2.2 加密\"></a>2.2 加密</h3><ul>\n<li>1.生成加密的KEY </li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">[</span>oracle<span class=\"token variable\">@orcl</span>:<span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>ggs<span class=\"token punctuation\">]</span>$keygen <span class=\"token number\">256</span> <span class=\"token number\">1</span>\n0x1673D6197E05DA1009B1451420A73134BDF868246D6AC878FBFC69193231C355\n</code></pre>\n<ul>\n<li>2.将KEY存到本地指定文件</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">[</span>oracle<span class=\"token variable\">@orcl</span>:<span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>ggs<span class=\"token punctuation\">]</span>$cat ENCKEYS \nKYLE_KEY 0xE9E07156ACC2411F97E78D117B55C444E935E27A034CBD389CF2F432F8B5F417\n</code></pre>\n<ul>\n<li>3.设置登录用的的KEY</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">\nGGSCI <span class=\"token punctuation\">(</span>orcl<span class=\"token punctuation\">)</span> <span class=\"token number\">109</span><span class=\"token operator\">></span> ENCRYPT PASSWORD goldengate AES256 ENCRYPTKEY KYLE_KEY\nEncrypted password:  AADAAAAAAAAAAAKABIXBCASDGBHCGFNGMHJIFFMDXFGBRCLHTGJGVIECPCGEUAJEXDSEFBUCGATGKGUGBGCCVFKBBENDYBSAPDZBACQCQILIRHYH\n<span class=\"token keyword\">Algorithm</span> used:  AES256\n</code></pre>\n<ul>\n<li>添加KEY到相应文件</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">extract eitpux01\nDDL INCLUDE <span class=\"token keyword\">ALL</span>\nDDLOPTIONS ADDTRANDATA<span class=\"token punctuation\">,</span>REPORT\nuserid goldengate<span class=\"token punctuation\">,</span>password AADAAAAAAAAAAAKACAHHWIRDTBQDNBUJYFUCXCGEVBCDHBCEGFOIQFSEGFKCBGLDPGUGAIIHZDJATJSJYBPBSJSJUFSBJCUBYCXBFBPJPDSBVGBJ<span class=\"token punctuation\">,</span>AES256<span class=\"token punctuation\">,</span>ENCRYPTKEY KYLE_KEY\nexttrail <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirdat<span class=\"token operator\">/</span>eitpux01<span class=\"token operator\">/</span>ex\ntranlogoptions excludeuser goldengate\ntranlogoptions convertucs2clobs\nwarnlongtrans 12h<span class=\"token punctuation\">,</span>checkinterval 30m\ndiscardfile <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>dirrpt<span class=\"token operator\">/</span>eitpux01<span class=\"token operator\">/</span>eitpux01<span class=\"token punctuation\">.</span>dsc<span class=\"token punctuation\">,</span>append<span class=\"token punctuation\">,</span>megabytes <span class=\"token number\">200</span>\n<span class=\"token keyword\">TABLE</span> itpux<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--TABLE itpux01.*;</span>\n<span class=\"token comment\" spellcheck=\"true\">--TABLE itpux02.*;</span>\n<span class=\"token comment\" spellcheck=\"true\">--TABLE itpux03.*;</span>\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"OracleGoldengate数据库复制与容灾实施\"><a href=\"#OracleGoldengate数据库复制与容灾实施\" class=\"headerlink\" title=\"OracleGoldengate数据库复制与容灾实施\"></a>OracleGoldengate数据库复制与容灾实施</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-GoldenGate-文件系统-文件系统\"><a href=\"#1-GoldenGate-文件系统-文件系统\" class=\"headerlink\" title=\"1.GoldenGate 文件系统-文件系统\"></a>1.GoldenGate 文件系统-文件系统</h2><h3 id=\"1-1-安装OGG软件-源端-目标端\"><a href=\"#1-1-安装OGG软件-源端-目标端\" class=\"headerlink\" title=\"1.1 安装OGG软件(源端-目标端)\"></a>1.1 安装OGG软件(源端-目标端)</h3><pre><code class=\"sql\">\n</code></pre>\n<h3 id=\"1-2-创建OGG用户-源端-目标端\"><a href=\"#1-2-创建OGG用户-源端-目标端\" class=\"headerlink\" title=\"1.2 创建OGG用户(源端-目标端)\"></a>1.2 创建OGG用户(源端-目标端)</h3><ul>\n<li>源端</li>\n</ul>\n<pre><code class=\"sql\">CREATE TABLESPACE ogg_tbs\n    DATAFILE &#39;/u01/oradata/orcl/ogg_tbs.dbf&#39;\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege(&#39;GOLDENGATE&#39;,&#39;*&#39;,TRUE)\n</code></pre>\n<ul>\n<li>目标端</li>\n</ul>\n<pre><code class=\"sql\">CREATE TABLESPACE ogg_tbs\n        DATAFILE &#39;/u01/oradata/itpux/ogg_tbs.dbf&#39;\n        SIZE 100 M\n    AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER goldengate IDENTIFIED BY goldengate DEFAULT TABLESPACE ogg_tbs TEMPORARY TABLESPACE temp QUOTA UNLIMITED ON users;\n\nGRANT CONNECT,RESOURCE TO GOLDENGATE;\nGRANT CREATE SESSION TO GOLDENGATE;\nGRANT ALTER SESSION TO GOLDENGATE;\nGRANT ALTER ANY TABLE TO GOLDENGATE;\nGRANT ALTER SYSTEM TO GOLDENGATE;\nGRANT CREATE TABLE TO GOLDENGATE;\nGRANT INSERT ANY TABLE,UPDATE ANY TABLE,DELETE ANY TABLE,LOCK ANY TABLE TO GOLDENGATE;\nGRANT SELECT ANY TRANSACTION TO GOLDENGATE;\nGRANT SELECT ANY DICTIONARY TO GOLDENGATE;\nGRANT FLASHBACK ANY TABLE TO GOLDENGATE;\nGRANT UNLIMITED TABLESPACE TO GOLDENGATE;\nGRANT EXECUTE on DBMS_FLASHBACK TO GOLDENGATE;\nGRANT EXECUTE on DBMS_GOLDENGATE_AUTH TO GOLDENGATE;\nGRANT DBA TO GOLDENGATE;\nEXEC dbms_goldengate_auth.grant_admin_privilege(&#39;GOLDENGATE&#39;,&#39;*&#39;,TRUE)\n</code></pre>\n<h3 id=\"1-3-创建测试用户-源端-目标端\"><a href=\"#1-3-创建测试用户-源端-目标端\" class=\"headerlink\" title=\"1.3 创建测试用户(源端-目标端)\"></a>1.3 创建测试用户(源端-目标端)</h3><ul>\n<li>源端</li>\n</ul>\n<pre><code class=\"sql\">CREATE  TABLESPACE &quot;KYLE&quot;\n    DATAFILE &#39;/u01/app/oracle/oradata/orcl/kyle01.dbf&#39;\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER &quot;KYLE&quot;\n    PROFILE &quot;DEFAULT&quot; \n    IDENTIFIED BY &quot;kyle&quot; \n    DEFAULT TABLESPACE &quot;KYLE&quot; \n    TEMPORARY TABLESPACE &quot;TEMP&quot; \n    ACCOUNT UNLOCK;\n\n--测试数据\nSELECT table_name FROM user_tables;\n\nCREATE SEQUENCE seq_kyle START WITH 1 INCREMENT BY 1;\nCREATE TABLE kyle01 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle02 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\nCREATE TABLE kyle03 (id INT PRIMARY KEY, rand INT , name VARCHAR2(30));\n\nINSERT INTO kyle01 VALUES(1,1,&#39;Kyle01&#39;);\nINSERT INTO kyle01 VALUES(2,2,&#39;Kyle02&#39;);\nINSERT INTO kyle01 VALUES(3,3,&#39;Kyle03&#39;);\nINSERT INTO kyle01 VALUES(4,4,&#39;Kyle04&#39;);\n\nDECLARE\n  rnd number(9,2);\nBEGIN\n   for i in 1..20000 loop\n     IF MOD(i,2000)=0 THEN\n         commit;\n     ELSE\n         insert into kyle03 values(seq_kyle.nextval,i*dbms_random.value,&#39;Kyle Is Testing&#39;);\n     END IF;\n   END LOOP;\nEND;\n/\n\nBEGIN\n   LOOP\n    delete from kyle03 where rownum=1;\n     commit;\n     insert into kyle03 values(seq_kyle.nextval,200000*dbms_random.value,&#39;MACLEAN IS UPDATING&#39;);\n     commit;\n     insert into kyle03 values(seq_kyle.nextval,300000*dbms_random.value,&#39;MACLEAN IS UPDATING&#39;);\n     commit;\n    update kyle03 set rand=rand+10 where rownum=1;\n    commit;\n     dbms_lock.sleep(1);\n     END loop;\nEND;\n\n/\n\n\n</code></pre>\n<ul>\n<li>目标端</li>\n</ul>\n<pre><code class=\"sql\">CREATE  TABLESPACE &quot;KYLE&quot;\n    DATAFILE &#39;/u01/oradata/itpux/kyle01.dbf&#39;\n        SIZE 100 M\n        AUTOEXTEND ON NEXT 10 M MAXSIZE 500 M\n    LOGGING\n    EXTENT MANAGEMENT LOCAL\n    SEGMENT SPACE MANAGEMENT AUTO;\n\nCREATE USER &quot;KYLE&quot;\n    PROFILE &quot;DEFAULT&quot; \n    IDENTIFIED BY &quot;kyle&quot; \n    DEFAULT TABLESPACE &quot;KYLE&quot; \n    TEMPORARY TABLESPACE &quot;TEMP&quot; \n    ACCOUNT UNLOCK;\n</code></pre>\n<h3 id=\"1-4-数据导入导出\"><a href=\"#1-4-数据导入导出\" class=\"headerlink\" title=\"1.4 数据导入导出\"></a>1.4 数据导入导出</h3><pre><code class=\"sql\">create directory bakdir as &#39;/home/oracle&#39;;\ngrant read,write on directory bakdir to system;\ngrant create any directory to system;\n\n--导出结构\nCREATE DIRECTORY BAKDIR AS &#39;/home/oracle&#39;;\nGRANT READ,WRITE ON DIRECTORY BAKDIR TO SYSTEM;\nGRANT CREATE ANY DIRECTORY TO SYSTEM;\n--导出某个或多个schema\nexpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log SCHEMAS=kyle\nimpdp system/jia  DIRECTORY=bakdir DUMPFILE=expdp_schema_kyle.dmp LOGFILE=expdp_schema_kyle.log TABLE_EXISTS_ACTION=truncate SCHEMAS=kyle\nscp /home/oracle/expdp_schema_kyle.dmp orcl-122:/home/oracle/\n</code></pre>\n<h3 id=\"1-5-配置环境变量\"><a href=\"#1-5-配置环境变量\" class=\"headerlink\" title=\"1.5 配置环境变量\"></a>1.5 配置环境变量</h3><pre><code class=\"sql\">alias sqlplus=&quot;rlwrap sqlplus&quot;\nalias ggsci=&quot;rlwrap ggsci&quot;\nalias rman=&quot;rlwrap rman&quot;\nalias asmcmd=&quot;rlwrap asmcmd&quot;\n\nLD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib; export LD_LIBRARY_PATH\nCLASSPATH=/ggs:$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib; export CLASSPATH\nOGG_PATH=/u01/ggs export OGG_PATH\nPATH=.:$PATH:$OGG_PATH:$HOME/bin:$ORACLE_BASE/product/11.2.0/db_1/bin:$ORACLE_HOME/bin; export PATH\n</code></pre>\n<h3 id=\"1-6-修改系统参数开启归档\"><a href=\"#1-6-修改系统参数开启归档\" class=\"headerlink\" title=\"1.6 修改系统参数开启归档\"></a>1.6 修改系统参数开启归档</h3><pre><code class=\"sql\">ALTER SYSTEM SET ENABLE_GOLDENGATE_REPLICATION = TRUE SCOPE=BOTH;\nalter database add supplemental log data;\nalter database force logging;\n</code></pre>\n<h3 id=\"1-7-配置OGG-源端\"><a href=\"#1-7-配置OGG-源端\" class=\"headerlink\" title=\"1.7 配置OGG(源端)\"></a>1.7 配置OGG(源端)</h3><ul>\n<li>1.创建目录</li>\n</ul>\n<pre><code class=\"sql\">create subdirs\n</code></pre>\n<ul>\n<li>2.配置MGR</li>\n</ul>\n<pre><code class=\"sql\">GGSCI&gt;\nEDIT PARAMS mgr\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\n--端口 7809\n--自动启动 ER(EXTARCT REPLACT)\n\n</code></pre>\n<ul>\n<li>3.配置检查点</li>\n</ul>\n<pre><code class=\"sql\">--GLOBALS储存了运行的一些信息\nGGSCI&gt; EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI&gt; dblogin userid goldengate,password goldengate\nGGSCI&gt; ADD CHECKPOINTTABLE goldengate.checkpoint\n</code></pre>\n<ul>\n<li>4.添加补充日志</li>\n</ul>\n<pre><code class=\"sql\">--ADD TRANDATA itpux.*\nADD SCHEMATRANDATA kyle\n--配置ddl 的时候，一定要用ADD SCHEMATRANDATA\n--如果不用ddl,可以用ADD TRANDATA\ninfo SCHEMATRANDATA kyle\n</code></pre>\n<ul>\n<li>5.配置extract进程</li>\n</ul>\n<pre><code class=\"sql\">--建立EXTRACT目录\nmkdir -p ./dirdat/rkyle\nmkdir -p ./dirrpt/rkyle\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI&gt;\nEDIT PARAMS ekyle\n\nsetenv(NLS_LANG=&quot;AMERICAN_AMERICA.ZHS16GBK&quot;)\nsetenv(ORACLE_SID=&quot;itpux&quot;)\nEXTRACT ekyle\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nUSERID goldengate, PASSWORD goldengate\nEXTTRAIL ./dirdat/ekyle/ex\nTRANLOGOPTIONS excludeuser goldengate\nTRANLOGOPTIONS convertucs2clobs\nWARNLONGTRANS 12h,CHECKINTERVAL 30m\nDISCARDFILE ./dirrpt/ekyle/ekyle.dsc, APPEND, MEGABYTES 200\nTABLE kyle.*;\n\n--设置语言\n--设置SID\n--设置EXTRACT名称不能操作过8个字符\n--抽取所有的DDL操作\n--\n--定义OGG使用用户\n--设置抽取目录\n--排除用于管理抽取的OGG用户\n--某某参数，可以传输大字段\n--设置告警阈值\n--配置文件存放位置\n--抽取的表\n\n--添加一个抽取进程\n--THREADS 2表示源端有2个RAC节点\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW\nADD EXTRACT ekyle, TRANLOG, BEGIN NOW, THREADS 2\n--添加一个队列文件\nGGSCI&gt;\nADD EXTTRAIL ./dirdat/ekyle/ex, EXTRACT ekyle, MEGABYTES 200\n\n--启动停止测试\nGGSCI&gt;\nSTART ekyle\nSTOP ekyle\nVIEW REPORT ekyle\n</code></pre>\n<ul>\n<li>6.配置PUMP进程</li>\n</ul>\n<pre><code class=\"sql\">cd /u01/ggs\nmkdir -p ./dirdat/ekyle\nmkdir -p ./dirrpt/ekyle\n\nGGSCI&gt;\nEDIT PARAMS pkyle\n\nsetenv(NLS_LANG=&quot;AMERICAN_AMERICA.ZHS16GBK&quot;)\nsetenv(ORACLE_SID=&quot;orcl&quot;)\nEXTRACT pkyle\nUSERID goldengate,PASSWORD goldengate\nPASSTHRU                        \nRMTHOST 172.17.0.122,MGRPORT 7809\nRMTTRAIL ./dirdat/rkyle/re\nDISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200\nTABLE ekyle.*;\n\n--\n--\n--\n-- 禁止extract与数据库交互，适合于PUMP传输进程\n-- 远端的IP,端口\n-- 指定写入到远程目标端的哪个队列\n-- 指定报错输出文件\n-- 指定传输表\n\n\n--增加pump 进程(指定本地trail 文件)\nGGSCI&gt;\nADD EXTRACT pkyle,EXTTRAILSOURCE ./dirdat/ekyle/ex\n\n--增加rmttail 文件\nGGSCI&gt;\nADD RMTTRAIL ./dirdat/rkyle/re, EXTRACT pkyle, MEGABYTES 200\n--检查:\nGGSCI&gt;\nINFO  pkyle\n</code></pre>\n<h3 id=\"1-8-配置OGG-目标端\"><a href=\"#1-8-配置OGG-目标端\" class=\"headerlink\" title=\"1.8 配置OGG(目标端)\"></a>1.8 配置OGG(目标端)</h3><ul>\n<li>1.配置mgr</li>\n</ul>\n<pre><code class=\"sql\">GGSCI&gt; EDIT PARAMS MGR\nPORT 7809\nAUTOSTART ER * \nAUTORESTART ER *, RETRIES 3, WAITMINUTES 3, RESETMINUTES 15\nPURGEOLDEXTRACTS ./dirdat/*, USECHECKPOINTS, MINKEEPDAYS 2\n*/\nGGSCI&gt;\nSTART MGR\nSTOP MGR\n</code></pre>\n<ul>\n<li>2.配置检查点</li>\n</ul>\n<pre><code class=\"sql\">GGSCI&gt; EDIT PARAMS ./GLOBALS\nCHECKPOINTTABLE goldengate.checkpoint\nGGSCI&gt; dblogin userid goldengate,password goldengate\nGGSCI&gt; ADD CHECKPOINTTABLE goldengate.checkpoint\n</code></pre>\n<ul>\n<li>3.配置replicat进程<br><code>`</code>sql<br>cd /u01/ggs<br>mkdir -p ./dirdat/rkyle<br>mkdir -p ./dirrpt/rkyle</li>\n</ul>\n<p>ggsci&gt; edit params rkyle</p>\n<p>setenv(NLS_LANG=”AMERICAN_AMERICA.ZHS16GBK”)<br>setenv(ORACLE_SID=”itpux”)<br>REPLICAT rkyle<br>USERID goldengate,PASSWORD goldengate<br>handlecollisions<br>assumetargetdefs<br>DISCARDFILE ./dirrpt/rkyle/rkyle.dsc, APPEND, MEGABYTES 200<br>MAP kyle.<em>, target kyle.</em>;</p>\n<p>–添加replicat 进程<br>GGSCI&gt;<br>ADD REPLICAT rkyle EXTTRAIL ./dirdat/rkyle/re, CHECKPOINTTABLE goldengate.checkpoint<br>–启动相关进程(目标)<br>GGSCI&gt;<br>START rkyle<br>VIEW REPORT rkyle<br>INFO ALL<br>–启动相关进程(源端)<br>GGSCI&gt;<br>START rkyle<br>START pkyle<br>VIEW REPORT rkyle<br>VIEW REPORT pkyle<br>INFO ALL</p>\n<pre><code>\n### 1.9 disable 目标库所有的trigger、cascading delete、check、job\n```sql\nSET PAGESIZE 2000\nSET LINESIZE 100\n--Foreign key Constraints/Cascading Deletes\nSELECT    &#39;alter table &#39;\n       || owner\n       || &#39;.&#39;\n       || table_name\n       || &#39; DISABLE CONSTRAINT &#39;\n       || constraint_name\n       || &#39;;&#39;\n  FROM dba_constraints\n WHERE     constraint_type = &#39;R&#39;\n       AND delete_rule = &#39;CASCADE&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n\n--查找生成并disable 约束(Check)：\nSELECT    &#39;alter table &#39;\n       || owner\n       || &#39;.&#39;\n       || table_name\n       || &#39; DISABLE CONSTRAINT &#39;\n       || constraint_name\n       || &#39;;&#39;\n  FROM dba_constraints\n WHERE     constraint_type = &#39;C&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n--查找生成并disable trigger：\nSELECT &#39;alter trigger &#39; || owner || &#39;.&#39; || object_name || &#39; disable;&#39;\n  FROM dba_objects\n WHERE     object_type = &#39;TRIGGER&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n\n\n--查找并disable job\nSELECT job,\n       next_date,\n       next_sec,\n       failures,\n       broken\n  FROM dba_jobs\n WHERE SCHEMA_USER IN (&#39;KYLE&#39;,\n                       &#39;KYLE01&#39;);\n\nBEGIN\n    sys.DBMS_JOB.broken (job =&gt; 21, broken =&gt; TRUE);\n    COMMIT;\nEND;\n\n\n--生成结果如下，然后在目标数据库中执行：\nalter table ... DISABLE CONSTRAINT SYS_C0017353;\nalter table ... DISABLE CONSTRAINT SYS_C0017355;…\n…\nalter trigger ... disable;\nalter trigger ... disable;\nalter trigger ... disable;\n--确认外键已经被禁用\nSELECT OWNER,\n       CONSTRAINT_NAME,\n       CONSTRAINT_TYPE,\n       STATUS\n  FROM dba_CONSTRAINTS\n WHERE     CONSTRAINT_TYPE = &#39;R&#39;\n       AND status = &#39;ENABLED&#39;\n       AND owner IN (&#39;KYLE&#39;,\n                     &#39;KYLE01&#39;);\n--确认目标端目标表的主键可用:\nSELECT T1.STATUS,\n       T1.VALIDATED,\n       T2.status,\n       T1.constraint_name,\n       T1.owner\n  FROM dba_constraints T1, dba_objects T2\n WHERE     T2.OBJECT_NAME = T1.constraint_name\n       AND T1.OWNER IN (&#39;KYLE&#39;,\n                        &#39;KYLE01&#39;);\n\n--验证job 确实被禁用\nSELECT job,\n       LOG_USER,\n       PRIV_USER,\n       SCHEMA_USER,\n       broken\n  FROM dba_jobs\n WHERE schema_user IN (&#39;KYLE&#39;,\n                       &#39;KYLE01&#39;);\n\nSELECT OWNER, JOB_NAME, STATE\n  FROM DBA_SCHEDULER_JOBS\n WHERE OWNER IN (&#39;KYLE&#39;,\n                 &#39;KYLE01&#39;);\n\n--确认trigger 已经全部关闭\nSELECT DISTINCT status\n  FROM dba_triggers\n WHERE owner IN (&#39;KYLE&#39;,\n                 &#39;KYLE01&#39;);\n</code></pre><h2 id=\"2-添加DDL功能与加密\"><a href=\"#2-添加DDL功能与加密\" class=\"headerlink\" title=\"2,.添加DDL功能与加密\"></a>2,.添加DDL功能与加密</h2><h3 id=\"2-1-添加DDL功能\"><a href=\"#2-1-添加DDL功能\" class=\"headerlink\" title=\"2.1 添加DDL功能\"></a>2.1 添加DDL功能</h3><ul>\n<li>1.关闭所有OGG进程</li>\n</ul>\n<pre><code class=\"sql\">STOP ekyle\nSTOP pkyle\nSTOP rkyle\n</code></pre>\n<ul>\n<li>2.用户的默认表空间不能自动SYSTEM表空间</li>\n</ul>\n<pre><code class=\"sql\">set PAGRSIZE 200\nset LINESIZE 200\ncol USERNAME format A20\ncol DEFAULT_TABLESPACE format A20 \n\nSELECT username, default_tablespace FROM dba_users;\n</code></pre>\n<ul>\n<li>3.关闭回收站并清空回收站</li>\n</ul>\n<pre><code class=\"sql\">--11G可以启动回收站，10G必须关闭回收站\nALTER SYSTEM SET recyclebin = off SCOPE = SPFILE;\nPURGE DBA_RECYCLEBIN;\n</code></pre>\n<ul>\n<li>4.指明支持DDL的对象放在那个SCHEMA下载</li>\n</ul>\n<pre><code class=\"sql\">ggsci&gt; edit params ./GLOBALS\nGGSCHEMA goldengate\n</code></pre>\n<ul>\n<li>5.添加相关权限</li>\n</ul>\n<pre><code class=\"sql\">GRANT EXECUTE ON UTL_FILE TO goldengate;\nGRANT RESTRICTED SESSION TO goldengate;\nGRANT CREATE TABLE, CREATE SEQUENCE TO goldengate;\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n</code></pre>\n<ul>\n<li>6.执行脚本（源目标）</li>\n</ul>\n<pre><code class=\"sql\">cd /ggs\nsqlplus &quot;/as sysdba&quot;\n@marker_setup.sql\n@ddl_setup.sql\n@role_setup.sql\nGRANT GGS_GGSUSER_ROLE TO goldengate;\n@ddl_enable.sql\n@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n@ddl_pin.sql goldengate\n</code></pre>\n<ul>\n<li>7.修改参数，增加DDL复制参数</li>\n</ul>\n<pre><code class=\"sql\">ggsci &gt;edit params eitpux01\n--DDL INCLUDE OBJNAME &quot;ITPUX01.*&quot;\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\n\nggsci &gt;edit params ritpux01\n--DDL INCLUDE OBJNAME &quot;ITPUX01.*&quot;\nDDL INCLUDE ALL\nDDLERROR default ignore retryop\n</code></pre>\n<ul>\n<li>8.启动进程</li>\n</ul>\n<pre><code class=\"sql\">START ekyle\nSTART pkyle\nSTART ryle\n</code></pre>\n<ul>\n<li>DDL其他功能</li>\n</ul>\n<pre><code class=\"sql\">--开启\nddl_enable.sql\n--关闭\nddl_disable.sql\n\n--清空DDL trace ggs_ddl_trace.log\nddl_cleartrace.sql\n\n--ddl 参数：\noptype alert\nobjtype &quot;table&quot;\nojbname &quot;user.tab*&quot;\ninclude mapped object &quot;*&quot;;\nexclude mapped object &quot;itpux.itux*&quot;\nDDL 环境重配（删除就是1-5，12，去掉参数中的DDL）:\n1.停止所有的OGG ex/pump/rp 进程\n2.@ddl_disable.sql\n3.@ddl_remove.sql\n4.@marker_remove.sql\n5.@marker_setup.sql\n6.@ddl_setup.sql\n7.@role_setup.sql\n8.GRANT GGS_GGSUSER_ROLE TO goldengate;\n9.@ddl_enable.sql\n10.@$ORACLE_HOME/rdbms/admin/dbmspool.sql\n11.@ddl_pin.sql goldengate\n12.运行所有的OGG ex/pump/rp 进程\n</code></pre>\n<h3 id=\"2-2-加密\"><a href=\"#2-2-加密\" class=\"headerlink\" title=\"2.2 加密\"></a>2.2 加密</h3><ul>\n<li>1.生成加密的KEY </li>\n</ul>\n<pre><code class=\"sql\">[oracle@orcl:/u01/ggs]$keygen 256 1\n0x1673D6197E05DA1009B1451420A73134BDF868246D6AC878FBFC69193231C355\n</code></pre>\n<ul>\n<li>2.将KEY存到本地指定文件</li>\n</ul>\n<pre><code class=\"sql\">[oracle@orcl:/u01/ggs]$cat ENCKEYS \nKYLE_KEY 0xE9E07156ACC2411F97E78D117B55C444E935E27A034CBD389CF2F432F8B5F417\n</code></pre>\n<ul>\n<li>3.设置登录用的的KEY</li>\n</ul>\n<pre><code class=\"sql\">\nGGSCI (orcl) 109&gt; ENCRYPT PASSWORD goldengate AES256 ENCRYPTKEY KYLE_KEY\nEncrypted password:  AADAAAAAAAAAAAKABIXBCASDGBHCGFNGMHJIFFMDXFGBRCLHTGJGVIECPCGEUAJEXDSEFBUCGATGKGUGBGCCVFKBBENDYBSAPDZBACQCQILIRHYH\nAlgorithm used:  AES256\n</code></pre>\n<ul>\n<li>添加KEY到相应文件</li>\n</ul>\n<pre><code class=\"sql\">extract eitpux01\nDDL INCLUDE ALL\nDDLOPTIONS ADDTRANDATA,REPORT\nuserid goldengate,password AADAAAAAAAAAAAKACAHHWIRDTBQDNBUJYFUCXCGEVBCDHBCEGFOIQFSEGFKCBGLDPGUGAIIHZDJATJSJYBPBSJSJUFSBJCUBYCXBFBPJPDSBVGBJ,AES256,ENCRYPTKEY KYLE_KEY\nexttrail ./dirdat/eitpux01/ex\ntranlogoptions excludeuser goldengate\ntranlogoptions convertucs2clobs\nwarnlongtrans 12h,checkinterval 30m\ndiscardfile ./dirrpt/eitpux01/eitpux01.dsc,append,megabytes 200\nTABLE itpux.*;\n--TABLE itpux01.*;\n--TABLE itpux02.*;\n--TABLE itpux03.*;\n</code></pre>\n"},{"title":"Oracle DML日常操作和事务处理","date":"2018-10-02T06:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle DML日常操作和事务处理\n\n## 注意\n\n[Oracle 11G R2 官方文档][1] \n\n## 1 使用INSERT 命令\n### 1.1 语法\n```sql\nINSERT INTO <TABLE> [(colum[,column.....])]VALUES (values[,value....])\nINSERT INTO 表名(列名列表) VALUES(值列表);\ntable： 指定表或视图\ncolumn：指定列名，多列之间用,分开\nvalue： 指定待插入的数据，多值之间依,分开\n```\n### 1.2 基本使用\n```sql\n/* Formatted on 2018/2/12 14:59:34 (QP5 v5.313) */\n--1.insert 语句\n--1.1\n\nSELECT * FROM sql02;                     -- for update\n--1.2\nSELECT * FROM sql03;\nINSERT INTO sql03 (sql03_id1, sql03_id2, sql03_id3)\n     VALUES (1, 11, 'sql03_11');\nCOMMIT;\n--1.3\n\nSELECT * FROM sql04;\nINSERT INTO sql04\n     VALUES (1,\n             '11g sql04 01',\n             'active',\n             60,\n             SYSDATE,\n             20);\nINSERT INTO sql04\n     VALUES (2,\n             '11g sql04 02',\n             'active',\n             100,\n             SYSDATE,\n             40);\nCOMMIT;\n--1.4\n\nSELECT * FROM sql03;\nINSERT INTO sql03\n     VALUES (&sql03_id1, &sql03_id2, &sql03_id3);\n\nCOMMIT;\n--1.5\n\nCREATE TABLE sql05\nAS\n    SELECT * FROM sql04;\nDELETE FROM sql05;\nCOMMIT;\n\nSELECT * FROM sql05;\nINSERT INTO sql05\n    SELECT * FROM sql04;\nCOMMIT;\n\nSELECT * FROM sql05;\n\n--1.6\n\nINSERT INTO sql04\n     VALUES (3,\n             '11g sql04 03',\n             'active',\n             160,\n             SYSDATE,\n             20);\n\nINSERT INTO sql04\n     VALUES (4,\n             '11g sql04 04',\n             'active',\n             220,\n             SYSDATE,\n             40);\n\nCOMMIT;\n\nSELECT * FROM sql04;\n\nINSERT INTO sql05\n    SELECT *\n      FROM sql04\n     WHERE sql04_price > 200;\n\nCOMMIT;\n\nSELECT * FROM sql05;\n```\n## 2 使用UPDATE 命令\n### 2.1 语法\n```sql\nUPDATE 表名称SET 列名称= 新值<WHERE 条件>\n```\n### 2.2 基本使用\n```sql\n/* Formatted on 2018/2/12 15:00:37 (QP5 v5.313) */\n--2.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\n--2.2\n\nUPDATE sql02\n   SET sql02_number = 20002\n WHERE sql02_id = 2;\n\nUPDATE sql02\n   SET sql02_status = 'no'\n WHERE sql02_id = 2;\n\nSELECT *\n  FROM sql02 commit;\n\n--2.3\n\nSELECT *\n  FROM sql02 update sql02 set sql02_id2=222,sql02_status='OK' where sql02_id=2;\n--2.4\n\nSELECT *\n  FROM sql04 update sql04\nset (sql04_desc, sql04_count) =\n(select sql04_desc, sql04_count from sql04 where sql04_id = 2)\nwhere sql04_id = 3;\nCOMMIT;\n\nSELECT * FROM sql04\n```\n\n## 3 使用DELETE 命令\n### 3.1 语法\n```sql\nDELETE FROM <table/view> [WHERE <condition>]\n```\n### 3.2 基本使用\n```sql\n--3.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\nselect * from sql02\n--3.2\nselect * from sql04\ndelete from sql04 where sql04_id=1;\nselect * from sql04\n--3.3\ndelete from sql04 where sql04_id=2 and sql04_id=3;\n\nDELETE FROM sql04\n      WHERE sql04_id IN (2, 3);\n\nDELETE FROM sql04\n      WHERE sql04_price IN ('160', '100');\n\nselect * from sql04\n--3.4\nselect * from sql03\ndelete from sql03;\nCOMMIT;\n--truncate table\n```\n## 4 创建PL/SQL 对象\n### 4.1 语法\n```sql\n/* Formatted on 2018/2/12 15:01:26 (QP5 v5.313) */\nSELECT * FROM yg;\n\n--创建\n\nCREATE OR REPLACE PROCEDURE yg_count\nAS\n    v_yg_count1   NUMBER (10);\n    v_yg_count2   NUMBER (10);\nBEGIN\n    SELECT COUNT (*) INTO v_yg_count1 FROM yg;\n    DELETE FROM yg\n          WHERE job_id = 'SH_CLERK';\n    SELECT COUNT (*) INTO v_yg_count2 FROM yg;\n    DBMS_OUTPUT.put_line ('离职前的员工数：' || v_yg_count1);\n    DBMS_OUTPUT.put_line ('离职后的员工数：' || v_yg_count2);\nEND;\n/\n\nSET SERVEROUTPUT ON;\nEXECUTE yg_count;\n--离职前的员工数：107\n--离职后的员工数：97\n\n--删除\nDROP PROCEDURE yg_count;\n```\n\n## 5 事务概念与控制\n### 5.1 事务说明\n```sql\n\t   \n\t事务是对数据库操作的逻辑单位，在一个事务中可以包含一条或多条DML （数据操纵语言）、DDL （数据定义语言）和DCL （数据控制语言）语句，这些语句组成一个逻辑整体。\n\t事务的执行只有两种结果：要么全部执行，把数据库带入一个新的状态，要么全部不执行，对数据库不做任何修改。\n\t一组SQL,一个逻辑工作单位，执行时整体修改或者整体回退。\n```\n### 5.2 事务相关概念\n\n```sql\n1）事务的提交和回滚：COMMIT/ROLLBACK\n2）事务的开始和结束\n\t开始事务：连接到数据库，执行DML、DCL、DDL 语句\n\t结束事务：1. 执行DDL(例如CREATE TABLE),DCL(例如GRANT),系统自动\n\t\n执行COMMIT 语句\n\n2. 执行COMMIT/ROLLBACK\n3. 退出/断开数据库的连接自动执行COMMIT 语句\n4. 进程意外终止，事务自动rollback\n5. 事务COMMIT 时会生成一个唯一的系统变化号（SCN）保存\n到事务表\n3）保存点（savepoint）： 可以在事务的任何地方设置保存点，以便ROLLBACK\n4）事务的四个特性ACID :\n\t1. Atomicity（原子性）: 事务中sql 语句不可分割，要么都做，要么都不做\n\t2. Consistency(一致性) ： 指事务操作前后，数据库中数据是一致的，数据\n满足业务规则约束（例如账户金额的转出和转入），与原子性对应。\n\t3. Isolation（隔离性）：多个并发事务可以独立运行，而不能相互干扰，一\n个事务修改数据未提交前，其他事务看不到它所做的更改。\n\t4. Durability（持久性）：事务提交后，数据的修改是永久的。\n5） 死锁：当两个事务相互等待对方释放资源时，就会形成死锁。\n```\n\n### 5.3 oracle 事务隔离级别\n* 1 .两个事务并发访问数据库数据时可能存在的问题\n\n```sql\n1. 幻想读：\n\t事务T1 读取一条指定where 条件的语句，返回结果集。此时事务T2 插入一行新记录并commit，恰好满足T1 的where 条件。然后T1 使用相同的条件再次查\n询，结果集中可以看到T2 插入的记录，这条新纪录就是幻想。\n2. 不可重复读取：\n\t事务T1 读取一行记录，紧接着事务T2 修改了T1 刚刚读取的记录并commit，然后T1 再次查询，发现与第一次读取的记录不同，这称为不可重复读。\n3. 脏读：\n\t事务T1 更新了一行记录，还未提交所做的修改，这个T2 读取了更新后的数\n据，然后T1 执行回滚操作，取消刚才的修改，所以T2 所读取的行就无效，也就是脏数据。\n```\n\n* 2.oracle 事务隔离级别\n\n```sql\noracle 支持的隔离级别：（不支持脏读）\nREAD COMMITTED--不允许脏读，允许幻想读和不可重复读\nSERIALIZABLE--以上三种都不允许\nsql 标准还支持READ UNCOMMITTED (三种都允许)和REPEATABLE READ（不允\n许不可重复读和脏读，只允许幻想读）\n```\n\n* 3.事务相关语句\n\n```sql\nSET TRANSACTION----设置事务属性\nSET CONSTRAINT -----设置约束\nSAVEPOINT ------------建立存储点\nRELEASE SAVEPOINT --释放存储点\nROLLBACK---------------回滚\nCOMMIT------------------提交\n```\n\n## 6 锁的检测和锁争用\t\n### 6.1 解决死锁冲突\n* 1）执行commit 或者rollback 结束事务\n```sql\n\n```\n* 2）终止会话\n```sql\n在等待资源时执行，查找阻塞会话\n\nSELECT sid, serial#, username\n  FROM v$session\n WHERE sid IN (SELECT blocking_session FROM v$session);\n\n杀掉会话\n\nALTER SYSTEM KILL SESSION '111,222';\n\n关于查看锁的一些视图\n\nSELECT * FROM V$SESSION;                        --查看会话和锁的信息\nSELECT * FROM V$SESSION_WAIT;                             --查看等待的会话信息\nSELECT * FROM V$LOCK;                     --系统中所有锁\nSELECT * FROM V$LOCKED_OBJECT;                              --系统中DML 锁\nSELECT l.sid, s.SERIAL#, sq.sql_text\n  FROM v$lock l, v$session s, v$sql sq\n WHERE l.sid = s.sid AND s.sql_id = sq.sql_id AND s.status = 'ACTIVE'\nalter system kill session '139,1431'\n```\n## 7 了解撤销数据UNDO\n### 7.1 查看近来数据库生成的撤销数据量\n```sql\nALTER SESSION SET nls_date_format = 'dd-mm-yy hh24:mi:ss';\nSELECT begin_time,\nend_time,\n(undoblks *\n(SELECT VALUE FROM v$parameter WHERE NAME = 'db_block_size'))\nundo_bytes\nFROM v$undostat;\n```\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle DML日常操作和事务处理.md","raw":"---\ntitle: Oracle DML日常操作和事务处理\ndate: 2018-10-02 14:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - SQL\n  - DML\n---\n\n\n# Oracle DML日常操作和事务处理\n\n## 注意\n\n[Oracle 11G R2 官方文档][1] \n\n## 1 使用INSERT 命令\n### 1.1 语法\n```sql\nINSERT INTO <TABLE> [(colum[,column.....])]VALUES (values[,value....])\nINSERT INTO 表名(列名列表) VALUES(值列表);\ntable： 指定表或视图\ncolumn：指定列名，多列之间用,分开\nvalue： 指定待插入的数据，多值之间依,分开\n```\n### 1.2 基本使用\n```sql\n/* Formatted on 2018/2/12 14:59:34 (QP5 v5.313) */\n--1.insert 语句\n--1.1\n\nSELECT * FROM sql02;                     -- for update\n--1.2\nSELECT * FROM sql03;\nINSERT INTO sql03 (sql03_id1, sql03_id2, sql03_id3)\n     VALUES (1, 11, 'sql03_11');\nCOMMIT;\n--1.3\n\nSELECT * FROM sql04;\nINSERT INTO sql04\n     VALUES (1,\n             '11g sql04 01',\n             'active',\n             60,\n             SYSDATE,\n             20);\nINSERT INTO sql04\n     VALUES (2,\n             '11g sql04 02',\n             'active',\n             100,\n             SYSDATE,\n             40);\nCOMMIT;\n--1.4\n\nSELECT * FROM sql03;\nINSERT INTO sql03\n     VALUES (&sql03_id1, &sql03_id2, &sql03_id3);\n\nCOMMIT;\n--1.5\n\nCREATE TABLE sql05\nAS\n    SELECT * FROM sql04;\nDELETE FROM sql05;\nCOMMIT;\n\nSELECT * FROM sql05;\nINSERT INTO sql05\n    SELECT * FROM sql04;\nCOMMIT;\n\nSELECT * FROM sql05;\n\n--1.6\n\nINSERT INTO sql04\n     VALUES (3,\n             '11g sql04 03',\n             'active',\n             160,\n             SYSDATE,\n             20);\n\nINSERT INTO sql04\n     VALUES (4,\n             '11g sql04 04',\n             'active',\n             220,\n             SYSDATE,\n             40);\n\nCOMMIT;\n\nSELECT * FROM sql04;\n\nINSERT INTO sql05\n    SELECT *\n      FROM sql04\n     WHERE sql04_price > 200;\n\nCOMMIT;\n\nSELECT * FROM sql05;\n```\n## 2 使用UPDATE 命令\n### 2.1 语法\n```sql\nUPDATE 表名称SET 列名称= 新值<WHERE 条件>\n```\n### 2.2 基本使用\n```sql\n/* Formatted on 2018/2/12 15:00:37 (QP5 v5.313) */\n--2.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\n--2.2\n\nUPDATE sql02\n   SET sql02_number = 20002\n WHERE sql02_id = 2;\n\nUPDATE sql02\n   SET sql02_status = 'no'\n WHERE sql02_id = 2;\n\nSELECT *\n  FROM sql02 commit;\n\n--2.3\n\nSELECT *\n  FROM sql02 update sql02 set sql02_id2=222,sql02_status='OK' where sql02_id=2;\n--2.4\n\nSELECT *\n  FROM sql04 update sql04\nset (sql04_desc, sql04_count) =\n(select sql04_desc, sql04_count from sql04 where sql04_id = 2)\nwhere sql04_id = 3;\nCOMMIT;\n\nSELECT * FROM sql04\n```\n\n## 3 使用DELETE 命令\n### 3.1 语法\n```sql\nDELETE FROM <table/view> [WHERE <condition>]\n```\n### 3.2 基本使用\n```sql\n--3.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\nselect * from sql02\n--3.2\nselect * from sql04\ndelete from sql04 where sql04_id=1;\nselect * from sql04\n--3.3\ndelete from sql04 where sql04_id=2 and sql04_id=3;\n\nDELETE FROM sql04\n      WHERE sql04_id IN (2, 3);\n\nDELETE FROM sql04\n      WHERE sql04_price IN ('160', '100');\n\nselect * from sql04\n--3.4\nselect * from sql03\ndelete from sql03;\nCOMMIT;\n--truncate table\n```\n## 4 创建PL/SQL 对象\n### 4.1 语法\n```sql\n/* Formatted on 2018/2/12 15:01:26 (QP5 v5.313) */\nSELECT * FROM yg;\n\n--创建\n\nCREATE OR REPLACE PROCEDURE yg_count\nAS\n    v_yg_count1   NUMBER (10);\n    v_yg_count2   NUMBER (10);\nBEGIN\n    SELECT COUNT (*) INTO v_yg_count1 FROM yg;\n    DELETE FROM yg\n          WHERE job_id = 'SH_CLERK';\n    SELECT COUNT (*) INTO v_yg_count2 FROM yg;\n    DBMS_OUTPUT.put_line ('离职前的员工数：' || v_yg_count1);\n    DBMS_OUTPUT.put_line ('离职后的员工数：' || v_yg_count2);\nEND;\n/\n\nSET SERVEROUTPUT ON;\nEXECUTE yg_count;\n--离职前的员工数：107\n--离职后的员工数：97\n\n--删除\nDROP PROCEDURE yg_count;\n```\n\n## 5 事务概念与控制\n### 5.1 事务说明\n```sql\n\t   \n\t事务是对数据库操作的逻辑单位，在一个事务中可以包含一条或多条DML （数据操纵语言）、DDL （数据定义语言）和DCL （数据控制语言）语句，这些语句组成一个逻辑整体。\n\t事务的执行只有两种结果：要么全部执行，把数据库带入一个新的状态，要么全部不执行，对数据库不做任何修改。\n\t一组SQL,一个逻辑工作单位，执行时整体修改或者整体回退。\n```\n### 5.2 事务相关概念\n\n```sql\n1）事务的提交和回滚：COMMIT/ROLLBACK\n2）事务的开始和结束\n\t开始事务：连接到数据库，执行DML、DCL、DDL 语句\n\t结束事务：1. 执行DDL(例如CREATE TABLE),DCL(例如GRANT),系统自动\n\t\n执行COMMIT 语句\n\n2. 执行COMMIT/ROLLBACK\n3. 退出/断开数据库的连接自动执行COMMIT 语句\n4. 进程意外终止，事务自动rollback\n5. 事务COMMIT 时会生成一个唯一的系统变化号（SCN）保存\n到事务表\n3）保存点（savepoint）： 可以在事务的任何地方设置保存点，以便ROLLBACK\n4）事务的四个特性ACID :\n\t1. Atomicity（原子性）: 事务中sql 语句不可分割，要么都做，要么都不做\n\t2. Consistency(一致性) ： 指事务操作前后，数据库中数据是一致的，数据\n满足业务规则约束（例如账户金额的转出和转入），与原子性对应。\n\t3. Isolation（隔离性）：多个并发事务可以独立运行，而不能相互干扰，一\n个事务修改数据未提交前，其他事务看不到它所做的更改。\n\t4. Durability（持久性）：事务提交后，数据的修改是永久的。\n5） 死锁：当两个事务相互等待对方释放资源时，就会形成死锁。\n```\n\n### 5.3 oracle 事务隔离级别\n* 1 .两个事务并发访问数据库数据时可能存在的问题\n\n```sql\n1. 幻想读：\n\t事务T1 读取一条指定where 条件的语句，返回结果集。此时事务T2 插入一行新记录并commit，恰好满足T1 的where 条件。然后T1 使用相同的条件再次查\n询，结果集中可以看到T2 插入的记录，这条新纪录就是幻想。\n2. 不可重复读取：\n\t事务T1 读取一行记录，紧接着事务T2 修改了T1 刚刚读取的记录并commit，然后T1 再次查询，发现与第一次读取的记录不同，这称为不可重复读。\n3. 脏读：\n\t事务T1 更新了一行记录，还未提交所做的修改，这个T2 读取了更新后的数\n据，然后T1 执行回滚操作，取消刚才的修改，所以T2 所读取的行就无效，也就是脏数据。\n```\n\n* 2.oracle 事务隔离级别\n\n```sql\noracle 支持的隔离级别：（不支持脏读）\nREAD COMMITTED--不允许脏读，允许幻想读和不可重复读\nSERIALIZABLE--以上三种都不允许\nsql 标准还支持READ UNCOMMITTED (三种都允许)和REPEATABLE READ（不允\n许不可重复读和脏读，只允许幻想读）\n```\n\n* 3.事务相关语句\n\n```sql\nSET TRANSACTION----设置事务属性\nSET CONSTRAINT -----设置约束\nSAVEPOINT ------------建立存储点\nRELEASE SAVEPOINT --释放存储点\nROLLBACK---------------回滚\nCOMMIT------------------提交\n```\n\n## 6 锁的检测和锁争用\t\n### 6.1 解决死锁冲突\n* 1）执行commit 或者rollback 结束事务\n```sql\n\n```\n* 2）终止会话\n```sql\n在等待资源时执行，查找阻塞会话\n\nSELECT sid, serial#, username\n  FROM v$session\n WHERE sid IN (SELECT blocking_session FROM v$session);\n\n杀掉会话\n\nALTER SYSTEM KILL SESSION '111,222';\n\n关于查看锁的一些视图\n\nSELECT * FROM V$SESSION;                        --查看会话和锁的信息\nSELECT * FROM V$SESSION_WAIT;                             --查看等待的会话信息\nSELECT * FROM V$LOCK;                     --系统中所有锁\nSELECT * FROM V$LOCKED_OBJECT;                              --系统中DML 锁\nSELECT l.sid, s.SERIAL#, sq.sql_text\n  FROM v$lock l, v$session s, v$sql sq\n WHERE l.sid = s.sid AND s.sql_id = sq.sql_id AND s.status = 'ACTIVE'\nalter system kill session '139,1431'\n```\n## 7 了解撤销数据UNDO\n### 7.1 查看近来数据库生成的撤销数据量\n```sql\nALTER SESSION SET nls_date_format = 'dd-mm-yy hh24:mi:ss';\nSELECT begin_time,\nend_time,\n(undoblks *\n(SELECT VALUE FROM v$parameter WHERE NAME = 'db_block_size'))\nundo_bytes\nFROM v$undostat;\n```\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle DML日常操作和事务处理","published":1,"updated":"2019-05-03T15:46:28.937Z","_id":"cjv890wc9001zi0cdw7o8anjj","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-DML日常操作和事务处理\"><a href=\"#Oracle-DML日常操作和事务处理\" class=\"headerlink\" title=\"Oracle DML日常操作和事务处理\"></a>Oracle DML日常操作和事务处理</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-使用INSERT-命令\"><a href=\"#1-使用INSERT-命令\" class=\"headerlink\" title=\"1 使用INSERT 命令\"></a>1 使用INSERT 命令</h2><h3 id=\"1-1-语法\"><a href=\"#1-1-语法\" class=\"headerlink\" title=\"1.1 语法\"></a>1.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">TABLE</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>colum<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">column</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">values</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> 表名<span class=\"token punctuation\">(</span>列名列表<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>值列表<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">table</span>： 指定表或视图\n<span class=\"token keyword\">column</span>：指定列名，多列之间用<span class=\"token punctuation\">,</span>分开\n<span class=\"token keyword\">value</span>： 指定待插入的数据，多值之间依<span class=\"token punctuation\">,</span>分开\n</code></pre>\n<h3 id=\"1-2-基本使用\"><a href=\"#1-2-基本使用\" class=\"headerlink\" title=\"1.2 基本使用\"></a>1.2 基本使用</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">/* Formatted on 2018/2/12 14:59:34 (QP5 v5.313) */</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.insert 语句</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.1</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql02<span class=\"token punctuation\">;</span>                     <span class=\"token comment\" spellcheck=\"true\">-- for update</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.2</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql03<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql03 <span class=\"token punctuation\">(</span>sql03_id1<span class=\"token punctuation\">,</span> sql03_id2<span class=\"token punctuation\">,</span> sql03_id3<span class=\"token punctuation\">)</span>\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sql03_11'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.3</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql04\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'11g sql04 01'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'active'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n             SYSDATE<span class=\"token punctuation\">,</span>\n             <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql04\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'11g sql04 02'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'active'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n             SYSDATE<span class=\"token punctuation\">,</span>\n             <span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.4</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql03<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql03\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sql03_id1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sql03_id2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sql03_id3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--1.5</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> sql05\n<span class=\"token keyword\">AS</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> sql05<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql05<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql05\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql05<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--1.6</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql04\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'11g sql04 03'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'active'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token number\">160</span><span class=\"token punctuation\">,</span>\n             SYSDATE<span class=\"token punctuation\">,</span>\n             <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql04\n     <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'11g sql04 04'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token string\">'active'</span><span class=\"token punctuation\">,</span>\n             <span class=\"token number\">220</span><span class=\"token punctuation\">,</span>\n             SYSDATE<span class=\"token punctuation\">,</span>\n             <span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> sql05\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n      <span class=\"token keyword\">FROM</span> sql04\n     <span class=\"token keyword\">WHERE</span> sql04_price <span class=\"token operator\">></span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql05<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"2-使用UPDATE-命令\"><a href=\"#2-使用UPDATE-命令\" class=\"headerlink\" title=\"2 使用UPDATE 命令\"></a>2 使用UPDATE 命令</h2><h3 id=\"2-1-语法\"><a href=\"#2-1-语法\" class=\"headerlink\" title=\"2.1 语法\"></a>2.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> 表名称<span class=\"token keyword\">SET</span> 列名称<span class=\"token operator\">=</span> 新值<span class=\"token operator\">&lt;</span><span class=\"token keyword\">WHERE</span> 条件<span class=\"token operator\">></span>\n</code></pre>\n<h3 id=\"2-2-基本使用\"><a href=\"#2-2-基本使用\" class=\"headerlink\" title=\"2.2 基本使用\"></a>2.2 基本使用</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">/* Formatted on 2018/2/12 15:00:37 (QP5 v5.313) */</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.1</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> sql02\n<span class=\"token keyword\">FOR</span> <span class=\"token keyword\">UPDATE</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.2</span>\n\n<span class=\"token keyword\">UPDATE</span> sql02\n   <span class=\"token keyword\">SET</span> sql02_number <span class=\"token operator\">=</span> <span class=\"token number\">20002</span>\n <span class=\"token keyword\">WHERE</span> sql02_id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">UPDATE</span> sql02\n   <span class=\"token keyword\">SET</span> sql02_status <span class=\"token operator\">=</span> <span class=\"token string\">'no'</span>\n <span class=\"token keyword\">WHERE</span> sql02_id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> sql02 <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.3</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> sql02 <span class=\"token keyword\">update</span> sql02 <span class=\"token keyword\">set</span> sql02_id2<span class=\"token operator\">=</span><span class=\"token number\">222</span><span class=\"token punctuation\">,</span>sql02_status<span class=\"token operator\">=</span><span class=\"token string\">'OK'</span> <span class=\"token keyword\">where</span> sql02_id<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.4</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> sql04 <span class=\"token keyword\">update</span> sql04\n<span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span>sql04_desc<span class=\"token punctuation\">,</span> sql04_count<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> sql04_desc<span class=\"token punctuation\">,</span> sql04_count <span class=\"token keyword\">from</span> sql04 <span class=\"token keyword\">where</span> sql04_id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">where</span> sql04_id <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04\n</code></pre>\n<h2 id=\"3-使用DELETE-命令\"><a href=\"#3-使用DELETE-命令\" class=\"headerlink\" title=\"3 使用DELETE 命令\"></a>3 使用DELETE 命令</h2><h3 id=\"3-1-语法\"><a href=\"#3-1-语法\" class=\"headerlink\" title=\"3.1 语法\"></a>3.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">table</span><span class=\"token operator\">/</span><span class=\"token keyword\">view</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">WHERE</span> <span class=\"token operator\">&lt;</span>condition<span class=\"token operator\">></span><span class=\"token punctuation\">]</span>\n</code></pre>\n<h3 id=\"3-2-基本使用\"><a href=\"#3-2-基本使用\" class=\"headerlink\" title=\"3.2 基本使用\"></a>3.2 基本使用</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--3.1</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> sql02\n<span class=\"token keyword\">FOR</span> <span class=\"token keyword\">UPDATE</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sql02\n<span class=\"token comment\" spellcheck=\"true\">--3.2</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sql04\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> sql04 <span class=\"token keyword\">where</span> sql04_id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sql04\n<span class=\"token comment\" spellcheck=\"true\">--3.3</span>\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> sql04 <span class=\"token keyword\">where</span> sql04_id<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token operator\">and</span> sql04_id<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> sql04\n      <span class=\"token keyword\">WHERE</span> sql04_id <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> sql04\n      <span class=\"token keyword\">WHERE</span> sql04_price <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'160'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'100'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sql04\n<span class=\"token comment\" spellcheck=\"true\">--3.4</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sql03\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> sql03<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--truncate table</span>\n</code></pre>\n<h2 id=\"4-创建PL-SQL-对象\"><a href=\"#4-创建PL-SQL-对象\" class=\"headerlink\" title=\"4 创建PL/SQL 对象\"></a>4 创建PL/SQL 对象</h2><h3 id=\"4-1-语法\"><a href=\"#4-1-语法\" class=\"headerlink\" title=\"4.1 语法\"></a>4.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">/* Formatted on 2018/2/12 15:01:26 (QP5 v5.313) */</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> yg<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--创建</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token operator\">OR</span> REPLACE <span class=\"token keyword\">PROCEDURE</span> yg_count\n<span class=\"token keyword\">AS</span>\n    v_yg_count1   NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    v_yg_count2   NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">BEGIN</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">INTO</span> v_yg_count1 <span class=\"token keyword\">FROM</span> yg<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> yg\n          <span class=\"token keyword\">WHERE</span> job_id <span class=\"token operator\">=</span> <span class=\"token string\">'SH_CLERK'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">INTO</span> v_yg_count2 <span class=\"token keyword\">FROM</span> yg<span class=\"token punctuation\">;</span>\n    DBMS_OUTPUT<span class=\"token punctuation\">.</span>put_line <span class=\"token punctuation\">(</span><span class=\"token string\">'离职前的员工数：'</span> <span class=\"token operator\">||</span> v_yg_count1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    DBMS_OUTPUT<span class=\"token punctuation\">.</span>put_line <span class=\"token punctuation\">(</span><span class=\"token string\">'离职后的员工数：'</span> <span class=\"token operator\">||</span> v_yg_count2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n\n<span class=\"token keyword\">SET</span> SERVEROUTPUT <span class=\"token keyword\">ON</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">EXECUTE</span> yg_count<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--离职前的员工数：107</span>\n<span class=\"token comment\" spellcheck=\"true\">--离职后的员工数：97</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--删除</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">PROCEDURE</span> yg_count<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"5-事务概念与控制\"><a href=\"#5-事务概念与控制\" class=\"headerlink\" title=\"5 事务概念与控制\"></a>5 事务概念与控制</h2><h3 id=\"5-1-事务说明\"><a href=\"#5-1-事务说明\" class=\"headerlink\" title=\"5.1 事务说明\"></a>5.1 事务说明</h3><pre class=\" language-sql\"><code class=\"language-sql\">\n    事务是对数据库操作的逻辑单位，在一个事务中可以包含一条或多条DML （数据操纵语言）、DDL （数据定义语言）和DCL （数据控制语言）语句，这些语句组成一个逻辑整体。\n    事务的执行只有两种结果：要么全部执行，把数据库带入一个新的状态，要么全部不执行，对数据库不做任何修改。\n    一组SQL<span class=\"token punctuation\">,</span>一个逻辑工作单位，执行时整体修改或者整体回退。\n</code></pre>\n<h3 id=\"5-2-事务相关概念\"><a href=\"#5-2-事务相关概念\" class=\"headerlink\" title=\"5.2 事务相关概念\"></a>5.2 事务相关概念</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span>）事务的提交和回滚：<span class=\"token keyword\">COMMIT</span><span class=\"token operator\">/</span><span class=\"token keyword\">ROLLBACK</span>\n<span class=\"token number\">2</span>）事务的开始和结束\n    开始事务：连接到数据库，执行DML、DCL、DDL 语句\n    结束事务：<span class=\"token number\">1</span><span class=\"token punctuation\">.</span> 执行DDL<span class=\"token punctuation\">(</span>例如<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>DCL<span class=\"token punctuation\">(</span>例如<span class=\"token keyword\">GRANT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>系统自动\n\n执行<span class=\"token keyword\">COMMIT</span> 语句\n\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span> 执行<span class=\"token keyword\">COMMIT</span><span class=\"token operator\">/</span><span class=\"token keyword\">ROLLBACK</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span> 退出<span class=\"token operator\">/</span>断开数据库的连接自动执行<span class=\"token keyword\">COMMIT</span> 语句\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span> 进程意外终止，事务自动<span class=\"token keyword\">rollback</span>\n<span class=\"token number\">5</span><span class=\"token punctuation\">.</span> 事务<span class=\"token keyword\">COMMIT</span> 时会生成一个唯一的系统变化号（SCN）保存\n到事务表\n<span class=\"token number\">3</span>）保存点（<span class=\"token keyword\">savepoint</span>）： 可以在事务的任何地方设置保存点，以便<span class=\"token keyword\">ROLLBACK</span>\n<span class=\"token number\">4</span>）事务的四个特性ACID :\n    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span> Atomicity（原子性）: 事务中sql 语句不可分割，要么都做，要么都不做\n    <span class=\"token number\">2</span><span class=\"token punctuation\">.</span> Consistency<span class=\"token punctuation\">(</span>一致性<span class=\"token punctuation\">)</span> ： 指事务操作前后，数据库中数据是一致的，数据\n满足业务规则约束（例如账户金额的转出和转入），与原子性对应。\n    <span class=\"token number\">3</span><span class=\"token punctuation\">.</span> Isolation（隔离性）：多个并发事务可以独立运行，而不能相互干扰，一\n个事务修改数据未提交前，其他事务看不到它所做的更改。\n    <span class=\"token number\">4</span><span class=\"token punctuation\">.</span> Durability（持久性）：事务提交后，数据的修改是永久的。\n<span class=\"token number\">5</span>） 死锁：当两个事务相互等待对方释放资源时，就会形成死锁。\n</code></pre>\n<h3 id=\"5-3-oracle-事务隔离级别\"><a href=\"#5-3-oracle-事务隔离级别\" class=\"headerlink\" title=\"5.3 oracle 事务隔离级别\"></a>5.3 oracle 事务隔离级别</h3><ul>\n<li>1 .两个事务并发访问数据库数据时可能存在的问题</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span> 幻想读：\n    事务T1 读取一条指定<span class=\"token keyword\">where</span> 条件的语句，返回结果集。此时事务T2 插入一行新记录并<span class=\"token keyword\">commit</span>，恰好满足T1 的<span class=\"token keyword\">where</span> 条件。然后T1 使用相同的条件再次查\n询，结果集中可以看到T2 插入的记录，这条新纪录就是幻想。\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span> 不可重复读取：\n    事务T1 读取一行记录，紧接着事务T2 修改了T1 刚刚读取的记录并<span class=\"token keyword\">commit</span>，然后T1 再次查询，发现与第一次读取的记录不同，这称为不可重复读。\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span> 脏读：\n    事务T1 更新了一行记录，还未提交所做的修改，这个T2 读取了更新后的数\n据，然后T1 执行回滚操作，取消刚才的修改，所以T2 所读取的行就无效，也就是脏数据。\n</code></pre>\n<ul>\n<li>2.oracle 事务隔离级别</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">oracle 支持的隔离级别：（不支持脏读）\n<span class=\"token keyword\">READ</span> <span class=\"token keyword\">COMMITTED</span><span class=\"token comment\" spellcheck=\"true\">--不允许脏读，允许幻想读和不可重复读</span>\n<span class=\"token keyword\">SERIALIZABLE</span><span class=\"token comment\" spellcheck=\"true\">--以上三种都不允许</span>\nsql 标准还支持<span class=\"token keyword\">READ</span> <span class=\"token keyword\">UNCOMMITTED</span> <span class=\"token punctuation\">(</span>三种都允许<span class=\"token punctuation\">)</span>和<span class=\"token keyword\">REPEATABLE</span> <span class=\"token keyword\">READ</span>（不允\n许不可重复读和脏读，只允许幻想读）\n</code></pre>\n<ul>\n<li>3.事务相关语句</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token comment\" spellcheck=\"true\">----设置事务属性</span>\n<span class=\"token keyword\">SET</span> <span class=\"token keyword\">CONSTRAINT</span> <span class=\"token comment\" spellcheck=\"true\">-----设置约束</span>\n<span class=\"token keyword\">SAVEPOINT</span> <span class=\"token comment\" spellcheck=\"true\">------------建立存储点</span>\n<span class=\"token keyword\">RELEASE</span> <span class=\"token keyword\">SAVEPOINT</span> <span class=\"token comment\" spellcheck=\"true\">--释放存储点</span>\n<span class=\"token keyword\">ROLLBACK</span><span class=\"token comment\" spellcheck=\"true\">---------------回滚</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token comment\" spellcheck=\"true\">------------------提交</span>\n</code></pre>\n<h2 id=\"6-锁的检测和锁争用\"><a href=\"#6-锁的检测和锁争用\" class=\"headerlink\" title=\"6 锁的检测和锁争用\"></a>6 锁的检测和锁争用</h2><h3 id=\"6-1-解决死锁冲突\"><a href=\"#6-1-解决死锁冲突\" class=\"headerlink\" title=\"6.1 解决死锁冲突\"></a>6.1 解决死锁冲突</h3><ul>\n<li>1）执行commit 或者rollback 结束事务<br><code>`</code>sql</li>\n</ul>\n<pre><code>* 2）终止会话\n```sql\n在等待资源时执行，查找阻塞会话\n\nSELECT sid, serial#, username\n  FROM v$session\n WHERE sid IN (SELECT blocking_session FROM v$session);\n\n杀掉会话\n\nALTER SYSTEM KILL SESSION &#39;111,222&#39;;\n\n关于查看锁的一些视图\n\nSELECT * FROM V$SESSION;                        --查看会话和锁的信息\nSELECT * FROM V$SESSION_WAIT;                             --查看等待的会话信息\nSELECT * FROM V$LOCK;                     --系统中所有锁\nSELECT * FROM V$LOCKED_OBJECT;                              --系统中DML 锁\nSELECT l.sid, s.SERIAL#, sq.sql_text\n  FROM v$lock l, v$session s, v$sql sq\n WHERE l.sid = s.sid AND s.sql_id = sq.sql_id AND s.status = &#39;ACTIVE&#39;\nalter system kill session &#39;139,1431&#39;\n</code></pre><h2 id=\"7-了解撤销数据UNDO\"><a href=\"#7-了解撤销数据UNDO\" class=\"headerlink\" title=\"7 了解撤销数据UNDO\"></a>7 了解撤销数据UNDO</h2><h3 id=\"7-1-查看近来数据库生成的撤销数据量\"><a href=\"#7-1-查看近来数据库生成的撤销数据量\" class=\"headerlink\" title=\"7.1 查看近来数据库生成的撤销数据量\"></a>7.1 查看近来数据库生成的撤销数据量</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">SET</span> nls_date_format <span class=\"token operator\">=</span> <span class=\"token string\">'dd-mm-yy hh24:mi:ss'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> begin_time<span class=\"token punctuation\">,</span>\nend_time<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span>undoblks <span class=\"token operator\">*</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">VALUE</span> <span class=\"token keyword\">FROM</span> v$parameter <span class=\"token keyword\">WHERE</span> NAME <span class=\"token operator\">=</span> <span class=\"token string\">'db_block_size'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nundo_bytes\n<span class=\"token keyword\">FROM</span> v$undostat<span class=\"token punctuation\">;</span>\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-DML日常操作和事务处理\"><a href=\"#Oracle-DML日常操作和事务处理\" class=\"headerlink\" title=\"Oracle DML日常操作和事务处理\"></a>Oracle DML日常操作和事务处理</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-使用INSERT-命令\"><a href=\"#1-使用INSERT-命令\" class=\"headerlink\" title=\"1 使用INSERT 命令\"></a>1 使用INSERT 命令</h2><h3 id=\"1-1-语法\"><a href=\"#1-1-语法\" class=\"headerlink\" title=\"1.1 语法\"></a>1.1 语法</h3><pre><code class=\"sql\">INSERT INTO &lt;TABLE&gt; [(colum[,column.....])]VALUES (values[,value....])\nINSERT INTO 表名(列名列表) VALUES(值列表);\ntable： 指定表或视图\ncolumn：指定列名，多列之间用,分开\nvalue： 指定待插入的数据，多值之间依,分开\n</code></pre>\n<h3 id=\"1-2-基本使用\"><a href=\"#1-2-基本使用\" class=\"headerlink\" title=\"1.2 基本使用\"></a>1.2 基本使用</h3><pre><code class=\"sql\">/* Formatted on 2018/2/12 14:59:34 (QP5 v5.313) */\n--1.insert 语句\n--1.1\n\nSELECT * FROM sql02;                     -- for update\n--1.2\nSELECT * FROM sql03;\nINSERT INTO sql03 (sql03_id1, sql03_id2, sql03_id3)\n     VALUES (1, 11, &#39;sql03_11&#39;);\nCOMMIT;\n--1.3\n\nSELECT * FROM sql04;\nINSERT INTO sql04\n     VALUES (1,\n             &#39;11g sql04 01&#39;,\n             &#39;active&#39;,\n             60,\n             SYSDATE,\n             20);\nINSERT INTO sql04\n     VALUES (2,\n             &#39;11g sql04 02&#39;,\n             &#39;active&#39;,\n             100,\n             SYSDATE,\n             40);\nCOMMIT;\n--1.4\n\nSELECT * FROM sql03;\nINSERT INTO sql03\n     VALUES (&amp;sql03_id1, &amp;sql03_id2, &amp;sql03_id3);\n\nCOMMIT;\n--1.5\n\nCREATE TABLE sql05\nAS\n    SELECT * FROM sql04;\nDELETE FROM sql05;\nCOMMIT;\n\nSELECT * FROM sql05;\nINSERT INTO sql05\n    SELECT * FROM sql04;\nCOMMIT;\n\nSELECT * FROM sql05;\n\n--1.6\n\nINSERT INTO sql04\n     VALUES (3,\n             &#39;11g sql04 03&#39;,\n             &#39;active&#39;,\n             160,\n             SYSDATE,\n             20);\n\nINSERT INTO sql04\n     VALUES (4,\n             &#39;11g sql04 04&#39;,\n             &#39;active&#39;,\n             220,\n             SYSDATE,\n             40);\n\nCOMMIT;\n\nSELECT * FROM sql04;\n\nINSERT INTO sql05\n    SELECT *\n      FROM sql04\n     WHERE sql04_price &gt; 200;\n\nCOMMIT;\n\nSELECT * FROM sql05;\n</code></pre>\n<h2 id=\"2-使用UPDATE-命令\"><a href=\"#2-使用UPDATE-命令\" class=\"headerlink\" title=\"2 使用UPDATE 命令\"></a>2 使用UPDATE 命令</h2><h3 id=\"2-1-语法\"><a href=\"#2-1-语法\" class=\"headerlink\" title=\"2.1 语法\"></a>2.1 语法</h3><pre><code class=\"sql\">UPDATE 表名称SET 列名称= 新值&lt;WHERE 条件&gt;\n</code></pre>\n<h3 id=\"2-2-基本使用\"><a href=\"#2-2-基本使用\" class=\"headerlink\" title=\"2.2 基本使用\"></a>2.2 基本使用</h3><pre><code class=\"sql\">/* Formatted on 2018/2/12 15:00:37 (QP5 v5.313) */\n--2.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\n--2.2\n\nUPDATE sql02\n   SET sql02_number = 20002\n WHERE sql02_id = 2;\n\nUPDATE sql02\n   SET sql02_status = &#39;no&#39;\n WHERE sql02_id = 2;\n\nSELECT *\n  FROM sql02 commit;\n\n--2.3\n\nSELECT *\n  FROM sql02 update sql02 set sql02_id2=222,sql02_status=&#39;OK&#39; where sql02_id=2;\n--2.4\n\nSELECT *\n  FROM sql04 update sql04\nset (sql04_desc, sql04_count) =\n(select sql04_desc, sql04_count from sql04 where sql04_id = 2)\nwhere sql04_id = 3;\nCOMMIT;\n\nSELECT * FROM sql04\n</code></pre>\n<h2 id=\"3-使用DELETE-命令\"><a href=\"#3-使用DELETE-命令\" class=\"headerlink\" title=\"3 使用DELETE 命令\"></a>3 使用DELETE 命令</h2><h3 id=\"3-1-语法\"><a href=\"#3-1-语法\" class=\"headerlink\" title=\"3.1 语法\"></a>3.1 语法</h3><pre><code class=\"sql\">DELETE FROM &lt;table/view&gt; [WHERE &lt;condition&gt;]\n</code></pre>\n<h3 id=\"3-2-基本使用\"><a href=\"#3-2-基本使用\" class=\"headerlink\" title=\"3.2 基本使用\"></a>3.2 基本使用</h3><pre><code class=\"sql\">--3.1\n\nSELECT *\n  FROM sql02\nFOR UPDATE;\n\nselect * from sql02\n--3.2\nselect * from sql04\ndelete from sql04 where sql04_id=1;\nselect * from sql04\n--3.3\ndelete from sql04 where sql04_id=2 and sql04_id=3;\n\nDELETE FROM sql04\n      WHERE sql04_id IN (2, 3);\n\nDELETE FROM sql04\n      WHERE sql04_price IN (&#39;160&#39;, &#39;100&#39;);\n\nselect * from sql04\n--3.4\nselect * from sql03\ndelete from sql03;\nCOMMIT;\n--truncate table\n</code></pre>\n<h2 id=\"4-创建PL-SQL-对象\"><a href=\"#4-创建PL-SQL-对象\" class=\"headerlink\" title=\"4 创建PL/SQL 对象\"></a>4 创建PL/SQL 对象</h2><h3 id=\"4-1-语法\"><a href=\"#4-1-语法\" class=\"headerlink\" title=\"4.1 语法\"></a>4.1 语法</h3><pre><code class=\"sql\">/* Formatted on 2018/2/12 15:01:26 (QP5 v5.313) */\nSELECT * FROM yg;\n\n--创建\n\nCREATE OR REPLACE PROCEDURE yg_count\nAS\n    v_yg_count1   NUMBER (10);\n    v_yg_count2   NUMBER (10);\nBEGIN\n    SELECT COUNT (*) INTO v_yg_count1 FROM yg;\n    DELETE FROM yg\n          WHERE job_id = &#39;SH_CLERK&#39;;\n    SELECT COUNT (*) INTO v_yg_count2 FROM yg;\n    DBMS_OUTPUT.put_line (&#39;离职前的员工数：&#39; || v_yg_count1);\n    DBMS_OUTPUT.put_line (&#39;离职后的员工数：&#39; || v_yg_count2);\nEND;\n/\n\nSET SERVEROUTPUT ON;\nEXECUTE yg_count;\n--离职前的员工数：107\n--离职后的员工数：97\n\n--删除\nDROP PROCEDURE yg_count;\n</code></pre>\n<h2 id=\"5-事务概念与控制\"><a href=\"#5-事务概念与控制\" class=\"headerlink\" title=\"5 事务概念与控制\"></a>5 事务概念与控制</h2><h3 id=\"5-1-事务说明\"><a href=\"#5-1-事务说明\" class=\"headerlink\" title=\"5.1 事务说明\"></a>5.1 事务说明</h3><pre><code class=\"sql\">\n    事务是对数据库操作的逻辑单位，在一个事务中可以包含一条或多条DML （数据操纵语言）、DDL （数据定义语言）和DCL （数据控制语言）语句，这些语句组成一个逻辑整体。\n    事务的执行只有两种结果：要么全部执行，把数据库带入一个新的状态，要么全部不执行，对数据库不做任何修改。\n    一组SQL,一个逻辑工作单位，执行时整体修改或者整体回退。\n</code></pre>\n<h3 id=\"5-2-事务相关概念\"><a href=\"#5-2-事务相关概念\" class=\"headerlink\" title=\"5.2 事务相关概念\"></a>5.2 事务相关概念</h3><pre><code class=\"sql\">1）事务的提交和回滚：COMMIT/ROLLBACK\n2）事务的开始和结束\n    开始事务：连接到数据库，执行DML、DCL、DDL 语句\n    结束事务：1. 执行DDL(例如CREATE TABLE),DCL(例如GRANT),系统自动\n\n执行COMMIT 语句\n\n2. 执行COMMIT/ROLLBACK\n3. 退出/断开数据库的连接自动执行COMMIT 语句\n4. 进程意外终止，事务自动rollback\n5. 事务COMMIT 时会生成一个唯一的系统变化号（SCN）保存\n到事务表\n3）保存点（savepoint）： 可以在事务的任何地方设置保存点，以便ROLLBACK\n4）事务的四个特性ACID :\n    1. Atomicity（原子性）: 事务中sql 语句不可分割，要么都做，要么都不做\n    2. Consistency(一致性) ： 指事务操作前后，数据库中数据是一致的，数据\n满足业务规则约束（例如账户金额的转出和转入），与原子性对应。\n    3. Isolation（隔离性）：多个并发事务可以独立运行，而不能相互干扰，一\n个事务修改数据未提交前，其他事务看不到它所做的更改。\n    4. Durability（持久性）：事务提交后，数据的修改是永久的。\n5） 死锁：当两个事务相互等待对方释放资源时，就会形成死锁。\n</code></pre>\n<h3 id=\"5-3-oracle-事务隔离级别\"><a href=\"#5-3-oracle-事务隔离级别\" class=\"headerlink\" title=\"5.3 oracle 事务隔离级别\"></a>5.3 oracle 事务隔离级别</h3><ul>\n<li>1 .两个事务并发访问数据库数据时可能存在的问题</li>\n</ul>\n<pre><code class=\"sql\">1. 幻想读：\n    事务T1 读取一条指定where 条件的语句，返回结果集。此时事务T2 插入一行新记录并commit，恰好满足T1 的where 条件。然后T1 使用相同的条件再次查\n询，结果集中可以看到T2 插入的记录，这条新纪录就是幻想。\n2. 不可重复读取：\n    事务T1 读取一行记录，紧接着事务T2 修改了T1 刚刚读取的记录并commit，然后T1 再次查询，发现与第一次读取的记录不同，这称为不可重复读。\n3. 脏读：\n    事务T1 更新了一行记录，还未提交所做的修改，这个T2 读取了更新后的数\n据，然后T1 执行回滚操作，取消刚才的修改，所以T2 所读取的行就无效，也就是脏数据。\n</code></pre>\n<ul>\n<li>2.oracle 事务隔离级别</li>\n</ul>\n<pre><code class=\"sql\">oracle 支持的隔离级别：（不支持脏读）\nREAD COMMITTED--不允许脏读，允许幻想读和不可重复读\nSERIALIZABLE--以上三种都不允许\nsql 标准还支持READ UNCOMMITTED (三种都允许)和REPEATABLE READ（不允\n许不可重复读和脏读，只允许幻想读）\n</code></pre>\n<ul>\n<li>3.事务相关语句</li>\n</ul>\n<pre><code class=\"sql\">SET TRANSACTION----设置事务属性\nSET CONSTRAINT -----设置约束\nSAVEPOINT ------------建立存储点\nRELEASE SAVEPOINT --释放存储点\nROLLBACK---------------回滚\nCOMMIT------------------提交\n</code></pre>\n<h2 id=\"6-锁的检测和锁争用\"><a href=\"#6-锁的检测和锁争用\" class=\"headerlink\" title=\"6 锁的检测和锁争用\"></a>6 锁的检测和锁争用</h2><h3 id=\"6-1-解决死锁冲突\"><a href=\"#6-1-解决死锁冲突\" class=\"headerlink\" title=\"6.1 解决死锁冲突\"></a>6.1 解决死锁冲突</h3><ul>\n<li>1）执行commit 或者rollback 结束事务<br><code>`</code>sql</li>\n</ul>\n<pre><code>* 2）终止会话\n```sql\n在等待资源时执行，查找阻塞会话\n\nSELECT sid, serial#, username\n  FROM v$session\n WHERE sid IN (SELECT blocking_session FROM v$session);\n\n杀掉会话\n\nALTER SYSTEM KILL SESSION &#39;111,222&#39;;\n\n关于查看锁的一些视图\n\nSELECT * FROM V$SESSION;                        --查看会话和锁的信息\nSELECT * FROM V$SESSION_WAIT;                             --查看等待的会话信息\nSELECT * FROM V$LOCK;                     --系统中所有锁\nSELECT * FROM V$LOCKED_OBJECT;                              --系统中DML 锁\nSELECT l.sid, s.SERIAL#, sq.sql_text\n  FROM v$lock l, v$session s, v$sql sq\n WHERE l.sid = s.sid AND s.sql_id = sq.sql_id AND s.status = &#39;ACTIVE&#39;\nalter system kill session &#39;139,1431&#39;\n</code></pre><h2 id=\"7-了解撤销数据UNDO\"><a href=\"#7-了解撤销数据UNDO\" class=\"headerlink\" title=\"7 了解撤销数据UNDO\"></a>7 了解撤销数据UNDO</h2><h3 id=\"7-1-查看近来数据库生成的撤销数据量\"><a href=\"#7-1-查看近来数据库生成的撤销数据量\" class=\"headerlink\" title=\"7.1 查看近来数据库生成的撤销数据量\"></a>7.1 查看近来数据库生成的撤销数据量</h3><pre><code class=\"sql\">ALTER SESSION SET nls_date_format = &#39;dd-mm-yy hh24:mi:ss&#39;;\nSELECT begin_time,\nend_time,\n(undoblks *\n(SELECT VALUE FROM v$parameter WHERE NAME = &#39;db_block_size&#39;))\nundo_bytes\nFROM v$undostat;\n</code></pre>\n"},{"title":"Oracle之DDL和对象管理","date":"2018-10-02T06:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n\n# SQL语言之DDL和对象管理\n\n[Oracle 11G R2 官方文档][1]\n\n## 1 介绍用户模拟下可以访问的模式对象\n```sql\n  SELECT object_type, COUNT (*)\n    FROM user_objects\nGROUP BY object_type;\n\n  SELECT object_type, COUNT (*)\n    FROM all_objects\nGROUP BY object_type;\n\nSELECT DISTINCT owner\n  FROM all_objects\n```\n\n## 2 研究模式中的数据类型\n```sql\n-- 1.DESC\n-- 2.SQL\nSELECT column_name, data_type\n  FROM user_tab_columns\n WHERE table_name = 'EMPLOYEES';\n\nSELECT DISTINCT data_type\n  FROM user_tab_columns\n WHERE table_name = 'EMPLOYEES';\n```\n## 3 表的创建与管理\n### 3.1 表的创建\n* 语法\n\n```sql\nCreate table [schema,] table_name(\ncolumn_name data_type [default express] [constraint]\n[,column_name data_type [default express] [constraint]]\n[,column_name data_type [default express] [constraint]]\n);\n\n\n--1.表的创建与结构变更\n--01.工具\n--A：创建表\n--B：写入数据\n--C：更改结构\n```\n* SQL 语法\n\n```sql\n--创建sql02,sql03,sql04\n --创建sql02,sql03,sql04\n\nCREATE TABLE SQL02\n(\n    sql02_id        NUMBER (8) NOT NULL,\n    sql02_id2       NUMBER (8) NOT NULL,\n    sql02_date      DATE NOT NULL,\n    sql02_status    VARCHAR2 (8) NOT NULL,\n    sql02_number NUMBER (10, 2)\n);\n\nCREATE TABLE SQL03\n(\n    sql03_id1    NUMBER (8) NOT NULL,\n    sql03_id2    NUMBER (8) NOT NULL,\n    sql03_id3    NUMBER (8) NOT NULL\n);\n\nALTER TABLE sql03\n    MODIFY (sql03_id3 VARCHAR2 (10));\n\nCREATE TABLE SQL04\n(\n    sql04_id        NUMBER (8) NOT NULL,\n    sql04_desc      VARCHAR2 (20) NOT NULL,\n    sql04_status    VARCHAR2 (8) NOT NULL,\n    sql04_price     NUMBER (10, 2) NOT NULL,\n    sql04_date      DATE NOT NULL,\n    sql04_count     NUMBER (8) NOT NULL\n);\n\n```\n### 3.2 表的重命名\n```sql\nRENAME sql044 TO sql04;\n\nALTER TABLE SQL04\n    MODIFY sql04_count NUMBER (18);\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count TO SQL04_COUNT2;\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count02 TO SQL04_COUNT;\n\nSELECT * FROM tab \nSELECT * FROM user_tables\n```\n### 3.3 表的复制\n```sql\nCREATE TABLE itpux05\nAS\n    SELECT * FROM sql04;\n\nSELECT * FROM sql01;\n\nCREATE TABLE itpux06\nAS\n    SELECT *\n      FROM sql01\n     WHERE sql01_id = 1;\n\nSELECT * FROM itpux06\n```\n### 3.4 表的截断\n```sql\n--100g delete 2h,truncate 2 分钟。\nTRUNCATE TABLE itpux07;\nSELECT * FROM itpux07\n```\n### 3.4 表的删除\n```sql\nDROP TABLE itpux06;\n```\n### 3.4 .删除表的定义\n```sql\nDROP TABLE table_name CASCADE CONSTRAINTS;              --相关的视图，约束，等相关所有的关系对象。\nDROP TABLE table_name PURGE;                            --释放资源，不经过回收站。\nDROP TABLE itpux05 CASCADE CONSTRAINTS;\nDROP TABLE itpux05 PURGE;\n```\n## 4 簇的概念与介绍\n>簇(cluster)其实就是一组表，由一组共享相同数据块的多个表组成，将经常一起使用的表\n组合在一起成簇可以提高处理效率；在一个簇中的表就叫做簇表。\n\n* 不宜用聚簇表的情况\n\n```sql\n1)如果预料到聚簇中的表会大量修改,聚簇表会对DML 的性能产生负面影响\n2)非常不适合对单表的全表扫描,因为只能引起对其它表的全表扫描\n3)频繁对表进行TRUNCATE 和加载,因为聚簇中的表是不能TRUNCATE 的，只能\nTRUNCATE 簇\n4)如果表只是偶尔被连接或者它们的公共列经常被修改，则不要聚簇表\n5)如果经常从所有有相同聚簇键值的表查询出的结果数据超过一个或两个Oracle 块，\n则不要聚簇表\n6)如果空间不够，并且不能为将要插入的新记录分配额外的空间，那么不要使用聚簇\n```\n## 5 临时表的创建与使用\n### 5.1 会话级临时表\n```sql\n--会话结束自动清空数据\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit preserve rows;\n```\n\n### 5.2 事务级临时表\n```sql\n--事务结束（commit,rollback） ，清除数据。\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit delete rows;\n```\n\n## 6 索引的创建与管理\n## 6.1 索引分类\n* 逻辑分类\n```sql\n1.单列或多列\n2.唯一索引和非唯一索引\n3.函数索引\nDoman\n```\n\n* 物理分类\n```sql\n物理分类:\nB-TREE\nBitmap\n\nB*Tree 索引\nB*Tree 索引是最常见的索引结构，默认建立的索引就是这种类型的索引。\n\nDML 语句：\nCreate index indexname on tablename(columnname[columnname...])\nBitmap 索引\n位图索引主要用于决策支持系统或静态数据，不支持行级锁定\n```\n## 6.2 索引的日常管理\n* 基本语法\n```sql\nCREATE [UNIQUE] | [BITMAP] INDEX index_name --unique 表示唯一索引\nON table_name([column1 [ASC|DESC],column2 --bitmap，创建位图索引\n[ASC|DESC],…] | [express])\n[TABLESPACE tablespace_name]\n[PCTFREE n1] --指定索引在数据块中空闲空间\n[STORAGE (INITIAL n2)]\n[NOLOGGING] --表示创建和重建索引时允许\n对表做DML 操作，默认情况下不应该使用\n[NOLINE]\n[NOSORT]; --表示创建索引时不进行排序，\n默认不适用，如果数据已经是按照该索引顺序排列的可以使用\n```\n\n* 1.添加/创建索引\n```sql\n--工具\n\nCREATE INDEX cust_name_i1\n    ON SQL01 (sql01_name);       --单列索引\n\nCREATE INDEX cust_name_i1\n    ON SQL01 (sql01_name)\n    TABLESPACE ITPUX;            --单列\n索引指定表空间\n--命令\n\nCREATE INDEX cust_name_i2\n    ON sql01 (sql01_name, sql01_status);    --组合索引\n\nCREATE BITMAP INDEX sql01_level_i3\n    ON sql01 (sql01_level);      --位图索引\n```\n\n* 2.修改索引\n```sql\n--重命名索引\n\nALTER INDEX cust_name_i1\n    RENAME TO idx1_sql01_name;\n\n--合并索引\n\nALTER INDEX idx1_sql01_name\n    COALESCE;\n```\n\n* 3.重建索引\n```sql\n--重命名索引\n\n--删除原来的索引，重新建立索引。\nDROP INDEX idx1_sql01_name;\n\nCREATE INDEX idx1_sql01_name\n    ON SQL01 (sql01_name);\n\n--直接rebuild\n\nALTER INDEX idx1_sql01_name\n    REBUILD;                                    --会锁表。\n\nALTER INDEX idx1_sql01_name\n    REBUILD ONLINE;\n```\n\n* 4.删除索引\n```sql\nDROP INDEX idx1_sql01_name;\n```\n\n* 5.查看索引\n```sql\n--select * from user_indexes;\n\nSELECT *\n  FROM dba_indexes\n WHERE owner = 'ITPUX';\n\nSELECT *\n  FROM dba_indexes\n WHERE table_name = 'SQL01';\n\n--select * from all_indexes;\n--select * from user_ind_columns;\n\nSELECT *\n  FROM dba_ind_columns\n WHERE index_owner = 'ITPUX' AND table_name = 'SQL01';\n\n--select * from all_ind_columns;\n\nSELECT index_name,\n       column_name,\n       index_type,\n       uniqueness,\n       tablespace_name\n  FROM dba_indexes NATURAL JOIN dba_ind_columns\n WHERE table_name = 'SQL01';\n```\n## 7 约束的创建与管理\n### 7.1  5种约束\n\n* 1.not null (非空约束)\n```sql\n--1.1 创建表的时候\n\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n\n--1.2 在已经创建的表加添加\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    MODIFY id NOT NULL;\n\n--1.3 验证。\n\nINSERT INTO itpux02\n     VALUES (NULL, 'name');\n\nINSERT INTO itpux02\n     VALUES (1, 'name');\n\nSELECT * FROM itpux02;\n\n--1.4 删除\n\nALTER TABLE itpux02\n    MODIFY id NULL;\n\nINSERT INTO itpux02\n     VALUES (NULL, 'name');\n\nSELECT * FROM itpux02;\n\nINSERT INTO itpux02\n     VALUES (2, 'name');\n```\n* 2.primary key 约束\n```sql\nDROP TABLE itpux01;\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n--1.2 在已经创建的表加添加\nDROP TABLE itpux02;\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    ADD CONSTRAINT itpux02_id_con PRIMARY KEY (id); --建议命名\n--alter table itpux02 drop constraint itpux02_id_con;\n\nALTER TABLE itpux02\n    ADD PRIMARY KEY (id);\n\n--1.3 删除\n\nALTER TABLE itpux02\n    DROP CONSTRAINT itpux02_id_con;\n\nALTER TABLE itpux02\n    DROP CONSTRAINT SYS_C0011169;\n```\n\n* 3.unique 约束\n```sql\n--3.1 创建表的时候\n\nCREATE TABLE itpux03\n(\n    id      NUMBER NOT NULL,\n    name    VARCHAR2 (20) UNIQUE\n);\n\nINSERT INTO itpux03\n     VALUES (1, 'name1');\n\nINSERT INTO itpux03\n     VALUES (2, 'name2');\n\n--3.2 删除\n\nALTER TABLE itpux03\n    DROP UNIQUE (name);\n\nINSERT INTO itpux03\n     VALUES (3, 'name2');\n\n--3.3 后期添加\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n\nDELETE FROM itpux03\n      WHERE id = 3;\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n```\n\n* 4.Check 约束\n```sql\n  --4.1 新建表添加约束\n\nCREATE TABLE itpux04\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux04_age_con CHECK (age > 17)\n);\n\nINSERT INTO itpux04\n     VALUES (1, 'mm', 16);\n\nINSERT INTO itpux04\n     VALUES (2, 'mm', 18);\n\n--4.2 删除\n\nALTER TABLE itpux04\n    DROP CONSTRAINT itpux04_age_con;\n\n--4.3 后期\nalter table itpux04 add constraint itpux04_age_con check(age>17);\n```\n\n* 5.Foreign key 约束\n```sql\nCREATE TABLE itpux051\n(\n    jobid    NUMBER NOT NULL PRIMARY KEY,\n    name1 VARCHAR2 (20),\n    age NUMBER (3)\n);\n\nCREATE TABLE itpux052\n(\n    no      NUMBER NOT NULL PRIMARY KEY,\n    dcname VARCHAR2 (20),\n    dcid    NUMBER REFERENCES itpux051 (jobid)\n);\n\nINSERT INTO itpux052\n     VALUES (1, 'dc1008', 20161218);                                                  --error\n\nINSERT INTO itpux051\n     VALUES (20161218, '风哥', 31);\n\nINSERT INTO itpux052\n     VALUES (1, 'dc1008', 20161218);\n\nSELECT * FROM itpux051;\n\nSELECT * FROM itpux052;\n\n--删除\n\nALTER TABLE itpux052\n    DROP CONSTRAINT SYS_C0011182;\n\nDROP TABLE itpux051;\nDROP TABLE itpux051 CASCADE CONSTRAINTS;\n--后期增加\n\nALTER TABLE itpux052\n    ADD CONSTRAINT itpux052_dcid_con FOREIGN KEY (dcid)\n        REFERENCES itpux051 (jobid);\n```\n\n### 7.1  约束的管理\n\n* 1.约束表级定义与列级定义\n```sql\n  --1.1 表级定义\nCREATE TABLE itpux08\n(\n    id NUMBER (8),\n    name VARCHAR2 (50),\n    CONSTRAINT pk_itpux08_id PRIMARY KEY (id)\n);\n\n--1.2 列级定义\nCREATE TABLE itpux09\n(\n    id    NUMBER (8) CONSTRAINT pk_itpux09_id PRIMARY KEY,\n    name VARCHAR2 (50)\n);\n```\n\n* 2.约束的disable/enable,validate/novalidate 的区别\n```sql\n--disable 禁用\n--disable validate --关闭后，不能增删改\n--disable novalidate --关闭后，可以增删改\n--enable 启用\n--enable validate --启用后，进行所有约束，有的，新加的\n--enable novalidate --启用后，对新加入的约束，对旧的不约束\n--2.1 非主键的\n\nCREATE TABLE itpux06\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux06_age_con CHECK (age > 17)\n);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;   --novalidate\n\nINSERT INTO itpux06\n     VALUES (2, 'name2', 18);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nALTER TABLE itpux06\n    DISABLE VALIDATE CONSTRAINT itpux06_age_con;                                                                 --validate\n\nINSERT INTO itpux06\n     VALUES (3, 'name3', 18);              --error\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nINSERT INTO itpux06\n     VALUES (3, 'name3', 18);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;    --novalidate\n\nINSERT INTO itpux06\n     VALUES (4, 'name4', 16);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --errpr\n\nALTER TABLE itpux06\n    ENABLE NOVALIDATE CONSTRAINT itpux06_age_con;\n\n--2.2 主键的\n\nCREATE TABLE itpux07\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux07\n    ADD CONSTRAINT itpux07_id_con PRIMARY KEY (id);\n\nINSERT INTO itpux07\n     VALUES (1, 'name1');\n\nALTER TABLE itpux07\n    DISABLE CONSTRAINT itpux07_id_con;    --novalidate\n\nINSERT INTO itpux07\n     VALUES (1, 'name2');\n\nSELECT * FROM itpux07;\n\nALTER TABLE itpux07\n    ENABLE CONSTRAINT itpux07_id_con;    --error\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --error\n\nCREATE INDEX idx_itpux07_id\n    ON itpux07 (id);\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --ok\n\nSELECT * FROM itpux07;\n```\n### 7.3 显示约束的信息\n* 1.约束的数据字典\n```sql\nselect * from all_constraints;\nselect * from dba_constraints;\nselect * from user_constraints;\nselect distinct constraint_type from user_constraints ;\n-- R references : column\n-- U unique : column\n-- P primary key : column\n-- C check : column\n-- O read only on a view : object\n-- V Check on a view : object\nselect * from all_cons_columns;\nselect * from dba_cons_columns;\nselect * from user_cons_columns;\nselect * from dba_constraints where table_name='ITPUX08';\n```\n\n* 2.约束的可延迟属性\n```sql\nselect * from dba_constraints where table_name='ITPUX08';\n\n--DEFERRABLE(延迟条件): NOT DEFERRABLE(默认，立即验证), DEFERRABLE（提\n交时验证）\n--DEFERRED ： IMMEDIATE(默认，立即验证)，DEFERRED（提交时才验证）,\n--set constraint 名字immediate;\n--用途：物化视图，级联更新。\n\ncreate table itpux10(\nid number not null primary key DEFERRABLE initially IMMEDIATE,\nname varchar2(20),\nage number constraint itpux10_age_con check(age>17) DEFERRABLE\ninitially DEFERRED);\n\nselect * from dba_constraints where table_name='ITPUX10';\n```\n## 8 视图的创建与管理\n### 8.1 语法\n```sql\nCREATE [OR REPLACE] [FORCE|NOFORCE] VIEW view_name\n[(alias[, alias]...)]\nAS subquery\n[WITH CHECK OPTION [CONSTRAINT constraint]]\n[WITH READ ONLY]\nOR REPLACE ：若所创建的试图已经存在，ORACLE 自动重建该视图；\nFORCE ：不管基表是否存在ORACLE 都会自动创建该视图；\nNOFORCE ：只有基表都存在ORACLE 才会创建该视图：\nalias ：为视图产生的列定义的别名；\nsubquery ：一条完整的SELECT 语句，可以在该语句中定义别名；\nWITH CHECK OPTION ：插入或修改的数据行必须满足视图定义的约束；\nWITH READ ONLY ：该视图上不能进行任何DML 操作。\n-- O read only on a view : object\n-- V Check OPTION on a view : object\n```\n## 9 同义词创建和使用\n```sql\n--1.创建同义词\ncreate synonym yg_s for yg_v;\ncreate synonym bm_s for bm_v;\ncreate synonym bm_sum_s for bm_sum_v;\nselect * from yg_s;\nselect * from bm_s;\ndrop view yg_v;\ndrop view bm_v;\nalter view bm_sum_v compile;\ndrop view bm_sum_v;\nalter synonym yg_s compile;\n\n--2.删除同义词\ndrop synonym yg_s;\ndrop synonym bm_s;\ndrop synonym bm_sum_s;\n\n--3.查看同义词\nselect * from dba_synonyms where owner='ITPUX';\nselect * from all_synonyms\nselect * from user_synonyms\nselect * from scott.emp;\ncreate synonym emp_s for scott.emp;\nselect * from emp_s;\ncreate table emp as select * from scott.emp;\nselect * from emp;\n\n--4.权限\ngrant create synonym to itpux01;\ngrant create any synonym to itpux01;\ngrant create public synonym to itpux01;\n```\n\n## 10 序列创建和使用.\n### 10.1 语法\n```sql\n创建序列：\n1、要有创建序列的权限create sequence 或create any sequence\n2、创建序列的语法\nCREATE SEQUENCE sequence //创建序列名称\n\t\t[INCREMENT BY n] //递增的序列值是n 如果n 是正数就递增,如果是负数\n\t\t就递减默认是1\n\t\t[START WITH n] //开始的值,递增默认是minvalue 递减是maxvalue\n\t\t[{MAXVALUE n | NOMAXVALUE}] //最大值\n\t\t[{MINVALUE n | NOMINVALUE}] //最小值\n\t\t[{CYCLE | NOCYCLE}] //循环/不循环\n\t\t[{CACHE n | NOCACHE}];//分配并存入到内存中\n\tNEXTVAL 返回序列中下一个有效的值，任何用户都可以引用\n\tCURRVAL 中存放序列的当前值\n\tNEXTVAL 应在CURRVAL 之前指定，二者应同时有效\n```\n\n### 10.2 日常使用\n```sql\n--创建普通序列\ncreate sequence seql start with 10 nocache maxvalue 15 cycle;\ncreate sequence seql1\n--创建一个带主键的表\ndrop table seqtest\ncreate table seqtest(\n\tc1 number,\n\tc2 varchar2(10)\n);\nalter table seqtest add constraint seqtest_pk primary key (c1);\ncreate sequence seq_test_pk_s\n\tminvalue 1\n\tmaxvalue 9999999999999999\n\tstart with 1\n\tincrement by 1\n\tcache 20;\n--间断\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,'11');\ncommit;\n\nB:\ninsert into seqtest values (seq_test_pk_s.nextval,'22');\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,'33');\ncommit;\nselect * from seqtest;\nB:\nrollback;\nselect * from seqtest;\n--删除\ndrop table seqtest\ndrop sequence SEQ_TEST_PK_S\n```\n\n## 11 存储过程创建和使用\n### 11.1 语法\n```sql\nCREATE [OR REPLACE] PROCEDURE procedure_name\n[(parameter1[model] datatype1, parameter2 [model] datatype2..)]\nIS[AS]\nBEGIN\nPL/SQL;\nEND [procedure_name];\n```\n### 11.2日常使用\n```sql\n--1.编写存储过程\n--显示当前系统时间\n--通过pl/sql dev 菜单\n--手写\ncreate or replace procedure print_sysdate\nis\nbegin\n\tdbms_output.put_line(sysdate);\n\tend print_sysdate;\n/\n--2.存储过程的调用\n--sqlplus,pl/sql 代码块\nexec print_sysdate;\n--set serverout on;\n--exec print_sysdate();\n\n--3.存储过程的删除\ndrop procedure test1;\n--4.编译存储过程\n--界面\n--命令\nalter procedure print_sysdate compile;\n\n\n--5.查询存储过程\nselect * from dba_objects where object_type='PROCEDURE' and\nowner='ITPUX';\nselect * from all_objects where object_type='PROCEDURE' and owner='ITPUX';\nselect * from user_objects where object_type='PROCEDURE';\n\n--6.查看存储过程的内容\n--界面\n--命令\nselect * from user_source where name='PRINT_SYSDATE';\nselect * from dba_source where owner='ITPUX' and name='PRINT_SYSDATE';\nselect * from all_source;\nselect text from user_source where name='PRINT_SYSDATE';\nselect * from dba_source where type='PROCEDURE' and text like '%sysdate%';\n```\n\n### 11.3 存储过程中事务处理\n* 存储过程中事务处理\n```sql\n--案例1 显示YG 表中员工人数的存储过程。\ncreate or replace procedure yg_count\nas\nv_total number(10);\nbegin\n\tselect count(*) into v_total from yg;\n\tdbms_output.put_line('员工总人数为：'||v_total);\nend;\nset serverout on;\nexecute yg_count;\n--员工总人数为：107\n\n--案例2 存储过程中的增删改DML 事务操作。\n--准备\ncreate table itpux_st(id int,name varchar2(10));\ninsert into itpux_st values(1,'itpux01');\ninsert into itpux_st values(2,'itpux02');\ncommit;\n\n--2.1 增加\n--创建过程\ncreate or replace procedure pro_insert\n(v_id int,v_name varchar2)\nis\nbegin\n\tinsert into itpux_st values(v_id,v_name);\ncommit;\nend;\n--执行\nbegin\n\tpro_insert(3,'itpux03');\nend;\n--检查\nselect * from itpux_st;\n\n--2.2 删除\n--创建过程\ncreate or replace procedure pro_delete\n(v_id int)\nis\nbegin\n\tdelete from itpux_st where id=v_id;\ncommit;\nend;\n--执行\nbegin\npro_delete(3);\nend;\n--检查\nselect * from itpux_st;\n\n--2.3 更新/更改\n--创建过程\ncreate or replace procedure pro_update\n(v_id int,v_name varchar2)\nis\nbegin\n\tupdate itpux_st set name=v_name where id=v_id;\ncommit;\nend;\n--执行\nbegin\n\tpro_update(2,'itpux02222');\nend;\n--检查\nselect * from itpux_st;\n\n--2.4 查询\n--创建过程\ncreate or replace procedure pro_select\n(v_id int) --定义输入变量\nis\n\tv_name varchar2(10);--定义输出变量\nbegin\n\tselect name into v_name from itpux_st where id=v_id;--执行查询\n\tdbms_output.put_line('学生姓名为：'||v_name);--输出结果\nend;\n--执行\n--set serverout on;\nbegin\npro_select(2);\nend;\n```\n\n## 12 触发器创建和使用\n* 1.触发器的语法\n```sql\nCREATE [OR REPLACE] TIGGER 触发器名触发时间触发事件\n\tON 表名/视图名\n\t[FOR EACH ROW] //加上FOR EACH ROW 即为行级触发器，不加时为语句\n\t级触发器\n\tBEGIN\n\tpl/sql 语句\n\tEND\n```\n### 12.1 DML 触发器及案例\n* 语法\n```sql\ncreate [or replace] trigger 触发器名称\n\t{before|after}\n\t{insert|delete|update[of column [,column...]]}\n\tor {insert|delete|update[of column [,column...]]}\n\ton [schema.] 表名|[schema.]视图\n\t[for each row]\n\t[when condition]\nbegin\n执行语句;\nend;\n```\n\n* 1.设置一个添加记录就提示的触发器\n```sql\ncreate or replace trigger t1\nafter insert on itpux.emp\n\tbegin\n\t\tdbms_output.put_line('你向ITPUX.EMP 表中添加了一条数据');\n\tend;\n/\n\n--验证\n--set serverout on\ninsert into emp values('8000','itpux15','DBA','8001',sysdate,'15000','0','30');\ninsert into emp values('8002','itpux16','DBA','8002',sysdate,'15000','0','30');\n--你向ITPUX.EMP 表中添加了一条数据\n```\n* 2.设置一个更改记录就提示的触发器\n```sql\ncreate or replace trigger t_update\nafter update on itpux.emp\nfor each row --提示每一条修改的记录\n\tbegin\n\tdbms_output.put_line('你修改了ITPUX.EMP 表中多条数据');\n\tend;\n/\n--验证\n--set serverout on\nselect * from emp;\nupdate emp set job='DBA+SA+HR' where ENAME in ('itpux15','itpux16');\n--你修改了ITPUX.EMP 表中多条数据\n```\n\n* 3.设置一个删除记录就提示的触发器\n```sql\ncreate or replace trigger t_delete\nbefore delete on itpux.emp\nbegin\n--select to_char(sysdate,'day') from dual;\nif to_char(sysdate,'day') in ('星期六','星期天') then\n\tdbms_output.put_line('禁止在周末删除ITPUX.EMP 表数据');\n\traise_application_error(-20001,'禁止在周末删除ITPUX.EMP 表数据'); --\n-20000~20999\nend if;\nend;\n/\n--验证\n--set serverout on\ndelete from emp;\n--ORA-20001: 禁止在周末删除ITPUX.EMP 表数据\n```\n\n### 12.2 DDL 触发器及案例\n* 语法\n```sql\ncreate or replace trigger ddl 触发器名称\nafter ddl on 方案名.schema\nbegin\n\t执行语句;\nend;\n```\n* 基本使用\n```sql\n--SYSTEM 用户\ndrop table itpux_ddl01\ncreate table itpux_ddl01\n(\n\tdbname varchar2(100),\n\tevent varchar2(100),\n\tusername varchar2(30),\n\tclient_ip varchar2(100),\n\tddl_time date\n);\ncreate or replace trigger t_itpux_ddl01\nafter ddl on itpux.schema\nbegin\n\tinsert into itpux_ddl01 values(ora_database_name,ora_sysevent,ora_login_user,ora_client_ip_address,\n\tsysdate);\nend;\n--切换至ITPUX 用户\ncreate table itpux012(id number);\nselect * from system.itpux_ddl01;\n```\n### 12.3 参考资料\n```sql\n系统触发器创建基本语法：\ncreate or replace trigger 系统触发器名称\nafter[before] logon[logoff] on datebase\nbegin\n\t执行语句;\nend;\n\n详细说明：\nafter 事件之后触发\nbefore 事件之前触发\nlogon 登陆触发\nlogoff 登出触发\nstartup 开启系统触发\nshutdown 关闭系统触发\n```\n```sql\n------------------------------参考资料---------------------------------------\n下面介绍一些常用的系统事件属性函数，和建立各种事件触发器的方法在建立系统事\n件触发器时，需要使用事件属性函数，\n常用的事件属性函数如下：\nora_client_ip_address //返回客户端的ip\nora_database_name //返回数据库名称\nora_login_user //返回登陆用户名\nora_sysevent //返回触发器的系统事件名\nora_des_encrypted_password //返回用户des(md5)加密后的密码\n事件属性函数表\nOra_client_ip_address 返回客户端的ip 地址\nOra_database_name 返回当前数据库名\nOra_des_encrypted_password 返回des 加密后的用户口令\nOra_dict_obj_name 返回ddl 操作所对应的数据库对象名\nOra_dict_obj_name_list(name_list out ora_name_list_t)返回在事件中被修改的对\n象名列表\nOra_dict_obj_owner 返回ddl 操作所对应的对象的所有者名\nOra_dict_obj_owner_list(owner_list out ora_name_list_t)返回在事件中被修改的对\n象的所有者列表\nOra_dict_obj_type 返回ddl 操作所对应的数据库对象的类型\nOra_grantee(user_list out ora_name_list_t)返回授权事件的授权者\nOra_instance_num 返回例程号\nOra_is_alter_column(column_name in varchar2)检测特定列是否被修改\nOra_is_creating_nested_table 检测是否正在建立嵌套表\nOra_is_drop_column(column_name in varchar2)检测特定列是否被删除\nOra_is_servererror(error_number)检测是否返回了特定oracle 错误\nOra_login_user 返回登录用户名\nOra_sysevent 返回触发器的系统事件名\n系统触发器的种类和事件出现的时机（前或后）：\n事件允许的时机说明\nSTARTUP AFTER 启动数据库实例之后触发\nSHUTDOWN BEFORE 关闭数据库实例之前触发（非正常关闭不触发）\nSERVERERROR AFTER 数据库服务器发生错误之后触发\nLOGON AFTER 成功登录连接到数据库后触发\nLOGOFF BEFORE 开始断开数据库连接之前触发\nCREATE BEFORE，AFTER 在执行CREATE 语句创建数据库对象之前、之后\n触发\nDROP BEFORE，AFTER 在执行DROP 语句删除数据库对象之前、之后触发\nALTER BEFORE，AFTER 在执行ALTER 语句更新数据库对象之前、之后触发\nDDL BEFORE，AFTER 在执行大多数DDL 语句之前、之后触发\nGRANT BEFORE，AFTER 执行GRANT 语句授予权限之前、之后触发\nREVOKE BEFORE，AFTER 执行REVOKE 语句收权限之前、之后触犯发\nRENAME BEFORE，AFTER 执行RENAME 语句更改数据库对象名称之前、之\n后触犯发\nAUDIT/NOAUDIT BEFORE，AFTER 执行AUDIT 或NOAUDIT 进行审计或停\n止审计之前、之后触发\n特别说明：系统触发器的级别较高，由系统管理员来创建。\n------------------------------------------------------------------------------------\n```\n\n### 12.4 数据库系统触发器\n\n* 1.创建\n```sql\n--记录登录数据库的用户名和IP\ncreate table login_info (ip varchar(30),username varchar(30));\ncreate or replace trigger logon_ip_info\nafter logon on database\ndeclare\n\tip varchar(30);\n\tuser varchar(30);\nbegin\n\tselect sys_context('USERENV','SESSION_USER') into user from dual;\n\tselect sys_context('USERENV','ip_address') into ip from dual;\n\tinsert into login_info values(ip,user);\nend;\n/\n\nselect * from login_info;\n```\n* 2. 管理\n```sql\n--禁用\nalter trigger logon_ip_info disable;\n--启用\nalter trigger logon_ip_info enable;\n--编译\nalter trigger logon_ip_info compile;\n--删除\ndrop trigger logon_ip_info;\n--查询\nselect * from dba_objects where owner='ITPUX' and object_type='TRIGGER';\ndrop trigger ITPUX.T_UPDATE;\ndrop trigger ITPUX.T_DELETE;\ndrop trigger system.t_itpux_ddl01;\n```\n## 13 包的创建和使用\n\n* 1 包定义（PACKAGE）\n```sql\n2.1 包定义（PACKAGE）\nCREATE [OR REPLACE] PACKAGE package_name\n\t{IS | AS}\n\t[公有数据类型定义]\n\t[公有游标声明]\n\t[公有变量、常量声明]\n\t[公有子程序声明]\n\t[package_name];\n定义包规范:\nCREATE OR REPLACE\npackage p_stu\nas\n--定义结构体\ntype re_stu is record(\n\trname student.name%type,\n\trage student.age%type\n);\n--定义游标\ntype c_stu is ref cursor;\n--定义函数\nfunction numAdd(num1 number,num2 number)return number;\n--定义过程\nprocedure GetStuList(cid in varchar2,c_st out c_stu);\nend;\n```\n* 2. 包主体（PACKAGE BODY）\n```sql\nCREATE [OR REPLACE] PACKAGE BODY package_name\n\t{IS | AS}\n\t[私有数据类型定义]\n\t[私有变量、常量声明]\n\t[私有子程序声明和定义]\n\t[公有子程序定义]\nBEGIN\n执行部分(初始化部分)\nEND [package_name];\n\n--1 创建包\ncreate or replace package itpux_pkg\nis\n\tprocedure update_sal(e_name varchar2,newsal number);\n\tFUNCTION emp_sal_fun(e_name varchar2) return number;\nend;\n--2.3 包体\ncreate or replace package body itpux_pkg is\nprocedure update_sal(e_name varchar2,newsal number)\nis\nbegin\n\tupdate emp set sal=newsal where ename=e_name;\nend;\nfunction emp_sal_fun(e_name varchar2)\nreturn number is\nemp_sal number;\nbegin\n\tselect sal*12+nvl(comm,0) into emp_sal from emp\nwhere ename=e_name;\nreturn emp_sal;\nend;\nend;\n--2.4 执行包-调过程\nset serveroutput on\n\texec itpux_pkg.update_sal('itpux14',2000);\ncommit;\nselect * from emp;\n--查看itpux14 的记录\n--2.5 执行包-调函数\ndeclare\n\tv_emp_sal number(7,2);\nbegin\n\tv_emp_sal:=itpux_pkg.emp_sal_fun('itpux14');\n\tdbms_output.put_line('ITPUX14 的年薪为: '||v_emp_sal);\nend;\n--ITPUX14 的年薪为: 24000\n--2.6 删除包\nselect * from dba_objects where owner='ITPUX' and object_type='PACKAGE';\ndrop package ITPUX_PKG;\ndrop package ITPUXA_PKG;\n```\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle之DDL和对象管理.md","raw":"---\ntitle: Oracle之DDL和对象管理\ndate: 2018-10-02 14:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - SQL\n  - DDL\n---\n\n\n\n# SQL语言之DDL和对象管理\n\n[Oracle 11G R2 官方文档][1]\n\n## 1 介绍用户模拟下可以访问的模式对象\n```sql\n  SELECT object_type, COUNT (*)\n    FROM user_objects\nGROUP BY object_type;\n\n  SELECT object_type, COUNT (*)\n    FROM all_objects\nGROUP BY object_type;\n\nSELECT DISTINCT owner\n  FROM all_objects\n```\n\n## 2 研究模式中的数据类型\n```sql\n-- 1.DESC\n-- 2.SQL\nSELECT column_name, data_type\n  FROM user_tab_columns\n WHERE table_name = 'EMPLOYEES';\n\nSELECT DISTINCT data_type\n  FROM user_tab_columns\n WHERE table_name = 'EMPLOYEES';\n```\n## 3 表的创建与管理\n### 3.1 表的创建\n* 语法\n\n```sql\nCreate table [schema,] table_name(\ncolumn_name data_type [default express] [constraint]\n[,column_name data_type [default express] [constraint]]\n[,column_name data_type [default express] [constraint]]\n);\n\n\n--1.表的创建与结构变更\n--01.工具\n--A：创建表\n--B：写入数据\n--C：更改结构\n```\n* SQL 语法\n\n```sql\n--创建sql02,sql03,sql04\n --创建sql02,sql03,sql04\n\nCREATE TABLE SQL02\n(\n    sql02_id        NUMBER (8) NOT NULL,\n    sql02_id2       NUMBER (8) NOT NULL,\n    sql02_date      DATE NOT NULL,\n    sql02_status    VARCHAR2 (8) NOT NULL,\n    sql02_number NUMBER (10, 2)\n);\n\nCREATE TABLE SQL03\n(\n    sql03_id1    NUMBER (8) NOT NULL,\n    sql03_id2    NUMBER (8) NOT NULL,\n    sql03_id3    NUMBER (8) NOT NULL\n);\n\nALTER TABLE sql03\n    MODIFY (sql03_id3 VARCHAR2 (10));\n\nCREATE TABLE SQL04\n(\n    sql04_id        NUMBER (8) NOT NULL,\n    sql04_desc      VARCHAR2 (20) NOT NULL,\n    sql04_status    VARCHAR2 (8) NOT NULL,\n    sql04_price     NUMBER (10, 2) NOT NULL,\n    sql04_date      DATE NOT NULL,\n    sql04_count     NUMBER (8) NOT NULL\n);\n\n```\n### 3.2 表的重命名\n```sql\nRENAME sql044 TO sql04;\n\nALTER TABLE SQL04\n    MODIFY sql04_count NUMBER (18);\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count TO SQL04_COUNT2;\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count02 TO SQL04_COUNT;\n\nSELECT * FROM tab \nSELECT * FROM user_tables\n```\n### 3.3 表的复制\n```sql\nCREATE TABLE itpux05\nAS\n    SELECT * FROM sql04;\n\nSELECT * FROM sql01;\n\nCREATE TABLE itpux06\nAS\n    SELECT *\n      FROM sql01\n     WHERE sql01_id = 1;\n\nSELECT * FROM itpux06\n```\n### 3.4 表的截断\n```sql\n--100g delete 2h,truncate 2 分钟。\nTRUNCATE TABLE itpux07;\nSELECT * FROM itpux07\n```\n### 3.4 表的删除\n```sql\nDROP TABLE itpux06;\n```\n### 3.4 .删除表的定义\n```sql\nDROP TABLE table_name CASCADE CONSTRAINTS;              --相关的视图，约束，等相关所有的关系对象。\nDROP TABLE table_name PURGE;                            --释放资源，不经过回收站。\nDROP TABLE itpux05 CASCADE CONSTRAINTS;\nDROP TABLE itpux05 PURGE;\n```\n## 4 簇的概念与介绍\n>簇(cluster)其实就是一组表，由一组共享相同数据块的多个表组成，将经常一起使用的表\n组合在一起成簇可以提高处理效率；在一个簇中的表就叫做簇表。\n\n* 不宜用聚簇表的情况\n\n```sql\n1)如果预料到聚簇中的表会大量修改,聚簇表会对DML 的性能产生负面影响\n2)非常不适合对单表的全表扫描,因为只能引起对其它表的全表扫描\n3)频繁对表进行TRUNCATE 和加载,因为聚簇中的表是不能TRUNCATE 的，只能\nTRUNCATE 簇\n4)如果表只是偶尔被连接或者它们的公共列经常被修改，则不要聚簇表\n5)如果经常从所有有相同聚簇键值的表查询出的结果数据超过一个或两个Oracle 块，\n则不要聚簇表\n6)如果空间不够，并且不能为将要插入的新记录分配额外的空间，那么不要使用聚簇\n```\n## 5 临时表的创建与使用\n### 5.1 会话级临时表\n```sql\n--会话结束自动清空数据\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit preserve rows;\n```\n\n### 5.2 事务级临时表\n```sql\n--事务结束（commit,rollback） ，清除数据。\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit delete rows;\n```\n\n## 6 索引的创建与管理\n## 6.1 索引分类\n* 逻辑分类\n```sql\n1.单列或多列\n2.唯一索引和非唯一索引\n3.函数索引\nDoman\n```\n\n* 物理分类\n```sql\n物理分类:\nB-TREE\nBitmap\n\nB*Tree 索引\nB*Tree 索引是最常见的索引结构，默认建立的索引就是这种类型的索引。\n\nDML 语句：\nCreate index indexname on tablename(columnname[columnname...])\nBitmap 索引\n位图索引主要用于决策支持系统或静态数据，不支持行级锁定\n```\n## 6.2 索引的日常管理\n* 基本语法\n```sql\nCREATE [UNIQUE] | [BITMAP] INDEX index_name --unique 表示唯一索引\nON table_name([column1 [ASC|DESC],column2 --bitmap，创建位图索引\n[ASC|DESC],…] | [express])\n[TABLESPACE tablespace_name]\n[PCTFREE n1] --指定索引在数据块中空闲空间\n[STORAGE (INITIAL n2)]\n[NOLOGGING] --表示创建和重建索引时允许\n对表做DML 操作，默认情况下不应该使用\n[NOLINE]\n[NOSORT]; --表示创建索引时不进行排序，\n默认不适用，如果数据已经是按照该索引顺序排列的可以使用\n```\n\n* 1.添加/创建索引\n```sql\n--工具\n\nCREATE INDEX cust_name_i1\n    ON SQL01 (sql01_name);       --单列索引\n\nCREATE INDEX cust_name_i1\n    ON SQL01 (sql01_name)\n    TABLESPACE ITPUX;            --单列\n索引指定表空间\n--命令\n\nCREATE INDEX cust_name_i2\n    ON sql01 (sql01_name, sql01_status);    --组合索引\n\nCREATE BITMAP INDEX sql01_level_i3\n    ON sql01 (sql01_level);      --位图索引\n```\n\n* 2.修改索引\n```sql\n--重命名索引\n\nALTER INDEX cust_name_i1\n    RENAME TO idx1_sql01_name;\n\n--合并索引\n\nALTER INDEX idx1_sql01_name\n    COALESCE;\n```\n\n* 3.重建索引\n```sql\n--重命名索引\n\n--删除原来的索引，重新建立索引。\nDROP INDEX idx1_sql01_name;\n\nCREATE INDEX idx1_sql01_name\n    ON SQL01 (sql01_name);\n\n--直接rebuild\n\nALTER INDEX idx1_sql01_name\n    REBUILD;                                    --会锁表。\n\nALTER INDEX idx1_sql01_name\n    REBUILD ONLINE;\n```\n\n* 4.删除索引\n```sql\nDROP INDEX idx1_sql01_name;\n```\n\n* 5.查看索引\n```sql\n--select * from user_indexes;\n\nSELECT *\n  FROM dba_indexes\n WHERE owner = 'ITPUX';\n\nSELECT *\n  FROM dba_indexes\n WHERE table_name = 'SQL01';\n\n--select * from all_indexes;\n--select * from user_ind_columns;\n\nSELECT *\n  FROM dba_ind_columns\n WHERE index_owner = 'ITPUX' AND table_name = 'SQL01';\n\n--select * from all_ind_columns;\n\nSELECT index_name,\n       column_name,\n       index_type,\n       uniqueness,\n       tablespace_name\n  FROM dba_indexes NATURAL JOIN dba_ind_columns\n WHERE table_name = 'SQL01';\n```\n## 7 约束的创建与管理\n### 7.1  5种约束\n\n* 1.not null (非空约束)\n```sql\n--1.1 创建表的时候\n\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n\n--1.2 在已经创建的表加添加\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    MODIFY id NOT NULL;\n\n--1.3 验证。\n\nINSERT INTO itpux02\n     VALUES (NULL, 'name');\n\nINSERT INTO itpux02\n     VALUES (1, 'name');\n\nSELECT * FROM itpux02;\n\n--1.4 删除\n\nALTER TABLE itpux02\n    MODIFY id NULL;\n\nINSERT INTO itpux02\n     VALUES (NULL, 'name');\n\nSELECT * FROM itpux02;\n\nINSERT INTO itpux02\n     VALUES (2, 'name');\n```\n* 2.primary key 约束\n```sql\nDROP TABLE itpux01;\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n--1.2 在已经创建的表加添加\nDROP TABLE itpux02;\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    ADD CONSTRAINT itpux02_id_con PRIMARY KEY (id); --建议命名\n--alter table itpux02 drop constraint itpux02_id_con;\n\nALTER TABLE itpux02\n    ADD PRIMARY KEY (id);\n\n--1.3 删除\n\nALTER TABLE itpux02\n    DROP CONSTRAINT itpux02_id_con;\n\nALTER TABLE itpux02\n    DROP CONSTRAINT SYS_C0011169;\n```\n\n* 3.unique 约束\n```sql\n--3.1 创建表的时候\n\nCREATE TABLE itpux03\n(\n    id      NUMBER NOT NULL,\n    name    VARCHAR2 (20) UNIQUE\n);\n\nINSERT INTO itpux03\n     VALUES (1, 'name1');\n\nINSERT INTO itpux03\n     VALUES (2, 'name2');\n\n--3.2 删除\n\nALTER TABLE itpux03\n    DROP UNIQUE (name);\n\nINSERT INTO itpux03\n     VALUES (3, 'name2');\n\n--3.3 后期添加\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n\nDELETE FROM itpux03\n      WHERE id = 3;\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n```\n\n* 4.Check 约束\n```sql\n  --4.1 新建表添加约束\n\nCREATE TABLE itpux04\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux04_age_con CHECK (age > 17)\n);\n\nINSERT INTO itpux04\n     VALUES (1, 'mm', 16);\n\nINSERT INTO itpux04\n     VALUES (2, 'mm', 18);\n\n--4.2 删除\n\nALTER TABLE itpux04\n    DROP CONSTRAINT itpux04_age_con;\n\n--4.3 后期\nalter table itpux04 add constraint itpux04_age_con check(age>17);\n```\n\n* 5.Foreign key 约束\n```sql\nCREATE TABLE itpux051\n(\n    jobid    NUMBER NOT NULL PRIMARY KEY,\n    name1 VARCHAR2 (20),\n    age NUMBER (3)\n);\n\nCREATE TABLE itpux052\n(\n    no      NUMBER NOT NULL PRIMARY KEY,\n    dcname VARCHAR2 (20),\n    dcid    NUMBER REFERENCES itpux051 (jobid)\n);\n\nINSERT INTO itpux052\n     VALUES (1, 'dc1008', 20161218);                                                  --error\n\nINSERT INTO itpux051\n     VALUES (20161218, '风哥', 31);\n\nINSERT INTO itpux052\n     VALUES (1, 'dc1008', 20161218);\n\nSELECT * FROM itpux051;\n\nSELECT * FROM itpux052;\n\n--删除\n\nALTER TABLE itpux052\n    DROP CONSTRAINT SYS_C0011182;\n\nDROP TABLE itpux051;\nDROP TABLE itpux051 CASCADE CONSTRAINTS;\n--后期增加\n\nALTER TABLE itpux052\n    ADD CONSTRAINT itpux052_dcid_con FOREIGN KEY (dcid)\n        REFERENCES itpux051 (jobid);\n```\n\n### 7.1  约束的管理\n\n* 1.约束表级定义与列级定义\n```sql\n  --1.1 表级定义\nCREATE TABLE itpux08\n(\n    id NUMBER (8),\n    name VARCHAR2 (50),\n    CONSTRAINT pk_itpux08_id PRIMARY KEY (id)\n);\n\n--1.2 列级定义\nCREATE TABLE itpux09\n(\n    id    NUMBER (8) CONSTRAINT pk_itpux09_id PRIMARY KEY,\n    name VARCHAR2 (50)\n);\n```\n\n* 2.约束的disable/enable,validate/novalidate 的区别\n```sql\n--disable 禁用\n--disable validate --关闭后，不能增删改\n--disable novalidate --关闭后，可以增删改\n--enable 启用\n--enable validate --启用后，进行所有约束，有的，新加的\n--enable novalidate --启用后，对新加入的约束，对旧的不约束\n--2.1 非主键的\n\nCREATE TABLE itpux06\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux06_age_con CHECK (age > 17)\n);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;   --novalidate\n\nINSERT INTO itpux06\n     VALUES (2, 'name2', 18);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nALTER TABLE itpux06\n    DISABLE VALIDATE CONSTRAINT itpux06_age_con;                                                                 --validate\n\nINSERT INTO itpux06\n     VALUES (3, 'name3', 18);              --error\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nINSERT INTO itpux06\n     VALUES (3, 'name3', 18);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;    --novalidate\n\nINSERT INTO itpux06\n     VALUES (4, 'name4', 16);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --errpr\n\nALTER TABLE itpux06\n    ENABLE NOVALIDATE CONSTRAINT itpux06_age_con;\n\n--2.2 主键的\n\nCREATE TABLE itpux07\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux07\n    ADD CONSTRAINT itpux07_id_con PRIMARY KEY (id);\n\nINSERT INTO itpux07\n     VALUES (1, 'name1');\n\nALTER TABLE itpux07\n    DISABLE CONSTRAINT itpux07_id_con;    --novalidate\n\nINSERT INTO itpux07\n     VALUES (1, 'name2');\n\nSELECT * FROM itpux07;\n\nALTER TABLE itpux07\n    ENABLE CONSTRAINT itpux07_id_con;    --error\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --error\n\nCREATE INDEX idx_itpux07_id\n    ON itpux07 (id);\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --ok\n\nSELECT * FROM itpux07;\n```\n### 7.3 显示约束的信息\n* 1.约束的数据字典\n```sql\nselect * from all_constraints;\nselect * from dba_constraints;\nselect * from user_constraints;\nselect distinct constraint_type from user_constraints ;\n-- R references : column\n-- U unique : column\n-- P primary key : column\n-- C check : column\n-- O read only on a view : object\n-- V Check on a view : object\nselect * from all_cons_columns;\nselect * from dba_cons_columns;\nselect * from user_cons_columns;\nselect * from dba_constraints where table_name='ITPUX08';\n```\n\n* 2.约束的可延迟属性\n```sql\nselect * from dba_constraints where table_name='ITPUX08';\n\n--DEFERRABLE(延迟条件): NOT DEFERRABLE(默认，立即验证), DEFERRABLE（提\n交时验证）\n--DEFERRED ： IMMEDIATE(默认，立即验证)，DEFERRED（提交时才验证）,\n--set constraint 名字immediate;\n--用途：物化视图，级联更新。\n\ncreate table itpux10(\nid number not null primary key DEFERRABLE initially IMMEDIATE,\nname varchar2(20),\nage number constraint itpux10_age_con check(age>17) DEFERRABLE\ninitially DEFERRED);\n\nselect * from dba_constraints where table_name='ITPUX10';\n```\n## 8 视图的创建与管理\n### 8.1 语法\n```sql\nCREATE [OR REPLACE] [FORCE|NOFORCE] VIEW view_name\n[(alias[, alias]...)]\nAS subquery\n[WITH CHECK OPTION [CONSTRAINT constraint]]\n[WITH READ ONLY]\nOR REPLACE ：若所创建的试图已经存在，ORACLE 自动重建该视图；\nFORCE ：不管基表是否存在ORACLE 都会自动创建该视图；\nNOFORCE ：只有基表都存在ORACLE 才会创建该视图：\nalias ：为视图产生的列定义的别名；\nsubquery ：一条完整的SELECT 语句，可以在该语句中定义别名；\nWITH CHECK OPTION ：插入或修改的数据行必须满足视图定义的约束；\nWITH READ ONLY ：该视图上不能进行任何DML 操作。\n-- O read only on a view : object\n-- V Check OPTION on a view : object\n```\n## 9 同义词创建和使用\n```sql\n--1.创建同义词\ncreate synonym yg_s for yg_v;\ncreate synonym bm_s for bm_v;\ncreate synonym bm_sum_s for bm_sum_v;\nselect * from yg_s;\nselect * from bm_s;\ndrop view yg_v;\ndrop view bm_v;\nalter view bm_sum_v compile;\ndrop view bm_sum_v;\nalter synonym yg_s compile;\n\n--2.删除同义词\ndrop synonym yg_s;\ndrop synonym bm_s;\ndrop synonym bm_sum_s;\n\n--3.查看同义词\nselect * from dba_synonyms where owner='ITPUX';\nselect * from all_synonyms\nselect * from user_synonyms\nselect * from scott.emp;\ncreate synonym emp_s for scott.emp;\nselect * from emp_s;\ncreate table emp as select * from scott.emp;\nselect * from emp;\n\n--4.权限\ngrant create synonym to itpux01;\ngrant create any synonym to itpux01;\ngrant create public synonym to itpux01;\n```\n\n## 10 序列创建和使用.\n### 10.1 语法\n```sql\n创建序列：\n1、要有创建序列的权限create sequence 或create any sequence\n2、创建序列的语法\nCREATE SEQUENCE sequence //创建序列名称\n\t\t[INCREMENT BY n] //递增的序列值是n 如果n 是正数就递增,如果是负数\n\t\t就递减默认是1\n\t\t[START WITH n] //开始的值,递增默认是minvalue 递减是maxvalue\n\t\t[{MAXVALUE n | NOMAXVALUE}] //最大值\n\t\t[{MINVALUE n | NOMINVALUE}] //最小值\n\t\t[{CYCLE | NOCYCLE}] //循环/不循环\n\t\t[{CACHE n | NOCACHE}];//分配并存入到内存中\n\tNEXTVAL 返回序列中下一个有效的值，任何用户都可以引用\n\tCURRVAL 中存放序列的当前值\n\tNEXTVAL 应在CURRVAL 之前指定，二者应同时有效\n```\n\n### 10.2 日常使用\n```sql\n--创建普通序列\ncreate sequence seql start with 10 nocache maxvalue 15 cycle;\ncreate sequence seql1\n--创建一个带主键的表\ndrop table seqtest\ncreate table seqtest(\n\tc1 number,\n\tc2 varchar2(10)\n);\nalter table seqtest add constraint seqtest_pk primary key (c1);\ncreate sequence seq_test_pk_s\n\tminvalue 1\n\tmaxvalue 9999999999999999\n\tstart with 1\n\tincrement by 1\n\tcache 20;\n--间断\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,'11');\ncommit;\n\nB:\ninsert into seqtest values (seq_test_pk_s.nextval,'22');\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,'33');\ncommit;\nselect * from seqtest;\nB:\nrollback;\nselect * from seqtest;\n--删除\ndrop table seqtest\ndrop sequence SEQ_TEST_PK_S\n```\n\n## 11 存储过程创建和使用\n### 11.1 语法\n```sql\nCREATE [OR REPLACE] PROCEDURE procedure_name\n[(parameter1[model] datatype1, parameter2 [model] datatype2..)]\nIS[AS]\nBEGIN\nPL/SQL;\nEND [procedure_name];\n```\n### 11.2日常使用\n```sql\n--1.编写存储过程\n--显示当前系统时间\n--通过pl/sql dev 菜单\n--手写\ncreate or replace procedure print_sysdate\nis\nbegin\n\tdbms_output.put_line(sysdate);\n\tend print_sysdate;\n/\n--2.存储过程的调用\n--sqlplus,pl/sql 代码块\nexec print_sysdate;\n--set serverout on;\n--exec print_sysdate();\n\n--3.存储过程的删除\ndrop procedure test1;\n--4.编译存储过程\n--界面\n--命令\nalter procedure print_sysdate compile;\n\n\n--5.查询存储过程\nselect * from dba_objects where object_type='PROCEDURE' and\nowner='ITPUX';\nselect * from all_objects where object_type='PROCEDURE' and owner='ITPUX';\nselect * from user_objects where object_type='PROCEDURE';\n\n--6.查看存储过程的内容\n--界面\n--命令\nselect * from user_source where name='PRINT_SYSDATE';\nselect * from dba_source where owner='ITPUX' and name='PRINT_SYSDATE';\nselect * from all_source;\nselect text from user_source where name='PRINT_SYSDATE';\nselect * from dba_source where type='PROCEDURE' and text like '%sysdate%';\n```\n\n### 11.3 存储过程中事务处理\n* 存储过程中事务处理\n```sql\n--案例1 显示YG 表中员工人数的存储过程。\ncreate or replace procedure yg_count\nas\nv_total number(10);\nbegin\n\tselect count(*) into v_total from yg;\n\tdbms_output.put_line('员工总人数为：'||v_total);\nend;\nset serverout on;\nexecute yg_count;\n--员工总人数为：107\n\n--案例2 存储过程中的增删改DML 事务操作。\n--准备\ncreate table itpux_st(id int,name varchar2(10));\ninsert into itpux_st values(1,'itpux01');\ninsert into itpux_st values(2,'itpux02');\ncommit;\n\n--2.1 增加\n--创建过程\ncreate or replace procedure pro_insert\n(v_id int,v_name varchar2)\nis\nbegin\n\tinsert into itpux_st values(v_id,v_name);\ncommit;\nend;\n--执行\nbegin\n\tpro_insert(3,'itpux03');\nend;\n--检查\nselect * from itpux_st;\n\n--2.2 删除\n--创建过程\ncreate or replace procedure pro_delete\n(v_id int)\nis\nbegin\n\tdelete from itpux_st where id=v_id;\ncommit;\nend;\n--执行\nbegin\npro_delete(3);\nend;\n--检查\nselect * from itpux_st;\n\n--2.3 更新/更改\n--创建过程\ncreate or replace procedure pro_update\n(v_id int,v_name varchar2)\nis\nbegin\n\tupdate itpux_st set name=v_name where id=v_id;\ncommit;\nend;\n--执行\nbegin\n\tpro_update(2,'itpux02222');\nend;\n--检查\nselect * from itpux_st;\n\n--2.4 查询\n--创建过程\ncreate or replace procedure pro_select\n(v_id int) --定义输入变量\nis\n\tv_name varchar2(10);--定义输出变量\nbegin\n\tselect name into v_name from itpux_st where id=v_id;--执行查询\n\tdbms_output.put_line('学生姓名为：'||v_name);--输出结果\nend;\n--执行\n--set serverout on;\nbegin\npro_select(2);\nend;\n```\n\n## 12 触发器创建和使用\n* 1.触发器的语法\n```sql\nCREATE [OR REPLACE] TIGGER 触发器名触发时间触发事件\n\tON 表名/视图名\n\t[FOR EACH ROW] //加上FOR EACH ROW 即为行级触发器，不加时为语句\n\t级触发器\n\tBEGIN\n\tpl/sql 语句\n\tEND\n```\n### 12.1 DML 触发器及案例\n* 语法\n```sql\ncreate [or replace] trigger 触发器名称\n\t{before|after}\n\t{insert|delete|update[of column [,column...]]}\n\tor {insert|delete|update[of column [,column...]]}\n\ton [schema.] 表名|[schema.]视图\n\t[for each row]\n\t[when condition]\nbegin\n执行语句;\nend;\n```\n\n* 1.设置一个添加记录就提示的触发器\n```sql\ncreate or replace trigger t1\nafter insert on itpux.emp\n\tbegin\n\t\tdbms_output.put_line('你向ITPUX.EMP 表中添加了一条数据');\n\tend;\n/\n\n--验证\n--set serverout on\ninsert into emp values('8000','itpux15','DBA','8001',sysdate,'15000','0','30');\ninsert into emp values('8002','itpux16','DBA','8002',sysdate,'15000','0','30');\n--你向ITPUX.EMP 表中添加了一条数据\n```\n* 2.设置一个更改记录就提示的触发器\n```sql\ncreate or replace trigger t_update\nafter update on itpux.emp\nfor each row --提示每一条修改的记录\n\tbegin\n\tdbms_output.put_line('你修改了ITPUX.EMP 表中多条数据');\n\tend;\n/\n--验证\n--set serverout on\nselect * from emp;\nupdate emp set job='DBA+SA+HR' where ENAME in ('itpux15','itpux16');\n--你修改了ITPUX.EMP 表中多条数据\n```\n\n* 3.设置一个删除记录就提示的触发器\n```sql\ncreate or replace trigger t_delete\nbefore delete on itpux.emp\nbegin\n--select to_char(sysdate,'day') from dual;\nif to_char(sysdate,'day') in ('星期六','星期天') then\n\tdbms_output.put_line('禁止在周末删除ITPUX.EMP 表数据');\n\traise_application_error(-20001,'禁止在周末删除ITPUX.EMP 表数据'); --\n-20000~20999\nend if;\nend;\n/\n--验证\n--set serverout on\ndelete from emp;\n--ORA-20001: 禁止在周末删除ITPUX.EMP 表数据\n```\n\n### 12.2 DDL 触发器及案例\n* 语法\n```sql\ncreate or replace trigger ddl 触发器名称\nafter ddl on 方案名.schema\nbegin\n\t执行语句;\nend;\n```\n* 基本使用\n```sql\n--SYSTEM 用户\ndrop table itpux_ddl01\ncreate table itpux_ddl01\n(\n\tdbname varchar2(100),\n\tevent varchar2(100),\n\tusername varchar2(30),\n\tclient_ip varchar2(100),\n\tddl_time date\n);\ncreate or replace trigger t_itpux_ddl01\nafter ddl on itpux.schema\nbegin\n\tinsert into itpux_ddl01 values(ora_database_name,ora_sysevent,ora_login_user,ora_client_ip_address,\n\tsysdate);\nend;\n--切换至ITPUX 用户\ncreate table itpux012(id number);\nselect * from system.itpux_ddl01;\n```\n### 12.3 参考资料\n```sql\n系统触发器创建基本语法：\ncreate or replace trigger 系统触发器名称\nafter[before] logon[logoff] on datebase\nbegin\n\t执行语句;\nend;\n\n详细说明：\nafter 事件之后触发\nbefore 事件之前触发\nlogon 登陆触发\nlogoff 登出触发\nstartup 开启系统触发\nshutdown 关闭系统触发\n```\n```sql\n------------------------------参考资料---------------------------------------\n下面介绍一些常用的系统事件属性函数，和建立各种事件触发器的方法在建立系统事\n件触发器时，需要使用事件属性函数，\n常用的事件属性函数如下：\nora_client_ip_address //返回客户端的ip\nora_database_name //返回数据库名称\nora_login_user //返回登陆用户名\nora_sysevent //返回触发器的系统事件名\nora_des_encrypted_password //返回用户des(md5)加密后的密码\n事件属性函数表\nOra_client_ip_address 返回客户端的ip 地址\nOra_database_name 返回当前数据库名\nOra_des_encrypted_password 返回des 加密后的用户口令\nOra_dict_obj_name 返回ddl 操作所对应的数据库对象名\nOra_dict_obj_name_list(name_list out ora_name_list_t)返回在事件中被修改的对\n象名列表\nOra_dict_obj_owner 返回ddl 操作所对应的对象的所有者名\nOra_dict_obj_owner_list(owner_list out ora_name_list_t)返回在事件中被修改的对\n象的所有者列表\nOra_dict_obj_type 返回ddl 操作所对应的数据库对象的类型\nOra_grantee(user_list out ora_name_list_t)返回授权事件的授权者\nOra_instance_num 返回例程号\nOra_is_alter_column(column_name in varchar2)检测特定列是否被修改\nOra_is_creating_nested_table 检测是否正在建立嵌套表\nOra_is_drop_column(column_name in varchar2)检测特定列是否被删除\nOra_is_servererror(error_number)检测是否返回了特定oracle 错误\nOra_login_user 返回登录用户名\nOra_sysevent 返回触发器的系统事件名\n系统触发器的种类和事件出现的时机（前或后）：\n事件允许的时机说明\nSTARTUP AFTER 启动数据库实例之后触发\nSHUTDOWN BEFORE 关闭数据库实例之前触发（非正常关闭不触发）\nSERVERERROR AFTER 数据库服务器发生错误之后触发\nLOGON AFTER 成功登录连接到数据库后触发\nLOGOFF BEFORE 开始断开数据库连接之前触发\nCREATE BEFORE，AFTER 在执行CREATE 语句创建数据库对象之前、之后\n触发\nDROP BEFORE，AFTER 在执行DROP 语句删除数据库对象之前、之后触发\nALTER BEFORE，AFTER 在执行ALTER 语句更新数据库对象之前、之后触发\nDDL BEFORE，AFTER 在执行大多数DDL 语句之前、之后触发\nGRANT BEFORE，AFTER 执行GRANT 语句授予权限之前、之后触发\nREVOKE BEFORE，AFTER 执行REVOKE 语句收权限之前、之后触犯发\nRENAME BEFORE，AFTER 执行RENAME 语句更改数据库对象名称之前、之\n后触犯发\nAUDIT/NOAUDIT BEFORE，AFTER 执行AUDIT 或NOAUDIT 进行审计或停\n止审计之前、之后触发\n特别说明：系统触发器的级别较高，由系统管理员来创建。\n------------------------------------------------------------------------------------\n```\n\n### 12.4 数据库系统触发器\n\n* 1.创建\n```sql\n--记录登录数据库的用户名和IP\ncreate table login_info (ip varchar(30),username varchar(30));\ncreate or replace trigger logon_ip_info\nafter logon on database\ndeclare\n\tip varchar(30);\n\tuser varchar(30);\nbegin\n\tselect sys_context('USERENV','SESSION_USER') into user from dual;\n\tselect sys_context('USERENV','ip_address') into ip from dual;\n\tinsert into login_info values(ip,user);\nend;\n/\n\nselect * from login_info;\n```\n* 2. 管理\n```sql\n--禁用\nalter trigger logon_ip_info disable;\n--启用\nalter trigger logon_ip_info enable;\n--编译\nalter trigger logon_ip_info compile;\n--删除\ndrop trigger logon_ip_info;\n--查询\nselect * from dba_objects where owner='ITPUX' and object_type='TRIGGER';\ndrop trigger ITPUX.T_UPDATE;\ndrop trigger ITPUX.T_DELETE;\ndrop trigger system.t_itpux_ddl01;\n```\n## 13 包的创建和使用\n\n* 1 包定义（PACKAGE）\n```sql\n2.1 包定义（PACKAGE）\nCREATE [OR REPLACE] PACKAGE package_name\n\t{IS | AS}\n\t[公有数据类型定义]\n\t[公有游标声明]\n\t[公有变量、常量声明]\n\t[公有子程序声明]\n\t[package_name];\n定义包规范:\nCREATE OR REPLACE\npackage p_stu\nas\n--定义结构体\ntype re_stu is record(\n\trname student.name%type,\n\trage student.age%type\n);\n--定义游标\ntype c_stu is ref cursor;\n--定义函数\nfunction numAdd(num1 number,num2 number)return number;\n--定义过程\nprocedure GetStuList(cid in varchar2,c_st out c_stu);\nend;\n```\n* 2. 包主体（PACKAGE BODY）\n```sql\nCREATE [OR REPLACE] PACKAGE BODY package_name\n\t{IS | AS}\n\t[私有数据类型定义]\n\t[私有变量、常量声明]\n\t[私有子程序声明和定义]\n\t[公有子程序定义]\nBEGIN\n执行部分(初始化部分)\nEND [package_name];\n\n--1 创建包\ncreate or replace package itpux_pkg\nis\n\tprocedure update_sal(e_name varchar2,newsal number);\n\tFUNCTION emp_sal_fun(e_name varchar2) return number;\nend;\n--2.3 包体\ncreate or replace package body itpux_pkg is\nprocedure update_sal(e_name varchar2,newsal number)\nis\nbegin\n\tupdate emp set sal=newsal where ename=e_name;\nend;\nfunction emp_sal_fun(e_name varchar2)\nreturn number is\nemp_sal number;\nbegin\n\tselect sal*12+nvl(comm,0) into emp_sal from emp\nwhere ename=e_name;\nreturn emp_sal;\nend;\nend;\n--2.4 执行包-调过程\nset serveroutput on\n\texec itpux_pkg.update_sal('itpux14',2000);\ncommit;\nselect * from emp;\n--查看itpux14 的记录\n--2.5 执行包-调函数\ndeclare\n\tv_emp_sal number(7,2);\nbegin\n\tv_emp_sal:=itpux_pkg.emp_sal_fun('itpux14');\n\tdbms_output.put_line('ITPUX14 的年薪为: '||v_emp_sal);\nend;\n--ITPUX14 的年薪为: 24000\n--2.6 删除包\nselect * from dba_objects where owner='ITPUX' and object_type='PACKAGE';\ndrop package ITPUX_PKG;\ndrop package ITPUXA_PKG;\n```\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle之DDL和对象管理","published":1,"updated":"2019-05-03T15:49:09.860Z","_id":"cjv894o560029i0cddjl3443m","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"SQL语言之DDL和对象管理\"><a href=\"#SQL语言之DDL和对象管理\" class=\"headerlink\" title=\"SQL语言之DDL和对象管理\"></a>SQL语言之DDL和对象管理</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-介绍用户模拟下可以访问的模式对象\"><a href=\"#1-介绍用户模拟下可以访问的模式对象\" class=\"headerlink\" title=\"1 介绍用户模拟下可以访问的模式对象\"></a>1 介绍用户模拟下可以访问的模式对象</h2><pre class=\" language-sql\"><code class=\"language-sql\">  <span class=\"token keyword\">SELECT</span> object_type<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> user_objects\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> object_type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">SELECT</span> object_type<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">FROM</span> all_objects\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> object_type<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> owner\n  <span class=\"token keyword\">FROM</span> all_objects\n</code></pre>\n<h2 id=\"2-研究模式中的数据类型\"><a href=\"#2-研究模式中的数据类型\" class=\"headerlink\" title=\"2 研究模式中的数据类型\"></a>2 研究模式中的数据类型</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">-- 1.DESC</span>\n<span class=\"token comment\" spellcheck=\"true\">-- 2.SQL</span>\n<span class=\"token keyword\">SELECT</span> column_name<span class=\"token punctuation\">,</span> data_type\n  <span class=\"token keyword\">FROM</span> user_tab_columns\n <span class=\"token keyword\">WHERE</span> table_name <span class=\"token operator\">=</span> <span class=\"token string\">'EMPLOYEES'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> data_type\n  <span class=\"token keyword\">FROM</span> user_tab_columns\n <span class=\"token keyword\">WHERE</span> table_name <span class=\"token operator\">=</span> <span class=\"token string\">'EMPLOYEES'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"3-表的创建与管理\"><a href=\"#3-表的创建与管理\" class=\"headerlink\" title=\"3 表的创建与管理\"></a>3 表的创建与管理</h2><h3 id=\"3-1-表的创建\"><a href=\"#3-1-表的创建\" class=\"headerlink\" title=\"3.1 表的创建\"></a>3.1 表的创建</h3><ul>\n<li>语法</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">Create</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">schema</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span> table_name<span class=\"token punctuation\">(</span>\ncolumn_name data_type <span class=\"token punctuation\">[</span><span class=\"token keyword\">default</span> express<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">constraint</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span>column_name data_type <span class=\"token punctuation\">[</span><span class=\"token keyword\">default</span> express<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">constraint</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span>column_name data_type <span class=\"token punctuation\">[</span><span class=\"token keyword\">default</span> express<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">constraint</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">--1.表的创建与结构变更</span>\n<span class=\"token comment\" spellcheck=\"true\">--01.工具</span>\n<span class=\"token comment\" spellcheck=\"true\">--A：创建表</span>\n<span class=\"token comment\" spellcheck=\"true\">--B：写入数据</span>\n<span class=\"token comment\" spellcheck=\"true\">--C：更改结构</span>\n</code></pre>\n<ul>\n<li>SQL 语法</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--创建sql02,sql03,sql04</span>\n <span class=\"token comment\" spellcheck=\"true\">--创建sql02,sql03,sql04</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> SQL02\n<span class=\"token punctuation\">(</span>\n    sql02_id        NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql02_id2       NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql02_date      <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql02_status    VARCHAR2 <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql02_number NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> SQL03\n<span class=\"token punctuation\">(</span>\n    sql03_id1    NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql03_id2    NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql03_id3    NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> sql03\n    <span class=\"token keyword\">MODIFY</span> <span class=\"token punctuation\">(</span>sql03_id3 VARCHAR2 <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> SQL04\n<span class=\"token punctuation\">(</span>\n    sql04_id        NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql04_desc      VARCHAR2 <span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql04_status    VARCHAR2 <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql04_price     NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql04_date      <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    sql04_count     NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h3 id=\"3-2-表的重命名\"><a href=\"#3-2-表的重命名\" class=\"headerlink\" title=\"3.2 表的重命名\"></a>3.2 表的重命名</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">RENAME</span> sql044 <span class=\"token keyword\">TO</span> sql04<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> SQL04\n    <span class=\"token keyword\">MODIFY</span> sql04_count NUMBER <span class=\"token punctuation\">(</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> SQL04\n    <span class=\"token keyword\">RENAME</span> <span class=\"token keyword\">COLUMN</span> sql04_count <span class=\"token keyword\">TO</span> SQL04_COUNT2<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> SQL04\n    <span class=\"token keyword\">RENAME</span> <span class=\"token keyword\">COLUMN</span> sql04_count02 <span class=\"token keyword\">TO</span> SQL04_COUNT<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> tab \n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> user_tables\n</code></pre>\n<h3 id=\"3-3-表的复制\"><a href=\"#3-3-表的复制\" class=\"headerlink\" title=\"3.3 表的复制\"></a>3.3 表的复制</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> itpux05\n<span class=\"token keyword\">AS</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql04<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> sql01<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> itpux06\n<span class=\"token keyword\">AS</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n      <span class=\"token keyword\">FROM</span> sql01\n     <span class=\"token keyword\">WHERE</span> sql01_id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> itpux06\n</code></pre>\n<h3 id=\"3-4-表的截断\"><a href=\"#3-4-表的截断\" class=\"headerlink\" title=\"3.4 表的截断\"></a>3.4 表的截断</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--100g delete 2h,truncate 2 分钟。</span>\n<span class=\"token keyword\">TRUNCATE</span> <span class=\"token keyword\">TABLE</span> itpux07<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> itpux07\n</code></pre>\n<h3 id=\"3-4-表的删除\"><a href=\"#3-4-表的删除\" class=\"headerlink\" title=\"3.4 表的删除\"></a>3.4 表的删除</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> itpux06<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"3-4-删除表的定义\"><a href=\"#3-4-删除表的定义\" class=\"headerlink\" title=\"3.4 .删除表的定义\"></a>3.4 .删除表的定义</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> table_name <span class=\"token keyword\">CASCADE</span> CONSTRAINTS<span class=\"token punctuation\">;</span>              <span class=\"token comment\" spellcheck=\"true\">--相关的视图，约束，等相关所有的关系对象。</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> table_name <span class=\"token keyword\">PURGE</span><span class=\"token punctuation\">;</span>                            <span class=\"token comment\" spellcheck=\"true\">--释放资源，不经过回收站。</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> itpux05 <span class=\"token keyword\">CASCADE</span> CONSTRAINTS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> itpux05 <span class=\"token keyword\">PURGE</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"4-簇的概念与介绍\"><a href=\"#4-簇的概念与介绍\" class=\"headerlink\" title=\"4 簇的概念与介绍\"></a>4 簇的概念与介绍</h2><blockquote>\n<p>簇(cluster)其实就是一组表，由一组共享相同数据块的多个表组成，将经常一起使用的表<br>组合在一起成簇可以提高处理效率；在一个簇中的表就叫做簇表。</p>\n</blockquote>\n<ul>\n<li>不宜用聚簇表的情况</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>如果预料到聚簇中的表会大量修改<span class=\"token punctuation\">,</span>聚簇表会对DML 的性能产生负面影响\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span>非常不适合对单表的全表扫描<span class=\"token punctuation\">,</span>因为只能引起对其它表的全表扫描\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span>频繁对表进行<span class=\"token keyword\">TRUNCATE</span> 和加载<span class=\"token punctuation\">,</span>因为聚簇中的表是不能<span class=\"token keyword\">TRUNCATE</span> 的，只能\n<span class=\"token keyword\">TRUNCATE</span> 簇\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span>如果表只是偶尔被连接或者它们的公共列经常被修改，则不要聚簇表\n<span class=\"token number\">5</span><span class=\"token punctuation\">)</span>如果经常从所有有相同聚簇键值的表查询出的结果数据超过一个或两个Oracle 块，\n则不要聚簇表\n<span class=\"token number\">6</span><span class=\"token punctuation\">)</span>如果空间不够，并且不能为将要插入的新记录分配额外的空间，那么不要使用聚簇\n</code></pre>\n<h2 id=\"5-临时表的创建与使用\"><a href=\"#5-临时表的创建与使用\" class=\"headerlink\" title=\"5 临时表的创建与使用\"></a>5 临时表的创建与使用</h2><h3 id=\"5-1-会话级临时表\"><a href=\"#5-1-会话级临时表\" class=\"headerlink\" title=\"5.1 会话级临时表\"></a>5.1 会话级临时表</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--会话结束自动清空数据</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">GLOBAL</span> <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLE</span> table_name\n<span class=\"token punctuation\">(</span>\n    col1 type1<span class=\"token punctuation\">,</span>\n    col2 type2<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">on</span> <span class=\"token keyword\">commit</span> preserve <span class=\"token keyword\">rows</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"5-2-事务级临时表\"><a href=\"#5-2-事务级临时表\" class=\"headerlink\" title=\"5.2 事务级临时表\"></a>5.2 事务级临时表</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--事务结束（commit,rollback） ，清除数据。</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">GLOBAL</span> <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLE</span> table_name\n<span class=\"token punctuation\">(</span>\n    col1 type1<span class=\"token punctuation\">,</span>\n    col2 type2<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">on</span> <span class=\"token keyword\">commit</span> <span class=\"token keyword\">delete</span> <span class=\"token keyword\">rows</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"6-索引的创建与管理\"><a href=\"#6-索引的创建与管理\" class=\"headerlink\" title=\"6 索引的创建与管理\"></a>6 索引的创建与管理</h2><h2 id=\"6-1-索引分类\"><a href=\"#6-1-索引分类\" class=\"headerlink\" title=\"6.1 索引分类\"></a>6.1 索引分类</h2><ul>\n<li><p>逻辑分类</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>单列或多列\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>唯一索引和非唯一索引\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>函数索引\nDoman\n</code></pre>\n</li>\n<li><p>物理分类<br><code>`</code>sql<br>物理分类:<br>B-TREE<br>Bitmap</p>\n</li>\n</ul>\n<p>B<em>Tree 索引<br>B</em>Tree 索引是最常见的索引结构，默认建立的索引就是这种类型的索引。</p>\n<p>DML 语句：<br>Create index indexname on tablename(columnname[columnname…])<br>Bitmap 索引<br>位图索引主要用于决策支持系统或静态数据，不支持行级锁定</p>\n<pre><code>## 6.2 索引的日常管理\n* 基本语法\n```sql\nCREATE [UNIQUE] | [BITMAP] INDEX index_name --unique 表示唯一索引\nON table_name([column1 [ASC|DESC],column2 --bitmap，创建位图索引\n[ASC|DESC],…] | [express])\n[TABLESPACE tablespace_name]\n[PCTFREE n1] --指定索引在数据块中空闲空间\n[STORAGE (INITIAL n2)]\n[NOLOGGING] --表示创建和重建索引时允许\n对表做DML 操作，默认情况下不应该使用\n[NOLINE]\n[NOSORT]; --表示创建索引时不进行排序，\n默认不适用，如果数据已经是按照该索引顺序排列的可以使用\n</code></pre><ul>\n<li>1.添加/创建索引<br><code>`</code>sql<br>–工具</li>\n</ul>\n<p>CREATE INDEX cust_name_i1<br>    ON SQL01 (sql01_name);       –单列索引</p>\n<p>CREATE INDEX cust_name_i1<br>    ON SQL01 (sql01_name)<br>    TABLESPACE ITPUX;            –单列<br>索引指定表空间<br>–命令</p>\n<p>CREATE INDEX cust_name_i2<br>    ON sql01 (sql01_name, sql01_status);    –组合索引</p>\n<p>CREATE BITMAP INDEX sql01_level_i3<br>    ON sql01 (sql01_level);      –位图索引</p>\n<pre><code>\n* 2.修改索引\n```sql\n--重命名索引\n\nALTER INDEX cust_name_i1\n    RENAME TO idx1_sql01_name;\n\n--合并索引\n\nALTER INDEX idx1_sql01_name\n    COALESCE;\n</code></pre><ul>\n<li>3.重建索引<br><code>`</code>sql<br>–重命名索引</li>\n</ul>\n<p>–删除原来的索引，重新建立索引。<br>DROP INDEX idx1_sql01_name;</p>\n<p>CREATE INDEX idx1_sql01_name<br>    ON SQL01 (sql01_name);</p>\n<p>–直接rebuild</p>\n<p>ALTER INDEX idx1_sql01_name<br>    REBUILD;                                    –会锁表。</p>\n<p>ALTER INDEX idx1_sql01_name<br>    REBUILD ONLINE;</p>\n<pre><code>\n* 4.删除索引\n```sql\nDROP INDEX idx1_sql01_name;\n</code></pre><ul>\n<li>5.查看索引<br><code>`</code>sql<br>–select * from user_indexes;</li>\n</ul>\n<p>SELECT *<br>  FROM dba_indexes<br> WHERE owner = ‘ITPUX’;</p>\n<p>SELECT *<br>  FROM dba_indexes<br> WHERE table_name = ‘SQL01’;</p>\n<p>–select <em> from all_indexes;<br>–select </em> from user_ind_columns;</p>\n<p>SELECT *<br>  FROM dba_ind_columns<br> WHERE index_owner = ‘ITPUX’ AND table_name = ‘SQL01’;</p>\n<p>–select * from all_ind_columns;</p>\n<p>SELECT index_name,<br>       column_name,<br>       index_type,<br>       uniqueness,<br>       tablespace_name<br>  FROM dba_indexes NATURAL JOIN dba_ind_columns<br> WHERE table_name = ‘SQL01’;</p>\n<pre><code>## 7 约束的创建与管理\n### 7.1  5种约束\n\n* 1.not null (非空约束)\n```sql\n--1.1 创建表的时候\n\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n\n--1.2 在已经创建的表加添加\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    MODIFY id NOT NULL;\n\n--1.3 验证。\n\nINSERT INTO itpux02\n     VALUES (NULL, &#39;name&#39;);\n\nINSERT INTO itpux02\n     VALUES (1, &#39;name&#39;);\n\nSELECT * FROM itpux02;\n\n--1.4 删除\n\nALTER TABLE itpux02\n    MODIFY id NULL;\n\nINSERT INTO itpux02\n     VALUES (NULL, &#39;name&#39;);\n\nSELECT * FROM itpux02;\n\nINSERT INTO itpux02\n     VALUES (2, &#39;name&#39;);\n</code></pre><ul>\n<li>2.primary key 约束<br><code>`</code>sql<br>DROP TABLE itpux01;<br>CREATE TABLE itpux01<br>(<br>  id    NUMBER NOT NULL PRIMARY KEY,<br>  name VARCHAR2 (20)<br>);<br>–1.2 在已经创建的表加添加<br>DROP TABLE itpux02;</li>\n</ul>\n<p>CREATE TABLE itpux02<br>(<br>    id NUMBER,<br>    name VARCHAR2 (20)<br>);</p>\n<p>ALTER TABLE itpux02<br>    ADD CONSTRAINT itpux02_id_con PRIMARY KEY (id); –建议命名<br>–alter table itpux02 drop constraint itpux02_id_con;</p>\n<p>ALTER TABLE itpux02<br>    ADD PRIMARY KEY (id);</p>\n<p>–1.3 删除</p>\n<p>ALTER TABLE itpux02<br>    DROP CONSTRAINT itpux02_id_con;</p>\n<p>ALTER TABLE itpux02<br>    DROP CONSTRAINT SYS_C0011169;</p>\n<pre><code>\n* 3.unique 约束\n```sql\n--3.1 创建表的时候\n\nCREATE TABLE itpux03\n(\n    id      NUMBER NOT NULL,\n    name    VARCHAR2 (20) UNIQUE\n);\n\nINSERT INTO itpux03\n     VALUES (1, &#39;name1&#39;);\n\nINSERT INTO itpux03\n     VALUES (2, &#39;name2&#39;);\n\n--3.2 删除\n\nALTER TABLE itpux03\n    DROP UNIQUE (name);\n\nINSERT INTO itpux03\n     VALUES (3, &#39;name2&#39;);\n\n--3.3 后期添加\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n\nDELETE FROM itpux03\n      WHERE id = 3;\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n</code></pre><ul>\n<li>4.Check 约束<br><code>`</code>sql<br>–4.1 新建表添加约束</li>\n</ul>\n<p>CREATE TABLE itpux04<br>(<br>    id     NUMBER NOT NULL PRIMARY KEY,<br>    name VARCHAR2 (20),<br>    age    NUMBER CONSTRAINT itpux04_age_con CHECK (age &gt; 17)<br>);</p>\n<p>INSERT INTO itpux04<br>     VALUES (1, ‘mm’, 16);</p>\n<p>INSERT INTO itpux04<br>     VALUES (2, ‘mm’, 18);</p>\n<p>–4.2 删除</p>\n<p>ALTER TABLE itpux04<br>    DROP CONSTRAINT itpux04_age_con;</p>\n<p>–4.3 后期<br>alter table itpux04 add constraint itpux04_age_con check(age&gt;17);</p>\n<pre><code>\n* 5.Foreign key 约束\n```sql\nCREATE TABLE itpux051\n(\n    jobid    NUMBER NOT NULL PRIMARY KEY,\n    name1 VARCHAR2 (20),\n    age NUMBER (3)\n);\n\nCREATE TABLE itpux052\n(\n    no      NUMBER NOT NULL PRIMARY KEY,\n    dcname VARCHAR2 (20),\n    dcid    NUMBER REFERENCES itpux051 (jobid)\n);\n\nINSERT INTO itpux052\n     VALUES (1, &#39;dc1008&#39;, 20161218);                                                  --error\n\nINSERT INTO itpux051\n     VALUES (20161218, &#39;风哥&#39;, 31);\n\nINSERT INTO itpux052\n     VALUES (1, &#39;dc1008&#39;, 20161218);\n\nSELECT * FROM itpux051;\n\nSELECT * FROM itpux052;\n\n--删除\n\nALTER TABLE itpux052\n    DROP CONSTRAINT SYS_C0011182;\n\nDROP TABLE itpux051;\nDROP TABLE itpux051 CASCADE CONSTRAINTS;\n--后期增加\n\nALTER TABLE itpux052\n    ADD CONSTRAINT itpux052_dcid_con FOREIGN KEY (dcid)\n        REFERENCES itpux051 (jobid);\n</code></pre><h3 id=\"7-1-约束的管理\"><a href=\"#7-1-约束的管理\" class=\"headerlink\" title=\"7.1  约束的管理\"></a>7.1  约束的管理</h3><ul>\n<li>1.约束表级定义与列级定义<br><code>`</code>sql<br>–1.1 表级定义<br>CREATE TABLE itpux08<br>(<br>  id NUMBER (8),<br>  name VARCHAR2 (50),<br>  CONSTRAINT pk_itpux08_id PRIMARY KEY (id)<br>);</li>\n</ul>\n<p>–1.2 列级定义<br>CREATE TABLE itpux09<br>(<br>    id    NUMBER (8) CONSTRAINT pk_itpux09_id PRIMARY KEY,<br>    name VARCHAR2 (50)<br>);</p>\n<pre><code>\n* 2.约束的disable/enable,validate/novalidate 的区别\n```sql\n--disable 禁用\n--disable validate --关闭后，不能增删改\n--disable novalidate --关闭后，可以增删改\n--enable 启用\n--enable validate --启用后，进行所有约束，有的，新加的\n--enable novalidate --启用后，对新加入的约束，对旧的不约束\n--2.1 非主键的\n\nCREATE TABLE itpux06\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux06_age_con CHECK (age &gt; 17)\n);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;   --novalidate\n\nINSERT INTO itpux06\n     VALUES (2, &#39;name2&#39;, 18);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nALTER TABLE itpux06\n    DISABLE VALIDATE CONSTRAINT itpux06_age_con;                                                                 --validate\n\nINSERT INTO itpux06\n     VALUES (3, &#39;name3&#39;, 18);              --error\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nINSERT INTO itpux06\n     VALUES (3, &#39;name3&#39;, 18);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;    --novalidate\n\nINSERT INTO itpux06\n     VALUES (4, &#39;name4&#39;, 16);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --errpr\n\nALTER TABLE itpux06\n    ENABLE NOVALIDATE CONSTRAINT itpux06_age_con;\n\n--2.2 主键的\n\nCREATE TABLE itpux07\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux07\n    ADD CONSTRAINT itpux07_id_con PRIMARY KEY (id);\n\nINSERT INTO itpux07\n     VALUES (1, &#39;name1&#39;);\n\nALTER TABLE itpux07\n    DISABLE CONSTRAINT itpux07_id_con;    --novalidate\n\nINSERT INTO itpux07\n     VALUES (1, &#39;name2&#39;);\n\nSELECT * FROM itpux07;\n\nALTER TABLE itpux07\n    ENABLE CONSTRAINT itpux07_id_con;    --error\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --error\n\nCREATE INDEX idx_itpux07_id\n    ON itpux07 (id);\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --ok\n\nSELECT * FROM itpux07;\n</code></pre><h3 id=\"7-3-显示约束的信息\"><a href=\"#7-3-显示约束的信息\" class=\"headerlink\" title=\"7.3 显示约束的信息\"></a>7.3 显示约束的信息</h3><ul>\n<li><p>1.约束的数据字典</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> all_constraints<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_constraints<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> user_constraints<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> constraint_type <span class=\"token keyword\">from</span> user_constraints <span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- R references : column</span>\n<span class=\"token comment\" spellcheck=\"true\">-- U unique : column</span>\n<span class=\"token comment\" spellcheck=\"true\">-- P primary key : column</span>\n<span class=\"token comment\" spellcheck=\"true\">-- C check : column</span>\n<span class=\"token comment\" spellcheck=\"true\">-- O read only on a view : object</span>\n<span class=\"token comment\" spellcheck=\"true\">-- V Check on a view : object</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> all_cons_columns<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_cons_columns<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> user_cons_columns<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_constraints <span class=\"token keyword\">where</span> table_name<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX08'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li><p>2.约束的可延迟属性<br><code>`</code>sql<br>select * from dba_constraints where table_name=’ITPUX08’;</p>\n</li>\n</ul>\n<p>–DEFERRABLE(延迟条件): NOT DEFERRABLE(默认，立即验证), DEFERRABLE（提<br>交时验证）<br>–DEFERRED ： IMMEDIATE(默认，立即验证)，DEFERRED（提交时才验证）,<br>–set constraint 名字immediate;<br>–用途：物化视图，级联更新。</p>\n<p>create table itpux10(<br>id number not null primary key DEFERRABLE initially IMMEDIATE,<br>name varchar2(20),<br>age number constraint itpux10_age_con check(age&gt;17) DEFERRABLE<br>initially DEFERRED);</p>\n<p>select * from dba_constraints where table_name=’ITPUX10’;</p>\n<pre><code>## 8 视图的创建与管理\n### 8.1 语法\n```sql\nCREATE [OR REPLACE] [FORCE|NOFORCE] VIEW view_name\n[(alias[, alias]...)]\nAS subquery\n[WITH CHECK OPTION [CONSTRAINT constraint]]\n[WITH READ ONLY]\nOR REPLACE ：若所创建的试图已经存在，ORACLE 自动重建该视图；\nFORCE ：不管基表是否存在ORACLE 都会自动创建该视图；\nNOFORCE ：只有基表都存在ORACLE 才会创建该视图：\nalias ：为视图产生的列定义的别名；\nsubquery ：一条完整的SELECT 语句，可以在该语句中定义别名；\nWITH CHECK OPTION ：插入或修改的数据行必须满足视图定义的约束；\nWITH READ ONLY ：该视图上不能进行任何DML 操作。\n-- O read only on a view : object\n-- V Check OPTION on a view : object\n</code></pre><h2 id=\"9-同义词创建和使用\"><a href=\"#9-同义词创建和使用\" class=\"headerlink\" title=\"9 同义词创建和使用\"></a>9 同义词创建和使用</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.创建同义词</span>\n<span class=\"token keyword\">create</span> synonym yg_s <span class=\"token keyword\">for</span> yg_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> synonym bm_s <span class=\"token keyword\">for</span> bm_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> synonym bm_sum_s <span class=\"token keyword\">for</span> bm_sum_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> yg_s<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> bm_s<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">view</span> yg_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">view</span> bm_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">view</span> bm_sum_v compile<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">view</span> bm_sum_v<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> synonym yg_s compile<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.删除同义词</span>\n<span class=\"token keyword\">drop</span> synonym yg_s<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> synonym bm_s<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> synonym bm_sum_s<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.查看同义词</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_synonyms <span class=\"token keyword\">where</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> all_synonyms\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> user_synonyms\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> scott<span class=\"token punctuation\">.</span>emp<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> synonym emp_s <span class=\"token keyword\">for</span> scott<span class=\"token punctuation\">.</span>emp<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp_s<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> emp <span class=\"token keyword\">as</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> scott<span class=\"token punctuation\">.</span>emp<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--4.权限</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">create</span> synonym <span class=\"token keyword\">to</span> itpux01<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">any</span> synonym <span class=\"token keyword\">to</span> itpux01<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">grant</span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">public</span> synonym <span class=\"token keyword\">to</span> itpux01<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"10-序列创建和使用\"><a href=\"#10-序列创建和使用\" class=\"headerlink\" title=\"10 序列创建和使用.\"></a>10 序列创建和使用.</h2><h3 id=\"10-1-语法\"><a href=\"#10-1-语法\" class=\"headerlink\" title=\"10.1 语法\"></a>10.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\">创建序列：\n<span class=\"token number\">1</span>、要有创建序列的权限<span class=\"token keyword\">create</span> sequence 或<span class=\"token keyword\">create</span> <span class=\"token keyword\">any</span> sequence\n<span class=\"token number\">2</span>、创建序列的语法\n<span class=\"token keyword\">CREATE</span> SEQUENCE sequence <span class=\"token comment\" spellcheck=\"true\">//创建序列名称</span>\n        <span class=\"token punctuation\">[</span>INCREMENT <span class=\"token keyword\">BY</span> n<span class=\"token punctuation\">]</span> <span class=\"token comment\" spellcheck=\"true\">//递增的序列值是n 如果n 是正数就递增,如果是负数</span>\n        就递减默认是<span class=\"token number\">1</span>\n        <span class=\"token punctuation\">[</span><span class=\"token keyword\">START</span> <span class=\"token keyword\">WITH</span> n<span class=\"token punctuation\">]</span> <span class=\"token comment\" spellcheck=\"true\">//开始的值,递增默认是minvalue 递减是maxvalue</span>\n        <span class=\"token punctuation\">[</span>{MAXVALUE n <span class=\"token operator\">|</span> NOMAXVALUE}<span class=\"token punctuation\">]</span> <span class=\"token comment\" spellcheck=\"true\">//最大值</span>\n        <span class=\"token punctuation\">[</span>{MINVALUE n <span class=\"token operator\">|</span> NOMINVALUE}<span class=\"token punctuation\">]</span> <span class=\"token comment\" spellcheck=\"true\">//最小值</span>\n        <span class=\"token punctuation\">[</span>{CYCLE <span class=\"token operator\">|</span> <span class=\"token keyword\">NOCYCLE</span>}<span class=\"token punctuation\">]</span> <span class=\"token comment\" spellcheck=\"true\">//循环/不循环</span>\n        <span class=\"token punctuation\">[</span>{CACHE n <span class=\"token operator\">|</span> NOCACHE}<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">//分配并存入到内存中</span>\n    NEXTVAL 返回序列中下一个有效的值，任何用户都可以引用\n    CURRVAL 中存放序列的当前值\n    NEXTVAL 应在CURRVAL 之前指定，二者应同时有效\n</code></pre>\n<h3 id=\"10-2-日常使用\"><a href=\"#10-2-日常使用\" class=\"headerlink\" title=\"10.2 日常使用\"></a>10.2 日常使用</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--创建普通序列</span>\n<span class=\"token keyword\">create</span> sequence seql <span class=\"token keyword\">start</span> <span class=\"token keyword\">with</span> <span class=\"token number\">10</span> nocache maxvalue <span class=\"token number\">15</span> cycle<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> sequence seql1\n<span class=\"token comment\" spellcheck=\"true\">--创建一个带主键的表</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> seqtest\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> seqtest<span class=\"token punctuation\">(</span>\n    <span class=\"token number\">c1</span> number<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">c2</span> varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> seqtest <span class=\"token keyword\">add</span> <span class=\"token keyword\">constraint</span> seqtest_pk <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token punctuation\">(</span><span class=\"token number\">c1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> sequence seq_test_pk_s\n    minvalue <span class=\"token number\">1</span>\n    maxvalue <span class=\"token number\">9999999999999999</span>\n    <span class=\"token keyword\">start</span> <span class=\"token keyword\">with</span> <span class=\"token number\">1</span>\n    increment <span class=\"token keyword\">by</span> <span class=\"token number\">1</span>\n    cache <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--间断</span>\nA:\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> seqtest <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span>seq_test_pk_s<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span><span class=\"token string\">'11'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n\nB:\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> seqtest <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span>seq_test_pk_s<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span><span class=\"token string\">'22'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nA:\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> seqtest <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span>seq_test_pk_s<span class=\"token punctuation\">.</span>nextval<span class=\"token punctuation\">,</span><span class=\"token string\">'33'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> seqtest<span class=\"token punctuation\">;</span>\nB:\n<span class=\"token keyword\">rollback</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> seqtest<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--删除</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> seqtest\n<span class=\"token keyword\">drop</span> sequence SEQ_TEST_PK_S\n</code></pre>\n<h2 id=\"11-存储过程创建和使用\"><a href=\"#11-存储过程创建和使用\" class=\"headerlink\" title=\"11 存储过程创建和使用\"></a>11 存储过程创建和使用</h2><h3 id=\"11-1-语法\"><a href=\"#11-1-语法\" class=\"headerlink\" title=\"11.1 语法\"></a>11.1 语法</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">OR</span> REPLACE<span class=\"token punctuation\">]</span> <span class=\"token keyword\">PROCEDURE</span> procedure_name\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>parameter1<span class=\"token punctuation\">[</span>model<span class=\"token punctuation\">]</span> datatype1<span class=\"token punctuation\">,</span> parameter2 <span class=\"token punctuation\">[</span>model<span class=\"token punctuation\">]</span> datatype2<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">IS</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">AS</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">BEGIN</span>\nPL<span class=\"token operator\">/</span>SQL<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span> <span class=\"token punctuation\">[</span>procedure_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"11-2日常使用\"><a href=\"#11-2日常使用\" class=\"headerlink\" title=\"11.2日常使用\"></a>11.2日常使用</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.编写存储过程</span>\n<span class=\"token comment\" spellcheck=\"true\">--显示当前系统时间</span>\n<span class=\"token comment\" spellcheck=\"true\">--通过pl/sql dev 菜单</span>\n<span class=\"token comment\" spellcheck=\"true\">--手写</span>\n<span class=\"token keyword\">create</span> <span class=\"token operator\">or</span> replace <span class=\"token keyword\">procedure</span> print_sysdate\n<span class=\"token operator\">is</span>\n<span class=\"token keyword\">begin</span>\n    dbms_output<span class=\"token punctuation\">.</span>put_line<span class=\"token punctuation\">(</span>sysdate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">end</span> print_sysdate<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.存储过程的调用</span>\n<span class=\"token comment\" spellcheck=\"true\">--sqlplus,pl/sql 代码块</span>\n<span class=\"token keyword\">exec</span> print_sysdate<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--set serverout on;</span>\n<span class=\"token comment\" spellcheck=\"true\">--exec print_sysdate();</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.存储过程的删除</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">procedure</span> test1<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--4.编译存储过程</span>\n<span class=\"token comment\" spellcheck=\"true\">--界面</span>\n<span class=\"token comment\" spellcheck=\"true\">--命令</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">procedure</span> print_sysdate compile<span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">--5.查询存储过程</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_objects <span class=\"token keyword\">where</span> object_type<span class=\"token operator\">=</span><span class=\"token string\">'PROCEDURE'</span> <span class=\"token operator\">and</span>\nowner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> all_objects <span class=\"token keyword\">where</span> object_type<span class=\"token operator\">=</span><span class=\"token string\">'PROCEDURE'</span> <span class=\"token operator\">and</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> user_objects <span class=\"token keyword\">where</span> object_type<span class=\"token operator\">=</span><span class=\"token string\">'PROCEDURE'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--6.查看存储过程的内容</span>\n<span class=\"token comment\" spellcheck=\"true\">--界面</span>\n<span class=\"token comment\" spellcheck=\"true\">--命令</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> user_source <span class=\"token keyword\">where</span> name<span class=\"token operator\">=</span><span class=\"token string\">'PRINT_SYSDATE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_source <span class=\"token keyword\">where</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX'</span> <span class=\"token operator\">and</span> name<span class=\"token operator\">=</span><span class=\"token string\">'PRINT_SYSDATE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> all_source<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token keyword\">text</span> <span class=\"token keyword\">from</span> user_source <span class=\"token keyword\">where</span> name<span class=\"token operator\">=</span><span class=\"token string\">'PRINT_SYSDATE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_source <span class=\"token keyword\">where</span> <span class=\"token keyword\">type</span><span class=\"token operator\">=</span><span class=\"token string\">'PROCEDURE'</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">text</span> <span class=\"token operator\">like</span> <span class=\"token string\">'%sysdate%'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"11-3-存储过程中事务处理\"><a href=\"#11-3-存储过程中事务处理\" class=\"headerlink\" title=\"11.3 存储过程中事务处理\"></a>11.3 存储过程中事务处理</h3><ul>\n<li>存储过程中事务处理<br><code>`</code>sql<br>–案例1 显示YG 表中员工人数的存储过程。<br>create or replace procedure yg_count<br>as<br>v_total number(10);<br>begin<br>  select count(*) into v_total from yg;<br>  dbms_output.put_line(‘员工总人数为：’||v_total);<br>end;<br>set serverout on;<br>execute yg_count;<br>–员工总人数为：107</li>\n</ul>\n<p>–案例2 存储过程中的增删改DML 事务操作。<br>–准备<br>create table itpux_st(id int,name varchar2(10));<br>insert into itpux_st values(1,’itpux01’);<br>insert into itpux_st values(2,’itpux02’);<br>commit;</p>\n<p>–2.1 增加<br>–创建过程<br>create or replace procedure pro_insert<br>(v_id int,v_name varchar2)<br>is<br>begin<br>    insert into itpux_st values(v_id,v_name);<br>commit;<br>end;<br>–执行<br>begin<br>    pro_insert(3,’itpux03’);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.2 删除<br>–创建过程<br>create or replace procedure pro_delete<br>(v_id int)<br>is<br>begin<br>    delete from itpux_st where id=v_id;<br>commit;<br>end;<br>–执行<br>begin<br>pro_delete(3);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.3 更新/更改<br>–创建过程<br>create or replace procedure pro_update<br>(v_id int,v_name varchar2)<br>is<br>begin<br>    update itpux_st set name=v_name where id=v_id;<br>commit;<br>end;<br>–执行<br>begin<br>    pro_update(2,’itpux02222’);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.4 查询<br>–创建过程<br>create or replace procedure pro_select<br>(v_id int) –定义输入变量<br>is<br>    v_name varchar2(10);–定义输出变量<br>begin<br>    select name into v_name from itpux_st where id=v_id;–执行查询<br>    dbms_output.put_line(‘学生姓名为：’||v_name);–输出结果<br>end;<br>–执行<br>–set serverout on;<br>begin<br>pro_select(2);<br>end;</p>\n<pre><code>\n## 12 触发器创建和使用\n* 1.触发器的语法\n```sql\nCREATE [OR REPLACE] TIGGER 触发器名触发时间触发事件\n    ON 表名/视图名\n    [FOR EACH ROW] //加上FOR EACH ROW 即为行级触发器，不加时为语句\n    级触发器\n    BEGIN\n    pl/sql 语句\n    END\n</code></pre><h3 id=\"12-1-DML-触发器及案例\"><a href=\"#12-1-DML-触发器及案例\" class=\"headerlink\" title=\"12.1 DML 触发器及案例\"></a>12.1 DML 触发器及案例</h3><ul>\n<li><p>语法</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">or</span> replace<span class=\"token punctuation\">]</span> <span class=\"token keyword\">trigger</span> 触发器名称\n  {before<span class=\"token operator\">|</span><span class=\"token keyword\">after</span>}\n  {<span class=\"token keyword\">insert</span><span class=\"token operator\">|</span><span class=\"token keyword\">delete</span><span class=\"token operator\">|</span><span class=\"token keyword\">update</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">of</span> <span class=\"token keyword\">column</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">column</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>}\n  <span class=\"token operator\">or</span> {<span class=\"token keyword\">insert</span><span class=\"token operator\">|</span><span class=\"token keyword\">delete</span><span class=\"token operator\">|</span><span class=\"token keyword\">update</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">of</span> <span class=\"token keyword\">column</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">column</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>}\n  <span class=\"token keyword\">on</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">schema</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span> 表名<span class=\"token operator\">|</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">schema</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span>视图\n  <span class=\"token punctuation\">[</span><span class=\"token keyword\">for each row</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token keyword\">when</span> condition<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">begin</span>\n执行语句<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li><p>1.设置一个添加记录就提示的触发器<br><code>`</code>sql<br>create or replace trigger t1<br>after insert on itpux.emp<br>  begin</p>\n<pre><code>  dbms_output.put_line(&#39;你向ITPUX.EMP 表中添加了一条数据&#39;);\n</code></pre><p>  end;<br>/</p>\n</li>\n</ul>\n<p>–验证<br>–set serverout on<br>insert into emp values(‘8000’,’itpux15’,’DBA’,’8001’,sysdate,’15000’,’0’,’30’);<br>insert into emp values(‘8002’,’itpux16’,’DBA’,’8002’,sysdate,’15000’,’0’,’30’);<br>–你向ITPUX.EMP 表中添加了一条数据</p>\n<pre><code>* 2.设置一个更改记录就提示的触发器\n```sql\ncreate or replace trigger t_update\nafter update on itpux.emp\nfor each row --提示每一条修改的记录\n    begin\n    dbms_output.put_line(&#39;你修改了ITPUX.EMP 表中多条数据&#39;);\n    end;\n/\n--验证\n--set serverout on\nselect * from emp;\nupdate emp set job=&#39;DBA+SA+HR&#39; where ENAME in (&#39;itpux15&#39;,&#39;itpux16&#39;);\n--你修改了ITPUX.EMP 表中多条数据\n</code></pre><ul>\n<li>3.设置一个删除记录就提示的触发器<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token operator\">or</span> replace <span class=\"token keyword\">trigger</span> t_delete\nbefore <span class=\"token keyword\">delete</span> <span class=\"token keyword\">on</span> itpux<span class=\"token punctuation\">.</span>emp\n<span class=\"token keyword\">begin</span>\n<span class=\"token comment\" spellcheck=\"true\">--select to_char(sysdate,'day') from dual;</span>\n<span class=\"token keyword\">if</span> to_char<span class=\"token punctuation\">(</span>sysdate<span class=\"token punctuation\">,</span><span class=\"token string\">'day'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'星期六'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'星期天'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span>\n  dbms_output<span class=\"token punctuation\">.</span>put_line<span class=\"token punctuation\">(</span><span class=\"token string\">'禁止在周末删除ITPUX.EMP 表数据'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  raise_application_error<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">20001</span><span class=\"token punctuation\">,</span><span class=\"token string\">'禁止在周末删除ITPUX.EMP 表数据'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--</span>\n<span class=\"token operator\">-</span><span class=\"token number\">20000</span><span class=\"token operator\">~</span><span class=\"token number\">20999</span>\n<span class=\"token keyword\">end</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n<span class=\"token comment\" spellcheck=\"true\">--验证</span>\n<span class=\"token comment\" spellcheck=\"true\">--set serverout on</span>\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> emp<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--ORA-20001: 禁止在周末删除ITPUX.EMP 表数据</span>\n</code></pre>\n</li>\n</ul>\n<h3 id=\"12-2-DDL-触发器及案例\"><a href=\"#12-2-DDL-触发器及案例\" class=\"headerlink\" title=\"12.2 DDL 触发器及案例\"></a>12.2 DDL 触发器及案例</h3><ul>\n<li>语法<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token operator\">or</span> replace <span class=\"token keyword\">trigger</span> ddl 触发器名称\n<span class=\"token keyword\">after</span> ddl <span class=\"token keyword\">on</span> 方案名<span class=\"token punctuation\">.</span><span class=\"token keyword\">schema</span>\n<span class=\"token keyword\">begin</span>\n  执行语句<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li>基本使用<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--SYSTEM 用户</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> itpux_ddl01\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> itpux_ddl01\n<span class=\"token punctuation\">(</span>\n  dbname varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  event varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  username varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  client_ip varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  ddl_time <span class=\"token keyword\">date</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token operator\">or</span> replace <span class=\"token keyword\">trigger</span> t_itpux_ddl01\n<span class=\"token keyword\">after</span> ddl <span class=\"token keyword\">on</span> itpux<span class=\"token punctuation\">.</span><span class=\"token keyword\">schema</span>\n<span class=\"token keyword\">begin</span>\n  <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> itpux_ddl01 <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span>ora_database_name<span class=\"token punctuation\">,</span>ora_sysevent<span class=\"token punctuation\">,</span>ora_login_user<span class=\"token punctuation\">,</span>ora_client_ip_address<span class=\"token punctuation\">,</span>\n  sysdate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--切换至ITPUX 用户</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> itpux012<span class=\"token punctuation\">(</span>id number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> system<span class=\"token punctuation\">.</span>itpux_ddl01<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"12-3-参考资料\"><a href=\"#12-3-参考资料\" class=\"headerlink\" title=\"12.3 参考资料\"></a>12.3 参考资料</h3><code>`</code>sql<br>系统触发器创建基本语法：<br>create or replace trigger 系统触发器名称<br>after[before] logon[logoff] on datebase<br>begin<br>  执行语句;<br>end;</li>\n</ul>\n<p>详细说明：<br>after 事件之后触发<br>before 事件之前触发<br>logon 登陆触发<br>logoff 登出触发<br>startup 开启系统触发<br>shutdown 关闭系统触发</p>\n<pre><code>```sql\n------------------------------参考资料---------------------------------------\n下面介绍一些常用的系统事件属性函数，和建立各种事件触发器的方法在建立系统事\n件触发器时，需要使用事件属性函数，\n常用的事件属性函数如下：\nora_client_ip_address //返回客户端的ip\nora_database_name //返回数据库名称\nora_login_user //返回登陆用户名\nora_sysevent //返回触发器的系统事件名\nora_des_encrypted_password //返回用户des(md5)加密后的密码\n事件属性函数表\nOra_client_ip_address 返回客户端的ip 地址\nOra_database_name 返回当前数据库名\nOra_des_encrypted_password 返回des 加密后的用户口令\nOra_dict_obj_name 返回ddl 操作所对应的数据库对象名\nOra_dict_obj_name_list(name_list out ora_name_list_t)返回在事件中被修改的对\n象名列表\nOra_dict_obj_owner 返回ddl 操作所对应的对象的所有者名\nOra_dict_obj_owner_list(owner_list out ora_name_list_t)返回在事件中被修改的对\n象的所有者列表\nOra_dict_obj_type 返回ddl 操作所对应的数据库对象的类型\nOra_grantee(user_list out ora_name_list_t)返回授权事件的授权者\nOra_instance_num 返回例程号\nOra_is_alter_column(column_name in varchar2)检测特定列是否被修改\nOra_is_creating_nested_table 检测是否正在建立嵌套表\nOra_is_drop_column(column_name in varchar2)检测特定列是否被删除\nOra_is_servererror(error_number)检测是否返回了特定oracle 错误\nOra_login_user 返回登录用户名\nOra_sysevent 返回触发器的系统事件名\n系统触发器的种类和事件出现的时机（前或后）：\n事件允许的时机说明\nSTARTUP AFTER 启动数据库实例之后触发\nSHUTDOWN BEFORE 关闭数据库实例之前触发（非正常关闭不触发）\nSERVERERROR AFTER 数据库服务器发生错误之后触发\nLOGON AFTER 成功登录连接到数据库后触发\nLOGOFF BEFORE 开始断开数据库连接之前触发\nCREATE BEFORE，AFTER 在执行CREATE 语句创建数据库对象之前、之后\n触发\nDROP BEFORE，AFTER 在执行DROP 语句删除数据库对象之前、之后触发\nALTER BEFORE，AFTER 在执行ALTER 语句更新数据库对象之前、之后触发\nDDL BEFORE，AFTER 在执行大多数DDL 语句之前、之后触发\nGRANT BEFORE，AFTER 执行GRANT 语句授予权限之前、之后触发\nREVOKE BEFORE，AFTER 执行REVOKE 语句收权限之前、之后触犯发\nRENAME BEFORE，AFTER 执行RENAME 语句更改数据库对象名称之前、之\n后触犯发\nAUDIT/NOAUDIT BEFORE，AFTER 执行AUDIT 或NOAUDIT 进行审计或停\n止审计之前、之后触发\n特别说明：系统触发器的级别较高，由系统管理员来创建。\n------------------------------------------------------------------------------------\n</code></pre><h3 id=\"12-4-数据库系统触发器\"><a href=\"#12-4-数据库系统触发器\" class=\"headerlink\" title=\"12.4 数据库系统触发器\"></a>12.4 数据库系统触发器</h3><ul>\n<li>1.创建<br><code>`</code>sql<br>–记录登录数据库的用户名和IP<br>create table login_info (ip varchar(30),username varchar(30));<br>create or replace trigger logon_ip_info<br>after logon on database<br>declare<br>  ip varchar(30);<br>  user varchar(30);<br>begin<br>  select sys_context(‘USERENV’,’SESSION_USER’) into user from dual;<br>  select sys_context(‘USERENV’,’ip_address’) into ip from dual;<br>  insert into login_info values(ip,user);<br>end;<br>/</li>\n</ul>\n<p>select * from login_info;</p>\n<pre><code>* 2. 管理\n```sql\n--禁用\nalter trigger logon_ip_info disable;\n--启用\nalter trigger logon_ip_info enable;\n--编译\nalter trigger logon_ip_info compile;\n--删除\ndrop trigger logon_ip_info;\n--查询\nselect * from dba_objects where owner=&#39;ITPUX&#39; and object_type=&#39;TRIGGER&#39;;\ndrop trigger ITPUX.T_UPDATE;\ndrop trigger ITPUX.T_DELETE;\ndrop trigger system.t_itpux_ddl01;\n</code></pre><h2 id=\"13-包的创建和使用\"><a href=\"#13-包的创建和使用\" class=\"headerlink\" title=\"13 包的创建和使用\"></a>13 包的创建和使用</h2><ul>\n<li>1 包定义（PACKAGE）<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">2.1</span> 包定义（PACKAGE）\n<span class=\"token keyword\">CREATE</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">OR</span> REPLACE<span class=\"token punctuation\">]</span> PACKAGE package_name\n  {<span class=\"token operator\">IS</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">AS</span>}\n  <span class=\"token punctuation\">[</span>公有数据类型定义<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span>公有游标声明<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span>公有变量、常量声明<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span>公有子程序声明<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span>package_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n定义包规范:\n<span class=\"token keyword\">CREATE</span> <span class=\"token operator\">OR</span> REPLACE\npackage p_stu\n<span class=\"token keyword\">as</span>\n<span class=\"token comment\" spellcheck=\"true\">--定义结构体</span>\n<span class=\"token keyword\">type</span> re_stu <span class=\"token operator\">is</span> record<span class=\"token punctuation\">(</span>\n  rname student<span class=\"token punctuation\">.</span>name<span class=\"token operator\">%</span><span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span>\n  rage student<span class=\"token punctuation\">.</span>age<span class=\"token operator\">%</span><span class=\"token keyword\">type</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--定义游标</span>\n<span class=\"token keyword\">type</span> c_stu <span class=\"token operator\">is</span> ref <span class=\"token keyword\">cursor</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--定义函数</span>\n<span class=\"token keyword\">function</span> numAdd<span class=\"token punctuation\">(</span>num1 number<span class=\"token punctuation\">,</span>num2 number<span class=\"token punctuation\">)</span><span class=\"token keyword\">return</span> number<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--定义过程</span>\n<span class=\"token keyword\">procedure</span> GetStuList<span class=\"token punctuation\">(</span>cid <span class=\"token operator\">in</span> varchar2<span class=\"token punctuation\">,</span>c_st <span class=\"token keyword\">out</span> c_stu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li><ol start=\"2\">\n<li>包主体（PACKAGE BODY）<br><code>`</code>sql<br>CREATE [OR REPLACE] PACKAGE BODY package_name<br>{IS | AS}<br>[私有数据类型定义]<br>[私有变量、常量声明]<br>[私有子程序声明和定义]<br>[公有子程序定义]<br>BEGIN<br>执行部分(初始化部分)<br>END [package_name];</li>\n</ol>\n</li>\n</ul>\n<p>–1 创建包<br>create or replace package itpux_pkg<br>is<br>    procedure update_sal(e_name varchar2,newsal number);<br>    FUNCTION emp_sal_fun(e_name varchar2) return number;<br>end;<br>–2.3 包体<br>create or replace package body itpux_pkg is<br>procedure update_sal(e_name varchar2,newsal number)<br>is<br>begin<br>    update emp set sal=newsal where ename=e_name;<br>end;<br>function emp_sal_fun(e_name varchar2)<br>return number is<br>emp_sal number;<br>begin<br>    select sal<em>12+nvl(comm,0) into emp_sal from emp<br>where ename=e_name;<br>return emp_sal;<br>end;<br>end;<br>–2.4 执行包-调过程<br>set serveroutput on<br>    exec itpux_pkg.update_sal(‘itpux14’,2000);<br>commit;<br>select </em> from emp;<br>–查看itpux14 的记录<br>–2.5 执行包-调函数<br>declare<br>    v_emp_sal number(7,2);<br>begin<br>    v_emp_sal:=itpux_pkg.emp_sal_fun(‘itpux14’);<br>    dbms_output.put_line(‘ITPUX14 的年薪为: ‘||v_emp_sal);<br>end;<br>–ITPUX14 的年薪为: 24000<br>–2.6 删除包<br>select * from dba_objects where owner=’ITPUX’ and object_type=’PACKAGE’;<br>drop package ITPUX_PKG;<br>drop package ITPUXA_PKG;<br><code>`</code></p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"SQL语言之DDL和对象管理\"><a href=\"#SQL语言之DDL和对象管理\" class=\"headerlink\" title=\"SQL语言之DDL和对象管理\"></a>SQL语言之DDL和对象管理</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-介绍用户模拟下可以访问的模式对象\"><a href=\"#1-介绍用户模拟下可以访问的模式对象\" class=\"headerlink\" title=\"1 介绍用户模拟下可以访问的模式对象\"></a>1 介绍用户模拟下可以访问的模式对象</h2><pre><code class=\"sql\">  SELECT object_type, COUNT (*)\n    FROM user_objects\nGROUP BY object_type;\n\n  SELECT object_type, COUNT (*)\n    FROM all_objects\nGROUP BY object_type;\n\nSELECT DISTINCT owner\n  FROM all_objects\n</code></pre>\n<h2 id=\"2-研究模式中的数据类型\"><a href=\"#2-研究模式中的数据类型\" class=\"headerlink\" title=\"2 研究模式中的数据类型\"></a>2 研究模式中的数据类型</h2><pre><code class=\"sql\">-- 1.DESC\n-- 2.SQL\nSELECT column_name, data_type\n  FROM user_tab_columns\n WHERE table_name = &#39;EMPLOYEES&#39;;\n\nSELECT DISTINCT data_type\n  FROM user_tab_columns\n WHERE table_name = &#39;EMPLOYEES&#39;;\n</code></pre>\n<h2 id=\"3-表的创建与管理\"><a href=\"#3-表的创建与管理\" class=\"headerlink\" title=\"3 表的创建与管理\"></a>3 表的创建与管理</h2><h3 id=\"3-1-表的创建\"><a href=\"#3-1-表的创建\" class=\"headerlink\" title=\"3.1 表的创建\"></a>3.1 表的创建</h3><ul>\n<li>语法</li>\n</ul>\n<pre><code class=\"sql\">Create table [schema,] table_name(\ncolumn_name data_type [default express] [constraint]\n[,column_name data_type [default express] [constraint]]\n[,column_name data_type [default express] [constraint]]\n);\n\n\n--1.表的创建与结构变更\n--01.工具\n--A：创建表\n--B：写入数据\n--C：更改结构\n</code></pre>\n<ul>\n<li>SQL 语法</li>\n</ul>\n<pre><code class=\"sql\">--创建sql02,sql03,sql04\n --创建sql02,sql03,sql04\n\nCREATE TABLE SQL02\n(\n    sql02_id        NUMBER (8) NOT NULL,\n    sql02_id2       NUMBER (8) NOT NULL,\n    sql02_date      DATE NOT NULL,\n    sql02_status    VARCHAR2 (8) NOT NULL,\n    sql02_number NUMBER (10, 2)\n);\n\nCREATE TABLE SQL03\n(\n    sql03_id1    NUMBER (8) NOT NULL,\n    sql03_id2    NUMBER (8) NOT NULL,\n    sql03_id3    NUMBER (8) NOT NULL\n);\n\nALTER TABLE sql03\n    MODIFY (sql03_id3 VARCHAR2 (10));\n\nCREATE TABLE SQL04\n(\n    sql04_id        NUMBER (8) NOT NULL,\n    sql04_desc      VARCHAR2 (20) NOT NULL,\n    sql04_status    VARCHAR2 (8) NOT NULL,\n    sql04_price     NUMBER (10, 2) NOT NULL,\n    sql04_date      DATE NOT NULL,\n    sql04_count     NUMBER (8) NOT NULL\n);\n\n</code></pre>\n<h3 id=\"3-2-表的重命名\"><a href=\"#3-2-表的重命名\" class=\"headerlink\" title=\"3.2 表的重命名\"></a>3.2 表的重命名</h3><pre><code class=\"sql\">RENAME sql044 TO sql04;\n\nALTER TABLE SQL04\n    MODIFY sql04_count NUMBER (18);\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count TO SQL04_COUNT2;\n\nALTER TABLE SQL04\n    RENAME COLUMN sql04_count02 TO SQL04_COUNT;\n\nSELECT * FROM tab \nSELECT * FROM user_tables\n</code></pre>\n<h3 id=\"3-3-表的复制\"><a href=\"#3-3-表的复制\" class=\"headerlink\" title=\"3.3 表的复制\"></a>3.3 表的复制</h3><pre><code class=\"sql\">CREATE TABLE itpux05\nAS\n    SELECT * FROM sql04;\n\nSELECT * FROM sql01;\n\nCREATE TABLE itpux06\nAS\n    SELECT *\n      FROM sql01\n     WHERE sql01_id = 1;\n\nSELECT * FROM itpux06\n</code></pre>\n<h3 id=\"3-4-表的截断\"><a href=\"#3-4-表的截断\" class=\"headerlink\" title=\"3.4 表的截断\"></a>3.4 表的截断</h3><pre><code class=\"sql\">--100g delete 2h,truncate 2 分钟。\nTRUNCATE TABLE itpux07;\nSELECT * FROM itpux07\n</code></pre>\n<h3 id=\"3-4-表的删除\"><a href=\"#3-4-表的删除\" class=\"headerlink\" title=\"3.4 表的删除\"></a>3.4 表的删除</h3><pre><code class=\"sql\">DROP TABLE itpux06;\n</code></pre>\n<h3 id=\"3-4-删除表的定义\"><a href=\"#3-4-删除表的定义\" class=\"headerlink\" title=\"3.4 .删除表的定义\"></a>3.4 .删除表的定义</h3><pre><code class=\"sql\">DROP TABLE table_name CASCADE CONSTRAINTS;              --相关的视图，约束，等相关所有的关系对象。\nDROP TABLE table_name PURGE;                            --释放资源，不经过回收站。\nDROP TABLE itpux05 CASCADE CONSTRAINTS;\nDROP TABLE itpux05 PURGE;\n</code></pre>\n<h2 id=\"4-簇的概念与介绍\"><a href=\"#4-簇的概念与介绍\" class=\"headerlink\" title=\"4 簇的概念与介绍\"></a>4 簇的概念与介绍</h2><blockquote>\n<p>簇(cluster)其实就是一组表，由一组共享相同数据块的多个表组成，将经常一起使用的表<br>组合在一起成簇可以提高处理效率；在一个簇中的表就叫做簇表。</p>\n</blockquote>\n<ul>\n<li>不宜用聚簇表的情况</li>\n</ul>\n<pre><code class=\"sql\">1)如果预料到聚簇中的表会大量修改,聚簇表会对DML 的性能产生负面影响\n2)非常不适合对单表的全表扫描,因为只能引起对其它表的全表扫描\n3)频繁对表进行TRUNCATE 和加载,因为聚簇中的表是不能TRUNCATE 的，只能\nTRUNCATE 簇\n4)如果表只是偶尔被连接或者它们的公共列经常被修改，则不要聚簇表\n5)如果经常从所有有相同聚簇键值的表查询出的结果数据超过一个或两个Oracle 块，\n则不要聚簇表\n6)如果空间不够，并且不能为将要插入的新记录分配额外的空间，那么不要使用聚簇\n</code></pre>\n<h2 id=\"5-临时表的创建与使用\"><a href=\"#5-临时表的创建与使用\" class=\"headerlink\" title=\"5 临时表的创建与使用\"></a>5 临时表的创建与使用</h2><h3 id=\"5-1-会话级临时表\"><a href=\"#5-1-会话级临时表\" class=\"headerlink\" title=\"5.1 会话级临时表\"></a>5.1 会话级临时表</h3><pre><code class=\"sql\">--会话结束自动清空数据\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit preserve rows;\n</code></pre>\n<h3 id=\"5-2-事务级临时表\"><a href=\"#5-2-事务级临时表\" class=\"headerlink\" title=\"5.2 事务级临时表\"></a>5.2 事务级临时表</h3><pre><code class=\"sql\">--事务结束（commit,rollback） ，清除数据。\nCREATE GLOBAL TEMPORARY TABLE table_name\n(\n    col1 type1,\n    col2 type2...\n)\non commit delete rows;\n</code></pre>\n<h2 id=\"6-索引的创建与管理\"><a href=\"#6-索引的创建与管理\" class=\"headerlink\" title=\"6 索引的创建与管理\"></a>6 索引的创建与管理</h2><h2 id=\"6-1-索引分类\"><a href=\"#6-1-索引分类\" class=\"headerlink\" title=\"6.1 索引分类\"></a>6.1 索引分类</h2><ul>\n<li><p>逻辑分类</p>\n<pre><code class=\"sql\">1.单列或多列\n2.唯一索引和非唯一索引\n3.函数索引\nDoman\n</code></pre>\n</li>\n<li><p>物理分类<br><code>`</code>sql<br>物理分类:<br>B-TREE<br>Bitmap</p>\n</li>\n</ul>\n<p>B<em>Tree 索引<br>B</em>Tree 索引是最常见的索引结构，默认建立的索引就是这种类型的索引。</p>\n<p>DML 语句：<br>Create index indexname on tablename(columnname[columnname…])<br>Bitmap 索引<br>位图索引主要用于决策支持系统或静态数据，不支持行级锁定</p>\n<pre><code>## 6.2 索引的日常管理\n* 基本语法\n```sql\nCREATE [UNIQUE] | [BITMAP] INDEX index_name --unique 表示唯一索引\nON table_name([column1 [ASC|DESC],column2 --bitmap，创建位图索引\n[ASC|DESC],…] | [express])\n[TABLESPACE tablespace_name]\n[PCTFREE n1] --指定索引在数据块中空闲空间\n[STORAGE (INITIAL n2)]\n[NOLOGGING] --表示创建和重建索引时允许\n对表做DML 操作，默认情况下不应该使用\n[NOLINE]\n[NOSORT]; --表示创建索引时不进行排序，\n默认不适用，如果数据已经是按照该索引顺序排列的可以使用\n</code></pre><ul>\n<li>1.添加/创建索引<br><code>`</code>sql<br>–工具</li>\n</ul>\n<p>CREATE INDEX cust_name_i1<br>    ON SQL01 (sql01_name);       –单列索引</p>\n<p>CREATE INDEX cust_name_i1<br>    ON SQL01 (sql01_name)<br>    TABLESPACE ITPUX;            –单列<br>索引指定表空间<br>–命令</p>\n<p>CREATE INDEX cust_name_i2<br>    ON sql01 (sql01_name, sql01_status);    –组合索引</p>\n<p>CREATE BITMAP INDEX sql01_level_i3<br>    ON sql01 (sql01_level);      –位图索引</p>\n<pre><code>\n* 2.修改索引\n```sql\n--重命名索引\n\nALTER INDEX cust_name_i1\n    RENAME TO idx1_sql01_name;\n\n--合并索引\n\nALTER INDEX idx1_sql01_name\n    COALESCE;\n</code></pre><ul>\n<li>3.重建索引<br><code>`</code>sql<br>–重命名索引</li>\n</ul>\n<p>–删除原来的索引，重新建立索引。<br>DROP INDEX idx1_sql01_name;</p>\n<p>CREATE INDEX idx1_sql01_name<br>    ON SQL01 (sql01_name);</p>\n<p>–直接rebuild</p>\n<p>ALTER INDEX idx1_sql01_name<br>    REBUILD;                                    –会锁表。</p>\n<p>ALTER INDEX idx1_sql01_name<br>    REBUILD ONLINE;</p>\n<pre><code>\n* 4.删除索引\n```sql\nDROP INDEX idx1_sql01_name;\n</code></pre><ul>\n<li>5.查看索引<br><code>`</code>sql<br>–select * from user_indexes;</li>\n</ul>\n<p>SELECT *<br>  FROM dba_indexes<br> WHERE owner = ‘ITPUX’;</p>\n<p>SELECT *<br>  FROM dba_indexes<br> WHERE table_name = ‘SQL01’;</p>\n<p>–select <em> from all_indexes;<br>–select </em> from user_ind_columns;</p>\n<p>SELECT *<br>  FROM dba_ind_columns<br> WHERE index_owner = ‘ITPUX’ AND table_name = ‘SQL01’;</p>\n<p>–select * from all_ind_columns;</p>\n<p>SELECT index_name,<br>       column_name,<br>       index_type,<br>       uniqueness,<br>       tablespace_name<br>  FROM dba_indexes NATURAL JOIN dba_ind_columns<br> WHERE table_name = ‘SQL01’;</p>\n<pre><code>## 7 约束的创建与管理\n### 7.1  5种约束\n\n* 1.not null (非空约束)\n```sql\n--1.1 创建表的时候\n\nCREATE TABLE itpux01\n(\n    id    NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20)\n);\n\n--1.2 在已经创建的表加添加\n\nCREATE TABLE itpux02\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux02\n    MODIFY id NOT NULL;\n\n--1.3 验证。\n\nINSERT INTO itpux02\n     VALUES (NULL, &#39;name&#39;);\n\nINSERT INTO itpux02\n     VALUES (1, &#39;name&#39;);\n\nSELECT * FROM itpux02;\n\n--1.4 删除\n\nALTER TABLE itpux02\n    MODIFY id NULL;\n\nINSERT INTO itpux02\n     VALUES (NULL, &#39;name&#39;);\n\nSELECT * FROM itpux02;\n\nINSERT INTO itpux02\n     VALUES (2, &#39;name&#39;);\n</code></pre><ul>\n<li>2.primary key 约束<br><code>`</code>sql<br>DROP TABLE itpux01;<br>CREATE TABLE itpux01<br>(<br>  id    NUMBER NOT NULL PRIMARY KEY,<br>  name VARCHAR2 (20)<br>);<br>–1.2 在已经创建的表加添加<br>DROP TABLE itpux02;</li>\n</ul>\n<p>CREATE TABLE itpux02<br>(<br>    id NUMBER,<br>    name VARCHAR2 (20)<br>);</p>\n<p>ALTER TABLE itpux02<br>    ADD CONSTRAINT itpux02_id_con PRIMARY KEY (id); –建议命名<br>–alter table itpux02 drop constraint itpux02_id_con;</p>\n<p>ALTER TABLE itpux02<br>    ADD PRIMARY KEY (id);</p>\n<p>–1.3 删除</p>\n<p>ALTER TABLE itpux02<br>    DROP CONSTRAINT itpux02_id_con;</p>\n<p>ALTER TABLE itpux02<br>    DROP CONSTRAINT SYS_C0011169;</p>\n<pre><code>\n* 3.unique 约束\n```sql\n--3.1 创建表的时候\n\nCREATE TABLE itpux03\n(\n    id      NUMBER NOT NULL,\n    name    VARCHAR2 (20) UNIQUE\n);\n\nINSERT INTO itpux03\n     VALUES (1, &#39;name1&#39;);\n\nINSERT INTO itpux03\n     VALUES (2, &#39;name2&#39;);\n\n--3.2 删除\n\nALTER TABLE itpux03\n    DROP UNIQUE (name);\n\nINSERT INTO itpux03\n     VALUES (3, &#39;name2&#39;);\n\n--3.3 后期添加\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n\nDELETE FROM itpux03\n      WHERE id = 3;\n\nALTER TABLE itpux03\n    ADD UNIQUE (name);\n</code></pre><ul>\n<li>4.Check 约束<br><code>`</code>sql<br>–4.1 新建表添加约束</li>\n</ul>\n<p>CREATE TABLE itpux04<br>(<br>    id     NUMBER NOT NULL PRIMARY KEY,<br>    name VARCHAR2 (20),<br>    age    NUMBER CONSTRAINT itpux04_age_con CHECK (age &gt; 17)<br>);</p>\n<p>INSERT INTO itpux04<br>     VALUES (1, ‘mm’, 16);</p>\n<p>INSERT INTO itpux04<br>     VALUES (2, ‘mm’, 18);</p>\n<p>–4.2 删除</p>\n<p>ALTER TABLE itpux04<br>    DROP CONSTRAINT itpux04_age_con;</p>\n<p>–4.3 后期<br>alter table itpux04 add constraint itpux04_age_con check(age&gt;17);</p>\n<pre><code>\n* 5.Foreign key 约束\n```sql\nCREATE TABLE itpux051\n(\n    jobid    NUMBER NOT NULL PRIMARY KEY,\n    name1 VARCHAR2 (20),\n    age NUMBER (3)\n);\n\nCREATE TABLE itpux052\n(\n    no      NUMBER NOT NULL PRIMARY KEY,\n    dcname VARCHAR2 (20),\n    dcid    NUMBER REFERENCES itpux051 (jobid)\n);\n\nINSERT INTO itpux052\n     VALUES (1, &#39;dc1008&#39;, 20161218);                                                  --error\n\nINSERT INTO itpux051\n     VALUES (20161218, &#39;风哥&#39;, 31);\n\nINSERT INTO itpux052\n     VALUES (1, &#39;dc1008&#39;, 20161218);\n\nSELECT * FROM itpux051;\n\nSELECT * FROM itpux052;\n\n--删除\n\nALTER TABLE itpux052\n    DROP CONSTRAINT SYS_C0011182;\n\nDROP TABLE itpux051;\nDROP TABLE itpux051 CASCADE CONSTRAINTS;\n--后期增加\n\nALTER TABLE itpux052\n    ADD CONSTRAINT itpux052_dcid_con FOREIGN KEY (dcid)\n        REFERENCES itpux051 (jobid);\n</code></pre><h3 id=\"7-1-约束的管理\"><a href=\"#7-1-约束的管理\" class=\"headerlink\" title=\"7.1  约束的管理\"></a>7.1  约束的管理</h3><ul>\n<li>1.约束表级定义与列级定义<br><code>`</code>sql<br>–1.1 表级定义<br>CREATE TABLE itpux08<br>(<br>  id NUMBER (8),<br>  name VARCHAR2 (50),<br>  CONSTRAINT pk_itpux08_id PRIMARY KEY (id)<br>);</li>\n</ul>\n<p>–1.2 列级定义<br>CREATE TABLE itpux09<br>(<br>    id    NUMBER (8) CONSTRAINT pk_itpux09_id PRIMARY KEY,<br>    name VARCHAR2 (50)<br>);</p>\n<pre><code>\n* 2.约束的disable/enable,validate/novalidate 的区别\n```sql\n--disable 禁用\n--disable validate --关闭后，不能增删改\n--disable novalidate --关闭后，可以增删改\n--enable 启用\n--enable validate --启用后，进行所有约束，有的，新加的\n--enable novalidate --启用后，对新加入的约束，对旧的不约束\n--2.1 非主键的\n\nCREATE TABLE itpux06\n(\n    id     NUMBER NOT NULL PRIMARY KEY,\n    name VARCHAR2 (20),\n    age    NUMBER CONSTRAINT itpux06_age_con CHECK (age &gt; 17)\n);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;   --novalidate\n\nINSERT INTO itpux06\n     VALUES (2, &#39;name2&#39;, 18);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nALTER TABLE itpux06\n    DISABLE VALIDATE CONSTRAINT itpux06_age_con;                                                                 --validate\n\nINSERT INTO itpux06\n     VALUES (3, &#39;name3&#39;, 18);              --error\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --validate\n\nINSERT INTO itpux06\n     VALUES (3, &#39;name3&#39;, 18);\n\nALTER TABLE itpux06\n    DISABLE CONSTRAINT itpux06_age_con;    --novalidate\n\nINSERT INTO itpux06\n     VALUES (4, &#39;name4&#39;, 16);\n\nALTER TABLE itpux06\n    ENABLE CONSTRAINT itpux06_age_con;     --errpr\n\nALTER TABLE itpux06\n    ENABLE NOVALIDATE CONSTRAINT itpux06_age_con;\n\n--2.2 主键的\n\nCREATE TABLE itpux07\n(\n    id NUMBER,\n    name VARCHAR2 (20)\n);\n\nALTER TABLE itpux07\n    ADD CONSTRAINT itpux07_id_con PRIMARY KEY (id);\n\nINSERT INTO itpux07\n     VALUES (1, &#39;name1&#39;);\n\nALTER TABLE itpux07\n    DISABLE CONSTRAINT itpux07_id_con;    --novalidate\n\nINSERT INTO itpux07\n     VALUES (1, &#39;name2&#39;);\n\nSELECT * FROM itpux07;\n\nALTER TABLE itpux07\n    ENABLE CONSTRAINT itpux07_id_con;    --error\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --error\n\nCREATE INDEX idx_itpux07_id\n    ON itpux07 (id);\n\nALTER TABLE itpux07\n    ENABLE NOVALIDATE CONSTRAINT itpux07_id_con;                                                                 --ok\n\nSELECT * FROM itpux07;\n</code></pre><h3 id=\"7-3-显示约束的信息\"><a href=\"#7-3-显示约束的信息\" class=\"headerlink\" title=\"7.3 显示约束的信息\"></a>7.3 显示约束的信息</h3><ul>\n<li><p>1.约束的数据字典</p>\n<pre><code class=\"sql\">select * from all_constraints;\nselect * from dba_constraints;\nselect * from user_constraints;\nselect distinct constraint_type from user_constraints ;\n-- R references : column\n-- U unique : column\n-- P primary key : column\n-- C check : column\n-- O read only on a view : object\n-- V Check on a view : object\nselect * from all_cons_columns;\nselect * from dba_cons_columns;\nselect * from user_cons_columns;\nselect * from dba_constraints where table_name=&#39;ITPUX08&#39;;\n</code></pre>\n</li>\n<li><p>2.约束的可延迟属性<br><code>`</code>sql<br>select * from dba_constraints where table_name=’ITPUX08’;</p>\n</li>\n</ul>\n<p>–DEFERRABLE(延迟条件): NOT DEFERRABLE(默认，立即验证), DEFERRABLE（提<br>交时验证）<br>–DEFERRED ： IMMEDIATE(默认，立即验证)，DEFERRED（提交时才验证）,<br>–set constraint 名字immediate;<br>–用途：物化视图，级联更新。</p>\n<p>create table itpux10(<br>id number not null primary key DEFERRABLE initially IMMEDIATE,<br>name varchar2(20),<br>age number constraint itpux10_age_con check(age&gt;17) DEFERRABLE<br>initially DEFERRED);</p>\n<p>select * from dba_constraints where table_name=’ITPUX10’;</p>\n<pre><code>## 8 视图的创建与管理\n### 8.1 语法\n```sql\nCREATE [OR REPLACE] [FORCE|NOFORCE] VIEW view_name\n[(alias[, alias]...)]\nAS subquery\n[WITH CHECK OPTION [CONSTRAINT constraint]]\n[WITH READ ONLY]\nOR REPLACE ：若所创建的试图已经存在，ORACLE 自动重建该视图；\nFORCE ：不管基表是否存在ORACLE 都会自动创建该视图；\nNOFORCE ：只有基表都存在ORACLE 才会创建该视图：\nalias ：为视图产生的列定义的别名；\nsubquery ：一条完整的SELECT 语句，可以在该语句中定义别名；\nWITH CHECK OPTION ：插入或修改的数据行必须满足视图定义的约束；\nWITH READ ONLY ：该视图上不能进行任何DML 操作。\n-- O read only on a view : object\n-- V Check OPTION on a view : object\n</code></pre><h2 id=\"9-同义词创建和使用\"><a href=\"#9-同义词创建和使用\" class=\"headerlink\" title=\"9 同义词创建和使用\"></a>9 同义词创建和使用</h2><pre><code class=\"sql\">--1.创建同义词\ncreate synonym yg_s for yg_v;\ncreate synonym bm_s for bm_v;\ncreate synonym bm_sum_s for bm_sum_v;\nselect * from yg_s;\nselect * from bm_s;\ndrop view yg_v;\ndrop view bm_v;\nalter view bm_sum_v compile;\ndrop view bm_sum_v;\nalter synonym yg_s compile;\n\n--2.删除同义词\ndrop synonym yg_s;\ndrop synonym bm_s;\ndrop synonym bm_sum_s;\n\n--3.查看同义词\nselect * from dba_synonyms where owner=&#39;ITPUX&#39;;\nselect * from all_synonyms\nselect * from user_synonyms\nselect * from scott.emp;\ncreate synonym emp_s for scott.emp;\nselect * from emp_s;\ncreate table emp as select * from scott.emp;\nselect * from emp;\n\n--4.权限\ngrant create synonym to itpux01;\ngrant create any synonym to itpux01;\ngrant create public synonym to itpux01;\n</code></pre>\n<h2 id=\"10-序列创建和使用\"><a href=\"#10-序列创建和使用\" class=\"headerlink\" title=\"10 序列创建和使用.\"></a>10 序列创建和使用.</h2><h3 id=\"10-1-语法\"><a href=\"#10-1-语法\" class=\"headerlink\" title=\"10.1 语法\"></a>10.1 语法</h3><pre><code class=\"sql\">创建序列：\n1、要有创建序列的权限create sequence 或create any sequence\n2、创建序列的语法\nCREATE SEQUENCE sequence //创建序列名称\n        [INCREMENT BY n] //递增的序列值是n 如果n 是正数就递增,如果是负数\n        就递减默认是1\n        [START WITH n] //开始的值,递增默认是minvalue 递减是maxvalue\n        [{MAXVALUE n | NOMAXVALUE}] //最大值\n        [{MINVALUE n | NOMINVALUE}] //最小值\n        [{CYCLE | NOCYCLE}] //循环/不循环\n        [{CACHE n | NOCACHE}];//分配并存入到内存中\n    NEXTVAL 返回序列中下一个有效的值，任何用户都可以引用\n    CURRVAL 中存放序列的当前值\n    NEXTVAL 应在CURRVAL 之前指定，二者应同时有效\n</code></pre>\n<h3 id=\"10-2-日常使用\"><a href=\"#10-2-日常使用\" class=\"headerlink\" title=\"10.2 日常使用\"></a>10.2 日常使用</h3><pre><code class=\"sql\">--创建普通序列\ncreate sequence seql start with 10 nocache maxvalue 15 cycle;\ncreate sequence seql1\n--创建一个带主键的表\ndrop table seqtest\ncreate table seqtest(\n    c1 number,\n    c2 varchar2(10)\n);\nalter table seqtest add constraint seqtest_pk primary key (c1);\ncreate sequence seq_test_pk_s\n    minvalue 1\n    maxvalue 9999999999999999\n    start with 1\n    increment by 1\n    cache 20;\n--间断\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,&#39;11&#39;);\ncommit;\n\nB:\ninsert into seqtest values (seq_test_pk_s.nextval,&#39;22&#39;);\nA:\ninsert into seqtest values (seq_test_pk_s.nextval,&#39;33&#39;);\ncommit;\nselect * from seqtest;\nB:\nrollback;\nselect * from seqtest;\n--删除\ndrop table seqtest\ndrop sequence SEQ_TEST_PK_S\n</code></pre>\n<h2 id=\"11-存储过程创建和使用\"><a href=\"#11-存储过程创建和使用\" class=\"headerlink\" title=\"11 存储过程创建和使用\"></a>11 存储过程创建和使用</h2><h3 id=\"11-1-语法\"><a href=\"#11-1-语法\" class=\"headerlink\" title=\"11.1 语法\"></a>11.1 语法</h3><pre><code class=\"sql\">CREATE [OR REPLACE] PROCEDURE procedure_name\n[(parameter1[model] datatype1, parameter2 [model] datatype2..)]\nIS[AS]\nBEGIN\nPL/SQL;\nEND [procedure_name];\n</code></pre>\n<h3 id=\"11-2日常使用\"><a href=\"#11-2日常使用\" class=\"headerlink\" title=\"11.2日常使用\"></a>11.2日常使用</h3><pre><code class=\"sql\">--1.编写存储过程\n--显示当前系统时间\n--通过pl/sql dev 菜单\n--手写\ncreate or replace procedure print_sysdate\nis\nbegin\n    dbms_output.put_line(sysdate);\n    end print_sysdate;\n/\n--2.存储过程的调用\n--sqlplus,pl/sql 代码块\nexec print_sysdate;\n--set serverout on;\n--exec print_sysdate();\n\n--3.存储过程的删除\ndrop procedure test1;\n--4.编译存储过程\n--界面\n--命令\nalter procedure print_sysdate compile;\n\n\n--5.查询存储过程\nselect * from dba_objects where object_type=&#39;PROCEDURE&#39; and\nowner=&#39;ITPUX&#39;;\nselect * from all_objects where object_type=&#39;PROCEDURE&#39; and owner=&#39;ITPUX&#39;;\nselect * from user_objects where object_type=&#39;PROCEDURE&#39;;\n\n--6.查看存储过程的内容\n--界面\n--命令\nselect * from user_source where name=&#39;PRINT_SYSDATE&#39;;\nselect * from dba_source where owner=&#39;ITPUX&#39; and name=&#39;PRINT_SYSDATE&#39;;\nselect * from all_source;\nselect text from user_source where name=&#39;PRINT_SYSDATE&#39;;\nselect * from dba_source where type=&#39;PROCEDURE&#39; and text like &#39;%sysdate%&#39;;\n</code></pre>\n<h3 id=\"11-3-存储过程中事务处理\"><a href=\"#11-3-存储过程中事务处理\" class=\"headerlink\" title=\"11.3 存储过程中事务处理\"></a>11.3 存储过程中事务处理</h3><ul>\n<li>存储过程中事务处理<br><code>`</code>sql<br>–案例1 显示YG 表中员工人数的存储过程。<br>create or replace procedure yg_count<br>as<br>v_total number(10);<br>begin<br>  select count(*) into v_total from yg;<br>  dbms_output.put_line(‘员工总人数为：’||v_total);<br>end;<br>set serverout on;<br>execute yg_count;<br>–员工总人数为：107</li>\n</ul>\n<p>–案例2 存储过程中的增删改DML 事务操作。<br>–准备<br>create table itpux_st(id int,name varchar2(10));<br>insert into itpux_st values(1,’itpux01’);<br>insert into itpux_st values(2,’itpux02’);<br>commit;</p>\n<p>–2.1 增加<br>–创建过程<br>create or replace procedure pro_insert<br>(v_id int,v_name varchar2)<br>is<br>begin<br>    insert into itpux_st values(v_id,v_name);<br>commit;<br>end;<br>–执行<br>begin<br>    pro_insert(3,’itpux03’);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.2 删除<br>–创建过程<br>create or replace procedure pro_delete<br>(v_id int)<br>is<br>begin<br>    delete from itpux_st where id=v_id;<br>commit;<br>end;<br>–执行<br>begin<br>pro_delete(3);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.3 更新/更改<br>–创建过程<br>create or replace procedure pro_update<br>(v_id int,v_name varchar2)<br>is<br>begin<br>    update itpux_st set name=v_name where id=v_id;<br>commit;<br>end;<br>–执行<br>begin<br>    pro_update(2,’itpux02222’);<br>end;<br>–检查<br>select * from itpux_st;</p>\n<p>–2.4 查询<br>–创建过程<br>create or replace procedure pro_select<br>(v_id int) –定义输入变量<br>is<br>    v_name varchar2(10);–定义输出变量<br>begin<br>    select name into v_name from itpux_st where id=v_id;–执行查询<br>    dbms_output.put_line(‘学生姓名为：’||v_name);–输出结果<br>end;<br>–执行<br>–set serverout on;<br>begin<br>pro_select(2);<br>end;</p>\n<pre><code>\n## 12 触发器创建和使用\n* 1.触发器的语法\n```sql\nCREATE [OR REPLACE] TIGGER 触发器名触发时间触发事件\n    ON 表名/视图名\n    [FOR EACH ROW] //加上FOR EACH ROW 即为行级触发器，不加时为语句\n    级触发器\n    BEGIN\n    pl/sql 语句\n    END\n</code></pre><h3 id=\"12-1-DML-触发器及案例\"><a href=\"#12-1-DML-触发器及案例\" class=\"headerlink\" title=\"12.1 DML 触发器及案例\"></a>12.1 DML 触发器及案例</h3><ul>\n<li><p>语法</p>\n<pre><code class=\"sql\">create [or replace] trigger 触发器名称\n  {before|after}\n  {insert|delete|update[of column [,column...]]}\n  or {insert|delete|update[of column [,column...]]}\n  on [schema.] 表名|[schema.]视图\n  [for each row]\n  [when condition]\nbegin\n执行语句;\nend;\n</code></pre>\n</li>\n<li><p>1.设置一个添加记录就提示的触发器<br><code>`</code>sql<br>create or replace trigger t1<br>after insert on itpux.emp<br>  begin</p>\n<pre><code>  dbms_output.put_line(&#39;你向ITPUX.EMP 表中添加了一条数据&#39;);\n</code></pre><p>  end;<br>/</p>\n</li>\n</ul>\n<p>–验证<br>–set serverout on<br>insert into emp values(‘8000’,’itpux15’,’DBA’,’8001’,sysdate,’15000’,’0’,’30’);<br>insert into emp values(‘8002’,’itpux16’,’DBA’,’8002’,sysdate,’15000’,’0’,’30’);<br>–你向ITPUX.EMP 表中添加了一条数据</p>\n<pre><code>* 2.设置一个更改记录就提示的触发器\n```sql\ncreate or replace trigger t_update\nafter update on itpux.emp\nfor each row --提示每一条修改的记录\n    begin\n    dbms_output.put_line(&#39;你修改了ITPUX.EMP 表中多条数据&#39;);\n    end;\n/\n--验证\n--set serverout on\nselect * from emp;\nupdate emp set job=&#39;DBA+SA+HR&#39; where ENAME in (&#39;itpux15&#39;,&#39;itpux16&#39;);\n--你修改了ITPUX.EMP 表中多条数据\n</code></pre><ul>\n<li>3.设置一个删除记录就提示的触发器<pre><code class=\"sql\">create or replace trigger t_delete\nbefore delete on itpux.emp\nbegin\n--select to_char(sysdate,&#39;day&#39;) from dual;\nif to_char(sysdate,&#39;day&#39;) in (&#39;星期六&#39;,&#39;星期天&#39;) then\n  dbms_output.put_line(&#39;禁止在周末删除ITPUX.EMP 表数据&#39;);\n  raise_application_error(-20001,&#39;禁止在周末删除ITPUX.EMP 表数据&#39;); --\n-20000~20999\nend if;\nend;\n/\n--验证\n--set serverout on\ndelete from emp;\n--ORA-20001: 禁止在周末删除ITPUX.EMP 表数据\n</code></pre>\n</li>\n</ul>\n<h3 id=\"12-2-DDL-触发器及案例\"><a href=\"#12-2-DDL-触发器及案例\" class=\"headerlink\" title=\"12.2 DDL 触发器及案例\"></a>12.2 DDL 触发器及案例</h3><ul>\n<li>语法<pre><code class=\"sql\">create or replace trigger ddl 触发器名称\nafter ddl on 方案名.schema\nbegin\n  执行语句;\nend;\n</code></pre>\n</li>\n<li>基本使用<pre><code class=\"sql\">--SYSTEM 用户\ndrop table itpux_ddl01\ncreate table itpux_ddl01\n(\n  dbname varchar2(100),\n  event varchar2(100),\n  username varchar2(30),\n  client_ip varchar2(100),\n  ddl_time date\n);\ncreate or replace trigger t_itpux_ddl01\nafter ddl on itpux.schema\nbegin\n  insert into itpux_ddl01 values(ora_database_name,ora_sysevent,ora_login_user,ora_client_ip_address,\n  sysdate);\nend;\n--切换至ITPUX 用户\ncreate table itpux012(id number);\nselect * from system.itpux_ddl01;\n</code></pre>\n<h3 id=\"12-3-参考资料\"><a href=\"#12-3-参考资料\" class=\"headerlink\" title=\"12.3 参考资料\"></a>12.3 参考资料</h3><code>`</code>sql<br>系统触发器创建基本语法：<br>create or replace trigger 系统触发器名称<br>after[before] logon[logoff] on datebase<br>begin<br>  执行语句;<br>end;</li>\n</ul>\n<p>详细说明：<br>after 事件之后触发<br>before 事件之前触发<br>logon 登陆触发<br>logoff 登出触发<br>startup 开启系统触发<br>shutdown 关闭系统触发</p>\n<pre><code>```sql\n------------------------------参考资料---------------------------------------\n下面介绍一些常用的系统事件属性函数，和建立各种事件触发器的方法在建立系统事\n件触发器时，需要使用事件属性函数，\n常用的事件属性函数如下：\nora_client_ip_address //返回客户端的ip\nora_database_name //返回数据库名称\nora_login_user //返回登陆用户名\nora_sysevent //返回触发器的系统事件名\nora_des_encrypted_password //返回用户des(md5)加密后的密码\n事件属性函数表\nOra_client_ip_address 返回客户端的ip 地址\nOra_database_name 返回当前数据库名\nOra_des_encrypted_password 返回des 加密后的用户口令\nOra_dict_obj_name 返回ddl 操作所对应的数据库对象名\nOra_dict_obj_name_list(name_list out ora_name_list_t)返回在事件中被修改的对\n象名列表\nOra_dict_obj_owner 返回ddl 操作所对应的对象的所有者名\nOra_dict_obj_owner_list(owner_list out ora_name_list_t)返回在事件中被修改的对\n象的所有者列表\nOra_dict_obj_type 返回ddl 操作所对应的数据库对象的类型\nOra_grantee(user_list out ora_name_list_t)返回授权事件的授权者\nOra_instance_num 返回例程号\nOra_is_alter_column(column_name in varchar2)检测特定列是否被修改\nOra_is_creating_nested_table 检测是否正在建立嵌套表\nOra_is_drop_column(column_name in varchar2)检测特定列是否被删除\nOra_is_servererror(error_number)检测是否返回了特定oracle 错误\nOra_login_user 返回登录用户名\nOra_sysevent 返回触发器的系统事件名\n系统触发器的种类和事件出现的时机（前或后）：\n事件允许的时机说明\nSTARTUP AFTER 启动数据库实例之后触发\nSHUTDOWN BEFORE 关闭数据库实例之前触发（非正常关闭不触发）\nSERVERERROR AFTER 数据库服务器发生错误之后触发\nLOGON AFTER 成功登录连接到数据库后触发\nLOGOFF BEFORE 开始断开数据库连接之前触发\nCREATE BEFORE，AFTER 在执行CREATE 语句创建数据库对象之前、之后\n触发\nDROP BEFORE，AFTER 在执行DROP 语句删除数据库对象之前、之后触发\nALTER BEFORE，AFTER 在执行ALTER 语句更新数据库对象之前、之后触发\nDDL BEFORE，AFTER 在执行大多数DDL 语句之前、之后触发\nGRANT BEFORE，AFTER 执行GRANT 语句授予权限之前、之后触发\nREVOKE BEFORE，AFTER 执行REVOKE 语句收权限之前、之后触犯发\nRENAME BEFORE，AFTER 执行RENAME 语句更改数据库对象名称之前、之\n后触犯发\nAUDIT/NOAUDIT BEFORE，AFTER 执行AUDIT 或NOAUDIT 进行审计或停\n止审计之前、之后触发\n特别说明：系统触发器的级别较高，由系统管理员来创建。\n------------------------------------------------------------------------------------\n</code></pre><h3 id=\"12-4-数据库系统触发器\"><a href=\"#12-4-数据库系统触发器\" class=\"headerlink\" title=\"12.4 数据库系统触发器\"></a>12.4 数据库系统触发器</h3><ul>\n<li>1.创建<br><code>`</code>sql<br>–记录登录数据库的用户名和IP<br>create table login_info (ip varchar(30),username varchar(30));<br>create or replace trigger logon_ip_info<br>after logon on database<br>declare<br>  ip varchar(30);<br>  user varchar(30);<br>begin<br>  select sys_context(‘USERENV’,’SESSION_USER’) into user from dual;<br>  select sys_context(‘USERENV’,’ip_address’) into ip from dual;<br>  insert into login_info values(ip,user);<br>end;<br>/</li>\n</ul>\n<p>select * from login_info;</p>\n<pre><code>* 2. 管理\n```sql\n--禁用\nalter trigger logon_ip_info disable;\n--启用\nalter trigger logon_ip_info enable;\n--编译\nalter trigger logon_ip_info compile;\n--删除\ndrop trigger logon_ip_info;\n--查询\nselect * from dba_objects where owner=&#39;ITPUX&#39; and object_type=&#39;TRIGGER&#39;;\ndrop trigger ITPUX.T_UPDATE;\ndrop trigger ITPUX.T_DELETE;\ndrop trigger system.t_itpux_ddl01;\n</code></pre><h2 id=\"13-包的创建和使用\"><a href=\"#13-包的创建和使用\" class=\"headerlink\" title=\"13 包的创建和使用\"></a>13 包的创建和使用</h2><ul>\n<li>1 包定义（PACKAGE）<pre><code class=\"sql\">2.1 包定义（PACKAGE）\nCREATE [OR REPLACE] PACKAGE package_name\n  {IS | AS}\n  [公有数据类型定义]\n  [公有游标声明]\n  [公有变量、常量声明]\n  [公有子程序声明]\n  [package_name];\n定义包规范:\nCREATE OR REPLACE\npackage p_stu\nas\n--定义结构体\ntype re_stu is record(\n  rname student.name%type,\n  rage student.age%type\n);\n--定义游标\ntype c_stu is ref cursor;\n--定义函数\nfunction numAdd(num1 number,num2 number)return number;\n--定义过程\nprocedure GetStuList(cid in varchar2,c_st out c_stu);\nend;\n</code></pre>\n</li>\n<li><ol start=\"2\">\n<li>包主体（PACKAGE BODY）<br><code>`</code>sql<br>CREATE [OR REPLACE] PACKAGE BODY package_name<br>{IS | AS}<br>[私有数据类型定义]<br>[私有变量、常量声明]<br>[私有子程序声明和定义]<br>[公有子程序定义]<br>BEGIN<br>执行部分(初始化部分)<br>END [package_name];</li>\n</ol>\n</li>\n</ul>\n<p>–1 创建包<br>create or replace package itpux_pkg<br>is<br>    procedure update_sal(e_name varchar2,newsal number);<br>    FUNCTION emp_sal_fun(e_name varchar2) return number;<br>end;<br>–2.3 包体<br>create or replace package body itpux_pkg is<br>procedure update_sal(e_name varchar2,newsal number)<br>is<br>begin<br>    update emp set sal=newsal where ename=e_name;<br>end;<br>function emp_sal_fun(e_name varchar2)<br>return number is<br>emp_sal number;<br>begin<br>    select sal<em>12+nvl(comm,0) into emp_sal from emp<br>where ename=e_name;<br>return emp_sal;<br>end;<br>end;<br>–2.4 执行包-调过程<br>set serveroutput on<br>    exec itpux_pkg.update_sal(‘itpux14’,2000);<br>commit;<br>select </em> from emp;<br>–查看itpux14 的记录<br>–2.5 执行包-调函数<br>declare<br>    v_emp_sal number(7,2);<br>begin<br>    v_emp_sal:=itpux_pkg.emp_sal_fun(‘itpux14’);<br>    dbms_output.put_line(‘ITPUX14 的年薪为: ‘||v_emp_sal);<br>end;<br>–ITPUX14 的年薪为: 24000<br>–2.6 删除包<br>select * from dba_objects where owner=’ITPUX’ and object_type=’PACKAGE’;<br>drop package ITPUX_PKG;<br>drop package ITPUXA_PKG;<br><code>`</code></p>\n"},{"title":"Oracle ASM数据库日常管理维护手册","date":"2018-10-02T06:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle ASM数据库日常管理维护\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.单机从ASM到文件系统\n### 1.1  前期准备\n* 01.收集信息\n\n```sql\n--1.查看数据文件\nSELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n--2.查看日志文件\nSELECT MEMBER FROM v$logfile;\n--3.查看临时文件\nSELECT file_name FROM dba_temp_files;\n--4.查看控制文件\nSELECT * FROM v$controlfile;\n```\n* 02.备份数据库\n\n```sql\n1.RMAN 备份\nbackup tag racdb_full format '/u01/backup/datafile/racdb_full_%s_%p_%t' (database);\nbackup tag racdb_ctrl format '/u01/backup/datafile/racdb_ctrl_%s_%p_%t' (current controlfile);\nbackup tag racdb_pfile format '/u01//backup/datafile/racdb_spfile_%s_%p_%t' (spfile);\n\n--2.SQLPLUS\nalter database backup controlfile to '/u01/backup/datafile/control.ctl';\n alter database backup controlfile to trace as  '/u01/backup/datafile/control.trc';\n```\n\n* 03.准备目录等环境\n\n```sql\n\n```\n\n* 04.开始迁移\n\n```sql\n--1.控制文件\n alter system set control_files='/oracle/oradata/racdb/control01.ctl' scope=spfile;\n--2.参数文件\nalter system set db_create_file_dest='/oracle/oradata/racdb/' scope=spfile;\n--3.归档日志\nshow parameter recover；\nalter system set db_recovery_file_dest='/oracle/recovery' scope=spfile;\n--4.将参数文件导出(需要手动删除ASM信息)\ncreate pfile='/oracle/racdbpfile.ora' from spfile;\n\n--5.关机后用新的PFILE启动数据库到NOMOUNT\nshutdown immediate\nstartup pfile='/oracle/racdbpfile.ora' nomount;\n--6.根据现在的PFILE生成SPFILE\ncreate spfile from pfile='/oracle/racdbpfile.ora';\n--7.关闭数据库后用SPFILE启动数据库\nshutdown immediate\nstartup nomount\nshow parameter spfile;\n--8.RMAN恢复控制文件\nrestore controlfile from '+DG_DATA/RACDB/CONTROLFILE/Current.256.966890297';\n--10.挂载数据库\nalter database mount;\n--11.RMAN将数据文件从ASM到文件系统\nbackup as copy database format '/oracle/oradata/racdb/%U';\nswitch database to copy;\n--12.恢复数据库(不恢复)\n recover database using backup controlfile until cancel;\n--13.打开数据库\nalter database open resetlogs;\n--14.处理临时文件（删掉再添加）\nselect file_name from dba_temp_files;\nalter database tempfile '+DG_DATA/racdb/tempfile/temp.263.966890331' drop including datafiles;\nalter tablespace temp add tempfile '/oracle/oradata/racdb/temp01.dbf' size 100m autoextend off;\n--注意：如果临时文件删不掉可以重启数据库再删\n\n--15.处理日志\nselect member from v$log;\nalter database drop logfile group 3;\nalter database add logfile group 2 ('/oracle/oradata/racdb/redo01.log') size 100m;\n alter system checkpoint;\n--注意:这个步骤再文件系统和ASM中相互转换\n--16.添加控制文件（重启后生效）\nalter system set control_files='/oracle/oradata/racdb/control01.ctl','/oracle/recovery/racdb/control02.ctl'scope=spfile;\n--17.修改数据文件名字\nmv data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu\tSYSTEM01.dbf\nmv data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012\tSYSAUX01.dbf\nmv data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur\tUNDOTBS01.dbf\nmv data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r    USERS01.dbf\n\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu' \nto '/oracle/oradata/racdb/SYSTEM01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012' \nto '/oracle/oradata/racdb/SYSAUX01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur' \nto '/oracle/oradata/racdb/UNDOTBS01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r' \nto '/oracle/oradata/racdb/USERS01.dbf';\n```\n* 转换前文件目录\n\n```sql\nSELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n\n+DG_DATA/racdb/datafile/system.260.966890307\n+DG_DATA/racdb/datafile/sysaux.261.966890319\n+DG_DATA/racdb/datafile/undotbs1.262.966890327\n+DG_DATA/racdb/datafile/users.264.966890339\n\nSELECT MEMBER FROM v$logfile;\n\n+DG_DATA/racdb/onlinelog/group_1.257.966890301\n+DG_BACKUP/racdb/onlinelog/group_1.257.966890301\n+DG_DATA/racdb/onlinelog/group_2.258.966890303\n+DG_BACKUP/racdb/onlinelog/group_2.258.966890303\n+DG_DATA/racdb/onlinelog/group_3.259.966890305\n+DG_BACKUP/racdb/onlinelog/group_3.259.966890305\n\nSELECT file_name FROM dba_temp_files;\n\n+DG_DATA/racdb/tempfile/temp.263.966890331\n\nSELECT * FROM v$controlfile;\n\n        +DG_DATA/racdb/controlfile/cur NO       16384           2924\n        rent.256.966890297\n\n        +DG_BACKUP/racdb/controlfile/c YES      16384           2924\n        urrent.256.966890299\n```\n* 转换后文件目录\n\n![数据文件][2]\n\n![日志文件][3]\n\n![临时文件][4]\n\n![控制文件][5]\n\n## 2.单机从ASM到文件系统\n* 步骤\n\n```sql\n1.利用PFILE和SPFILE将一个包含控制文件文字的SPFILE存到ASM\n2.RMAN将备份的控制文件恢复到指定目录\n3.恢复数据文件\n4.处理日志文件\n```\n* 操作\n\n```sql\nSQL>  alter system set control_files='+DG_DATA' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set db_create_file_dest='+DG_DATA/' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set db_recovery_file_dest='+DG_BACKUP' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set control_files='+DG_DATA/racdb/control01.ctl' scope=spfile;\n\nSystem altered.\n\nSQL> create pfile '/oracle/racdbpfile.ora' from spfile;\ncreate pfile '/oracle/racdbpfile.ora' from spfile\n             *\nERROR at line 1:\nORA-00923: FROM keyword not found where expected\n\n\nSQL> create pfile='/oracle/racdbpfile.ora' from spfile;\n\nFile created.\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> \nSQL> startup pfile='/oracle/racdbpfile.ora' nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL> create spfile from pfile='/oracle/racdbpfile.ora';\n\nFile created.\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n  2  ;\ncreate spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/oralce/racdbpfile.ora'\n\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n  2  ;\ncreate spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/oralce/racdbpfile.ora'\n\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oracle/racdbpfile.ora';\n\nFile created.\n\nSQL> shutdown immediate;\nORA-01507: database not mounted\n\n\nORACLE instance shut down.\nSQL> startup nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL> show parameter spfile\nSQL> show parameter control\n\nNAME                                 TYPE                   VALUE\n------------------------------------ ---------------------- ------------------------------\ncontrol_file_record_keep_time        integer                7\ncontrol_files                        string                 +DG_DATA/racdb/control01.ctl\ncontrol_management_pack_access       string                 DIAGNOSTIC+TUNING\n\n\n[oracle@rac1:/]$rman target /\n\nRecovery Manager: Release 11.2.0.4.0 - Production on Thu Feb 1 15:37:25 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\nconnected to target database: RACDB (not mounted)\n\nRMAN> restore controlfile from '/u01/backup/datafile/racdb_ctrl_32_1_966957454';\n\nStarting restore at 2018-02-01 15:37:57\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=10 device type=DISK\n\nchannel ORA_DISK_1: restoring control file\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:03\noutput file name=+DG_DATA/racdb/control01.ctl\nFinished restore at 2018-02-01 15:38:01\n\nSQL> alter database mount;\n\nDatabase altered.\n\n\nRMAN> list backup;\n\nreleased channel: ORA_DISK_1\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n24      Full    1.05G      DISK        00:00:15     2018-02-01 15:17:28\n        BP Key: 24   Status: AVAILABLE  Compressed: NO  Tag: RACDB_FULL\n        Piece Name: /u01/backup/datafile/racdb_full_30_1_966957433\n  List of Datafiles in backup set 24\n  File LV Type Ckp SCN    Ckp Time            Name\n  ---- -- ---- ---------- ------------------- ----\n  1       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSTEM01.dbf\n  2       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSAUX01.dbf\n  3       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/UNDOTBS01.dbf\n  4       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/USERS01.dbf\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n25      Full    46.05M     DISK        00:00:01     2018-02-01 15:17:30\n        BP Key: 25   Status: AVAILABLE  Compressed: NO  Tag: TAG20180201T151729\n        Piece Name: +DG_BACKUP/racdb/autobackup/2018_02_01/s_966957449.256.966957449\n  SPFILE Included: Modification time: 2018-02-01 14:40:33\n  SPFILE db_unique_name: RACDB\n  Control File Included: Ckp SCN: 874719       Ckp time: 2018-02-01 15:17:29\n  \n  List of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    750      SYSTEM               ***     /oracle/oradata/racdb/SYSTEM01.dbf\n2    600      SYSAUX               ***     /oracle/oradata/racdb/SYSAUX01.dbf\n3    885      UNDOTBS1             ***     /oracle/oradata/racdb/UNDOTBS01.dbf\n4    5        USERS                ***     /oracle/oradata/racdb/USERS01.dbf\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    100      TEMP                 100         /oracle/oradata/racdb/temp01.dbf\n\nRMAN> run{\n2> set newname for datafile 1 to \"+DG_DATA\";\n3> set newname for datafile 2 to \"+DG_DATA\";\n4> set newname for datafile 3 to \"+DG_DATA\";\n5> set newname for datafile 4 to \"+DG_DATA\";\n6> set newname for tempfile 1 to \"+DG_DATA\";\n7> restore database;\n8> switch datafile all;\n9> recover database;\n10> }\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nStarting restore at 2018-02-01 15:44:20\nusing channel ORA_DISK_1\n\nchannel ORA_DISK_1: starting datafile backup set restore\nchannel ORA_DISK_1: specifying datafile(s) to restore from backup set\nchannel ORA_DISK_1: restoring datafile 00001 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00002 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00003 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00004 to +DG_DATA\nchannel ORA_DISK_1: reading from backup piece /u01/backup/datafile/racdb_full_30_1_966957433\nchannel ORA_DISK_1: piece handle=/u01/backup/datafile/racdb_full_30_1_966957433 tag=RACDB_FULL\nchannel ORA_DISK_1: restored backup piece 1\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:45\nFinished restore at 2018-02-01 15:45:05\n\ndatafile 1 switched to datafile copy\ninput datafile copy RECID=15 STAMP=966959106 file name=+DG_DATA/racdb/datafile/system.261.966959061\ndatafile 2 switched to datafile copy\ninput datafile copy RECID=16 STAMP=966959106 file name=+DG_DATA/racdb/datafile/sysaux.260.966959061\ndatafile 3 switched to datafile copy\ninput datafile copy RECID=17 STAMP=966959106 file name=+DG_DATA/racdb/datafile/undotbs1.262.966959061\ndatafile 4 switched to datafile copy\ninput datafile copy RECID=18 STAMP=966959106 file name=+DG_DATA/racdb/datafile/users.265.966959061\n\nStarting recover at 2018-02-01 15:45:08\nusing channel ORA_DISK_1\n\nstarting media recovery\n\narchived log for thread 1 with sequence 33 is already on disk as file /oracle/oradata/racdb/redo03.log\narchived log file name=/oracle/oradata/racdb/redo03.log thread=1 sequence=33\nmedia recovery complete, elapsed time: 00:00:01\nFinished recover at 2018-02-01 15:45:11\n\n\n--这里不知道为什么控制文件也帮我恢复了\nASMCMD [+DG_DATA/racdb] > ls\nCONTROLFILE/\nDATAFILE/\nPARAMETERFILE/\ncontrol01.ctl\nspfileracdb.ora\nASMCMD [+DG_DATA/racdb] > cd datafile\nASMCMD [+DG_DATA/racdb/datafile] > ls\nSYSAUX.260.966959061\nSYSTEM.261.966959061\nUNDOTBS1.262.966959061\nUSERS.265.966959061\nASMCMD [+DG_DATA/racdb/datafile] >  \n\nQL> alter database add logfile group 3 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter database add logfile group 4 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> select member from v$log;\nselect member from v$log\n       *\nERROR at line 1:\nORA-00904: \"MEMBER\": invalid identifier\n\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 NO  CURRENT       876161 2018-02-01 16:02:43   2.8147E+14\n         3          1          0  104857600        512          1 YES UNUSED     0                                 0\n         4          1          0  104857600        512          1 YES UNUSED     0                                 0\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES ACTIVE        876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES ACTIVE        876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system checkpoint;\n\nSystem altered.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES INACTIVE      875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES INACTIVE      876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system drop logfile group 1;\nalter system drop logfile group 1\n             *\nERROR at line 1:\nORA-02065: illegal option for ALTER SYSTEM\n\n\nSQL> alter database drop logfile group 1;\n\nDatabase altered.\n\nSQL> alter database drop logfile group 2;\n\nDatabase altered.\n\nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> alter database add logfile group 2 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter database add logfile group 1('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\n\nSQL> /\n\nSystem altered.\n\nSQL> alter system checkpoint\n  2  ;\n\nSystem altered.\n\n```","source":"_posts/oracle/Oracle ASM数据库日常管理维护手册.md","raw":"---\ntitle: Oracle ASM数据库日常管理维护手册\ndate: 2018-10-02 14:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - SQL\n  - DML\n---\n\n\n# Oracle ASM数据库日常管理维护\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.单机从ASM到文件系统\n### 1.1  前期准备\n* 01.收集信息\n\n```sql\n--1.查看数据文件\nSELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n--2.查看日志文件\nSELECT MEMBER FROM v$logfile;\n--3.查看临时文件\nSELECT file_name FROM dba_temp_files;\n--4.查看控制文件\nSELECT * FROM v$controlfile;\n```\n* 02.备份数据库\n\n```sql\n1.RMAN 备份\nbackup tag racdb_full format '/u01/backup/datafile/racdb_full_%s_%p_%t' (database);\nbackup tag racdb_ctrl format '/u01/backup/datafile/racdb_ctrl_%s_%p_%t' (current controlfile);\nbackup tag racdb_pfile format '/u01//backup/datafile/racdb_spfile_%s_%p_%t' (spfile);\n\n--2.SQLPLUS\nalter database backup controlfile to '/u01/backup/datafile/control.ctl';\n alter database backup controlfile to trace as  '/u01/backup/datafile/control.trc';\n```\n\n* 03.准备目录等环境\n\n```sql\n\n```\n\n* 04.开始迁移\n\n```sql\n--1.控制文件\n alter system set control_files='/oracle/oradata/racdb/control01.ctl' scope=spfile;\n--2.参数文件\nalter system set db_create_file_dest='/oracle/oradata/racdb/' scope=spfile;\n--3.归档日志\nshow parameter recover；\nalter system set db_recovery_file_dest='/oracle/recovery' scope=spfile;\n--4.将参数文件导出(需要手动删除ASM信息)\ncreate pfile='/oracle/racdbpfile.ora' from spfile;\n\n--5.关机后用新的PFILE启动数据库到NOMOUNT\nshutdown immediate\nstartup pfile='/oracle/racdbpfile.ora' nomount;\n--6.根据现在的PFILE生成SPFILE\ncreate spfile from pfile='/oracle/racdbpfile.ora';\n--7.关闭数据库后用SPFILE启动数据库\nshutdown immediate\nstartup nomount\nshow parameter spfile;\n--8.RMAN恢复控制文件\nrestore controlfile from '+DG_DATA/RACDB/CONTROLFILE/Current.256.966890297';\n--10.挂载数据库\nalter database mount;\n--11.RMAN将数据文件从ASM到文件系统\nbackup as copy database format '/oracle/oradata/racdb/%U';\nswitch database to copy;\n--12.恢复数据库(不恢复)\n recover database using backup controlfile until cancel;\n--13.打开数据库\nalter database open resetlogs;\n--14.处理临时文件（删掉再添加）\nselect file_name from dba_temp_files;\nalter database tempfile '+DG_DATA/racdb/tempfile/temp.263.966890331' drop including datafiles;\nalter tablespace temp add tempfile '/oracle/oradata/racdb/temp01.dbf' size 100m autoextend off;\n--注意：如果临时文件删不掉可以重启数据库再删\n\n--15.处理日志\nselect member from v$log;\nalter database drop logfile group 3;\nalter database add logfile group 2 ('/oracle/oradata/racdb/redo01.log') size 100m;\n alter system checkpoint;\n--注意:这个步骤再文件系统和ASM中相互转换\n--16.添加控制文件（重启后生效）\nalter system set control_files='/oracle/oradata/racdb/control01.ctl','/oracle/recovery/racdb/control02.ctl'scope=spfile;\n--17.修改数据文件名字\nmv data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu\tSYSTEM01.dbf\nmv data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012\tSYSAUX01.dbf\nmv data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur\tUNDOTBS01.dbf\nmv data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r    USERS01.dbf\n\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu' \nto '/oracle/oradata/racdb/SYSTEM01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012' \nto '/oracle/oradata/racdb/SYSAUX01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur' \nto '/oracle/oradata/racdb/UNDOTBS01.dbf';\nalter database rename file '/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r' \nto '/oracle/oradata/racdb/USERS01.dbf';\n```\n* 转换前文件目录\n\n```sql\nSELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n\n+DG_DATA/racdb/datafile/system.260.966890307\n+DG_DATA/racdb/datafile/sysaux.261.966890319\n+DG_DATA/racdb/datafile/undotbs1.262.966890327\n+DG_DATA/racdb/datafile/users.264.966890339\n\nSELECT MEMBER FROM v$logfile;\n\n+DG_DATA/racdb/onlinelog/group_1.257.966890301\n+DG_BACKUP/racdb/onlinelog/group_1.257.966890301\n+DG_DATA/racdb/onlinelog/group_2.258.966890303\n+DG_BACKUP/racdb/onlinelog/group_2.258.966890303\n+DG_DATA/racdb/onlinelog/group_3.259.966890305\n+DG_BACKUP/racdb/onlinelog/group_3.259.966890305\n\nSELECT file_name FROM dba_temp_files;\n\n+DG_DATA/racdb/tempfile/temp.263.966890331\n\nSELECT * FROM v$controlfile;\n\n        +DG_DATA/racdb/controlfile/cur NO       16384           2924\n        rent.256.966890297\n\n        +DG_BACKUP/racdb/controlfile/c YES      16384           2924\n        urrent.256.966890299\n```\n* 转换后文件目录\n\n![数据文件][2]\n\n![日志文件][3]\n\n![临时文件][4]\n\n![控制文件][5]\n\n## 2.单机从ASM到文件系统\n* 步骤\n\n```sql\n1.利用PFILE和SPFILE将一个包含控制文件文字的SPFILE存到ASM\n2.RMAN将备份的控制文件恢复到指定目录\n3.恢复数据文件\n4.处理日志文件\n```\n* 操作\n\n```sql\nSQL>  alter system set control_files='+DG_DATA' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set db_create_file_dest='+DG_DATA/' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set db_recovery_file_dest='+DG_BACKUP' scope=spfile;\n\nSystem altered.\n\nSQL> alter system set control_files='+DG_DATA/racdb/control01.ctl' scope=spfile;\n\nSystem altered.\n\nSQL> create pfile '/oracle/racdbpfile.ora' from spfile;\ncreate pfile '/oracle/racdbpfile.ora' from spfile\n             *\nERROR at line 1:\nORA-00923: FROM keyword not found where expected\n\n\nSQL> create pfile='/oracle/racdbpfile.ora' from spfile;\n\nFile created.\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> \nSQL> startup pfile='/oracle/racdbpfile.ora' nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL> create spfile from pfile='/oracle/racdbpfile.ora';\n\nFile created.\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n  2  ;\ncreate spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/oralce/racdbpfile.ora'\n\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n  2  ;\ncreate spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oralce/racdbpfile.ora'\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/oralce/racdbpfile.ora'\n\n\nSQL> create spfile='+DG_DATA/racdb/spfileracdb.ora' from pfile='/oracle/racdbpfile.ora';\n\nFile created.\n\nSQL> shutdown immediate;\nORA-01507: database not mounted\n\n\nORACLE instance shut down.\nSQL> startup nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL> show parameter spfile\nSQL> show parameter control\n\nNAME                                 TYPE                   VALUE\n------------------------------------ ---------------------- ------------------------------\ncontrol_file_record_keep_time        integer                7\ncontrol_files                        string                 +DG_DATA/racdb/control01.ctl\ncontrol_management_pack_access       string                 DIAGNOSTIC+TUNING\n\n\n[oracle@rac1:/]$rman target /\n\nRecovery Manager: Release 11.2.0.4.0 - Production on Thu Feb 1 15:37:25 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\nconnected to target database: RACDB (not mounted)\n\nRMAN> restore controlfile from '/u01/backup/datafile/racdb_ctrl_32_1_966957454';\n\nStarting restore at 2018-02-01 15:37:57\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=10 device type=DISK\n\nchannel ORA_DISK_1: restoring control file\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:03\noutput file name=+DG_DATA/racdb/control01.ctl\nFinished restore at 2018-02-01 15:38:01\n\nSQL> alter database mount;\n\nDatabase altered.\n\n\nRMAN> list backup;\n\nreleased channel: ORA_DISK_1\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n24      Full    1.05G      DISK        00:00:15     2018-02-01 15:17:28\n        BP Key: 24   Status: AVAILABLE  Compressed: NO  Tag: RACDB_FULL\n        Piece Name: /u01/backup/datafile/racdb_full_30_1_966957433\n  List of Datafiles in backup set 24\n  File LV Type Ckp SCN    Ckp Time            Name\n  ---- -- ---- ---------- ------------------- ----\n  1       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSTEM01.dbf\n  2       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSAUX01.dbf\n  3       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/UNDOTBS01.dbf\n  4       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/USERS01.dbf\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n25      Full    46.05M     DISK        00:00:01     2018-02-01 15:17:30\n        BP Key: 25   Status: AVAILABLE  Compressed: NO  Tag: TAG20180201T151729\n        Piece Name: +DG_BACKUP/racdb/autobackup/2018_02_01/s_966957449.256.966957449\n  SPFILE Included: Modification time: 2018-02-01 14:40:33\n  SPFILE db_unique_name: RACDB\n  Control File Included: Ckp SCN: 874719       Ckp time: 2018-02-01 15:17:29\n  \n  List of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    750      SYSTEM               ***     /oracle/oradata/racdb/SYSTEM01.dbf\n2    600      SYSAUX               ***     /oracle/oradata/racdb/SYSAUX01.dbf\n3    885      UNDOTBS1             ***     /oracle/oradata/racdb/UNDOTBS01.dbf\n4    5        USERS                ***     /oracle/oradata/racdb/USERS01.dbf\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    100      TEMP                 100         /oracle/oradata/racdb/temp01.dbf\n\nRMAN> run{\n2> set newname for datafile 1 to \"+DG_DATA\";\n3> set newname for datafile 2 to \"+DG_DATA\";\n4> set newname for datafile 3 to \"+DG_DATA\";\n5> set newname for datafile 4 to \"+DG_DATA\";\n6> set newname for tempfile 1 to \"+DG_DATA\";\n7> restore database;\n8> switch datafile all;\n9> recover database;\n10> }\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nStarting restore at 2018-02-01 15:44:20\nusing channel ORA_DISK_1\n\nchannel ORA_DISK_1: starting datafile backup set restore\nchannel ORA_DISK_1: specifying datafile(s) to restore from backup set\nchannel ORA_DISK_1: restoring datafile 00001 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00002 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00003 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00004 to +DG_DATA\nchannel ORA_DISK_1: reading from backup piece /u01/backup/datafile/racdb_full_30_1_966957433\nchannel ORA_DISK_1: piece handle=/u01/backup/datafile/racdb_full_30_1_966957433 tag=RACDB_FULL\nchannel ORA_DISK_1: restored backup piece 1\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:45\nFinished restore at 2018-02-01 15:45:05\n\ndatafile 1 switched to datafile copy\ninput datafile copy RECID=15 STAMP=966959106 file name=+DG_DATA/racdb/datafile/system.261.966959061\ndatafile 2 switched to datafile copy\ninput datafile copy RECID=16 STAMP=966959106 file name=+DG_DATA/racdb/datafile/sysaux.260.966959061\ndatafile 3 switched to datafile copy\ninput datafile copy RECID=17 STAMP=966959106 file name=+DG_DATA/racdb/datafile/undotbs1.262.966959061\ndatafile 4 switched to datafile copy\ninput datafile copy RECID=18 STAMP=966959106 file name=+DG_DATA/racdb/datafile/users.265.966959061\n\nStarting recover at 2018-02-01 15:45:08\nusing channel ORA_DISK_1\n\nstarting media recovery\n\narchived log for thread 1 with sequence 33 is already on disk as file /oracle/oradata/racdb/redo03.log\narchived log file name=/oracle/oradata/racdb/redo03.log thread=1 sequence=33\nmedia recovery complete, elapsed time: 00:00:01\nFinished recover at 2018-02-01 15:45:11\n\n\n--这里不知道为什么控制文件也帮我恢复了\nASMCMD [+DG_DATA/racdb] > ls\nCONTROLFILE/\nDATAFILE/\nPARAMETERFILE/\ncontrol01.ctl\nspfileracdb.ora\nASMCMD [+DG_DATA/racdb] > cd datafile\nASMCMD [+DG_DATA/racdb/datafile] > ls\nSYSAUX.260.966959061\nSYSTEM.261.966959061\nUNDOTBS1.262.966959061\nUSERS.265.966959061\nASMCMD [+DG_DATA/racdb/datafile] >  \n\nQL> alter database add logfile group 3 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter database add logfile group 4 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> select member from v$log;\nselect member from v$log\n       *\nERROR at line 1:\nORA-00904: \"MEMBER\": invalid identifier\n\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 NO  CURRENT       876161 2018-02-01 16:02:43   2.8147E+14\n         3          1          0  104857600        512          1 YES UNUSED     0                                 0\n         4          1          0  104857600        512          1 YES UNUSED     0                                 0\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES ACTIVE        876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES ACTIVE        876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system checkpoint;\n\nSystem altered.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES INACTIVE      875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES INACTIVE      876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system drop logfile group 1;\nalter system drop logfile group 1\n             *\nERROR at line 1:\nORA-02065: illegal option for ALTER SYSTEM\n\n\nSQL> alter database drop logfile group 1;\n\nDatabase altered.\n\nSQL> alter database drop logfile group 2;\n\nDatabase altered.\n\nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> \nSQL> alter database add logfile group 2 ('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> alter database add logfile group 1('+DG_DATA') size 100m;\n\nDatabase altered.\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL> alter system switch logfile;\n\nSystem altered.\n\n\nSQL> /\n\nSystem altered.\n\nSQL> alter system checkpoint\n  2  ;\n\nSystem altered.\n\n```","slug":"oracle/Oracle ASM数据库日常管理维护手册","published":1,"updated":"2019-05-03T15:52:00.578Z","_id":"cjv898bqp002gi0cdpuuvmyb0","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-ASM数据库日常管理维护\"><a href=\"#Oracle-ASM数据库日常管理维护\" class=\"headerlink\" title=\"Oracle ASM数据库日常管理维护\"></a>Oracle ASM数据库日常管理维护</h1><p>[Oracle 11G R2 官方文档][1]</p>\n<h2 id=\"1-单机从ASM到文件系统\"><a href=\"#1-单机从ASM到文件系统\" class=\"headerlink\" title=\"1.单机从ASM到文件系统\"></a>1.单机从ASM到文件系统</h2><h3 id=\"1-1-前期准备\"><a href=\"#1-1-前期准备\" class=\"headerlink\" title=\"1.1  前期准备\"></a>1.1  前期准备</h3><ul>\n<li>01.收集信息</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.查看数据文件</span>\n<span class=\"token keyword\">SELECT</span> name <span class=\"token keyword\">FROM</span> v$datafile<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> file_name <span class=\"token keyword\">FROM</span> dba_data_files<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.查看日志文件</span>\n<span class=\"token keyword\">SELECT</span> MEMBER <span class=\"token keyword\">FROM</span> v$logfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--3.查看临时文件</span>\n<span class=\"token keyword\">SELECT</span> file_name <span class=\"token keyword\">FROM</span> dba_temp_files<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--4.查看控制文件</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> v$controlfile<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>02.备份数据库</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>RMAN 备份\n<span class=\"token keyword\">backup</span> tag racdb_full format <span class=\"token string\">'/u01/backup/datafile/racdb_full_%s_%p_%t'</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">database</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">backup</span> tag racdb_ctrl format <span class=\"token string\">'/u01/backup/datafile/racdb_ctrl_%s_%p_%t'</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">current</span> controlfile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">backup</span> tag racdb_pfile format '<span class=\"token operator\">/</span>u01<span class=\"token comment\" spellcheck=\"true\">//backup/datafile/racdb_spfile_%s_%p_%t' (spfile);</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.SQLPLUS</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">backup</span> controlfile <span class=\"token keyword\">to</span> <span class=\"token string\">'/u01/backup/datafile/control.ctl'</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">backup</span> controlfile <span class=\"token keyword\">to</span> trace <span class=\"token keyword\">as</span>  <span class=\"token string\">'/u01/backup/datafile/control.trc'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>03.准备目录等环境</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">\n</code></pre>\n<ul>\n<li>04.开始迁移</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.控制文件</span>\n <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> control_files<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/oradata/racdb/control01.ctl'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.参数文件</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> db_create_file_dest<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/oradata/racdb/'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--3.归档日志</span>\n<span class=\"token keyword\">show</span> parameter recover；\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> db_recovery_file_dest<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/recovery'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--4.将参数文件导出(需要手动删除ASM信息)</span>\n<span class=\"token keyword\">create</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span> <span class=\"token keyword\">from</span> spfile<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--5.关机后用新的PFILE启动数据库到NOMOUNT</span>\n<span class=\"token keyword\">shutdown</span> immediate\nstartup pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span> nomount<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--6.根据现在的PFILE生成SPFILE</span>\n<span class=\"token keyword\">create</span> spfile <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--7.关闭数据库后用SPFILE启动数据库</span>\n<span class=\"token keyword\">shutdown</span> immediate\nstartup nomount\n<span class=\"token keyword\">show</span> parameter spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--8.RMAN恢复控制文件</span>\n<span class=\"token keyword\">restore</span> controlfile <span class=\"token keyword\">from</span> <span class=\"token string\">'+DG_DATA/RACDB/CONTROLFILE/Current.256.966890297'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--10.挂载数据库</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> mount<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--11.RMAN将数据文件从ASM到文件系统</span>\n<span class=\"token keyword\">backup</span> <span class=\"token keyword\">as</span> copy <span class=\"token keyword\">database</span> format <span class=\"token string\">'/oracle/oradata/racdb/%U'</span><span class=\"token punctuation\">;</span>\nswitch <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> copy<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--12.恢复数据库(不恢复)</span>\n recover <span class=\"token keyword\">database</span> <span class=\"token keyword\">using</span> <span class=\"token keyword\">backup</span> controlfile until cancel<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--13.打开数据库</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">open</span> resetlogs<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--14.处理临时文件（删掉再添加）</span>\n<span class=\"token keyword\">select</span> file_name <span class=\"token keyword\">from</span> dba_temp_files<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> tempfile <span class=\"token string\">'+DG_DATA/racdb/tempfile/temp.263.966890331'</span> <span class=\"token keyword\">drop</span> including datafiles<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">temp</span> <span class=\"token keyword\">add</span> tempfile <span class=\"token string\">'/oracle/oradata/racdb/temp01.dbf'</span> size 100m autoextend <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--注意：如果临时文件删不掉可以重启数据库再删</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--15.处理日志</span>\n<span class=\"token keyword\">select</span> member <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">drop</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'/oracle/oradata/racdb/redo01.log'</span><span class=\"token punctuation\">)</span> size 100m<span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">checkpoint</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--注意:这个步骤再文件系统和ASM中相互转换</span>\n<span class=\"token comment\" spellcheck=\"true\">--16.添加控制文件（重启后生效）</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> control_files<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/oradata/racdb/control01.ctl'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/oracle/recovery/racdb/control02.ctl'</span>scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--17.修改数据文件名字</span>\nmv data_D<span class=\"token operator\">-</span>RACDB_I<span class=\"token operator\">-</span>964507061_TS<span class=\"token operator\">-</span>SYSTEM_FNO<span class=\"token operator\">-</span>1_0ksq4vvu    SYSTEM01<span class=\"token number\">.dbf</span>\nmv data_D<span class=\"token operator\">-</span>RACDB_I<span class=\"token operator\">-</span>964507061_TS<span class=\"token operator\">-</span>SYSAUX_FNO<span class=\"token operator\">-</span>2_0lsq5012    SYSAUX01<span class=\"token number\">.dbf</span>\nmv data_D<span class=\"token operator\">-</span>RACDB_I<span class=\"token operator\">-</span>964507061_TS<span class=\"token operator\">-</span>UNDOTBS1_FNO<span class=\"token operator\">-</span>3_0jsq4vur    UNDOTBS01<span class=\"token number\">.dbf</span>\nmv data_D<span class=\"token operator\">-</span>RACDB_I<span class=\"token operator\">-</span>964507061_TS<span class=\"token operator\">-</span>USERS_FNO<span class=\"token operator\">-</span>4_0msq501r    USERS01<span class=\"token number\">.dbf</span>\n\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">file</span> <span class=\"token string\">'/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu'</span> \n<span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/oradata/racdb/SYSTEM01.dbf'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">file</span> <span class=\"token string\">'/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012'</span> \n<span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/oradata/racdb/SYSAUX01.dbf'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">file</span> <span class=\"token string\">'/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur'</span> \n<span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/oradata/racdb/UNDOTBS01.dbf'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">file</span> <span class=\"token string\">'/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r'</span> \n<span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/oradata/racdb/USERS01.dbf'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>转换前文件目录</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> name <span class=\"token keyword\">FROM</span> v$datafile<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> file_name <span class=\"token keyword\">FROM</span> dba_data_files<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>system<span class=\"token number\">.260</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890307</span>\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>sysaux<span class=\"token number\">.261</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890319</span>\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>undotbs1<span class=\"token number\">.262</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890327</span>\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>users<span class=\"token number\">.264</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890339</span>\n\n<span class=\"token keyword\">SELECT</span> MEMBER <span class=\"token keyword\">FROM</span> v$logfile<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_1<span class=\"token number\">.257</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890301</span>\n<span class=\"token operator\">+</span>DG_BACKUP<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_1<span class=\"token number\">.257</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890301</span>\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_2<span class=\"token number\">.258</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890303</span>\n<span class=\"token operator\">+</span>DG_BACKUP<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_2<span class=\"token number\">.258</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890303</span>\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_3<span class=\"token number\">.259</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890305</span>\n<span class=\"token operator\">+</span>DG_BACKUP<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>onlinelog<span class=\"token operator\">/</span>group_3<span class=\"token number\">.259</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890305</span>\n\n<span class=\"token keyword\">SELECT</span> file_name <span class=\"token keyword\">FROM</span> dba_temp_files<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>tempfile<span class=\"token operator\">/</span><span class=\"token keyword\">temp</span><span class=\"token punctuation\">.</span><span class=\"token number\">263.966890331</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> v$controlfile<span class=\"token punctuation\">;</span>\n\n        <span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>controlfile<span class=\"token operator\">/</span>cur <span class=\"token keyword\">NO</span>       <span class=\"token number\">16384</span>           <span class=\"token number\">2924</span>\n        rent<span class=\"token number\">.256</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890297</span>\n\n        <span class=\"token operator\">+</span>DG_BACKUP<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>controlfile<span class=\"token operator\">/</span><span class=\"token number\">c</span> YES      <span class=\"token number\">16384</span>           <span class=\"token number\">2924</span>\n        urrent<span class=\"token number\">.256</span><span class=\"token punctuation\">.</span><span class=\"token number\">966890299</span>\n</code></pre>\n<ul>\n<li>转换后文件目录</li>\n</ul>\n<p>![数据文件][2]</p>\n<p>![日志文件][3]</p>\n<p>![临时文件][4]</p>\n<p>![控制文件][5]</p>\n<h2 id=\"2-单机从ASM到文件系统\"><a href=\"#2-单机从ASM到文件系统\" class=\"headerlink\" title=\"2.单机从ASM到文件系统\"></a>2.单机从ASM到文件系统</h2><ul>\n<li>步骤</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>利用PFILE和SPFILE将一个包含控制文件文字的SPFILE存到ASM\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>RMAN将备份的控制文件恢复到指定目录\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>恢复数据文件\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span>处理日志文件\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">SQL<span class=\"token operator\">></span>  <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> control_files<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> db_create_file_dest<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> db_recovery_file_dest<span class=\"token operator\">=</span><span class=\"token string\">'+DG_BACKUP'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> control_files<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/control01.ctl'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> pfile <span class=\"token string\">'/oracle/racdbpfile.ora'</span> <span class=\"token keyword\">from</span> spfile<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> pfile <span class=\"token string\">'/oracle/racdbpfile.ora'</span> <span class=\"token keyword\">from</span> spfile\n             <span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token number\">-00923</span>: <span class=\"token keyword\">FROM</span> keyword <span class=\"token operator\">not</span> found <span class=\"token keyword\">where</span> expected\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span> <span class=\"token keyword\">from</span> spfile<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">File</span> created<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> closed<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">Database</span> dismounted<span class=\"token punctuation\">.</span>\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> startup pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span> nomount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area <span class=\"token number\">1043886080</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2259840</span> bytes\nVariable Size             <span class=\"token number\">335545472</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">700448768</span> bytes\nRedo Buffers                <span class=\"token number\">5632000</span> bytes\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> spfile <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">File</span> created<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> spfile<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/spfileracdb.ora'</span> <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n  <span class=\"token number\">2</span>  <span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> spfile<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/spfileracdb.ora'</span> <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n<span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token number\">-01078</span>: failure <span class=\"token operator\">in</span> processing system parameters\nLRM<span class=\"token number\">-00109</span>: could <span class=\"token operator\">not</span> <span class=\"token keyword\">open</span> parameter <span class=\"token keyword\">file</span> <span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> spfile<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/spfileracdb.ora'</span> <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n  <span class=\"token number\">2</span>  <span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> spfile<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/spfileracdb.ora'</span> <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n<span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token number\">-01078</span>: failure <span class=\"token operator\">in</span> processing system parameters\nLRM<span class=\"token number\">-00109</span>: could <span class=\"token operator\">not</span> <span class=\"token keyword\">open</span> parameter <span class=\"token keyword\">file</span> <span class=\"token string\">'/oralce/racdbpfile.ora'</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> spfile<span class=\"token operator\">=</span><span class=\"token string\">'+DG_DATA/racdb/spfileracdb.ora'</span> <span class=\"token keyword\">from</span> pfile<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/racdbpfile.ora'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">File</span> created<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\nORA<span class=\"token number\">-01507</span>: <span class=\"token keyword\">database</span> <span class=\"token operator\">not</span> mounted\n\n\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> startup nomount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area <span class=\"token number\">1043886080</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2259840</span> bytes\nVariable Size             <span class=\"token number\">335545472</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">700448768</span> bytes\nRedo Buffers                <span class=\"token number\">5632000</span> bytes\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> parameter spfile\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> parameter control\n\nNAME                                 <span class=\"token keyword\">TYPE</span>                   <span class=\"token keyword\">VALUE</span>\n<span class=\"token comment\" spellcheck=\"true\">------------------------------------ ---------------------- ------------------------------</span>\ncontrol_file_record_keep_time        <span class=\"token keyword\">integer</span>                <span class=\"token number\">7</span>\ncontrol_files                        string                 <span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>control01<span class=\"token punctuation\">.</span>ctl\ncontrol_management_pack_access       string                 DIAGNOSTIC<span class=\"token operator\">+</span>TUNING\n\n\n<span class=\"token punctuation\">[</span>oracle<span class=\"token variable\">@rac1</span>:<span class=\"token operator\">/</span><span class=\"token punctuation\">]</span>$rman target <span class=\"token operator\">/</span>\n\nRecovery Manager: <span class=\"token keyword\">Release</span> <span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span> <span class=\"token operator\">-</span> Production <span class=\"token keyword\">on</span> Thu Feb <span class=\"token number\">1</span> <span class=\"token number\">15</span>:<span class=\"token number\">37</span>:<span class=\"token number\">25</span> <span class=\"token number\">2018</span>\n\nCopyright <span class=\"token punctuation\">(</span><span class=\"token number\">c</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1982</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2011</span><span class=\"token punctuation\">,</span> Oracle <span class=\"token operator\">and</span><span class=\"token operator\">/</span><span class=\"token operator\">or</span> its affiliates<span class=\"token punctuation\">.</span>  <span class=\"token keyword\">All</span> rights reserved<span class=\"token punctuation\">.</span>\n\nconnected <span class=\"token keyword\">to</span> target <span class=\"token keyword\">database</span>: RACDB <span class=\"token punctuation\">(</span><span class=\"token operator\">not</span> mounted<span class=\"token punctuation\">)</span>\n\nRMAN<span class=\"token operator\">></span> <span class=\"token keyword\">restore</span> controlfile <span class=\"token keyword\">from</span> <span class=\"token string\">'/u01/backup/datafile/racdb_ctrl_32_1_966957454'</span><span class=\"token punctuation\">;</span>\n\nStarting <span class=\"token keyword\">restore</span> at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">37</span>:<span class=\"token number\">57</span>\n<span class=\"token keyword\">using</span> target <span class=\"token keyword\">database</span> control <span class=\"token keyword\">file</span> instead <span class=\"token keyword\">of</span> recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID<span class=\"token operator\">=</span><span class=\"token number\">10</span> device <span class=\"token keyword\">type</span><span class=\"token operator\">=</span><span class=\"token keyword\">DISK</span>\n\nchannel ORA_DISK_1: restoring control <span class=\"token keyword\">file</span>\nchannel ORA_DISK_1: <span class=\"token keyword\">restore</span> complete<span class=\"token punctuation\">,</span> elapsed time: <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">03</span>\noutput <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>control01<span class=\"token punctuation\">.</span>ctl\nFinished <span class=\"token keyword\">restore</span> at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">38</span>:<span class=\"token number\">01</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> mount<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\n\nRMAN<span class=\"token operator\">></span> list <span class=\"token keyword\">backup</span><span class=\"token punctuation\">;</span>\n\nreleased channel: ORA_DISK_1\n\nList <span class=\"token keyword\">of</span> <span class=\"token keyword\">Backup</span> Sets\n<span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span>\n\n\nBS <span class=\"token keyword\">Key</span>  <span class=\"token keyword\">Type</span> LV Size       Device <span class=\"token keyword\">Type</span> Elapsed Time Completion Time    \n<span class=\"token comment\" spellcheck=\"true\">------- ---- -- ---------- ----------- ------------ -------------------</span>\n<span class=\"token number\">24</span>      <span class=\"token keyword\">Full</span>    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span>05G      <span class=\"token keyword\">DISK</span>        <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">15</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">28</span>\n        BP <span class=\"token keyword\">Key</span>: <span class=\"token number\">24</span>   <span class=\"token keyword\">Status</span>: AVAILABLE  Compressed: <span class=\"token keyword\">NO</span>  Tag: RACDB_FULL\n        Piece Name: <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span><span class=\"token keyword\">backup</span><span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>racdb_full_30_1_966957433\n  List <span class=\"token keyword\">of</span> Datafiles <span class=\"token operator\">in</span> <span class=\"token keyword\">backup</span> <span class=\"token keyword\">set</span> <span class=\"token number\">24</span>\n  <span class=\"token keyword\">File</span> LV <span class=\"token keyword\">Type</span> Ckp SCN    Ckp Time            Name\n  <span class=\"token comment\" spellcheck=\"true\">---- -- ---- ---------- ------------------- ----</span>\n  <span class=\"token number\">1</span>       <span class=\"token keyword\">Full</span> <span class=\"token number\">874708</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">14</span> <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>SYSTEM01<span class=\"token number\">.dbf</span>\n  <span class=\"token number\">2</span>       <span class=\"token keyword\">Full</span> <span class=\"token number\">874708</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">14</span> <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>SYSAUX01<span class=\"token number\">.dbf</span>\n  <span class=\"token number\">3</span>       <span class=\"token keyword\">Full</span> <span class=\"token number\">874708</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">14</span> <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>UNDOTBS01<span class=\"token number\">.dbf</span>\n  <span class=\"token number\">4</span>       <span class=\"token keyword\">Full</span> <span class=\"token number\">874708</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">14</span> <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>USERS01<span class=\"token number\">.dbf</span>\n\nBS <span class=\"token keyword\">Key</span>  <span class=\"token keyword\">Type</span> LV Size       Device <span class=\"token keyword\">Type</span> Elapsed Time Completion Time    \n<span class=\"token comment\" spellcheck=\"true\">------- ---- -- ---------- ----------- ------------ -------------------</span>\n<span class=\"token number\">25</span>      <span class=\"token keyword\">Full</span>    <span class=\"token number\">46</span><span class=\"token punctuation\">.</span>05M     <span class=\"token keyword\">DISK</span>        <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">01</span>     <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">30</span>\n        BP <span class=\"token keyword\">Key</span>: <span class=\"token number\">25</span>   <span class=\"token keyword\">Status</span>: AVAILABLE  Compressed: <span class=\"token keyword\">NO</span>  Tag: TAG20180201T151729\n        Piece Name: <span class=\"token operator\">+</span>DG_BACKUP<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>autobackup<span class=\"token operator\">/</span>2018_02_01<span class=\"token operator\">/</span>s_966957449<span class=\"token number\">.256</span><span class=\"token punctuation\">.</span><span class=\"token number\">966957449</span>\n  SPFILE Included: Modification time: <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">14</span>:<span class=\"token number\">40</span>:<span class=\"token number\">33</span>\n  SPFILE db_unique_name: RACDB\n  Control <span class=\"token keyword\">File</span> Included: Ckp SCN: <span class=\"token number\">874719</span>       Ckp time: <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">17</span>:<span class=\"token number\">29</span>\n\n  List <span class=\"token keyword\">of</span> Permanent Datafiles\n<span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span>\n<span class=\"token keyword\">File</span> Size<span class=\"token punctuation\">(</span>MB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">Tablespace</span>           RB segs Datafile Name\n<span class=\"token comment\" spellcheck=\"true\">---- -------- -------------------- ------- ------------------------</span>\n<span class=\"token number\">1</span>    <span class=\"token number\">750</span>      SYSTEM               <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>     <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>SYSTEM01<span class=\"token number\">.dbf</span>\n<span class=\"token number\">2</span>    <span class=\"token number\">600</span>      SYSAUX               <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>     <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>SYSAUX01<span class=\"token number\">.dbf</span>\n<span class=\"token number\">3</span>    <span class=\"token number\">885</span>      UNDOTBS1             <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>     <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>UNDOTBS01<span class=\"token number\">.dbf</span>\n<span class=\"token number\">4</span>    <span class=\"token number\">5</span>        USERS                <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>     <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>USERS01<span class=\"token number\">.dbf</span>\n\nList <span class=\"token keyword\">of</span> <span class=\"token keyword\">Temporary</span> Files\n<span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span>\n<span class=\"token keyword\">File</span> Size<span class=\"token punctuation\">(</span>MB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">Tablespace</span>           Maxsize<span class=\"token punctuation\">(</span>MB<span class=\"token punctuation\">)</span> Tempfile Name\n<span class=\"token comment\" spellcheck=\"true\">---- -------- -------------------- ----------- --------------------</span>\n<span class=\"token number\">1</span>    <span class=\"token number\">100</span>      <span class=\"token keyword\">TEMP</span>                 <span class=\"token number\">100</span>         <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>temp01<span class=\"token number\">.dbf</span>\n\nRMAN<span class=\"token operator\">></span> run{\n<span class=\"token number\">2</span><span class=\"token operator\">></span> <span class=\"token keyword\">set</span> newname <span class=\"token keyword\">for</span> datafile <span class=\"token number\">1</span> <span class=\"token keyword\">to</span> <span class=\"token string\">\"+DG_DATA\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">3</span><span class=\"token operator\">></span> <span class=\"token keyword\">set</span> newname <span class=\"token keyword\">for</span> datafile <span class=\"token number\">2</span> <span class=\"token keyword\">to</span> <span class=\"token string\">\"+DG_DATA\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">4</span><span class=\"token operator\">></span> <span class=\"token keyword\">set</span> newname <span class=\"token keyword\">for</span> datafile <span class=\"token number\">3</span> <span class=\"token keyword\">to</span> <span class=\"token string\">\"+DG_DATA\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">5</span><span class=\"token operator\">></span> <span class=\"token keyword\">set</span> newname <span class=\"token keyword\">for</span> datafile <span class=\"token number\">4</span> <span class=\"token keyword\">to</span> <span class=\"token string\">\"+DG_DATA\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">6</span><span class=\"token operator\">></span> <span class=\"token keyword\">set</span> newname <span class=\"token keyword\">for</span> tempfile <span class=\"token number\">1</span> <span class=\"token keyword\">to</span> <span class=\"token string\">\"+DG_DATA\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">7</span><span class=\"token operator\">></span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">8</span><span class=\"token operator\">></span> switch datafile <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">9</span><span class=\"token operator\">></span> recover <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">10</span><span class=\"token operator\">></span> }\n\nexecuting command: <span class=\"token keyword\">SET</span> NEWNAME\n\nexecuting command: <span class=\"token keyword\">SET</span> NEWNAME\n\nexecuting command: <span class=\"token keyword\">SET</span> NEWNAME\n\nexecuting command: <span class=\"token keyword\">SET</span> NEWNAME\n\nexecuting command: <span class=\"token keyword\">SET</span> NEWNAME\n\nStarting <span class=\"token keyword\">restore</span> at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">44</span>:<span class=\"token number\">20</span>\n<span class=\"token keyword\">using</span> channel ORA_DISK_1\n\nchannel ORA_DISK_1: starting datafile <span class=\"token keyword\">backup</span> <span class=\"token keyword\">set</span> <span class=\"token keyword\">restore</span>\nchannel ORA_DISK_1: specifying datafile<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">backup</span> <span class=\"token keyword\">set</span>\nchannel ORA_DISK_1: restoring datafile <span class=\"token number\">00001</span> <span class=\"token keyword\">to</span> <span class=\"token operator\">+</span>DG_DATA\nchannel ORA_DISK_1: restoring datafile <span class=\"token number\">00002</span> <span class=\"token keyword\">to</span> <span class=\"token operator\">+</span>DG_DATA\nchannel ORA_DISK_1: restoring datafile <span class=\"token number\">00003</span> <span class=\"token keyword\">to</span> <span class=\"token operator\">+</span>DG_DATA\nchannel ORA_DISK_1: restoring datafile <span class=\"token number\">00004</span> <span class=\"token keyword\">to</span> <span class=\"token operator\">+</span>DG_DATA\nchannel ORA_DISK_1: reading <span class=\"token keyword\">from</span> <span class=\"token keyword\">backup</span> piece <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span><span class=\"token keyword\">backup</span><span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>racdb_full_30_1_966957433\nchannel ORA_DISK_1: piece handle<span class=\"token operator\">=</span><span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span><span class=\"token keyword\">backup</span><span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>racdb_full_30_1_966957433 tag<span class=\"token operator\">=</span>RACDB_FULL\nchannel ORA_DISK_1: restored <span class=\"token keyword\">backup</span> piece <span class=\"token number\">1</span>\nchannel ORA_DISK_1: <span class=\"token keyword\">restore</span> complete<span class=\"token punctuation\">,</span> elapsed time: <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">45</span>\nFinished <span class=\"token keyword\">restore</span> at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">45</span>:<span class=\"token number\">05</span>\n\ndatafile <span class=\"token number\">1</span> switched <span class=\"token keyword\">to</span> datafile copy\ninput datafile copy RECID<span class=\"token operator\">=</span><span class=\"token number\">15</span> STAMP<span class=\"token operator\">=</span><span class=\"token number\">966959106</span> <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>system<span class=\"token number\">.261</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\ndatafile <span class=\"token number\">2</span> switched <span class=\"token keyword\">to</span> datafile copy\ninput datafile copy RECID<span class=\"token operator\">=</span><span class=\"token number\">16</span> STAMP<span class=\"token operator\">=</span><span class=\"token number\">966959106</span> <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>sysaux<span class=\"token number\">.260</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\ndatafile <span class=\"token number\">3</span> switched <span class=\"token keyword\">to</span> datafile copy\ninput datafile copy RECID<span class=\"token operator\">=</span><span class=\"token number\">17</span> STAMP<span class=\"token operator\">=</span><span class=\"token number\">966959106</span> <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>undotbs1<span class=\"token number\">.262</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\ndatafile <span class=\"token number\">4</span> switched <span class=\"token keyword\">to</span> datafile copy\ninput datafile copy RECID<span class=\"token operator\">=</span><span class=\"token number\">18</span> STAMP<span class=\"token operator\">=</span><span class=\"token number\">966959106</span> <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token operator\">/</span>users<span class=\"token number\">.265</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\n\nStarting recover at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">45</span>:<span class=\"token number\">08</span>\n<span class=\"token keyword\">using</span> channel ORA_DISK_1\n\nstarting media recovery\n\narchived log <span class=\"token keyword\">for</span> thread <span class=\"token number\">1</span> <span class=\"token keyword\">with</span> sequence <span class=\"token number\">33</span> <span class=\"token operator\">is</span> already <span class=\"token keyword\">on</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">file</span> <span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>redo03<span class=\"token punctuation\">.</span>log\narchived log <span class=\"token keyword\">file</span> name<span class=\"token operator\">=</span><span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>redo03<span class=\"token punctuation\">.</span>log thread<span class=\"token operator\">=</span><span class=\"token number\">1</span> sequence<span class=\"token operator\">=</span><span class=\"token number\">33</span>\nmedia recovery complete<span class=\"token punctuation\">,</span> elapsed time: <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">01</span>\nFinished recover at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">45</span>:<span class=\"token number\">11</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">--这里不知道为什么控制文件也帮我恢复了</span>\nASMCMD <span class=\"token punctuation\">[</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> ls\nCONTROLFILE<span class=\"token operator\">/</span>\nDATAFILE<span class=\"token operator\">/</span>\nPARAMETERFILE<span class=\"token operator\">/</span>\ncontrol01<span class=\"token punctuation\">.</span>ctl\nspfileracdb<span class=\"token punctuation\">.</span>ora\nASMCMD <span class=\"token punctuation\">[</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">cd</span> datafile\nASMCMD <span class=\"token punctuation\">[</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> ls\nSYSAUX<span class=\"token number\">.260</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\nSYSTEM<span class=\"token number\">.261</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\nUNDOTBS1<span class=\"token number\">.262</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\nUSERS<span class=\"token number\">.265</span><span class=\"token punctuation\">.</span><span class=\"token number\">966959061</span>\nASMCMD <span class=\"token punctuation\">[</span><span class=\"token operator\">+</span>DG_DATA<span class=\"token operator\">/</span>racdb<span class=\"token operator\">/</span>datafile<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span>  \n\nQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'+DG_DATA'</span><span class=\"token punctuation\">)</span> size 100m<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'+DG_DATA'</span><span class=\"token punctuation\">)</span> size 100m<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system switch logfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> member <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> member <span class=\"token keyword\">from</span> v$log\n       <span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token number\">-00904</span>: <span class=\"token string\">\"MEMBER\"</span>: invalid identifier\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">GROUP</span><span class=\"token comment\" spellcheck=\"true\">#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME</span>\n<span class=\"token comment\" spellcheck=\"true\">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------</span>\n         <span class=\"token number\">1</span>          <span class=\"token number\">1</span>          <span class=\"token number\">1</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES ACTIVE        <span class=\"token number\">875061</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">50</span>:<span class=\"token number\">41</span>       <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>\n         <span class=\"token number\">2</span>          <span class=\"token number\">1</span>          <span class=\"token number\">2</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> <span class=\"token keyword\">NO</span>  <span class=\"token keyword\">CURRENT</span>       <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>   <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>8147E<span class=\"token operator\">+</span><span class=\"token number\">14</span>\n         <span class=\"token number\">3</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n         <span class=\"token number\">4</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system switch logfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system switch logfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">GROUP</span><span class=\"token comment\" spellcheck=\"true\">#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME</span>\n<span class=\"token comment\" spellcheck=\"true\">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------</span>\n         <span class=\"token number\">1</span>          <span class=\"token number\">1</span>          <span class=\"token number\">1</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES ACTIVE        <span class=\"token number\">875061</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">50</span>:<span class=\"token number\">41</span>       <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>\n         <span class=\"token number\">2</span>          <span class=\"token number\">1</span>          <span class=\"token number\">2</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES ACTIVE        <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>       <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>\n         <span class=\"token number\">3</span>          <span class=\"token number\">1</span>          <span class=\"token number\">3</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES ACTIVE        <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>\n         <span class=\"token number\">4</span>          <span class=\"token number\">1</span>          <span class=\"token number\">4</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> <span class=\"token keyword\">NO</span>  <span class=\"token keyword\">CURRENT</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>   <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>8147E<span class=\"token operator\">+</span><span class=\"token number\">14</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">checkpoint</span><span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">checkpoint</span><span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">GROUP</span><span class=\"token comment\" spellcheck=\"true\">#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME</span>\n<span class=\"token comment\" spellcheck=\"true\">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------</span>\n         <span class=\"token number\">1</span>          <span class=\"token number\">1</span>          <span class=\"token number\">1</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES INACTIVE      <span class=\"token number\">875061</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">15</span>:<span class=\"token number\">50</span>:<span class=\"token number\">41</span>       <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>\n         <span class=\"token number\">2</span>          <span class=\"token number\">1</span>          <span class=\"token number\">2</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES INACTIVE      <span class=\"token number\">876161</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">02</span>:<span class=\"token number\">43</span>       <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>\n         <span class=\"token number\">3</span>          <span class=\"token number\">1</span>          <span class=\"token number\">3</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES INACTIVE      <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>\n         <span class=\"token number\">4</span>          <span class=\"token number\">1</span>          <span class=\"token number\">4</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> <span class=\"token keyword\">NO</span>  <span class=\"token keyword\">CURRENT</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>   <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>8147E<span class=\"token operator\">+</span><span class=\"token number\">14</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">drop</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">drop</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">1</span>\n             <span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token number\">-02065</span>: illegal <span class=\"token keyword\">option</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">ALTER</span> SYSTEM\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">drop</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">drop</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> \nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'+DG_DATA'</span><span class=\"token punctuation\">)</span> size 100m<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> logfile <span class=\"token keyword\">group</span> <span class=\"token number\">1</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+DG_DATA'</span><span class=\"token punctuation\">)</span> size 100m<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">GROUP</span><span class=\"token comment\" spellcheck=\"true\">#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME</span>\n<span class=\"token comment\" spellcheck=\"true\">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------</span>\n         <span class=\"token number\">1</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n         <span class=\"token number\">2</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n         <span class=\"token number\">3</span>          <span class=\"token number\">1</span>          <span class=\"token number\">3</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES INACTIVE      <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>\n         <span class=\"token number\">4</span>          <span class=\"token number\">1</span>          <span class=\"token number\">4</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> <span class=\"token keyword\">NO</span>  <span class=\"token keyword\">CURRENT</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>   <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>8147E<span class=\"token operator\">+</span><span class=\"token number\">14</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$log<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">GROUP</span><span class=\"token comment\" spellcheck=\"true\">#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME</span>\n<span class=\"token comment\" spellcheck=\"true\">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------</span>\n         <span class=\"token number\">1</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n         <span class=\"token number\">2</span>          <span class=\"token number\">1</span>          <span class=\"token number\">0</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES UNUSED     <span class=\"token number\">0</span>                                 <span class=\"token number\">0</span>\n         <span class=\"token number\">3</span>          <span class=\"token number\">1</span>          <span class=\"token number\">3</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> YES INACTIVE      <span class=\"token number\">876177</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">03</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>\n         <span class=\"token number\">4</span>          <span class=\"token number\">1</span>          <span class=\"token number\">4</span>  <span class=\"token number\">104857600</span>        <span class=\"token number\">512</span>          <span class=\"token number\">1</span> <span class=\"token keyword\">NO</span>  <span class=\"token keyword\">CURRENT</span>       <span class=\"token number\">876180</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token number\">16</span>:<span class=\"token number\">03</span>:<span class=\"token number\">04</span>   <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>8147E<span class=\"token operator\">+</span><span class=\"token number\">14</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system switch logfile<span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token operator\">/</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> system <span class=\"token keyword\">checkpoint</span>\n  <span class=\"token number\">2</span>  <span class=\"token punctuation\">;</span>\n\nSystem altered<span class=\"token punctuation\">.</span>\n\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-ASM数据库日常管理维护\"><a href=\"#Oracle-ASM数据库日常管理维护\" class=\"headerlink\" title=\"Oracle ASM数据库日常管理维护\"></a>Oracle ASM数据库日常管理维护</h1><p>[Oracle 11G R2 官方文档][1]</p>\n<h2 id=\"1-单机从ASM到文件系统\"><a href=\"#1-单机从ASM到文件系统\" class=\"headerlink\" title=\"1.单机从ASM到文件系统\"></a>1.单机从ASM到文件系统</h2><h3 id=\"1-1-前期准备\"><a href=\"#1-1-前期准备\" class=\"headerlink\" title=\"1.1  前期准备\"></a>1.1  前期准备</h3><ul>\n<li>01.收集信息</li>\n</ul>\n<pre><code class=\"sql\">--1.查看数据文件\nSELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n--2.查看日志文件\nSELECT MEMBER FROM v$logfile;\n--3.查看临时文件\nSELECT file_name FROM dba_temp_files;\n--4.查看控制文件\nSELECT * FROM v$controlfile;\n</code></pre>\n<ul>\n<li>02.备份数据库</li>\n</ul>\n<pre><code class=\"sql\">1.RMAN 备份\nbackup tag racdb_full format &#39;/u01/backup/datafile/racdb_full_%s_%p_%t&#39; (database);\nbackup tag racdb_ctrl format &#39;/u01/backup/datafile/racdb_ctrl_%s_%p_%t&#39; (current controlfile);\nbackup tag racdb_pfile format &#39;/u01//backup/datafile/racdb_spfile_%s_%p_%t&#39; (spfile);\n\n--2.SQLPLUS\nalter database backup controlfile to &#39;/u01/backup/datafile/control.ctl&#39;;\n alter database backup controlfile to trace as  &#39;/u01/backup/datafile/control.trc&#39;;\n</code></pre>\n<ul>\n<li>03.准备目录等环境</li>\n</ul>\n<pre><code class=\"sql\">\n</code></pre>\n<ul>\n<li>04.开始迁移</li>\n</ul>\n<pre><code class=\"sql\">--1.控制文件\n alter system set control_files=&#39;/oracle/oradata/racdb/control01.ctl&#39; scope=spfile;\n--2.参数文件\nalter system set db_create_file_dest=&#39;/oracle/oradata/racdb/&#39; scope=spfile;\n--3.归档日志\nshow parameter recover；\nalter system set db_recovery_file_dest=&#39;/oracle/recovery&#39; scope=spfile;\n--4.将参数文件导出(需要手动删除ASM信息)\ncreate pfile=&#39;/oracle/racdbpfile.ora&#39; from spfile;\n\n--5.关机后用新的PFILE启动数据库到NOMOUNT\nshutdown immediate\nstartup pfile=&#39;/oracle/racdbpfile.ora&#39; nomount;\n--6.根据现在的PFILE生成SPFILE\ncreate spfile from pfile=&#39;/oracle/racdbpfile.ora&#39;;\n--7.关闭数据库后用SPFILE启动数据库\nshutdown immediate\nstartup nomount\nshow parameter spfile;\n--8.RMAN恢复控制文件\nrestore controlfile from &#39;+DG_DATA/RACDB/CONTROLFILE/Current.256.966890297&#39;;\n--10.挂载数据库\nalter database mount;\n--11.RMAN将数据文件从ASM到文件系统\nbackup as copy database format &#39;/oracle/oradata/racdb/%U&#39;;\nswitch database to copy;\n--12.恢复数据库(不恢复)\n recover database using backup controlfile until cancel;\n--13.打开数据库\nalter database open resetlogs;\n--14.处理临时文件（删掉再添加）\nselect file_name from dba_temp_files;\nalter database tempfile &#39;+DG_DATA/racdb/tempfile/temp.263.966890331&#39; drop including datafiles;\nalter tablespace temp add tempfile &#39;/oracle/oradata/racdb/temp01.dbf&#39; size 100m autoextend off;\n--注意：如果临时文件删不掉可以重启数据库再删\n\n--15.处理日志\nselect member from v$log;\nalter database drop logfile group 3;\nalter database add logfile group 2 (&#39;/oracle/oradata/racdb/redo01.log&#39;) size 100m;\n alter system checkpoint;\n--注意:这个步骤再文件系统和ASM中相互转换\n--16.添加控制文件（重启后生效）\nalter system set control_files=&#39;/oracle/oradata/racdb/control01.ctl&#39;,&#39;/oracle/recovery/racdb/control02.ctl&#39;scope=spfile;\n--17.修改数据文件名字\nmv data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu    SYSTEM01.dbf\nmv data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012    SYSAUX01.dbf\nmv data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur    UNDOTBS01.dbf\nmv data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r    USERS01.dbf\n\nalter database rename file &#39;/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSTEM_FNO-1_0ksq4vvu&#39; \nto &#39;/oracle/oradata/racdb/SYSTEM01.dbf&#39;;\nalter database rename file &#39;/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-SYSAUX_FNO-2_0lsq5012&#39; \nto &#39;/oracle/oradata/racdb/SYSAUX01.dbf&#39;;\nalter database rename file &#39;/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-UNDOTBS1_FNO-3_0jsq4vur&#39; \nto &#39;/oracle/oradata/racdb/UNDOTBS01.dbf&#39;;\nalter database rename file &#39;/oracle/oradata/racdb/data_D-RACDB_I-964507061_TS-USERS_FNO-4_0msq501r&#39; \nto &#39;/oracle/oradata/racdb/USERS01.dbf&#39;;\n</code></pre>\n<ul>\n<li>转换前文件目录</li>\n</ul>\n<pre><code class=\"sql\">SELECT name FROM v$datafile;\nSELECT file_name FROM dba_data_files;\n\n+DG_DATA/racdb/datafile/system.260.966890307\n+DG_DATA/racdb/datafile/sysaux.261.966890319\n+DG_DATA/racdb/datafile/undotbs1.262.966890327\n+DG_DATA/racdb/datafile/users.264.966890339\n\nSELECT MEMBER FROM v$logfile;\n\n+DG_DATA/racdb/onlinelog/group_1.257.966890301\n+DG_BACKUP/racdb/onlinelog/group_1.257.966890301\n+DG_DATA/racdb/onlinelog/group_2.258.966890303\n+DG_BACKUP/racdb/onlinelog/group_2.258.966890303\n+DG_DATA/racdb/onlinelog/group_3.259.966890305\n+DG_BACKUP/racdb/onlinelog/group_3.259.966890305\n\nSELECT file_name FROM dba_temp_files;\n\n+DG_DATA/racdb/tempfile/temp.263.966890331\n\nSELECT * FROM v$controlfile;\n\n        +DG_DATA/racdb/controlfile/cur NO       16384           2924\n        rent.256.966890297\n\n        +DG_BACKUP/racdb/controlfile/c YES      16384           2924\n        urrent.256.966890299\n</code></pre>\n<ul>\n<li>转换后文件目录</li>\n</ul>\n<p>![数据文件][2]</p>\n<p>![日志文件][3]</p>\n<p>![临时文件][4]</p>\n<p>![控制文件][5]</p>\n<h2 id=\"2-单机从ASM到文件系统\"><a href=\"#2-单机从ASM到文件系统\" class=\"headerlink\" title=\"2.单机从ASM到文件系统\"></a>2.单机从ASM到文件系统</h2><ul>\n<li>步骤</li>\n</ul>\n<pre><code class=\"sql\">1.利用PFILE和SPFILE将一个包含控制文件文字的SPFILE存到ASM\n2.RMAN将备份的控制文件恢复到指定目录\n3.恢复数据文件\n4.处理日志文件\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre><code class=\"sql\">SQL&gt;  alter system set control_files=&#39;+DG_DATA&#39; scope=spfile;\n\nSystem altered.\n\nSQL&gt; alter system set db_create_file_dest=&#39;+DG_DATA/&#39; scope=spfile;\n\nSystem altered.\n\nSQL&gt; alter system set db_recovery_file_dest=&#39;+DG_BACKUP&#39; scope=spfile;\n\nSystem altered.\n\nSQL&gt; alter system set control_files=&#39;+DG_DATA/racdb/control01.ctl&#39; scope=spfile;\n\nSystem altered.\n\nSQL&gt; create pfile &#39;/oracle/racdbpfile.ora&#39; from spfile;\ncreate pfile &#39;/oracle/racdbpfile.ora&#39; from spfile\n             *\nERROR at line 1:\nORA-00923: FROM keyword not found where expected\n\n\nSQL&gt; create pfile=&#39;/oracle/racdbpfile.ora&#39; from spfile;\n\nFile created.\n\nSQL&gt; shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL&gt; \nSQL&gt; startup pfile=&#39;/oracle/racdbpfile.ora&#39; nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL&gt; create spfile from pfile=&#39;/oracle/racdbpfile.ora&#39;;\n\nFile created.\n\nSQL&gt; create spfile=&#39;+DG_DATA/racdb/spfileracdb.ora&#39; from pfile=&#39;/oralce/racdbpfile.ora&#39;\n  2  ;\ncreate spfile=&#39;+DG_DATA/racdb/spfileracdb.ora&#39; from pfile=&#39;/oralce/racdbpfile.ora&#39;\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file &#39;/oralce/racdbpfile.ora&#39;\n\n\nSQL&gt; create spfile=&#39;+DG_DATA/racdb/spfileracdb.ora&#39; from pfile=&#39;/oralce/racdbpfile.ora&#39;\n  2  ;\ncreate spfile=&#39;+DG_DATA/racdb/spfileracdb.ora&#39; from pfile=&#39;/oralce/racdbpfile.ora&#39;\n*\nERROR at line 1:\nORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file &#39;/oralce/racdbpfile.ora&#39;\n\n\nSQL&gt; create spfile=&#39;+DG_DATA/racdb/spfileracdb.ora&#39; from pfile=&#39;/oracle/racdbpfile.ora&#39;;\n\nFile created.\n\nSQL&gt; shutdown immediate;\nORA-01507: database not mounted\n\n\nORACLE instance shut down.\nSQL&gt; startup nomount;\nORACLE instance started.\n\nTotal System Global Area 1043886080 bytes\nFixed Size                  2259840 bytes\nVariable Size             335545472 bytes\nDatabase Buffers          700448768 bytes\nRedo Buffers                5632000 bytes\nSQL&gt; show parameter spfile\nSQL&gt; show parameter control\n\nNAME                                 TYPE                   VALUE\n------------------------------------ ---------------------- ------------------------------\ncontrol_file_record_keep_time        integer                7\ncontrol_files                        string                 +DG_DATA/racdb/control01.ctl\ncontrol_management_pack_access       string                 DIAGNOSTIC+TUNING\n\n\n[oracle@rac1:/]$rman target /\n\nRecovery Manager: Release 11.2.0.4.0 - Production on Thu Feb 1 15:37:25 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\nconnected to target database: RACDB (not mounted)\n\nRMAN&gt; restore controlfile from &#39;/u01/backup/datafile/racdb_ctrl_32_1_966957454&#39;;\n\nStarting restore at 2018-02-01 15:37:57\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=10 device type=DISK\n\nchannel ORA_DISK_1: restoring control file\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:03\noutput file name=+DG_DATA/racdb/control01.ctl\nFinished restore at 2018-02-01 15:38:01\n\nSQL&gt; alter database mount;\n\nDatabase altered.\n\n\nRMAN&gt; list backup;\n\nreleased channel: ORA_DISK_1\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n24      Full    1.05G      DISK        00:00:15     2018-02-01 15:17:28\n        BP Key: 24   Status: AVAILABLE  Compressed: NO  Tag: RACDB_FULL\n        Piece Name: /u01/backup/datafile/racdb_full_30_1_966957433\n  List of Datafiles in backup set 24\n  File LV Type Ckp SCN    Ckp Time            Name\n  ---- -- ---- ---------- ------------------- ----\n  1       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSTEM01.dbf\n  2       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/SYSAUX01.dbf\n  3       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/UNDOTBS01.dbf\n  4       Full 874708     2018-02-01 15:17:14 /oracle/oradata/racdb/USERS01.dbf\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time    \n------- ---- -- ---------- ----------- ------------ -------------------\n25      Full    46.05M     DISK        00:00:01     2018-02-01 15:17:30\n        BP Key: 25   Status: AVAILABLE  Compressed: NO  Tag: TAG20180201T151729\n        Piece Name: +DG_BACKUP/racdb/autobackup/2018_02_01/s_966957449.256.966957449\n  SPFILE Included: Modification time: 2018-02-01 14:40:33\n  SPFILE db_unique_name: RACDB\n  Control File Included: Ckp SCN: 874719       Ckp time: 2018-02-01 15:17:29\n\n  List of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    750      SYSTEM               ***     /oracle/oradata/racdb/SYSTEM01.dbf\n2    600      SYSAUX               ***     /oracle/oradata/racdb/SYSAUX01.dbf\n3    885      UNDOTBS1             ***     /oracle/oradata/racdb/UNDOTBS01.dbf\n4    5        USERS                ***     /oracle/oradata/racdb/USERS01.dbf\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    100      TEMP                 100         /oracle/oradata/racdb/temp01.dbf\n\nRMAN&gt; run{\n2&gt; set newname for datafile 1 to &quot;+DG_DATA&quot;;\n3&gt; set newname for datafile 2 to &quot;+DG_DATA&quot;;\n4&gt; set newname for datafile 3 to &quot;+DG_DATA&quot;;\n5&gt; set newname for datafile 4 to &quot;+DG_DATA&quot;;\n6&gt; set newname for tempfile 1 to &quot;+DG_DATA&quot;;\n7&gt; restore database;\n8&gt; switch datafile all;\n9&gt; recover database;\n10&gt; }\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nStarting restore at 2018-02-01 15:44:20\nusing channel ORA_DISK_1\n\nchannel ORA_DISK_1: starting datafile backup set restore\nchannel ORA_DISK_1: specifying datafile(s) to restore from backup set\nchannel ORA_DISK_1: restoring datafile 00001 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00002 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00003 to +DG_DATA\nchannel ORA_DISK_1: restoring datafile 00004 to +DG_DATA\nchannel ORA_DISK_1: reading from backup piece /u01/backup/datafile/racdb_full_30_1_966957433\nchannel ORA_DISK_1: piece handle=/u01/backup/datafile/racdb_full_30_1_966957433 tag=RACDB_FULL\nchannel ORA_DISK_1: restored backup piece 1\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:45\nFinished restore at 2018-02-01 15:45:05\n\ndatafile 1 switched to datafile copy\ninput datafile copy RECID=15 STAMP=966959106 file name=+DG_DATA/racdb/datafile/system.261.966959061\ndatafile 2 switched to datafile copy\ninput datafile copy RECID=16 STAMP=966959106 file name=+DG_DATA/racdb/datafile/sysaux.260.966959061\ndatafile 3 switched to datafile copy\ninput datafile copy RECID=17 STAMP=966959106 file name=+DG_DATA/racdb/datafile/undotbs1.262.966959061\ndatafile 4 switched to datafile copy\ninput datafile copy RECID=18 STAMP=966959106 file name=+DG_DATA/racdb/datafile/users.265.966959061\n\nStarting recover at 2018-02-01 15:45:08\nusing channel ORA_DISK_1\n\nstarting media recovery\n\narchived log for thread 1 with sequence 33 is already on disk as file /oracle/oradata/racdb/redo03.log\narchived log file name=/oracle/oradata/racdb/redo03.log thread=1 sequence=33\nmedia recovery complete, elapsed time: 00:00:01\nFinished recover at 2018-02-01 15:45:11\n\n\n--这里不知道为什么控制文件也帮我恢复了\nASMCMD [+DG_DATA/racdb] &gt; ls\nCONTROLFILE/\nDATAFILE/\nPARAMETERFILE/\ncontrol01.ctl\nspfileracdb.ora\nASMCMD [+DG_DATA/racdb] &gt; cd datafile\nASMCMD [+DG_DATA/racdb/datafile] &gt; ls\nSYSAUX.260.966959061\nSYSTEM.261.966959061\nUNDOTBS1.262.966959061\nUSERS.265.966959061\nASMCMD [+DG_DATA/racdb/datafile] &gt;  \n\nQL&gt; alter database add logfile group 3 (&#39;+DG_DATA&#39;) size 100m;\n\nDatabase altered.\n\nSQL&gt; alter database add logfile group 4 (&#39;+DG_DATA&#39;) size 100m;\n\nDatabase altered.\n\nSQL&gt; alter system switch logfile;\n\nSystem altered.\n\nSQL&gt; select member from v$log;\nselect member from v$log\n       *\nERROR at line 1:\nORA-00904: &quot;MEMBER&quot;: invalid identifier\n\n\nSQL&gt; select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 NO  CURRENT       876161 2018-02-01 16:02:43   2.8147E+14\n         3          1          0  104857600        512          1 YES UNUSED     0                                 0\n         4          1          0  104857600        512          1 YES UNUSED     0                                 0\n\nSQL&gt; alter system switch logfile;\n\nSystem altered.\n\nSQL&gt; alter system switch logfile;\n\nSystem altered.\n\nSQL&gt; select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES ACTIVE        875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES ACTIVE        876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES ACTIVE        876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL&gt; alter system checkpoint;\n\nSystem altered.\n\nSQL&gt; alter system checkpoint;\n\nSystem altered.\n\nSQL&gt; select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          1  104857600        512          1 YES INACTIVE      875061 2018-02-01 15:50:41       876161 2018-02-01 16:02:43\n         2          1          2  104857600        512          1 YES INACTIVE      876161 2018-02-01 16:02:43       876177 2018-02-01 16:03:03\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL&gt; alter system drop logfile group 1;\nalter system drop logfile group 1\n             *\nERROR at line 1:\nORA-02065: illegal option for ALTER SYSTEM\n\n\nSQL&gt; alter database drop logfile group 1;\n\nDatabase altered.\n\nSQL&gt; alter database drop logfile group 2;\n\nDatabase altered.\n\nSQL&gt; \nSQL&gt; \nSQL&gt; \nSQL&gt; \nSQL&gt; \nSQL&gt; \nSQL&gt; \nSQL&gt; alter database add logfile group 2 (&#39;+DG_DATA&#39;) size 100m;\n\nDatabase altered.\n\nSQL&gt; alter database add logfile group 1(&#39;+DG_DATA&#39;) size 100m;\n\nDatabase altered.\n\nSQL&gt; select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL&gt; select * from v$log;\n\n    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS         FIRST_CHANGE# FIRST_TIME   NEXT_CHANGE# NEXT_TIME\n---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------------- ------------ -------------------\n         1          1          0  104857600        512          1 YES UNUSED     0                                 0\n         2          1          0  104857600        512          1 YES UNUSED     0                                 0\n         3          1          3  104857600        512          1 YES INACTIVE      876177 2018-02-01 16:03:03       876180 2018-02-01 16:03:04\n         4          1          4  104857600        512          1 NO  CURRENT       876180 2018-02-01 16:03:04   2.8147E+14\n\nSQL&gt; alter system switch logfile;\n\nSystem altered.\n\n\nSQL&gt; /\n\nSystem altered.\n\nSQL&gt; alter system checkpoint\n  2  ;\n\nSystem altered.\n\n</code></pre>\n"},{"title":"Oracle数据库逻辑备份恢复迁移之expdp与impdp","date":"2018-10-02T06:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n# Oracle数据库逻辑备份恢复迁移之expdp与impdp\n\n## 注意\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.Oracle数据泵expdp/impdp概念\n* Oracle Database 10g引入了最新的数据泵(Data Dump)技术，数据泵导出导入(EXPDP和IMPDP)的作用\n> 1）实现逻辑备份和逻辑恢复.\n2）在数据库用户之间移动对象.\n3）在数据库之间移动对象\n4）实现表空间搬移.\n* 数据泵导出导入与传统导出导入的区别\n>&emsp;&emsp;在10g之前,传统的导出和导入分别使用exp工具和imp工具,从10g开始,不仅保留了原有的exp和imp工具,还提供了数据泵导出导入工具expdp和impdp.使用expdp和impdp时应该注意的事项：\n1）exp和imp是客户端工具程序,它们既可以在可以客户端使用,也可以在服务端使用。\n2）expdp和impdp是服务端的工具程序,他们只能在oracle服务端使用,不能在客户端使用。\n3）imp只适用于exp导出文件,不适用于expdp导出文件;impdp只适用于expdp导出文件,而不适用于exp导出文件。\n\n* 数据泵导出包括导出表,导出方案,导出表空间,导出数据库4种方式.\n\n* oracle数据泵的工作流程如下\n>1、在命令行执行命令\n2、expdp/impdp命令调用dbms_datapump pl/sql包。 这个api提供高速的导出导入功能。\n3、 当data 移动的时候， data pump 会自动选择direct path 或者external table mechanism 或者 两种结合的方式。\n&emsp;&emsp;当metadata（对象定义） 移动的时候，data pump会使用dbms_metadata pl/sql包。 metadata api 将metadata（对象定义）存储在xml里。所有的进程都能load 和unload 这些metadata. 因为data pump 调用的是服务端的api, 所以当一个任务被调度或执行，客户端就可以退出连接，任务job 会在server 端继续执行，随后通过客户端实用程序从任何地方检查任务的状态和进行修改。\n\n## 2.expdp/impdp 命令参数详解\n### 2.1关于expdp\n```shell\n[oracle@db01:/home/oracle]$expdp -help\nExport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:30 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump export utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: expdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Export runs by entering the 'expdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: expdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: expdp scott/tiger DUMPFILE=scott.dmp DIRECTORY=dmpdir SCHEMAS=scott\nor TABLES=(T1:P1,T1:P2), if T1 is partitioned table\nUSERID must be the first parameter on the command line.\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\n\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\n\n该选项用于在客户会话与已存在导出作用之间建立关联.语法如下\nattach=[schema_name.]job_name\nschema_name用于指定方案名,job_name用于指定导出作业名.注意,如果使用attach选项,在命令行除了连接字符串和attach选项外,不能指定任何其他选项,示例如下:\nexpdp scott/tiger attach=scott.export_job\n\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\n而在11GR2后EXPDP和IMDP的WORKER进程会在多个INSTANCE启动，所以DIRECTORY必须在共享磁盘上，如果没有设置共享磁盘还是指定cluster=no来防止报错\n\nCOMPRESSION\nReduce the size of a dump file.\nValid keyword values are: ALL, DATA_ONLY, [METADATA_ONLY] and NONE.\n这个压缩比例可以和操作系统“gzip -9”相媲美，某些特例下有可能比gzip还要高效：1/7。\n10g中的COMPRESSION参数只提供METADATA_ONLY和NONE两个选项，基本上没有提供压缩功能。\n11g中的COMPRESSION参数提供四个选项，分别是ALL、DATA_ONLY、METADATA_ONLY和NONE，非常的丰富，稍后我们将使用ALL参数进行操作。\n\nOracle 11g的EXPDP工具提供了真正意义上的“备份压缩”，这个技术在备份空间不足的情况下非常实用。all 压缩元数据和对象数据 data_only 只压缩对象数据 metadata_only 只压缩元数据 none 不压缩任何数据。\n\nCONTENT\nSpecifies data to unload.\nValid keyword values are: [ALL], DATA_ONLY and METADATA_ONLY.\n该选项用于指定要导出的内容.默认值为all\ncontent={all | data_only | metadata_only}\n当设置content为all 时,将导出对象定义及其所有数据.为data_only时,只导出对象数据,为metadata_only时,只导出对象定义。\nexpdp scott/tiger directory=dump dumpfile=a.dump content=metadata_only\n\nDATA_OPTIONS\nData layer option flags.\nValid keyword values are: XML_CLOBS.\n用于为某些类型的数据提供选项\n\nDIRECTORY\nDirectory object to be used for dump and log files.\n指定转储文件和日志文件所在的目录，directory=directory_object\ndirectory_object用于指定目录对象名称.需要注意,目录对象是使用create directory语句建立的对象,而不是os 目录。\n\nexpdp scott/tiger directory=dump dumpfile=a.dump\n先在对应的位置创建物理文件夹，如d:/backup\n建立目录:\ncreate or replace directory backup as '/opt/oracle/utl_file'\nsql>create directory backup as ‘d:/backup’;\nsql>grant read,write on directory backup to system;\n查询创建了那些子目录:\nselect * from dba_directories;\n\nDUMPFILE\nSpecify list of destination dump file names [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\n用于指定转储文件的名称,默认名称为expdat.dmp\ndumpfile=[directory_object:]file_name [,….]\ndirectory_object用于指定目录对象名,file_name用于指定转储文件名.需要注意,如果不指定directory_object,导出工具会自动使用directory选项指定的目录对象：expdp scott/tiger directory=dump1 dumpfile=dump2:a.dmp\n\nENCRYPTION\nEncrypt part or all of a dump file.\nValid keyword values are: ALL, DATA_ONLY, ENCRYPTED_COLUMNS_ONLY, METADATA_ONLY and NONE.\n是否加密导出数据 默认none\nencryption={all | data_only |metadata_only | encrypted_columns_only | none}\nall 对象和元数据 data_only 对象加密 metadata_only 元数据加密 encryption_columns_only 只加密加密列 none 不加密\n\nENCRYPTION_ALGORITHM\nSpecify how encryption should be done.\nValid keyword values are: [AES128], AES192 and AES256.\n加密算法 默认aes128\nencryption_algorithm= {aes128 | aes 192 | aes 256}\n\nENCRYPTION_MODE\nMethod of generating encryption key.\nValid keyword values are: DUAL, PASSWORD and [TRANSPARENT].\n加密和解密所使用的安全类型\nencryption_mode={dual | password |transparent }\ndual 表示用 oracle wallet 或指定口令建立导出文件password 指定口令建立导出文件 transparent oracle wallet建立导出文件\n\nENCRYPTION_PASSWORD\nPassword key for creating encrypted data within a dump file.\n指定加密和解密口令 encryption_password=password\n\nESTIMATE\nCalculate job estimates.\nValid keyword values are: [BLOCKS] and STATISTICS.\n指定估算被导出表所占用磁盘空间分方法.默认值是blocks。\nextimate={blocks | statistics}\n设置为blocks时,oracle会按照目标对象所占用的数据块个数乘以数据块尺寸估算对象占用的空间,设置为statistics时,根据最近统计值估算对象占用空间: expdp scott/tiger tables=emp estimate=statistics directory=dump dumpfile=a.dump\n\nESTIMATE_ONLY\nCalculate job estimates without performing the export.\n指定是否只估算导出作业所占用的磁盘空间,默认值为n\nextimate_only={y | n}\n设置为y时,导出作用只估算对象所占用的磁盘空间,而不会执行导出作业,为n时,不仅估算对象所占用的磁盘空间,还会执行导出操作.\nexpdp scott/tiger estimate_only=y nologfile=y\n\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\n该选项用于指定执行操作时释放要排除对象类型或相关对象 ITPUX\n\nexclude=object_type[:name_clause] [,….]\nobject_type用于指定要排除的对象类型,name_clause用于指定要排除的具体对象.exclude和include不能同时使用。\nexpdp scott/tiger directory=dump dumpfile=a.dup exclude=view\nFILESIZE\nSpecify the size of each dump file in units of bytes.\n指定导出文件的最大尺寸,默认为0,(表示文件尺寸没有限制)\nFLASHBACK_SCN\nSCN used to reset session snapshot.\n指定导出特定scn时刻的表数据。flashback_scn=scn_value\nscn_value用于标识scn值.flashback_scn和flashback_time不能同时使用： expdp\nscott/tiger directory=dump dumpfile=a.dmp flashback_scn=358523\n\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\n指定导出特定时间点的表数据\nflashback_time=”to_timestamp(time_value)”\nexpdp scott/tiger directory=dump dumpfile=a.dmp flashback_time= “to_timestamp(’25-08-2004 14:35:00’,’dd-mm-yyyy hh24:mi:ss’)”\n\nFULL\nExport entire database [N].\n指定数据库模式导出,默认为n。 full={y | n} 。为y时,标识执行数据库导出.\nHELP\nDisplay Help messages [N].\n指定是否显示expdp命令行选项的帮助信息,默认为n。当设置为y时,会显示导出选项的帮助信息. expdp help=y\n\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\n指定导出时要包含的对象类型及相关对象。include = object_type[:name_clause] [,… ]\n\nJOB_NAME\nName of export job to create.\n指定要导出作用的名称,默认为sys_xxx 。job_name=jobname_string\n\nLOGFILE\nSpecify log file name [export.log].\n指定导出日志文件文件的名称,默认名称为export.log\nlogfile=[directory_object:]file_name\ndirectory_object用于指定目录对象名称,file_name用于指定导出日志文件名.如果不指定directory_object.导出作用会自动使用directory的相应选项值.\nexpdp scott/tiger directory=dump dumpfile=a.dmp logfile=a.log\n\nNETWORK_LINK\nName of remote database link to the source system.\n指定数据库链接名,如果要将远程数据库对象导出到本地例程的转储文件中,必须设置该选项.\n\nNOLOGFILE\nDo not write log file [N].\n该选项用于指定禁止生成导出日志文件,默认值为n.\n\nPARALLEL\nChange the number of active workers for current job.\n指定执行导出操作的并行进程个数,默认值为1\n一般是cpu的2倍，可以被文件个数整除\n\nPARFILE\nSpecify parameter file name.\n指定导出参数文件的名称。parfile=[directory_path] file_name\n\nQUERY\nPredicate clause used to export a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\n用于指定过滤导出数据的where条件\nquery=[schema.] [table_name:] query_clause\nschema用于指定方案名,table_name用于指定表名,query_clause用于指定条件限制子句.query选项不能与connect=metadata_only,extimate_only,transport_tablespaces等选项同时使用.\nexpdp scott/tiger directory=dump dumpfiel=a.dmp tables=emp query=’where deptno=20’\n\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\n用于转换列的数据函数， 并将转换值导出到文件中\nremap_data=[schema1.]tablename.column_name:[schema2.]pkg.func\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n覆盖已处在的导出文件，默认N\n\nSAMPLE\nPercentage of data to be exported.\n用于指定被采样数据块的百分比\nsample=[[schema_name.]table_name:]sample_percent (采用比率)\n\nSCHEMAS\nList of schemas to export [login schema].\n该方案用于指定执行方案模式导出,默认为当前用户方案.\n\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\n\nSOURCE_EDITION\nEdition to be used for extracting metadata.\n用于提取源数据的版本\n\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n指定显示导出作用进程的详细状态,默认值为0\n\nTABLES\nIdentifies a list of tables to export.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\n指定表模式导出\ntables=[schema_name.]table_name[:partition_name][,…]\nschema_name用于指定方案名,table_name用于指定导出的表名,partition_name用于指定要导出的分区名.\n\nTABLESPACES\nIdentifies a list of tablespaces to export.\n指定要导出表空间列表\n\nTRANSPORTABLE\nSpecify whether transportable method can be used.\nValid keyword values are: ALWAYS and [NEVER].\n指定是否可以使用可传输方法\n\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\n\t该选项用于指定被搬移表空间和未搬移表空间关联关系的检查方式,默认为n. 当设置为y时,导出作用会检查表空间直接的完整关联关系,如果表空间所在表空间或其索引所在的表空间只有一个表空间被搬移,将显示错误信息.当设置为n时,导出作用只检查单端依赖,如果搬移索引所在表空间,但未搬移表所在表空间,将显示出错信息,如果搬移表所在表空间,未搬移索引所在表空间,则不会显示错误信息.\n\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be unloaded.\n指定执行表空间模式导出 ，用于指定搬移的的表空间\nVERSION\nVersion of objects to export.\nValid keyword values are: [COMPATIBLE], LATEST or any valid database version.\n用于指定被导出对象的数据库版本 默认 compatible\nversion={compatable | latest |version_string}\ncompatible 根据compatible参数生成对象 latest 根据数据库的实际版本 version_string 指定数据库版本（>9.2）\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nADD_FILE\nAdd dumpfile to dumpfile set. \n\n向转储文件集中添加转储文件\n\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\n返回到记录模式。如果处于空闲状态, 将重新启动作业。\n\nEXIT_CLIENT\nQuit client session and leave job running.\n退出客户机会话并使作业处于运行状态\n\nFILESIZE\nDefault filesize (bytes) for subsequent ADD_FILE commands.\n后续 ADD_FILE 命令的默认文件大小 (字节)。\n\nHELP\nSummarize interactive commands.\n总结交互命令。\n\nKILL_JOB\nDetach and delete job.\n分离和删除作业\nPARALLEL\nChange the number of active workers for current job.\n更改当前作业的活动 worker 的数目。\n\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n是否覆盖dumpfiles\n\nSTART_JOB\nStart or resume current job.\n\nValid keyword values are: SKIP_CURRENT.\n启动/恢复当前作业。\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n在默认值 (0) 将显示可用时的新状态的情况下,要监视的频率 (以秒计) 作业状态。\nSTATUS[=interval]\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keyword values are: IMMEDIATE.\n顺序关闭执行的作业并退出客户机。STOP_JOB=IMMEDIATE 将立即关闭数据泵作业。\n```\n## 2.2 关于impdp\n```shell\n[oracle@db01:/home/oracle]$impdp -help\nImport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:43 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump Import utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Import runs by entering the 'impdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: impdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nUSERID must be the first parameter on the command line.\n------------------------------------------------------------------------------\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\nCONTENT\nSpecifies data to load.\nValid keywords are: [ALL], DATA_ONLY and METADATA_ONLY.\nDATA_OPTIONS\nData layer option flags.\nValid keywords are: SKIP_CONSTRAINT_ERRORS.\nDIRECTORY\nDirectory object to be used for dump, log and SQL files.\nDUMPFILE\nList of dump files to import from [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\nENCRYPTION_PASSWORD\nPassword key for accessing encrypted data within a dump file.\nNot valid for network import jobs.\nESTIMATE\nCalculate job estimates.\nValid keywords are: [BLOCKS] and STATISTICS.\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\nFLASHBACK_SCN\nSCN used to reset session snapshot.\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\nFULL\nImport everything from source [Y].\nHELP\nDisplay help messages [N].\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\nJOB_NAME\nName of import job to create.\nLOGFILE\nLog file name [import.log].\nNETWORK_LINK\nName of remote database link to the source system.\nNOLOGFILE\nDo not write log file [N].\nPARALLEL\nChange the number of active workers for current job.\nPARFILE\nSpecify parameter file.\nPARTITION_OPTIONS\nSpecify how partitions should be transformed.\nValid keywords are: DEPARTITION, MERGE and [NONE].\nQUERY\nPredicate clause used to import a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\nREMAP_DATAFILE\nRedefine data file references in all DDL statements.\nREMAP_SCHEMA\nObjects from one schema are loaded into another schema.\nREMAP_TABLE\nTable names are remapped to another table.\nFor example, REMAP_TABLE=HR.EMPLOYEES:EMPS.\nREMAP_TABLESPACE\nTablespace objects are remapped to another tablespace.\nREUSE_DATAFILES\nTablespace will be initialized if it already exists [N].\nSCHEMAS\nList of schemas to import.\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\nSKIP_UNUSABLE_INDEXES\nSkip indexes that were set to the Index Unusable state.\nSOURCE_EDITION\nEdition to be used for extracting metadata.\nSQLFILE\nWrite all the SQL DDL to a specified file.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTREAMS_CONFIGURATION\nEnable the loading of Streams metadata\nTABLE_EXISTS_ACTION\nAction to take if imported object already exists.\nValid keywords are: APPEND, REPLACE, [SKIP] and TRUNCATE.\nTABLES\nIdentifies a list of tables to import.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\nTABLESPACES\nIdentifies a list of tablespaces to import.\nTARGET_EDITION\nEdition to be used for loading metadata.\nTRANSFORM\nMetadata transform to apply to applicable objects.\nValid keywords are: OID, PCTSPACE, SEGMENT_ATTRIBUTES and STORAGE.\nTRANSPORTABLE\nOptions for choosing transportable data movement.\nValid keywords are: ALWAYS and [NEVER].\nOnly valid in NETWORK_LINK mode import operations.\nTRANSPORT_DATAFILES\nList of data files to be imported by transportable mode.\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be loaded.\nOnly valid in NETWORK_LINK mode import operations.\nVERSION\nVersion of objects to import.\nValid keywords are: [COMPATIBLE], LATEST or any valid database version.\nOnly valid for NETWORK_LINK and SQLFILE.\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\nEXIT_CLIENT\nQuit client session and leave job running.\nHELP\nSummarize interactive commands.\nKILL_JOB\nDetach and delete job.\nPARALLEL\nChange the number of active workers for current job.\nSTART_JOB\nStart or resume current job.\nValid keywords are: SKIP_CURRENT.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keywords are: IMMEDIATE.\n\n其实IMPDP命令行选项与EXPDP有很多相同的,下面我们只介绍不同的部分：\n（1）REMAP_DATAFILE\n该选项用于将源数据文件名转变为目标数据文件名,在不同平台之间搬移表空间时可能需要该选项.\nREMAP_DATAFIEL=source_datafie:target_datafile\n\n（2）REMAP_SCHEMA\n该选项用于将源方案的所有对象装载到目标方案中.\nREMAP_SCHEMA=source_schema:target_schema\n\n（3）REMAP_TABLESPACE\n将源表空间的所有对象导入到目标表空间中\nREMAP_TABLESPACE=source_tablespace:target_tablespace\n\n（4）REUSE_DATAFILES\n该选项指定建立表空间时是否覆盖已存在的数据文件.默认为N。\nREUSE_DATAFIELS={Y | N}\n\n（5）SKIP_UNUSABLE_INDEXES\n指定导入是是否跳过不可使用的索引,默认为N\n\n（6）SQLFILE\n指定将导入要指定的索引DDL操作写入到SQL脚本中。\nSQLFILE=[directory_object:]file_name\nImpdp scott/tiger DIRECTORY=dump DUMPFILE=tab.dmp SQLFILE=a.sql\n\n（7）STREAMS_CONFIGURATION\n指定是否导入流元数据(Stream Matadata),默认值为Y.\n\n（8）TABLE_EXISTS_ACTION\n该选项用于指定当表已经存在时导入作业要执行的操作,默认为SKIP\nTABBLE_EXISTS_ACTION={SKIP | APPEND | TRUNCATE | FRPLACE }\n当设置该选项为SKIP时,导入作业会跳过已存在表处理下一个对象;当设置为APPEND时,会追加数据,为TRUNCATE时,导入作业会截断表,然后为其追加新数据;当设置为REPLACE时,导入作业会删除已存在表,重建表病追加数据,注意,TRUNCATE选项不适用与簇表和NETWORK_LINK选项\n\n（9）TRANSFORM\n该选项用于指定是否修改建立对象的DDL语句\nTRANSFORM=transform_name:value[:object_type]\nTransform_name用于指定转换名,其中SEGMENT_ATTRIBUTES用于标识段属性(物理属性,存储属性,表空间,日志等信息),STORAGE用于标识段存储属性,VALUE用于指定是否包含段属性或段存储属性,object_type用于指定对象类型.\nImpdp scott/tiger directory=dump dumpfile=tab.dmp Transform=segment_attributes:n:table\n\n（10）TRANSPORT_DATAFILES\n该选项用于指定搬移空间时要被导入到目标数据库的数据文件。\nTRANSPORT_DATAFILE=datafile_name\nDatafile_name用于指定被复制到目标数据库的数据文件\nImpdp system/manager DIRECTORY=dump DUMPFILE=tts.dmp TRANSPORT_DATAFILES=’/user01/data/tbs1.f’\n```\n## 3.expdp/impdp 使用方法详解\n\n\n### 3.1 oracle expdp 使用方法介绍\n```shell\n使用expdp工具时,其转储文件只能被存放在directory对象对应的os目录中,而不能直接指定转储文件所在的os目录.因此,使用expdp工具时,必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n--创建directory:\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导出整个数据库\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=expdp_full_db01.log full=y parallel=4\n\n--02)导出方案-schema-用户\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=expdp_u_itpux01.log schemas=itpux01,itpux02\n\n--03)导出表空间\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=expdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导出表\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01,itpux02\nexpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01\n\n--05)按表查询条件导出\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log tables=itpux01 query='where id=5'\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log QUERY=employees:\"WHERE department_id > 10\"\n```\n### 3.2 oracle impdp 使用方法介绍\n>使用impdp工具时,如果数据库中不存在相应的directory，必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n```sql\n--创建directory:\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导入整个数据库\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=impdp_full_db01.log full=y\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=impdp_full_db01.log full=y parallel=4\n\n--02)导入方案-schema-用户\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02 remap_schema=itpux02:itpux002\n\n--03)导入表空间\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=impdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导入表\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux\nimpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995\n\n--05)按表查询条件导入\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 query='where id=5'\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux query='where id=5'\n\nimpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01 query='where id=5'\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995 QUERY=HR.EMPLOYEES:\"WHERE department_id > 10\"\n```\n\n### 3.3 oracle expdp/impdp补充\n```shell\n--01)directory\ncreate directory itpuxbak_dir as '/backup';\n--drop directory itpuxbak_dir\nselect * from dba_directories\ngrant read,write on directory itpuxbak_dir to system; --system:itpux01:other users\ngrant create any directory to system;\nselect * from dba_sys_privs where grantee='SYSTEM';\n\n--02) sysdba full=y\nexpdp \"'/as sysdba'\" directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y --sys\n\n--03)查询datapump jobs\nselect * from dba_datapump_jobs;\nexpdp \"'/as sysdba'\" directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y job_name=itpuxexpjob;\n```\n\n## 4.配置生产环境的逻辑自动备份策略\n>每天做逻辑备份，数据量大小500G，保留2天，空间准备2TB\n我的库不开归档的，不能在线做RMAN。\n```shell\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant create any directory to system;\n\n#vi expdpfull_db01.sh\nexport BAKDATE=`date +%Y%m%d`\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.$BAKDATE.%U.dmp logfile=expdp_full_db01.$BAKDATE.log full=y parallel=4\nfind /backup -name expdp_full_db01.*.dmp -atime +2 -exec rm -rf {} \\;\n\n#--cluster=N\n#chown -R oracle:dba /backup\n#chmod -R 775 /backup\n#crontab -e\n0 20 * * * su - oracle -c /backup/scripts/expdpfull_db01.sh\n```\n* --报错的处理：\n```shell\nORA-39181: Only partial table data may be exported due to fine grain access control on \"OE\".\"PURCHASEORDER\"\nselect count(*) from \"OE\".\"PURCHASEORDER\"\ngrant EXEMPT ACCESS POLICY to system;\nexpdp system/oracle directory=itpuxbak_dir dumpfile=test-b.dmp logfile=test-b.log tables=OE.PURCHASEORDER\n```\n\n## 5.expdp/impdp生产环境数据迁移流程\n* 5.1、做数据迁移流程的目的\n>使用expdp/impdp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n\n* 5.2、数据迁移的适用范围\n>所有线上库>10.2\n\n* 5.3、 数据迁移的风险评估\n>01.有些os对文件大小有限制，expdp数据时需要使用filesize参数来分割导出文件\n02.expdp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n03.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n04.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n\n* 5.4、数据迁移的准备工作\n>01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用expdp/impdp迁移数据。\n02.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。\n03.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\n04.提前准备备份脚本（parfile参数）：\n```shell\ncat expdp_itpux.par\nuserid=system/oracle\ndirectory=itpuxbak_dir\ndumpfile=expdp_full_db01.$BAKDATE.%U.dmp\nlogfile=expdp_full_db01.$BAKDATE.log\ntables=user.tab1,user.tab2,user.tab3\nparallel=4\n\nvi expdp.sh\n\nexport BAKDATE=`date +%Y%m%d`\nexpdp parfile=expdp_itpux.par\nnohup ./expdp.sh &\n```\n\n* 5.5、数据迁移的执行过程\n\n\n* 5.6、数据迁移后的验证方案\n>对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n编译无效对象\n\n\n## 6.expdp/impdp生产环境数据迁移案例\n>迁移过程详细请看视频演示，此处只做参考\n### 6.1 迁移目的\n>将linux系统oracle服务器上schema（itpux01,itpux02）全部通过ExpDP全库迁移到另一台oracle服务器，并能正常查询到相关数据。\n>IMPDP虽然加上parallel参数，在做table数据导入时确实速度提高了不少，但是在create index和statistics时，依旧采用单线程的方式，故此一般在迁移过程中这两步操作选择生产DDL脚本增加parallel参数后手工执行，以最大化缩减迁移时间。\n### 6.2 迁移流程\n```sql\n1.linux系统oracle服务器上创建测试数据。\n2.linux本地用Expdp做导出;\n3.远程主机创建相关对象；\n4.远程主机用expdp做导入(导入);\n5.验证远程本地数据合法性;\n```\n### 6.3 演示过程\n* 01.准备数据\n```sql\n/* Formatted on 2018/1/30 21:28:32 (QP5 v5.313) */\nCREATE TABLESPACE itpux11\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE itpux12\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n--创建用户并授权\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n\n--用户登录并创建测试表\nCONN itpux01 / itpux01\n\nCREATE TABLE itpux01\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\nCONN itpux02 / itpux02\n\nCREATE TABLE itpux02\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\n--要建两个索引\n\nCREATE INDEX itpux02\n    ON itpux02_table_test (id);\n\n--创建2个存储过程并执行。\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\nEND p_itpux01;\n/\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n```\n* 查询验证数据\n```sql\n/* Formatted on 2018/1/30 21:31:51 (QP5 v5.313) */\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id > 1990;\n\n--02.获取DDL\n--在源主机获取：\nSPOOL itpux_tbs_create_ddl.sql\nSET LONG 200000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 200\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX02') FROM DUAL;\n\nSPOOL OFF;\n--在另一台主机执行：\nCREATE TABLESPACE \"ITPUX01\"\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE \"ITPUX02\"\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\n--03、源库导出\n建立目录（建立directory）\nSQL> CREATE OR REPLACE DIRECTORY oradmp AS '/oracle/backup';\nSQL> GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\nexpdp SYSTEM/oracle DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=expdpfull_db01.LOG PARALLEL=2;\n--04、目标库导入\n禁止自动维护任务\n（禁用数据库自动维护任务，oracle11g中存在）\nSQL> EXECUTE DBMS_AUTO_TASK_ADMIN.DISABLE;\n建立目录（建立directory）\nSQL> CREATE OR REPLACE DIRECTORY oradmp AS '/oracle/backup';\nSQL> GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\n生成index、CONSTRAINT的ddl语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp dumpfile=itpux_01.dmp,itpux_02.dmp LOGFILE=impitpux.LOG PARALLEL=2 SQLFILE=indconddl.SQL INCLUDE=INDEX,CONSTRAINT SCHEMAS=itpux\n编辑ddl语句脚本\nsed 's/NOLOGGING/ /g;s/LOGGING/ /g' indconddl.SQL>indconddl.sql.nologin\nsed '/TABLESPACE/ s/TS_itpux/TS_itpux_INDEX/g;/TABLESPACE/ s/1/32 NOLOGGING/g' indconddl.sql.nologin>indconddl.sql.NEW\n设置parallel 4;\n执行导入语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=impdpfull_db01.LOG PARALLEL=2\nEXCLUDE=INDEX,CONSTRAINT,STATISTICS SCHEMAS=ITPUX;\n检查job，延后迁移时间内发起的job任务\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n执行ddl语句脚本，建立索引、约束，手工发起统计分析\n建立索引、约束\nchmod +x indconddl.sql.NEW\n more createindcon.sh\nSQLPLUS -s /nolog <<EOS\nCONNECT itpux / itpux\nSPOOL /tmp/indconcreate.log\n@ /oracle/backup/indconddl.sql.new;\nSPOOL OFF\nEXIT\nEOS\n执行createindcon.sh\n然后再改parallel 4;为NOPARALLEL\n--05、收集统计信息\nstats.SQL:\n\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nnohup sqlplus \"/as sysdba\" @ stats.SQL &\n--06、无效对象的编译\n自动生成编译无效对象SQL及编译过程\n1) 统计当前用户无效对象数量:\n  SELECT OWNER,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY OWNER, object_type, status\nORDER BY OWNER, object_type;\n2) 生成编译无效对象SQL\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n# su - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/ADMIN/utlrp.SQL\n--07、验证数据\n对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n\nSELECT COUNT (*) FROM itpux.itpux01;\n\nSQL>SELECT OWNER,OBJECT_TYPE,COUNT(*) FROM dba_objects WHERE wner='&owner' GROUP BY OWNER,OBJECT_TYPE ORDER BY OBJECT_TYPE;\n跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n检查对象状态\nSQL>SELECT OWNER,OBJECT_NAME,SUBOBJECT_NAME,STATUS,OBJECT_TYPE FROM dba_objects WHERE wner='&owner' ORDER BY OBJECT_TYPE, OBJECT_NAME, SUBOBJECT_NAME;\n\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status <> 'VALID' AND owner = 'ITPUX01';\n\n--08、收尾\n启用数据库自动维护任务\nSQL> EXECUTE DBMS_AUTO_TASK_ADMIN.ENABLE;\n检查并更正job运行时间\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n--09、对外应用测试\n```\n\n## 7.expdp/impdp迁移过程字符集的处理\n>进行数据的导入导出时，我们要注意关于字符集的问题。在EXPDP/IMPDP过程中我们需要注意四个字符集的参数：\n```sql\n01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n05.导入端数据库字符集。\n```\n* 查看数据库的字符集的信息\n```sql\nSQL> select * from nls_database_parameters;\n//SQL> select * from props$;\nNLS_LANGUAGE AMERICAN\nNLS_TERRITORY AMERICA\nNLS_CURRENCY $\nNLS_ISO_CURRENCY AMERICA\nNLS_NUMERIC_CHARACTERS .,\nNLS_CHARACTERSET ZHS16GBK\nNLS_CALENDAR GREGORIAN\nNLS_DATE_FORMAT DD-MON-RR\nNLS_DATE_LANGUAGE AMERICAN\nNLS_SORT BINARY\nNLS_TIME_FORMAT HH.MI.SSXFF AM\nNLS_TIMESTAMP_FORMAT DD-MON-RR HH.MI.SSXFF AM\nNLS_TIME_TZ_FORMAT HH.MI.SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT DD-MON-RR HH.MI.SSXFF AM TZR\nNLS_DUAL_CURRENCY $\nNLS_COMP BINARY\nNLS_LENGTH_SEMANTICS BYTE\nNLS_NCHAR_CONV_EXCP FALSE\nNLS_NCHAR_CHARACTERSET AL16UTF16\nNLS_RDBMS_VERSION 11.2.0.3.0\n```\n\n* 我们再来查看客户端的字符集信息\n```shell\n客户端字符集的参数NLS_LANG=_< territory >.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n如数据库语言环境\nos是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\nos是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n永久修改可用：\nvi bash_profile\n通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n```\n>(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n(2) 源数据库和目标数据库字符集不同。\n先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n\n## 8.expdp与impdp 版本兼容性与各版本的区别\n参考资料：\nhttp://www.itpux.com/thread-288-1-1.html\n## 9.如何停止expdp与impdp备份任务的后台进程\n参考资料：\nhttp://www.itpux.com/thread-286-1-1.html\n## 10.如何清理不需要的数据泵job\n参考资料：\nhttp://www.itpux.com/thread-287-1-1.html\n## 11.如何对expdp/impdp进行trace跟踪分析问题\n### 11.1 使用Trace 480300\n>&emsp;&emsp;Data Pump工作原理有两个特点：作业调度，多进程配合协作。对Data Pump的诊断本质上就是对各种Process行为的跟踪。Oracle提供了一个Trace的隐含参数，来帮助我们实现这个目标。\n>&emsp;&emsp;Trace并不像其他跟踪过程相同，使用y/n的参数，开启或者关闭。Data Pump的Trace参数是一个7位十六进制组成的数字串。不同的数字串表示不同的跟踪对象方法。7位十六进制数字分为两个部分，前三个数字表示特定的数据泵组件，后四位使用0300就可以。\n\n* 各个组件分别使用不同的三位十六进制数字代表。如下片段所示\n```shell\n-- Summary of Data Pump trace levels:\n-- ==================================\nTrace DM DW ORA Lines\nlevel trc trc trc in\n(hex) file file file trace Purpose\n------- ---- ---- ---- ------ -----------------------------------------------\n10300 x x x SHDW: To trace the Shadow process (API) (expdp/impdp)\n20300 x x x KUPV: To trace Fixed table\n40300 x x x 'div' To trace Process services\n80300 x KUPM: To trace Master Control Process (MCP) (DM)\n100300 x x KUPF: To trace File Manager\n200300 x x x KUPC: To trace Queue services\n400300 x KUPW: To trace Worker process(es) (DW)\n800300 x KUPD: To trace Data Package\n1000300 x META. To trace Metadata Package\n--- +\n1FF0300 x x x 'all' To trace all components (full tracing)\n```\n>如果需要同时跟踪多个组件，需要将目标组件的hex值进行累加，后面四位的300相同。\n>400300+80300=480300\n>&emsp;&emsp;对于跟踪的Trace取值，Oracle建议使用480300就可以应对大部分的情况。480300会跟踪Oracle Dump作业的Master Control Process（MCP）和Work Process。作为初始化跟踪的过程，480300基本就够用了。\n>我们先从数据导出Expdp看Trace，导出一个案例。首先清理一下Trace File目录\n```sql\nexpdp \\\"/ as sysdba\\\" directory=dumpdir schemas=itpux dumpfile=itpux_dump.dmp parallel=2 trace=480300\n```\n>&emsp;&emsp;然后检查trc目录，Dm和dw标注的就是MCP和Work Process生成的Trace文件。同时Parallel设置使得dw有00和01两个。\n>2个trace 文件在BACKGROUND_DUMP_DEST目录下：\n```sql\nMaster Process trace file: <SID>_dm<number>_<process_id>.trc\nWorker Process trace file: <SID>_dw<number>_<process_id>.trc\n```\n>在导出过程中，我们可以看到两个worker的会话信息。\n```sql\nSQL> select * from dba_datapump_sessions;\nOWNER_NAME JOB_NAME INST_ID SADDR SESSION_TYPE\n------------------------------ ------------------------------ ---------- -------- --------------\nSYS SYS_EXPORT_SCHEMA_01 1 35EB0580 DBMS_DATAPUMP\nSYS SYS_EXPORT_SCHEMA_01 1 35E95280 MASTER\nSYS SYS_EXPORT_SCHEMA_01 1 35E8A480 WORKER\nSYS SYS_EXPORT_SCHEMA_01 1 35E84D80 WORKER\n```\n>&emsp;&emsp;此时我们可以从Trace文件中，看到一些Data Pump工作的细节信息。例如：在MCP的Trace文件中，我们看到一系列调用动作过程，如下片段：\n--初始化导出动作，整理文件系统；\n-日志写入\n在Worker Process中，如下片段看出在导出数据。\n### 11.2 使用Trace 480301\n>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。\n```sql\nimpdp \\\"/ as sysdba\\\" directory=dumpdir dumpfile=itpux_dump.dmp remap_schema=itpux:test trace=480301 parallel=2\n```\n>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。我们使用导入过程进行实验。\n>&emsp;&emsp;目录生成的Trace文件，都是10046格式的Raw文件。截取片段如下：\n10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux__dw01_17294.out waits=y sort=exeela\n```\n\n### 11.3.使用10046事件\n* 10046 事件有如下级别\n```shell\nevent 10046, level 1 = enable standardSQL_TRACE functionality\nevent 10046, level 4 = as level 1, plus trace the BIND values\nevent 10046, level 8 = as level 1, plus trace the WAITs\nevent 10046, level 12 = as level 1, plus trace the BIND values and the WAITs\n```\n* 不同级别的使用情况如下\n```shell\nlevel 1: lowest level tracing - not alwayssufficient to determine cause of errors;\nlevel 4: useful when an error in DataPump's worker or master process occurs;\nlevel 12: useful when there is an issuewith Data Pump performance.\n```\n* 注意：\n>&emsp;&emsp; 当我们设置10046的级别高于8或者12的时候，需要将TIMED_STATISTICS设置为TRUE. 临时的将这个参数设置为true，可以将trace数据性能的影响降到最低，在11gR2里，该参数默认为true。\n>一般只有遇到性能问题时，才会使用8或者12的level。\n\n### 11.4 日常使用\n* 01、对当前正在运行的进程进行trace\n```sql\n\n--查看数据泵进程的信息：\nSET LINES 150 PAGES 100 NUMWIDTH 7\nCOL username FOR a10\nCOL spid FOR a7\nCOL program FOR a25\n\nSELECT TO_CHAR (SYSDATE, 'YYYY-MM-DDHH24:MI:SS') \"DATE\",\n       s.program,\n       s.sid,\n       s.status,\n       s.username,\n       d.job_name,\n       p.spid,\n       s.serial#,\n       p.pid\n  FROM v$session s, v$process p, dba_datapump_sessions d\n WHERE p.addr = s.paddr\n ands.saddr=d.saddr;\n```\n>使用sys.dbms_system.set_ev设置10046\n>在上节的查询结果里：\nData Pump Master process (DM00)的SID 是58，serial#是85.\nData Pump Worker process (DW01)的SID 是23，serial#是311.\n\n>使用10046 跟踪活动session的语法如下\n```sql\nSyntax: DBMS_SYSTEM.SET_EV([SID],[SERIAL#],[EVENT],[LEVEL],'')\n\n--在level 4跟踪Worker process进程(Bind values)：\nexecute sys.dbms_system.set_ev(23,311,10046,4,'');\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(23,311,10046,0,'');\n\n--在level 8 跟踪Master进程（Waits）：\nexecute sys.dbms_system.set_ev(143,50,10046,8,'');\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(143,50,10046,0,'');\n```\n* 02、使用oradebug\n>可以在oradebug中设置SPID，来进行trace\n```sql\n--在level 4跟踪Worker process进程(Bind values)：\noradebug setospid 8173\noradebug unlimit\noradebug event 10046 trace name context forever, level 4\noradebug tracefile_name\n\n--在level 8 跟踪Master进程（Waits）：\noradebug setospid 8171\noradebug unlimit\noradebug event 10046 trace name context forever, level 8\noradebug tracefile_name\n\n--stop tracing:\noradebug event 10046 trace name context off ITPUX\n```\n\n* 03、使用tkprof 分析trace文件\n>10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux_dw01_17294.out waits=y sort=exeela\n```\n\n\n## 12.expdp/impdp使用总结\n\n* 1.expdp/impdp 默认就是使用直接路径的，所以速度比较快，但是expdp/impdp 是服务端程序，影响它速度的只有磁盘io。\n* 2.导出多表时，expdp/impdp用法是tables='table1','table2','table3'。\n* 3.dumpfile 参数 ，可以用%u 指定多个数据文件\n```sql\nexpdp xxx/xxx schemas=xxx directory=dump1 dumpfile=xxx_%u.dmp filesize=50g\n```\n>这样每个文件50g ，xxx_01.dump,xxx_02.dump 这样。\n* 4.如果要把用户usera的对象导到用户userb，操作如下：\n```shell\nimpdp system/passwd directory=expdp dumpfile=expdp.dmp remap_schema='usera':'userb' logfile=/oracle/exp.log;\n```\n* 5.如果导入需要更换表空间，impdp用remap_tablespace='tabspace_old':'tablespace_new'\n\n* 6.关于数据导出时要导出哪些内容\n>expdp content（all:对象＋导出数据行，data_only：只导出对象，metadata_only：只导出数据的记录）\n* 7、数据泵expdp/impdp 影响速度和性能最大的就是paralle。 所以使用数据泵，要想提高速度，就要设置并行参数。如：\n>&emsp;&emsp; expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4\n那么expdp将为parallel 创建4个文件： test_01.dmp，test_02.dmp，test_03.dmp，test_04.dmp。 每个进程一个文件。 这样的话，每个文件的大小会因进程而不同。 可以某个文件很大，某个文件却很小。 要解决这个问题，就是设置filesize 参数。 来指定每个文件的最大值。 这样当一个文件达到最大值的之后，就会创建一个新的文件。\n\n>&emsp;&emsp;如：expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4 filesize=50m\n导出的dump文件和paralle有关系，那么导入也有关系。 paralle要小于dump文件数。 如果paralle 大于dump文件的个数，就会因为超过的那个进程获取不到文件，就不能对性能提高。一般parall 参数值等于cpu 的个数。而且要小于dump文件的个数。","source":"_posts/oracle/Oracle数据库逻辑备份恢复迁移之expdp与impdp.md","raw":"---\ntitle: Oracle数据库逻辑备份恢复迁移之expdp与impdp\ndate: 2018-10-02 14:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - Expdp\n  - Impdp\n  - 备份容灾\n---\n\n# Oracle数据库逻辑备份恢复迁移之expdp与impdp\n\n## 注意\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.Oracle数据泵expdp/impdp概念\n* Oracle Database 10g引入了最新的数据泵(Data Dump)技术，数据泵导出导入(EXPDP和IMPDP)的作用\n> 1）实现逻辑备份和逻辑恢复.\n2）在数据库用户之间移动对象.\n3）在数据库之间移动对象\n4）实现表空间搬移.\n* 数据泵导出导入与传统导出导入的区别\n>&emsp;&emsp;在10g之前,传统的导出和导入分别使用exp工具和imp工具,从10g开始,不仅保留了原有的exp和imp工具,还提供了数据泵导出导入工具expdp和impdp.使用expdp和impdp时应该注意的事项：\n1）exp和imp是客户端工具程序,它们既可以在可以客户端使用,也可以在服务端使用。\n2）expdp和impdp是服务端的工具程序,他们只能在oracle服务端使用,不能在客户端使用。\n3）imp只适用于exp导出文件,不适用于expdp导出文件;impdp只适用于expdp导出文件,而不适用于exp导出文件。\n\n* 数据泵导出包括导出表,导出方案,导出表空间,导出数据库4种方式.\n\n* oracle数据泵的工作流程如下\n>1、在命令行执行命令\n2、expdp/impdp命令调用dbms_datapump pl/sql包。 这个api提供高速的导出导入功能。\n3、 当data 移动的时候， data pump 会自动选择direct path 或者external table mechanism 或者 两种结合的方式。\n&emsp;&emsp;当metadata（对象定义） 移动的时候，data pump会使用dbms_metadata pl/sql包。 metadata api 将metadata（对象定义）存储在xml里。所有的进程都能load 和unload 这些metadata. 因为data pump 调用的是服务端的api, 所以当一个任务被调度或执行，客户端就可以退出连接，任务job 会在server 端继续执行，随后通过客户端实用程序从任何地方检查任务的状态和进行修改。\n\n## 2.expdp/impdp 命令参数详解\n### 2.1关于expdp\n```shell\n[oracle@db01:/home/oracle]$expdp -help\nExport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:30 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump export utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: expdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Export runs by entering the 'expdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: expdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: expdp scott/tiger DUMPFILE=scott.dmp DIRECTORY=dmpdir SCHEMAS=scott\nor TABLES=(T1:P1,T1:P2), if T1 is partitioned table\nUSERID must be the first parameter on the command line.\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\n\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\n\n该选项用于在客户会话与已存在导出作用之间建立关联.语法如下\nattach=[schema_name.]job_name\nschema_name用于指定方案名,job_name用于指定导出作业名.注意,如果使用attach选项,在命令行除了连接字符串和attach选项外,不能指定任何其他选项,示例如下:\nexpdp scott/tiger attach=scott.export_job\n\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\n而在11GR2后EXPDP和IMDP的WORKER进程会在多个INSTANCE启动，所以DIRECTORY必须在共享磁盘上，如果没有设置共享磁盘还是指定cluster=no来防止报错\n\nCOMPRESSION\nReduce the size of a dump file.\nValid keyword values are: ALL, DATA_ONLY, [METADATA_ONLY] and NONE.\n这个压缩比例可以和操作系统“gzip -9”相媲美，某些特例下有可能比gzip还要高效：1/7。\n10g中的COMPRESSION参数只提供METADATA_ONLY和NONE两个选项，基本上没有提供压缩功能。\n11g中的COMPRESSION参数提供四个选项，分别是ALL、DATA_ONLY、METADATA_ONLY和NONE，非常的丰富，稍后我们将使用ALL参数进行操作。\n\nOracle 11g的EXPDP工具提供了真正意义上的“备份压缩”，这个技术在备份空间不足的情况下非常实用。all 压缩元数据和对象数据 data_only 只压缩对象数据 metadata_only 只压缩元数据 none 不压缩任何数据。\n\nCONTENT\nSpecifies data to unload.\nValid keyword values are: [ALL], DATA_ONLY and METADATA_ONLY.\n该选项用于指定要导出的内容.默认值为all\ncontent={all | data_only | metadata_only}\n当设置content为all 时,将导出对象定义及其所有数据.为data_only时,只导出对象数据,为metadata_only时,只导出对象定义。\nexpdp scott/tiger directory=dump dumpfile=a.dump content=metadata_only\n\nDATA_OPTIONS\nData layer option flags.\nValid keyword values are: XML_CLOBS.\n用于为某些类型的数据提供选项\n\nDIRECTORY\nDirectory object to be used for dump and log files.\n指定转储文件和日志文件所在的目录，directory=directory_object\ndirectory_object用于指定目录对象名称.需要注意,目录对象是使用create directory语句建立的对象,而不是os 目录。\n\nexpdp scott/tiger directory=dump dumpfile=a.dump\n先在对应的位置创建物理文件夹，如d:/backup\n建立目录:\ncreate or replace directory backup as '/opt/oracle/utl_file'\nsql>create directory backup as ‘d:/backup’;\nsql>grant read,write on directory backup to system;\n查询创建了那些子目录:\nselect * from dba_directories;\n\nDUMPFILE\nSpecify list of destination dump file names [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\n用于指定转储文件的名称,默认名称为expdat.dmp\ndumpfile=[directory_object:]file_name [,….]\ndirectory_object用于指定目录对象名,file_name用于指定转储文件名.需要注意,如果不指定directory_object,导出工具会自动使用directory选项指定的目录对象：expdp scott/tiger directory=dump1 dumpfile=dump2:a.dmp\n\nENCRYPTION\nEncrypt part or all of a dump file.\nValid keyword values are: ALL, DATA_ONLY, ENCRYPTED_COLUMNS_ONLY, METADATA_ONLY and NONE.\n是否加密导出数据 默认none\nencryption={all | data_only |metadata_only | encrypted_columns_only | none}\nall 对象和元数据 data_only 对象加密 metadata_only 元数据加密 encryption_columns_only 只加密加密列 none 不加密\n\nENCRYPTION_ALGORITHM\nSpecify how encryption should be done.\nValid keyword values are: [AES128], AES192 and AES256.\n加密算法 默认aes128\nencryption_algorithm= {aes128 | aes 192 | aes 256}\n\nENCRYPTION_MODE\nMethod of generating encryption key.\nValid keyword values are: DUAL, PASSWORD and [TRANSPARENT].\n加密和解密所使用的安全类型\nencryption_mode={dual | password |transparent }\ndual 表示用 oracle wallet 或指定口令建立导出文件password 指定口令建立导出文件 transparent oracle wallet建立导出文件\n\nENCRYPTION_PASSWORD\nPassword key for creating encrypted data within a dump file.\n指定加密和解密口令 encryption_password=password\n\nESTIMATE\nCalculate job estimates.\nValid keyword values are: [BLOCKS] and STATISTICS.\n指定估算被导出表所占用磁盘空间分方法.默认值是blocks。\nextimate={blocks | statistics}\n设置为blocks时,oracle会按照目标对象所占用的数据块个数乘以数据块尺寸估算对象占用的空间,设置为statistics时,根据最近统计值估算对象占用空间: expdp scott/tiger tables=emp estimate=statistics directory=dump dumpfile=a.dump\n\nESTIMATE_ONLY\nCalculate job estimates without performing the export.\n指定是否只估算导出作业所占用的磁盘空间,默认值为n\nextimate_only={y | n}\n设置为y时,导出作用只估算对象所占用的磁盘空间,而不会执行导出作业,为n时,不仅估算对象所占用的磁盘空间,还会执行导出操作.\nexpdp scott/tiger estimate_only=y nologfile=y\n\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\n该选项用于指定执行操作时释放要排除对象类型或相关对象 ITPUX\n\nexclude=object_type[:name_clause] [,….]\nobject_type用于指定要排除的对象类型,name_clause用于指定要排除的具体对象.exclude和include不能同时使用。\nexpdp scott/tiger directory=dump dumpfile=a.dup exclude=view\nFILESIZE\nSpecify the size of each dump file in units of bytes.\n指定导出文件的最大尺寸,默认为0,(表示文件尺寸没有限制)\nFLASHBACK_SCN\nSCN used to reset session snapshot.\n指定导出特定scn时刻的表数据。flashback_scn=scn_value\nscn_value用于标识scn值.flashback_scn和flashback_time不能同时使用： expdp\nscott/tiger directory=dump dumpfile=a.dmp flashback_scn=358523\n\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\n指定导出特定时间点的表数据\nflashback_time=”to_timestamp(time_value)”\nexpdp scott/tiger directory=dump dumpfile=a.dmp flashback_time= “to_timestamp(’25-08-2004 14:35:00’,’dd-mm-yyyy hh24:mi:ss’)”\n\nFULL\nExport entire database [N].\n指定数据库模式导出,默认为n。 full={y | n} 。为y时,标识执行数据库导出.\nHELP\nDisplay Help messages [N].\n指定是否显示expdp命令行选项的帮助信息,默认为n。当设置为y时,会显示导出选项的帮助信息. expdp help=y\n\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\n指定导出时要包含的对象类型及相关对象。include = object_type[:name_clause] [,… ]\n\nJOB_NAME\nName of export job to create.\n指定要导出作用的名称,默认为sys_xxx 。job_name=jobname_string\n\nLOGFILE\nSpecify log file name [export.log].\n指定导出日志文件文件的名称,默认名称为export.log\nlogfile=[directory_object:]file_name\ndirectory_object用于指定目录对象名称,file_name用于指定导出日志文件名.如果不指定directory_object.导出作用会自动使用directory的相应选项值.\nexpdp scott/tiger directory=dump dumpfile=a.dmp logfile=a.log\n\nNETWORK_LINK\nName of remote database link to the source system.\n指定数据库链接名,如果要将远程数据库对象导出到本地例程的转储文件中,必须设置该选项.\n\nNOLOGFILE\nDo not write log file [N].\n该选项用于指定禁止生成导出日志文件,默认值为n.\n\nPARALLEL\nChange the number of active workers for current job.\n指定执行导出操作的并行进程个数,默认值为1\n一般是cpu的2倍，可以被文件个数整除\n\nPARFILE\nSpecify parameter file name.\n指定导出参数文件的名称。parfile=[directory_path] file_name\n\nQUERY\nPredicate clause used to export a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\n用于指定过滤导出数据的where条件\nquery=[schema.] [table_name:] query_clause\nschema用于指定方案名,table_name用于指定表名,query_clause用于指定条件限制子句.query选项不能与connect=metadata_only,extimate_only,transport_tablespaces等选项同时使用.\nexpdp scott/tiger directory=dump dumpfiel=a.dmp tables=emp query=’where deptno=20’\n\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\n用于转换列的数据函数， 并将转换值导出到文件中\nremap_data=[schema1.]tablename.column_name:[schema2.]pkg.func\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n覆盖已处在的导出文件，默认N\n\nSAMPLE\nPercentage of data to be exported.\n用于指定被采样数据块的百分比\nsample=[[schema_name.]table_name:]sample_percent (采用比率)\n\nSCHEMAS\nList of schemas to export [login schema].\n该方案用于指定执行方案模式导出,默认为当前用户方案.\n\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\n\nSOURCE_EDITION\nEdition to be used for extracting metadata.\n用于提取源数据的版本\n\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n指定显示导出作用进程的详细状态,默认值为0\n\nTABLES\nIdentifies a list of tables to export.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\n指定表模式导出\ntables=[schema_name.]table_name[:partition_name][,…]\nschema_name用于指定方案名,table_name用于指定导出的表名,partition_name用于指定要导出的分区名.\n\nTABLESPACES\nIdentifies a list of tablespaces to export.\n指定要导出表空间列表\n\nTRANSPORTABLE\nSpecify whether transportable method can be used.\nValid keyword values are: ALWAYS and [NEVER].\n指定是否可以使用可传输方法\n\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\n\t该选项用于指定被搬移表空间和未搬移表空间关联关系的检查方式,默认为n. 当设置为y时,导出作用会检查表空间直接的完整关联关系,如果表空间所在表空间或其索引所在的表空间只有一个表空间被搬移,将显示错误信息.当设置为n时,导出作用只检查单端依赖,如果搬移索引所在表空间,但未搬移表所在表空间,将显示出错信息,如果搬移表所在表空间,未搬移索引所在表空间,则不会显示错误信息.\n\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be unloaded.\n指定执行表空间模式导出 ，用于指定搬移的的表空间\nVERSION\nVersion of objects to export.\nValid keyword values are: [COMPATIBLE], LATEST or any valid database version.\n用于指定被导出对象的数据库版本 默认 compatible\nversion={compatable | latest |version_string}\ncompatible 根据compatible参数生成对象 latest 根据数据库的实际版本 version_string 指定数据库版本（>9.2）\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nADD_FILE\nAdd dumpfile to dumpfile set. \n\n向转储文件集中添加转储文件\n\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\n返回到记录模式。如果处于空闲状态, 将重新启动作业。\n\nEXIT_CLIENT\nQuit client session and leave job running.\n退出客户机会话并使作业处于运行状态\n\nFILESIZE\nDefault filesize (bytes) for subsequent ADD_FILE commands.\n后续 ADD_FILE 命令的默认文件大小 (字节)。\n\nHELP\nSummarize interactive commands.\n总结交互命令。\n\nKILL_JOB\nDetach and delete job.\n分离和删除作业\nPARALLEL\nChange the number of active workers for current job.\n更改当前作业的活动 worker 的数目。\n\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n是否覆盖dumpfiles\n\nSTART_JOB\nStart or resume current job.\n\nValid keyword values are: SKIP_CURRENT.\n启动/恢复当前作业。\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n在默认值 (0) 将显示可用时的新状态的情况下,要监视的频率 (以秒计) 作业状态。\nSTATUS[=interval]\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keyword values are: IMMEDIATE.\n顺序关闭执行的作业并退出客户机。STOP_JOB=IMMEDIATE 将立即关闭数据泵作业。\n```\n## 2.2 关于impdp\n```shell\n[oracle@db01:/home/oracle]$impdp -help\nImport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:43 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump Import utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Import runs by entering the 'impdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: impdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nUSERID must be the first parameter on the command line.\n------------------------------------------------------------------------------\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\nCONTENT\nSpecifies data to load.\nValid keywords are: [ALL], DATA_ONLY and METADATA_ONLY.\nDATA_OPTIONS\nData layer option flags.\nValid keywords are: SKIP_CONSTRAINT_ERRORS.\nDIRECTORY\nDirectory object to be used for dump, log and SQL files.\nDUMPFILE\nList of dump files to import from [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\nENCRYPTION_PASSWORD\nPassword key for accessing encrypted data within a dump file.\nNot valid for network import jobs.\nESTIMATE\nCalculate job estimates.\nValid keywords are: [BLOCKS] and STATISTICS.\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\nFLASHBACK_SCN\nSCN used to reset session snapshot.\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\nFULL\nImport everything from source [Y].\nHELP\nDisplay help messages [N].\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\nJOB_NAME\nName of import job to create.\nLOGFILE\nLog file name [import.log].\nNETWORK_LINK\nName of remote database link to the source system.\nNOLOGFILE\nDo not write log file [N].\nPARALLEL\nChange the number of active workers for current job.\nPARFILE\nSpecify parameter file.\nPARTITION_OPTIONS\nSpecify how partitions should be transformed.\nValid keywords are: DEPARTITION, MERGE and [NONE].\nQUERY\nPredicate clause used to import a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\nREMAP_DATAFILE\nRedefine data file references in all DDL statements.\nREMAP_SCHEMA\nObjects from one schema are loaded into another schema.\nREMAP_TABLE\nTable names are remapped to another table.\nFor example, REMAP_TABLE=HR.EMPLOYEES:EMPS.\nREMAP_TABLESPACE\nTablespace objects are remapped to another tablespace.\nREUSE_DATAFILES\nTablespace will be initialized if it already exists [N].\nSCHEMAS\nList of schemas to import.\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\nSKIP_UNUSABLE_INDEXES\nSkip indexes that were set to the Index Unusable state.\nSOURCE_EDITION\nEdition to be used for extracting metadata.\nSQLFILE\nWrite all the SQL DDL to a specified file.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTREAMS_CONFIGURATION\nEnable the loading of Streams metadata\nTABLE_EXISTS_ACTION\nAction to take if imported object already exists.\nValid keywords are: APPEND, REPLACE, [SKIP] and TRUNCATE.\nTABLES\nIdentifies a list of tables to import.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\nTABLESPACES\nIdentifies a list of tablespaces to import.\nTARGET_EDITION\nEdition to be used for loading metadata.\nTRANSFORM\nMetadata transform to apply to applicable objects.\nValid keywords are: OID, PCTSPACE, SEGMENT_ATTRIBUTES and STORAGE.\nTRANSPORTABLE\nOptions for choosing transportable data movement.\nValid keywords are: ALWAYS and [NEVER].\nOnly valid in NETWORK_LINK mode import operations.\nTRANSPORT_DATAFILES\nList of data files to be imported by transportable mode.\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be loaded.\nOnly valid in NETWORK_LINK mode import operations.\nVERSION\nVersion of objects to import.\nValid keywords are: [COMPATIBLE], LATEST or any valid database version.\nOnly valid for NETWORK_LINK and SQLFILE.\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\nEXIT_CLIENT\nQuit client session and leave job running.\nHELP\nSummarize interactive commands.\nKILL_JOB\nDetach and delete job.\nPARALLEL\nChange the number of active workers for current job.\nSTART_JOB\nStart or resume current job.\nValid keywords are: SKIP_CURRENT.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keywords are: IMMEDIATE.\n\n其实IMPDP命令行选项与EXPDP有很多相同的,下面我们只介绍不同的部分：\n（1）REMAP_DATAFILE\n该选项用于将源数据文件名转变为目标数据文件名,在不同平台之间搬移表空间时可能需要该选项.\nREMAP_DATAFIEL=source_datafie:target_datafile\n\n（2）REMAP_SCHEMA\n该选项用于将源方案的所有对象装载到目标方案中.\nREMAP_SCHEMA=source_schema:target_schema\n\n（3）REMAP_TABLESPACE\n将源表空间的所有对象导入到目标表空间中\nREMAP_TABLESPACE=source_tablespace:target_tablespace\n\n（4）REUSE_DATAFILES\n该选项指定建立表空间时是否覆盖已存在的数据文件.默认为N。\nREUSE_DATAFIELS={Y | N}\n\n（5）SKIP_UNUSABLE_INDEXES\n指定导入是是否跳过不可使用的索引,默认为N\n\n（6）SQLFILE\n指定将导入要指定的索引DDL操作写入到SQL脚本中。\nSQLFILE=[directory_object:]file_name\nImpdp scott/tiger DIRECTORY=dump DUMPFILE=tab.dmp SQLFILE=a.sql\n\n（7）STREAMS_CONFIGURATION\n指定是否导入流元数据(Stream Matadata),默认值为Y.\n\n（8）TABLE_EXISTS_ACTION\n该选项用于指定当表已经存在时导入作业要执行的操作,默认为SKIP\nTABBLE_EXISTS_ACTION={SKIP | APPEND | TRUNCATE | FRPLACE }\n当设置该选项为SKIP时,导入作业会跳过已存在表处理下一个对象;当设置为APPEND时,会追加数据,为TRUNCATE时,导入作业会截断表,然后为其追加新数据;当设置为REPLACE时,导入作业会删除已存在表,重建表病追加数据,注意,TRUNCATE选项不适用与簇表和NETWORK_LINK选项\n\n（9）TRANSFORM\n该选项用于指定是否修改建立对象的DDL语句\nTRANSFORM=transform_name:value[:object_type]\nTransform_name用于指定转换名,其中SEGMENT_ATTRIBUTES用于标识段属性(物理属性,存储属性,表空间,日志等信息),STORAGE用于标识段存储属性,VALUE用于指定是否包含段属性或段存储属性,object_type用于指定对象类型.\nImpdp scott/tiger directory=dump dumpfile=tab.dmp Transform=segment_attributes:n:table\n\n（10）TRANSPORT_DATAFILES\n该选项用于指定搬移空间时要被导入到目标数据库的数据文件。\nTRANSPORT_DATAFILE=datafile_name\nDatafile_name用于指定被复制到目标数据库的数据文件\nImpdp system/manager DIRECTORY=dump DUMPFILE=tts.dmp TRANSPORT_DATAFILES=’/user01/data/tbs1.f’\n```\n## 3.expdp/impdp 使用方法详解\n\n\n### 3.1 oracle expdp 使用方法介绍\n```shell\n使用expdp工具时,其转储文件只能被存放在directory对象对应的os目录中,而不能直接指定转储文件所在的os目录.因此,使用expdp工具时,必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n--创建directory:\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导出整个数据库\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=expdp_full_db01.log full=y parallel=4\n\n--02)导出方案-schema-用户\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=expdp_u_itpux01.log schemas=itpux01,itpux02\n\n--03)导出表空间\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=expdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导出表\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01,itpux02\nexpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01\n\n--05)按表查询条件导出\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log tables=itpux01 query='where id=5'\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log QUERY=employees:\"WHERE department_id > 10\"\n```\n### 3.2 oracle impdp 使用方法介绍\n>使用impdp工具时,如果数据库中不存在相应的directory，必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n```sql\n--创建directory:\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导入整个数据库\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=impdp_full_db01.log full=y\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=impdp_full_db01.log full=y parallel=4\n\n--02)导入方案-schema-用户\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02 remap_schema=itpux02:itpux002\n\n--03)导入表空间\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=impdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导入表\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux\nimpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995\n\n--05)按表查询条件导入\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 query='where id=5'\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux query='where id=5'\n\nimpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01 query='where id=5'\nimpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995 QUERY=HR.EMPLOYEES:\"WHERE department_id > 10\"\n```\n\n### 3.3 oracle expdp/impdp补充\n```shell\n--01)directory\ncreate directory itpuxbak_dir as '/backup';\n--drop directory itpuxbak_dir\nselect * from dba_directories\ngrant read,write on directory itpuxbak_dir to system; --system:itpux01:other users\ngrant create any directory to system;\nselect * from dba_sys_privs where grantee='SYSTEM';\n\n--02) sysdba full=y\nexpdp \"'/as sysdba'\" directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y --sys\n\n--03)查询datapump jobs\nselect * from dba_datapump_jobs;\nexpdp \"'/as sysdba'\" directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y job_name=itpuxexpjob;\n```\n\n## 4.配置生产环境的逻辑自动备份策略\n>每天做逻辑备份，数据量大小500G，保留2天，空间准备2TB\n我的库不开归档的，不能在线做RMAN。\n```shell\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant create any directory to system;\n\n#vi expdpfull_db01.sh\nexport BAKDATE=`date +%Y%m%d`\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.$BAKDATE.%U.dmp logfile=expdp_full_db01.$BAKDATE.log full=y parallel=4\nfind /backup -name expdp_full_db01.*.dmp -atime +2 -exec rm -rf {} \\;\n\n#--cluster=N\n#chown -R oracle:dba /backup\n#chmod -R 775 /backup\n#crontab -e\n0 20 * * * su - oracle -c /backup/scripts/expdpfull_db01.sh\n```\n* --报错的处理：\n```shell\nORA-39181: Only partial table data may be exported due to fine grain access control on \"OE\".\"PURCHASEORDER\"\nselect count(*) from \"OE\".\"PURCHASEORDER\"\ngrant EXEMPT ACCESS POLICY to system;\nexpdp system/oracle directory=itpuxbak_dir dumpfile=test-b.dmp logfile=test-b.log tables=OE.PURCHASEORDER\n```\n\n## 5.expdp/impdp生产环境数据迁移流程\n* 5.1、做数据迁移流程的目的\n>使用expdp/impdp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n\n* 5.2、数据迁移的适用范围\n>所有线上库>10.2\n\n* 5.3、 数据迁移的风险评估\n>01.有些os对文件大小有限制，expdp数据时需要使用filesize参数来分割导出文件\n02.expdp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n03.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n04.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n\n* 5.4、数据迁移的准备工作\n>01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用expdp/impdp迁移数据。\n02.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。\n03.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\n04.提前准备备份脚本（parfile参数）：\n```shell\ncat expdp_itpux.par\nuserid=system/oracle\ndirectory=itpuxbak_dir\ndumpfile=expdp_full_db01.$BAKDATE.%U.dmp\nlogfile=expdp_full_db01.$BAKDATE.log\ntables=user.tab1,user.tab2,user.tab3\nparallel=4\n\nvi expdp.sh\n\nexport BAKDATE=`date +%Y%m%d`\nexpdp parfile=expdp_itpux.par\nnohup ./expdp.sh &\n```\n\n* 5.5、数据迁移的执行过程\n\n\n* 5.6、数据迁移后的验证方案\n>对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n编译无效对象\n\n\n## 6.expdp/impdp生产环境数据迁移案例\n>迁移过程详细请看视频演示，此处只做参考\n### 6.1 迁移目的\n>将linux系统oracle服务器上schema（itpux01,itpux02）全部通过ExpDP全库迁移到另一台oracle服务器，并能正常查询到相关数据。\n>IMPDP虽然加上parallel参数，在做table数据导入时确实速度提高了不少，但是在create index和statistics时，依旧采用单线程的方式，故此一般在迁移过程中这两步操作选择生产DDL脚本增加parallel参数后手工执行，以最大化缩减迁移时间。\n### 6.2 迁移流程\n```sql\n1.linux系统oracle服务器上创建测试数据。\n2.linux本地用Expdp做导出;\n3.远程主机创建相关对象；\n4.远程主机用expdp做导入(导入);\n5.验证远程本地数据合法性;\n```\n### 6.3 演示过程\n* 01.准备数据\n```sql\n/* Formatted on 2018/1/30 21:28:32 (QP5 v5.313) */\nCREATE TABLESPACE itpux11\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE itpux12\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n--创建用户并授权\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n\n--用户登录并创建测试表\nCONN itpux01 / itpux01\n\nCREATE TABLE itpux01\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\nCONN itpux02 / itpux02\n\nCREATE TABLE itpux02\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\n--要建两个索引\n\nCREATE INDEX itpux02\n    ON itpux02_table_test (id);\n\n--创建2个存储过程并执行。\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\nEND p_itpux01;\n/\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n```\n* 查询验证数据\n```sql\n/* Formatted on 2018/1/30 21:31:51 (QP5 v5.313) */\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id > 1990;\n\n--02.获取DDL\n--在源主机获取：\nSPOOL itpux_tbs_create_ddl.sql\nSET LONG 200000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 200\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX02') FROM DUAL;\n\nSPOOL OFF;\n--在另一台主机执行：\nCREATE TABLESPACE \"ITPUX01\"\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE \"ITPUX02\"\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\n--03、源库导出\n建立目录（建立directory）\nSQL> CREATE OR REPLACE DIRECTORY oradmp AS '/oracle/backup';\nSQL> GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\nexpdp SYSTEM/oracle DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=expdpfull_db01.LOG PARALLEL=2;\n--04、目标库导入\n禁止自动维护任务\n（禁用数据库自动维护任务，oracle11g中存在）\nSQL> EXECUTE DBMS_AUTO_TASK_ADMIN.DISABLE;\n建立目录（建立directory）\nSQL> CREATE OR REPLACE DIRECTORY oradmp AS '/oracle/backup';\nSQL> GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\n生成index、CONSTRAINT的ddl语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp dumpfile=itpux_01.dmp,itpux_02.dmp LOGFILE=impitpux.LOG PARALLEL=2 SQLFILE=indconddl.SQL INCLUDE=INDEX,CONSTRAINT SCHEMAS=itpux\n编辑ddl语句脚本\nsed 's/NOLOGGING/ /g;s/LOGGING/ /g' indconddl.SQL>indconddl.sql.nologin\nsed '/TABLESPACE/ s/TS_itpux/TS_itpux_INDEX/g;/TABLESPACE/ s/1/32 NOLOGGING/g' indconddl.sql.nologin>indconddl.sql.NEW\n设置parallel 4;\n执行导入语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=impdpfull_db01.LOG PARALLEL=2\nEXCLUDE=INDEX,CONSTRAINT,STATISTICS SCHEMAS=ITPUX;\n检查job，延后迁移时间内发起的job任务\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n执行ddl语句脚本，建立索引、约束，手工发起统计分析\n建立索引、约束\nchmod +x indconddl.sql.NEW\n more createindcon.sh\nSQLPLUS -s /nolog <<EOS\nCONNECT itpux / itpux\nSPOOL /tmp/indconcreate.log\n@ /oracle/backup/indconddl.sql.new;\nSPOOL OFF\nEXIT\nEOS\n执行createindcon.sh\n然后再改parallel 4;为NOPARALLEL\n--05、收集统计信息\nstats.SQL:\n\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nnohup sqlplus \"/as sysdba\" @ stats.SQL &\n--06、无效对象的编译\n自动生成编译无效对象SQL及编译过程\n1) 统计当前用户无效对象数量:\n  SELECT OWNER,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY OWNER, object_type, status\nORDER BY OWNER, object_type;\n2) 生成编译无效对象SQL\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n# su - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/ADMIN/utlrp.SQL\n--07、验证数据\n对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n\nSELECT COUNT (*) FROM itpux.itpux01;\n\nSQL>SELECT OWNER,OBJECT_TYPE,COUNT(*) FROM dba_objects WHERE wner='&owner' GROUP BY OWNER,OBJECT_TYPE ORDER BY OBJECT_TYPE;\n跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n检查对象状态\nSQL>SELECT OWNER,OBJECT_NAME,SUBOBJECT_NAME,STATUS,OBJECT_TYPE FROM dba_objects WHERE wner='&owner' ORDER BY OBJECT_TYPE, OBJECT_NAME, SUBOBJECT_NAME;\n\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status <> 'VALID' AND owner = 'ITPUX01';\n\n--08、收尾\n启用数据库自动维护任务\nSQL> EXECUTE DBMS_AUTO_TASK_ADMIN.ENABLE;\n检查并更正job运行时间\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n--09、对外应用测试\n```\n\n## 7.expdp/impdp迁移过程字符集的处理\n>进行数据的导入导出时，我们要注意关于字符集的问题。在EXPDP/IMPDP过程中我们需要注意四个字符集的参数：\n```sql\n01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n05.导入端数据库字符集。\n```\n* 查看数据库的字符集的信息\n```sql\nSQL> select * from nls_database_parameters;\n//SQL> select * from props$;\nNLS_LANGUAGE AMERICAN\nNLS_TERRITORY AMERICA\nNLS_CURRENCY $\nNLS_ISO_CURRENCY AMERICA\nNLS_NUMERIC_CHARACTERS .,\nNLS_CHARACTERSET ZHS16GBK\nNLS_CALENDAR GREGORIAN\nNLS_DATE_FORMAT DD-MON-RR\nNLS_DATE_LANGUAGE AMERICAN\nNLS_SORT BINARY\nNLS_TIME_FORMAT HH.MI.SSXFF AM\nNLS_TIMESTAMP_FORMAT DD-MON-RR HH.MI.SSXFF AM\nNLS_TIME_TZ_FORMAT HH.MI.SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT DD-MON-RR HH.MI.SSXFF AM TZR\nNLS_DUAL_CURRENCY $\nNLS_COMP BINARY\nNLS_LENGTH_SEMANTICS BYTE\nNLS_NCHAR_CONV_EXCP FALSE\nNLS_NCHAR_CHARACTERSET AL16UTF16\nNLS_RDBMS_VERSION 11.2.0.3.0\n```\n\n* 我们再来查看客户端的字符集信息\n```shell\n客户端字符集的参数NLS_LANG=_< territory >.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n如数据库语言环境\nos是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\nos是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n永久修改可用：\nvi bash_profile\n通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n```\n>(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n(2) 源数据库和目标数据库字符集不同。\n先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n\n## 8.expdp与impdp 版本兼容性与各版本的区别\n参考资料：\nhttp://www.itpux.com/thread-288-1-1.html\n## 9.如何停止expdp与impdp备份任务的后台进程\n参考资料：\nhttp://www.itpux.com/thread-286-1-1.html\n## 10.如何清理不需要的数据泵job\n参考资料：\nhttp://www.itpux.com/thread-287-1-1.html\n## 11.如何对expdp/impdp进行trace跟踪分析问题\n### 11.1 使用Trace 480300\n>&emsp;&emsp;Data Pump工作原理有两个特点：作业调度，多进程配合协作。对Data Pump的诊断本质上就是对各种Process行为的跟踪。Oracle提供了一个Trace的隐含参数，来帮助我们实现这个目标。\n>&emsp;&emsp;Trace并不像其他跟踪过程相同，使用y/n的参数，开启或者关闭。Data Pump的Trace参数是一个7位十六进制组成的数字串。不同的数字串表示不同的跟踪对象方法。7位十六进制数字分为两个部分，前三个数字表示特定的数据泵组件，后四位使用0300就可以。\n\n* 各个组件分别使用不同的三位十六进制数字代表。如下片段所示\n```shell\n-- Summary of Data Pump trace levels:\n-- ==================================\nTrace DM DW ORA Lines\nlevel trc trc trc in\n(hex) file file file trace Purpose\n------- ---- ---- ---- ------ -----------------------------------------------\n10300 x x x SHDW: To trace the Shadow process (API) (expdp/impdp)\n20300 x x x KUPV: To trace Fixed table\n40300 x x x 'div' To trace Process services\n80300 x KUPM: To trace Master Control Process (MCP) (DM)\n100300 x x KUPF: To trace File Manager\n200300 x x x KUPC: To trace Queue services\n400300 x KUPW: To trace Worker process(es) (DW)\n800300 x KUPD: To trace Data Package\n1000300 x META. To trace Metadata Package\n--- +\n1FF0300 x x x 'all' To trace all components (full tracing)\n```\n>如果需要同时跟踪多个组件，需要将目标组件的hex值进行累加，后面四位的300相同。\n>400300+80300=480300\n>&emsp;&emsp;对于跟踪的Trace取值，Oracle建议使用480300就可以应对大部分的情况。480300会跟踪Oracle Dump作业的Master Control Process（MCP）和Work Process。作为初始化跟踪的过程，480300基本就够用了。\n>我们先从数据导出Expdp看Trace，导出一个案例。首先清理一下Trace File目录\n```sql\nexpdp \\\"/ as sysdba\\\" directory=dumpdir schemas=itpux dumpfile=itpux_dump.dmp parallel=2 trace=480300\n```\n>&emsp;&emsp;然后检查trc目录，Dm和dw标注的就是MCP和Work Process生成的Trace文件。同时Parallel设置使得dw有00和01两个。\n>2个trace 文件在BACKGROUND_DUMP_DEST目录下：\n```sql\nMaster Process trace file: <SID>_dm<number>_<process_id>.trc\nWorker Process trace file: <SID>_dw<number>_<process_id>.trc\n```\n>在导出过程中，我们可以看到两个worker的会话信息。\n```sql\nSQL> select * from dba_datapump_sessions;\nOWNER_NAME JOB_NAME INST_ID SADDR SESSION_TYPE\n------------------------------ ------------------------------ ---------- -------- --------------\nSYS SYS_EXPORT_SCHEMA_01 1 35EB0580 DBMS_DATAPUMP\nSYS SYS_EXPORT_SCHEMA_01 1 35E95280 MASTER\nSYS SYS_EXPORT_SCHEMA_01 1 35E8A480 WORKER\nSYS SYS_EXPORT_SCHEMA_01 1 35E84D80 WORKER\n```\n>&emsp;&emsp;此时我们可以从Trace文件中，看到一些Data Pump工作的细节信息。例如：在MCP的Trace文件中，我们看到一系列调用动作过程，如下片段：\n--初始化导出动作，整理文件系统；\n-日志写入\n在Worker Process中，如下片段看出在导出数据。\n### 11.2 使用Trace 480301\n>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。\n```sql\nimpdp \\\"/ as sysdba\\\" directory=dumpdir dumpfile=itpux_dump.dmp remap_schema=itpux:test trace=480301 parallel=2\n```\n>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。我们使用导入过程进行实验。\n>&emsp;&emsp;目录生成的Trace文件，都是10046格式的Raw文件。截取片段如下：\n10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux__dw01_17294.out waits=y sort=exeela\n```\n\n### 11.3.使用10046事件\n* 10046 事件有如下级别\n```shell\nevent 10046, level 1 = enable standardSQL_TRACE functionality\nevent 10046, level 4 = as level 1, plus trace the BIND values\nevent 10046, level 8 = as level 1, plus trace the WAITs\nevent 10046, level 12 = as level 1, plus trace the BIND values and the WAITs\n```\n* 不同级别的使用情况如下\n```shell\nlevel 1: lowest level tracing - not alwayssufficient to determine cause of errors;\nlevel 4: useful when an error in DataPump's worker or master process occurs;\nlevel 12: useful when there is an issuewith Data Pump performance.\n```\n* 注意：\n>&emsp;&emsp; 当我们设置10046的级别高于8或者12的时候，需要将TIMED_STATISTICS设置为TRUE. 临时的将这个参数设置为true，可以将trace数据性能的影响降到最低，在11gR2里，该参数默认为true。\n>一般只有遇到性能问题时，才会使用8或者12的level。\n\n### 11.4 日常使用\n* 01、对当前正在运行的进程进行trace\n```sql\n\n--查看数据泵进程的信息：\nSET LINES 150 PAGES 100 NUMWIDTH 7\nCOL username FOR a10\nCOL spid FOR a7\nCOL program FOR a25\n\nSELECT TO_CHAR (SYSDATE, 'YYYY-MM-DDHH24:MI:SS') \"DATE\",\n       s.program,\n       s.sid,\n       s.status,\n       s.username,\n       d.job_name,\n       p.spid,\n       s.serial#,\n       p.pid\n  FROM v$session s, v$process p, dba_datapump_sessions d\n WHERE p.addr = s.paddr\n ands.saddr=d.saddr;\n```\n>使用sys.dbms_system.set_ev设置10046\n>在上节的查询结果里：\nData Pump Master process (DM00)的SID 是58，serial#是85.\nData Pump Worker process (DW01)的SID 是23，serial#是311.\n\n>使用10046 跟踪活动session的语法如下\n```sql\nSyntax: DBMS_SYSTEM.SET_EV([SID],[SERIAL#],[EVENT],[LEVEL],'')\n\n--在level 4跟踪Worker process进程(Bind values)：\nexecute sys.dbms_system.set_ev(23,311,10046,4,'');\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(23,311,10046,0,'');\n\n--在level 8 跟踪Master进程（Waits）：\nexecute sys.dbms_system.set_ev(143,50,10046,8,'');\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(143,50,10046,0,'');\n```\n* 02、使用oradebug\n>可以在oradebug中设置SPID，来进行trace\n```sql\n--在level 4跟踪Worker process进程(Bind values)：\noradebug setospid 8173\noradebug unlimit\noradebug event 10046 trace name context forever, level 4\noradebug tracefile_name\n\n--在level 8 跟踪Master进程（Waits）：\noradebug setospid 8171\noradebug unlimit\noradebug event 10046 trace name context forever, level 8\noradebug tracefile_name\n\n--stop tracing:\noradebug event 10046 trace name context off ITPUX\n```\n\n* 03、使用tkprof 分析trace文件\n>10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux_dw01_17294.out waits=y sort=exeela\n```\n\n\n## 12.expdp/impdp使用总结\n\n* 1.expdp/impdp 默认就是使用直接路径的，所以速度比较快，但是expdp/impdp 是服务端程序，影响它速度的只有磁盘io。\n* 2.导出多表时，expdp/impdp用法是tables='table1','table2','table3'。\n* 3.dumpfile 参数 ，可以用%u 指定多个数据文件\n```sql\nexpdp xxx/xxx schemas=xxx directory=dump1 dumpfile=xxx_%u.dmp filesize=50g\n```\n>这样每个文件50g ，xxx_01.dump,xxx_02.dump 这样。\n* 4.如果要把用户usera的对象导到用户userb，操作如下：\n```shell\nimpdp system/passwd directory=expdp dumpfile=expdp.dmp remap_schema='usera':'userb' logfile=/oracle/exp.log;\n```\n* 5.如果导入需要更换表空间，impdp用remap_tablespace='tabspace_old':'tablespace_new'\n\n* 6.关于数据导出时要导出哪些内容\n>expdp content（all:对象＋导出数据行，data_only：只导出对象，metadata_only：只导出数据的记录）\n* 7、数据泵expdp/impdp 影响速度和性能最大的就是paralle。 所以使用数据泵，要想提高速度，就要设置并行参数。如：\n>&emsp;&emsp; expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4\n那么expdp将为parallel 创建4个文件： test_01.dmp，test_02.dmp，test_03.dmp，test_04.dmp。 每个进程一个文件。 这样的话，每个文件的大小会因进程而不同。 可以某个文件很大，某个文件却很小。 要解决这个问题，就是设置filesize 参数。 来指定每个文件的最大值。 这样当一个文件达到最大值的之后，就会创建一个新的文件。\n\n>&emsp;&emsp;如：expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4 filesize=50m\n导出的dump文件和paralle有关系，那么导入也有关系。 paralle要小于dump文件数。 如果paralle 大于dump文件的个数，就会因为超过的那个进程获取不到文件，就不能对性能提高。一般parall 参数值等于cpu 的个数。而且要小于dump文件的个数。","slug":"oracle/Oracle数据库逻辑备份恢复迁移之expdp与impdp","published":1,"updated":"2019-05-03T15:54:40.531Z","_id":"cjv89bjfw002li0cd8edkr8ui","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle数据库逻辑备份恢复迁移之expdp与impdp\"><a href=\"#Oracle数据库逻辑备份恢复迁移之expdp与impdp\" class=\"headerlink\" title=\"Oracle数据库逻辑备份恢复迁移之expdp与impdp\"></a>Oracle数据库逻辑备份恢复迁移之expdp与impdp</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p>[Oracle 11G R2 官方文档][1]</p>\n<h2 id=\"1-Oracle数据泵expdp-impdp概念\"><a href=\"#1-Oracle数据泵expdp-impdp概念\" class=\"headerlink\" title=\"1.Oracle数据泵expdp/impdp概念\"></a>1.Oracle数据泵expdp/impdp概念</h2><ul>\n<li>Oracle Database 10g引入了最新的数据泵(Data Dump)技术，数据泵导出导入(EXPDP和IMPDP)的作用<blockquote>\n<p>1）实现逻辑备份和逻辑恢复.<br>2）在数据库用户之间移动对象.<br>3）在数据库之间移动对象<br>4）实现表空间搬移.</p>\n</blockquote>\n</li>\n<li><p>数据泵导出导入与传统导出导入的区别</p>\n<blockquote>\n<p>&emsp;&emsp;在10g之前,传统的导出和导入分别使用exp工具和imp工具,从10g开始,不仅保留了原有的exp和imp工具,还提供了数据泵导出导入工具expdp和impdp.使用expdp和impdp时应该注意的事项：<br>1）exp和imp是客户端工具程序,它们既可以在可以客户端使用,也可以在服务端使用。<br>2）expdp和impdp是服务端的工具程序,他们只能在oracle服务端使用,不能在客户端使用。<br>3）imp只适用于exp导出文件,不适用于expdp导出文件;impdp只适用于expdp导出文件,而不适用于exp导出文件。</p>\n</blockquote>\n</li>\n<li><p>数据泵导出包括导出表,导出方案,导出表空间,导出数据库4种方式.</p>\n</li>\n<li><p>oracle数据泵的工作流程如下</p>\n<blockquote>\n<p>1、在命令行执行命令<br>2、expdp/impdp命令调用dbms_datapump pl/sql包。 这个api提供高速的导出导入功能。<br>3、 当data 移动的时候， data pump 会自动选择direct path 或者external table mechanism 或者 两种结合的方式。<br>&emsp;&emsp;当metadata（对象定义） 移动的时候，data pump会使用dbms_metadata pl/sql包。 metadata api 将metadata（对象定义）存储在xml里。所有的进程都能load 和unload 这些metadata. 因为data pump 调用的是服务端的api, 所以当一个任务被调度或执行，客户端就可以退出连接，任务job 会在server 端继续执行，随后通过客户端实用程序从任何地方检查任务的状态和进行修改。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"2-expdp-impdp-命令参数详解\"><a href=\"#2-expdp-impdp-命令参数详解\" class=\"headerlink\" title=\"2.expdp/impdp 命令参数详解\"></a>2.expdp/impdp 命令参数详解</h2><h3 id=\"2-1关于expdp\"><a href=\"#2-1关于expdp\" class=\"headerlink\" title=\"2.1关于expdp\"></a>2.1关于expdp</h3><pre class=\" language-shell\"><code class=\"language-shell\">[oracle@db01:/home/oracle]$expdp -help\nExport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:30 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump export utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: expdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Export runs by entering the 'expdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: expdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: expdp scott/tiger DUMPFILE=scott.dmp DIRECTORY=dmpdir SCHEMAS=scott\nor TABLES=(T1:P1,T1:P2), if T1 is partitioned table\nUSERID must be the first parameter on the command line.\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\n\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\n\n该选项用于在客户会话与已存在导出作用之间建立关联.语法如下\nattach=[schema_name.]job_name\nschema_name用于指定方案名,job_name用于指定导出作业名.注意,如果使用attach选项,在命令行除了连接字符串和attach选项外,不能指定任何其他选项,示例如下:\nexpdp scott/tiger attach=scott.export_job\n\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\n而在11GR2后EXPDP和IMDP的WORKER进程会在多个INSTANCE启动，所以DIRECTORY必须在共享磁盘上，如果没有设置共享磁盘还是指定cluster=no来防止报错\n\nCOMPRESSION\nReduce the size of a dump file.\nValid keyword values are: ALL, DATA_ONLY, [METADATA_ONLY] and NONE.\n这个压缩比例可以和操作系统“gzip -9”相媲美，某些特例下有可能比gzip还要高效：1/7。\n10g中的COMPRESSION参数只提供METADATA_ONLY和NONE两个选项，基本上没有提供压缩功能。\n11g中的COMPRESSION参数提供四个选项，分别是ALL、DATA_ONLY、METADATA_ONLY和NONE，非常的丰富，稍后我们将使用ALL参数进行操作。\n\nOracle 11g的EXPDP工具提供了真正意义上的“备份压缩”，这个技术在备份空间不足的情况下非常实用。all 压缩元数据和对象数据 data_only 只压缩对象数据 metadata_only 只压缩元数据 none 不压缩任何数据。\n\nCONTENT\nSpecifies data to unload.\nValid keyword values are: [ALL], DATA_ONLY and METADATA_ONLY.\n该选项用于指定要导出的内容.默认值为all\ncontent={all | data_only | metadata_only}\n当设置content为all 时,将导出对象定义及其所有数据.为data_only时,只导出对象数据,为metadata_only时,只导出对象定义。\nexpdp scott/tiger directory=dump dumpfile=a.dump content=metadata_only\n\nDATA_OPTIONS\nData layer option flags.\nValid keyword values are: XML_CLOBS.\n用于为某些类型的数据提供选项\n\nDIRECTORY\nDirectory object to be used for dump and log files.\n指定转储文件和日志文件所在的目录，directory=directory_object\ndirectory_object用于指定目录对象名称.需要注意,目录对象是使用create directory语句建立的对象,而不是os 目录。\n\nexpdp scott/tiger directory=dump dumpfile=a.dump\n先在对应的位置创建物理文件夹，如d:/backup\n建立目录:\ncreate or replace directory backup as '/opt/oracle/utl_file'\nsql>create directory backup as ‘d:/backup’;\nsql>grant read,write on directory backup to system;\n查询创建了那些子目录:\nselect * from dba_directories;\n\nDUMPFILE\nSpecify list of destination dump file names [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\n用于指定转储文件的名称,默认名称为expdat.dmp\ndumpfile=[directory_object:]file_name [,….]\ndirectory_object用于指定目录对象名,file_name用于指定转储文件名.需要注意,如果不指定directory_object,导出工具会自动使用directory选项指定的目录对象：expdp scott/tiger directory=dump1 dumpfile=dump2:a.dmp\n\nENCRYPTION\nEncrypt part or all of a dump file.\nValid keyword values are: ALL, DATA_ONLY, ENCRYPTED_COLUMNS_ONLY, METADATA_ONLY and NONE.\n是否加密导出数据 默认none\nencryption={all | data_only |metadata_only | encrypted_columns_only | none}\nall 对象和元数据 data_only 对象加密 metadata_only 元数据加密 encryption_columns_only 只加密加密列 none 不加密\n\nENCRYPTION_ALGORITHM\nSpecify how encryption should be done.\nValid keyword values are: [AES128], AES192 and AES256.\n加密算法 默认aes128\nencryption_algorithm= {aes128 | aes 192 | aes 256}\n\nENCRYPTION_MODE\nMethod of generating encryption key.\nValid keyword values are: DUAL, PASSWORD and [TRANSPARENT].\n加密和解密所使用的安全类型\nencryption_mode={dual | password |transparent }\ndual 表示用 oracle wallet 或指定口令建立导出文件password 指定口令建立导出文件 transparent oracle wallet建立导出文件\n\nENCRYPTION_PASSWORD\nPassword key for creating encrypted data within a dump file.\n指定加密和解密口令 encryption_password=password\n\nESTIMATE\nCalculate job estimates.\nValid keyword values are: [BLOCKS] and STATISTICS.\n指定估算被导出表所占用磁盘空间分方法.默认值是blocks。\nextimate={blocks | statistics}\n设置为blocks时,oracle会按照目标对象所占用的数据块个数乘以数据块尺寸估算对象占用的空间,设置为statistics时,根据最近统计值估算对象占用空间: expdp scott/tiger tables=emp estimate=statistics directory=dump dumpfile=a.dump\n\nESTIMATE_ONLY\nCalculate job estimates without performing the export.\n指定是否只估算导出作业所占用的磁盘空间,默认值为n\nextimate_only={y | n}\n设置为y时,导出作用只估算对象所占用的磁盘空间,而不会执行导出作业,为n时,不仅估算对象所占用的磁盘空间,还会执行导出操作.\nexpdp scott/tiger estimate_only=y nologfile=y\n\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\n该选项用于指定执行操作时释放要排除对象类型或相关对象 ITPUX\n\nexclude=object_type[:name_clause] [,….]\nobject_type用于指定要排除的对象类型,name_clause用于指定要排除的具体对象.exclude和include不能同时使用。\nexpdp scott/tiger directory=dump dumpfile=a.dup exclude=view\nFILESIZE\nSpecify the size of each dump file in units of bytes.\n指定导出文件的最大尺寸,默认为0,(表示文件尺寸没有限制)\nFLASHBACK_SCN\nSCN used to reset session snapshot.\n指定导出特定scn时刻的表数据。flashback_scn=scn_value\nscn_value用于标识scn值.flashback_scn和flashback_time不能同时使用： expdp\nscott/tiger directory=dump dumpfile=a.dmp flashback_scn=358523\n\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\n指定导出特定时间点的表数据\nflashback_time=”to_timestamp(time_value)”\nexpdp scott/tiger directory=dump dumpfile=a.dmp flashback_time= “to_timestamp(’25-08-2004 14:35:00’,’dd-mm-yyyy hh24:mi:ss’)”\n\nFULL\nExport entire database [N].\n指定数据库模式导出,默认为n。 full={y | n} 。为y时,标识执行数据库导出.\nHELP\nDisplay Help messages [N].\n指定是否显示expdp命令行选项的帮助信息,默认为n。当设置为y时,会显示导出选项的帮助信息. expdp help=y\n\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\n指定导出时要包含的对象类型及相关对象。include = object_type[:name_clause] [,… ]\n\nJOB_NAME\nName of export job to create.\n指定要导出作用的名称,默认为sys_xxx 。job_name=jobname_string\n\nLOGFILE\nSpecify log file name [export.log].\n指定导出日志文件文件的名称,默认名称为export.log\nlogfile=[directory_object:]file_name\ndirectory_object用于指定目录对象名称,file_name用于指定导出日志文件名.如果不指定directory_object.导出作用会自动使用directory的相应选项值.\nexpdp scott/tiger directory=dump dumpfile=a.dmp logfile=a.log\n\nNETWORK_LINK\nName of remote database link to the source system.\n指定数据库链接名,如果要将远程数据库对象导出到本地例程的转储文件中,必须设置该选项.\n\nNOLOGFILE\nDo not write log file [N].\n该选项用于指定禁止生成导出日志文件,默认值为n.\n\nPARALLEL\nChange the number of active workers for current job.\n指定执行导出操作的并行进程个数,默认值为1\n一般是cpu的2倍，可以被文件个数整除\n\nPARFILE\nSpecify parameter file name.\n指定导出参数文件的名称。parfile=[directory_path] file_name\n\nQUERY\nPredicate clause used to export a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\n用于指定过滤导出数据的where条件\nquery=[schema.] [table_name:] query_clause\nschema用于指定方案名,table_name用于指定表名,query_clause用于指定条件限制子句.query选项不能与connect=metadata_only,extimate_only,transport_tablespaces等选项同时使用.\nexpdp scott/tiger directory=dump dumpfiel=a.dmp tables=emp query=’where deptno=20’\n\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\n用于转换列的数据函数， 并将转换值导出到文件中\nremap_data=[schema1.]tablename.column_name:[schema2.]pkg.func\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n覆盖已处在的导出文件，默认N\n\nSAMPLE\nPercentage of data to be exported.\n用于指定被采样数据块的百分比\nsample=[[schema_name.]table_name:]sample_percent (采用比率)\n\nSCHEMAS\nList of schemas to export [login schema].\n该方案用于指定执行方案模式导出,默认为当前用户方案.\n\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\n\nSOURCE_EDITION\nEdition to be used for extracting metadata.\n用于提取源数据的版本\n\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n指定显示导出作用进程的详细状态,默认值为0\n\nTABLES\nIdentifies a list of tables to export.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\n指定表模式导出\ntables=[schema_name.]table_name[:partition_name][,…]\nschema_name用于指定方案名,table_name用于指定导出的表名,partition_name用于指定要导出的分区名.\n\nTABLESPACES\nIdentifies a list of tablespaces to export.\n指定要导出表空间列表\n\nTRANSPORTABLE\nSpecify whether transportable method can be used.\nValid keyword values are: ALWAYS and [NEVER].\n指定是否可以使用可传输方法\n\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\n    该选项用于指定被搬移表空间和未搬移表空间关联关系的检查方式,默认为n. 当设置为y时,导出作用会检查表空间直接的完整关联关系,如果表空间所在表空间或其索引所在的表空间只有一个表空间被搬移,将显示错误信息.当设置为n时,导出作用只检查单端依赖,如果搬移索引所在表空间,但未搬移表所在表空间,将显示出错信息,如果搬移表所在表空间,未搬移索引所在表空间,则不会显示错误信息.\n\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be unloaded.\n指定执行表空间模式导出 ，用于指定搬移的的表空间\nVERSION\nVersion of objects to export.\nValid keyword values are: [COMPATIBLE], LATEST or any valid database version.\n用于指定被导出对象的数据库版本 默认 compatible\nversion={compatable | latest |version_string}\ncompatible 根据compatible参数生成对象 latest 根据数据库的实际版本 version_string 指定数据库版本（>9.2）\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nADD_FILE\nAdd dumpfile to dumpfile set. \n\n向转储文件集中添加转储文件\n\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\n返回到记录模式。如果处于空闲状态, 将重新启动作业。\n\nEXIT_CLIENT\nQuit client session and leave job running.\n退出客户机会话并使作业处于运行状态\n\nFILESIZE\nDefault filesize (bytes) for subsequent ADD_FILE commands.\n后续 ADD_FILE 命令的默认文件大小 (字节)。\n\nHELP\nSummarize interactive commands.\n总结交互命令。\n\nKILL_JOB\nDetach and delete job.\n分离和删除作业\nPARALLEL\nChange the number of active workers for current job.\n更改当前作业的活动 worker 的数目。\n\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n是否覆盖dumpfiles\n\nSTART_JOB\nStart or resume current job.\n\nValid keyword values are: SKIP_CURRENT.\n启动/恢复当前作业。\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n在默认值 (0) 将显示可用时的新状态的情况下,要监视的频率 (以秒计) 作业状态。\nSTATUS[=interval]\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keyword values are: IMMEDIATE.\n顺序关闭执行的作业并退出客户机。STOP_JOB=IMMEDIATE 将立即关闭数据泵作业。\n</code></pre>\n<h2 id=\"2-2-关于impdp\"><a href=\"#2-2-关于impdp\" class=\"headerlink\" title=\"2.2 关于impdp\"></a>2.2 关于impdp</h2><pre class=\" language-shell\"><code class=\"language-shell\">[oracle@db01:/home/oracle]$impdp -help\nImport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:43 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump Import utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Import runs by entering the 'impdp' command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: impdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nUSERID must be the first parameter on the command line.\n------------------------------------------------------------------------------\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\nCONTENT\nSpecifies data to load.\nValid keywords are: [ALL], DATA_ONLY and METADATA_ONLY.\nDATA_OPTIONS\nData layer option flags.\nValid keywords are: SKIP_CONSTRAINT_ERRORS.\nDIRECTORY\nDirectory object to be used for dump, log and SQL files.\nDUMPFILE\nList of dump files to import from [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\nENCRYPTION_PASSWORD\nPassword key for accessing encrypted data within a dump file.\nNot valid for network import jobs.\nESTIMATE\nCalculate job estimates.\nValid keywords are: [BLOCKS] and STATISTICS.\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:\"='HR'\".\nFLASHBACK_SCN\nSCN used to reset session snapshot.\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\nFULL\nImport everything from source [Y].\nHELP\nDisplay help messages [N].\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\nJOB_NAME\nName of import job to create.\nLOGFILE\nLog file name [import.log].\nNETWORK_LINK\nName of remote database link to the source system.\nNOLOGFILE\nDo not write log file [N].\nPARALLEL\nChange the number of active workers for current job.\nPARFILE\nSpecify parameter file.\nPARTITION_OPTIONS\nSpecify how partitions should be transformed.\nValid keywords are: DEPARTITION, MERGE and [NONE].\nQUERY\nPredicate clause used to import a subset of a table.\nFor example, QUERY=employees:\"WHERE department_id > 10\".\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\nREMAP_DATAFILE\nRedefine data file references in all DDL statements.\nREMAP_SCHEMA\nObjects from one schema are loaded into another schema.\nREMAP_TABLE\nTable names are remapped to another table.\nFor example, REMAP_TABLE=HR.EMPLOYEES:EMPS.\nREMAP_TABLESPACE\nTablespace objects are remapped to another tablespace.\nREUSE_DATAFILES\nTablespace will be initialized if it already exists [N].\nSCHEMAS\nList of schemas to import.\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\nSKIP_UNUSABLE_INDEXES\nSkip indexes that were set to the Index Unusable state.\nSOURCE_EDITION\nEdition to be used for extracting metadata.\nSQLFILE\nWrite all the SQL DDL to a specified file.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTREAMS_CONFIGURATION\nEnable the loading of Streams metadata\nTABLE_EXISTS_ACTION\nAction to take if imported object already exists.\nValid keywords are: APPEND, REPLACE, [SKIP] and TRUNCATE.\nTABLES\nIdentifies a list of tables to import.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\nTABLESPACES\nIdentifies a list of tablespaces to import.\nTARGET_EDITION\nEdition to be used for loading metadata.\nTRANSFORM\nMetadata transform to apply to applicable objects.\nValid keywords are: OID, PCTSPACE, SEGMENT_ATTRIBUTES and STORAGE.\nTRANSPORTABLE\nOptions for choosing transportable data movement.\nValid keywords are: ALWAYS and [NEVER].\nOnly valid in NETWORK_LINK mode import operations.\nTRANSPORT_DATAFILES\nList of data files to be imported by transportable mode.\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be loaded.\nOnly valid in NETWORK_LINK mode import operations.\nVERSION\nVersion of objects to import.\nValid keywords are: [COMPATIBLE], LATEST or any valid database version.\nOnly valid for NETWORK_LINK and SQLFILE.\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\nEXIT_CLIENT\nQuit client session and leave job running.\nHELP\nSummarize interactive commands.\nKILL_JOB\nDetach and delete job.\nPARALLEL\nChange the number of active workers for current job.\nSTART_JOB\nStart or resume current job.\nValid keywords are: SKIP_CURRENT.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keywords are: IMMEDIATE.\n\n其实IMPDP命令行选项与EXPDP有很多相同的,下面我们只介绍不同的部分：\n（1）REMAP_DATAFILE\n该选项用于将源数据文件名转变为目标数据文件名,在不同平台之间搬移表空间时可能需要该选项.\nREMAP_DATAFIEL=source_datafie:target_datafile\n\n（2）REMAP_SCHEMA\n该选项用于将源方案的所有对象装载到目标方案中.\nREMAP_SCHEMA=source_schema:target_schema\n\n（3）REMAP_TABLESPACE\n将源表空间的所有对象导入到目标表空间中\nREMAP_TABLESPACE=source_tablespace:target_tablespace\n\n（4）REUSE_DATAFILES\n该选项指定建立表空间时是否覆盖已存在的数据文件.默认为N。\nREUSE_DATAFIELS={Y | N}\n\n（5）SKIP_UNUSABLE_INDEXES\n指定导入是是否跳过不可使用的索引,默认为N\n\n（6）SQLFILE\n指定将导入要指定的索引DDL操作写入到SQL脚本中。\nSQLFILE=[directory_object:]file_name\nImpdp scott/tiger DIRECTORY=dump DUMPFILE=tab.dmp SQLFILE=a.sql\n\n（7）STREAMS_CONFIGURATION\n指定是否导入流元数据(Stream Matadata),默认值为Y.\n\n（8）TABLE_EXISTS_ACTION\n该选项用于指定当表已经存在时导入作业要执行的操作,默认为SKIP\nTABBLE_EXISTS_ACTION={SKIP | APPEND | TRUNCATE | FRPLACE }\n当设置该选项为SKIP时,导入作业会跳过已存在表处理下一个对象;当设置为APPEND时,会追加数据,为TRUNCATE时,导入作业会截断表,然后为其追加新数据;当设置为REPLACE时,导入作业会删除已存在表,重建表病追加数据,注意,TRUNCATE选项不适用与簇表和NETWORK_LINK选项\n\n（9）TRANSFORM\n该选项用于指定是否修改建立对象的DDL语句\nTRANSFORM=transform_name:value[:object_type]\nTransform_name用于指定转换名,其中SEGMENT_ATTRIBUTES用于标识段属性(物理属性,存储属性,表空间,日志等信息),STORAGE用于标识段存储属性,VALUE用于指定是否包含段属性或段存储属性,object_type用于指定对象类型.\nImpdp scott/tiger directory=dump dumpfile=tab.dmp Transform=segment_attributes:n:table\n\n（10）TRANSPORT_DATAFILES\n该选项用于指定搬移空间时要被导入到目标数据库的数据文件。\nTRANSPORT_DATAFILE=datafile_name\nDatafile_name用于指定被复制到目标数据库的数据文件\nImpdp system/manager DIRECTORY=dump DUMPFILE=tts.dmp TRANSPORT_DATAFILES=’/user01/data/tbs1.f’\n</code></pre>\n<h2 id=\"3-expdp-impdp-使用方法详解\"><a href=\"#3-expdp-impdp-使用方法详解\" class=\"headerlink\" title=\"3.expdp/impdp 使用方法详解\"></a>3.expdp/impdp 使用方法详解</h2><h3 id=\"3-1-oracle-expdp-使用方法介绍\"><a href=\"#3-1-oracle-expdp-使用方法介绍\" class=\"headerlink\" title=\"3.1 oracle expdp 使用方法介绍\"></a>3.1 oracle expdp 使用方法介绍</h3><pre class=\" language-shell\"><code class=\"language-shell\">使用expdp工具时,其转储文件只能被存放在directory对象对应的os目录中,而不能直接指定转储文件所在的os目录.因此,使用expdp工具时,必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n--创建directory:\ncreate directory itpuxbak_dir as '/backup';\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导出整个数据库\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=expdp_full_db01.log full=y parallel=4\n\n--02)导出方案-schema-用户\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=expdp_u_itpux01.log schemas=itpux01,itpux02\n\n--03)导出表空间\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=expdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导出表\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01,itpux02\nexpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01\n\n--05)按表查询条件导出\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log tables=itpux01 query='where id=5'\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log QUERY=employees:\"WHERE department_id > 10\"\n</code></pre>\n<h3 id=\"3-2-oracle-impdp-使用方法介绍\"><a href=\"#3-2-oracle-impdp-使用方法介绍\" class=\"headerlink\" title=\"3.2 oracle impdp 使用方法介绍\"></a>3.2 oracle impdp 使用方法介绍</h3><blockquote>\n<p>使用impdp工具时,如果数据库中不存在相应的directory，必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.<br><code>`</code>sql<br>–创建directory:<br>create directory itpuxbak_dir as ‘/backup’;<br>grant read,write on directory itpuxbak_dir to system;<br>grant read,write on directory itpuxbak_dir to itpux01;</p>\n</blockquote>\n<p>–01)导入整个数据库<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=impdp_full_db01.log full=y<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=impdp_full_db01.log full=y parallel=4</p>\n<p>–02)导入方案-schema-用户<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02 remap_schema=itpux02:itpux002</p>\n<p>–03)导入表空间<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=impdp_ts_itpux01.log tablespaces=itpux01,itpux02</p>\n<p>–04)导入表<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux<br>impdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995</p>\n<p>–05)按表查询条件导入<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 query=’where id=5’<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux query=’where id=5’</p>\n<p>impdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01 query=’where id=5’<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995 QUERY=HR.EMPLOYEES:”WHERE department_id &gt; 10”</p>\n<pre><code>\n### 3.3 oracle expdp/impdp补充\n```shell\n--01)directory\ncreate directory itpuxbak_dir as &#39;/backup&#39;;\n--drop directory itpuxbak_dir\nselect * from dba_directories\ngrant read,write on directory itpuxbak_dir to system; --system:itpux01:other users\ngrant create any directory to system;\nselect * from dba_sys_privs where grantee=&#39;SYSTEM&#39;;\n\n--02) sysdba full=y\nexpdp &quot;&#39;/as sysdba&#39;&quot; directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y --sys\n\n--03)查询datapump jobs\nselect * from dba_datapump_jobs;\nexpdp &quot;&#39;/as sysdba&#39;&quot; directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y job_name=itpuxexpjob;\n</code></pre><h2 id=\"4-配置生产环境的逻辑自动备份策略\"><a href=\"#4-配置生产环境的逻辑自动备份策略\" class=\"headerlink\" title=\"4.配置生产环境的逻辑自动备份策略\"></a>4.配置生产环境的逻辑自动备份策略</h2><blockquote>\n<p>每天做逻辑备份，数据量大小500G，保留2天，空间准备2TB<br>我的库不开归档的，不能在线做RMAN。<br><code>`</code>shell<br>create directory itpuxbak_dir as ‘/backup’;<br>grant read,write on directory itpuxbak_dir to system;<br>grant create any directory to system;</p>\n</blockquote>\n<p>#vi expdpfull_db01.sh<br>export BAKDATE=<code>date +%Y%m%d</code><br>expdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.$BAKDATE.%U.dmp logfile=expdp_full_db01.$BAKDATE.log full=y parallel=4<br>find /backup -name expdp_full_db01.*.dmp -atime +2 -exec rm -rf {} \\;</p>\n<p>#–cluster=N</p>\n<p>#chown -R oracle:dba /backup</p>\n<p>#chmod -R 775 /backup</p>\n<p>#crontab -e<br>0 20 <em> </em> * su - oracle -c /backup/scripts/expdpfull_db01.sh</p>\n<pre><code>* --报错的处理：\n```shell\nORA-39181: Only partial table data may be exported due to fine grain access control on &quot;OE&quot;.&quot;PURCHASEORDER&quot;\nselect count(*) from &quot;OE&quot;.&quot;PURCHASEORDER&quot;\ngrant EXEMPT ACCESS POLICY to system;\nexpdp system/oracle directory=itpuxbak_dir dumpfile=test-b.dmp logfile=test-b.log tables=OE.PURCHASEORDER\n</code></pre><h2 id=\"5-expdp-impdp生产环境数据迁移流程\"><a href=\"#5-expdp-impdp生产环境数据迁移流程\" class=\"headerlink\" title=\"5.expdp/impdp生产环境数据迁移流程\"></a>5.expdp/impdp生产环境数据迁移流程</h2><ul>\n<li><p>5.1、做数据迁移流程的目的</p>\n<blockquote>\n<p>使用expdp/impdp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障</p>\n</blockquote>\n</li>\n<li><p>5.2、数据迁移的适用范围</p>\n<blockquote>\n<p>所有线上库&gt;10.2</p>\n</blockquote>\n</li>\n<li><p>5.3、 数据迁移的风险评估</p>\n<blockquote>\n<p>01.有些os对文件大小有限制，expdp数据时需要使用filesize参数来分割导出文件<br>02.expdp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。<br>03.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。<br>04.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错</p>\n</blockquote>\n</li>\n<li><p>5.4、数据迁移的准备工作</p>\n<blockquote>\n<p>01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用expdp/impdp迁移数据。<br>02.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。<br>03.表比较多的情况下，建议用parfile。各个参数在parfile里写好。<br>04.提前准备备份脚本（parfile参数）：<br><code>`</code>shell<br>cat expdp_itpux.par<br>userid=system/oracle<br>directory=itpuxbak_dir<br>dumpfile=expdp_full_db01.$BAKDATE.%U.dmp<br>logfile=expdp_full_db01.$BAKDATE.log<br>tables=user.tab1,user.tab2,user.tab3<br>parallel=4</p>\n</blockquote>\n</li>\n</ul>\n<p>vi expdp.sh</p>\n<p>export BAKDATE=<code>date +%Y%m%d</code><br>expdp parfile=expdp_itpux.par<br>nohup ./expdp.sh &amp;</p>\n<pre><code>\n* 5.5、数据迁移的执行过程\n\n\n* 5.6、数据迁移后的验证方案\n&gt;对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n编译无效对象\n\n\n## 6.expdp/impdp生产环境数据迁移案例\n&gt;迁移过程详细请看视频演示，此处只做参考\n### 6.1 迁移目的\n&gt;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过ExpDP全库迁移到另一台oracle服务器，并能正常查询到相关数据。\n&gt;IMPDP虽然加上parallel参数，在做table数据导入时确实速度提高了不少，但是在create index和statistics时，依旧采用单线程的方式，故此一般在迁移过程中这两步操作选择生产DDL脚本增加parallel参数后手工执行，以最大化缩减迁移时间。\n### 6.2 迁移流程\n```sql\n1.linux系统oracle服务器上创建测试数据。\n2.linux本地用Expdp做导出;\n3.远程主机创建相关对象；\n4.远程主机用expdp做导入(导入);\n5.验证远程本地数据合法性;\n</code></pre><h3 id=\"6-3-演示过程\"><a href=\"#6-3-演示过程\" class=\"headerlink\" title=\"6.3 演示过程\"></a>6.3 演示过程</h3><ul>\n<li>01.准备数据<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 21:28:32 (QP5 v5.313) </em>/<br>CREATE TABLESPACE itpux11<br>  DATAFILE ‘/oracle/oradata/db01/itpux01.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;<br>CREATE TABLESPACE itpux12<br>  DATAFILE ‘/oracle/oradata/db01/itpux02.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;<br>–创建用户并授权<br>CREATE USER itpux01 IDENTIFIED BY itpux01<br>  DEFAULT TABLESPACE itpux01;<br>CREATE USER itpux02 IDENTIFIED BY itpux02<br>  DEFAULT TABLESPACE itpux02;<br>GRANT DBA TO itpux01;<br>GRANT DBA TO itpux02;</li>\n</ul>\n<p>ALTER USER itpux01<br>    QUOTA UNLIMITED ON itpux01;</p>\n<p>ALTER USER itpux02<br>    QUOTA UNLIMITED ON itpux02;</p>\n<p>–用户登录并创建测试表<br>CONN itpux01 / itpux01</p>\n<p>CREATE TABLE itpux01<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<p>CONN itpux02 / itpux02</p>\n<p>CREATE TABLE itpux02<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<p>–要建两个索引</p>\n<p>CREATE INDEX itpux02<br>    ON itpux02_table_test (id);</p>\n<p>–创建2个存储过程并执行。<br>CONN itpux01 / itpux01</p>\n<p>CREATE OR REPLACE PROCEDURE p_itpux01<br>IS<br>BEGIN<br>    EXECUTE IMMEDIATE ‘select count(*) from itpux01’;</p>\n<pre><code>FOR i IN 1 .. 1000\nLOOP\n    INSERT INTO itpux01 (id, name)\n         VALUES (i, SYSDATE);\n\n    COMMIT;\nEND LOOP;\n\nEXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\n</code></pre><p>END p_itpux01;<br>/</p>\n<p>BEGIN<br>    p_itpux01;<br>END;<br>/</p>\n<p>SELECT COUNT (*) FROM itpux01;</p>\n<p>SELECT *<br>  FROM itpux01<br> WHERE id &gt; 990;</p>\n<p>CONN itpux02 / itpux02</p>\n<p>CREATE OR REPLACE PROCEDURE p_itpux02<br>IS<br>BEGIN<br>    EXECUTE IMMEDIATE ‘select count(*) from itpux02’;</p>\n<pre><code>FOR i IN 1 .. 2000\nLOOP\n    INSERT INTO itpux02 (id, name)\n         VALUES (i, SYSDATE);\n\n    COMMIT;\nEND LOOP;\n\nEXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\n</code></pre><p>END p_itpux02;<br>/</p>\n<p>BEGIN<br>    p_itpux02;<br>END;<br>/</p>\n<pre><code>* 查询验证数据\n```sql\n/* Formatted on 2018/1/30 21:31:51 (QP5 v5.313) */\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id &gt; 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id &gt; 1990;\n\n--02.获取DDL\n--在源主机获取：\nSPOOL itpux_tbs_create_ddl.sql\nSET LONG 200000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 200\n\nSELECT DBMS_METADATA.get_ddl (&#39;TABLESPACE&#39;, &#39;ITPUX01&#39;) FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl (&#39;TABLESPACE&#39;, &#39;ITPUX02&#39;) FROM DUAL;\n\nSPOOL OFF;\n--在另一台主机执行：\nCREATE TABLESPACE &quot;ITPUX01&quot;\n    DATAFILE &#39;/oracle/oradata/db01/itpux01.dbf&#39;\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE &quot;ITPUX02&quot;\n    DATAFILE &#39;/oracle/oradata/db01/itpux02.dbf&#39;\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\n--03、源库导出\n建立目录（建立directory）\nSQL&gt; CREATE OR REPLACE DIRECTORY oradmp AS &#39;/oracle/backup&#39;;\nSQL&gt; GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\nexpdp SYSTEM/oracle DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=expdpfull_db01.LOG PARALLEL=2;\n--04、目标库导入\n禁止自动维护任务\n（禁用数据库自动维护任务，oracle11g中存在）\nSQL&gt; EXECUTE DBMS_AUTO_TASK_ADMIN.DISABLE;\n建立目录（建立directory）\nSQL&gt; CREATE OR REPLACE DIRECTORY oradmp AS &#39;/oracle/backup&#39;;\nSQL&gt; GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\n生成index、CONSTRAINT的ddl语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp dumpfile=itpux_01.dmp,itpux_02.dmp LOGFILE=impitpux.LOG PARALLEL=2 SQLFILE=indconddl.SQL INCLUDE=INDEX,CONSTRAINT SCHEMAS=itpux\n编辑ddl语句脚本\nsed &#39;s/NOLOGGING/ /g;s/LOGGING/ /g&#39; indconddl.SQL&gt;indconddl.sql.nologin\nsed &#39;/TABLESPACE/ s/TS_itpux/TS_itpux_INDEX/g;/TABLESPACE/ s/1/32 NOLOGGING/g&#39; indconddl.sql.nologin&gt;indconddl.sql.NEW\n设置parallel 4;\n执行导入语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=impdpfull_db01.LOG PARALLEL=2\nEXCLUDE=INDEX,CONSTRAINT,STATISTICS SCHEMAS=ITPUX;\n检查job，延后迁移时间内发起的job任务\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n执行ddl语句脚本，建立索引、约束，手工发起统计分析\n建立索引、约束\nchmod +x indconddl.sql.NEW\n more createindcon.sh\nSQLPLUS -s /nolog &lt;&lt;EOS\nCONNECT itpux / itpux\nSPOOL /tmp/indconcreate.log\n@ /oracle/backup/indconddl.sql.new;\nSPOOL OFF\nEXIT\nEOS\n执行createindcon.sh\n然后再改parallel 4;为NOPARALLEL\n--05、收集统计信息\nstats.SQL:\n\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nnohup sqlplus &quot;/as sysdba&quot; @ stats.SQL &amp;\n--06、无效对象的编译\n自动生成编译无效对象SQL及编译过程\n1) 统计当前用户无效对象数量:\n  SELECT OWNER,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status &lt;&gt; &#39;VALID&#39;\nGROUP BY OWNER, object_type, status\nORDER BY OWNER, object_type;\n2) 生成编译无效对象SQL\nSELECT    &#39;ALTER &#39;\n       || OBJECT_TYPE\n       || &#39; &#39;\n       || OWNER\n       || &#39;.&#39;\n       || OBJECT_NAME\n       || &#39; COMPILE;&#39;\n  FROM dba_objects\n WHERE     status &lt;&gt; &#39;VALID&#39;\n       AND object_type IN (&#39;PACKAGE&#39;,\n                           &#39;PACKAGE BODY&#39;,\n                           &#39;FUNCTION&#39;,\n                           &#39;PROCEDURE&#39;,\n                           &#39;TRIGGER&#39;,\n                           &#39;VIEW&#39;);\n通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n# su - oracle\n$ sqlplus / as sysdba\nSQL&gt; @$ORACLE_HOME/rdbms/ADMIN/utlrp.SQL\n--07、验证数据\n对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n\nSELECT COUNT (*) FROM itpux.itpux01;\n\nSQL&gt;SELECT OWNER,OBJECT_TYPE,COUNT(*) FROM dba_objects WHERE wner=&#39;&amp;owner&#39; GROUP BY OWNER,OBJECT_TYPE ORDER BY OBJECT_TYPE;\n跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n检查对象状态\nSQL&gt;SELECT OWNER,OBJECT_NAME,SUBOBJECT_NAME,STATUS,OBJECT_TYPE FROM dba_objects WHERE wner=&#39;&amp;owner&#39; ORDER BY OBJECT_TYPE, OBJECT_NAME, SUBOBJECT_NAME;\n\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = &#39;ITPUX01&#39;\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = &#39;ITPUX01&#39;\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status &lt;&gt; &#39;VALID&#39; AND owner = &#39;ITPUX01&#39;;\n\n--08、收尾\n启用数据库自动维护任务\nSQL&gt; EXECUTE DBMS_AUTO_TASK_ADMIN.ENABLE;\n检查并更正job运行时间\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n--09、对外应用测试\n</code></pre><h2 id=\"7-expdp-impdp迁移过程字符集的处理\"><a href=\"#7-expdp-impdp迁移过程字符集的处理\" class=\"headerlink\" title=\"7.expdp/impdp迁移过程字符集的处理\"></a>7.expdp/impdp迁移过程字符集的处理</h2><blockquote>\n<p>进行数据的导入导出时，我们要注意关于字符集的问题。在EXPDP/IMPDP过程中我们需要注意四个字符集的参数：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">01</span><span class=\"token punctuation\">.</span>导出端的客户端字符集。\n<span class=\"token number\">02</span><span class=\"token punctuation\">.</span>导出端数据库字符集。\n<span class=\"token number\">03</span><span class=\"token punctuation\">.</span>导入端的客户端字符集。\n<span class=\"token number\">05</span><span class=\"token punctuation\">.</span>导入端数据库字符集。\n</code></pre>\n<ul>\n<li>查看数据库的字符集的信息<pre class=\" language-sql\"><code class=\"language-sql\">SQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> nls_database_parameters<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//SQL> select * from props$;</span>\nNLS_LANGUAGE AMERICAN\nNLS_TERRITORY AMERICA\nNLS_CURRENCY $\nNLS_ISO_CURRENCY AMERICA\nNLS_NUMERIC_CHARACTERS <span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>\nNLS_CHARACTERSET ZHS16GBK\nNLS_CALENDAR GREGORIAN\nNLS_DATE_FORMAT DD<span class=\"token operator\">-</span>MON<span class=\"token operator\">-</span>RR\nNLS_DATE_LANGUAGE AMERICAN\nNLS_SORT <span class=\"token keyword\">BINARY</span>\nNLS_TIME_FORMAT HH<span class=\"token punctuation\">.</span>MI<span class=\"token punctuation\">.</span>SSXFF AM\nNLS_TIMESTAMP_FORMAT DD<span class=\"token operator\">-</span>MON<span class=\"token operator\">-</span>RR HH<span class=\"token punctuation\">.</span>MI<span class=\"token punctuation\">.</span>SSXFF AM\nNLS_TIME_TZ_FORMAT HH<span class=\"token punctuation\">.</span>MI<span class=\"token punctuation\">.</span>SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT DD<span class=\"token operator\">-</span>MON<span class=\"token operator\">-</span>RR HH<span class=\"token punctuation\">.</span>MI<span class=\"token punctuation\">.</span>SSXFF AM TZR\nNLS_DUAL_CURRENCY $\nNLS_COMP <span class=\"token keyword\">BINARY</span>\nNLS_LENGTH_SEMANTICS BYTE\nNLS_NCHAR_CONV_EXCP <span class=\"token boolean\">FALSE</span>\nNLS_NCHAR_CHARACTERSET AL16UTF16\nNLS_RDBMS_VERSION <span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.3</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span>\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li>我们再来查看客户端的字符集信息<pre class=\" language-shell\"><code class=\"language-shell\">客户端字符集的参数NLS_LANG=_< territory >.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n如数据库语言环境\nos是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\nos是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n永久修改可用：\nvi bash_profile\n通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n</code></pre>\n<blockquote>\n<p>(1) 源数据库和目标数据库具有相同的字符集设置。<br>这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。<br>(2) 源数据库和目标数据库字符集不同。<br>先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。<br>这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"8-expdp与impdp-版本兼容性与各版本的区别\"><a href=\"#8-expdp与impdp-版本兼容性与各版本的区别\" class=\"headerlink\" title=\"8.expdp与impdp 版本兼容性与各版本的区别\"></a>8.expdp与impdp 版本兼容性与各版本的区别</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-288-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-288-1-1.html</a></p>\n<h2 id=\"9-如何停止expdp与impdp备份任务的后台进程\"><a href=\"#9-如何停止expdp与impdp备份任务的后台进程\" class=\"headerlink\" title=\"9.如何停止expdp与impdp备份任务的后台进程\"></a>9.如何停止expdp与impdp备份任务的后台进程</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-286-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-286-1-1.html</a></p>\n<h2 id=\"10-如何清理不需要的数据泵job\"><a href=\"#10-如何清理不需要的数据泵job\" class=\"headerlink\" title=\"10.如何清理不需要的数据泵job\"></a>10.如何清理不需要的数据泵job</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-287-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-287-1-1.html</a></p>\n<h2 id=\"11-如何对expdp-impdp进行trace跟踪分析问题\"><a href=\"#11-如何对expdp-impdp进行trace跟踪分析问题\" class=\"headerlink\" title=\"11.如何对expdp/impdp进行trace跟踪分析问题\"></a>11.如何对expdp/impdp进行trace跟踪分析问题</h2><h3 id=\"11-1-使用Trace-480300\"><a href=\"#11-1-使用Trace-480300\" class=\"headerlink\" title=\"11.1 使用Trace 480300\"></a>11.1 使用Trace 480300</h3><blockquote>\n<p>&emsp;&emsp;Data Pump工作原理有两个特点：作业调度，多进程配合协作。对Data Pump的诊断本质上就是对各种Process行为的跟踪。Oracle提供了一个Trace的隐含参数，来帮助我们实现这个目标。<br>&emsp;&emsp;Trace并不像其他跟踪过程相同，使用y/n的参数，开启或者关闭。Data Pump的Trace参数是一个7位十六进制组成的数字串。不同的数字串表示不同的跟踪对象方法。7位十六进制数字分为两个部分，前三个数字表示特定的数据泵组件，后四位使用0300就可以。</p>\n</blockquote>\n<ul>\n<li>各个组件分别使用不同的三位十六进制数字代表。如下片段所示<br><code>`</code>shell<br>– Summary of Data Pump trace levels:<br>– ==================================<br>Trace DM DW ORA Lines<br>level trc trc trc in<br>(hex) file file file trace Purpose</li>\n</ul>\n<hr>\n<p>10300 x x x SHDW: To trace the Shadow process (API) (expdp/impdp)<br>20300 x x x KUPV: To trace Fixed table<br>40300 x x x ‘div’ To trace Process services<br>80300 x KUPM: To trace Master Control Process (MCP) (DM)<br>100300 x x KUPF: To trace File Manager<br>200300 x x x KUPC: To trace Queue services<br>400300 x KUPW: To trace Worker process(es) (DW)<br>800300 x KUPD: To trace Data Package<br>1000300 x META. To trace Metadata Package<br>— +<br>1FF0300 x x x ‘all’ To trace all components (full tracing)</p>\n<pre><code>&gt;如果需要同时跟踪多个组件，需要将目标组件的hex值进行累加，后面四位的300相同。\n&gt;400300+80300=480300\n&gt;&amp;emsp;&amp;emsp;对于跟踪的Trace取值，Oracle建议使用480300就可以应对大部分的情况。480300会跟踪Oracle Dump作业的Master Control Process（MCP）和Work Process。作为初始化跟踪的过程，480300基本就够用了。\n&gt;我们先从数据导出Expdp看Trace，导出一个案例。首先清理一下Trace File目录\n```sql\nexpdp \\&quot;/ as sysdba\\&quot; directory=dumpdir schemas=itpux dumpfile=itpux_dump.dmp parallel=2 trace=480300\n</code></pre><blockquote>\n<p>&emsp;&emsp;然后检查trc目录，Dm和dw标注的就是MCP和Work Process生成的Trace文件。同时Parallel设置使得dw有00和01两个。<br>2个trace 文件在BACKGROUND_DUMP_DEST目录下：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">Master Process trace <span class=\"token keyword\">file</span>: <span class=\"token operator\">&lt;</span>SID<span class=\"token operator\">></span>_dm<span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span>_<span class=\"token operator\">&lt;</span>process_id<span class=\"token operator\">></span><span class=\"token punctuation\">.</span>trc\nWorker Process trace <span class=\"token keyword\">file</span>: <span class=\"token operator\">&lt;</span>SID<span class=\"token operator\">></span>_dw<span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span>_<span class=\"token operator\">&lt;</span>process_id<span class=\"token operator\">></span><span class=\"token punctuation\">.</span>trc\n</code></pre>\n<p>在导出过程中，我们可以看到两个worker的会话信息。<br><code>`</code>sql<br>SQL&gt; select * from dba_datapump_sessions;<br>OWNER_NAME JOB_NAME INST_ID SADDR SESSION_TYPE</p>\n</blockquote>\n<hr>\n<p>SYS SYS_EXPORT_SCHEMA_01 1 35EB0580 DBMS_DATAPUMP<br>SYS SYS_EXPORT_SCHEMA_01 1 35E95280 MASTER<br>SYS SYS_EXPORT_SCHEMA_01 1 35E8A480 WORKER<br>SYS SYS_EXPORT_SCHEMA_01 1 35E84D80 WORKER</p>\n<pre><code>&gt;&amp;emsp;&amp;emsp;此时我们可以从Trace文件中，看到一些Data Pump工作的细节信息。例如：在MCP的Trace文件中，我们看到一系列调用动作过程，如下片段：\n--初始化导出动作，整理文件系统；\n-日志写入\n在Worker Process中，如下片段看出在导出数据。\n### 11.2 使用Trace 480301\n&gt;&amp;emsp;&amp;emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n&gt;切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。\n```sql\nimpdp \\&quot;/ as sysdba\\&quot; directory=dumpdir dumpfile=itpux_dump.dmp remap_schema=itpux:test trace=480301 parallel=2\n</code></pre><blockquote>\n<p>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。<br>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。我们使用导入过程进行实验。<br>&emsp;&emsp;目录生成的Trace文件，都是10046格式的Raw文件。截取片段如下：<br>10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">$ tkprof itpux_dm00_17292<span class=\"token punctuation\">.</span>trc tkprof_itpux_dm00_17292<span class=\"token punctuation\">.</span><span class=\"token keyword\">out</span> waits<span class=\"token operator\">=</span>y sort<span class=\"token operator\">=</span>exeela\n$ tkprof itpux_dw01_17294<span class=\"token punctuation\">.</span>trc tkprof_itpux__dw01_17294<span class=\"token punctuation\">.</span><span class=\"token keyword\">out</span> waits<span class=\"token operator\">=</span>y sort<span class=\"token operator\">=</span>exeela\n</code></pre>\n</blockquote>\n<h3 id=\"11-3-使用10046事件\"><a href=\"#11-3-使用10046事件\" class=\"headerlink\" title=\"11.3.使用10046事件\"></a>11.3.使用10046事件</h3><ul>\n<li>10046 事件有如下级别<pre class=\" language-shell\"><code class=\"language-shell\">event 10046, level 1 = enable standardSQL_TRACE functionality\nevent 10046, level 4 = as level 1, plus trace the BIND values\nevent 10046, level 8 = as level 1, plus trace the WAITs\nevent 10046, level 12 = as level 1, plus trace the BIND values and the WAITs\n</code></pre>\n</li>\n<li>不同级别的使用情况如下<pre class=\" language-shell\"><code class=\"language-shell\">level 1: lowest level tracing - not alwayssufficient to determine cause of errors;\nlevel 4: useful when an error in DataPump's worker or master process occurs;\nlevel 12: useful when there is an issuewith Data Pump performance.\n</code></pre>\n</li>\n<li>注意：<blockquote>\n<p>&emsp;&emsp; 当我们设置10046的级别高于8或者12的时候，需要将TIMED_STATISTICS设置为TRUE. 临时的将这个参数设置为true，可以将trace数据性能的影响降到最低，在11gR2里，该参数默认为true。<br>一般只有遇到性能问题时，才会使用8或者12的level。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"11-4-日常使用\"><a href=\"#11-4-日常使用\" class=\"headerlink\" title=\"11.4 日常使用\"></a>11.4 日常使用</h3><ul>\n<li>01、对当前正在运行的进程进行trace<br><code>`</code>sql</li>\n</ul>\n<p>–查看数据泵进程的信息：<br>SET LINES 150 PAGES 100 NUMWIDTH 7<br>COL username FOR a10<br>COL spid FOR a7<br>COL program FOR a25</p>\n<p>SELECT TO_CHAR (SYSDATE, ‘YYYY-MM-DDHH24:MI:SS’) “DATE”,<br>       s.program,<br>       s.sid,<br>       s.status,<br>       s.username,<br>       d.job_name,<br>       p.spid,<br>       s.serial#,<br>       p.pid<br>  FROM v$session s, v$process p, dba_datapump_sessions d<br> WHERE p.addr = s.paddr<br> ands.saddr=d.saddr;</p>\n<pre><code>&gt;使用sys.dbms_system.set_ev设置10046\n&gt;在上节的查询结果里：\nData Pump Master process (DM00)的SID 是58，serial#是85.\nData Pump Worker process (DW01)的SID 是23，serial#是311.\n\n&gt;使用10046 跟踪活动session的语法如下\n```sql\nSyntax: DBMS_SYSTEM.SET_EV([SID],[SERIAL#],[EVENT],[LEVEL],&#39;&#39;)\n\n--在level 4跟踪Worker process进程(Bind values)：\nexecute sys.dbms_system.set_ev(23,311,10046,4,&#39;&#39;);\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(23,311,10046,0,&#39;&#39;);\n\n--在level 8 跟踪Master进程（Waits）：\nexecute sys.dbms_system.set_ev(143,50,10046,8,&#39;&#39;);\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(143,50,10046,0,&#39;&#39;);\n</code></pre><ul>\n<li>02、使用oradebug<blockquote>\n<p>可以在oradebug中设置SPID，来进行trace<br><code>`</code>sql<br>–在level 4跟踪Worker process进程(Bind values)：<br>oradebug setospid 8173<br>oradebug unlimit<br>oradebug event 10046 trace name context forever, level 4<br>oradebug tracefile_name</p>\n</blockquote>\n</li>\n</ul>\n<p>–在level 8 跟踪Master进程（Waits）：<br>oradebug setospid 8171<br>oradebug unlimit<br>oradebug event 10046 trace name context forever, level 8<br>oradebug tracefile_name</p>\n<p>–stop tracing:<br>oradebug event 10046 trace name context off ITPUX</p>\n<pre><code>\n* 03、使用tkprof 分析trace文件\n&gt;10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux_dw01_17294.out waits=y sort=exeela\n</code></pre><h2 id=\"12-expdp-impdp使用总结\"><a href=\"#12-expdp-impdp使用总结\" class=\"headerlink\" title=\"12.expdp/impdp使用总结\"></a>12.expdp/impdp使用总结</h2><ul>\n<li>1.expdp/impdp 默认就是使用直接路径的，所以速度比较快，但是expdp/impdp 是服务端程序，影响它速度的只有磁盘io。</li>\n<li>2.导出多表时，expdp/impdp用法是tables=’table1’,’table2’,’table3’。</li>\n<li>3.dumpfile 参数 ，可以用%u 指定多个数据文件<pre class=\" language-sql\"><code class=\"language-sql\">expdp xxx<span class=\"token operator\">/</span>xxx schemas<span class=\"token operator\">=</span>xxx directory<span class=\"token operator\">=</span>dump1 <span class=\"token keyword\">dumpfile</span><span class=\"token operator\">=</span>xxx_<span class=\"token operator\">%</span>u<span class=\"token punctuation\">.</span>dmp filesize<span class=\"token operator\">=</span>50g\n</code></pre>\n<blockquote>\n<p>这样每个文件50g ，xxx_01.dump,xxx_02.dump 这样。</p>\n</blockquote>\n</li>\n<li>4.如果要把用户usera的对象导到用户userb，操作如下：<pre class=\" language-shell\"><code class=\"language-shell\">impdp system/passwd directory=expdp dumpfile=expdp.dmp remap_schema='usera':'userb' logfile=/oracle/exp.log;\n</code></pre>\n</li>\n<li><p>5.如果导入需要更换表空间，impdp用remap_tablespace=’tabspace_old’:’tablespace_new’</p>\n</li>\n<li><p>6.关于数据导出时要导出哪些内容</p>\n<blockquote>\n<p>expdp content（all:对象＋导出数据行，data_only：只导出对象，metadata_only：只导出数据的记录）</p>\n</blockquote>\n</li>\n<li>7、数据泵expdp/impdp 影响速度和性能最大的就是paralle。 所以使用数据泵，要想提高速度，就要设置并行参数。如：<blockquote>\n<p>&emsp;&emsp; expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4<br>那么expdp将为parallel 创建4个文件： test_01.dmp，test_02.dmp，test_03.dmp，test_04.dmp。 每个进程一个文件。 这样的话，每个文件的大小会因进程而不同。 可以某个文件很大，某个文件却很小。 要解决这个问题，就是设置filesize 参数。 来指定每个文件的最大值。 这样当一个文件达到最大值的之后，就会创建一个新的文件。</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>&emsp;&emsp;如：expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4 filesize=50m<br>导出的dump文件和paralle有关系，那么导入也有关系。 paralle要小于dump文件数。 如果paralle 大于dump文件的个数，就会因为超过的那个进程获取不到文件，就不能对性能提高。一般parall 参数值等于cpu 的个数。而且要小于dump文件的个数。</p>\n</blockquote>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle数据库逻辑备份恢复迁移之expdp与impdp\"><a href=\"#Oracle数据库逻辑备份恢复迁移之expdp与impdp\" class=\"headerlink\" title=\"Oracle数据库逻辑备份恢复迁移之expdp与impdp\"></a>Oracle数据库逻辑备份恢复迁移之expdp与impdp</h1><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><p>[Oracle 11G R2 官方文档][1]</p>\n<h2 id=\"1-Oracle数据泵expdp-impdp概念\"><a href=\"#1-Oracle数据泵expdp-impdp概念\" class=\"headerlink\" title=\"1.Oracle数据泵expdp/impdp概念\"></a>1.Oracle数据泵expdp/impdp概念</h2><ul>\n<li>Oracle Database 10g引入了最新的数据泵(Data Dump)技术，数据泵导出导入(EXPDP和IMPDP)的作用<blockquote>\n<p>1）实现逻辑备份和逻辑恢复.<br>2）在数据库用户之间移动对象.<br>3）在数据库之间移动对象<br>4）实现表空间搬移.</p>\n</blockquote>\n</li>\n<li><p>数据泵导出导入与传统导出导入的区别</p>\n<blockquote>\n<p>&emsp;&emsp;在10g之前,传统的导出和导入分别使用exp工具和imp工具,从10g开始,不仅保留了原有的exp和imp工具,还提供了数据泵导出导入工具expdp和impdp.使用expdp和impdp时应该注意的事项：<br>1）exp和imp是客户端工具程序,它们既可以在可以客户端使用,也可以在服务端使用。<br>2）expdp和impdp是服务端的工具程序,他们只能在oracle服务端使用,不能在客户端使用。<br>3）imp只适用于exp导出文件,不适用于expdp导出文件;impdp只适用于expdp导出文件,而不适用于exp导出文件。</p>\n</blockquote>\n</li>\n<li><p>数据泵导出包括导出表,导出方案,导出表空间,导出数据库4种方式.</p>\n</li>\n<li><p>oracle数据泵的工作流程如下</p>\n<blockquote>\n<p>1、在命令行执行命令<br>2、expdp/impdp命令调用dbms_datapump pl/sql包。 这个api提供高速的导出导入功能。<br>3、 当data 移动的时候， data pump 会自动选择direct path 或者external table mechanism 或者 两种结合的方式。<br>&emsp;&emsp;当metadata（对象定义） 移动的时候，data pump会使用dbms_metadata pl/sql包。 metadata api 将metadata（对象定义）存储在xml里。所有的进程都能load 和unload 这些metadata. 因为data pump 调用的是服务端的api, 所以当一个任务被调度或执行，客户端就可以退出连接，任务job 会在server 端继续执行，随后通过客户端实用程序从任何地方检查任务的状态和进行修改。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"2-expdp-impdp-命令参数详解\"><a href=\"#2-expdp-impdp-命令参数详解\" class=\"headerlink\" title=\"2.expdp/impdp 命令参数详解\"></a>2.expdp/impdp 命令参数详解</h2><h3 id=\"2-1关于expdp\"><a href=\"#2-1关于expdp\" class=\"headerlink\" title=\"2.1关于expdp\"></a>2.1关于expdp</h3><pre><code class=\"shell\">[oracle@db01:/home/oracle]$expdp -help\nExport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:30 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump export utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: expdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Export runs by entering the &#39;expdp&#39; command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: expdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: expdp scott/tiger DUMPFILE=scott.dmp DIRECTORY=dmpdir SCHEMAS=scott\nor TABLES=(T1:P1,T1:P2), if T1 is partitioned table\nUSERID must be the first parameter on the command line.\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\n\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\n\n该选项用于在客户会话与已存在导出作用之间建立关联.语法如下\nattach=[schema_name.]job_name\nschema_name用于指定方案名,job_name用于指定导出作业名.注意,如果使用attach选项,在命令行除了连接字符串和attach选项外,不能指定任何其他选项,示例如下:\nexpdp scott/tiger attach=scott.export_job\n\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\n而在11GR2后EXPDP和IMDP的WORKER进程会在多个INSTANCE启动，所以DIRECTORY必须在共享磁盘上，如果没有设置共享磁盘还是指定cluster=no来防止报错\n\nCOMPRESSION\nReduce the size of a dump file.\nValid keyword values are: ALL, DATA_ONLY, [METADATA_ONLY] and NONE.\n这个压缩比例可以和操作系统“gzip -9”相媲美，某些特例下有可能比gzip还要高效：1/7。\n10g中的COMPRESSION参数只提供METADATA_ONLY和NONE两个选项，基本上没有提供压缩功能。\n11g中的COMPRESSION参数提供四个选项，分别是ALL、DATA_ONLY、METADATA_ONLY和NONE，非常的丰富，稍后我们将使用ALL参数进行操作。\n\nOracle 11g的EXPDP工具提供了真正意义上的“备份压缩”，这个技术在备份空间不足的情况下非常实用。all 压缩元数据和对象数据 data_only 只压缩对象数据 metadata_only 只压缩元数据 none 不压缩任何数据。\n\nCONTENT\nSpecifies data to unload.\nValid keyword values are: [ALL], DATA_ONLY and METADATA_ONLY.\n该选项用于指定要导出的内容.默认值为all\ncontent={all | data_only | metadata_only}\n当设置content为all 时,将导出对象定义及其所有数据.为data_only时,只导出对象数据,为metadata_only时,只导出对象定义。\nexpdp scott/tiger directory=dump dumpfile=a.dump content=metadata_only\n\nDATA_OPTIONS\nData layer option flags.\nValid keyword values are: XML_CLOBS.\n用于为某些类型的数据提供选项\n\nDIRECTORY\nDirectory object to be used for dump and log files.\n指定转储文件和日志文件所在的目录，directory=directory_object\ndirectory_object用于指定目录对象名称.需要注意,目录对象是使用create directory语句建立的对象,而不是os 目录。\n\nexpdp scott/tiger directory=dump dumpfile=a.dump\n先在对应的位置创建物理文件夹，如d:/backup\n建立目录:\ncreate or replace directory backup as &#39;/opt/oracle/utl_file&#39;\nsql&gt;create directory backup as ‘d:/backup’;\nsql&gt;grant read,write on directory backup to system;\n查询创建了那些子目录:\nselect * from dba_directories;\n\nDUMPFILE\nSpecify list of destination dump file names [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\n用于指定转储文件的名称,默认名称为expdat.dmp\ndumpfile=[directory_object:]file_name [,….]\ndirectory_object用于指定目录对象名,file_name用于指定转储文件名.需要注意,如果不指定directory_object,导出工具会自动使用directory选项指定的目录对象：expdp scott/tiger directory=dump1 dumpfile=dump2:a.dmp\n\nENCRYPTION\nEncrypt part or all of a dump file.\nValid keyword values are: ALL, DATA_ONLY, ENCRYPTED_COLUMNS_ONLY, METADATA_ONLY and NONE.\n是否加密导出数据 默认none\nencryption={all | data_only |metadata_only | encrypted_columns_only | none}\nall 对象和元数据 data_only 对象加密 metadata_only 元数据加密 encryption_columns_only 只加密加密列 none 不加密\n\nENCRYPTION_ALGORITHM\nSpecify how encryption should be done.\nValid keyword values are: [AES128], AES192 and AES256.\n加密算法 默认aes128\nencryption_algorithm= {aes128 | aes 192 | aes 256}\n\nENCRYPTION_MODE\nMethod of generating encryption key.\nValid keyword values are: DUAL, PASSWORD and [TRANSPARENT].\n加密和解密所使用的安全类型\nencryption_mode={dual | password |transparent }\ndual 表示用 oracle wallet 或指定口令建立导出文件password 指定口令建立导出文件 transparent oracle wallet建立导出文件\n\nENCRYPTION_PASSWORD\nPassword key for creating encrypted data within a dump file.\n指定加密和解密口令 encryption_password=password\n\nESTIMATE\nCalculate job estimates.\nValid keyword values are: [BLOCKS] and STATISTICS.\n指定估算被导出表所占用磁盘空间分方法.默认值是blocks。\nextimate={blocks | statistics}\n设置为blocks时,oracle会按照目标对象所占用的数据块个数乘以数据块尺寸估算对象占用的空间,设置为statistics时,根据最近统计值估算对象占用空间: expdp scott/tiger tables=emp estimate=statistics directory=dump dumpfile=a.dump\n\nESTIMATE_ONLY\nCalculate job estimates without performing the export.\n指定是否只估算导出作业所占用的磁盘空间,默认值为n\nextimate_only={y | n}\n设置为y时,导出作用只估算对象所占用的磁盘空间,而不会执行导出作业,为n时,不仅估算对象所占用的磁盘空间,还会执行导出操作.\nexpdp scott/tiger estimate_only=y nologfile=y\n\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:&quot;=&#39;HR&#39;&quot;.\n该选项用于指定执行操作时释放要排除对象类型或相关对象 ITPUX\n\nexclude=object_type[:name_clause] [,….]\nobject_type用于指定要排除的对象类型,name_clause用于指定要排除的具体对象.exclude和include不能同时使用。\nexpdp scott/tiger directory=dump dumpfile=a.dup exclude=view\nFILESIZE\nSpecify the size of each dump file in units of bytes.\n指定导出文件的最大尺寸,默认为0,(表示文件尺寸没有限制)\nFLASHBACK_SCN\nSCN used to reset session snapshot.\n指定导出特定scn时刻的表数据。flashback_scn=scn_value\nscn_value用于标识scn值.flashback_scn和flashback_time不能同时使用： expdp\nscott/tiger directory=dump dumpfile=a.dmp flashback_scn=358523\n\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\n指定导出特定时间点的表数据\nflashback_time=”to_timestamp(time_value)”\nexpdp scott/tiger directory=dump dumpfile=a.dmp flashback_time= “to_timestamp(’25-08-2004 14:35:00’,’dd-mm-yyyy hh24:mi:ss’)”\n\nFULL\nExport entire database [N].\n指定数据库模式导出,默认为n。 full={y | n} 。为y时,标识执行数据库导出.\nHELP\nDisplay Help messages [N].\n指定是否显示expdp命令行选项的帮助信息,默认为n。当设置为y时,会显示导出选项的帮助信息. expdp help=y\n\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\n指定导出时要包含的对象类型及相关对象。include = object_type[:name_clause] [,… ]\n\nJOB_NAME\nName of export job to create.\n指定要导出作用的名称,默认为sys_xxx 。job_name=jobname_string\n\nLOGFILE\nSpecify log file name [export.log].\n指定导出日志文件文件的名称,默认名称为export.log\nlogfile=[directory_object:]file_name\ndirectory_object用于指定目录对象名称,file_name用于指定导出日志文件名.如果不指定directory_object.导出作用会自动使用directory的相应选项值.\nexpdp scott/tiger directory=dump dumpfile=a.dmp logfile=a.log\n\nNETWORK_LINK\nName of remote database link to the source system.\n指定数据库链接名,如果要将远程数据库对象导出到本地例程的转储文件中,必须设置该选项.\n\nNOLOGFILE\nDo not write log file [N].\n该选项用于指定禁止生成导出日志文件,默认值为n.\n\nPARALLEL\nChange the number of active workers for current job.\n指定执行导出操作的并行进程个数,默认值为1\n一般是cpu的2倍，可以被文件个数整除\n\nPARFILE\nSpecify parameter file name.\n指定导出参数文件的名称。parfile=[directory_path] file_name\n\nQUERY\nPredicate clause used to export a subset of a table.\nFor example, QUERY=employees:&quot;WHERE department_id &gt; 10&quot;.\n用于指定过滤导出数据的where条件\nquery=[schema.] [table_name:] query_clause\nschema用于指定方案名,table_name用于指定表名,query_clause用于指定条件限制子句.query选项不能与connect=metadata_only,extimate_only,transport_tablespaces等选项同时使用.\nexpdp scott/tiger directory=dump dumpfiel=a.dmp tables=emp query=’where deptno=20’\n\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\n用于转换列的数据函数， 并将转换值导出到文件中\nremap_data=[schema1.]tablename.column_name:[schema2.]pkg.func\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n覆盖已处在的导出文件，默认N\n\nSAMPLE\nPercentage of data to be exported.\n用于指定被采样数据块的百分比\nsample=[[schema_name.]table_name:]sample_percent (采用比率)\n\nSCHEMAS\nList of schemas to export [login schema].\n该方案用于指定执行方案模式导出,默认为当前用户方案.\n\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\n\nSOURCE_EDITION\nEdition to be used for extracting metadata.\n用于提取源数据的版本\n\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n指定显示导出作用进程的详细状态,默认值为0\n\nTABLES\nIdentifies a list of tables to export.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\n指定表模式导出\ntables=[schema_name.]table_name[:partition_name][,…]\nschema_name用于指定方案名,table_name用于指定导出的表名,partition_name用于指定要导出的分区名.\n\nTABLESPACES\nIdentifies a list of tablespaces to export.\n指定要导出表空间列表\n\nTRANSPORTABLE\nSpecify whether transportable method can be used.\nValid keyword values are: ALWAYS and [NEVER].\n指定是否可以使用可传输方法\n\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\n    该选项用于指定被搬移表空间和未搬移表空间关联关系的检查方式,默认为n. 当设置为y时,导出作用会检查表空间直接的完整关联关系,如果表空间所在表空间或其索引所在的表空间只有一个表空间被搬移,将显示错误信息.当设置为n时,导出作用只检查单端依赖,如果搬移索引所在表空间,但未搬移表所在表空间,将显示出错信息,如果搬移表所在表空间,未搬移索引所在表空间,则不会显示错误信息.\n\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be unloaded.\n指定执行表空间模式导出 ，用于指定搬移的的表空间\nVERSION\nVersion of objects to export.\nValid keyword values are: [COMPATIBLE], LATEST or any valid database version.\n用于指定被导出对象的数据库版本 默认 compatible\nversion={compatable | latest |version_string}\ncompatible 根据compatible参数生成对象 latest 根据数据库的实际版本 version_string 指定数据库版本（&gt;9.2）\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nADD_FILE\nAdd dumpfile to dumpfile set. \n\n向转储文件集中添加转储文件\n\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\n返回到记录模式。如果处于空闲状态, 将重新启动作业。\n\nEXIT_CLIENT\nQuit client session and leave job running.\n退出客户机会话并使作业处于运行状态\n\nFILESIZE\nDefault filesize (bytes) for subsequent ADD_FILE commands.\n后续 ADD_FILE 命令的默认文件大小 (字节)。\n\nHELP\nSummarize interactive commands.\n总结交互命令。\n\nKILL_JOB\nDetach and delete job.\n分离和删除作业\nPARALLEL\nChange the number of active workers for current job.\n更改当前作业的活动 worker 的数目。\n\nREUSE_DUMPFILES\nOverwrite destination dump file if it exists [N].\n是否覆盖dumpfiles\n\nSTART_JOB\nStart or resume current job.\n\nValid keyword values are: SKIP_CURRENT.\n启动/恢复当前作业。\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\n在默认值 (0) 将显示可用时的新状态的情况下,要监视的频率 (以秒计) 作业状态。\nSTATUS[=interval]\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keyword values are: IMMEDIATE.\n顺序关闭执行的作业并退出客户机。STOP_JOB=IMMEDIATE 将立即关闭数据泵作业。\n</code></pre>\n<h2 id=\"2-2-关于impdp\"><a href=\"#2-2-关于impdp\" class=\"headerlink\" title=\"2.2 关于impdp\"></a>2.2 关于impdp</h2><pre><code class=\"shell\">[oracle@db01:/home/oracle]$impdp -help\nImport: Release 11.2.0.3.0 - Production on Mon Aug 22 00:16:43 2016\nCopyright (c) 1982, 2011, Oracle and/or its affiliates. All rights reserved.\nThe Data Pump Import utility provides a mechanism for transferring data objects\nbetween Oracle databases. The utility is invoked with the following command:\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nYou can control how Import runs by entering the &#39;impdp&#39; command followed\nby various parameters. To specify parameters, you use keywords:\nFormat: impdp KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\nExample: impdp scott/tiger DIRECTORY=dmpdir DUMPFILE=scott.dmp\nUSERID must be the first parameter on the command line.\n------------------------------------------------------------------------------\nThe available keywords and their descriptions follow. Default values are listed within square brackets.\nATTACH\nAttach to an existing job.\nFor example, ATTACH=job_name.\nCLUSTER\nUtilize cluster resources and distribute workers across the Oracle RAC.\nValid keyword values are: [Y] and N.\nCONTENT\nSpecifies data to load.\nValid keywords are: [ALL], DATA_ONLY and METADATA_ONLY.\nDATA_OPTIONS\nData layer option flags.\nValid keywords are: SKIP_CONSTRAINT_ERRORS.\nDIRECTORY\nDirectory object to be used for dump, log and SQL files.\nDUMPFILE\nList of dump files to import from [expdat.dmp].\nFor example, DUMPFILE=scott1.dmp, scott2.dmp, dmpdir:scott3.dmp.\nENCRYPTION_PASSWORD\nPassword key for accessing encrypted data within a dump file.\nNot valid for network import jobs.\nESTIMATE\nCalculate job estimates.\nValid keywords are: [BLOCKS] and STATISTICS.\nEXCLUDE\nExclude specific object types.\nFor example, EXCLUDE=SCHEMA:&quot;=&#39;HR&#39;&quot;.\nFLASHBACK_SCN\nSCN used to reset session snapshot.\nFLASHBACK_TIME\nTime used to find the closest corresponding SCN value.\nFULL\nImport everything from source [Y].\nHELP\nDisplay help messages [N].\nINCLUDE\nInclude specific object types.\nFor example, INCLUDE=TABLE_DATA.\nJOB_NAME\nName of import job to create.\nLOGFILE\nLog file name [import.log].\nNETWORK_LINK\nName of remote database link to the source system.\nNOLOGFILE\nDo not write log file [N].\nPARALLEL\nChange the number of active workers for current job.\nPARFILE\nSpecify parameter file.\nPARTITION_OPTIONS\nSpecify how partitions should be transformed.\nValid keywords are: DEPARTITION, MERGE and [NONE].\nQUERY\nPredicate clause used to import a subset of a table.\nFor example, QUERY=employees:&quot;WHERE department_id &gt; 10&quot;.\nREMAP_DATA\nSpecify a data conversion function.\nFor example, REMAP_DATA=EMP.EMPNO:REMAPPKG.EMPNO.\nREMAP_DATAFILE\nRedefine data file references in all DDL statements.\nREMAP_SCHEMA\nObjects from one schema are loaded into another schema.\nREMAP_TABLE\nTable names are remapped to another table.\nFor example, REMAP_TABLE=HR.EMPLOYEES:EMPS.\nREMAP_TABLESPACE\nTablespace objects are remapped to another tablespace.\nREUSE_DATAFILES\nTablespace will be initialized if it already exists [N].\nSCHEMAS\nList of schemas to import.\nSERVICE_NAME\nName of an active Service and associated resource group to constrain Oracle RAC resources.\nSKIP_UNUSABLE_INDEXES\nSkip indexes that were set to the Index Unusable state.\nSOURCE_EDITION\nEdition to be used for extracting metadata.\nSQLFILE\nWrite all the SQL DDL to a specified file.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTREAMS_CONFIGURATION\nEnable the loading of Streams metadata\nTABLE_EXISTS_ACTION\nAction to take if imported object already exists.\nValid keywords are: APPEND, REPLACE, [SKIP] and TRUNCATE.\nTABLES\nIdentifies a list of tables to import.\nFor example, TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995.\nTABLESPACES\nIdentifies a list of tablespaces to import.\nTARGET_EDITION\nEdition to be used for loading metadata.\nTRANSFORM\nMetadata transform to apply to applicable objects.\nValid keywords are: OID, PCTSPACE, SEGMENT_ATTRIBUTES and STORAGE.\nTRANSPORTABLE\nOptions for choosing transportable data movement.\nValid keywords are: ALWAYS and [NEVER].\nOnly valid in NETWORK_LINK mode import operations.\nTRANSPORT_DATAFILES\nList of data files to be imported by transportable mode.\nTRANSPORT_FULL_CHECK\nVerify storage segments of all tables [N].\nTRANSPORT_TABLESPACES\nList of tablespaces from which metadata will be loaded.\nOnly valid in NETWORK_LINK mode import operations.\nVERSION\nVersion of objects to import.\nValid keywords are: [COMPATIBLE], LATEST or any valid database version.\nOnly valid for NETWORK_LINK and SQLFILE.\n------------------------------------------------------------------------------\nThe following commands are valid while in interactive mode.\nNote: abbreviations are allowed.\nCONTINUE_CLIENT\nReturn to logging mode. Job will be restarted if idle.\nEXIT_CLIENT\nQuit client session and leave job running.\nHELP\nSummarize interactive commands.\nKILL_JOB\nDetach and delete job.\nPARALLEL\nChange the number of active workers for current job.\nSTART_JOB\nStart or resume current job.\nValid keywords are: SKIP_CURRENT.\nSTATUS\nFrequency (secs) job status is to be monitored where\nthe default [0] will show new status when available.\nSTOP_JOB\nOrderly shutdown of job execution and exits the client.\nValid keywords are: IMMEDIATE.\n\n其实IMPDP命令行选项与EXPDP有很多相同的,下面我们只介绍不同的部分：\n（1）REMAP_DATAFILE\n该选项用于将源数据文件名转变为目标数据文件名,在不同平台之间搬移表空间时可能需要该选项.\nREMAP_DATAFIEL=source_datafie:target_datafile\n\n（2）REMAP_SCHEMA\n该选项用于将源方案的所有对象装载到目标方案中.\nREMAP_SCHEMA=source_schema:target_schema\n\n（3）REMAP_TABLESPACE\n将源表空间的所有对象导入到目标表空间中\nREMAP_TABLESPACE=source_tablespace:target_tablespace\n\n（4）REUSE_DATAFILES\n该选项指定建立表空间时是否覆盖已存在的数据文件.默认为N。\nREUSE_DATAFIELS={Y | N}\n\n（5）SKIP_UNUSABLE_INDEXES\n指定导入是是否跳过不可使用的索引,默认为N\n\n（6）SQLFILE\n指定将导入要指定的索引DDL操作写入到SQL脚本中。\nSQLFILE=[directory_object:]file_name\nImpdp scott/tiger DIRECTORY=dump DUMPFILE=tab.dmp SQLFILE=a.sql\n\n（7）STREAMS_CONFIGURATION\n指定是否导入流元数据(Stream Matadata),默认值为Y.\n\n（8）TABLE_EXISTS_ACTION\n该选项用于指定当表已经存在时导入作业要执行的操作,默认为SKIP\nTABBLE_EXISTS_ACTION={SKIP | APPEND | TRUNCATE | FRPLACE }\n当设置该选项为SKIP时,导入作业会跳过已存在表处理下一个对象;当设置为APPEND时,会追加数据,为TRUNCATE时,导入作业会截断表,然后为其追加新数据;当设置为REPLACE时,导入作业会删除已存在表,重建表病追加数据,注意,TRUNCATE选项不适用与簇表和NETWORK_LINK选项\n\n（9）TRANSFORM\n该选项用于指定是否修改建立对象的DDL语句\nTRANSFORM=transform_name:value[:object_type]\nTransform_name用于指定转换名,其中SEGMENT_ATTRIBUTES用于标识段属性(物理属性,存储属性,表空间,日志等信息),STORAGE用于标识段存储属性,VALUE用于指定是否包含段属性或段存储属性,object_type用于指定对象类型.\nImpdp scott/tiger directory=dump dumpfile=tab.dmp Transform=segment_attributes:n:table\n\n（10）TRANSPORT_DATAFILES\n该选项用于指定搬移空间时要被导入到目标数据库的数据文件。\nTRANSPORT_DATAFILE=datafile_name\nDatafile_name用于指定被复制到目标数据库的数据文件\nImpdp system/manager DIRECTORY=dump DUMPFILE=tts.dmp TRANSPORT_DATAFILES=’/user01/data/tbs1.f’\n</code></pre>\n<h2 id=\"3-expdp-impdp-使用方法详解\"><a href=\"#3-expdp-impdp-使用方法详解\" class=\"headerlink\" title=\"3.expdp/impdp 使用方法详解\"></a>3.expdp/impdp 使用方法详解</h2><h3 id=\"3-1-oracle-expdp-使用方法介绍\"><a href=\"#3-1-oracle-expdp-使用方法介绍\" class=\"headerlink\" title=\"3.1 oracle expdp 使用方法介绍\"></a>3.1 oracle expdp 使用方法介绍</h3><pre><code class=\"shell\">使用expdp工具时,其转储文件只能被存放在directory对象对应的os目录中,而不能直接指定转储文件所在的os目录.因此,使用expdp工具时,必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.\n--创建directory:\ncreate directory itpuxbak_dir as &#39;/backup&#39;;\ngrant read,write on directory itpuxbak_dir to system;\ngrant read,write on directory itpuxbak_dir to itpux01;\n\n--01)导出整个数据库\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=expdp_full_db01.log full=y parallel=4\n\n--02)导出方案-schema-用户\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=expdp_u_itpux01.log schemas=itpux01,itpux02\n\n--03)导出表空间\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=expdp_ts_itpux01.log tablespaces=itpux01,itpux02\n\n--04)导出表\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01,itpux02\nexpdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=expdp_tb_itpux01.log tables=itpux01\n\n--05)按表查询条件导出\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log tables=itpux01 query=&#39;where id=5&#39;\nexpdp system/oracle directory=itpuxbak_dir dumpfile=expdp_q_itpux01.dmp logfile=expdp_q_itpux01.log QUERY=employees:&quot;WHERE department_id &gt; 10&quot;\n</code></pre>\n<h3 id=\"3-2-oracle-impdp-使用方法介绍\"><a href=\"#3-2-oracle-impdp-使用方法介绍\" class=\"headerlink\" title=\"3.2 oracle impdp 使用方法介绍\"></a>3.2 oracle impdp 使用方法介绍</h3><blockquote>\n<p>使用impdp工具时,如果数据库中不存在相应的directory，必须首先建立directory对象.并且需要为数据库用户授予使用directory对象权限.<br><code>`</code>sql<br>–创建directory:<br>create directory itpuxbak_dir as ‘/backup’;<br>grant read,write on directory itpuxbak_dir to system;<br>grant read,write on directory itpuxbak_dir to itpux01;</p>\n</blockquote>\n<p>–01)导入整个数据库<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=impdp_full_db01.log full=y<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01_%U.dmp logfile=impdp_full_db01.log full=y parallel=4</p>\n<p>–02)导入方案-schema-用户<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_u_itpux01.dmp logfile=impdp_u_itpux01.log schemas=itpux01,itpux02 remap_schema=itpux02:itpux002</p>\n<p>–03)导入表空间<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_ts_itpux01.dmp logfile=impdp_ts_itpux01.log tablespaces=itpux01,itpux02</p>\n<p>–04)导入表<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux<br>impdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995</p>\n<p>–05)按表查询条件导入<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 query=’where id=5’<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01,itpux02 remap_schema=system:itpux query=’where id=5’</p>\n<p>impdp itpux01/itpux01 directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log tables=itpux01 query=’where id=5’<br>impdp system/oracle directory=itpuxbak_dir dumpfile=expdp_tb_itpux01.dmp logfile=impdp_tb_itpux01.log TABLES=HR.EMPLOYEES,SH.SALES:SALES_1995 QUERY=HR.EMPLOYEES:”WHERE department_id &gt; 10”</p>\n<pre><code>\n### 3.3 oracle expdp/impdp补充\n```shell\n--01)directory\ncreate directory itpuxbak_dir as &#39;/backup&#39;;\n--drop directory itpuxbak_dir\nselect * from dba_directories\ngrant read,write on directory itpuxbak_dir to system; --system:itpux01:other users\ngrant create any directory to system;\nselect * from dba_sys_privs where grantee=&#39;SYSTEM&#39;;\n\n--02) sysdba full=y\nexpdp &quot;&#39;/as sysdba&#39;&quot; directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y --sys\n\n--03)查询datapump jobs\nselect * from dba_datapump_jobs;\nexpdp &quot;&#39;/as sysdba&#39;&quot; directory=itpuxbak_dir dumpfile=expdp_full_db01.dmp logfile=expdp_full_db01.log full=y job_name=itpuxexpjob;\n</code></pre><h2 id=\"4-配置生产环境的逻辑自动备份策略\"><a href=\"#4-配置生产环境的逻辑自动备份策略\" class=\"headerlink\" title=\"4.配置生产环境的逻辑自动备份策略\"></a>4.配置生产环境的逻辑自动备份策略</h2><blockquote>\n<p>每天做逻辑备份，数据量大小500G，保留2天，空间准备2TB<br>我的库不开归档的，不能在线做RMAN。<br><code>`</code>shell<br>create directory itpuxbak_dir as ‘/backup’;<br>grant read,write on directory itpuxbak_dir to system;<br>grant create any directory to system;</p>\n</blockquote>\n<p>#vi expdpfull_db01.sh<br>export BAKDATE=<code>date +%Y%m%d</code><br>expdp system/oracle directory=itpuxbak_dir dumpfile=expdp_full_db01.$BAKDATE.%U.dmp logfile=expdp_full_db01.$BAKDATE.log full=y parallel=4<br>find /backup -name expdp_full_db01.*.dmp -atime +2 -exec rm -rf {} \\;</p>\n<p>#–cluster=N</p>\n<p>#chown -R oracle:dba /backup</p>\n<p>#chmod -R 775 /backup</p>\n<p>#crontab -e<br>0 20 <em> </em> * su - oracle -c /backup/scripts/expdpfull_db01.sh</p>\n<pre><code>* --报错的处理：\n```shell\nORA-39181: Only partial table data may be exported due to fine grain access control on &quot;OE&quot;.&quot;PURCHASEORDER&quot;\nselect count(*) from &quot;OE&quot;.&quot;PURCHASEORDER&quot;\ngrant EXEMPT ACCESS POLICY to system;\nexpdp system/oracle directory=itpuxbak_dir dumpfile=test-b.dmp logfile=test-b.log tables=OE.PURCHASEORDER\n</code></pre><h2 id=\"5-expdp-impdp生产环境数据迁移流程\"><a href=\"#5-expdp-impdp生产环境数据迁移流程\" class=\"headerlink\" title=\"5.expdp/impdp生产环境数据迁移流程\"></a>5.expdp/impdp生产环境数据迁移流程</h2><ul>\n<li><p>5.1、做数据迁移流程的目的</p>\n<blockquote>\n<p>使用expdp/impdp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障</p>\n</blockquote>\n</li>\n<li><p>5.2、数据迁移的适用范围</p>\n<blockquote>\n<p>所有线上库&gt;10.2</p>\n</blockquote>\n</li>\n<li><p>5.3、 数据迁移的风险评估</p>\n<blockquote>\n<p>01.有些os对文件大小有限制，expdp数据时需要使用filesize参数来分割导出文件<br>02.expdp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。<br>03.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。<br>04.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错</p>\n</blockquote>\n</li>\n<li><p>5.4、数据迁移的准备工作</p>\n<blockquote>\n<p>01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用expdp/impdp迁移数据。<br>02.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。<br>03.表比较多的情况下，建议用parfile。各个参数在parfile里写好。<br>04.提前准备备份脚本（parfile参数）：<br><code>`</code>shell<br>cat expdp_itpux.par<br>userid=system/oracle<br>directory=itpuxbak_dir<br>dumpfile=expdp_full_db01.$BAKDATE.%U.dmp<br>logfile=expdp_full_db01.$BAKDATE.log<br>tables=user.tab1,user.tab2,user.tab3<br>parallel=4</p>\n</blockquote>\n</li>\n</ul>\n<p>vi expdp.sh</p>\n<p>export BAKDATE=<code>date +%Y%m%d</code><br>expdp parfile=expdp_itpux.par<br>nohup ./expdp.sh &amp;</p>\n<pre><code>\n* 5.5、数据迁移的执行过程\n\n\n* 5.6、数据迁移后的验证方案\n&gt;对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n编译无效对象\n\n\n## 6.expdp/impdp生产环境数据迁移案例\n&gt;迁移过程详细请看视频演示，此处只做参考\n### 6.1 迁移目的\n&gt;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过ExpDP全库迁移到另一台oracle服务器，并能正常查询到相关数据。\n&gt;IMPDP虽然加上parallel参数，在做table数据导入时确实速度提高了不少，但是在create index和statistics时，依旧采用单线程的方式，故此一般在迁移过程中这两步操作选择生产DDL脚本增加parallel参数后手工执行，以最大化缩减迁移时间。\n### 6.2 迁移流程\n```sql\n1.linux系统oracle服务器上创建测试数据。\n2.linux本地用Expdp做导出;\n3.远程主机创建相关对象；\n4.远程主机用expdp做导入(导入);\n5.验证远程本地数据合法性;\n</code></pre><h3 id=\"6-3-演示过程\"><a href=\"#6-3-演示过程\" class=\"headerlink\" title=\"6.3 演示过程\"></a>6.3 演示过程</h3><ul>\n<li>01.准备数据<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 21:28:32 (QP5 v5.313) </em>/<br>CREATE TABLESPACE itpux11<br>  DATAFILE ‘/oracle/oradata/db01/itpux01.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;<br>CREATE TABLESPACE itpux12<br>  DATAFILE ‘/oracle/oradata/db01/itpux02.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;<br>–创建用户并授权<br>CREATE USER itpux01 IDENTIFIED BY itpux01<br>  DEFAULT TABLESPACE itpux01;<br>CREATE USER itpux02 IDENTIFIED BY itpux02<br>  DEFAULT TABLESPACE itpux02;<br>GRANT DBA TO itpux01;<br>GRANT DBA TO itpux02;</li>\n</ul>\n<p>ALTER USER itpux01<br>    QUOTA UNLIMITED ON itpux01;</p>\n<p>ALTER USER itpux02<br>    QUOTA UNLIMITED ON itpux02;</p>\n<p>–用户登录并创建测试表<br>CONN itpux01 / itpux01</p>\n<p>CREATE TABLE itpux01<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<p>CONN itpux02 / itpux02</p>\n<p>CREATE TABLE itpux02<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<p>–要建两个索引</p>\n<p>CREATE INDEX itpux02<br>    ON itpux02_table_test (id);</p>\n<p>–创建2个存储过程并执行。<br>CONN itpux01 / itpux01</p>\n<p>CREATE OR REPLACE PROCEDURE p_itpux01<br>IS<br>BEGIN<br>    EXECUTE IMMEDIATE ‘select count(*) from itpux01’;</p>\n<pre><code>FOR i IN 1 .. 1000\nLOOP\n    INSERT INTO itpux01 (id, name)\n         VALUES (i, SYSDATE);\n\n    COMMIT;\nEND LOOP;\n\nEXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\n</code></pre><p>END p_itpux01;<br>/</p>\n<p>BEGIN<br>    p_itpux01;<br>END;<br>/</p>\n<p>SELECT COUNT (*) FROM itpux01;</p>\n<p>SELECT *<br>  FROM itpux01<br> WHERE id &gt; 990;</p>\n<p>CONN itpux02 / itpux02</p>\n<p>CREATE OR REPLACE PROCEDURE p_itpux02<br>IS<br>BEGIN<br>    EXECUTE IMMEDIATE ‘select count(*) from itpux02’;</p>\n<pre><code>FOR i IN 1 .. 2000\nLOOP\n    INSERT INTO itpux02 (id, name)\n         VALUES (i, SYSDATE);\n\n    COMMIT;\nEND LOOP;\n\nEXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\n</code></pre><p>END p_itpux02;<br>/</p>\n<p>BEGIN<br>    p_itpux02;<br>END;<br>/</p>\n<pre><code>* 查询验证数据\n```sql\n/* Formatted on 2018/1/30 21:31:51 (QP5 v5.313) */\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id &gt; 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id &gt; 1990;\n\n--02.获取DDL\n--在源主机获取：\nSPOOL itpux_tbs_create_ddl.sql\nSET LONG 200000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 200\n\nSELECT DBMS_METADATA.get_ddl (&#39;TABLESPACE&#39;, &#39;ITPUX01&#39;) FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl (&#39;TABLESPACE&#39;, &#39;ITPUX02&#39;) FROM DUAL;\n\nSPOOL OFF;\n--在另一台主机执行：\nCREATE TABLESPACE &quot;ITPUX01&quot;\n    DATAFILE &#39;/oracle/oradata/db01/itpux01.dbf&#39;\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\nCREATE TABLESPACE &quot;ITPUX02&quot;\n    DATAFILE &#39;/oracle/oradata/db01/itpux02.dbf&#39;\n                 SIZE 50 M\n    LOGGING\n    ONLINE\n    PERMANENT\n    BLOCKSIZE 8192\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    DEFAULT\n    NOCOMPRESS\n    SEGMENT SPACE MANAGEMENT AUTO;\n--03、源库导出\n建立目录（建立directory）\nSQL&gt; CREATE OR REPLACE DIRECTORY oradmp AS &#39;/oracle/backup&#39;;\nSQL&gt; GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\nexpdp SYSTEM/oracle DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=expdpfull_db01.LOG PARALLEL=2;\n--04、目标库导入\n禁止自动维护任务\n（禁用数据库自动维护任务，oracle11g中存在）\nSQL&gt; EXECUTE DBMS_AUTO_TASK_ADMIN.DISABLE;\n建立目录（建立directory）\nSQL&gt; CREATE OR REPLACE DIRECTORY oradmp AS &#39;/oracle/backup&#39;;\nSQL&gt; GRANT READ,WRITE ON DIRECTORY oradmp TO SYSTEM;\n生成index、CONSTRAINT的ddl语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp dumpfile=itpux_01.dmp,itpux_02.dmp LOGFILE=impitpux.LOG PARALLEL=2 SQLFILE=indconddl.SQL INCLUDE=INDEX,CONSTRAINT SCHEMAS=itpux\n编辑ddl语句脚本\nsed &#39;s/NOLOGGING/ /g;s/LOGGING/ /g&#39; indconddl.SQL&gt;indconddl.sql.nologin\nsed &#39;/TABLESPACE/ s/TS_itpux/TS_itpux_INDEX/g;/TABLESPACE/ s/1/32 NOLOGGING/g&#39; indconddl.sql.nologin&gt;indconddl.sql.NEW\n设置parallel 4;\n执行导入语句\nimpdp SYSTEM/SYSTEM DIRECTORY=oradmp FULL=y dumpfile=expdpfull_db01_%U.dmp LOGFILE=impdpfull_db01.LOG PARALLEL=2\nEXCLUDE=INDEX,CONSTRAINT,STATISTICS SCHEMAS=ITPUX;\n检查job，延后迁移时间内发起的job任务\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n执行ddl语句脚本，建立索引、约束，手工发起统计分析\n建立索引、约束\nchmod +x indconddl.sql.NEW\n more createindcon.sh\nSQLPLUS -s /nolog &lt;&lt;EOS\nCONNECT itpux / itpux\nSPOOL /tmp/indconcreate.log\n@ /oracle/backup/indconddl.sql.new;\nSPOOL OFF\nEXIT\nEOS\n执行createindcon.sh\n然后再改parallel 4;为NOPARALLEL\n--05、收集统计信息\nstats.SQL:\n\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nnohup sqlplus &quot;/as sysdba&quot; @ stats.SQL &amp;\n--06、无效对象的编译\n自动生成编译无效对象SQL及编译过程\n1) 统计当前用户无效对象数量:\n  SELECT OWNER,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status &lt;&gt; &#39;VALID&#39;\nGROUP BY OWNER, object_type, status\nORDER BY OWNER, object_type;\n2) 生成编译无效对象SQL\nSELECT    &#39;ALTER &#39;\n       || OBJECT_TYPE\n       || &#39; &#39;\n       || OWNER\n       || &#39;.&#39;\n       || OBJECT_NAME\n       || &#39; COMPILE;&#39;\n  FROM dba_objects\n WHERE     status &lt;&gt; &#39;VALID&#39;\n       AND object_type IN (&#39;PACKAGE&#39;,\n                           &#39;PACKAGE BODY&#39;,\n                           &#39;FUNCTION&#39;,\n                           &#39;PROCEDURE&#39;,\n                           &#39;TRIGGER&#39;,\n                           &#39;VIEW&#39;);\n通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n# su - oracle\n$ sqlplus / as sysdba\nSQL&gt; @$ORACLE_HOME/rdbms/ADMIN/utlrp.SQL\n--07、验证数据\n对比expdp、impdp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n\nSELECT COUNT (*) FROM itpux.itpux01;\n\nSQL&gt;SELECT OWNER,OBJECT_TYPE,COUNT(*) FROM dba_objects WHERE wner=&#39;&amp;owner&#39; GROUP BY OWNER,OBJECT_TYPE ORDER BY OBJECT_TYPE;\n跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n检查对象状态\nSQL&gt;SELECT OWNER,OBJECT_NAME,SUBOBJECT_NAME,STATUS,OBJECT_TYPE FROM dba_objects WHERE wner=&#39;&amp;owner&#39; ORDER BY OBJECT_TYPE, OBJECT_NAME, SUBOBJECT_NAME;\n\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = &#39;ITPUX01&#39;\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = &#39;ITPUX01&#39;\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status &lt;&gt; &#39;VALID&#39; AND owner = &#39;ITPUX01&#39;;\n\n--08、收尾\n启用数据库自动维护任务\nSQL&gt; EXECUTE DBMS_AUTO_TASK_ADMIN.ENABLE;\n检查并更正job运行时间\n\nSELECT JOB,\n       LOG_USER,\n       SCHEMA_USER,\n       what,\n       LAST_DATE,\n       LAST_SEC,\n       NEXT_DATE,\n       NEXT_SEC,\n       FAILURES,\n       BROKEN\n  FROM DBA_JOBS;\n\n--09、对外应用测试\n</code></pre><h2 id=\"7-expdp-impdp迁移过程字符集的处理\"><a href=\"#7-expdp-impdp迁移过程字符集的处理\" class=\"headerlink\" title=\"7.expdp/impdp迁移过程字符集的处理\"></a>7.expdp/impdp迁移过程字符集的处理</h2><blockquote>\n<p>进行数据的导入导出时，我们要注意关于字符集的问题。在EXPDP/IMPDP过程中我们需要注意四个字符集的参数：</p>\n<pre><code class=\"sql\">01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n05.导入端数据库字符集。\n</code></pre>\n<ul>\n<li>查看数据库的字符集的信息<pre><code class=\"sql\">SQL&gt; select * from nls_database_parameters;\n//SQL&gt; select * from props$;\nNLS_LANGUAGE AMERICAN\nNLS_TERRITORY AMERICA\nNLS_CURRENCY $\nNLS_ISO_CURRENCY AMERICA\nNLS_NUMERIC_CHARACTERS .,\nNLS_CHARACTERSET ZHS16GBK\nNLS_CALENDAR GREGORIAN\nNLS_DATE_FORMAT DD-MON-RR\nNLS_DATE_LANGUAGE AMERICAN\nNLS_SORT BINARY\nNLS_TIME_FORMAT HH.MI.SSXFF AM\nNLS_TIMESTAMP_FORMAT DD-MON-RR HH.MI.SSXFF AM\nNLS_TIME_TZ_FORMAT HH.MI.SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT DD-MON-RR HH.MI.SSXFF AM TZR\nNLS_DUAL_CURRENCY $\nNLS_COMP BINARY\nNLS_LENGTH_SEMANTICS BYTE\nNLS_NCHAR_CONV_EXCP FALSE\nNLS_NCHAR_CHARACTERSET AL16UTF16\nNLS_RDBMS_VERSION 11.2.0.3.0\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li>我们再来查看客户端的字符集信息<pre><code class=\"shell\">客户端字符集的参数NLS_LANG=_&lt; territory &gt;.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n如数据库语言环境\nos是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\nos是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n永久修改可用：\nvi bash_profile\n通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n</code></pre>\n<blockquote>\n<p>(1) 源数据库和目标数据库具有相同的字符集设置。<br>这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。<br>(2) 源数据库和目标数据库字符集不同。<br>先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。<br>这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"8-expdp与impdp-版本兼容性与各版本的区别\"><a href=\"#8-expdp与impdp-版本兼容性与各版本的区别\" class=\"headerlink\" title=\"8.expdp与impdp 版本兼容性与各版本的区别\"></a>8.expdp与impdp 版本兼容性与各版本的区别</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-288-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-288-1-1.html</a></p>\n<h2 id=\"9-如何停止expdp与impdp备份任务的后台进程\"><a href=\"#9-如何停止expdp与impdp备份任务的后台进程\" class=\"headerlink\" title=\"9.如何停止expdp与impdp备份任务的后台进程\"></a>9.如何停止expdp与impdp备份任务的后台进程</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-286-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-286-1-1.html</a></p>\n<h2 id=\"10-如何清理不需要的数据泵job\"><a href=\"#10-如何清理不需要的数据泵job\" class=\"headerlink\" title=\"10.如何清理不需要的数据泵job\"></a>10.如何清理不需要的数据泵job</h2><p>参考资料：<br><a href=\"http://www.itpux.com/thread-287-1-1.html\" target=\"_blank\" rel=\"noopener\">http://www.itpux.com/thread-287-1-1.html</a></p>\n<h2 id=\"11-如何对expdp-impdp进行trace跟踪分析问题\"><a href=\"#11-如何对expdp-impdp进行trace跟踪分析问题\" class=\"headerlink\" title=\"11.如何对expdp/impdp进行trace跟踪分析问题\"></a>11.如何对expdp/impdp进行trace跟踪分析问题</h2><h3 id=\"11-1-使用Trace-480300\"><a href=\"#11-1-使用Trace-480300\" class=\"headerlink\" title=\"11.1 使用Trace 480300\"></a>11.1 使用Trace 480300</h3><blockquote>\n<p>&emsp;&emsp;Data Pump工作原理有两个特点：作业调度，多进程配合协作。对Data Pump的诊断本质上就是对各种Process行为的跟踪。Oracle提供了一个Trace的隐含参数，来帮助我们实现这个目标。<br>&emsp;&emsp;Trace并不像其他跟踪过程相同，使用y/n的参数，开启或者关闭。Data Pump的Trace参数是一个7位十六进制组成的数字串。不同的数字串表示不同的跟踪对象方法。7位十六进制数字分为两个部分，前三个数字表示特定的数据泵组件，后四位使用0300就可以。</p>\n</blockquote>\n<ul>\n<li>各个组件分别使用不同的三位十六进制数字代表。如下片段所示<br><code>`</code>shell<br>– Summary of Data Pump trace levels:<br>– ==================================<br>Trace DM DW ORA Lines<br>level trc trc trc in<br>(hex) file file file trace Purpose</li>\n</ul>\n<hr>\n<p>10300 x x x SHDW: To trace the Shadow process (API) (expdp/impdp)<br>20300 x x x KUPV: To trace Fixed table<br>40300 x x x ‘div’ To trace Process services<br>80300 x KUPM: To trace Master Control Process (MCP) (DM)<br>100300 x x KUPF: To trace File Manager<br>200300 x x x KUPC: To trace Queue services<br>400300 x KUPW: To trace Worker process(es) (DW)<br>800300 x KUPD: To trace Data Package<br>1000300 x META. To trace Metadata Package<br>— +<br>1FF0300 x x x ‘all’ To trace all components (full tracing)</p>\n<pre><code>&gt;如果需要同时跟踪多个组件，需要将目标组件的hex值进行累加，后面四位的300相同。\n&gt;400300+80300=480300\n&gt;&amp;emsp;&amp;emsp;对于跟踪的Trace取值，Oracle建议使用480300就可以应对大部分的情况。480300会跟踪Oracle Dump作业的Master Control Process（MCP）和Work Process。作为初始化跟踪的过程，480300基本就够用了。\n&gt;我们先从数据导出Expdp看Trace，导出一个案例。首先清理一下Trace File目录\n```sql\nexpdp \\&quot;/ as sysdba\\&quot; directory=dumpdir schemas=itpux dumpfile=itpux_dump.dmp parallel=2 trace=480300\n</code></pre><blockquote>\n<p>&emsp;&emsp;然后检查trc目录，Dm和dw标注的就是MCP和Work Process生成的Trace文件。同时Parallel设置使得dw有00和01两个。<br>2个trace 文件在BACKGROUND_DUMP_DEST目录下：</p>\n<pre><code class=\"sql\">Master Process trace file: &lt;SID&gt;_dm&lt;number&gt;_&lt;process_id&gt;.trc\nWorker Process trace file: &lt;SID&gt;_dw&lt;number&gt;_&lt;process_id&gt;.trc\n</code></pre>\n<p>在导出过程中，我们可以看到两个worker的会话信息。<br><code>`</code>sql<br>SQL&gt; select * from dba_datapump_sessions;<br>OWNER_NAME JOB_NAME INST_ID SADDR SESSION_TYPE</p>\n</blockquote>\n<hr>\n<p>SYS SYS_EXPORT_SCHEMA_01 1 35EB0580 DBMS_DATAPUMP<br>SYS SYS_EXPORT_SCHEMA_01 1 35E95280 MASTER<br>SYS SYS_EXPORT_SCHEMA_01 1 35E8A480 WORKER<br>SYS SYS_EXPORT_SCHEMA_01 1 35E84D80 WORKER</p>\n<pre><code>&gt;&amp;emsp;&amp;emsp;此时我们可以从Trace文件中，看到一些Data Pump工作的细节信息。例如：在MCP的Trace文件中，我们看到一系列调用动作过程，如下片段：\n--初始化导出动作，整理文件系统；\n-日志写入\n在Worker Process中，如下片段看出在导出数据。\n### 11.2 使用Trace 480301\n&gt;&amp;emsp;&amp;emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。\n&gt;切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。\n```sql\nimpdp \\&quot;/ as sysdba\\&quot; directory=dumpdir dumpfile=itpux_dump.dmp remap_schema=itpux:test trace=480301 parallel=2\n</code></pre><blockquote>\n<p>&emsp;&emsp;在Trace过程中，我们也可以如10046跟踪过程一样，添加SQL跟踪。Data Pump本质上工作还是一系列的SQL语句，很多时候的性能问题根源都是从SQL着手的。<br>切换到SQL跟踪模式也比较简单，一般是在Trace数值后面添加1。我们使用导入过程进行实验。<br>&emsp;&emsp;目录生成的Trace文件，都是10046格式的Raw文件。截取片段如下：<br>10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。</p>\n<pre><code class=\"sql\">$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux__dw01_17294.out waits=y sort=exeela\n</code></pre>\n</blockquote>\n<h3 id=\"11-3-使用10046事件\"><a href=\"#11-3-使用10046事件\" class=\"headerlink\" title=\"11.3.使用10046事件\"></a>11.3.使用10046事件</h3><ul>\n<li>10046 事件有如下级别<pre><code class=\"shell\">event 10046, level 1 = enable standardSQL_TRACE functionality\nevent 10046, level 4 = as level 1, plus trace the BIND values\nevent 10046, level 8 = as level 1, plus trace the WAITs\nevent 10046, level 12 = as level 1, plus trace the BIND values and the WAITs\n</code></pre>\n</li>\n<li>不同级别的使用情况如下<pre><code class=\"shell\">level 1: lowest level tracing - not alwayssufficient to determine cause of errors;\nlevel 4: useful when an error in DataPump&#39;s worker or master process occurs;\nlevel 12: useful when there is an issuewith Data Pump performance.\n</code></pre>\n</li>\n<li>注意：<blockquote>\n<p>&emsp;&emsp; 当我们设置10046的级别高于8或者12的时候，需要将TIMED_STATISTICS设置为TRUE. 临时的将这个参数设置为true，可以将trace数据性能的影响降到最低，在11gR2里，该参数默认为true。<br>一般只有遇到性能问题时，才会使用8或者12的level。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"11-4-日常使用\"><a href=\"#11-4-日常使用\" class=\"headerlink\" title=\"11.4 日常使用\"></a>11.4 日常使用</h3><ul>\n<li>01、对当前正在运行的进程进行trace<br><code>`</code>sql</li>\n</ul>\n<p>–查看数据泵进程的信息：<br>SET LINES 150 PAGES 100 NUMWIDTH 7<br>COL username FOR a10<br>COL spid FOR a7<br>COL program FOR a25</p>\n<p>SELECT TO_CHAR (SYSDATE, ‘YYYY-MM-DDHH24:MI:SS’) “DATE”,<br>       s.program,<br>       s.sid,<br>       s.status,<br>       s.username,<br>       d.job_name,<br>       p.spid,<br>       s.serial#,<br>       p.pid<br>  FROM v$session s, v$process p, dba_datapump_sessions d<br> WHERE p.addr = s.paddr<br> ands.saddr=d.saddr;</p>\n<pre><code>&gt;使用sys.dbms_system.set_ev设置10046\n&gt;在上节的查询结果里：\nData Pump Master process (DM00)的SID 是58，serial#是85.\nData Pump Worker process (DW01)的SID 是23，serial#是311.\n\n&gt;使用10046 跟踪活动session的语法如下\n```sql\nSyntax: DBMS_SYSTEM.SET_EV([SID],[SERIAL#],[EVENT],[LEVEL],&#39;&#39;)\n\n--在level 4跟踪Worker process进程(Bind values)：\nexecute sys.dbms_system.set_ev(23,311,10046,4,&#39;&#39;);\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(23,311,10046,0,&#39;&#39;);\n\n--在level 8 跟踪Master进程（Waits）：\nexecute sys.dbms_system.set_ev(143,50,10046,8,&#39;&#39;);\n\n-- stop tracing:\nexecute sys.dbms_system.set_ev(143,50,10046,0,&#39;&#39;);\n</code></pre><ul>\n<li>02、使用oradebug<blockquote>\n<p>可以在oradebug中设置SPID，来进行trace<br><code>`</code>sql<br>–在level 4跟踪Worker process进程(Bind values)：<br>oradebug setospid 8173<br>oradebug unlimit<br>oradebug event 10046 trace name context forever, level 4<br>oradebug tracefile_name</p>\n</blockquote>\n</li>\n</ul>\n<p>–在level 8 跟踪Master进程（Waits）：<br>oradebug setospid 8171<br>oradebug unlimit<br>oradebug event 10046 trace name context forever, level 8<br>oradebug tracefile_name</p>\n<p>–stop tracing:<br>oradebug event 10046 trace name context off ITPUX</p>\n<pre><code>\n* 03、使用tkprof 分析trace文件\n&gt;10046 生成的trace 文件可读性并不好，所有我们可以使用tkprof工具进行格式化，方便阅读。\n```sql\n$ tkprof itpux_dm00_17292.trc tkprof_itpux_dm00_17292.out waits=y sort=exeela\n$ tkprof itpux_dw01_17294.trc tkprof_itpux_dw01_17294.out waits=y sort=exeela\n</code></pre><h2 id=\"12-expdp-impdp使用总结\"><a href=\"#12-expdp-impdp使用总结\" class=\"headerlink\" title=\"12.expdp/impdp使用总结\"></a>12.expdp/impdp使用总结</h2><ul>\n<li>1.expdp/impdp 默认就是使用直接路径的，所以速度比较快，但是expdp/impdp 是服务端程序，影响它速度的只有磁盘io。</li>\n<li>2.导出多表时，expdp/impdp用法是tables=’table1’,’table2’,’table3’。</li>\n<li>3.dumpfile 参数 ，可以用%u 指定多个数据文件<pre><code class=\"sql\">expdp xxx/xxx schemas=xxx directory=dump1 dumpfile=xxx_%u.dmp filesize=50g\n</code></pre>\n<blockquote>\n<p>这样每个文件50g ，xxx_01.dump,xxx_02.dump 这样。</p>\n</blockquote>\n</li>\n<li>4.如果要把用户usera的对象导到用户userb，操作如下：<pre><code class=\"shell\">impdp system/passwd directory=expdp dumpfile=expdp.dmp remap_schema=&#39;usera&#39;:&#39;userb&#39; logfile=/oracle/exp.log;\n</code></pre>\n</li>\n<li><p>5.如果导入需要更换表空间，impdp用remap_tablespace=’tabspace_old’:’tablespace_new’</p>\n</li>\n<li><p>6.关于数据导出时要导出哪些内容</p>\n<blockquote>\n<p>expdp content（all:对象＋导出数据行，data_only：只导出对象，metadata_only：只导出数据的记录）</p>\n</blockquote>\n</li>\n<li>7、数据泵expdp/impdp 影响速度和性能最大的就是paralle。 所以使用数据泵，要想提高速度，就要设置并行参数。如：<blockquote>\n<p>&emsp;&emsp; expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4<br>那么expdp将为parallel 创建4个文件： test_01.dmp，test_02.dmp，test_03.dmp，test_04.dmp。 每个进程一个文件。 这样的话，每个文件的大小会因进程而不同。 可以某个文件很大，某个文件却很小。 要解决这个问题，就是设置filesize 参数。 来指定每个文件的最大值。 这样当一个文件达到最大值的之后，就会创建一个新的文件。</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>&emsp;&emsp;如：expdp full=y directory=dump dumpfile=test_%u.dmp parallel=4 filesize=50m<br>导出的dump文件和paralle有关系，那么导入也有关系。 paralle要小于dump文件数。 如果paralle 大于dump文件的个数，就会因为超过的那个进程获取不到文件，就不能对性能提高。一般parall 参数值等于cpu 的个数。而且要小于dump文件的个数。</p>\n</blockquote>\n"},{"title":"Oracle数据库逻辑备份恢复迁移之exp与imp","date":"2018-10-02T06:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle数据库逻辑备份恢复迁移之exp与imp\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.export与import逻辑备份恢复概述\n### 1.1 备份概述\n* 备份可分为两类，物理备份和逻辑备份\n>&emsp;&emsp;物理备份：该方法实现数据库的完整恢复，但需要极大的外部存储设备，例如磁带库，具体包括冷备份和热备份。冷备份和热备份(热备份要求数据库运行在归档模式下)都是物理备份，它涉及到组成数据库的文件，但不考虑逻辑内容。\n>&emsp;&emsp;逻辑备份： 使用软件技术从数据库中导出数据并写入一个输出文件，该文件的格式一般与原数据库的文件格式不同，只是 原数据库中数据内容的一个映像。因此，逻辑备份文件只能用来对数据库进行逻辑恢复，即数据导入，而不能按数据库原来的存储特征进行物理恢复。逻辑备份一般 用于增量备份，即备份那些在上次备份以后改变的数据。\n>&emsp;&emsp;Oracle 的导出导入是一个很常用的迁移工具。 在Oracle 10g以后，Oracle 推出了数据泵(expdp/impdp).它可以通过使用并行，从而在效率上要比exp/imp 要高。但是这个exp/imp很多时候还需要使用。\n>&emsp;&emsp;导入/导出是ORACLE幸存的最古老的两个命令行工具，其实我从来不认为Exp/Imp是一种好的备份方式，正确的说法是Exp/Imp只能是一个好的转储工具，特别是在小型数据库的转储，表空间的迁移，表的抽取，检测逻辑和物理冲突等中有不小的功劳。当然，我们也可以把它作为小型数据库的物理备份后的一个逻辑辅助备份，也是不错的建议。对于越来越大的数据库，特别是TB级数据库和越来越多数据仓库的出现，EXP/IMP越来越力不从心了，这个时候，数据库的备份都转向了RMAN和第三方工具。下面说明一下EXP/IMP的使用。\n\n## 2.export与import参数详解\n### 2.1 export参数详解\n```shell\n[oracle@orcl:/]$exp -help\n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 18:30:39 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Export prompt you for parameters by entering the EXP\ncommand followed by your username/password:\n\n     Example: EXP SCOTT/TIGER\n\nOr, you can control how Export runs by entering the EXP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  EXP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: EXP SCOTT/TIGER GRANTS=Y TABLES=(EMP,DEPT,MGR)\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword    Description (Default)      Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID     username/password          FULL         export entire file (N)\nBUFFER     size of data buffer        OWNER        list of owner usernames\nFILE       output files (EXPDAT.DMP)  TABLES       list of table names\nCOMPRESS   import into one extent (Y) RECORDLENGTH length of IO record\nGRANTS     export grants (Y)          INCTYPE      incremental export type\nINDEXES    export indexes (Y)         RECORD       track incr. export (Y)\nDIRECT     direct path (N)            TRIGGERS     export triggers (Y)\nLOG        log file of screen output  STATISTICS   analyze objects (ESTIMATE)\nROWS       export data rows (Y)       PARFILE      parameter filename\nCONSISTENT cross-table consistency(N) CONSTRAINTS  export constraints (Y)\n\nOBJECT_CONSISTENT    transaction set to read only during object export (N)\nFEEDBACK             display progress every x rows (0)\nFILESIZE             maximum size of each dump file\nFLASHBACK_SCN        SCN used to set session snapshot back to\nFLASHBACK_TIME       time used to get the SCN closest to the specified time\nQUERY                select clause used to export a subset of a table\nRESUMABLE            suspend when a space related error is encountered(N)\nRESUMABLE_NAME       text string used to identify resumable statement\nRESUMABLE_TIMEOUT    wait time for RESUMABLE \nTTS_FULL_CHECK       perform full or partial dependency check for TTS\nVOLSIZE              number of bytes to write to each tape volume\nTABLESPACES          list of tablespaces to export\nTRANSPORT_TABLESPACE export transportable tablespace metadata (N)\nTEMPLATE             template name which invokes iAS mode export\n\nExport terminated successfully without warnings.\n```\n* EXP的所有参数（括号中为参数的默认值）：\n>可以通过exp help=y或者imp help=y查看exp或imp的详细参数，下面以exp为例解释参数意义\nUSERID：用户名/口令\n\n>FULL：导出整个数据库，只有拥有exp_full_database角色的用户或者特权用户如sys，system等才能进行全库导出。 示例如下\nexp \"'/ as sysdba'\" full=y\n\n>BUFFER：制定数据缓冲区大小，主要用于提高exp/imp速度，该单位为字节，不能写成buffer=1m的形式，应写成字节为单位的参数，如buffer=1048576\nexp hr/hr file=t_b.dmp buffer= 1048576 tables=T\n\n>OWNER：需要导出的用户，示例如下\nexp \"'/ as sysdba'\" owner=\\(hr,ITPUX02\\) file=hr_ITPUX02.dmp\n上例中由于是在linux平台进行测试的，需要对 owner=\\(hr,ITPUX02\\)使用\\进行转义\n\n>FILE：输出文件\n\n>TABLES：需要导出的表\n\n>COMPRESS：导入到一个区 (Y) 。主要目的是为了消除存储碎片，以保证某张表的所有记录都存储在连续的空间里。 但是负面效应很明显， 如果该参数值为y，则会将高水位线以下的所有extent导入到一个区中， 因此在导入时很有可能出现，明明表中数据很少，但是却花了很多时间在建立的extent上。 且自oracle9i开始，使用了本地管理的表空间，存储碎片的问题应该比低版本好多了，个人建议将compress设为n。\n\n* DIRECT：直接路径 (N)。\n>传统模式导出和直接路径导出的原理\n传 统模式导出相当于使用select语句从表中取出数据，数据从磁盘上先读到buffer cache中，记录被转移到一个评估检测的缓冲区中，数据经过语法检测后没有问题，将数据传给PGA，最后写入导出的文件中。如果使用Direct Path模式导出，数据直接从磁盘上读取到导出的PGA中：记录直接被转换导出会话的私有buffer中。这也就是意味着SQL语句处理层被忽略掉了，因 为数据已经是符合导出的格式了，不需要其他的转换处理了。数据直接被传送给导出的客户端，最后写入导出文件。过程可概况如下\n```shell\ndirect=n datafile---->sga----->pga----->dump\ndirect=y datafile---->pga----->dump\n```\n>传统路径导出VS直接路径导出(oracle exp direct=y)两者的差异\n>a、 Conventional path Export\n&emsp;&emsp; 传统路径模式使用SQL SELECT语句抽取表数据。数据从磁盘读入到buffer cache缓冲区中，行被转移到评估缓冲区。在此之后根据SQL表达式，将记录返回给导出客户端，然后写入到dump文件。\n>b、Direct path Export\n&emsp;&emsp; 直接导出模式，数据直接从磁盘中读取到导出session的PGA中，行被直接转移到导出session的私有缓冲区，从而跳过SQL命令处理层。\n避免了不必要的数据转换。最后记录返回给导出客户端，写到dump文件。\n\n* 传统路径导出VS直接路径导出(oracle exp direct=y)性能问题\n>&emsp;&emsp; a、直接路径导出方式比传统路径方式具有更优的性能，速度更快，因为绕过了SQL命令处理部分。\n&emsp;&emsp; b、直接路径导出方式支持RECORDLENGTH参数(最大为64k)，该参数值通常建议设置为系统I/O或者DB_BLOCK_SIZE的整数倍\n&emsp;&emsp; c、影响直接路径导出的具体因素(DB_BLOCK_SIZE，列的类型，I/O性能，即数据文件所在的磁盘驱动器是否单独于dump文件所在的磁盘驱动器)\n&emsp;&emsp; d、无论是直接路径导出还是传统路径导出产生的dump，在使用imp方式导入时，会耗用相同的时间.\n\n* 传统路径导出VS直接路径导出(oracle exp direct=y)直接路径导出的限制\n>a、直接路径导出不支持交互模式\nb、不支持表空间传输模式(即transport_tablespaces=y不被支持)，支持的是full,owner,tables导出方式\nc、不支持query查询方式，如exp scott/tiger tables=emp query=\\\"where job=\\'salesman\\' \\\" 不被支持\nd、直接路径导出使用recordlength设置一次可以导出数据的量，取代传统路径使用buffer的设置\ne、直接路径导出要求nls_lang环境参数等于数据库字符集，负责收到exp-41警告及exp-0终止错误\n\n>GRANTS：导出权限 (Y)\nINCTYPE：增量导出类型，已废除\nINDEXES：导出索引 (Y)\nRECORD：跟踪增量导出 (Y) ，已废除\nTRIGGERS：导出触发器 (Y)\nLOG：屏幕输出的日志文件\n\n>STATISTICS：在导出文件中保留对象的统计信息，默认值ESTIMATE，还可以为compute或者none。如果导出时出现\nEXP-00091: Exporting questionable statistics\n可以考虑将 STATISTICS设置为NONE\n>ROWS：确定表中的数据行是否导出，默认为Y，导出\n\n>QUERY：用于导出表的子集的select子句，示例如下\nexp hr/hr file=emp_q.dmp tables=employees query=\\\"where hire_date \\>to_date\\(\\'1999-01-01\\'\\,\\'yyyy-mm-dd\\'\\)\\\"\n\n* PARFILE：参数文件名，可以用如下方式导出\n```sql\nexp hr/hr parfile=parfile\n$ cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=(t,empl%s)\n```\n\n>使用parfile参数可以对频繁进行的导出操作进行反复调用，同时也可以避免不同操作系统之间需要对特定字符进行转义的烦恼，如下例\n```sql\nexp hr/hr parfile=parfile\n$cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=employees\nstatistics=none\nquery=\"where hire_date>to_date('1999-01-01','yyyy-mm-dd')\"\n```\n>CONSISTENT：在导出时，将影响正在导出的表的事务设为只读，主要作用于嵌套表和分区表，默认为N。\nCONSTRAINTS：导出的约束条件 (Y)\nOBJECT_CONSISTENT:只在对象导出期间设置为只读的事务处理 (N)\nFEEDBACK:每 x 行显示进度，默认为0\nFILESIZE：每个导出文件的最大大小\nFLASHBACK_SCN：用于将会话快照设置回以前状态的SCN\nFLASHBACK_TIME：用于获取最接近指定时间的SCN的时间\nRESUMABLE：遇到空间不足时的错误时挂起，默认为N，需与 RESUMABLE_NAME和 RESUMABLE_TIMEOUT一起使用\nRESUMABLE_NAME：用于标示哪个会话需要使用 RESUMABLE选项，格式为 User USERNAME (USERID), Session SESSIONID, Instance INSTANCEID\nRESUMABLE_TIMEOUT：RESUMABLE的等待时间，默认为7200s，如果在指定时间内未解决问题，则操作中断\n>TTS_FULL_CHECK：对TTS执行完整或部分相关性检查\nTABLESPACES：要导出的表空间列表，示例如下\nexp \"'/ as sysdba'\" file=t_ts.dmp tablespaces=(users,example)\nTRANSPORT_TABLESPACE 导出可传输的表空间元数据 (N)\n直接备份到磁带上\nexp icdmain/icd rows=y indexes=n compress=n buffer=65536 feedback=100000 file=/dev/rmt0 log=exp.log tables=(tab1,tab2,tab3)\n注：在磁盘空间允许的情况下，应先备份到本地服务器，然后再拷贝到磁带。出于速度方面的考虑，尽量不要直接备份到磁带设备\n\n### 2.2 import参数详解\n```sql\n[oracle@orcl:/]$imp -help\n\nImport: Release 11.2.0.4.0 - Production on Tue Jan 30 19:01:13 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Import prompt you for parameters by entering the IMP\ncommand followed by your username/password:\n\n     Example: IMP SCOTT/TIGER\n\nOr, you can control how Import runs by entering the IMP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  IMP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: IMP SCOTT/TIGER IGNORE=Y TABLES=(EMP,DEPT) FULL=N\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword  Description (Default)       Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID   username/password           FULL         import entire file (N)\nBUFFER   size of data buffer         FROMUSER     list of owner usernames\nFILE     input files (EXPDAT.DMP)    TOUSER       list of usernames\nSHOW     just list file contents (N) TABLES       list of table names\nIGNORE   ignore create errors (N)    RECORDLENGTH length of IO record\nGRANTS   import grants (Y)           INCTYPE      incremental import type\nINDEXES  import indexes (Y)          COMMIT       commit array insert (N)\nROWS     import data rows (Y)        PARFILE      parameter filename\nLOG      log file of screen output   CONSTRAINTS  import constraints (Y)\nDESTROY                overwrite tablespace data file (N)\nINDEXFILE              write table/index info to specified file\nSKIP_UNUSABLE_INDEXES  skip maintenance of unusable indexes (N)\nFEEDBACK               display progress every x rows(0)\nTOID_NOVALIDATE        skip validation of specified type ids \nFILESIZE               maximum size of each dump file\nSTATISTICS             import precomputed statistics (always)\nRESUMABLE              suspend when a space related error is encountered(N)\nRESUMABLE_NAME         text string used to identify resumable statement\nRESUMABLE_TIMEOUT      wait time for RESUMABLE \nCOMPILE                compile procedures, packages, and functions (Y)\nSTREAMS_CONFIGURATION  import streams general metadata (Y)\nSTREAMS_INSTANTIATION  import streams instantiation metadata (N)\nDATA_ONLY              import only data (N)\nVOLSIZE                number of bytes in file on each volume of a file on tape\n\nThe following keywords only apply to transportable tablespaces\nTRANSPORT_TABLESPACE import transportable tablespace metadata (N)\nTABLESPACES tablespaces to be transported into database\nDATAFILES datafiles to be transported into database\nTTS_OWNERS users that own data in the transportable tablespace set\n\nImport terminated successfully without warnings.\n```\n* IMP的所有参数（括号中为参数的默认值）：\n>i&emsp;&emsp;mp的参数和exp的大致相同，下面是常用参数的解释，与exp相同的这就不再赘述\n>&emsp;&emsp;ignore：Oracle在恢复数据的过程中，当导入某个表时，该表已经存在，就要根据ignore参数的设置来决定如何操作。若 ignore=y，Oracle不执行CREATE TABLE语句，直接将数据插入到表中，如果插入的记录违背了约束条件，比如主键约束，唯一索引等，则出错的记录不会插入，但合法的记录会添加到表中。若 ignore=n，Oracle不执行CREATE TABLE语句，同时也不会将数据插入到表中，而是忽略该表的错误，继续导入下一个表。 注\n意：如果表中的字段并没有唯一性约束，那么在使用ignore=y的情况下很有可能插入重复数据。\n>&emsp;&emsp;indexes：在恢复数据的过程中，若indexes=n，则表上的索引不会被恢复，但是对 LOB 索引, OID索引和 主键索引等系统自动生成的索引将无条件恢复。\n>&emsp;&emsp;indexfile：不进行导入操作而是将创建对象的文本保存到文件中，可以通过编辑使用该文本文件创建数据库对象。\n>&emsp;&emsp;fromuser,touser:这两个参数可以组合使用，也可以分开使用。他们可以实现将源用户的对象数据，导入到目标用户schema底下的功能。这里要注意，导入时的用户需要有\nimp_full_database角色，示例如下\n导入一个或一组指定用户所属的全部对象\n$imp system/manager file=full_all.dmp log=seapark fromuser=hr\n$imp system/manager file=seapark log=seapark fromuser=(seapark,amy,amyc,harold)\n将一个或一组指定用户所属的全部对象导入到另一个用户下\n$imp hr/hr fromuser=hr touser=czm file=hr_all.dmp\n$imp system/manager file=tank log=tank fromuser=(seapark,amy) touser=(seapark1, amy1)\n>commit：默认值为 COMMIT=N，及在每插入完一个对象后提交。 当COMMIT=Y时候是根据你BUFFER的大小决定每次提交的数量。对于包含了LONG、RAW、 DATE等类型的表，不论BUFFER设置多大，都是每插入一行进行提交。设置commit=y可以防止减少回滚段的压力，但由于频繁提交，会带来性能 上的影响，推荐使用COMMIT=N。\n\n*  下列关键字仅用于可传输的表空间\n>TRANSPORT_TABLESPACE 导入可传输的表空间元数据 (N)\nTABLESPACES 将要传输到数据库的表空间\nDATAFILES 将要传输到数据库的数据文件\nTTS_OWNERS 拥有可传输表空间集中数据的用户\n\n* 关于增量参数的说明：exp/imp的增量并不是真正意义上的增量，所以最好不要使用。\n\n## 3.exp / imp常用语法\n### 3.1 exp\n* 完全\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" compress=n buffer=4096000 feedback=100000 full=y file=exp_itpuxdb.dmp log=exp_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n```\n\n* 用户\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 owner=itpux file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n--exp itpux/itpux compress=n buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n```\n\n* 表\n```shell\nexp itpux/itpux compress=n buffer=4096000 feedback=100000 tables=t1,t2,t2 file=exp_t1_itpuxdb.dmp log=exp_t1_itpuxdb.log\n```\n\n* other\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 rows=n file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n```\n\n\n### 3.2 imp\n* 完全\n```shell\nimp system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n```\n\n* 用户\n```shell\nimp system/oracle fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n--imp itpux/itpux fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n```\n\n* 表\n```shell\nimp itpux/itpux fromuser=itpux touser=itpux tables=t1,t2,t3 ignore=y buffer=4096000 feedback=100000 file=exp_t1_itpuxdb.dmp log=imp_t1_itpuxdb.log\n```\n\n## 4.配置生产环境的逻辑自动备份策略\n>要求：每天早上5点做逻辑全备，备份文件保留一周。\n```shell\nvi /backup/scripts/expfull_db01.sh\nexport BAKDATE=`date +%Y%m%d`\nexport ORACLE_SID=db01\nnohup exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=/backup/expfull_db01_$BAKDATE.dmp log=/backup/expfull_db01_$BAKDATE.log &\ngzip -f /backup/expfull_db01_$BAKDATE.dmp\nfind /backup -name expfull_db01_*.dmp.gz -atime +2 -exec rm -rf {} \\;\n#chown -R oracle:dba /backup/expfull_db01.sh\n#chmod 775 /backup/expfull_db01.sh\n#crontab -e\n00 05 * * * su - oracle -c /backup/scripts/expfull_db01.sh\n```\n\n## 5.exp / imp生产环境数据迁移流程和注意事项\n### 5.1 数据迁移的目的\n>使用exp/imp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n### 5.2 数据迁移的适用范围\n>所有线上库9i ,10g > 11g 12c \n>11g不建用了，\n### 5.3 数据迁移的风险评估\n>&emsp;&emsp;01.exp导出数据时没有使用compress=n参数，会导致所有数据被压缩在一个extent里，导入可能由于没有连续的blocks满足需要，导致imp失败。\n&emsp;&emsp;02.有些os对文件大小有限制，exp数据时需要使用filesize参数来分割导出文件\n&emsp;&emsp;03.exp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n&emsp;&emsp;05.imp导入数据时没有使用ignore=y参数，目标库上存在表的情况下数据无法导入\n&emsp;&emsp;05.imp导入大量数据时没有使用commit=y参数，导致事务太久，undo资源占用过大无法及时回收。\n&emsp;&emsp;06.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n&emsp;&emsp;07.imp跨schema进行数据迁移时，没有正确指定fromuser、touser，导致数据没有正确导入\n&emsp;&emsp;09.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n### 5.4 数据迁移的准备工作\n>&emsp;&emsp;01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用exp/imp迁移数据。\n&emsp;&emsp;02.检查目标库上表结构和源结构是否一致，如果不一致，先修复结构，保证一致。\n&emsp;&emsp;03.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。如果表大小超出文件大小，exp导出时加上这两个参数：filesize=小于文件限制的数值m,file=exp01.dmp,exp02.dmp,…多个dmp文件\n&emsp;&emsp;04.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\ntables=(tab1,tab2,tab3,..)\n&emsp;&emsp;05.根据不同的需要要书写query子句时，这个参数跟direct=y冲突\n### 5.5 数据迁移的执行过程\n>01.如果目标表是已存在数据，跟应用确认后，可以先进行导出备份，以防后面需要回退。\n先根据需求编辑exp、imp的参数文件：’-‘后面是参数说明，实际使用时去掉cat exp_itpux.par\nuserid=itpux/itpux@db01\ndirect=y –直接路径导出，加快导出速度\ncompress=n –避免数据全部压缩在一个数据块上\nfile=exp_itpux01.dmp\nlog=exp_itpux01.log\nrecordlength=65535 –写dmp文件时一次IO的大小，上限是65535，可以加快导出速度\nbuffer=4096000 -数据缓冲区大小\ntables=itpux01\n\nexp parfile=exp_itpux.par –进行数据导出\n```shell\ncat imp_itpux.par\nuserid=itpux/itpux\ncommit=y –开启批量提交，避免长事务\nignore=y –如果目标表已经存在，只导入数据\nfromuser=itpux\ntouser=itpux\ntables=itpux01\nfile=imp_itpux01.dmp\nlog=imp_itpux01.log\nbuffer=100000 –大小控制导入速度的，设置过大会导致日志产生很快\nimp parfile=imp_itpux.par –进行数据导入\n```\n>注意上面的fromuser和touser。如果将表导入到两个schema:itpux01,itpux02\n需要按照这种格式配置参数：\nfromuser和touser一一对应，即使导出时只有一个schema.\nfromuser=itpux01,itpux01\ntouser=itpux02,itpux02\n\n* 02 exp导出数据时，检查exp的日志，如果报错，一般是参数配置错误，参考官方文档调整参数。\n* 03 imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报错：\n```sql\nspool itpux_object_create_scripts.sql\nSET LONG 2000000 PAGESIZE 0 head off verify off feedback off linesize 180\nselect dbms_metadata.get_ddl('USER','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('OBJECT_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('ROLE_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('SYSTEM_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_ddl('TABLESPACE','ITPUX02') from dual;\nspool off;\n```\n* 04 imp导入数据过程，需要监控下数据库事务和日志产生速度。\n* 05 对导入的表收集统计信息。\n\n### 5.6 数据迁移后的验证方案\n>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\nselect count(*) from itpux.itpux01;\n>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n```sql\nselect object_type s_object_type,count(*) from dba_objects where owner='ITPUX01' group by object_type ;\nselect object_type t_object_type,count(*) from dba_objects where owner='ITPUX01' group by object_type ;\nselect * from dba_objects where status <> 'VALID' and owner='ITPUX01';\n```\n* dblink两个库一起查询;\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) t;\n```\n>自动生成编译无效对象SQL及编译过程\n\n* 统计当前用户无效对象数量:\n```sql\n  SELECT owner,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n```\n* 生成编译无效对象SQL\n```sql\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n```\n>通过复制以上SQL语句,直接手动执行编译执行,也可以采用如下方式在oracle用户下进行手工编译\n```sql\n# su - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/admin/utlrp.sql\n```\n\n* 如果有序列要处理\n```sql\nexclude=SEQUENCE\n```\n>目标库\n方法1:\n1.源库： 查出sequence的最大值\n2.目标库： DROP SEQUENCE .... 再 CREATE SEQUENCE START最大值 其他不变\n方法2：\n目标库： DROP SEQUENCE .... 再 CREATE SEQUENCE START 超大值 （保证比之前的都大，不会发生冲突的 ）\n\n* 可以用以下脚本来实现 ：\n```sql\n/* Formatted on 2018/1/30 19:49:33 (QP5 v5.313) */\nscript FROM THE SOURCE database. USE this script TO RESET THE proper starting VALUE FOR sequences ON THE TARGET database.\ncr_tts_create_seq.SQL\nSET HEADING OFF FEEDBACK OFF TRIMSPOOL ON ESCAPE OFF\nSET LONG 1000 LINESIZE 1000 PAGESIZE 0\nCOL SEQDDL FORMAT A300\nSPOOL tts_create_seq.sql\nPROMPT /* ========================= */\nPROMPT /* Drop and create sequences */\nPROMPT /* ========================= */\n\nSELECT REGEXP_REPLACE (\n           DBMS_METADATA.get_ddl ('SEQUENCE', sequence_name, sequence_owner),\n           '^.*(CREATE SEQUENCE.*CYCLE).*$',\n              'DROP SEQUENCE \"'\n           || sequence_owner\n           || '\".\"'\n           || sequence_name\n           || '\";'\n           || CHR (10)\n           || '\\1;')\n           SEQDDL\n  FROM dba_sequences\n WHERE sequence_owner NOT IN (SELECT name\n                                FROM SYSTEM.logstdby$skip_support\n                               WHERE action = 0);\n\nSPOOL OFF\n```\n\n### 5.7 数据迁移核心对象风险\n>由于核心表访问、变更频繁，不宜直接使用imp对核心表大量导入数据。\n\n### 5.8 数据迁移回退方案\n>exp对应用无影响，不需要回退。\nimp后可能数据有误，需要进行回退操作。\n如果目标表本来就是空表，跟应用确认后，直接清空即可。\n如果目标表原有数据，跟应用确认是否使用原有备份数据进行恢复。若需要，先exp备份当前数据，然后清空再导入前面的备份数据。\n\n## 6.exp / imp数据迁移案例\n### 6.1 迁移目的\n>&emsp;&emsp;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过Exp迁移到另一台oracle服务器，并能正常查询到相关数据。\n### 6.2 迁移流程\n```sql\n1.准备数据：linux系统oracle服务器上创建用户,表空间.并创建相关表.数据等。\n2.linux本地用Exp做导出;\n3.再到远程主机创建相关对象；\n4.远程主机用imp做导入(导入);\n5.验证远程本地数据合法性;\n```\n### 6.3 迁移过程\n* 创建表空间\n```sql\nCREATE TABLESPACE itpux11\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n\t\nCREATE TABLESPACE itpux12\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n```\n\n* 创建用户并授权\n```sql\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n```\n\n* moon用户登录并创建测试表\n```sql\nCONN itpux01 / itpux01\nCREATE TABLE itpux01\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\nCONN itpux02 / itpux02\nCREATE TABLE itpux02\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\n```\n\n* 创建2个存储过程并执行\n```sql\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\nEND p_itpux01;\n/\n\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n```\n\n* 查询验证数据\n```sql\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id > 1990;\n```\n\n* 本地用Exp做导出\n```sql\nEXP SYSTEM/oracle OWNER=itpux01,itpux02 COMPRESS=n FILE=exp_2table.dmp LOG=exp_2table.LOG direct=y recordlength=65535 buffer=4096000\n```\n\n* imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报\n```sql\n/* Formatted on 2018/1/30 20:03:14 (QP5 v5.313) */\nSPOOL itpux_object_create_scripts.sql\nSET LONG 2000000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 180\n\nSELECT DBMS_METADATA.get_ddl ('USER', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('OBJECT_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('ROLE_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('SYSTEM_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('USER', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('OBJECT_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('ROLE_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('SYSTEM_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX02') FROM DUAL;\n\nSPOOL OFF;\n```\n\n* 异机用imp做导入\n```sql\nimp SYSTEM/oracle fromuser=itpux01,itpux02 touser=itpux01,itpux02 FILE=exp_2table.dmp LOG=exp_2table.LOG COMMIT=y IGNORE=y buffer=4096000\n```\n\n* 验证导入后的数据合法性\n```sql\n\n```\n\n### 6.4 数据迁移后的验证方案\n>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n```sql\nSELECT COUNT (*) FROM itpux.itpux01;\n```\n>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n```sql\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status <> 'VALID' AND owner = 'ITPUX01';\n```\n* dblink两个库一起查\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) t;\n```\n* 自动生成编译无效对象SQL及编译过程\n>统计当前用户无效对象数量\n```sql\n  SELECT owner,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n```\n\n>生成编译无效对象SQL\n```sql\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n```\n>通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n```sql\nsu - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/admin/utlrp.sql\n```\n## 7.exp / imp迁移过程字符集的处理\n> 进行数据的导入导出时，我们要注意关于字符集的问题。在EXP/IMP过程中我们需要注意四个字符集的参数：\n```shell\n01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n04.导入端数据库字符集。\n```\n>我们首先需要查看这四个字符集参数。\n查看数据库的字符集的信息：\n```sql\nSQL> select * from nls_database_parameters;\n//SQL> select * from props$;\nSQL> SET PAGESIZE 30\nSQL> select * from nls_database_parameters;\n\nPARAMETER                      VALUE\n------------------------------ ------------------------------\nNLS_LANGUAGE                   AMERICAN\nNLS_TERRITORY                  AMERICA\nNLS_CURRENCY                   $\nNLS_ISO_CURRENCY               AMERICA\nNLS_NUMERIC_CHARACTERS         .,\nNLS_CHARACTERSET               ZHS16GBK\nNLS_CALENDAR                   GREGORIAN\nNLS_DATE_FORMAT                DD-MON-RR\nNLS_DATE_LANGUAGE              AMERICAN\nNLS_SORT                       BINARY\nNLS_TIME_FORMAT                HH.MI.SSXFF AM\nNLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM\nNLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR\nNLS_DUAL_CURRENCY              $\nNLS_COMP                       BINARY\nNLS_LENGTH_SEMANTICS           BYTE\nNLS_NCHAR_CONV_EXCP            FALSE\nNLS_NCHAR_CHARACTERSET         UTF8\nNLS_RDBMS_VERSION              11.2.0.4.0\n\n20 rows selected.\n\n```\n>我们再来查看客户端的字符集信息：\n客户端字符集的参数NLS_LANG=_< territory >.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n\n* 如数据库语言环境\n>os是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>os是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n\\\n\n>$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>永久修改可用：\nvi bash_profile\n\n* 通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n>&emsp;&emsp;(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n&emsp;&emsp;(2) 源数据库和目标数据库字符集不同。\n&emsp;&emsp;先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n&emsp;&emsp;这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n## 8.exp / imp优化的方法\n>当需要exp/imp的数据量比较大时，这个过程需要的时间是比较长的，我们可以用一些方法来优化exp/imp的操作。\n\n* 01.exp:使用直接路径 direct=y\n>&emsp;&emsp;oracle会避开sql语句处理引擎,直接从数据库文件中读取数据,然后写入导出文件.\n&emsp;&emsp;可以在导出日志中观察到: exp-00067: table xxx will be exported in conventional path\n&emsp;&emsp;如果没有使用直接路径,必须保证buffer参数的值足够大.\n&emsp;&emsp;有一些参数于direct=y不兼容,无法用直接路径导出可移动的tablespace,或者用query参数导出数据库子集.\n&emsp;&emsp;当导入导出的数据库运行在不同的os下时,必须保证recordlength参数的值一致.\n\n* 02.exp: 清空回收站\n```sql\nSQL> select count(*) from dba_recyclebin;\nSQL> purge dba_recyclebin;\n```\n\n* 03.imp:避免磁盘排序\n>涉及到sort_area_size参数,也就是我们的PGA要够大。\n\n* 05.imp:优化日志缓冲区\n>比如将log_buffer容量扩大10倍(最大不要超过5M),也就是我们的SGA要够大。\n\n* 05.imp:避免日志切换等待\n>增加重做日志组的数量,增大日志文件大小.\n\n* 06.imp:使用commit\n>commit = y\n注意:这个方式不能处理包含LOB和LONG类型的表,对于这样的table,如果使用commit = y,每插入一行,就会执行一次提交.\n\n* 07.imp:使用NOLOGGING方式减小重做日志大小\n>在导入时指定参数indexes=n,只导入数据而忽略index,在导完数据后在通过脚本创建index,指定NOLOGGING选项\n\n## 9.exp / imp 常见问题及解决方法\n### 9.1 关于imp/exp版本的问题\n>一般来说，从低版本导入到高版本问题不大，麻烦的是将高版本的数据导入到低版本中。\n* 可以跨版本的使用EXP/IMP，但必须正确地使用EXP和IMP的版本（官方可查）：\n```sql\n1、使用IMP的版本匹配数据库的版本，如：要导入到11.2中，使用11.2的IMP工具。\n2、使用EXP的版本匹配两个数据库中最低的版本，如：从11.2往10.2中导入，则使用10.2版本的EXP工具。\n3、高版本的Export导出来的转储文件，低版本的Import读不了；低版本的Export导出来的转储文件，高版本的Import可以进行读取。\n4、从Oracle低版本的Export数据可以Import到Oracle高版本中，但限于Oracle的相邻版本，两个不相邻版本间进行转换应借助中间版本。\n5、exp/imp可以做到在不同版本Oracle、不同数据库上的迁移。\n```\n\n### 9.2 数据库对象已经存在\n>&emsp;&emsp;一般情况, 导入数据前应该彻底删除目标数据下的表, 序列, 函数/过程,触发器等; 数据库对象已经存在, 按缺省的imp参数, 则会导入失败如果用了参数ignore=y, 会把exp文件内的数据内容导入如果表有唯一关键字的约束条件, 不合条件将不被导入如果表没有唯一关键字的约束条件, 将引起记录重复\n### 9.3 数据库对象有主外键约束\n>不符合主外键约束时, 数据会导入失败,\n解决办法:\n先导入主表, 再导入依存表\ndisable目标导入对象的主外键约束, 导入数据后, 再enable它们\n### 9.4 权限不够\n>如果要把A用户的数据导入B用户下, A用户需要有imp_full_database权限\n### 9.5 导入大表存储分配失败\n>&emsp;&emsp;默认的EXP时, compress = y, 也就是把所有的数据压缩在一个数据块上.\n导入时, 如果不存在连续一个大数据块, 则会导入失败. 导出大表时, 记得compress= n, 则不会引起这种错误.\n### 9.6 imp和exp使用的字符集不同\n>&emsp;&emsp;如果字符集不同, 导入会失败, 可以改变unix环境变量或者NT注册表里NLS_LANG相关信息. 导入完成后再改回来.\n\n### 9.7 imp和exp版本不能往上兼容\n>可以从低版本导入高版本，但不能从高版本导入到低版本。\n如果遇到迁移因版本不同的问题，可以用低版本的export 导出，到导入到低版本。\n\n### 9.8 导出统计信息的问题。\n>&emsp;&emsp;如果导出统计信息,在只导出部分数据,或不导出数据时,导出统计信息会报错.另如果未导出统计信息,但导入时,需导入统计信息\n,那此时,导入后,统计信息会被锁住,而无法更新统计信息.\n&emsp;&emsp;此时,我们可使用包dbms_stats.unlock_schema_stats来解锁.最好的办法是,在exp,imp时,加入参数statistics=none,不exp,imp统计信息,在导入完成后,在重新收集统计信息.\n\n```sql\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nBEGIN\n    DBMS_STATS.gather_schema_stats ('ITPUX02');\nEND;\n/\n```","source":"_posts/oracle/Oracle数据库逻辑备份恢复迁移之exp与imp.md","raw":"---\ntitle: Oracle数据库逻辑备份恢复迁移之exp与imp\ndate: 2018-10-02 14:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - Exp\n  - Imp\n  - 备份容灾\n---\n\n\n# Oracle数据库逻辑备份恢复迁移之exp与imp\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.export与import逻辑备份恢复概述\n### 1.1 备份概述\n* 备份可分为两类，物理备份和逻辑备份\n>&emsp;&emsp;物理备份：该方法实现数据库的完整恢复，但需要极大的外部存储设备，例如磁带库，具体包括冷备份和热备份。冷备份和热备份(热备份要求数据库运行在归档模式下)都是物理备份，它涉及到组成数据库的文件，但不考虑逻辑内容。\n>&emsp;&emsp;逻辑备份： 使用软件技术从数据库中导出数据并写入一个输出文件，该文件的格式一般与原数据库的文件格式不同，只是 原数据库中数据内容的一个映像。因此，逻辑备份文件只能用来对数据库进行逻辑恢复，即数据导入，而不能按数据库原来的存储特征进行物理恢复。逻辑备份一般 用于增量备份，即备份那些在上次备份以后改变的数据。\n>&emsp;&emsp;Oracle 的导出导入是一个很常用的迁移工具。 在Oracle 10g以后，Oracle 推出了数据泵(expdp/impdp).它可以通过使用并行，从而在效率上要比exp/imp 要高。但是这个exp/imp很多时候还需要使用。\n>&emsp;&emsp;导入/导出是ORACLE幸存的最古老的两个命令行工具，其实我从来不认为Exp/Imp是一种好的备份方式，正确的说法是Exp/Imp只能是一个好的转储工具，特别是在小型数据库的转储，表空间的迁移，表的抽取，检测逻辑和物理冲突等中有不小的功劳。当然，我们也可以把它作为小型数据库的物理备份后的一个逻辑辅助备份，也是不错的建议。对于越来越大的数据库，特别是TB级数据库和越来越多数据仓库的出现，EXP/IMP越来越力不从心了，这个时候，数据库的备份都转向了RMAN和第三方工具。下面说明一下EXP/IMP的使用。\n\n## 2.export与import参数详解\n### 2.1 export参数详解\n```shell\n[oracle@orcl:/]$exp -help\n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 18:30:39 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Export prompt you for parameters by entering the EXP\ncommand followed by your username/password:\n\n     Example: EXP SCOTT/TIGER\n\nOr, you can control how Export runs by entering the EXP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  EXP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: EXP SCOTT/TIGER GRANTS=Y TABLES=(EMP,DEPT,MGR)\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword    Description (Default)      Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID     username/password          FULL         export entire file (N)\nBUFFER     size of data buffer        OWNER        list of owner usernames\nFILE       output files (EXPDAT.DMP)  TABLES       list of table names\nCOMPRESS   import into one extent (Y) RECORDLENGTH length of IO record\nGRANTS     export grants (Y)          INCTYPE      incremental export type\nINDEXES    export indexes (Y)         RECORD       track incr. export (Y)\nDIRECT     direct path (N)            TRIGGERS     export triggers (Y)\nLOG        log file of screen output  STATISTICS   analyze objects (ESTIMATE)\nROWS       export data rows (Y)       PARFILE      parameter filename\nCONSISTENT cross-table consistency(N) CONSTRAINTS  export constraints (Y)\n\nOBJECT_CONSISTENT    transaction set to read only during object export (N)\nFEEDBACK             display progress every x rows (0)\nFILESIZE             maximum size of each dump file\nFLASHBACK_SCN        SCN used to set session snapshot back to\nFLASHBACK_TIME       time used to get the SCN closest to the specified time\nQUERY                select clause used to export a subset of a table\nRESUMABLE            suspend when a space related error is encountered(N)\nRESUMABLE_NAME       text string used to identify resumable statement\nRESUMABLE_TIMEOUT    wait time for RESUMABLE \nTTS_FULL_CHECK       perform full or partial dependency check for TTS\nVOLSIZE              number of bytes to write to each tape volume\nTABLESPACES          list of tablespaces to export\nTRANSPORT_TABLESPACE export transportable tablespace metadata (N)\nTEMPLATE             template name which invokes iAS mode export\n\nExport terminated successfully without warnings.\n```\n* EXP的所有参数（括号中为参数的默认值）：\n>可以通过exp help=y或者imp help=y查看exp或imp的详细参数，下面以exp为例解释参数意义\nUSERID：用户名/口令\n\n>FULL：导出整个数据库，只有拥有exp_full_database角色的用户或者特权用户如sys，system等才能进行全库导出。 示例如下\nexp \"'/ as sysdba'\" full=y\n\n>BUFFER：制定数据缓冲区大小，主要用于提高exp/imp速度，该单位为字节，不能写成buffer=1m的形式，应写成字节为单位的参数，如buffer=1048576\nexp hr/hr file=t_b.dmp buffer= 1048576 tables=T\n\n>OWNER：需要导出的用户，示例如下\nexp \"'/ as sysdba'\" owner=\\(hr,ITPUX02\\) file=hr_ITPUX02.dmp\n上例中由于是在linux平台进行测试的，需要对 owner=\\(hr,ITPUX02\\)使用\\进行转义\n\n>FILE：输出文件\n\n>TABLES：需要导出的表\n\n>COMPRESS：导入到一个区 (Y) 。主要目的是为了消除存储碎片，以保证某张表的所有记录都存储在连续的空间里。 但是负面效应很明显， 如果该参数值为y，则会将高水位线以下的所有extent导入到一个区中， 因此在导入时很有可能出现，明明表中数据很少，但是却花了很多时间在建立的extent上。 且自oracle9i开始，使用了本地管理的表空间，存储碎片的问题应该比低版本好多了，个人建议将compress设为n。\n\n* DIRECT：直接路径 (N)。\n>传统模式导出和直接路径导出的原理\n传 统模式导出相当于使用select语句从表中取出数据，数据从磁盘上先读到buffer cache中，记录被转移到一个评估检测的缓冲区中，数据经过语法检测后没有问题，将数据传给PGA，最后写入导出的文件中。如果使用Direct Path模式导出，数据直接从磁盘上读取到导出的PGA中：记录直接被转换导出会话的私有buffer中。这也就是意味着SQL语句处理层被忽略掉了，因 为数据已经是符合导出的格式了，不需要其他的转换处理了。数据直接被传送给导出的客户端，最后写入导出文件。过程可概况如下\n```shell\ndirect=n datafile---->sga----->pga----->dump\ndirect=y datafile---->pga----->dump\n```\n>传统路径导出VS直接路径导出(oracle exp direct=y)两者的差异\n>a、 Conventional path Export\n&emsp;&emsp; 传统路径模式使用SQL SELECT语句抽取表数据。数据从磁盘读入到buffer cache缓冲区中，行被转移到评估缓冲区。在此之后根据SQL表达式，将记录返回给导出客户端，然后写入到dump文件。\n>b、Direct path Export\n&emsp;&emsp; 直接导出模式，数据直接从磁盘中读取到导出session的PGA中，行被直接转移到导出session的私有缓冲区，从而跳过SQL命令处理层。\n避免了不必要的数据转换。最后记录返回给导出客户端，写到dump文件。\n\n* 传统路径导出VS直接路径导出(oracle exp direct=y)性能问题\n>&emsp;&emsp; a、直接路径导出方式比传统路径方式具有更优的性能，速度更快，因为绕过了SQL命令处理部分。\n&emsp;&emsp; b、直接路径导出方式支持RECORDLENGTH参数(最大为64k)，该参数值通常建议设置为系统I/O或者DB_BLOCK_SIZE的整数倍\n&emsp;&emsp; c、影响直接路径导出的具体因素(DB_BLOCK_SIZE，列的类型，I/O性能，即数据文件所在的磁盘驱动器是否单独于dump文件所在的磁盘驱动器)\n&emsp;&emsp; d、无论是直接路径导出还是传统路径导出产生的dump，在使用imp方式导入时，会耗用相同的时间.\n\n* 传统路径导出VS直接路径导出(oracle exp direct=y)直接路径导出的限制\n>a、直接路径导出不支持交互模式\nb、不支持表空间传输模式(即transport_tablespaces=y不被支持)，支持的是full,owner,tables导出方式\nc、不支持query查询方式，如exp scott/tiger tables=emp query=\\\"where job=\\'salesman\\' \\\" 不被支持\nd、直接路径导出使用recordlength设置一次可以导出数据的量，取代传统路径使用buffer的设置\ne、直接路径导出要求nls_lang环境参数等于数据库字符集，负责收到exp-41警告及exp-0终止错误\n\n>GRANTS：导出权限 (Y)\nINCTYPE：增量导出类型，已废除\nINDEXES：导出索引 (Y)\nRECORD：跟踪增量导出 (Y) ，已废除\nTRIGGERS：导出触发器 (Y)\nLOG：屏幕输出的日志文件\n\n>STATISTICS：在导出文件中保留对象的统计信息，默认值ESTIMATE，还可以为compute或者none。如果导出时出现\nEXP-00091: Exporting questionable statistics\n可以考虑将 STATISTICS设置为NONE\n>ROWS：确定表中的数据行是否导出，默认为Y，导出\n\n>QUERY：用于导出表的子集的select子句，示例如下\nexp hr/hr file=emp_q.dmp tables=employees query=\\\"where hire_date \\>to_date\\(\\'1999-01-01\\'\\,\\'yyyy-mm-dd\\'\\)\\\"\n\n* PARFILE：参数文件名，可以用如下方式导出\n```sql\nexp hr/hr parfile=parfile\n$ cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=(t,empl%s)\n```\n\n>使用parfile参数可以对频繁进行的导出操作进行反复调用，同时也可以避免不同操作系统之间需要对特定字符进行转义的烦恼，如下例\n```sql\nexp hr/hr parfile=parfile\n$cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=employees\nstatistics=none\nquery=\"where hire_date>to_date('1999-01-01','yyyy-mm-dd')\"\n```\n>CONSISTENT：在导出时，将影响正在导出的表的事务设为只读，主要作用于嵌套表和分区表，默认为N。\nCONSTRAINTS：导出的约束条件 (Y)\nOBJECT_CONSISTENT:只在对象导出期间设置为只读的事务处理 (N)\nFEEDBACK:每 x 行显示进度，默认为0\nFILESIZE：每个导出文件的最大大小\nFLASHBACK_SCN：用于将会话快照设置回以前状态的SCN\nFLASHBACK_TIME：用于获取最接近指定时间的SCN的时间\nRESUMABLE：遇到空间不足时的错误时挂起，默认为N，需与 RESUMABLE_NAME和 RESUMABLE_TIMEOUT一起使用\nRESUMABLE_NAME：用于标示哪个会话需要使用 RESUMABLE选项，格式为 User USERNAME (USERID), Session SESSIONID, Instance INSTANCEID\nRESUMABLE_TIMEOUT：RESUMABLE的等待时间，默认为7200s，如果在指定时间内未解决问题，则操作中断\n>TTS_FULL_CHECK：对TTS执行完整或部分相关性检查\nTABLESPACES：要导出的表空间列表，示例如下\nexp \"'/ as sysdba'\" file=t_ts.dmp tablespaces=(users,example)\nTRANSPORT_TABLESPACE 导出可传输的表空间元数据 (N)\n直接备份到磁带上\nexp icdmain/icd rows=y indexes=n compress=n buffer=65536 feedback=100000 file=/dev/rmt0 log=exp.log tables=(tab1,tab2,tab3)\n注：在磁盘空间允许的情况下，应先备份到本地服务器，然后再拷贝到磁带。出于速度方面的考虑，尽量不要直接备份到磁带设备\n\n### 2.2 import参数详解\n```sql\n[oracle@orcl:/]$imp -help\n\nImport: Release 11.2.0.4.0 - Production on Tue Jan 30 19:01:13 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Import prompt you for parameters by entering the IMP\ncommand followed by your username/password:\n\n     Example: IMP SCOTT/TIGER\n\nOr, you can control how Import runs by entering the IMP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  IMP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: IMP SCOTT/TIGER IGNORE=Y TABLES=(EMP,DEPT) FULL=N\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword  Description (Default)       Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID   username/password           FULL         import entire file (N)\nBUFFER   size of data buffer         FROMUSER     list of owner usernames\nFILE     input files (EXPDAT.DMP)    TOUSER       list of usernames\nSHOW     just list file contents (N) TABLES       list of table names\nIGNORE   ignore create errors (N)    RECORDLENGTH length of IO record\nGRANTS   import grants (Y)           INCTYPE      incremental import type\nINDEXES  import indexes (Y)          COMMIT       commit array insert (N)\nROWS     import data rows (Y)        PARFILE      parameter filename\nLOG      log file of screen output   CONSTRAINTS  import constraints (Y)\nDESTROY                overwrite tablespace data file (N)\nINDEXFILE              write table/index info to specified file\nSKIP_UNUSABLE_INDEXES  skip maintenance of unusable indexes (N)\nFEEDBACK               display progress every x rows(0)\nTOID_NOVALIDATE        skip validation of specified type ids \nFILESIZE               maximum size of each dump file\nSTATISTICS             import precomputed statistics (always)\nRESUMABLE              suspend when a space related error is encountered(N)\nRESUMABLE_NAME         text string used to identify resumable statement\nRESUMABLE_TIMEOUT      wait time for RESUMABLE \nCOMPILE                compile procedures, packages, and functions (Y)\nSTREAMS_CONFIGURATION  import streams general metadata (Y)\nSTREAMS_INSTANTIATION  import streams instantiation metadata (N)\nDATA_ONLY              import only data (N)\nVOLSIZE                number of bytes in file on each volume of a file on tape\n\nThe following keywords only apply to transportable tablespaces\nTRANSPORT_TABLESPACE import transportable tablespace metadata (N)\nTABLESPACES tablespaces to be transported into database\nDATAFILES datafiles to be transported into database\nTTS_OWNERS users that own data in the transportable tablespace set\n\nImport terminated successfully without warnings.\n```\n* IMP的所有参数（括号中为参数的默认值）：\n>i&emsp;&emsp;mp的参数和exp的大致相同，下面是常用参数的解释，与exp相同的这就不再赘述\n>&emsp;&emsp;ignore：Oracle在恢复数据的过程中，当导入某个表时，该表已经存在，就要根据ignore参数的设置来决定如何操作。若 ignore=y，Oracle不执行CREATE TABLE语句，直接将数据插入到表中，如果插入的记录违背了约束条件，比如主键约束，唯一索引等，则出错的记录不会插入，但合法的记录会添加到表中。若 ignore=n，Oracle不执行CREATE TABLE语句，同时也不会将数据插入到表中，而是忽略该表的错误，继续导入下一个表。 注\n意：如果表中的字段并没有唯一性约束，那么在使用ignore=y的情况下很有可能插入重复数据。\n>&emsp;&emsp;indexes：在恢复数据的过程中，若indexes=n，则表上的索引不会被恢复，但是对 LOB 索引, OID索引和 主键索引等系统自动生成的索引将无条件恢复。\n>&emsp;&emsp;indexfile：不进行导入操作而是将创建对象的文本保存到文件中，可以通过编辑使用该文本文件创建数据库对象。\n>&emsp;&emsp;fromuser,touser:这两个参数可以组合使用，也可以分开使用。他们可以实现将源用户的对象数据，导入到目标用户schema底下的功能。这里要注意，导入时的用户需要有\nimp_full_database角色，示例如下\n导入一个或一组指定用户所属的全部对象\n$imp system/manager file=full_all.dmp log=seapark fromuser=hr\n$imp system/manager file=seapark log=seapark fromuser=(seapark,amy,amyc,harold)\n将一个或一组指定用户所属的全部对象导入到另一个用户下\n$imp hr/hr fromuser=hr touser=czm file=hr_all.dmp\n$imp system/manager file=tank log=tank fromuser=(seapark,amy) touser=(seapark1, amy1)\n>commit：默认值为 COMMIT=N，及在每插入完一个对象后提交。 当COMMIT=Y时候是根据你BUFFER的大小决定每次提交的数量。对于包含了LONG、RAW、 DATE等类型的表，不论BUFFER设置多大，都是每插入一行进行提交。设置commit=y可以防止减少回滚段的压力，但由于频繁提交，会带来性能 上的影响，推荐使用COMMIT=N。\n\n*  下列关键字仅用于可传输的表空间\n>TRANSPORT_TABLESPACE 导入可传输的表空间元数据 (N)\nTABLESPACES 将要传输到数据库的表空间\nDATAFILES 将要传输到数据库的数据文件\nTTS_OWNERS 拥有可传输表空间集中数据的用户\n\n* 关于增量参数的说明：exp/imp的增量并不是真正意义上的增量，所以最好不要使用。\n\n## 3.exp / imp常用语法\n### 3.1 exp\n* 完全\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" compress=n buffer=4096000 feedback=100000 full=y file=exp_itpuxdb.dmp log=exp_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n```\n\n* 用户\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 owner=itpux file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n--exp itpux/itpux compress=n buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n```\n\n* 表\n```shell\nexp itpux/itpux compress=n buffer=4096000 feedback=100000 tables=t1,t2,t2 file=exp_t1_itpuxdb.dmp log=exp_t1_itpuxdb.log\n```\n\n* other\n```shell\nexp system/oracle compress=n buffer=4096000 feedback=100000 rows=n file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n```\n\n\n### 3.2 imp\n* 完全\n```shell\nimp system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n```\n\n* 用户\n```shell\nimp system/oracle fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n--imp itpux/itpux fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n```\n\n* 表\n```shell\nimp itpux/itpux fromuser=itpux touser=itpux tables=t1,t2,t3 ignore=y buffer=4096000 feedback=100000 file=exp_t1_itpuxdb.dmp log=imp_t1_itpuxdb.log\n```\n\n## 4.配置生产环境的逻辑自动备份策略\n>要求：每天早上5点做逻辑全备，备份文件保留一周。\n```shell\nvi /backup/scripts/expfull_db01.sh\nexport BAKDATE=`date +%Y%m%d`\nexport ORACLE_SID=db01\nnohup exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=/backup/expfull_db01_$BAKDATE.dmp log=/backup/expfull_db01_$BAKDATE.log &\ngzip -f /backup/expfull_db01_$BAKDATE.dmp\nfind /backup -name expfull_db01_*.dmp.gz -atime +2 -exec rm -rf {} \\;\n#chown -R oracle:dba /backup/expfull_db01.sh\n#chmod 775 /backup/expfull_db01.sh\n#crontab -e\n00 05 * * * su - oracle -c /backup/scripts/expfull_db01.sh\n```\n\n## 5.exp / imp生产环境数据迁移流程和注意事项\n### 5.1 数据迁移的目的\n>使用exp/imp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n### 5.2 数据迁移的适用范围\n>所有线上库9i ,10g > 11g 12c \n>11g不建用了，\n### 5.3 数据迁移的风险评估\n>&emsp;&emsp;01.exp导出数据时没有使用compress=n参数，会导致所有数据被压缩在一个extent里，导入可能由于没有连续的blocks满足需要，导致imp失败。\n&emsp;&emsp;02.有些os对文件大小有限制，exp数据时需要使用filesize参数来分割导出文件\n&emsp;&emsp;03.exp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n&emsp;&emsp;05.imp导入数据时没有使用ignore=y参数，目标库上存在表的情况下数据无法导入\n&emsp;&emsp;05.imp导入大量数据时没有使用commit=y参数，导致事务太久，undo资源占用过大无法及时回收。\n&emsp;&emsp;06.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n&emsp;&emsp;07.imp跨schema进行数据迁移时，没有正确指定fromuser、touser，导致数据没有正确导入\n&emsp;&emsp;09.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n### 5.4 数据迁移的准备工作\n>&emsp;&emsp;01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用exp/imp迁移数据。\n&emsp;&emsp;02.检查目标库上表结构和源结构是否一致，如果不一致，先修复结构，保证一致。\n&emsp;&emsp;03.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。如果表大小超出文件大小，exp导出时加上这两个参数：filesize=小于文件限制的数值m,file=exp01.dmp,exp02.dmp,…多个dmp文件\n&emsp;&emsp;04.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\ntables=(tab1,tab2,tab3,..)\n&emsp;&emsp;05.根据不同的需要要书写query子句时，这个参数跟direct=y冲突\n### 5.5 数据迁移的执行过程\n>01.如果目标表是已存在数据，跟应用确认后，可以先进行导出备份，以防后面需要回退。\n先根据需求编辑exp、imp的参数文件：’-‘后面是参数说明，实际使用时去掉cat exp_itpux.par\nuserid=itpux/itpux@db01\ndirect=y –直接路径导出，加快导出速度\ncompress=n –避免数据全部压缩在一个数据块上\nfile=exp_itpux01.dmp\nlog=exp_itpux01.log\nrecordlength=65535 –写dmp文件时一次IO的大小，上限是65535，可以加快导出速度\nbuffer=4096000 -数据缓冲区大小\ntables=itpux01\n\nexp parfile=exp_itpux.par –进行数据导出\n```shell\ncat imp_itpux.par\nuserid=itpux/itpux\ncommit=y –开启批量提交，避免长事务\nignore=y –如果目标表已经存在，只导入数据\nfromuser=itpux\ntouser=itpux\ntables=itpux01\nfile=imp_itpux01.dmp\nlog=imp_itpux01.log\nbuffer=100000 –大小控制导入速度的，设置过大会导致日志产生很快\nimp parfile=imp_itpux.par –进行数据导入\n```\n>注意上面的fromuser和touser。如果将表导入到两个schema:itpux01,itpux02\n需要按照这种格式配置参数：\nfromuser和touser一一对应，即使导出时只有一个schema.\nfromuser=itpux01,itpux01\ntouser=itpux02,itpux02\n\n* 02 exp导出数据时，检查exp的日志，如果报错，一般是参数配置错误，参考官方文档调整参数。\n* 03 imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报错：\n```sql\nspool itpux_object_create_scripts.sql\nSET LONG 2000000 PAGESIZE 0 head off verify off feedback off linesize 180\nselect dbms_metadata.get_ddl('USER','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('OBJECT_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('ROLE_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_granted_ddl('SYSTEM_GRANT','ITPUX02') from dual;\nselect dbms_metadata.get_ddl('TABLESPACE','ITPUX02') from dual;\nspool off;\n```\n* 04 imp导入数据过程，需要监控下数据库事务和日志产生速度。\n* 05 对导入的表收集统计信息。\n\n### 5.6 数据迁移后的验证方案\n>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\nselect count(*) from itpux.itpux01;\n>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n```sql\nselect object_type s_object_type,count(*) from dba_objects where owner='ITPUX01' group by object_type ;\nselect object_type t_object_type,count(*) from dba_objects where owner='ITPUX01' group by object_type ;\nselect * from dba_objects where status <> 'VALID' and owner='ITPUX01';\n```\n* dblink两个库一起查询;\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) t;\n```\n>自动生成编译无效对象SQL及编译过程\n\n* 统计当前用户无效对象数量:\n```sql\n  SELECT owner,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n```\n* 生成编译无效对象SQL\n```sql\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n```\n>通过复制以上SQL语句,直接手动执行编译执行,也可以采用如下方式在oracle用户下进行手工编译\n```sql\n# su - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/admin/utlrp.sql\n```\n\n* 如果有序列要处理\n```sql\nexclude=SEQUENCE\n```\n>目标库\n方法1:\n1.源库： 查出sequence的最大值\n2.目标库： DROP SEQUENCE .... 再 CREATE SEQUENCE START最大值 其他不变\n方法2：\n目标库： DROP SEQUENCE .... 再 CREATE SEQUENCE START 超大值 （保证比之前的都大，不会发生冲突的 ）\n\n* 可以用以下脚本来实现 ：\n```sql\n/* Formatted on 2018/1/30 19:49:33 (QP5 v5.313) */\nscript FROM THE SOURCE database. USE this script TO RESET THE proper starting VALUE FOR sequences ON THE TARGET database.\ncr_tts_create_seq.SQL\nSET HEADING OFF FEEDBACK OFF TRIMSPOOL ON ESCAPE OFF\nSET LONG 1000 LINESIZE 1000 PAGESIZE 0\nCOL SEQDDL FORMAT A300\nSPOOL tts_create_seq.sql\nPROMPT /* ========================= */\nPROMPT /* Drop and create sequences */\nPROMPT /* ========================= */\n\nSELECT REGEXP_REPLACE (\n           DBMS_METADATA.get_ddl ('SEQUENCE', sequence_name, sequence_owner),\n           '^.*(CREATE SEQUENCE.*CYCLE).*$',\n              'DROP SEQUENCE \"'\n           || sequence_owner\n           || '\".\"'\n           || sequence_name\n           || '\";'\n           || CHR (10)\n           || '\\1;')\n           SEQDDL\n  FROM dba_sequences\n WHERE sequence_owner NOT IN (SELECT name\n                                FROM SYSTEM.logstdby$skip_support\n                               WHERE action = 0);\n\nSPOOL OFF\n```\n\n### 5.7 数据迁移核心对象风险\n>由于核心表访问、变更频繁，不宜直接使用imp对核心表大量导入数据。\n\n### 5.8 数据迁移回退方案\n>exp对应用无影响，不需要回退。\nimp后可能数据有误，需要进行回退操作。\n如果目标表本来就是空表，跟应用确认后，直接清空即可。\n如果目标表原有数据，跟应用确认是否使用原有备份数据进行恢复。若需要，先exp备份当前数据，然后清空再导入前面的备份数据。\n\n## 6.exp / imp数据迁移案例\n### 6.1 迁移目的\n>&emsp;&emsp;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过Exp迁移到另一台oracle服务器，并能正常查询到相关数据。\n### 6.2 迁移流程\n```sql\n1.准备数据：linux系统oracle服务器上创建用户,表空间.并创建相关表.数据等。\n2.linux本地用Exp做导出;\n3.再到远程主机创建相关对象；\n4.远程主机用imp做导入(导入);\n5.验证远程本地数据合法性;\n```\n### 6.3 迁移过程\n* 创建表空间\n```sql\nCREATE TABLESPACE itpux11\n    DATAFILE '/oracle/oradata/db01/itpux01.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n\t\nCREATE TABLESPACE itpux12\n    DATAFILE '/oracle/oradata/db01/itpux02.dbf'\n                 SIZE 100 M\n                 AUTOEXTEND OFF\n    EXTENT MANAGEMENT LOCAL AUTOALLOCATE\n    SEGMENT SPACE MANAGEMENT AUTO;\n```\n\n* 创建用户并授权\n```sql\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n```\n\n* moon用户登录并创建测试表\n```sql\nCONN itpux01 / itpux01\nCREATE TABLE itpux01\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\nCONN itpux02 / itpux02\nCREATE TABLE itpux02\n(\n    id    NUMBER (30) PRIMARY KEY NOT NULL,\n    name DATE\n);\n\n```\n\n* 创建2个存储过程并执行\n```sql\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux01';\nEND p_itpux01;\n/\n\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE 'select count(*) from itpux02';\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n```\n\n* 查询验证数据\n```sql\nCONN itpux01 / itpux01\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id > 990;\n\nCONN itpux02 / itpux02\n\nSELECT COUNT (*) FROM itpux02;\n\nSELECT *\n  FROM itpux02\n WHERE id > 1990;\n```\n\n* 本地用Exp做导出\n```sql\nEXP SYSTEM/oracle OWNER=itpux01,itpux02 COMPRESS=n FILE=exp_2table.dmp LOG=exp_2table.LOG direct=y recordlength=65535 buffer=4096000\n```\n\n* imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报\n```sql\n/* Formatted on 2018/1/30 20:03:14 (QP5 v5.313) */\nSPOOL itpux_object_create_scripts.sql\nSET LONG 2000000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 180\n\nSELECT DBMS_METADATA.get_ddl ('USER', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('OBJECT_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('ROLE_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('SYSTEM_GRANT', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX01') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('USER', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('OBJECT_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('ROLE_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_granted_ddl ('SYSTEM_GRANT', 'ITPUX02') FROM DUAL;\n\nSELECT DBMS_METADATA.get_ddl ('TABLESPACE', 'ITPUX02') FROM DUAL;\n\nSPOOL OFF;\n```\n\n* 异机用imp做导入\n```sql\nimp SYSTEM/oracle fromuser=itpux01,itpux02 touser=itpux01,itpux02 FILE=exp_2table.dmp LOG=exp_2table.LOG COMMIT=y IGNORE=y buffer=4096000\n```\n\n* 验证导入后的数据合法性\n```sql\n\n```\n\n### 6.4 数据迁移后的验证方案\n>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n```sql\nSELECT COUNT (*) FROM itpux.itpux01;\n```\n>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。\n```sql\n  SELECT object_type s_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\n  SELECT object_type t_object_type, COUNT (*)\n    FROM dba_objects\n   WHERE owner = 'ITPUX01'\nGROUP BY object_type;\n\nSELECT *\n  FROM dba_objects\n WHERE status <> 'VALID' AND owner = 'ITPUX01';\n```\n* dblink两个库一起查\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = 'ITPUX01'\n        GROUP BY object_type) t;\n```\n* 自动生成编译无效对象SQL及编译过程\n>统计当前用户无效对象数量\n```sql\n  SELECT owner,\n         object_type,\n         status,\n         COUNT (*)\n    FROM dba_objects\n   WHERE status <> 'VALID'\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n```\n\n>生成编译无效对象SQL\n```sql\nSELECT    'ALTER '\n       || OBJECT_TYPE\n       || ' '\n       || OWNER\n       || '.'\n       || OBJECT_NAME\n       || ' COMPILE;'\n  FROM dba_objects\n WHERE     status <> 'VALID'\n       AND object_type IN ('PACKAGE',\n                           'PACKAGE BODY',\n                           'FUNCTION',\n                           'PROCEDURE',\n                           'TRIGGER',\n                           'VIEW');\n```\n>通过复制以上SQL语句,直接手动执行编译执行.\n也可以采用如下方式在oracle用户下进行手工编译\n```sql\nsu - oracle\n$ sqlplus / as sysdba\nSQL> @$ORACLE_HOME/rdbms/admin/utlrp.sql\n```\n## 7.exp / imp迁移过程字符集的处理\n> 进行数据的导入导出时，我们要注意关于字符集的问题。在EXP/IMP过程中我们需要注意四个字符集的参数：\n```shell\n01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n04.导入端数据库字符集。\n```\n>我们首先需要查看这四个字符集参数。\n查看数据库的字符集的信息：\n```sql\nSQL> select * from nls_database_parameters;\n//SQL> select * from props$;\nSQL> SET PAGESIZE 30\nSQL> select * from nls_database_parameters;\n\nPARAMETER                      VALUE\n------------------------------ ------------------------------\nNLS_LANGUAGE                   AMERICAN\nNLS_TERRITORY                  AMERICA\nNLS_CURRENCY                   $\nNLS_ISO_CURRENCY               AMERICA\nNLS_NUMERIC_CHARACTERS         .,\nNLS_CHARACTERSET               ZHS16GBK\nNLS_CALENDAR                   GREGORIAN\nNLS_DATE_FORMAT                DD-MON-RR\nNLS_DATE_LANGUAGE              AMERICAN\nNLS_SORT                       BINARY\nNLS_TIME_FORMAT                HH.MI.SSXFF AM\nNLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM\nNLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR\nNLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR\nNLS_DUAL_CURRENCY              $\nNLS_COMP                       BINARY\nNLS_LENGTH_SEMANTICS           BYTE\nNLS_NCHAR_CONV_EXCP            FALSE\nNLS_NCHAR_CHARACTERSET         UTF8\nNLS_RDBMS_VERSION              11.2.0.4.0\n\n20 rows selected.\n\n```\n>我们再来查看客户端的字符集信息：\n客户端字符集的参数NLS_LANG=_< territory >.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n\n* 如数据库语言环境\n>os是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>os是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n\\\n\n>$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n>永久修改可用：\nvi bash_profile\n\n* 通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n>&emsp;&emsp;(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n&emsp;&emsp;(2) 源数据库和目标数据库字符集不同。\n&emsp;&emsp;先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n&emsp;&emsp;这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n## 8.exp / imp优化的方法\n>当需要exp/imp的数据量比较大时，这个过程需要的时间是比较长的，我们可以用一些方法来优化exp/imp的操作。\n\n* 01.exp:使用直接路径 direct=y\n>&emsp;&emsp;oracle会避开sql语句处理引擎,直接从数据库文件中读取数据,然后写入导出文件.\n&emsp;&emsp;可以在导出日志中观察到: exp-00067: table xxx will be exported in conventional path\n&emsp;&emsp;如果没有使用直接路径,必须保证buffer参数的值足够大.\n&emsp;&emsp;有一些参数于direct=y不兼容,无法用直接路径导出可移动的tablespace,或者用query参数导出数据库子集.\n&emsp;&emsp;当导入导出的数据库运行在不同的os下时,必须保证recordlength参数的值一致.\n\n* 02.exp: 清空回收站\n```sql\nSQL> select count(*) from dba_recyclebin;\nSQL> purge dba_recyclebin;\n```\n\n* 03.imp:避免磁盘排序\n>涉及到sort_area_size参数,也就是我们的PGA要够大。\n\n* 05.imp:优化日志缓冲区\n>比如将log_buffer容量扩大10倍(最大不要超过5M),也就是我们的SGA要够大。\n\n* 05.imp:避免日志切换等待\n>增加重做日志组的数量,增大日志文件大小.\n\n* 06.imp:使用commit\n>commit = y\n注意:这个方式不能处理包含LOB和LONG类型的表,对于这样的table,如果使用commit = y,每插入一行,就会执行一次提交.\n\n* 07.imp:使用NOLOGGING方式减小重做日志大小\n>在导入时指定参数indexes=n,只导入数据而忽略index,在导完数据后在通过脚本创建index,指定NOLOGGING选项\n\n## 9.exp / imp 常见问题及解决方法\n### 9.1 关于imp/exp版本的问题\n>一般来说，从低版本导入到高版本问题不大，麻烦的是将高版本的数据导入到低版本中。\n* 可以跨版本的使用EXP/IMP，但必须正确地使用EXP和IMP的版本（官方可查）：\n```sql\n1、使用IMP的版本匹配数据库的版本，如：要导入到11.2中，使用11.2的IMP工具。\n2、使用EXP的版本匹配两个数据库中最低的版本，如：从11.2往10.2中导入，则使用10.2版本的EXP工具。\n3、高版本的Export导出来的转储文件，低版本的Import读不了；低版本的Export导出来的转储文件，高版本的Import可以进行读取。\n4、从Oracle低版本的Export数据可以Import到Oracle高版本中，但限于Oracle的相邻版本，两个不相邻版本间进行转换应借助中间版本。\n5、exp/imp可以做到在不同版本Oracle、不同数据库上的迁移。\n```\n\n### 9.2 数据库对象已经存在\n>&emsp;&emsp;一般情况, 导入数据前应该彻底删除目标数据下的表, 序列, 函数/过程,触发器等; 数据库对象已经存在, 按缺省的imp参数, 则会导入失败如果用了参数ignore=y, 会把exp文件内的数据内容导入如果表有唯一关键字的约束条件, 不合条件将不被导入如果表没有唯一关键字的约束条件, 将引起记录重复\n### 9.3 数据库对象有主外键约束\n>不符合主外键约束时, 数据会导入失败,\n解决办法:\n先导入主表, 再导入依存表\ndisable目标导入对象的主外键约束, 导入数据后, 再enable它们\n### 9.4 权限不够\n>如果要把A用户的数据导入B用户下, A用户需要有imp_full_database权限\n### 9.5 导入大表存储分配失败\n>&emsp;&emsp;默认的EXP时, compress = y, 也就是把所有的数据压缩在一个数据块上.\n导入时, 如果不存在连续一个大数据块, 则会导入失败. 导出大表时, 记得compress= n, 则不会引起这种错误.\n### 9.6 imp和exp使用的字符集不同\n>&emsp;&emsp;如果字符集不同, 导入会失败, 可以改变unix环境变量或者NT注册表里NLS_LANG相关信息. 导入完成后再改回来.\n\n### 9.7 imp和exp版本不能往上兼容\n>可以从低版本导入高版本，但不能从高版本导入到低版本。\n如果遇到迁移因版本不同的问题，可以用低版本的export 导出，到导入到低版本。\n\n### 9.8 导出统计信息的问题。\n>&emsp;&emsp;如果导出统计信息,在只导出部分数据,或不导出数据时,导出统计信息会报错.另如果未导出统计信息,但导入时,需导入统计信息\n,那此时,导入后,统计信息会被锁住,而无法更新统计信息.\n&emsp;&emsp;此时,我们可使用包dbms_stats.unlock_schema_stats来解锁.最好的办法是,在exp,imp时,加入参数statistics=none,不exp,imp统计信息,在导入完成后,在重新收集统计信息.\n\n```sql\nBEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nBEGIN\n    DBMS_STATS.gather_schema_stats ('ITPUX02');\nEND;\n/\n```","slug":"oracle/Oracle数据库逻辑备份恢复迁移之exp与imp","published":1,"updated":"2019-05-03T15:55:51.284Z","_id":"cjv89en3f002xi0cdqjbci7kl","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle数据库逻辑备份恢复迁移之exp与imp\"><a href=\"#Oracle数据库逻辑备份恢复迁移之exp与imp\" class=\"headerlink\" title=\"Oracle数据库逻辑备份恢复迁移之exp与imp\"></a>Oracle数据库逻辑备份恢复迁移之exp与imp</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-export与import逻辑备份恢复概述\"><a href=\"#1-export与import逻辑备份恢复概述\" class=\"headerlink\" title=\"1.export与import逻辑备份恢复概述\"></a>1.export与import逻辑备份恢复概述</h2><h3 id=\"1-1-备份概述\"><a href=\"#1-1-备份概述\" class=\"headerlink\" title=\"1.1 备份概述\"></a>1.1 备份概述</h3><ul>\n<li>备份可分为两类，物理备份和逻辑备份<blockquote>\n<p>&emsp;&emsp;物理备份：该方法实现数据库的完整恢复，但需要极大的外部存储设备，例如磁带库，具体包括冷备份和热备份。冷备份和热备份(热备份要求数据库运行在归档模式下)都是物理备份，它涉及到组成数据库的文件，但不考虑逻辑内容。<br>&emsp;&emsp;逻辑备份： 使用软件技术从数据库中导出数据并写入一个输出文件，该文件的格式一般与原数据库的文件格式不同，只是 原数据库中数据内容的一个映像。因此，逻辑备份文件只能用来对数据库进行逻辑恢复，即数据导入，而不能按数据库原来的存储特征进行物理恢复。逻辑备份一般 用于增量备份，即备份那些在上次备份以后改变的数据。<br>&emsp;&emsp;Oracle 的导出导入是一个很常用的迁移工具。 在Oracle 10g以后，Oracle 推出了数据泵(expdp/impdp).它可以通过使用并行，从而在效率上要比exp/imp 要高。但是这个exp/imp很多时候还需要使用。<br>&emsp;&emsp;导入/导出是ORACLE幸存的最古老的两个命令行工具，其实我从来不认为Exp/Imp是一种好的备份方式，正确的说法是Exp/Imp只能是一个好的转储工具，特别是在小型数据库的转储，表空间的迁移，表的抽取，检测逻辑和物理冲突等中有不小的功劳。当然，我们也可以把它作为小型数据库的物理备份后的一个逻辑辅助备份，也是不错的建议。对于越来越大的数据库，特别是TB级数据库和越来越多数据仓库的出现，EXP/IMP越来越力不从心了，这个时候，数据库的备份都转向了RMAN和第三方工具。下面说明一下EXP/IMP的使用。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"2-export与import参数详解\"><a href=\"#2-export与import参数详解\" class=\"headerlink\" title=\"2.export与import参数详解\"></a>2.export与import参数详解</h2><h3 id=\"2-1-export参数详解\"><a href=\"#2-1-export参数详解\" class=\"headerlink\" title=\"2.1 export参数详解\"></a>2.1 export参数详解</h3><pre class=\" language-shell\"><code class=\"language-shell\">[oracle@orcl:/]$exp -help\n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 18:30:39 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Export prompt you for parameters by entering the EXP\ncommand followed by your username/password:\n\n     Example: EXP SCOTT/TIGER\n\nOr, you can control how Export runs by entering the EXP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  EXP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: EXP SCOTT/TIGER GRANTS=Y TABLES=(EMP,DEPT,MGR)\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword    Description (Default)      Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID     username/password          FULL         export entire file (N)\nBUFFER     size of data buffer        OWNER        list of owner usernames\nFILE       output files (EXPDAT.DMP)  TABLES       list of table names\nCOMPRESS   import into one extent (Y) RECORDLENGTH length of IO record\nGRANTS     export grants (Y)          INCTYPE      incremental export type\nINDEXES    export indexes (Y)         RECORD       track incr. export (Y)\nDIRECT     direct path (N)            TRIGGERS     export triggers (Y)\nLOG        log file of screen output  STATISTICS   analyze objects (ESTIMATE)\nROWS       export data rows (Y)       PARFILE      parameter filename\nCONSISTENT cross-table consistency(N) CONSTRAINTS  export constraints (Y)\n\nOBJECT_CONSISTENT    transaction set to read only during object export (N)\nFEEDBACK             display progress every x rows (0)\nFILESIZE             maximum size of each dump file\nFLASHBACK_SCN        SCN used to set session snapshot back to\nFLASHBACK_TIME       time used to get the SCN closest to the specified time\nQUERY                select clause used to export a subset of a table\nRESUMABLE            suspend when a space related error is encountered(N)\nRESUMABLE_NAME       text string used to identify resumable statement\nRESUMABLE_TIMEOUT    wait time for RESUMABLE \nTTS_FULL_CHECK       perform full or partial dependency check for TTS\nVOLSIZE              number of bytes to write to each tape volume\nTABLESPACES          list of tablespaces to export\nTRANSPORT_TABLESPACE export transportable tablespace metadata (N)\nTEMPLATE             template name which invokes iAS mode export\n\nExport terminated successfully without warnings.\n</code></pre>\n<ul>\n<li>EXP的所有参数（括号中为参数的默认值）：<blockquote>\n<p>可以通过exp help=y或者imp help=y查看exp或imp的详细参数，下面以exp为例解释参数意义<br>USERID：用户名/口令</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>FULL：导出整个数据库，只有拥有exp_full_database角色的用户或者特权用户如sys，system等才能进行全库导出。 示例如下<br>exp “‘/ as sysdba’” full=y</p>\n</blockquote>\n<blockquote>\n<p>BUFFER：制定数据缓冲区大小，主要用于提高exp/imp速度，该单位为字节，不能写成buffer=1m的形式，应写成字节为单位的参数，如buffer=1048576<br>exp hr/hr file=t_b.dmp buffer= 1048576 tables=T</p>\n</blockquote>\n<blockquote>\n<p>OWNER：需要导出的用户，示例如下<br>exp “‘/ as sysdba’” owner=(hr,ITPUX02) file=hr_ITPUX02.dmp<br>上例中由于是在linux平台进行测试的，需要对 owner=(hr,ITPUX02)使用\\进行转义</p>\n</blockquote>\n<blockquote>\n<p>FILE：输出文件</p>\n</blockquote>\n<blockquote>\n<p>TABLES：需要导出的表</p>\n</blockquote>\n<blockquote>\n<p>COMPRESS：导入到一个区 (Y) 。主要目的是为了消除存储碎片，以保证某张表的所有记录都存储在连续的空间里。 但是负面效应很明显， 如果该参数值为y，则会将高水位线以下的所有extent导入到一个区中， 因此在导入时很有可能出现，明明表中数据很少，但是却花了很多时间在建立的extent上。 且自oracle9i开始，使用了本地管理的表空间，存储碎片的问题应该比低版本好多了，个人建议将compress设为n。</p>\n</blockquote>\n<ul>\n<li><p>DIRECT：直接路径 (N)。</p>\n<blockquote>\n<p>传统模式导出和直接路径导出的原理<br>传 统模式导出相当于使用select语句从表中取出数据，数据从磁盘上先读到buffer cache中，记录被转移到一个评估检测的缓冲区中，数据经过语法检测后没有问题，将数据传给PGA，最后写入导出的文件中。如果使用Direct Path模式导出，数据直接从磁盘上读取到导出的PGA中：记录直接被转换导出会话的私有buffer中。这也就是意味着SQL语句处理层被忽略掉了，因 为数据已经是符合导出的格式了，不需要其他的转换处理了。数据直接被传送给导出的客户端，最后写入导出文件。过程可概况如下</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">direct=n datafile---->sga----->pga----->dump\ndirect=y datafile---->pga----->dump\n</code></pre>\n<p>传统路径导出VS直接路径导出(oracle exp direct=y)两者的差异<br>a、 Conventional path Export<br>&emsp;&emsp; 传统路径模式使用SQL SELECT语句抽取表数据。数据从磁盘读入到buffer cache缓冲区中，行被转移到评估缓冲区。在此之后根据SQL表达式，将记录返回给导出客户端，然后写入到dump文件。<br>b、Direct path Export<br>&emsp;&emsp; 直接导出模式，数据直接从磁盘中读取到导出session的PGA中，行被直接转移到导出session的私有缓冲区，从而跳过SQL命令处理层。<br>避免了不必要的数据转换。最后记录返回给导出客户端，写到dump文件。</p>\n</blockquote>\n</li>\n<li><p>传统路径导出VS直接路径导出(oracle exp direct=y)性能问题</p>\n<blockquote>\n<p>&emsp;&emsp; a、直接路径导出方式比传统路径方式具有更优的性能，速度更快，因为绕过了SQL命令处理部分。<br>&emsp;&emsp; b、直接路径导出方式支持RECORDLENGTH参数(最大为64k)，该参数值通常建议设置为系统I/O或者DB_BLOCK_SIZE的整数倍<br>&emsp;&emsp; c、影响直接路径导出的具体因素(DB_BLOCK_SIZE，列的类型，I/O性能，即数据文件所在的磁盘驱动器是否单独于dump文件所在的磁盘驱动器)<br>&emsp;&emsp; d、无论是直接路径导出还是传统路径导出产生的dump，在使用imp方式导入时，会耗用相同的时间.</p>\n</blockquote>\n</li>\n<li><p>传统路径导出VS直接路径导出(oracle exp direct=y)直接路径导出的限制</p>\n<blockquote>\n<p>a、直接路径导出不支持交互模式<br>b、不支持表空间传输模式(即transport_tablespaces=y不被支持)，支持的是full,owner,tables导出方式<br>c、不支持query查询方式，如exp scott/tiger tables=emp query=\\”where job=\\’salesman\\’ \\” 不被支持<br>d、直接路径导出使用recordlength设置一次可以导出数据的量，取代传统路径使用buffer的设置<br>e、直接路径导出要求nls_lang环境参数等于数据库字符集，负责收到exp-41警告及exp-0终止错误</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>GRANTS：导出权限 (Y)<br>INCTYPE：增量导出类型，已废除<br>INDEXES：导出索引 (Y)<br>RECORD：跟踪增量导出 (Y) ，已废除<br>TRIGGERS：导出触发器 (Y)<br>LOG：屏幕输出的日志文件</p>\n</blockquote>\n<blockquote>\n<p>STATISTICS：在导出文件中保留对象的统计信息，默认值ESTIMATE，还可以为compute或者none。如果导出时出现<br>EXP-00091: Exporting questionable statistics<br>可以考虑将 STATISTICS设置为NONE<br>ROWS：确定表中的数据行是否导出，默认为Y，导出</p>\n</blockquote>\n<blockquote>\n<p>QUERY：用于导出表的子集的select子句，示例如下<br>exp hr/hr file=emp_q.dmp tables=employees query=\\”where hire_date >to_date(\\’1999-01-01\\’\\,\\’yyyy-mm-dd\\’)\\”</p>\n</blockquote>\n<ul>\n<li>PARFILE：参数文件名，可以用如下方式导出<pre class=\" language-sql\"><code class=\"language-sql\">exp hr<span class=\"token operator\">/</span>hr parfile<span class=\"token operator\">=</span>parfile\n$ cat parfile\n<span class=\"token keyword\">file</span><span class=\"token operator\">=</span>t_p<span class=\"token punctuation\">.</span>dmp\ncompress<span class=\"token operator\">=</span>y\n<span class=\"token keyword\">rows</span><span class=\"token operator\">=</span>y\n<span class=\"token keyword\">tables</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span>empl<span class=\"token operator\">%</span>s<span class=\"token punctuation\">)</span>\n</code></pre>\n</li>\n</ul>\n<blockquote>\n<p>使用parfile参数可以对频繁进行的导出操作进行反复调用，同时也可以避免不同操作系统之间需要对特定字符进行转义的烦恼，如下例</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">exp hr<span class=\"token operator\">/</span>hr parfile<span class=\"token operator\">=</span>parfile\n$cat parfile\n<span class=\"token keyword\">file</span><span class=\"token operator\">=</span>t_p<span class=\"token punctuation\">.</span>dmp\ncompress<span class=\"token operator\">=</span>y\n<span class=\"token keyword\">rows</span><span class=\"token operator\">=</span>y\n<span class=\"token keyword\">tables</span><span class=\"token operator\">=</span>employees\n<span class=\"token keyword\">statistics</span><span class=\"token operator\">=</span>none\nquery<span class=\"token operator\">=</span><span class=\"token string\">\"where hire_date>to_date('1999-01-01','yyyy-mm-dd')\"</span>\n</code></pre>\n<p>CONSISTENT：在导出时，将影响正在导出的表的事务设为只读，主要作用于嵌套表和分区表，默认为N。<br>CONSTRAINTS：导出的约束条件 (Y)<br>OBJECT_CONSISTENT:只在对象导出期间设置为只读的事务处理 (N)<br>FEEDBACK:每 x 行显示进度，默认为0<br>FILESIZE：每个导出文件的最大大小<br>FLASHBACK_SCN：用于将会话快照设置回以前状态的SCN<br>FLASHBACK_TIME：用于获取最接近指定时间的SCN的时间<br>RESUMABLE：遇到空间不足时的错误时挂起，默认为N，需与 RESUMABLE_NAME和 RESUMABLE_TIMEOUT一起使用<br>RESUMABLE_NAME：用于标示哪个会话需要使用 RESUMABLE选项，格式为 User USERNAME (USERID), Session SESSIONID, Instance INSTANCEID<br>RESUMABLE_TIMEOUT：RESUMABLE的等待时间，默认为7200s，如果在指定时间内未解决问题，则操作中断<br>TTS_FULL_CHECK：对TTS执行完整或部分相关性检查<br>TABLESPACES：要导出的表空间列表，示例如下<br>exp “‘/ as sysdba’” file=t_ts.dmp tablespaces=(users,example)<br>TRANSPORT_TABLESPACE 导出可传输的表空间元数据 (N)<br>直接备份到磁带上<br>exp icdmain/icd rows=y indexes=n compress=n buffer=65536 feedback=100000 file=/dev/rmt0 log=exp.log tables=(tab1,tab2,tab3)<br>注：在磁盘空间允许的情况下，应先备份到本地服务器，然后再拷贝到磁带。出于速度方面的考虑，尽量不要直接备份到磁带设备</p>\n</blockquote>\n<h3 id=\"2-2-import参数详解\"><a href=\"#2-2-import参数详解\" class=\"headerlink\" title=\"2.2 import参数详解\"></a>2.2 import参数详解</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">[</span>oracle<span class=\"token variable\">@orcl</span>:<span class=\"token operator\">/</span><span class=\"token punctuation\">]</span>$imp <span class=\"token operator\">-</span>help\n\n<span class=\"token keyword\">Import</span>: <span class=\"token keyword\">Release</span> <span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span> <span class=\"token operator\">-</span> Production <span class=\"token keyword\">on</span> Tue Jan <span class=\"token number\">30</span> <span class=\"token number\">19</span>:<span class=\"token number\">01</span>:<span class=\"token number\">13</span> <span class=\"token number\">2018</span>\n\nCopyright <span class=\"token punctuation\">(</span><span class=\"token number\">c</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1982</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2011</span><span class=\"token punctuation\">,</span> Oracle <span class=\"token operator\">and</span><span class=\"token operator\">/</span><span class=\"token operator\">or</span> its affiliates<span class=\"token punctuation\">.</span>  <span class=\"token keyword\">All</span> rights reserved<span class=\"token punctuation\">.</span>\n\n\n\nYou can let <span class=\"token keyword\">Import</span> prompt you <span class=\"token keyword\">for</span> parameters <span class=\"token keyword\">by</span> entering the IMP\ncommand followed <span class=\"token keyword\">by</span> your username<span class=\"token operator\">/</span>password:\n\n     Example: IMP SCOTT<span class=\"token operator\">/</span>TIGER\n\n<span class=\"token operator\">Or</span><span class=\"token punctuation\">,</span> you can control how <span class=\"token keyword\">Import</span> runs <span class=\"token keyword\">by</span> entering the IMP command followed\n<span class=\"token keyword\">by</span> various arguments<span class=\"token punctuation\">.</span> <span class=\"token keyword\">To</span> specify parameters<span class=\"token punctuation\">,</span> you <span class=\"token keyword\">use</span> keywords:\n\n     Format:  IMP KEYWORD<span class=\"token operator\">=</span><span class=\"token keyword\">value</span> <span class=\"token operator\">or</span> KEYWORD<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>value1<span class=\"token punctuation\">,</span>value2<span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>valueN<span class=\"token punctuation\">)</span>\n     Example: IMP SCOTT<span class=\"token operator\">/</span>TIGER <span class=\"token keyword\">IGNORE</span><span class=\"token operator\">=</span>Y <span class=\"token keyword\">TABLES</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>EMP<span class=\"token punctuation\">,</span>DEPT<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FULL</span><span class=\"token operator\">=</span>N\n               <span class=\"token operator\">or</span> <span class=\"token keyword\">TABLES</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>T1:P1<span class=\"token punctuation\">,</span>T1:P2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span> T1 <span class=\"token operator\">is</span> partitioned <span class=\"token keyword\">table</span>\n\nUSERID must <span class=\"token number\">be</span> the <span class=\"token keyword\">first</span> parameter <span class=\"token keyword\">on</span> the command line<span class=\"token punctuation\">.</span>\n\nKeyword  Description <span class=\"token punctuation\">(</span><span class=\"token keyword\">Default</span><span class=\"token punctuation\">)</span>       Keyword      Description <span class=\"token punctuation\">(</span><span class=\"token keyword\">Default</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">--------------------------------------------------------------------------</span>\nUSERID   username<span class=\"token operator\">/</span>password           <span class=\"token keyword\">FULL</span>         <span class=\"token keyword\">import</span> entire <span class=\"token keyword\">file</span> <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nBUFFER   size <span class=\"token keyword\">of</span> <span class=\"token keyword\">data</span> buffer         FROMUSER     list <span class=\"token keyword\">of</span> owner usernames\n<span class=\"token keyword\">FILE</span>     input files <span class=\"token punctuation\">(</span>EXPDAT<span class=\"token punctuation\">.</span>DMP<span class=\"token punctuation\">)</span>    TOUSER       list <span class=\"token keyword\">of</span> usernames\n<span class=\"token keyword\">SHOW</span>     just list <span class=\"token keyword\">file</span> contents <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span> <span class=\"token keyword\">TABLES</span>       list <span class=\"token keyword\">of</span> <span class=\"token keyword\">table</span> names\n<span class=\"token keyword\">IGNORE</span>   <span class=\"token keyword\">ignore</span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">errors</span> <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>    RECORDLENGTH length <span class=\"token keyword\">of</span> IO record\nGRANTS   <span class=\"token keyword\">import</span> grants <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>           INCTYPE      incremental <span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span>\nINDEXES  <span class=\"token keyword\">import</span> indexes <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>          <span class=\"token keyword\">COMMIT</span>       <span class=\"token keyword\">commit</span> array <span class=\"token keyword\">insert</span> <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ROWS</span>     <span class=\"token keyword\">import</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">rows</span> <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>        PARFILE      parameter filename\nLOG      log <span class=\"token keyword\">file</span> <span class=\"token keyword\">of</span> screen output   CONSTRAINTS  <span class=\"token keyword\">import</span> constraints <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>\nDESTROY                overwrite <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">file</span> <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nINDEXFILE              <span class=\"token keyword\">write</span> <span class=\"token keyword\">table</span><span class=\"token operator\">/</span><span class=\"token keyword\">index</span> info <span class=\"token keyword\">to</span> specified <span class=\"token keyword\">file</span>\nSKIP_UNUSABLE_INDEXES  skip maintenance <span class=\"token keyword\">of</span> unusable indexes <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nFEEDBACK               display progress every x <span class=\"token keyword\">rows</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTOID_NOVALIDATE        skip validation <span class=\"token keyword\">of</span> specified <span class=\"token keyword\">type</span> ids \nFILESIZE               maximum size <span class=\"token keyword\">of</span> each <span class=\"token keyword\">dump</span> <span class=\"token keyword\">file</span>\n<span class=\"token keyword\">STATISTICS</span>             <span class=\"token keyword\">import</span> precomputed <span class=\"token keyword\">statistics</span> <span class=\"token punctuation\">(</span>always<span class=\"token punctuation\">)</span>\nRESUMABLE              suspend <span class=\"token keyword\">when</span> <span class=\"token number\">a</span> space related error <span class=\"token operator\">is</span> encountered<span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nRESUMABLE_NAME         <span class=\"token keyword\">text</span> string used <span class=\"token keyword\">to</span> identify resumable statement\nRESUMABLE_TIMEOUT      wait time <span class=\"token keyword\">for</span> RESUMABLE \nCOMPILE                compile procedures<span class=\"token punctuation\">,</span> packages<span class=\"token punctuation\">,</span> <span class=\"token operator\">and</span> functions <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>\nSTREAMS_CONFIGURATION  <span class=\"token keyword\">import</span> streams general metadata <span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>\nSTREAMS_INSTANTIATION  <span class=\"token keyword\">import</span> streams instantiation metadata <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nDATA_ONLY              <span class=\"token keyword\">import</span> only <span class=\"token keyword\">data</span> <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nVOLSIZE                number <span class=\"token keyword\">of</span> bytes <span class=\"token operator\">in</span> <span class=\"token keyword\">file</span> <span class=\"token keyword\">on</span> each volume <span class=\"token keyword\">of</span> <span class=\"token number\">a</span> <span class=\"token keyword\">file</span> <span class=\"token keyword\">on</span> tape\n\nThe <span class=\"token keyword\">following</span> keywords only <span class=\"token keyword\">apply</span> <span class=\"token keyword\">to</span> transportable tablespaces\nTRANSPORT_TABLESPACE <span class=\"token keyword\">import</span> transportable <span class=\"token keyword\">tablespace</span> metadata <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>\nTABLESPACES tablespaces <span class=\"token keyword\">to</span> <span class=\"token number\">be</span> transported <span class=\"token keyword\">into</span> <span class=\"token keyword\">database</span>\nDATAFILES datafiles <span class=\"token keyword\">to</span> <span class=\"token number\">be</span> transported <span class=\"token keyword\">into</span> <span class=\"token keyword\">database</span>\nTTS_OWNERS users that own <span class=\"token keyword\">data</span> <span class=\"token operator\">in</span> the transportable <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">set</span>\n\n<span class=\"token keyword\">Import</span> terminated successfully without <span class=\"token keyword\">warnings</span><span class=\"token punctuation\">.</span>\n</code></pre>\n<ul>\n<li><p>IMP的所有参数（括号中为参数的默认值）：</p>\n<blockquote>\n<p>i&emsp;&emsp;mp的参数和exp的大致相同，下面是常用参数的解释，与exp相同的这就不再赘述<br>&emsp;&emsp;ignore：Oracle在恢复数据的过程中，当导入某个表时，该表已经存在，就要根据ignore参数的设置来决定如何操作。若 ignore=y，Oracle不执行CREATE TABLE语句，直接将数据插入到表中，如果插入的记录违背了约束条件，比如主键约束，唯一索引等，则出错的记录不会插入，但合法的记录会添加到表中。若 ignore=n，Oracle不执行CREATE TABLE语句，同时也不会将数据插入到表中，而是忽略该表的错误，继续导入下一个表。 注<br>意：如果表中的字段并没有唯一性约束，那么在使用ignore=y的情况下很有可能插入重复数据。<br>&emsp;&emsp;indexes：在恢复数据的过程中，若indexes=n，则表上的索引不会被恢复，但是对 LOB 索引, OID索引和 主键索引等系统自动生成的索引将无条件恢复。<br>&emsp;&emsp;indexfile：不进行导入操作而是将创建对象的文本保存到文件中，可以通过编辑使用该文本文件创建数据库对象。<br>&emsp;&emsp;fromuser,touser:这两个参数可以组合使用，也可以分开使用。他们可以实现将源用户的对象数据，导入到目标用户schema底下的功能。这里要注意，导入时的用户需要有<br>imp_full_database角色，示例如下<br>导入一个或一组指定用户所属的全部对象<br>$imp system/manager file=full_all.dmp log=seapark fromuser=hr<br>$imp system/manager file=seapark log=seapark fromuser=(seapark,amy,amyc,harold)<br>将一个或一组指定用户所属的全部对象导入到另一个用户下<br>$imp hr/hr fromuser=hr touser=czm file=hr_all.dmp<br>$imp system/manager file=tank log=tank fromuser=(seapark,amy) touser=(seapark1, amy1)<br>commit：默认值为 COMMIT=N，及在每插入完一个对象后提交。 当COMMIT=Y时候是根据你BUFFER的大小决定每次提交的数量。对于包含了LONG、RAW、 DATE等类型的表，不论BUFFER设置多大，都是每插入一行进行提交。设置commit=y可以防止减少回滚段的压力，但由于频繁提交，会带来性能 上的影响，推荐使用COMMIT=N。</p>\n</blockquote>\n</li>\n<li><p>下列关键字仅用于可传输的表空间</p>\n<blockquote>\n<p>TRANSPORT_TABLESPACE 导入可传输的表空间元数据 (N)<br>TABLESPACES 将要传输到数据库的表空间<br>DATAFILES 将要传输到数据库的数据文件<br>TTS_OWNERS 拥有可传输表空间集中数据的用户</p>\n</blockquote>\n</li>\n<li><p>关于增量参数的说明：exp/imp的增量并不是真正意义上的增量，所以最好不要使用。</p>\n</li>\n</ul>\n<h2 id=\"3-exp-imp常用语法\"><a href=\"#3-exp-imp常用语法\" class=\"headerlink\" title=\"3.exp / imp常用语法\"></a>3.exp / imp常用语法</h2><h3 id=\"3-1-exp\"><a href=\"#3-1-exp\" class=\"headerlink\" title=\"3.1 exp\"></a>3.1 exp</h3><ul>\n<li><p>完全</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" compress=n buffer=4096000 feedback=100000 full=y file=exp_itpuxdb.dmp log=exp_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n</code></pre>\n</li>\n<li><p>用户</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 owner=itpux file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n--exp itpux/itpux compress=n buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n</code></pre>\n</li>\n<li><p>表</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">exp itpux/itpux compress=n buffer=4096000 feedback=100000 tables=t1,t2,t2 file=exp_t1_itpuxdb.dmp log=exp_t1_itpuxdb.log\n</code></pre>\n</li>\n<li><p>other</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 rows=n file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n</code></pre>\n</li>\n</ul>\n<h3 id=\"3-2-imp\"><a href=\"#3-2-imp\" class=\"headerlink\" title=\"3.2 imp\"></a>3.2 imp</h3><ul>\n<li><p>完全</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">imp system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--exp \\\"/ as sysdba\\\" system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n</code></pre>\n</li>\n<li><p>用户</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">imp system/oracle fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n--imp itpux/itpux fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n</code></pre>\n</li>\n<li><p>表</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">imp itpux/itpux fromuser=itpux touser=itpux tables=t1,t2,t3 ignore=y buffer=4096000 feedback=100000 file=exp_t1_itpuxdb.dmp log=imp_t1_itpuxdb.log\n</code></pre>\n</li>\n</ul>\n<h2 id=\"4-配置生产环境的逻辑自动备份策略\"><a href=\"#4-配置生产环境的逻辑自动备份策略\" class=\"headerlink\" title=\"4.配置生产环境的逻辑自动备份策略\"></a>4.配置生产环境的逻辑自动备份策略</h2><blockquote>\n<p>要求：每天早上5点做逻辑全备，备份文件保留一周。<br><code>`</code>shell<br>vi /backup/scripts/expfull_db01.sh<br>export BAKDATE=<code>date +%Y%m%d</code><br>export ORACLE_SID=db01<br>nohup exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=/backup/expfull_db01_$BAKDATE.dmp log=/backup/expfull_db01_$BAKDATE.log &amp;<br>gzip -f /backup/expfull_db01_$BAKDATE.dmp<br>find /backup -name expfull_db01_*.dmp.gz -atime +2 -exec rm -rf {} \\;</p>\n</blockquote>\n<p>#chown -R oracle:dba /backup/expfull_db01.sh</p>\n<p>#chmod 775 /backup/expfull_db01.sh</p>\n<p>#crontab -e<br>00 05 <em> </em> * su - oracle -c /backup/scripts/expfull_db01.sh</p>\n<pre><code>\n## 5.exp / imp生产环境数据迁移流程和注意事项\n### 5.1 数据迁移的目的\n&gt;使用exp/imp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n### 5.2 数据迁移的适用范围\n&gt;所有线上库9i ,10g &gt; 11g 12c \n&gt;11g不建用了，\n### 5.3 数据迁移的风险评估\n&gt;&amp;emsp;&amp;emsp;01.exp导出数据时没有使用compress=n参数，会导致所有数据被压缩在一个extent里，导入可能由于没有连续的blocks满足需要，导致imp失败。\n&amp;emsp;&amp;emsp;02.有些os对文件大小有限制，exp数据时需要使用filesize参数来分割导出文件\n&amp;emsp;&amp;emsp;03.exp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n&amp;emsp;&amp;emsp;05.imp导入数据时没有使用ignore=y参数，目标库上存在表的情况下数据无法导入\n&amp;emsp;&amp;emsp;05.imp导入大量数据时没有使用commit=y参数，导致事务太久，undo资源占用过大无法及时回收。\n&amp;emsp;&amp;emsp;06.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n&amp;emsp;&amp;emsp;07.imp跨schema进行数据迁移时，没有正确指定fromuser、touser，导致数据没有正确导入\n&amp;emsp;&amp;emsp;09.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n### 5.4 数据迁移的准备工作\n&gt;&amp;emsp;&amp;emsp;01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用exp/imp迁移数据。\n&amp;emsp;&amp;emsp;02.检查目标库上表结构和源结构是否一致，如果不一致，先修复结构，保证一致。\n&amp;emsp;&amp;emsp;03.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。如果表大小超出文件大小，exp导出时加上这两个参数：filesize=小于文件限制的数值m,file=exp01.dmp,exp02.dmp,…多个dmp文件\n&amp;emsp;&amp;emsp;04.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\ntables=(tab1,tab2,tab3,..)\n&amp;emsp;&amp;emsp;05.根据不同的需要要书写query子句时，这个参数跟direct=y冲突\n### 5.5 数据迁移的执行过程\n&gt;01.如果目标表是已存在数据，跟应用确认后，可以先进行导出备份，以防后面需要回退。\n先根据需求编辑exp、imp的参数文件：’-‘后面是参数说明，实际使用时去掉cat exp_itpux.par\nuserid=itpux/itpux@db01\ndirect=y –直接路径导出，加快导出速度\ncompress=n –避免数据全部压缩在一个数据块上\nfile=exp_itpux01.dmp\nlog=exp_itpux01.log\nrecordlength=65535 –写dmp文件时一次IO的大小，上限是65535，可以加快导出速度\nbuffer=4096000 -数据缓冲区大小\ntables=itpux01\n\nexp parfile=exp_itpux.par –进行数据导出\n```shell\ncat imp_itpux.par\nuserid=itpux/itpux\ncommit=y –开启批量提交，避免长事务\nignore=y –如果目标表已经存在，只导入数据\nfromuser=itpux\ntouser=itpux\ntables=itpux01\nfile=imp_itpux01.dmp\nlog=imp_itpux01.log\nbuffer=100000 –大小控制导入速度的，设置过大会导致日志产生很快\nimp parfile=imp_itpux.par –进行数据导入\n</code></pre><blockquote>\n<p>注意上面的fromuser和touser。如果将表导入到两个schema:itpux01,itpux02<br>需要按照这种格式配置参数：<br>fromuser和touser一一对应，即使导出时只有一个schema.<br>fromuser=itpux01,itpux01<br>touser=itpux02,itpux02</p>\n</blockquote>\n<ul>\n<li>02 exp导出数据时，检查exp的日志，如果报错，一般是参数配置错误，参考官方文档调整参数。</li>\n<li>03 imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报错：<pre class=\" language-sql\"><code class=\"language-sql\">spool itpux_object_create_scripts<span class=\"token punctuation\">.</span>sql\n<span class=\"token keyword\">SET</span> LONG <span class=\"token number\">2000000</span> PAGESIZE <span class=\"token number\">0</span> head <span class=\"token keyword\">off</span> verify <span class=\"token keyword\">off</span> feedback <span class=\"token keyword\">off</span> linesize <span class=\"token number\">180</span>\n<span class=\"token keyword\">select</span> dbms_metadata<span class=\"token punctuation\">.</span>get_ddl<span class=\"token punctuation\">(</span><span class=\"token string\">'USER'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> dbms_metadata<span class=\"token punctuation\">.</span>get_granted_ddl<span class=\"token punctuation\">(</span><span class=\"token string\">'OBJECT_GRANT'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> dbms_metadata<span class=\"token punctuation\">.</span>get_granted_ddl<span class=\"token punctuation\">(</span><span class=\"token string\">'ROLE_GRANT'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> dbms_metadata<span class=\"token punctuation\">.</span>get_granted_ddl<span class=\"token punctuation\">(</span><span class=\"token string\">'SYSTEM_GRANT'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> dbms_metadata<span class=\"token punctuation\">.</span>get_ddl<span class=\"token punctuation\">(</span><span class=\"token string\">'TABLESPACE'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dual<span class=\"token punctuation\">;</span>\nspool <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li>04 imp导入数据过程，需要监控下数据库事务和日志产生速度。</li>\n<li>05 对导入的表收集统计信息。</li>\n</ul>\n<h3 id=\"5-6-数据迁移后的验证方案\"><a href=\"#5-6-数据迁移后的验证方案\" class=\"headerlink\" title=\"5.6 数据迁移后的验证方案\"></a>5.6 数据迁移后的验证方案</h3><blockquote>\n<p>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。<br>比如上面的数据迁移，检查数据量跟日志显示是否一致。<br>select count(*) from itpux.itpux01;<br>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> object_type s_object_type<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dba_objects <span class=\"token keyword\">where</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX01'</span> <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> object_type <span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> object_type t_object_type<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> dba_objects <span class=\"token keyword\">where</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX01'</span> <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> object_type <span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dba_objects <span class=\"token keyword\">where</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'VALID'</span> <span class=\"token operator\">and</span> owner<span class=\"token operator\">=</span><span class=\"token string\">'ITPUX01'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>dblink两个库一起查询;<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> s<span class=\"token punctuation\">.</span>s_object_type<span class=\"token punctuation\">,</span>\n     s<span class=\"token punctuation\">.</span>s_count<span class=\"token punctuation\">,</span>\n     t<span class=\"token punctuation\">.</span>t_object_type<span class=\"token punctuation\">,</span>\n     t<span class=\"token punctuation\">.</span>t_count\n<span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span>  <span class=\"token keyword\">SELECT</span> object_type s_object_type<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> s_count\n          <span class=\"token keyword\">FROM</span> dba_objects<span class=\"token variable\">@db01</span>\n         <span class=\"token keyword\">WHERE</span> owner <span class=\"token operator\">=</span> <span class=\"token string\">'ITPUX01'</span>\n      <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> object_type<span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">,</span>\n     <span class=\"token punctuation\">(</span>  <span class=\"token keyword\">SELECT</span> object_type t_object_type<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> t_count\n          <span class=\"token keyword\">FROM</span> dba_objects\n         <span class=\"token keyword\">WHERE</span> owner <span class=\"token operator\">=</span> <span class=\"token string\">'ITPUX01'</span>\n      <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> object_type<span class=\"token punctuation\">)</span> t<span class=\"token punctuation\">;</span>\n</code></pre>\n自动生成编译无效对象SQL及编译过程</li>\n</ul>\n</blockquote>\n<ul>\n<li>统计当前用户无效对象数量:<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> owner<span class=\"token punctuation\">,</span>\n       object_type<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">status</span><span class=\"token punctuation\">,</span>\n       <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> dba_objects\n <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'VALID'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> owner<span class=\"token punctuation\">,</span> object_type<span class=\"token punctuation\">,</span> <span class=\"token keyword\">status</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> owner<span class=\"token punctuation\">,</span> object_type<span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li><p>生成编译无效对象SQL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token string\">'ALTER '</span>\n     <span class=\"token operator\">||</span> OBJECT_TYPE\n     <span class=\"token operator\">||</span> <span class=\"token string\">' '</span>\n     <span class=\"token operator\">||</span> OWNER\n     <span class=\"token operator\">||</span> <span class=\"token string\">'.'</span>\n     <span class=\"token operator\">||</span> OBJECT_NAME\n     <span class=\"token operator\">||</span> <span class=\"token string\">' COMPILE;'</span>\n<span class=\"token keyword\">FROM</span> dba_objects\n<span class=\"token keyword\">WHERE</span>     <span class=\"token keyword\">status</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'VALID'</span>\n     <span class=\"token operator\">AND</span> object_type <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'PACKAGE'</span><span class=\"token punctuation\">,</span>\n                         <span class=\"token string\">'PACKAGE BODY'</span><span class=\"token punctuation\">,</span>\n                         <span class=\"token string\">'FUNCTION'</span><span class=\"token punctuation\">,</span>\n                         <span class=\"token string\">'PROCEDURE'</span><span class=\"token punctuation\">,</span>\n                         <span class=\"token string\">'TRIGGER'</span><span class=\"token punctuation\">,</span>\n                         <span class=\"token string\">'VIEW'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<blockquote>\n<p>通过复制以上SQL语句,直接手动执行编译执行,也可以采用如下方式在oracle用户下进行手工编译<br><code>`</code>sql</p>\n</blockquote>\n<h1 id=\"su-oracle\"><a href=\"#su-oracle\" class=\"headerlink\" title=\"su - oracle\"></a>su - oracle</h1><p>$ sqlplus / as sysdba<br>SQL&gt; @$ORACLE_HOME/rdbms/admin/utlrp.sql<br><code>`</code></p>\n</li>\n<li><p>如果有序列要处理</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">exclude<span class=\"token operator\">=</span>SEQUENCE\n</code></pre>\n<blockquote>\n<p>目标库<br>方法1:<br>1.源库： 查出sequence的最大值<br>2.目标库： DROP SEQUENCE …. 再 CREATE SEQUENCE START最大值 其他不变<br>方法2：<br>目标库： DROP SEQUENCE …. 再 CREATE SEQUENCE START 超大值 （保证比之前的都大，不会发生冲突的 ）</p>\n</blockquote>\n</li>\n<li><p>可以用以下脚本来实现 ：<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 19:49:33 (QP5 v5.313) </em>/<br>script FROM THE SOURCE database. USE this script TO RESET THE proper starting VALUE FOR sequences ON THE TARGET database.<br>cr_tts_create_seq.SQL<br>SET HEADING OFF FEEDBACK OFF TRIMSPOOL ON ESCAPE OFF<br>SET LONG 1000 LINESIZE 1000 PAGESIZE 0<br>COL SEQDDL FORMAT A300<br>SPOOL tts_create_seq.sql<br>PROMPT /<em> ========================= </em>/<br>PROMPT /<em> Drop and create sequences </em>/<br>PROMPT /<em> ========================= </em>/</p>\n</li>\n</ul>\n<p>SELECT REGEXP_REPLACE (<br>           DBMS_METADATA.get_ddl (‘SEQUENCE’, sequence_name, sequence_owner),<br>           ‘^.<em>(CREATE SEQUENCE.</em>CYCLE).*$’,<br>              ‘DROP SEQUENCE “‘<br>           || sequence_owner<br>           || ‘“.”‘<br>           || sequence_name<br>           || ‘“;’<br>           || CHR (10)<br>           || ‘\\1;’)<br>           SEQDDL<br>  FROM dba_sequences<br> WHERE sequence_owner NOT IN (SELECT name<br>                                FROM SYSTEM.logstdby$skip_support<br>                               WHERE action = 0);</p>\n<p>SPOOL OFF</p>\n<pre><code>\n### 5.7 数据迁移核心对象风险\n&gt;由于核心表访问、变更频繁，不宜直接使用imp对核心表大量导入数据。\n\n### 5.8 数据迁移回退方案\n&gt;exp对应用无影响，不需要回退。\nimp后可能数据有误，需要进行回退操作。\n如果目标表本来就是空表，跟应用确认后，直接清空即可。\n如果目标表原有数据，跟应用确认是否使用原有备份数据进行恢复。若需要，先exp备份当前数据，然后清空再导入前面的备份数据。\n\n## 6.exp / imp数据迁移案例\n### 6.1 迁移目的\n&gt;&amp;emsp;&amp;emsp;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过Exp迁移到另一台oracle服务器，并能正常查询到相关数据。\n### 6.2 迁移流程\n```sql\n1.准备数据：linux系统oracle服务器上创建用户,表空间.并创建相关表.数据等。\n2.linux本地用Exp做导出;\n3.再到远程主机创建相关对象；\n4.远程主机用imp做导入(导入);\n5.验证远程本地数据合法性;\n</code></pre><h3 id=\"6-3-迁移过程\"><a href=\"#6-3-迁移过程\" class=\"headerlink\" title=\"6.3 迁移过程\"></a>6.3 迁移过程</h3><ul>\n<li>创建表空间<br><code>`</code>sql<br>CREATE TABLESPACE itpux11<br>  DATAFILE ‘/oracle/oradata/db01/itpux01.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;</li>\n</ul>\n<p>CREATE TABLESPACE itpux12<br>    DATAFILE ‘/oracle/oradata/db01/itpux02.dbf’<br>                 SIZE 100 M<br>                 AUTOEXTEND OFF<br>    EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>    SEGMENT SPACE MANAGEMENT AUTO;</p>\n<pre><code>\n* 创建用户并授权\n```sql\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n</code></pre><ul>\n<li>moon用户登录并创建测试表<br><code>`</code>sql<br>CONN itpux01 / itpux01<br>CREATE TABLE itpux01<br>(<br>  id    NUMBER (30) PRIMARY KEY NOT NULL,<br>  name DATE<br>);</li>\n</ul>\n<p>CONN itpux02 / itpux02<br>CREATE TABLE itpux02<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<pre><code>\n* 创建2个存储过程并执行\n```sql\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\nEND p_itpux01;\n/\n\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id &gt; 990;\n\nCONN itpux02 / itpux02\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n</code></pre><ul>\n<li>查询验证数据<br><code>`</code>sql<br>CONN itpux01 / itpux01</li>\n</ul>\n<p>SELECT COUNT (*) FROM itpux01;</p>\n<p>SELECT *<br>  FROM itpux01<br> WHERE id &gt; 990;</p>\n<p>CONN itpux02 / itpux02</p>\n<p>SELECT COUNT (*) FROM itpux02;</p>\n<p>SELECT *<br>  FROM itpux02<br> WHERE id &gt; 1990;</p>\n<pre><code>\n* 本地用Exp做导出\n```sql\nEXP SYSTEM/oracle OWNER=itpux01,itpux02 COMPRESS=n FILE=exp_2table.dmp LOG=exp_2table.LOG direct=y recordlength=65535 buffer=4096000\n</code></pre><ul>\n<li>imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 20:03:14 (QP5 v5.313) </em>/<br>SPOOL itpux_object_create_scripts.sql<br>SET LONG 2000000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 180</li>\n</ul>\n<p>SELECT DBMS_METADATA.get_ddl (‘USER’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘OBJECT_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘ROLE_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘SYSTEM_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘TABLESPACE’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘USER’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘OBJECT_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘ROLE_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘SYSTEM_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘TABLESPACE’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SPOOL OFF;</p>\n<pre><code>\n* 异机用imp做导入\n```sql\nimp SYSTEM/oracle fromuser=itpux01,itpux02 touser=itpux01,itpux02 FILE=exp_2table.dmp LOG=exp_2table.LOG COMMIT=y IGNORE=y buffer=4096000\n</code></pre><ul>\n<li>验证导入后的数据合法性<br><code>`</code>sql</li>\n</ul>\n<pre><code>\n### 6.4 数据迁移后的验证方案\n&gt;对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n```sql\nSELECT COUNT (*) FROM itpux.itpux01;\n</code></pre><blockquote>\n<p>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。<br><code>`</code>sql<br>  SELECT object_type s_object_type, COUNT (*)<br>    FROM dba_objects<br>   WHERE owner = ‘ITPUX01’<br>GROUP BY object_type;</p>\n</blockquote>\n<p>  SELECT object_type t_object_type, COUNT (*)<br>    FROM dba_objects<br>   WHERE owner = ‘ITPUX01’<br>GROUP BY object_type;</p>\n<p>SELECT *<br>  FROM dba_objects<br> WHERE status &lt;&gt; ‘VALID’ AND owner = ‘ITPUX01’;</p>\n<pre><code>* dblink两个库一起查\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = &#39;ITPUX01&#39;\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = &#39;ITPUX01&#39;\n        GROUP BY object_type) t;\n</code></pre><ul>\n<li>自动生成编译无效对象SQL及编译过程<blockquote>\n<p>统计当前用户无效对象数量</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> owner<span class=\"token punctuation\">,</span>\n       object_type<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">status</span><span class=\"token punctuation\">,</span>\n       <span class=\"token function\">COUNT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">FROM</span> dba_objects\n <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'VALID'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> owner<span class=\"token punctuation\">,</span> object_type<span class=\"token punctuation\">,</span> <span class=\"token keyword\">status</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> owner<span class=\"token punctuation\">,</span> object_type<span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>生成编译无效对象SQL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token string\">'ALTER '</span>\n       <span class=\"token operator\">||</span> OBJECT_TYPE\n       <span class=\"token operator\">||</span> <span class=\"token string\">' '</span>\n       <span class=\"token operator\">||</span> OWNER\n       <span class=\"token operator\">||</span> <span class=\"token string\">'.'</span>\n       <span class=\"token operator\">||</span> OBJECT_NAME\n       <span class=\"token operator\">||</span> <span class=\"token string\">' COMPILE;'</span>\n  <span class=\"token keyword\">FROM</span> dba_objects\n <span class=\"token keyword\">WHERE</span>     <span class=\"token keyword\">status</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'VALID'</span>\n       <span class=\"token operator\">AND</span> object_type <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'PACKAGE'</span><span class=\"token punctuation\">,</span>\n                           <span class=\"token string\">'PACKAGE BODY'</span><span class=\"token punctuation\">,</span>\n                           <span class=\"token string\">'FUNCTION'</span><span class=\"token punctuation\">,</span>\n                           <span class=\"token string\">'PROCEDURE'</span><span class=\"token punctuation\">,</span>\n                           <span class=\"token string\">'TRIGGER'</span><span class=\"token punctuation\">,</span>\n                           <span class=\"token string\">'VIEW'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>通过复制以上SQL语句,直接手动执行编译执行.<br>也可以采用如下方式在oracle用户下进行手工编译</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">su <span class=\"token operator\">-</span> oracle\n$ sqlplus <span class=\"token operator\">/</span> <span class=\"token keyword\">as</span> sysdba\nSQL<span class=\"token operator\">></span> <span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>utlrp<span class=\"token punctuation\">.</span>sql\n</code></pre>\n</blockquote>\n<h2 id=\"7-exp-imp迁移过程字符集的处理\"><a href=\"#7-exp-imp迁移过程字符集的处理\" class=\"headerlink\" title=\"7.exp / imp迁移过程字符集的处理\"></a>7.exp / imp迁移过程字符集的处理</h2><blockquote>\n<p>进行数据的导入导出时，我们要注意关于字符集的问题。在EXP/IMP过程中我们需要注意四个字符集的参数：</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n04.导入端数据库字符集。\n</code></pre>\n<p>我们首先需要查看这四个字符集参数。<br>查看数据库的字符集的信息：<br><code>`</code>sql<br>SQL&gt; select <em> from nls_database_parameters;<br>//SQL&gt; select </em> from props$;<br>SQL&gt; SET PAGESIZE 30<br>SQL&gt; select * from nls_database_parameters;</p>\n</blockquote>\n<p>PARAMETER                      VALUE</p>\n<hr>\n<p>NLS_LANGUAGE                   AMERICAN<br>NLS_TERRITORY                  AMERICA<br>NLS_CURRENCY                   $<br>NLS_ISO_CURRENCY               AMERICA<br>NLS_NUMERIC_CHARACTERS         .,<br>NLS_CHARACTERSET               ZHS16GBK<br>NLS_CALENDAR                   GREGORIAN<br>NLS_DATE_FORMAT                DD-MON-RR<br>NLS_DATE_LANGUAGE              AMERICAN<br>NLS_SORT                       BINARY<br>NLS_TIME_FORMAT                HH.MI.SSXFF AM<br>NLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM<br>NLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR<br>NLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR<br>NLS_DUAL_CURRENCY              $<br>NLS_COMP                       BINARY<br>NLS_LENGTH_SEMANTICS           BYTE<br>NLS_NCHAR_CONV_EXCP            FALSE<br>NLS_NCHAR_CHARACTERSET         UTF8<br>NLS_RDBMS_VERSION              11.2.0.4.0</p>\n<p>20 rows selected.</p>\n<pre><code>&gt;我们再来查看客户端的字符集信息：\n客户端字符集的参数NLS_LANG=_&lt; territory &gt;.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n\n* 如数据库语言环境\n&gt;os是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;os是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n\\\n\n&gt;$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;永久修改可用：\nvi bash_profile\n\n* 通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n&gt;&amp;emsp;&amp;emsp;(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n&amp;emsp;&amp;emsp;(2) 源数据库和目标数据库字符集不同。\n&amp;emsp;&amp;emsp;先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n&amp;emsp;&amp;emsp;这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n## 8.exp / imp优化的方法\n&gt;当需要exp/imp的数据量比较大时，这个过程需要的时间是比较长的，我们可以用一些方法来优化exp/imp的操作。\n\n* 01.exp:使用直接路径 direct=y\n&gt;&amp;emsp;&amp;emsp;oracle会避开sql语句处理引擎,直接从数据库文件中读取数据,然后写入导出文件.\n&amp;emsp;&amp;emsp;可以在导出日志中观察到: exp-00067: table xxx will be exported in conventional path\n&amp;emsp;&amp;emsp;如果没有使用直接路径,必须保证buffer参数的值足够大.\n&amp;emsp;&amp;emsp;有一些参数于direct=y不兼容,无法用直接路径导出可移动的tablespace,或者用query参数导出数据库子集.\n&amp;emsp;&amp;emsp;当导入导出的数据库运行在不同的os下时,必须保证recordlength参数的值一致.\n\n* 02.exp: 清空回收站\n```sql\nSQL&gt; select count(*) from dba_recyclebin;\nSQL&gt; purge dba_recyclebin;\n</code></pre><ul>\n<li><p>03.imp:避免磁盘排序</p>\n<blockquote>\n<p>涉及到sort_area_size参数,也就是我们的PGA要够大。</p>\n</blockquote>\n</li>\n<li><p>05.imp:优化日志缓冲区</p>\n<blockquote>\n<p>比如将log_buffer容量扩大10倍(最大不要超过5M),也就是我们的SGA要够大。</p>\n</blockquote>\n</li>\n<li><p>05.imp:避免日志切换等待</p>\n<blockquote>\n<p>增加重做日志组的数量,增大日志文件大小.</p>\n</blockquote>\n</li>\n<li><p>06.imp:使用commit</p>\n<blockquote>\n<p>commit = y<br>注意:这个方式不能处理包含LOB和LONG类型的表,对于这样的table,如果使用commit = y,每插入一行,就会执行一次提交.</p>\n</blockquote>\n</li>\n<li><p>07.imp:使用NOLOGGING方式减小重做日志大小</p>\n<blockquote>\n<p>在导入时指定参数indexes=n,只导入数据而忽略index,在导完数据后在通过脚本创建index,指定NOLOGGING选项</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"9-exp-imp-常见问题及解决方法\"><a href=\"#9-exp-imp-常见问题及解决方法\" class=\"headerlink\" title=\"9.exp / imp 常见问题及解决方法\"></a>9.exp / imp 常见问题及解决方法</h2><h3 id=\"9-1-关于imp-exp版本的问题\"><a href=\"#9-1-关于imp-exp版本的问题\" class=\"headerlink\" title=\"9.1 关于imp/exp版本的问题\"></a>9.1 关于imp/exp版本的问题</h3><blockquote>\n<p>一般来说，从低版本导入到高版本问题不大，麻烦的是将高版本的数据导入到低版本中。</p>\n<ul>\n<li>可以跨版本的使用EXP/IMP，但必须正确地使用EXP和IMP的版本（官方可查）：<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span>、使用IMP的版本匹配数据库的版本，如：要导入到<span class=\"token number\">11.2</span>中，使用<span class=\"token number\">11.2</span>的IMP工具。\n<span class=\"token number\">2</span>、使用EXP的版本匹配两个数据库中最低的版本，如：从<span class=\"token number\">11.2</span>往<span class=\"token number\">10.2</span>中导入，则使用<span class=\"token number\">10.2</span>版本的EXP工具。\n<span class=\"token number\">3</span>、高版本的Export导出来的转储文件，低版本的<span class=\"token keyword\">Import</span>读不了；低版本的Export导出来的转储文件，高版本的<span class=\"token keyword\">Import</span>可以进行读取。\n<span class=\"token number\">4</span>、从Oracle低版本的Export数据可以<span class=\"token keyword\">Import</span>到Oracle高版本中，但限于Oracle的相邻版本，两个不相邻版本间进行转换应借助中间版本。\n<span class=\"token number\">5</span>、exp<span class=\"token operator\">/</span>imp可以做到在不同版本Oracle、不同数据库上的迁移。\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"9-2-数据库对象已经存在\"><a href=\"#9-2-数据库对象已经存在\" class=\"headerlink\" title=\"9.2 数据库对象已经存在\"></a>9.2 数据库对象已经存在</h3><blockquote>\n<p>&emsp;&emsp;一般情况, 导入数据前应该彻底删除目标数据下的表, 序列, 函数/过程,触发器等; 数据库对象已经存在, 按缺省的imp参数, 则会导入失败如果用了参数ignore=y, 会把exp文件内的数据内容导入如果表有唯一关键字的约束条件, 不合条件将不被导入如果表没有唯一关键字的约束条件, 将引起记录重复</p>\n</blockquote>\n<h3 id=\"9-3-数据库对象有主外键约束\"><a href=\"#9-3-数据库对象有主外键约束\" class=\"headerlink\" title=\"9.3 数据库对象有主外键约束\"></a>9.3 数据库对象有主外键约束</h3><blockquote>\n<p>不符合主外键约束时, 数据会导入失败,<br>解决办法:<br>先导入主表, 再导入依存表<br>disable目标导入对象的主外键约束, 导入数据后, 再enable它们</p>\n</blockquote>\n<h3 id=\"9-4-权限不够\"><a href=\"#9-4-权限不够\" class=\"headerlink\" title=\"9.4 权限不够\"></a>9.4 权限不够</h3><blockquote>\n<p>如果要把A用户的数据导入B用户下, A用户需要有imp_full_database权限</p>\n</blockquote>\n<h3 id=\"9-5-导入大表存储分配失败\"><a href=\"#9-5-导入大表存储分配失败\" class=\"headerlink\" title=\"9.5 导入大表存储分配失败\"></a>9.5 导入大表存储分配失败</h3><blockquote>\n<p>&emsp;&emsp;默认的EXP时, compress = y, 也就是把所有的数据压缩在一个数据块上.<br>导入时, 如果不存在连续一个大数据块, 则会导入失败. 导出大表时, 记得compress= n, 则不会引起这种错误.</p>\n</blockquote>\n<h3 id=\"9-6-imp和exp使用的字符集不同\"><a href=\"#9-6-imp和exp使用的字符集不同\" class=\"headerlink\" title=\"9.6 imp和exp使用的字符集不同\"></a>9.6 imp和exp使用的字符集不同</h3><blockquote>\n<p>&emsp;&emsp;如果字符集不同, 导入会失败, 可以改变unix环境变量或者NT注册表里NLS_LANG相关信息. 导入完成后再改回来.</p>\n</blockquote>\n<h3 id=\"9-7-imp和exp版本不能往上兼容\"><a href=\"#9-7-imp和exp版本不能往上兼容\" class=\"headerlink\" title=\"9.7 imp和exp版本不能往上兼容\"></a>9.7 imp和exp版本不能往上兼容</h3><blockquote>\n<p>可以从低版本导入高版本，但不能从高版本导入到低版本。<br>如果遇到迁移因版本不同的问题，可以用低版本的export 导出，到导入到低版本。</p>\n</blockquote>\n<h3 id=\"9-8-导出统计信息的问题。\"><a href=\"#9-8-导出统计信息的问题。\" class=\"headerlink\" title=\"9.8 导出统计信息的问题。\"></a>9.8 导出统计信息的问题。</h3><blockquote>\n<p>&emsp;&emsp;如果导出统计信息,在只导出部分数据,或不导出数据时,导出统计信息会报错.另如果未导出统计信息,但导入时,需导入统计信息<br>,那此时,导入后,统计信息会被锁住,而无法更新统计信息.<br>&emsp;&emsp;此时,我们可使用包dbms_stats.unlock_schema_stats来解锁.最好的办法是,在exp,imp时,加入参数statistics=none,不exp,imp统计信息,在导入完成后,在重新收集统计信息.</p>\n</blockquote>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">BEGIN</span>\n    DBMS_STATS<span class=\"token punctuation\">.</span>gather_database_stats<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n\n<span class=\"token keyword\">BEGIN</span>\n    DBMS_STATS<span class=\"token punctuation\">.</span>gather_schema_stats <span class=\"token punctuation\">(</span><span class=\"token string\">'ITPUX02'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span>\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle数据库逻辑备份恢复迁移之exp与imp\"><a href=\"#Oracle数据库逻辑备份恢复迁移之exp与imp\" class=\"headerlink\" title=\"Oracle数据库逻辑备份恢复迁移之exp与imp\"></a>Oracle数据库逻辑备份恢复迁移之exp与imp</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-export与import逻辑备份恢复概述\"><a href=\"#1-export与import逻辑备份恢复概述\" class=\"headerlink\" title=\"1.export与import逻辑备份恢复概述\"></a>1.export与import逻辑备份恢复概述</h2><h3 id=\"1-1-备份概述\"><a href=\"#1-1-备份概述\" class=\"headerlink\" title=\"1.1 备份概述\"></a>1.1 备份概述</h3><ul>\n<li>备份可分为两类，物理备份和逻辑备份<blockquote>\n<p>&emsp;&emsp;物理备份：该方法实现数据库的完整恢复，但需要极大的外部存储设备，例如磁带库，具体包括冷备份和热备份。冷备份和热备份(热备份要求数据库运行在归档模式下)都是物理备份，它涉及到组成数据库的文件，但不考虑逻辑内容。<br>&emsp;&emsp;逻辑备份： 使用软件技术从数据库中导出数据并写入一个输出文件，该文件的格式一般与原数据库的文件格式不同，只是 原数据库中数据内容的一个映像。因此，逻辑备份文件只能用来对数据库进行逻辑恢复，即数据导入，而不能按数据库原来的存储特征进行物理恢复。逻辑备份一般 用于增量备份，即备份那些在上次备份以后改变的数据。<br>&emsp;&emsp;Oracle 的导出导入是一个很常用的迁移工具。 在Oracle 10g以后，Oracle 推出了数据泵(expdp/impdp).它可以通过使用并行，从而在效率上要比exp/imp 要高。但是这个exp/imp很多时候还需要使用。<br>&emsp;&emsp;导入/导出是ORACLE幸存的最古老的两个命令行工具，其实我从来不认为Exp/Imp是一种好的备份方式，正确的说法是Exp/Imp只能是一个好的转储工具，特别是在小型数据库的转储，表空间的迁移，表的抽取，检测逻辑和物理冲突等中有不小的功劳。当然，我们也可以把它作为小型数据库的物理备份后的一个逻辑辅助备份，也是不错的建议。对于越来越大的数据库，特别是TB级数据库和越来越多数据仓库的出现，EXP/IMP越来越力不从心了，这个时候，数据库的备份都转向了RMAN和第三方工具。下面说明一下EXP/IMP的使用。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"2-export与import参数详解\"><a href=\"#2-export与import参数详解\" class=\"headerlink\" title=\"2.export与import参数详解\"></a>2.export与import参数详解</h2><h3 id=\"2-1-export参数详解\"><a href=\"#2-1-export参数详解\" class=\"headerlink\" title=\"2.1 export参数详解\"></a>2.1 export参数详解</h3><pre><code class=\"shell\">[oracle@orcl:/]$exp -help\n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 18:30:39 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Export prompt you for parameters by entering the EXP\ncommand followed by your username/password:\n\n     Example: EXP SCOTT/TIGER\n\nOr, you can control how Export runs by entering the EXP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  EXP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: EXP SCOTT/TIGER GRANTS=Y TABLES=(EMP,DEPT,MGR)\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword    Description (Default)      Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID     username/password          FULL         export entire file (N)\nBUFFER     size of data buffer        OWNER        list of owner usernames\nFILE       output files (EXPDAT.DMP)  TABLES       list of table names\nCOMPRESS   import into one extent (Y) RECORDLENGTH length of IO record\nGRANTS     export grants (Y)          INCTYPE      incremental export type\nINDEXES    export indexes (Y)         RECORD       track incr. export (Y)\nDIRECT     direct path (N)            TRIGGERS     export triggers (Y)\nLOG        log file of screen output  STATISTICS   analyze objects (ESTIMATE)\nROWS       export data rows (Y)       PARFILE      parameter filename\nCONSISTENT cross-table consistency(N) CONSTRAINTS  export constraints (Y)\n\nOBJECT_CONSISTENT    transaction set to read only during object export (N)\nFEEDBACK             display progress every x rows (0)\nFILESIZE             maximum size of each dump file\nFLASHBACK_SCN        SCN used to set session snapshot back to\nFLASHBACK_TIME       time used to get the SCN closest to the specified time\nQUERY                select clause used to export a subset of a table\nRESUMABLE            suspend when a space related error is encountered(N)\nRESUMABLE_NAME       text string used to identify resumable statement\nRESUMABLE_TIMEOUT    wait time for RESUMABLE \nTTS_FULL_CHECK       perform full or partial dependency check for TTS\nVOLSIZE              number of bytes to write to each tape volume\nTABLESPACES          list of tablespaces to export\nTRANSPORT_TABLESPACE export transportable tablespace metadata (N)\nTEMPLATE             template name which invokes iAS mode export\n\nExport terminated successfully without warnings.\n</code></pre>\n<ul>\n<li>EXP的所有参数（括号中为参数的默认值）：<blockquote>\n<p>可以通过exp help=y或者imp help=y查看exp或imp的详细参数，下面以exp为例解释参数意义<br>USERID：用户名/口令</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>FULL：导出整个数据库，只有拥有exp_full_database角色的用户或者特权用户如sys，system等才能进行全库导出。 示例如下<br>exp “‘/ as sysdba’” full=y</p>\n</blockquote>\n<blockquote>\n<p>BUFFER：制定数据缓冲区大小，主要用于提高exp/imp速度，该单位为字节，不能写成buffer=1m的形式，应写成字节为单位的参数，如buffer=1048576<br>exp hr/hr file=t_b.dmp buffer= 1048576 tables=T</p>\n</blockquote>\n<blockquote>\n<p>OWNER：需要导出的用户，示例如下<br>exp “‘/ as sysdba’” owner=(hr,ITPUX02) file=hr_ITPUX02.dmp<br>上例中由于是在linux平台进行测试的，需要对 owner=(hr,ITPUX02)使用\\进行转义</p>\n</blockquote>\n<blockquote>\n<p>FILE：输出文件</p>\n</blockquote>\n<blockquote>\n<p>TABLES：需要导出的表</p>\n</blockquote>\n<blockquote>\n<p>COMPRESS：导入到一个区 (Y) 。主要目的是为了消除存储碎片，以保证某张表的所有记录都存储在连续的空间里。 但是负面效应很明显， 如果该参数值为y，则会将高水位线以下的所有extent导入到一个区中， 因此在导入时很有可能出现，明明表中数据很少，但是却花了很多时间在建立的extent上。 且自oracle9i开始，使用了本地管理的表空间，存储碎片的问题应该比低版本好多了，个人建议将compress设为n。</p>\n</blockquote>\n<ul>\n<li><p>DIRECT：直接路径 (N)。</p>\n<blockquote>\n<p>传统模式导出和直接路径导出的原理<br>传 统模式导出相当于使用select语句从表中取出数据，数据从磁盘上先读到buffer cache中，记录被转移到一个评估检测的缓冲区中，数据经过语法检测后没有问题，将数据传给PGA，最后写入导出的文件中。如果使用Direct Path模式导出，数据直接从磁盘上读取到导出的PGA中：记录直接被转换导出会话的私有buffer中。这也就是意味着SQL语句处理层被忽略掉了，因 为数据已经是符合导出的格式了，不需要其他的转换处理了。数据直接被传送给导出的客户端，最后写入导出文件。过程可概况如下</p>\n<pre><code class=\"shell\">direct=n datafile----&gt;sga-----&gt;pga-----&gt;dump\ndirect=y datafile----&gt;pga-----&gt;dump\n</code></pre>\n<p>传统路径导出VS直接路径导出(oracle exp direct=y)两者的差异<br>a、 Conventional path Export<br>&emsp;&emsp; 传统路径模式使用SQL SELECT语句抽取表数据。数据从磁盘读入到buffer cache缓冲区中，行被转移到评估缓冲区。在此之后根据SQL表达式，将记录返回给导出客户端，然后写入到dump文件。<br>b、Direct path Export<br>&emsp;&emsp; 直接导出模式，数据直接从磁盘中读取到导出session的PGA中，行被直接转移到导出session的私有缓冲区，从而跳过SQL命令处理层。<br>避免了不必要的数据转换。最后记录返回给导出客户端，写到dump文件。</p>\n</blockquote>\n</li>\n<li><p>传统路径导出VS直接路径导出(oracle exp direct=y)性能问题</p>\n<blockquote>\n<p>&emsp;&emsp; a、直接路径导出方式比传统路径方式具有更优的性能，速度更快，因为绕过了SQL命令处理部分。<br>&emsp;&emsp; b、直接路径导出方式支持RECORDLENGTH参数(最大为64k)，该参数值通常建议设置为系统I/O或者DB_BLOCK_SIZE的整数倍<br>&emsp;&emsp; c、影响直接路径导出的具体因素(DB_BLOCK_SIZE，列的类型，I/O性能，即数据文件所在的磁盘驱动器是否单独于dump文件所在的磁盘驱动器)<br>&emsp;&emsp; d、无论是直接路径导出还是传统路径导出产生的dump，在使用imp方式导入时，会耗用相同的时间.</p>\n</blockquote>\n</li>\n<li><p>传统路径导出VS直接路径导出(oracle exp direct=y)直接路径导出的限制</p>\n<blockquote>\n<p>a、直接路径导出不支持交互模式<br>b、不支持表空间传输模式(即transport_tablespaces=y不被支持)，支持的是full,owner,tables导出方式<br>c、不支持query查询方式，如exp scott/tiger tables=emp query=\\”where job=\\’salesman\\’ \\” 不被支持<br>d、直接路径导出使用recordlength设置一次可以导出数据的量，取代传统路径使用buffer的设置<br>e、直接路径导出要求nls_lang环境参数等于数据库字符集，负责收到exp-41警告及exp-0终止错误</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>GRANTS：导出权限 (Y)<br>INCTYPE：增量导出类型，已废除<br>INDEXES：导出索引 (Y)<br>RECORD：跟踪增量导出 (Y) ，已废除<br>TRIGGERS：导出触发器 (Y)<br>LOG：屏幕输出的日志文件</p>\n</blockquote>\n<blockquote>\n<p>STATISTICS：在导出文件中保留对象的统计信息，默认值ESTIMATE，还可以为compute或者none。如果导出时出现<br>EXP-00091: Exporting questionable statistics<br>可以考虑将 STATISTICS设置为NONE<br>ROWS：确定表中的数据行是否导出，默认为Y，导出</p>\n</blockquote>\n<blockquote>\n<p>QUERY：用于导出表的子集的select子句，示例如下<br>exp hr/hr file=emp_q.dmp tables=employees query=\\”where hire_date >to_date(\\’1999-01-01\\’\\,\\’yyyy-mm-dd\\’)\\”</p>\n</blockquote>\n<ul>\n<li>PARFILE：参数文件名，可以用如下方式导出<pre><code class=\"sql\">exp hr/hr parfile=parfile\n$ cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=(t,empl%s)\n</code></pre>\n</li>\n</ul>\n<blockquote>\n<p>使用parfile参数可以对频繁进行的导出操作进行反复调用，同时也可以避免不同操作系统之间需要对特定字符进行转义的烦恼，如下例</p>\n<pre><code class=\"sql\">exp hr/hr parfile=parfile\n$cat parfile\nfile=t_p.dmp\ncompress=y\nrows=y\ntables=employees\nstatistics=none\nquery=&quot;where hire_date&gt;to_date(&#39;1999-01-01&#39;,&#39;yyyy-mm-dd&#39;)&quot;\n</code></pre>\n<p>CONSISTENT：在导出时，将影响正在导出的表的事务设为只读，主要作用于嵌套表和分区表，默认为N。<br>CONSTRAINTS：导出的约束条件 (Y)<br>OBJECT_CONSISTENT:只在对象导出期间设置为只读的事务处理 (N)<br>FEEDBACK:每 x 行显示进度，默认为0<br>FILESIZE：每个导出文件的最大大小<br>FLASHBACK_SCN：用于将会话快照设置回以前状态的SCN<br>FLASHBACK_TIME：用于获取最接近指定时间的SCN的时间<br>RESUMABLE：遇到空间不足时的错误时挂起，默认为N，需与 RESUMABLE_NAME和 RESUMABLE_TIMEOUT一起使用<br>RESUMABLE_NAME：用于标示哪个会话需要使用 RESUMABLE选项，格式为 User USERNAME (USERID), Session SESSIONID, Instance INSTANCEID<br>RESUMABLE_TIMEOUT：RESUMABLE的等待时间，默认为7200s，如果在指定时间内未解决问题，则操作中断<br>TTS_FULL_CHECK：对TTS执行完整或部分相关性检查<br>TABLESPACES：要导出的表空间列表，示例如下<br>exp “‘/ as sysdba’” file=t_ts.dmp tablespaces=(users,example)<br>TRANSPORT_TABLESPACE 导出可传输的表空间元数据 (N)<br>直接备份到磁带上<br>exp icdmain/icd rows=y indexes=n compress=n buffer=65536 feedback=100000 file=/dev/rmt0 log=exp.log tables=(tab1,tab2,tab3)<br>注：在磁盘空间允许的情况下，应先备份到本地服务器，然后再拷贝到磁带。出于速度方面的考虑，尽量不要直接备份到磁带设备</p>\n</blockquote>\n<h3 id=\"2-2-import参数详解\"><a href=\"#2-2-import参数详解\" class=\"headerlink\" title=\"2.2 import参数详解\"></a>2.2 import参数详解</h3><pre><code class=\"sql\">[oracle@orcl:/]$imp -help\n\nImport: Release 11.2.0.4.0 - Production on Tue Jan 30 19:01:13 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nYou can let Import prompt you for parameters by entering the IMP\ncommand followed by your username/password:\n\n     Example: IMP SCOTT/TIGER\n\nOr, you can control how Import runs by entering the IMP command followed\nby various arguments. To specify parameters, you use keywords:\n\n     Format:  IMP KEYWORD=value or KEYWORD=(value1,value2,...,valueN)\n     Example: IMP SCOTT/TIGER IGNORE=Y TABLES=(EMP,DEPT) FULL=N\n               or TABLES=(T1:P1,T1:P2), if T1 is partitioned table\n\nUSERID must be the first parameter on the command line.\n\nKeyword  Description (Default)       Keyword      Description (Default)\n--------------------------------------------------------------------------\nUSERID   username/password           FULL         import entire file (N)\nBUFFER   size of data buffer         FROMUSER     list of owner usernames\nFILE     input files (EXPDAT.DMP)    TOUSER       list of usernames\nSHOW     just list file contents (N) TABLES       list of table names\nIGNORE   ignore create errors (N)    RECORDLENGTH length of IO record\nGRANTS   import grants (Y)           INCTYPE      incremental import type\nINDEXES  import indexes (Y)          COMMIT       commit array insert (N)\nROWS     import data rows (Y)        PARFILE      parameter filename\nLOG      log file of screen output   CONSTRAINTS  import constraints (Y)\nDESTROY                overwrite tablespace data file (N)\nINDEXFILE              write table/index info to specified file\nSKIP_UNUSABLE_INDEXES  skip maintenance of unusable indexes (N)\nFEEDBACK               display progress every x rows(0)\nTOID_NOVALIDATE        skip validation of specified type ids \nFILESIZE               maximum size of each dump file\nSTATISTICS             import precomputed statistics (always)\nRESUMABLE              suspend when a space related error is encountered(N)\nRESUMABLE_NAME         text string used to identify resumable statement\nRESUMABLE_TIMEOUT      wait time for RESUMABLE \nCOMPILE                compile procedures, packages, and functions (Y)\nSTREAMS_CONFIGURATION  import streams general metadata (Y)\nSTREAMS_INSTANTIATION  import streams instantiation metadata (N)\nDATA_ONLY              import only data (N)\nVOLSIZE                number of bytes in file on each volume of a file on tape\n\nThe following keywords only apply to transportable tablespaces\nTRANSPORT_TABLESPACE import transportable tablespace metadata (N)\nTABLESPACES tablespaces to be transported into database\nDATAFILES datafiles to be transported into database\nTTS_OWNERS users that own data in the transportable tablespace set\n\nImport terminated successfully without warnings.\n</code></pre>\n<ul>\n<li><p>IMP的所有参数（括号中为参数的默认值）：</p>\n<blockquote>\n<p>i&emsp;&emsp;mp的参数和exp的大致相同，下面是常用参数的解释，与exp相同的这就不再赘述<br>&emsp;&emsp;ignore：Oracle在恢复数据的过程中，当导入某个表时，该表已经存在，就要根据ignore参数的设置来决定如何操作。若 ignore=y，Oracle不执行CREATE TABLE语句，直接将数据插入到表中，如果插入的记录违背了约束条件，比如主键约束，唯一索引等，则出错的记录不会插入，但合法的记录会添加到表中。若 ignore=n，Oracle不执行CREATE TABLE语句，同时也不会将数据插入到表中，而是忽略该表的错误，继续导入下一个表。 注<br>意：如果表中的字段并没有唯一性约束，那么在使用ignore=y的情况下很有可能插入重复数据。<br>&emsp;&emsp;indexes：在恢复数据的过程中，若indexes=n，则表上的索引不会被恢复，但是对 LOB 索引, OID索引和 主键索引等系统自动生成的索引将无条件恢复。<br>&emsp;&emsp;indexfile：不进行导入操作而是将创建对象的文本保存到文件中，可以通过编辑使用该文本文件创建数据库对象。<br>&emsp;&emsp;fromuser,touser:这两个参数可以组合使用，也可以分开使用。他们可以实现将源用户的对象数据，导入到目标用户schema底下的功能。这里要注意，导入时的用户需要有<br>imp_full_database角色，示例如下<br>导入一个或一组指定用户所属的全部对象<br>$imp system/manager file=full_all.dmp log=seapark fromuser=hr<br>$imp system/manager file=seapark log=seapark fromuser=(seapark,amy,amyc,harold)<br>将一个或一组指定用户所属的全部对象导入到另一个用户下<br>$imp hr/hr fromuser=hr touser=czm file=hr_all.dmp<br>$imp system/manager file=tank log=tank fromuser=(seapark,amy) touser=(seapark1, amy1)<br>commit：默认值为 COMMIT=N，及在每插入完一个对象后提交。 当COMMIT=Y时候是根据你BUFFER的大小决定每次提交的数量。对于包含了LONG、RAW、 DATE等类型的表，不论BUFFER设置多大，都是每插入一行进行提交。设置commit=y可以防止减少回滚段的压力，但由于频繁提交，会带来性能 上的影响，推荐使用COMMIT=N。</p>\n</blockquote>\n</li>\n<li><p>下列关键字仅用于可传输的表空间</p>\n<blockquote>\n<p>TRANSPORT_TABLESPACE 导入可传输的表空间元数据 (N)<br>TABLESPACES 将要传输到数据库的表空间<br>DATAFILES 将要传输到数据库的数据文件<br>TTS_OWNERS 拥有可传输表空间集中数据的用户</p>\n</blockquote>\n</li>\n<li><p>关于增量参数的说明：exp/imp的增量并不是真正意义上的增量，所以最好不要使用。</p>\n</li>\n</ul>\n<h2 id=\"3-exp-imp常用语法\"><a href=\"#3-exp-imp常用语法\" class=\"headerlink\" title=\"3.exp / imp常用语法\"></a>3.exp / imp常用语法</h2><h3 id=\"3-1-exp\"><a href=\"#3-1-exp\" class=\"headerlink\" title=\"3.1 exp\"></a>3.1 exp</h3><ul>\n<li><p>完全</p>\n<pre><code class=\"shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n--exp \\&quot;/ as sysdba\\&quot; compress=n buffer=4096000 feedback=100000 full=y file=exp_itpuxdb.dmp log=exp_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n</code></pre>\n</li>\n<li><p>用户</p>\n<pre><code class=\"shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 owner=itpux file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n--exp itpux/itpux compress=n buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=expitpux_itpuxdb.log\n</code></pre>\n</li>\n<li><p>表</p>\n<pre><code class=\"shell\">exp itpux/itpux compress=n buffer=4096000 feedback=100000 tables=t1,t2,t2 file=exp_t1_itpuxdb.dmp log=exp_t1_itpuxdb.log\n</code></pre>\n</li>\n<li><p>other</p>\n<pre><code class=\"shell\">exp system/oracle compress=n buffer=4096000 feedback=100000 rows=n file=expfull_itpuxdb.dmp log=expfull_itpuxdb.log\n</code></pre>\n</li>\n</ul>\n<h3 id=\"3-2-imp\"><a href=\"#3-2-imp\" class=\"headerlink\" title=\"3.2 imp\"></a>3.2 imp</h3><ul>\n<li><p>完全</p>\n<pre><code class=\"shell\">imp system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--exp \\&quot;/ as sysdba\\&quot; system/oracle ignore=y buffer=4096000 feedback=100000 full=y file=expfull_itpuxdb.dmp log=impfull_itpuxdb.log\n--backup/backup : exp_full_database,imp_full_database, grant exp_full_database to backup; grant imp_full_database to backup;\n</code></pre>\n</li>\n<li><p>用户</p>\n<pre><code class=\"shell\">imp system/oracle fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n--imp itpux/itpux fromuser=itpux touser=itpux ignore=y buffer=4096000 feedback=100000 file=expitpux_itpuxdb.dmp log=impitpux_itpuxdb.log\n</code></pre>\n</li>\n<li><p>表</p>\n<pre><code class=\"shell\">imp itpux/itpux fromuser=itpux touser=itpux tables=t1,t2,t3 ignore=y buffer=4096000 feedback=100000 file=exp_t1_itpuxdb.dmp log=imp_t1_itpuxdb.log\n</code></pre>\n</li>\n</ul>\n<h2 id=\"4-配置生产环境的逻辑自动备份策略\"><a href=\"#4-配置生产环境的逻辑自动备份策略\" class=\"headerlink\" title=\"4.配置生产环境的逻辑自动备份策略\"></a>4.配置生产环境的逻辑自动备份策略</h2><blockquote>\n<p>要求：每天早上5点做逻辑全备，备份文件保留一周。<br><code>`</code>shell<br>vi /backup/scripts/expfull_db01.sh<br>export BAKDATE=<code>date +%Y%m%d</code><br>export ORACLE_SID=db01<br>nohup exp system/oracle compress=n buffer=4096000 feedback=100000 full=y file=/backup/expfull_db01_$BAKDATE.dmp log=/backup/expfull_db01_$BAKDATE.log &amp;<br>gzip -f /backup/expfull_db01_$BAKDATE.dmp<br>find /backup -name expfull_db01_*.dmp.gz -atime +2 -exec rm -rf {} \\;</p>\n</blockquote>\n<p>#chown -R oracle:dba /backup/expfull_db01.sh</p>\n<p>#chmod 775 /backup/expfull_db01.sh</p>\n<p>#crontab -e<br>00 05 <em> </em> * su - oracle -c /backup/scripts/expfull_db01.sh</p>\n<pre><code>\n## 5.exp / imp生产环境数据迁移流程和注意事项\n### 5.1 数据迁移的目的\n&gt;使用exp/imp进行数据迁移的前置条件、操作步骤，降低对对应用造成的影响及避免故障\n### 5.2 数据迁移的适用范围\n&gt;所有线上库9i ,10g &gt; 11g 12c \n&gt;11g不建用了，\n### 5.3 数据迁移的风险评估\n&gt;&amp;emsp;&amp;emsp;01.exp导出数据时没有使用compress=n参数，会导致所有数据被压缩在一个extent里，导入可能由于没有连续的blocks满足需要，导致imp失败。\n&amp;emsp;&amp;emsp;02.有些os对文件大小有限制，exp数据时需要使用filesize参数来分割导出文件\n&amp;emsp;&amp;emsp;03.exp导出数据时没有正确估计dmp文件所需空间，导致主机磁盘满。\n&amp;emsp;&amp;emsp;05.imp导入数据时没有使用ignore=y参数，目标库上存在表的情况下数据无法导入\n&amp;emsp;&amp;emsp;05.imp导入大量数据时没有使用commit=y参数，导致事务太久，undo资源占用过大无法及时回收。\n&amp;emsp;&amp;emsp;06.跨字符集的数据迁移，由于字符集不兼容导致数据迁移失败。\n&amp;emsp;&amp;emsp;07.imp跨schema进行数据迁移时，没有正确指定fromuser、touser，导致数据没有正确导入\n&amp;emsp;&amp;emsp;09.导入表空间不存在或者空间不足，导致表创建失败或者数据导入失败，导致其他应用报错\n### 5.4 数据迁移的准备工作\n&gt;&amp;emsp;&amp;emsp;01.检查源数据库和目标库的版本、字符集，如果目标库版本低于源库，使用目标库的软件做导出。如果字符集不一致，不建议使用exp/imp迁移数据。\n&amp;emsp;&amp;emsp;02.检查目标库上表结构和源结构是否一致，如果不一致，先修复结构，保证一致。\n&amp;emsp;&amp;emsp;03.user_segments里查出导出表所占的空间大小，检查os对文件大小的限制。如果表大小超出文件大小，exp导出时加上这两个参数：filesize=小于文件限制的数值m,file=exp01.dmp,exp02.dmp,…多个dmp文件\n&amp;emsp;&amp;emsp;04.表比较多的情况下，建议用parfile。各个参数在parfile里写好。\ntables=(tab1,tab2,tab3,..)\n&amp;emsp;&amp;emsp;05.根据不同的需要要书写query子句时，这个参数跟direct=y冲突\n### 5.5 数据迁移的执行过程\n&gt;01.如果目标表是已存在数据，跟应用确认后，可以先进行导出备份，以防后面需要回退。\n先根据需求编辑exp、imp的参数文件：’-‘后面是参数说明，实际使用时去掉cat exp_itpux.par\nuserid=itpux/itpux@db01\ndirect=y –直接路径导出，加快导出速度\ncompress=n –避免数据全部压缩在一个数据块上\nfile=exp_itpux01.dmp\nlog=exp_itpux01.log\nrecordlength=65535 –写dmp文件时一次IO的大小，上限是65535，可以加快导出速度\nbuffer=4096000 -数据缓冲区大小\ntables=itpux01\n\nexp parfile=exp_itpux.par –进行数据导出\n```shell\ncat imp_itpux.par\nuserid=itpux/itpux\ncommit=y –开启批量提交，避免长事务\nignore=y –如果目标表已经存在，只导入数据\nfromuser=itpux\ntouser=itpux\ntables=itpux01\nfile=imp_itpux01.dmp\nlog=imp_itpux01.log\nbuffer=100000 –大小控制导入速度的，设置过大会导致日志产生很快\nimp parfile=imp_itpux.par –进行数据导入\n</code></pre><blockquote>\n<p>注意上面的fromuser和touser。如果将表导入到两个schema:itpux01,itpux02<br>需要按照这种格式配置参数：<br>fromuser和touser一一对应，即使导出时只有一个schema.<br>fromuser=itpux01,itpux01<br>touser=itpux02,itpux02</p>\n</blockquote>\n<ul>\n<li>02 exp导出数据时，检查exp的日志，如果报错，一般是参数配置错误，参考官方文档调整参数。</li>\n<li>03 imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报错：<pre><code class=\"sql\">spool itpux_object_create_scripts.sql\nSET LONG 2000000 PAGESIZE 0 head off verify off feedback off linesize 180\nselect dbms_metadata.get_ddl(&#39;USER&#39;,&#39;ITPUX02&#39;) from dual;\nselect dbms_metadata.get_granted_ddl(&#39;OBJECT_GRANT&#39;,&#39;ITPUX02&#39;) from dual;\nselect dbms_metadata.get_granted_ddl(&#39;ROLE_GRANT&#39;,&#39;ITPUX02&#39;) from dual;\nselect dbms_metadata.get_granted_ddl(&#39;SYSTEM_GRANT&#39;,&#39;ITPUX02&#39;) from dual;\nselect dbms_metadata.get_ddl(&#39;TABLESPACE&#39;,&#39;ITPUX02&#39;) from dual;\nspool off;\n</code></pre>\n</li>\n<li>04 imp导入数据过程，需要监控下数据库事务和日志产生速度。</li>\n<li>05 对导入的表收集统计信息。</li>\n</ul>\n<h3 id=\"5-6-数据迁移后的验证方案\"><a href=\"#5-6-数据迁移后的验证方案\" class=\"headerlink\" title=\"5.6 数据迁移后的验证方案\"></a>5.6 数据迁移后的验证方案</h3><blockquote>\n<p>对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。<br>比如上面的数据迁移，检查数据量跟日志显示是否一致。<br>select count(*) from itpux.itpux01;<br>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。</p>\n<pre><code class=\"sql\">select object_type s_object_type,count(*) from dba_objects where owner=&#39;ITPUX01&#39; group by object_type ;\nselect object_type t_object_type,count(*) from dba_objects where owner=&#39;ITPUX01&#39; group by object_type ;\nselect * from dba_objects where status &lt;&gt; &#39;VALID&#39; and owner=&#39;ITPUX01&#39;;\n</code></pre>\n<ul>\n<li>dblink两个库一起查询;<pre><code class=\"sql\">SELECT s.s_object_type,\n     s.s_count,\n     t.t_object_type,\n     t.t_count\nFROM (  SELECT object_type s_object_type, COUNT (*) s_count\n          FROM dba_objects@db01\n         WHERE owner = &#39;ITPUX01&#39;\n      GROUP BY object_type) s,\n     (  SELECT object_type t_object_type, COUNT (*) t_count\n          FROM dba_objects\n         WHERE owner = &#39;ITPUX01&#39;\n      GROUP BY object_type) t;\n</code></pre>\n自动生成编译无效对象SQL及编译过程</li>\n</ul>\n</blockquote>\n<ul>\n<li>统计当前用户无效对象数量:<pre><code class=\"sql\">SELECT owner,\n       object_type,\n       status,\n       COUNT (*)\n  FROM dba_objects\n WHERE status &lt;&gt; &#39;VALID&#39;\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n</code></pre>\n</li>\n<li><p>生成编译无效对象SQL</p>\n<pre><code class=\"sql\">SELECT    &#39;ALTER &#39;\n     || OBJECT_TYPE\n     || &#39; &#39;\n     || OWNER\n     || &#39;.&#39;\n     || OBJECT_NAME\n     || &#39; COMPILE;&#39;\nFROM dba_objects\nWHERE     status &lt;&gt; &#39;VALID&#39;\n     AND object_type IN (&#39;PACKAGE&#39;,\n                         &#39;PACKAGE BODY&#39;,\n                         &#39;FUNCTION&#39;,\n                         &#39;PROCEDURE&#39;,\n                         &#39;TRIGGER&#39;,\n                         &#39;VIEW&#39;);\n</code></pre>\n<blockquote>\n<p>通过复制以上SQL语句,直接手动执行编译执行,也可以采用如下方式在oracle用户下进行手工编译<br><code>`</code>sql</p>\n</blockquote>\n<h1 id=\"su-oracle\"><a href=\"#su-oracle\" class=\"headerlink\" title=\"su - oracle\"></a>su - oracle</h1><p>$ sqlplus / as sysdba<br>SQL&gt; @$ORACLE_HOME/rdbms/admin/utlrp.sql<br><code>`</code></p>\n</li>\n<li><p>如果有序列要处理</p>\n<pre><code class=\"sql\">exclude=SEQUENCE\n</code></pre>\n<blockquote>\n<p>目标库<br>方法1:<br>1.源库： 查出sequence的最大值<br>2.目标库： DROP SEQUENCE …. 再 CREATE SEQUENCE START最大值 其他不变<br>方法2：<br>目标库： DROP SEQUENCE …. 再 CREATE SEQUENCE START 超大值 （保证比之前的都大，不会发生冲突的 ）</p>\n</blockquote>\n</li>\n<li><p>可以用以下脚本来实现 ：<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 19:49:33 (QP5 v5.313) </em>/<br>script FROM THE SOURCE database. USE this script TO RESET THE proper starting VALUE FOR sequences ON THE TARGET database.<br>cr_tts_create_seq.SQL<br>SET HEADING OFF FEEDBACK OFF TRIMSPOOL ON ESCAPE OFF<br>SET LONG 1000 LINESIZE 1000 PAGESIZE 0<br>COL SEQDDL FORMAT A300<br>SPOOL tts_create_seq.sql<br>PROMPT /<em> ========================= </em>/<br>PROMPT /<em> Drop and create sequences </em>/<br>PROMPT /<em> ========================= </em>/</p>\n</li>\n</ul>\n<p>SELECT REGEXP_REPLACE (<br>           DBMS_METADATA.get_ddl (‘SEQUENCE’, sequence_name, sequence_owner),<br>           ‘^.<em>(CREATE SEQUENCE.</em>CYCLE).*$’,<br>              ‘DROP SEQUENCE “‘<br>           || sequence_owner<br>           || ‘“.”‘<br>           || sequence_name<br>           || ‘“;’<br>           || CHR (10)<br>           || ‘\\1;’)<br>           SEQDDL<br>  FROM dba_sequences<br> WHERE sequence_owner NOT IN (SELECT name<br>                                FROM SYSTEM.logstdby$skip_support<br>                               WHERE action = 0);</p>\n<p>SPOOL OFF</p>\n<pre><code>\n### 5.7 数据迁移核心对象风险\n&gt;由于核心表访问、变更频繁，不宜直接使用imp对核心表大量导入数据。\n\n### 5.8 数据迁移回退方案\n&gt;exp对应用无影响，不需要回退。\nimp后可能数据有误，需要进行回退操作。\n如果目标表本来就是空表，跟应用确认后，直接清空即可。\n如果目标表原有数据，跟应用确认是否使用原有备份数据进行恢复。若需要，先exp备份当前数据，然后清空再导入前面的备份数据。\n\n## 6.exp / imp数据迁移案例\n### 6.1 迁移目的\n&gt;&amp;emsp;&amp;emsp;将linux系统oracle服务器上schema（itpux01,itpux02）全部通过Exp迁移到另一台oracle服务器，并能正常查询到相关数据。\n### 6.2 迁移流程\n```sql\n1.准备数据：linux系统oracle服务器上创建用户,表空间.并创建相关表.数据等。\n2.linux本地用Exp做导出;\n3.再到远程主机创建相关对象；\n4.远程主机用imp做导入(导入);\n5.验证远程本地数据合法性;\n</code></pre><h3 id=\"6-3-迁移过程\"><a href=\"#6-3-迁移过程\" class=\"headerlink\" title=\"6.3 迁移过程\"></a>6.3 迁移过程</h3><ul>\n<li>创建表空间<br><code>`</code>sql<br>CREATE TABLESPACE itpux11<br>  DATAFILE ‘/oracle/oradata/db01/itpux01.dbf’<pre><code>           SIZE 100 M\n           AUTOEXTEND OFF\n</code></pre>  EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>  SEGMENT SPACE MANAGEMENT AUTO;</li>\n</ul>\n<p>CREATE TABLESPACE itpux12<br>    DATAFILE ‘/oracle/oradata/db01/itpux02.dbf’<br>                 SIZE 100 M<br>                 AUTOEXTEND OFF<br>    EXTENT MANAGEMENT LOCAL AUTOALLOCATE<br>    SEGMENT SPACE MANAGEMENT AUTO;</p>\n<pre><code>\n* 创建用户并授权\n```sql\nCREATE USER itpux01 IDENTIFIED BY itpux01\n    DEFAULT TABLESPACE itpux01;\nCREATE USER itpux02 IDENTIFIED BY itpux02\n    DEFAULT TABLESPACE itpux02;\nGRANT DBA TO itpux01;\nGRANT DBA TO itpux02;\n\nALTER USER itpux01\n    QUOTA UNLIMITED ON itpux01;\n\nALTER USER itpux02\n    QUOTA UNLIMITED ON itpux02;\n</code></pre><ul>\n<li>moon用户登录并创建测试表<br><code>`</code>sql<br>CONN itpux01 / itpux01<br>CREATE TABLE itpux01<br>(<br>  id    NUMBER (30) PRIMARY KEY NOT NULL,<br>  name DATE<br>);</li>\n</ul>\n<p>CONN itpux02 / itpux02<br>CREATE TABLE itpux02<br>(<br>    id    NUMBER (30) PRIMARY KEY NOT NULL,<br>    name DATE<br>);</p>\n<pre><code>\n* 创建2个存储过程并执行\n```sql\nCONN itpux01 / itpux01\n\nCREATE OR REPLACE PROCEDURE p_itpux01\nIS\nBEGIN\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\n\n    FOR i IN 1 .. 1000\n    LOOP\n        INSERT INTO itpux01 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux01&#39;;\nEND p_itpux01;\n/\n\n\nBEGIN\n    p_itpux01;\nEND;\n/\n\nSELECT COUNT (*) FROM itpux01;\n\nSELECT *\n  FROM itpux01\n WHERE id &gt; 990;\n\nCONN itpux02 / itpux02\nCREATE OR REPLACE PROCEDURE p_itpux02\nIS\nBEGIN\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\n\n    FOR i IN 1 .. 2000\n    LOOP\n        INSERT INTO itpux02 (id, name)\n             VALUES (i, SYSDATE);\n\n        COMMIT;\n    END LOOP;\n\n    EXECUTE IMMEDIATE &#39;select count(*) from itpux02&#39;;\nEND p_itpux02;\n/\n\nBEGIN\n    p_itpux02;\nEND;\n/\n</code></pre><ul>\n<li>查询验证数据<br><code>`</code>sql<br>CONN itpux01 / itpux01</li>\n</ul>\n<p>SELECT COUNT (*) FROM itpux01;</p>\n<p>SELECT *<br>  FROM itpux01<br> WHERE id &gt; 990;</p>\n<p>CONN itpux02 / itpux02</p>\n<p>SELECT COUNT (*) FROM itpux02;</p>\n<p>SELECT *<br>  FROM itpux02<br> WHERE id &gt; 1990;</p>\n<pre><code>\n* 本地用Exp做导出\n```sql\nEXP SYSTEM/oracle OWNER=itpux01,itpux02 COMPRESS=n FILE=exp_2table.dmp LOG=exp_2table.LOG direct=y recordlength=65535 buffer=4096000\n</code></pre><ul>\n<li>imp导入之前，需要创建相应的用户，权限，表空间等对象，否则报<br><code>`</code>sql<br>/<em> Formatted on 2018/1/30 20:03:14 (QP5 v5.313) </em>/<br>SPOOL itpux_object_create_scripts.sql<br>SET LONG 2000000 PAGESIZE 0 HEAD OFF VERIFY OFF FEEDBACK OFF LINESIZE 180</li>\n</ul>\n<p>SELECT DBMS_METADATA.get_ddl (‘USER’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘OBJECT_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘ROLE_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘SYSTEM_GRANT’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘TABLESPACE’, ‘ITPUX01’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘USER’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘OBJECT_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘ROLE_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_granted_ddl (‘SYSTEM_GRANT’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SELECT DBMS_METADATA.get_ddl (‘TABLESPACE’, ‘ITPUX02’) FROM DUAL;</p>\n<p>SPOOL OFF;</p>\n<pre><code>\n* 异机用imp做导入\n```sql\nimp SYSTEM/oracle fromuser=itpux01,itpux02 touser=itpux01,itpux02 FILE=exp_2table.dmp LOG=exp_2table.LOG COMMIT=y IGNORE=y buffer=4096000\n</code></pre><ul>\n<li>验证导入后的数据合法性<br><code>`</code>sql</li>\n</ul>\n<pre><code>\n### 6.4 数据迁移后的验证方案\n&gt;对比exp、imp的日志，确认导出导入数据量是否一致。并在数据库上检查数据量。\n比如上面的数据迁移，检查数据量跟日志显示是否一致。\n```sql\nSELECT COUNT (*) FROM itpux.itpux01;\n</code></pre><blockquote>\n<p>跨schema或者数据库迁移数据时，除检查日志外，还需要检查源和目标的对象数据量、是否有失效对象。<br><code>`</code>sql<br>  SELECT object_type s_object_type, COUNT (*)<br>    FROM dba_objects<br>   WHERE owner = ‘ITPUX01’<br>GROUP BY object_type;</p>\n</blockquote>\n<p>  SELECT object_type t_object_type, COUNT (*)<br>    FROM dba_objects<br>   WHERE owner = ‘ITPUX01’<br>GROUP BY object_type;</p>\n<p>SELECT *<br>  FROM dba_objects<br> WHERE status &lt;&gt; ‘VALID’ AND owner = ‘ITPUX01’;</p>\n<pre><code>* dblink两个库一起查\n```sql\nSELECT s.s_object_type,\n       s.s_count,\n       t.t_object_type,\n       t.t_count\n  FROM (  SELECT object_type s_object_type, COUNT (*) s_count\n            FROM dba_objects@db01\n           WHERE owner = &#39;ITPUX01&#39;\n        GROUP BY object_type) s,\n       (  SELECT object_type t_object_type, COUNT (*) t_count\n            FROM dba_objects\n           WHERE owner = &#39;ITPUX01&#39;\n        GROUP BY object_type) t;\n</code></pre><ul>\n<li>自动生成编译无效对象SQL及编译过程<blockquote>\n<p>统计当前用户无效对象数量</p>\n<pre><code class=\"sql\">SELECT owner,\n       object_type,\n       status,\n       COUNT (*)\n  FROM dba_objects\n WHERE status &lt;&gt; &#39;VALID&#39;\nGROUP BY owner, object_type, status\nORDER BY owner, object_type;\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>生成编译无效对象SQL</p>\n<pre><code class=\"sql\">SELECT    &#39;ALTER &#39;\n       || OBJECT_TYPE\n       || &#39; &#39;\n       || OWNER\n       || &#39;.&#39;\n       || OBJECT_NAME\n       || &#39; COMPILE;&#39;\n  FROM dba_objects\n WHERE     status &lt;&gt; &#39;VALID&#39;\n       AND object_type IN (&#39;PACKAGE&#39;,\n                           &#39;PACKAGE BODY&#39;,\n                           &#39;FUNCTION&#39;,\n                           &#39;PROCEDURE&#39;,\n                           &#39;TRIGGER&#39;,\n                           &#39;VIEW&#39;);\n</code></pre>\n<p>通过复制以上SQL语句,直接手动执行编译执行.<br>也可以采用如下方式在oracle用户下进行手工编译</p>\n<pre><code class=\"sql\">su - oracle\n$ sqlplus / as sysdba\nSQL&gt; @$ORACLE_HOME/rdbms/admin/utlrp.sql\n</code></pre>\n</blockquote>\n<h2 id=\"7-exp-imp迁移过程字符集的处理\"><a href=\"#7-exp-imp迁移过程字符集的处理\" class=\"headerlink\" title=\"7.exp / imp迁移过程字符集的处理\"></a>7.exp / imp迁移过程字符集的处理</h2><blockquote>\n<p>进行数据的导入导出时，我们要注意关于字符集的问题。在EXP/IMP过程中我们需要注意四个字符集的参数：</p>\n<pre><code class=\"shell\">01.导出端的客户端字符集。\n02.导出端数据库字符集。\n03.导入端的客户端字符集。\n04.导入端数据库字符集。\n</code></pre>\n<p>我们首先需要查看这四个字符集参数。<br>查看数据库的字符集的信息：<br><code>`</code>sql<br>SQL&gt; select <em> from nls_database_parameters;<br>//SQL&gt; select </em> from props$;<br>SQL&gt; SET PAGESIZE 30<br>SQL&gt; select * from nls_database_parameters;</p>\n</blockquote>\n<p>PARAMETER                      VALUE</p>\n<hr>\n<p>NLS_LANGUAGE                   AMERICAN<br>NLS_TERRITORY                  AMERICA<br>NLS_CURRENCY                   $<br>NLS_ISO_CURRENCY               AMERICA<br>NLS_NUMERIC_CHARACTERS         .,<br>NLS_CHARACTERSET               ZHS16GBK<br>NLS_CALENDAR                   GREGORIAN<br>NLS_DATE_FORMAT                DD-MON-RR<br>NLS_DATE_LANGUAGE              AMERICAN<br>NLS_SORT                       BINARY<br>NLS_TIME_FORMAT                HH.MI.SSXFF AM<br>NLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM<br>NLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR<br>NLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR<br>NLS_DUAL_CURRENCY              $<br>NLS_COMP                       BINARY<br>NLS_LENGTH_SEMANTICS           BYTE<br>NLS_NCHAR_CONV_EXCP            FALSE<br>NLS_NCHAR_CHARACTERSET         UTF8<br>NLS_RDBMS_VERSION              11.2.0.4.0</p>\n<p>20 rows selected.</p>\n<pre><code>&gt;我们再来查看客户端的字符集信息：\n客户端字符集的参数NLS_LANG=_&lt; territory &gt;.\nlanguage：指定oracle消息使用的语言，日期中日和月的显示。\nTerritory：指定货币和数字的格式，地区和计算星期及日期的习惯。\nCharacterset：控制客户端应用程序使用的字符集。通常设置或等于客户端的代码页。ZHS16GBK、UTF8。\n\n* 如数据库语言环境\n&gt;os是windows,使用命令\nset NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;os是linux or unix,使用命令\nexport NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n在unix中：\n\\\n\n&gt;$ env|grep NLS_LANG\nNLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;当前修改可用：\n$ export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK\n\n&gt;永久修改可用：\nvi bash_profile\n\n* 通常在导出时最好把客户端字符集设置得和数据库端相同。当进行数据导入时，主要有以下两种情况：\n&gt;&amp;emsp;&amp;emsp;(1) 源数据库和目标数据库具有相同的字符集设置。\n这时，只需设置导出和导入端的客户端NLS_LANG等于数据库字符集即可。\n&amp;emsp;&amp;emsp;(2) 源数据库和目标数据库字符集不同。\n&amp;emsp;&amp;emsp;先将导出端客户端的NLS_LANG设置成和导出端的数据库字符集一致，导出数据，然后将导入端客户端的NLS_LANG设置成和导出端一致，导入数据，这样转换只发生在数据库端，而且只发生一次。\n&amp;emsp;&amp;emsp;这种情况下，只有当导入端数据库字符集为导出端数据库字符集的严格超集时，数据才能完全导成功，否则，可能会有数据不一致或乱码出现。\n## 8.exp / imp优化的方法\n&gt;当需要exp/imp的数据量比较大时，这个过程需要的时间是比较长的，我们可以用一些方法来优化exp/imp的操作。\n\n* 01.exp:使用直接路径 direct=y\n&gt;&amp;emsp;&amp;emsp;oracle会避开sql语句处理引擎,直接从数据库文件中读取数据,然后写入导出文件.\n&amp;emsp;&amp;emsp;可以在导出日志中观察到: exp-00067: table xxx will be exported in conventional path\n&amp;emsp;&amp;emsp;如果没有使用直接路径,必须保证buffer参数的值足够大.\n&amp;emsp;&amp;emsp;有一些参数于direct=y不兼容,无法用直接路径导出可移动的tablespace,或者用query参数导出数据库子集.\n&amp;emsp;&amp;emsp;当导入导出的数据库运行在不同的os下时,必须保证recordlength参数的值一致.\n\n* 02.exp: 清空回收站\n```sql\nSQL&gt; select count(*) from dba_recyclebin;\nSQL&gt; purge dba_recyclebin;\n</code></pre><ul>\n<li><p>03.imp:避免磁盘排序</p>\n<blockquote>\n<p>涉及到sort_area_size参数,也就是我们的PGA要够大。</p>\n</blockquote>\n</li>\n<li><p>05.imp:优化日志缓冲区</p>\n<blockquote>\n<p>比如将log_buffer容量扩大10倍(最大不要超过5M),也就是我们的SGA要够大。</p>\n</blockquote>\n</li>\n<li><p>05.imp:避免日志切换等待</p>\n<blockquote>\n<p>增加重做日志组的数量,增大日志文件大小.</p>\n</blockquote>\n</li>\n<li><p>06.imp:使用commit</p>\n<blockquote>\n<p>commit = y<br>注意:这个方式不能处理包含LOB和LONG类型的表,对于这样的table,如果使用commit = y,每插入一行,就会执行一次提交.</p>\n</blockquote>\n</li>\n<li><p>07.imp:使用NOLOGGING方式减小重做日志大小</p>\n<blockquote>\n<p>在导入时指定参数indexes=n,只导入数据而忽略index,在导完数据后在通过脚本创建index,指定NOLOGGING选项</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"9-exp-imp-常见问题及解决方法\"><a href=\"#9-exp-imp-常见问题及解决方法\" class=\"headerlink\" title=\"9.exp / imp 常见问题及解决方法\"></a>9.exp / imp 常见问题及解决方法</h2><h3 id=\"9-1-关于imp-exp版本的问题\"><a href=\"#9-1-关于imp-exp版本的问题\" class=\"headerlink\" title=\"9.1 关于imp/exp版本的问题\"></a>9.1 关于imp/exp版本的问题</h3><blockquote>\n<p>一般来说，从低版本导入到高版本问题不大，麻烦的是将高版本的数据导入到低版本中。</p>\n<ul>\n<li>可以跨版本的使用EXP/IMP，但必须正确地使用EXP和IMP的版本（官方可查）：<pre><code class=\"sql\">1、使用IMP的版本匹配数据库的版本，如：要导入到11.2中，使用11.2的IMP工具。\n2、使用EXP的版本匹配两个数据库中最低的版本，如：从11.2往10.2中导入，则使用10.2版本的EXP工具。\n3、高版本的Export导出来的转储文件，低版本的Import读不了；低版本的Export导出来的转储文件，高版本的Import可以进行读取。\n4、从Oracle低版本的Export数据可以Import到Oracle高版本中，但限于Oracle的相邻版本，两个不相邻版本间进行转换应借助中间版本。\n5、exp/imp可以做到在不同版本Oracle、不同数据库上的迁移。\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"9-2-数据库对象已经存在\"><a href=\"#9-2-数据库对象已经存在\" class=\"headerlink\" title=\"9.2 数据库对象已经存在\"></a>9.2 数据库对象已经存在</h3><blockquote>\n<p>&emsp;&emsp;一般情况, 导入数据前应该彻底删除目标数据下的表, 序列, 函数/过程,触发器等; 数据库对象已经存在, 按缺省的imp参数, 则会导入失败如果用了参数ignore=y, 会把exp文件内的数据内容导入如果表有唯一关键字的约束条件, 不合条件将不被导入如果表没有唯一关键字的约束条件, 将引起记录重复</p>\n</blockquote>\n<h3 id=\"9-3-数据库对象有主外键约束\"><a href=\"#9-3-数据库对象有主外键约束\" class=\"headerlink\" title=\"9.3 数据库对象有主外键约束\"></a>9.3 数据库对象有主外键约束</h3><blockquote>\n<p>不符合主外键约束时, 数据会导入失败,<br>解决办法:<br>先导入主表, 再导入依存表<br>disable目标导入对象的主外键约束, 导入数据后, 再enable它们</p>\n</blockquote>\n<h3 id=\"9-4-权限不够\"><a href=\"#9-4-权限不够\" class=\"headerlink\" title=\"9.4 权限不够\"></a>9.4 权限不够</h3><blockquote>\n<p>如果要把A用户的数据导入B用户下, A用户需要有imp_full_database权限</p>\n</blockquote>\n<h3 id=\"9-5-导入大表存储分配失败\"><a href=\"#9-5-导入大表存储分配失败\" class=\"headerlink\" title=\"9.5 导入大表存储分配失败\"></a>9.5 导入大表存储分配失败</h3><blockquote>\n<p>&emsp;&emsp;默认的EXP时, compress = y, 也就是把所有的数据压缩在一个数据块上.<br>导入时, 如果不存在连续一个大数据块, 则会导入失败. 导出大表时, 记得compress= n, 则不会引起这种错误.</p>\n</blockquote>\n<h3 id=\"9-6-imp和exp使用的字符集不同\"><a href=\"#9-6-imp和exp使用的字符集不同\" class=\"headerlink\" title=\"9.6 imp和exp使用的字符集不同\"></a>9.6 imp和exp使用的字符集不同</h3><blockquote>\n<p>&emsp;&emsp;如果字符集不同, 导入会失败, 可以改变unix环境变量或者NT注册表里NLS_LANG相关信息. 导入完成后再改回来.</p>\n</blockquote>\n<h3 id=\"9-7-imp和exp版本不能往上兼容\"><a href=\"#9-7-imp和exp版本不能往上兼容\" class=\"headerlink\" title=\"9.7 imp和exp版本不能往上兼容\"></a>9.7 imp和exp版本不能往上兼容</h3><blockquote>\n<p>可以从低版本导入高版本，但不能从高版本导入到低版本。<br>如果遇到迁移因版本不同的问题，可以用低版本的export 导出，到导入到低版本。</p>\n</blockquote>\n<h3 id=\"9-8-导出统计信息的问题。\"><a href=\"#9-8-导出统计信息的问题。\" class=\"headerlink\" title=\"9.8 导出统计信息的问题。\"></a>9.8 导出统计信息的问题。</h3><blockquote>\n<p>&emsp;&emsp;如果导出统计信息,在只导出部分数据,或不导出数据时,导出统计信息会报错.另如果未导出统计信息,但导入时,需导入统计信息<br>,那此时,导入后,统计信息会被锁住,而无法更新统计信息.<br>&emsp;&emsp;此时,我们可使用包dbms_stats.unlock_schema_stats来解锁.最好的办法是,在exp,imp时,加入参数statistics=none,不exp,imp统计信息,在导入完成后,在重新收集统计信息.</p>\n</blockquote>\n<pre><code class=\"sql\">BEGIN\n    DBMS_STATS.gather_database_stats;\nEND;\n/\n\nBEGIN\n    DBMS_STATS.gather_schema_stats (&#39;ITPUX02&#39;);\nEND;\n/\n</code></pre>\n"},{"title":"Oracle LogMiner日志挖掘技术部分日志","date":"2018-10-04T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n# Oracle LogMiner日志挖掘技术部分日志\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.Logminer相关概念\n\n\n## 2.Logminer使用详解\n\n### 2.1 安装logminer\n```sql\n$ORACLE_HOME/rdbms/admin/dbmslm.sql : DBMS_LOGMNR\n$ORACLE_HOME/rdbms/admin/dbmslmd.sql :DBMS_LOGMNR_D\n$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--过程\ndbms_logmnr_d.build('dict.ora','/u01') --创建一个数据字典文件\ndbms_logmnr.add_logfile\ndbms_logmnr.start_logmnr\ndbms_logmnr.end_logmnr\n--视图\nselect * from v$logmnr_dictionary;\nselect * from v$logmnr_logs;\nselect * from v$logmnr_contents;\n```\n### 2.2  使用源数据库的数据字典（Online catalog)来分析DML操作\n```sql\n--01.开启补充日志\nselect SUPPLEMENTAL_LOG_DATA_MIN from v$database;\nalter database add supplemental log data;\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=>'日志文件')\n--03.启动分析\nexecute dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog)\n//execute dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,startscn=>123,endScn => 124);\n//exec dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n```\n### 2.3 使用LogMiner字典到字典文件来分析DDL操作\n```sql\n--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir='/oracle' scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build('dict.ora','/oracle');\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=>'日志文件')\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora');---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n```\n### 2.4使用LogMiner进行日志分析\n```sql\nexec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora');---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n```\n### 2.5 查看logminer分析结果\n```sql\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\nSQL> desc v$logmnr_contents;\n名称 类型\n----------------------------------------- ----------------------------\nTIMESTAMP DATE //SQL执行时间\nCOMMIT_TIMESTAMP DATE //事务提交时间\nSEG_OWNER VARCHAR2(32) //被修改对象创建者\nSEG_NAME VARCHAR2(256) //被修改对象的名字，如表名\nSEG_TYPE NUMBER //被修改对象类型\nSEG_TYPE_NAME VARCHAR2(32) //被修改对象类型名\nTABLE_SPACE VARCHAR2(32) //被修改对象所属表空间\nROW_ID VARCHAR2(19) //被修改行的ROWID，如果\nSESSION# NUMBER //执行修改的SESSION号\nSERIAL# NUMBER //执行修改的SESSION序号\nUSERNAME VARCHAR2(30) //执行事务的用户名\nSESSION_INFO VARCHAR2(4000) //执行修改的SESSION信息,例如：login_username= client_info= OS_username=SYSTEM Machine_name=ZFMISERVER OS_termi\nnal=ZFMISERVER OS_process_id=1812 OS_program name=ORACLE.EXE\nTX_NAME VARCHAR2(256) //执行的事务名，当该事务被命名时\nROLLBACK NUMBER //回滚标记\nOPERATION VARCHAR2(32) //操作类型\nINSERT\nUPDATE\nDELETE\nDDL\nSTART\nCOMMIT\nROLLBACK\nLOB_WRITE\nLOB_TRIM\nLOB_ERASE\nSELECT_FOR_UPDATE\nSEL_LOB_LOCATOR\nMISSING_SCN\nINTERNAL\nUNSUPPORTED\nOPERATION_CODE NUMBER //操作类型代码\n\t0 = INTERNAL\n\t1 = INSERT\n\t2 = DELETE\n\t3 = UPDATE\n\t5 = DDL\n\t6 = START\n\t7 = COMMIT\n\t9 = SELECT_LOB_LOCATOR\n\t10 = LOB_WRITE\n\t11 = LOB_TRIM\n\t25 = SELECT_FOR_UPDATE\n\t28 = LOB_ERASE\n\t34 = MISSING_SCN\n\t36 = ROLLBACK\n\t255 = UNSUPPORTED\nSQL_REDO VARCHAR2(4000) //重做日志SQL\nSQL_UNDO VARCHAR2(4000) //相反操作SQL\nSEQUENCE# NUMBER //重做日志的序号\n```\n\n\n## 3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因\n```sql\n--3.1 安装logminer\n@$ORACLE_HOME/rdbms/admin/dbmslm.sql\n@$ORACLE_HOME/rdbms/admin/dbmslmd.sql\n@$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--3.2、使用LogMiner字典到字典文件来分析DDL操作\n--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir='/u01' scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build('dict.ora','/u01');\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_42_f7043xy4_.arc',options=>dbms_logmnr.new);\nexecute dbms_logmnr.add_logfile(logfilename=>'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_41_f7043xtq_.arc',options=>dbms_logmnr.addfile);\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName => '/u01/dict.ora');\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\ncreate table test01.logmnr_temp nologging as select * from v$logmnr_contents;\nselect * from itpux01.logmnr_temp where seg_owner='test01' and seg_name='TEST01';\nselect * from itpux01.logmnr_temp where seg_owner='test01' and seg_name='TEST01';\n--05.结束分析\nexec dbms_logmnr.end_logmnr;\n\n```\n\n## 4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\n\n\n## 5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\n\n\n## 6.logminer使用总结","source":"_posts/oracle/Oracle LogMiner日志挖掘技术部分日志.md","raw":"---\ntitle: Oracle LogMiner日志挖掘技术部分日志\ndate: 2018-10-04 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - LogMiner\n  - 日志分析\n---\n\n# Oracle LogMiner日志挖掘技术部分日志\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.Logminer相关概念\n\n\n## 2.Logminer使用详解\n\n### 2.1 安装logminer\n```sql\n$ORACLE_HOME/rdbms/admin/dbmslm.sql : DBMS_LOGMNR\n$ORACLE_HOME/rdbms/admin/dbmslmd.sql :DBMS_LOGMNR_D\n$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--过程\ndbms_logmnr_d.build('dict.ora','/u01') --创建一个数据字典文件\ndbms_logmnr.add_logfile\ndbms_logmnr.start_logmnr\ndbms_logmnr.end_logmnr\n--视图\nselect * from v$logmnr_dictionary;\nselect * from v$logmnr_logs;\nselect * from v$logmnr_contents;\n```\n### 2.2  使用源数据库的数据字典（Online catalog)来分析DML操作\n```sql\n--01.开启补充日志\nselect SUPPLEMENTAL_LOG_DATA_MIN from v$database;\nalter database add supplemental log data;\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=>'日志文件')\n--03.启动分析\nexecute dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog)\n//execute dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,startscn=>123,endScn => 124);\n//exec dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n```\n### 2.3 使用LogMiner字典到字典文件来分析DDL操作\n```sql\n--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir='/oracle' scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build('dict.ora','/oracle');\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=>'日志文件'，options=>dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=>'日志文件')\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora');---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n```\n### 2.4使用LogMiner进行日志分析\n```sql\nexec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora');---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',\nstarttime => to_date('2016-08-15 00:00:00','YYYY-MM-DD HH24:MI:SS'),\nendtime => to_date('2016-08-15 01:00:00','YYYY-MM-DD HH24:MI:SS');\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n```\n### 2.5 查看logminer分析结果\n```sql\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\nSQL> desc v$logmnr_contents;\n名称 类型\n----------------------------------------- ----------------------------\nTIMESTAMP DATE //SQL执行时间\nCOMMIT_TIMESTAMP DATE //事务提交时间\nSEG_OWNER VARCHAR2(32) //被修改对象创建者\nSEG_NAME VARCHAR2(256) //被修改对象的名字，如表名\nSEG_TYPE NUMBER //被修改对象类型\nSEG_TYPE_NAME VARCHAR2(32) //被修改对象类型名\nTABLE_SPACE VARCHAR2(32) //被修改对象所属表空间\nROW_ID VARCHAR2(19) //被修改行的ROWID，如果\nSESSION# NUMBER //执行修改的SESSION号\nSERIAL# NUMBER //执行修改的SESSION序号\nUSERNAME VARCHAR2(30) //执行事务的用户名\nSESSION_INFO VARCHAR2(4000) //执行修改的SESSION信息,例如：login_username= client_info= OS_username=SYSTEM Machine_name=ZFMISERVER OS_termi\nnal=ZFMISERVER OS_process_id=1812 OS_program name=ORACLE.EXE\nTX_NAME VARCHAR2(256) //执行的事务名，当该事务被命名时\nROLLBACK NUMBER //回滚标记\nOPERATION VARCHAR2(32) //操作类型\nINSERT\nUPDATE\nDELETE\nDDL\nSTART\nCOMMIT\nROLLBACK\nLOB_WRITE\nLOB_TRIM\nLOB_ERASE\nSELECT_FOR_UPDATE\nSEL_LOB_LOCATOR\nMISSING_SCN\nINTERNAL\nUNSUPPORTED\nOPERATION_CODE NUMBER //操作类型代码\n\t0 = INTERNAL\n\t1 = INSERT\n\t2 = DELETE\n\t3 = UPDATE\n\t5 = DDL\n\t6 = START\n\t7 = COMMIT\n\t9 = SELECT_LOB_LOCATOR\n\t10 = LOB_WRITE\n\t11 = LOB_TRIM\n\t25 = SELECT_FOR_UPDATE\n\t28 = LOB_ERASE\n\t34 = MISSING_SCN\n\t36 = ROLLBACK\n\t255 = UNSUPPORTED\nSQL_REDO VARCHAR2(4000) //重做日志SQL\nSQL_UNDO VARCHAR2(4000) //相反操作SQL\nSEQUENCE# NUMBER //重做日志的序号\n```\n\n\n## 3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因\n```sql\n--3.1 安装logminer\n@$ORACLE_HOME/rdbms/admin/dbmslm.sql\n@$ORACLE_HOME/rdbms/admin/dbmslmd.sql\n@$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--3.2、使用LogMiner字典到字典文件来分析DDL操作\n--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir='/u01' scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build('dict.ora','/u01');\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=>'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_42_f7043xy4_.arc',options=>dbms_logmnr.new);\nexecute dbms_logmnr.add_logfile(logfilename=>'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_41_f7043xtq_.arc',options=>dbms_logmnr.addfile);\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName => '/u01/dict.ora');\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\ncreate table test01.logmnr_temp nologging as select * from v$logmnr_contents;\nselect * from itpux01.logmnr_temp where seg_owner='test01' and seg_name='TEST01';\nselect * from itpux01.logmnr_temp where seg_owner='test01' and seg_name='TEST01';\n--05.结束分析\nexec dbms_logmnr.end_logmnr;\n\n```\n\n## 4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\n\n\n## 5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\n\n\n## 6.logminer使用总结","slug":"oracle/Oracle LogMiner日志挖掘技术部分日志","published":1,"updated":"2019-05-03T15:59:40.248Z","_id":"cjv89h3jq0037i0cdgpurj3r7","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-LogMiner日志挖掘技术部分日志\"><a href=\"#Oracle-LogMiner日志挖掘技术部分日志\" class=\"headerlink\" title=\"Oracle LogMiner日志挖掘技术部分日志\"></a>Oracle LogMiner日志挖掘技术部分日志</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-Logminer相关概念\"><a href=\"#1-Logminer相关概念\" class=\"headerlink\" title=\"1.Logminer相关概念\"></a>1.Logminer相关概念</h2><h2 id=\"2-Logminer使用详解\"><a href=\"#2-Logminer使用详解\" class=\"headerlink\" title=\"2.Logminer使用详解\"></a>2.Logminer使用详解</h2><h3 id=\"2-1-安装logminer\"><a href=\"#2-1-安装logminer\" class=\"headerlink\" title=\"2.1 安装logminer\"></a>2.1 安装logminer</h3><pre class=\" language-sql\"><code class=\"language-sql\">$ORACLE_HOME<span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslm<span class=\"token punctuation\">.</span>sql : DBMS_LOGMNR\n$ORACLE_HOME<span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslmd<span class=\"token punctuation\">.</span>sql :DBMS_LOGMNR_D\n$ORACLE_HOME<span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslms<span class=\"token punctuation\">.</span>sql\n<span class=\"token comment\" spellcheck=\"true\">--过程</span>\ndbms_logmnr_d<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span><span class=\"token string\">'dict.ora'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/u01'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">--创建一个数据字典文件</span>\ndbms_logmnr<span class=\"token punctuation\">.</span>add_logfile\ndbms_logmnr<span class=\"token punctuation\">.</span>start_logmnr\ndbms_logmnr<span class=\"token punctuation\">.</span>end_logmnr\n<span class=\"token comment\" spellcheck=\"true\">--视图</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$logmnr_dictionary<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$logmnr_logs<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"2-2-使用源数据库的数据字典（Online-catalog-来分析DML操作\"><a href=\"#2-2-使用源数据库的数据字典（Online-catalog-来分析DML操作\" class=\"headerlink\" title=\"2.2  使用源数据库的数据字典（Online catalog)来分析DML操作\"></a>2.2  使用源数据库的数据字典（Online catalog)来分析DML操作</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.开启补充日志</span>\n<span class=\"token keyword\">select</span> SUPPLEMENTAL_LOG_DATA_MIN <span class=\"token keyword\">from</span> v$<span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">add</span> supplemental log <span class=\"token keyword\">data</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--02.建立日志分析列表</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">--继续添加</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>addfile<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>addfile<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)</span>\n<span class=\"token comment\" spellcheck=\"true\">--移除</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>remove_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">--03.启动分析</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>start_logmnr<span class=\"token punctuation\">(</span>Options <span class=\"token operator\">=</span><span class=\"token operator\">></span> dbms_logmnr<span class=\"token punctuation\">.</span>dict_from_online_catalog<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//execute dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,startscn=>123,endScn => 124);</span>\n<span class=\"token comment\" spellcheck=\"true\">//exec dbms_logmnr.start_logmnr(Options => dbms_logmnr.dict_from_online_catalog,</span>\nstarttime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 00:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nendtime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 01:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--04.查看日志分析结果</span>\n<span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span>scn<span class=\"token punctuation\">,</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>sql_redo<span class=\"token punctuation\">,</span>sql_undo <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--05.结束分析</span>\ndbms_logmnr<span class=\"token punctuation\">.</span>end_logmnr<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"2-3-使用LogMiner字典到字典文件来分析DDL操作\"><a href=\"#2-3-使用LogMiner字典到字典文件来分析DDL操作\" class=\"headerlink\" title=\"2.3 使用LogMiner字典到字典文件来分析DDL操作\"></a>2.3 使用LogMiner字典到字典文件来分析DDL操作</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--01.提取logminer字典</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置一个字典文件路径：</span>\n<span class=\"token keyword\">show</span> parameter utl_file_dir <span class=\"token comment\" spellcheck=\"true\">--需要重启DB</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> utl_file_dir<span class=\"token operator\">=</span><span class=\"token string\">'/oracle'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--创建一个数据字典文件</span>\n<span class=\"token keyword\">exec</span> dbms_logmnr_d<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span><span class=\"token string\">'dict.ora'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/oracle'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--02.建立日志分析列表</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">--继续添加</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>addfile<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span>，options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>addfile<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//execute dbms_logmnr.add_logfile('日志文件'，dbms_logmnr.addfile)</span>\n<span class=\"token comment\" spellcheck=\"true\">--移除</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>remove_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'日志文件'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">--03.启动分析</span>\n<span class=\"token keyword\">exec</span> dbms_logmnr<span class=\"token punctuation\">.</span>start_logmnr<span class=\"token punctuation\">(</span>DictFileName <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'/oracle/dict.ora'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">---无条件分析</span>\n<span class=\"token comment\" spellcheck=\"true\">//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析</span>\n<span class=\"token comment\" spellcheck=\"true\">//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',</span>\nstarttime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 00:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nendtime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 01:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--有条件分析：</span>\nscn: startscn<span class=\"token punctuation\">,</span>endScn\ntime: starttime<span class=\"token punctuation\">,</span>endtime\n<span class=\"token comment\" spellcheck=\"true\">--04.查看日志分析结果</span>\n<span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span>scn<span class=\"token punctuation\">,</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>sql_redo<span class=\"token punctuation\">,</span>sql_undo <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--05.结束分析</span>\ndbms_logmnr<span class=\"token punctuation\">.</span>end_logmnr<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"2-4使用LogMiner进行日志分析\"><a href=\"#2-4使用LogMiner进行日志分析\" class=\"headerlink\" title=\"2.4使用LogMiner进行日志分析\"></a>2.4使用LogMiner进行日志分析</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">exec</span> dbms_logmnr<span class=\"token punctuation\">.</span>start_logmnr<span class=\"token punctuation\">(</span>DictFileName <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'/oracle/dict.ora'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">---无条件分析</span>\n<span class=\"token comment\" spellcheck=\"true\">//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',startscn=>123,endScn => 124); --有条件分析</span>\n<span class=\"token comment\" spellcheck=\"true\">//exec dbms_logmnr.start_logmnr(DictFileName => '/oracle/dict.ora',</span>\nstarttime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 00:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nendtime <span class=\"token operator\">=</span><span class=\"token operator\">></span> to_date<span class=\"token punctuation\">(</span><span class=\"token string\">'2016-08-15 01:00:00'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'YYYY-MM-DD HH24:MI:SS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--有条件分析：</span>\nscn: startscn<span class=\"token punctuation\">,</span>endScn\ntime: starttime<span class=\"token punctuation\">,</span>endtime\n</code></pre>\n<h3 id=\"2-5-查看logminer分析结果\"><a href=\"#2-5-查看logminer分析结果\" class=\"headerlink\" title=\"2.5 查看logminer分析结果\"></a>2.5 查看logminer分析结果</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span>scn<span class=\"token punctuation\">,</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>sql_redo<span class=\"token punctuation\">,</span>sql_undo <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">desc</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n名称 类型\n<span class=\"token comment\" spellcheck=\"true\">----------------------------------------- ----------------------------</span>\n<span class=\"token keyword\">TIMESTAMP</span> <span class=\"token keyword\">DATE</span> <span class=\"token comment\" spellcheck=\"true\">//SQL执行时间</span>\nCOMMIT_TIMESTAMP <span class=\"token keyword\">DATE</span> <span class=\"token comment\" spellcheck=\"true\">//事务提交时间</span>\nSEG_OWNER VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//被修改对象创建者</span>\nSEG_NAME VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//被修改对象的名字，如表名</span>\nSEG_TYPE NUMBER <span class=\"token comment\" spellcheck=\"true\">//被修改对象类型</span>\nSEG_TYPE_NAME VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//被修改对象类型名</span>\nTABLE_SPACE VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//被修改对象所属表空间</span>\nROW_ID VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">19</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//被修改行的ROWID，如果</span>\n<span class=\"token keyword\">SESSION</span><span class=\"token comment\" spellcheck=\"true\"># NUMBER //执行修改的SESSION号</span>\n<span class=\"token keyword\">SERIAL</span><span class=\"token comment\" spellcheck=\"true\"># NUMBER //执行修改的SESSION序号</span>\nUSERNAME VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//执行事务的用户名</span>\nSESSION_INFO VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//执行修改的SESSION信息,例如：login_username= client_info= OS_username=SYSTEM Machine_name=ZFMISERVER OS_termi</span>\nnal<span class=\"token operator\">=</span>ZFMISERVER OS_process_id<span class=\"token operator\">=</span><span class=\"token number\">1812</span> OS_program name<span class=\"token operator\">=</span>ORACLE<span class=\"token punctuation\">.</span>EXE\nTX_NAME VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//执行的事务名，当该事务被命名时</span>\n<span class=\"token keyword\">ROLLBACK</span> NUMBER <span class=\"token comment\" spellcheck=\"true\">//回滚标记</span>\nOPERATION VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//操作类型</span>\n<span class=\"token keyword\">INSERT</span>\n<span class=\"token keyword\">UPDATE</span>\n<span class=\"token keyword\">DELETE</span>\nDDL\n<span class=\"token keyword\">START</span>\n<span class=\"token keyword\">COMMIT</span>\n<span class=\"token keyword\">ROLLBACK</span>\nLOB_WRITE\nLOB_TRIM\nLOB_ERASE\nSELECT_FOR_UPDATE\nSEL_LOB_LOCATOR\nMISSING_SCN\nINTERNAL\nUNSUPPORTED\nOPERATION_CODE NUMBER <span class=\"token comment\" spellcheck=\"true\">//操作类型代码</span>\n    <span class=\"token number\">0</span> <span class=\"token operator\">=</span> INTERNAL\n    <span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">INSERT</span>\n    <span class=\"token number\">2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">DELETE</span>\n    <span class=\"token number\">3</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">UPDATE</span>\n    <span class=\"token number\">5</span> <span class=\"token operator\">=</span> DDL\n    <span class=\"token number\">6</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">START</span>\n    <span class=\"token number\">7</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">COMMIT</span>\n    <span class=\"token number\">9</span> <span class=\"token operator\">=</span> SELECT_LOB_LOCATOR\n    <span class=\"token number\">10</span> <span class=\"token operator\">=</span> LOB_WRITE\n    <span class=\"token number\">11</span> <span class=\"token operator\">=</span> LOB_TRIM\n    <span class=\"token number\">25</span> <span class=\"token operator\">=</span> SELECT_FOR_UPDATE\n    <span class=\"token number\">28</span> <span class=\"token operator\">=</span> LOB_ERASE\n    <span class=\"token number\">34</span> <span class=\"token operator\">=</span> MISSING_SCN\n    <span class=\"token number\">36</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">ROLLBACK</span>\n    <span class=\"token number\">255</span> <span class=\"token operator\">=</span> UNSUPPORTED\nSQL_REDO VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//重做日志SQL</span>\nSQL_UNDO VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//相反操作SQL</span>\nSEQUENCE<span class=\"token comment\" spellcheck=\"true\"># NUMBER //重做日志的序号</span>\n</code></pre>\n<h2 id=\"3-logminer日志挖掘案例1-分析生产系统表数据丢失的原因\"><a href=\"#3-logminer日志挖掘案例1-分析生产系统表数据丢失的原因\" class=\"headerlink\" title=\"3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因\"></a>3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--3.1 安装logminer</span>\n<span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslm<span class=\"token punctuation\">.</span>sql\n<span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslmd<span class=\"token punctuation\">.</span>sql\n<span class=\"token variable\">@$ORACLE_HOME</span><span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>dbmslms<span class=\"token punctuation\">.</span>sql\n<span class=\"token comment\" spellcheck=\"true\">--3.2、使用LogMiner字典到字典文件来分析DDL操作</span>\n<span class=\"token comment\" spellcheck=\"true\">--01.提取logminer字典</span>\n<span class=\"token comment\" spellcheck=\"true\">--设置一个字典文件路径：</span>\n<span class=\"token keyword\">show</span> parameter utl_file_dir <span class=\"token comment\" spellcheck=\"true\">--需要重启DB</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> utl_file_dir<span class=\"token operator\">=</span><span class=\"token string\">'/u01'</span> scope<span class=\"token operator\">=</span>spfile<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--创建一个数据字典文件</span>\n<span class=\"token keyword\">exec</span> dbms_logmnr_d<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span><span class=\"token string\">'dict.ora'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/u01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--02.建立日志分析列表</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_42_f7043xy4_.arc'</span><span class=\"token punctuation\">,</span>options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">execute</span> dbms_logmnr<span class=\"token punctuation\">.</span>add_logfile<span class=\"token punctuation\">(</span>logfilename<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_41_f7043xtq_.arc'</span><span class=\"token punctuation\">,</span>options<span class=\"token operator\">=</span><span class=\"token operator\">></span>dbms_logmnr<span class=\"token punctuation\">.</span>addfile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--03.启动分析</span>\n<span class=\"token keyword\">exec</span> dbms_logmnr<span class=\"token punctuation\">.</span>start_logmnr<span class=\"token punctuation\">(</span>DictFileName <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'/u01/dict.ora'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--04.查看日志分析结果</span>\n<span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span>scn<span class=\"token punctuation\">,</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>sql_redo<span class=\"token punctuation\">,</span>sql_undo <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test01<span class=\"token punctuation\">.</span>logmnr_temp nologging <span class=\"token keyword\">as</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$logmnr_contents<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> itpux01<span class=\"token punctuation\">.</span>logmnr_temp <span class=\"token keyword\">where</span> seg_owner<span class=\"token operator\">=</span><span class=\"token string\">'test01'</span> <span class=\"token operator\">and</span> seg_name<span class=\"token operator\">=</span><span class=\"token string\">'TEST01'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> itpux01<span class=\"token punctuation\">.</span>logmnr_temp <span class=\"token keyword\">where</span> seg_owner<span class=\"token operator\">=</span><span class=\"token string\">'test01'</span> <span class=\"token operator\">and</span> seg_name<span class=\"token operator\">=</span><span class=\"token string\">'TEST01'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--05.结束分析</span>\n<span class=\"token keyword\">exec</span> dbms_logmnr<span class=\"token punctuation\">.</span>end_logmnr<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"4-logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\"><a href=\"#4-logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\" class=\"headerlink\" title=\"4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\"></a>4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失</h2><h2 id=\"5-logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\"><a href=\"#5-logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\" class=\"headerlink\" title=\"5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\"></a>5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复</h2><h2 id=\"6-logminer使用总结\"><a href=\"#6-logminer使用总结\" class=\"headerlink\" title=\"6.logminer使用总结\"></a>6.logminer使用总结</h2>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-LogMiner日志挖掘技术部分日志\"><a href=\"#Oracle-LogMiner日志挖掘技术部分日志\" class=\"headerlink\" title=\"Oracle LogMiner日志挖掘技术部分日志\"></a>Oracle LogMiner日志挖掘技术部分日志</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-Logminer相关概念\"><a href=\"#1-Logminer相关概念\" class=\"headerlink\" title=\"1.Logminer相关概念\"></a>1.Logminer相关概念</h2><h2 id=\"2-Logminer使用详解\"><a href=\"#2-Logminer使用详解\" class=\"headerlink\" title=\"2.Logminer使用详解\"></a>2.Logminer使用详解</h2><h3 id=\"2-1-安装logminer\"><a href=\"#2-1-安装logminer\" class=\"headerlink\" title=\"2.1 安装logminer\"></a>2.1 安装logminer</h3><pre><code class=\"sql\">$ORACLE_HOME/rdbms/admin/dbmslm.sql : DBMS_LOGMNR\n$ORACLE_HOME/rdbms/admin/dbmslmd.sql :DBMS_LOGMNR_D\n$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--过程\ndbms_logmnr_d.build(&#39;dict.ora&#39;,&#39;/u01&#39;) --创建一个数据字典文件\ndbms_logmnr.add_logfile\ndbms_logmnr.start_logmnr\ndbms_logmnr.end_logmnr\n--视图\nselect * from v$logmnr_dictionary;\nselect * from v$logmnr_logs;\nselect * from v$logmnr_contents;\n</code></pre>\n<h3 id=\"2-2-使用源数据库的数据字典（Online-catalog-来分析DML操作\"><a href=\"#2-2-使用源数据库的数据字典（Online-catalog-来分析DML操作\" class=\"headerlink\" title=\"2.2  使用源数据库的数据字典（Online catalog)来分析DML操作\"></a>2.2  使用源数据库的数据字典（Online catalog)来分析DML操作</h3><pre><code class=\"sql\">--01.开启补充日志\nselect SUPPLEMENTAL_LOG_DATA_MIN from v$database;\nalter database add supplemental log data;\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile(&#39;日志文件&#39;，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=&gt;&#39;日志文件&#39;)\n--03.启动分析\nexecute dbms_logmnr.start_logmnr(Options =&gt; dbms_logmnr.dict_from_online_catalog)\n//execute dbms_logmnr.start_logmnr(Options =&gt; dbms_logmnr.dict_from_online_catalog,startscn=&gt;123,endScn =&gt; 124);\n//exec dbms_logmnr.start_logmnr(Options =&gt; dbms_logmnr.dict_from_online_catalog,\nstarttime =&gt; to_date(&#39;2016-08-15 00:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;),\nendtime =&gt; to_date(&#39;2016-08-15 01:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;);\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n</code></pre>\n<h3 id=\"2-3-使用LogMiner字典到字典文件来分析DDL操作\"><a href=\"#2-3-使用LogMiner字典到字典文件来分析DDL操作\" class=\"headerlink\" title=\"2.3 使用LogMiner字典到字典文件来分析DDL操作\"></a>2.3 使用LogMiner字典到字典文件来分析DDL操作</h3><pre><code class=\"sql\">--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir=&#39;/oracle&#39; scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build(&#39;dict.ora&#39;,&#39;/oracle&#39;);\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.new)\n--继续添加\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.addfile)\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;日志文件&#39;，options=&gt;dbms_logmnr.addfile)\n//execute dbms_logmnr.add_logfile(&#39;日志文件&#39;，dbms_logmnr.addfile)\n--移除\nexecute dbms_logmnr.remove_logfile(logfilename=&gt;&#39;日志文件&#39;)\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;);---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;,startscn=&gt;123,endScn =&gt; 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;,\nstarttime =&gt; to_date(&#39;2016-08-15 00:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;),\nendtime =&gt; to_date(&#39;2016-08-15 01:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;);\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\n--05.结束分析\ndbms_logmnr.end_logmnr;\n</code></pre>\n<h3 id=\"2-4使用LogMiner进行日志分析\"><a href=\"#2-4使用LogMiner进行日志分析\" class=\"headerlink\" title=\"2.4使用LogMiner进行日志分析\"></a>2.4使用LogMiner进行日志分析</h3><pre><code class=\"sql\">exec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;);---无条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;,startscn=&gt;123,endScn =&gt; 124); --有条件分析\n//exec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/oracle/dict.ora&#39;,\nstarttime =&gt; to_date(&#39;2016-08-15 00:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;),\nendtime =&gt; to_date(&#39;2016-08-15 01:00:00&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;);\n--有条件分析：\nscn: startscn,endScn\ntime: starttime,endtime\n</code></pre>\n<h3 id=\"2-5-查看logminer分析结果\"><a href=\"#2-5-查看logminer分析结果\" class=\"headerlink\" title=\"2.5 查看logminer分析结果\"></a>2.5 查看logminer分析结果</h3><pre><code class=\"sql\">select username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\nSQL&gt; desc v$logmnr_contents;\n名称 类型\n----------------------------------------- ----------------------------\nTIMESTAMP DATE //SQL执行时间\nCOMMIT_TIMESTAMP DATE //事务提交时间\nSEG_OWNER VARCHAR2(32) //被修改对象创建者\nSEG_NAME VARCHAR2(256) //被修改对象的名字，如表名\nSEG_TYPE NUMBER //被修改对象类型\nSEG_TYPE_NAME VARCHAR2(32) //被修改对象类型名\nTABLE_SPACE VARCHAR2(32) //被修改对象所属表空间\nROW_ID VARCHAR2(19) //被修改行的ROWID，如果\nSESSION# NUMBER //执行修改的SESSION号\nSERIAL# NUMBER //执行修改的SESSION序号\nUSERNAME VARCHAR2(30) //执行事务的用户名\nSESSION_INFO VARCHAR2(4000) //执行修改的SESSION信息,例如：login_username= client_info= OS_username=SYSTEM Machine_name=ZFMISERVER OS_termi\nnal=ZFMISERVER OS_process_id=1812 OS_program name=ORACLE.EXE\nTX_NAME VARCHAR2(256) //执行的事务名，当该事务被命名时\nROLLBACK NUMBER //回滚标记\nOPERATION VARCHAR2(32) //操作类型\nINSERT\nUPDATE\nDELETE\nDDL\nSTART\nCOMMIT\nROLLBACK\nLOB_WRITE\nLOB_TRIM\nLOB_ERASE\nSELECT_FOR_UPDATE\nSEL_LOB_LOCATOR\nMISSING_SCN\nINTERNAL\nUNSUPPORTED\nOPERATION_CODE NUMBER //操作类型代码\n    0 = INTERNAL\n    1 = INSERT\n    2 = DELETE\n    3 = UPDATE\n    5 = DDL\n    6 = START\n    7 = COMMIT\n    9 = SELECT_LOB_LOCATOR\n    10 = LOB_WRITE\n    11 = LOB_TRIM\n    25 = SELECT_FOR_UPDATE\n    28 = LOB_ERASE\n    34 = MISSING_SCN\n    36 = ROLLBACK\n    255 = UNSUPPORTED\nSQL_REDO VARCHAR2(4000) //重做日志SQL\nSQL_UNDO VARCHAR2(4000) //相反操作SQL\nSEQUENCE# NUMBER //重做日志的序号\n</code></pre>\n<h2 id=\"3-logminer日志挖掘案例1-分析生产系统表数据丢失的原因\"><a href=\"#3-logminer日志挖掘案例1-分析生产系统表数据丢失的原因\" class=\"headerlink\" title=\"3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因\"></a>3.logminer日志挖掘案例1-分析生产系统表数据丢失的原因</h2><pre><code class=\"sql\">--3.1 安装logminer\n@$ORACLE_HOME/rdbms/admin/dbmslm.sql\n@$ORACLE_HOME/rdbms/admin/dbmslmd.sql\n@$ORACLE_HOME/rdbms/admin/dbmslms.sql\n--3.2、使用LogMiner字典到字典文件来分析DDL操作\n--01.提取logminer字典\n--设置一个字典文件路径：\nshow parameter utl_file_dir --需要重启DB\nalter system set utl_file_dir=&#39;/u01&#39; scope=spfile;\n--创建一个数据字典文件\nexec dbms_logmnr_d.build(&#39;dict.ora&#39;,&#39;/u01&#39;);\n--02.建立日志分析列表\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_42_f7043xy4_.arc&#39;,options=&gt;dbms_logmnr.new);\nexecute dbms_logmnr.add_logfile(logfilename=&gt;&#39;/u01/fast_recovery_area/ORCL/archivelog/2018_01_30/o1_mf_1_41_f7043xtq_.arc&#39;,options=&gt;dbms_logmnr.addfile);\n--03.启动分析\nexec dbms_logmnr.start_logmnr(DictFileName =&gt; &#39;/u01/dict.ora&#39;);\n--04.查看日志分析结果\nselect username,scn,timestamp,sql_redo,sql_undo from v$logmnr_contents;\ncreate table test01.logmnr_temp nologging as select * from v$logmnr_contents;\nselect * from itpux01.logmnr_temp where seg_owner=&#39;test01&#39; and seg_name=&#39;TEST01&#39;;\nselect * from itpux01.logmnr_temp where seg_owner=&#39;test01&#39; and seg_name=&#39;TEST01&#39;;\n--05.结束分析\nexec dbms_logmnr.end_logmnr;\n\n</code></pre>\n<h2 id=\"4-logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\"><a href=\"#4-logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\" class=\"headerlink\" title=\"4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失\"></a>4.logminer日志挖掘案例2-恢复DML误操作导致的表数据丢失</h2><h2 id=\"5-logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\"><a href=\"#5-logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\" class=\"headerlink\" title=\"5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复\"></a>5.logminer日志挖掘案例3-RMAN表空间基于时间点的自动恢复</h2><h2 id=\"6-logminer使用总结\"><a href=\"#6-logminer使用总结\" class=\"headerlink\" title=\"6.logminer使用总结\"></a>6.logminer使用总结</h2>"},{"title":"Oracle Rman 备份3","date":"2018-10-04T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle Rman 的备份 （高级）\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.关于RMAN内存缓冲与块跟踪\n```sql\n## 6.使用RMAN的dbms_backup_restore包\n```\n* 查看RMAN 备份进程\n\n```sql\nselect sid,serial#,context,sofar,totalwork,round(sofar/totalwork*100,2) \"%_COMPLETE\"\n     from v$session_longops\n    where opname like 'RMAN%'\n     AND OPNAME NOT LIKE '%aggregate%'\n     and totalwork != 0\n     and sofar <>totalwork;\n```\n\n## 2.使用RMAN的dbms_backup_restore包\n* 1.恢复controlfile\n\n> dbms_backup_restore包是一个非常强大的package，可以在数据库nomount下使用，用于从RMAN备份集中读取各类文件。\n\n```sql\nDECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=>'',ident=>'t1');\n    sys.dbms_backup_restore.restoreSetDatafile;\n    sys.dbms_backup_restore.restoreControlfileTo(cfname=>'/backup/test/control01.ctl');\n    sys.dbms_backup_restore.restoreBackupPiece(done=>done,handle=>'/backup/full/itpux19_ctl_db01_3_1_919281645',params=>null);\n    sys.dbms_backup_restore.deviceDeallocate;\n   END;\n/ \n```\n\n* 2.恢复数据文件\n\n```sql\nselect 'sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>' || file# ||\n       ',toname=>' ||chr(39)|| name ||chr(39) || ');',\n       'sys.dbms_backup_restore.applySetDatafile(dfnumber=>' || file# ||\n       ',toname=>' ||chr(39)|| name ||chr(39) || ');'\n  from v$datafile; \n  \n \n DECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=>'',ident=>'t1');\n\t  sys.dbms_backup_restore.restoreSetDatafile;\n\t  sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>1,toname=>'/backup/test/system01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>2,toname=>'/backup/test/sysaux01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>3,toname=>'/backup/test/undotbs01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>4,toname=>'/backup/test/users01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>5,toname=>'/backup/test/example01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>6,toname=>'/backup/test/scdata01.ora');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>7,toname=>'/backup/test/rman.dbf');\n    sys.dbms_backup_restore.restoreBackupPiece(done=>done,handle=>'/backup/full/itpux19_full_db01_1_1_919278149', params=>null);\n    sys.dbms_backup_restore.deviceDeallocate;\n END;\n /\n\n```\n\n* 3.恢复归档日志文件\n\n```sql\n---从备份集中还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =>'',ident => 't1');\ndbms_backup_restore.RestoreSetArchivedLog(destination=>'/backu/test/archive');   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLog(thread =>1 ,sequence =>9);   --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done => done,handle =>'/oracle/full/itpux19_pfile_db01_4_1_919281649', params => null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n\n---从备份集中按scn范围还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =>'',ident => 't1');\ndbms_backup_restore.RestoreSetArchivedLog(destination=>'/backu/test/archive');   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLogRange(log_change =>1125933 ,high_change =>1126275);  --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done => done,handle =>'/oracle/full/itpux19_pfile_db01_4_1_919281649', params => null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n```\n\n\n## 3.使用RMAN的BlockRecovery恢复坏块\n## 4. Oracle RMAN Recovery Advisor案列\n## 5.RMAN 备份压缩案列\n### 5.1修改参数开启/关闭备份压缩\n* 1.开启备份压缩\n\n```sql\n--使用COMPRESSED启用RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO COMPRESSED BACKUPSET;\n```\n\n* 2.关闭备份压缩\n\n```sql\n--取消COMPRESSED取消RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO BACKUPSET;\n```\n### 5.2直接使用命令开启/取消备份压缩\n```sql\n--对整个数据库压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATABASE PLUS ARCHIVELOG;\n--对指定数据文件压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATAFILE 1,3,4;\n```\n\n## 6.RMAN 增量备份与恢复\n## 7.RMAN 备份的加密\n## 8. RMAN 克隆数据库测试\n## 9.生产环境 RMAN 异机恢复场景\n## 10.FlashBack\n\n* 要求\n\n```sql\n1.版本大于等于10.2\n2.数据必须开启归档\n3.数据必须配置Flash recovery\n4.\n5.没有特殊要求就正常闪回\n```\n* 基本步骤\n\n```sql\n1.关闭数据库\n2.startup mount[exclusive模式]\n3.闪回  时间/SCN/还原点\n4.open resetlogs/**;\n4.1 打开有2种方法\n\t1.open resetlog 方法，整个数据库都都恢复到丢表之前的状态（假如丢表之后对其他表进行了某些操作也将丢失）\n\t2.open read only 只读打开，导标，完全恢复，在导入丢失的表。\n\t也可以先把备份放到其他的数据库恢复后把丢失的表导入的目标数据库\n```\n\n* 具体操作\n\n```sql\n\n--SQLPLUS\nflashback database <db_name> to scn <scn>   --scn \nflashback database <db_name> to timestamp <timestamp> --time\nflashback database to restore point <point_name> --restore point\n\n--RMAN\nflashback database to scn=<scn> --scn\nflashback database to time=\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\"; --time\nflashback database to sequence=88 thread=1; --sequence\n```\n\n### 10.1.基于SCN的闪回\n```sql\n\nSQL> select current_scn from v$database;\n\nCURRENT_SCN\n-----------\n    1349018\n\nSQL> select * from v$flashback_database_log;\n\nOLDEST_FLASHBACK_SCN OLDEST_FLASHBACK_TI RETENTION_TARGET FLASHBACK_SIZE\n-------------------- ------------------- ---------------- --------------\nESTIMATED_FLASHBACK_SIZE\n------------------------\n             1345507 2018-01-30 13:18:09             1440      104857600\n               327008256\n14:13:37 SQL> select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n14:13:47 SQL> delete from test where id=7;\n\n1 row deleted.\n\n14:14:06 SQL> commit;\n\nCommit complete.\n\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> flashback database orcl to scn   1349018;\n\n```\n\n### 10.2.基于时间的闪回\n* 步骤\n\n```sql\n1.数据库启动到MOUNT，恢复到制定时间点\n2.把数据的打开导只读模式\n3.把表导出\n4.重启数据库到MOUNT后恢复数据库到最新\n4.正常打开后导入表\n```\n* 操作\n\n```sql\nSQL> set time on\n15:00:12 SQL> select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:17 SQL> create table test01 as select * from test;\n\nTable created.\n\n15:00:41 SQL> select * from test01;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:48 SQL> commit;\n\nCommit complete.\n\n15:00:57 SQL> drop table test01;\n\nTable dropped.\n\n15:01:10 SQL> drop table test;\n\nTable dropped.\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\n\nRMAN> flashback database to time=\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\";\n\nStarting flashback at 2018-01-30 15:04:25\nusing channel ORA_DISK_1\n\n\nstarting media recovery\nmedia recovery complete, elapsed time: 00:00:07\n\nFinished flashback at 2018-01-30 15:04:32\n\nSQL> alter database open read only;\n\nDatabase altered.\n\n[oracle@orcl:/u01]$exp anonycurse/jia tables=test01 file=/u01/test01.dmp log=/u01/test01.log \n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 15:22:07 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n  \n\nConnected to: Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nExport done in ZHS16GBK character set and UTF8 NCHAR character set\n\nAbout to export specified tables via Conventional Path ...\n. . exporting table                         TEST01          7 rows exported\nExport terminated successfully without warnings.\n\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> recovery database;\nSP2-0734: unknown command beginning \"recovery d...\" - rest of line ignored.\nSQL> recover database;\nMedia recovery complete.\n\n```\n\n### 10.4 Restore point in Oracle（Normal）\n* 基本使用\n\n```sql\n--1.创建还原点\ncreate restore point test_normal;\n--2.查看还原点\nselect name,time,storage_size from v$restore_point;\n--3.删除还原点\ndrop restore point test_normal;\n\n```\n\n* 步骤\n\n```sql\n1.创建还原点\n2.执行某操作后需要还原\n3.执行还原\n4.OPEN RESETLOGS打开数据库\n5.删除还原点\n```\n\n* 操作\n\n```sql\nSQL> create restore point test_normal;\n\nRestore point created.\n\nSQL> select name,time,storage_size from v$restore_point;\n\nNAME\n--------------------------------------------------------------------------------\nTIME\n---------------------------------------------------------------------------\nSTORAGE_SIZE\n------------\nTEST_NORMAL\n30-JAN-18 03.46.27.000000000 PM\n           0\n\t\t   \n\nSQL> select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\nSQL> drop table test01 purge;\n\nTable dropped.\n\nSQL> shutdown immediate\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> flashback database to restore point test_normal;\n\nFlashback complete.\n\nSQL> alter database open  resetlogs;\n\nDatabase altered.\n\n\nSQL> select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\n```\n\n### 10.5 Restore point in Oracle（Guaranteed）\n* 基本使用\n\n```sql\n--1.创建还原点\ncreate restore point test_guaranteed Guarantee flashback database;\n--2.\n--3.\n\n```\n* 步骤\n\n```sql\n和Normal基本一致\n```\n\n* 操作\n\n```sql\nflashback database to restore point test_guaranteed;\n\n```\n\n## 10.3 日常监控\n```sql\n--1.监控flashback\nSELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nSELECT * FROM V$RECOVERY_FILE_DEST;\n\n--2.清理空间\nrm datafile.dbf\n\nRMAN>\ncrosscheck backup;\ncrosscheck archivelog all;\ndelete expired backup;\ndelete expired archivelog all;\ndelete force obsolete;\n\n--3.闪回点清理\nSELECT * FROM v$resore_point;\ndrop restore point <point_name>;\n\n--4.相关视图\nSELECT * FROM DICTIONARY WHERE table_name like '%FLASH%';\n\nv$database  \n\tSELECT FLASHBACK_ON FROM v$database;\nv$flashback_database_log\n\tSELECT * FROM v$flashback_database_log;\nv$flashback_database_stat\n    SELECT * FROM v$flashback_database_stat;\nV$FLASH_RECOVERY_AREA_USAGE\n    SELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nV$RECOVERY_FILE_DEST\n    SELECT * FROM V$RECOVERY_FILE_DEST;\n\n```\n\n## 11.回收站管理\n```sql\nSELECT * FROM dba_recyclebin;\ndrop table test purge; \n--清空回收站\npurge dba_recyclebin;\t--All User\npurge recyclebin;\t--Current User\ndrop table test purge;\t--Skip\n\npurge tablespace tbs_name;\npurge tablespace tbs_name user user_name;\npurge index BIN$Y/nEtmKPVY3gUwEAAH92GA==$0;\n\n--回收站还原表\n--FlashBack\nflash table \"BIN$Y/nEtmKPVY3gUwEAAH92GA==$0\" to before drop;\nflashback table test to before drop;\nflashback table test before drop rename to test-new;\n\n--Change Name\nSELECT table_name,table_owner,indedx_name from dba_indexes WHERE table_owner='anonycurse';\nSELECT table_name,constraint_name from dba_constraints WHERE table_name='test01';\n\nalter table test01 rename constraint \"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\"  rename to test_id_pk;\nalter index \"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\" rename to test_pk;\n\n```","source":"_posts/oracle/Oracle Rman 备份3.md","raw":"---\ntitle: Oracle Rman 备份3\ndate: 2018-10-04 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - RMAN\n---\n\n\n# Oracle Rman 的备份 （高级）\n\n[Oracle 11G R2 官方文档][1] \n\n## 1.关于RMAN内存缓冲与块跟踪\n```sql\n## 6.使用RMAN的dbms_backup_restore包\n```\n* 查看RMAN 备份进程\n\n```sql\nselect sid,serial#,context,sofar,totalwork,round(sofar/totalwork*100,2) \"%_COMPLETE\"\n     from v$session_longops\n    where opname like 'RMAN%'\n     AND OPNAME NOT LIKE '%aggregate%'\n     and totalwork != 0\n     and sofar <>totalwork;\n```\n\n## 2.使用RMAN的dbms_backup_restore包\n* 1.恢复controlfile\n\n> dbms_backup_restore包是一个非常强大的package，可以在数据库nomount下使用，用于从RMAN备份集中读取各类文件。\n\n```sql\nDECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=>'',ident=>'t1');\n    sys.dbms_backup_restore.restoreSetDatafile;\n    sys.dbms_backup_restore.restoreControlfileTo(cfname=>'/backup/test/control01.ctl');\n    sys.dbms_backup_restore.restoreBackupPiece(done=>done,handle=>'/backup/full/itpux19_ctl_db01_3_1_919281645',params=>null);\n    sys.dbms_backup_restore.deviceDeallocate;\n   END;\n/ \n```\n\n* 2.恢复数据文件\n\n```sql\nselect 'sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>' || file# ||\n       ',toname=>' ||chr(39)|| name ||chr(39) || ');',\n       'sys.dbms_backup_restore.applySetDatafile(dfnumber=>' || file# ||\n       ',toname=>' ||chr(39)|| name ||chr(39) || ');'\n  from v$datafile; \n  \n \n DECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=>'',ident=>'t1');\n\t  sys.dbms_backup_restore.restoreSetDatafile;\n\t  sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>1,toname=>'/backup/test/system01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>2,toname=>'/backup/test/sysaux01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>3,toname=>'/backup/test/undotbs01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>4,toname=>'/backup/test/users01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>5,toname=>'/backup/test/example01.dbf');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>6,toname=>'/backup/test/scdata01.ora');\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>7,toname=>'/backup/test/rman.dbf');\n    sys.dbms_backup_restore.restoreBackupPiece(done=>done,handle=>'/backup/full/itpux19_full_db01_1_1_919278149', params=>null);\n    sys.dbms_backup_restore.deviceDeallocate;\n END;\n /\n\n```\n\n* 3.恢复归档日志文件\n\n```sql\n---从备份集中还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =>'',ident => 't1');\ndbms_backup_restore.RestoreSetArchivedLog(destination=>'/backu/test/archive');   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLog(thread =>1 ,sequence =>9);   --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done => done,handle =>'/oracle/full/itpux19_pfile_db01_4_1_919281649', params => null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n\n---从备份集中按scn范围还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =>'',ident => 't1');\ndbms_backup_restore.RestoreSetArchivedLog(destination=>'/backu/test/archive');   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLogRange(log_change =>1125933 ,high_change =>1126275);  --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done => done,handle =>'/oracle/full/itpux19_pfile_db01_4_1_919281649', params => null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n```\n\n\n## 3.使用RMAN的BlockRecovery恢复坏块\n## 4. Oracle RMAN Recovery Advisor案列\n## 5.RMAN 备份压缩案列\n### 5.1修改参数开启/关闭备份压缩\n* 1.开启备份压缩\n\n```sql\n--使用COMPRESSED启用RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO COMPRESSED BACKUPSET;\n```\n\n* 2.关闭备份压缩\n\n```sql\n--取消COMPRESSED取消RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO BACKUPSET;\n```\n### 5.2直接使用命令开启/取消备份压缩\n```sql\n--对整个数据库压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATABASE PLUS ARCHIVELOG;\n--对指定数据文件压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATAFILE 1,3,4;\n```\n\n## 6.RMAN 增量备份与恢复\n## 7.RMAN 备份的加密\n## 8. RMAN 克隆数据库测试\n## 9.生产环境 RMAN 异机恢复场景\n## 10.FlashBack\n\n* 要求\n\n```sql\n1.版本大于等于10.2\n2.数据必须开启归档\n3.数据必须配置Flash recovery\n4.\n5.没有特殊要求就正常闪回\n```\n* 基本步骤\n\n```sql\n1.关闭数据库\n2.startup mount[exclusive模式]\n3.闪回  时间/SCN/还原点\n4.open resetlogs/**;\n4.1 打开有2种方法\n\t1.open resetlog 方法，整个数据库都都恢复到丢表之前的状态（假如丢表之后对其他表进行了某些操作也将丢失）\n\t2.open read only 只读打开，导标，完全恢复，在导入丢失的表。\n\t也可以先把备份放到其他的数据库恢复后把丢失的表导入的目标数据库\n```\n\n* 具体操作\n\n```sql\n\n--SQLPLUS\nflashback database <db_name> to scn <scn>   --scn \nflashback database <db_name> to timestamp <timestamp> --time\nflashback database to restore point <point_name> --restore point\n\n--RMAN\nflashback database to scn=<scn> --scn\nflashback database to time=\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\"; --time\nflashback database to sequence=88 thread=1; --sequence\n```\n\n### 10.1.基于SCN的闪回\n```sql\n\nSQL> select current_scn from v$database;\n\nCURRENT_SCN\n-----------\n    1349018\n\nSQL> select * from v$flashback_database_log;\n\nOLDEST_FLASHBACK_SCN OLDEST_FLASHBACK_TI RETENTION_TARGET FLASHBACK_SIZE\n-------------------- ------------------- ---------------- --------------\nESTIMATED_FLASHBACK_SIZE\n------------------------\n             1345507 2018-01-30 13:18:09             1440      104857600\n               327008256\n14:13:37 SQL> select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n14:13:47 SQL> delete from test where id=7;\n\n1 row deleted.\n\n14:14:06 SQL> commit;\n\nCommit complete.\n\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> flashback database orcl to scn   1349018;\n\n```\n\n### 10.2.基于时间的闪回\n* 步骤\n\n```sql\n1.数据库启动到MOUNT，恢复到制定时间点\n2.把数据的打开导只读模式\n3.把表导出\n4.重启数据库到MOUNT后恢复数据库到最新\n4.正常打开后导入表\n```\n* 操作\n\n```sql\nSQL> set time on\n15:00:12 SQL> select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:17 SQL> create table test01 as select * from test;\n\nTable created.\n\n15:00:41 SQL> select * from test01;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:48 SQL> commit;\n\nCommit complete.\n\n15:00:57 SQL> drop table test01;\n\nTable dropped.\n\n15:01:10 SQL> drop table test;\n\nTable dropped.\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\n\nRMAN> flashback database to time=\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\";\n\nStarting flashback at 2018-01-30 15:04:25\nusing channel ORA_DISK_1\n\n\nstarting media recovery\nmedia recovery complete, elapsed time: 00:00:07\n\nFinished flashback at 2018-01-30 15:04:32\n\nSQL> alter database open read only;\n\nDatabase altered.\n\n[oracle@orcl:/u01]$exp anonycurse/jia tables=test01 file=/u01/test01.dmp log=/u01/test01.log \n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 15:22:07 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n  \n\nConnected to: Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nExport done in ZHS16GBK character set and UTF8 NCHAR character set\n\nAbout to export specified tables via Conventional Path ...\n. . exporting table                         TEST01          7 rows exported\nExport terminated successfully without warnings.\n\n\nSQL> shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> recovery database;\nSP2-0734: unknown command beginning \"recovery d...\" - rest of line ignored.\nSQL> recover database;\nMedia recovery complete.\n\n```\n\n### 10.4 Restore point in Oracle（Normal）\n* 基本使用\n\n```sql\n--1.创建还原点\ncreate restore point test_normal;\n--2.查看还原点\nselect name,time,storage_size from v$restore_point;\n--3.删除还原点\ndrop restore point test_normal;\n\n```\n\n* 步骤\n\n```sql\n1.创建还原点\n2.执行某操作后需要还原\n3.执行还原\n4.OPEN RESETLOGS打开数据库\n5.删除还原点\n```\n\n* 操作\n\n```sql\nSQL> create restore point test_normal;\n\nRestore point created.\n\nSQL> select name,time,storage_size from v$restore_point;\n\nNAME\n--------------------------------------------------------------------------------\nTIME\n---------------------------------------------------------------------------\nSTORAGE_SIZE\n------------\nTEST_NORMAL\n30-JAN-18 03.46.27.000000000 PM\n           0\n\t\t   \n\nSQL> select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\nSQL> drop table test01 purge;\n\nTable dropped.\n\nSQL> shutdown immediate\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL> startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL> flashback database to restore point test_normal;\n\nFlashback complete.\n\nSQL> alter database open  resetlogs;\n\nDatabase altered.\n\n\nSQL> select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\n```\n\n### 10.5 Restore point in Oracle（Guaranteed）\n* 基本使用\n\n```sql\n--1.创建还原点\ncreate restore point test_guaranteed Guarantee flashback database;\n--2.\n--3.\n\n```\n* 步骤\n\n```sql\n和Normal基本一致\n```\n\n* 操作\n\n```sql\nflashback database to restore point test_guaranteed;\n\n```\n\n## 10.3 日常监控\n```sql\n--1.监控flashback\nSELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nSELECT * FROM V$RECOVERY_FILE_DEST;\n\n--2.清理空间\nrm datafile.dbf\n\nRMAN>\ncrosscheck backup;\ncrosscheck archivelog all;\ndelete expired backup;\ndelete expired archivelog all;\ndelete force obsolete;\n\n--3.闪回点清理\nSELECT * FROM v$resore_point;\ndrop restore point <point_name>;\n\n--4.相关视图\nSELECT * FROM DICTIONARY WHERE table_name like '%FLASH%';\n\nv$database  \n\tSELECT FLASHBACK_ON FROM v$database;\nv$flashback_database_log\n\tSELECT * FROM v$flashback_database_log;\nv$flashback_database_stat\n    SELECT * FROM v$flashback_database_stat;\nV$FLASH_RECOVERY_AREA_USAGE\n    SELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nV$RECOVERY_FILE_DEST\n    SELECT * FROM V$RECOVERY_FILE_DEST;\n\n```\n\n## 11.回收站管理\n```sql\nSELECT * FROM dba_recyclebin;\ndrop table test purge; \n--清空回收站\npurge dba_recyclebin;\t--All User\npurge recyclebin;\t--Current User\ndrop table test purge;\t--Skip\n\npurge tablespace tbs_name;\npurge tablespace tbs_name user user_name;\npurge index BIN$Y/nEtmKPVY3gUwEAAH92GA==$0;\n\n--回收站还原表\n--FlashBack\nflash table \"BIN$Y/nEtmKPVY3gUwEAAH92GA==$0\" to before drop;\nflashback table test to before drop;\nflashback table test before drop rename to test-new;\n\n--Change Name\nSELECT table_name,table_owner,indedx_name from dba_indexes WHERE table_owner='anonycurse';\nSELECT table_name,constraint_name from dba_constraints WHERE table_name='test01';\n\nalter table test01 rename constraint \"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\"  rename to test_id_pk;\nalter index \"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\" rename to test_pk;\n\n```","slug":"oracle/Oracle Rman 备份3","published":1,"updated":"2019-05-03T16:04:06.081Z","_id":"cjv89lll5003fi0cdrdocs6sb","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-Rman-的备份-（高级）\"><a href=\"#Oracle-Rman-的备份-（高级）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （高级）\"></a>Oracle Rman 的备份 （高级）</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-关于RMAN内存缓冲与块跟踪\"><a href=\"#1-关于RMAN内存缓冲与块跟踪\" class=\"headerlink\" title=\"1.关于RMAN内存缓冲与块跟踪\"></a>1.关于RMAN内存缓冲与块跟踪</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">## 6.使用RMAN的dbms_backup_restore包</span>\n</code></pre>\n<ul>\n<li>查看RMAN 备份进程</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> sid<span class=\"token punctuation\">,</span><span class=\"token keyword\">serial</span><span class=\"token comment\" spellcheck=\"true\">#,context,sofar,totalwork,round(sofar/totalwork*100,2) \"%_COMPLETE\"</span>\n     <span class=\"token keyword\">from</span> v$session_longops\n    <span class=\"token keyword\">where</span> opname <span class=\"token operator\">like</span> <span class=\"token string\">'RMAN%'</span>\n     <span class=\"token operator\">AND</span> OPNAME <span class=\"token operator\">NOT</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%aggregate%'</span>\n     <span class=\"token operator\">and</span> totalwork <span class=\"token operator\">!=</span> <span class=\"token number\">0</span>\n     <span class=\"token operator\">and</span> sofar <span class=\"token operator\">&lt;></span>totalwork<span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"2-使用RMAN的dbms-backup-restore包\"><a href=\"#2-使用RMAN的dbms-backup-restore包\" class=\"headerlink\" title=\"2.使用RMAN的dbms_backup_restore包\"></a>2.使用RMAN的dbms_backup_restore包</h2><ul>\n<li>1.恢复controlfile</li>\n</ul>\n<blockquote>\n<p>dbms_backup_restore包是一个非常强大的package，可以在数据库nomount下使用，用于从RMAN备份集中读取各类文件。</p>\n</blockquote>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DECLARE</span>\n    devtype varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    done <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">BEGIN</span>\n    devtype:<span class=\"token operator\">=</span>sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>deviceAllocate <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>ident<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'t1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreSetDatafile<span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreControlfileTo<span class=\"token punctuation\">(</span>cfname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/control01.ctl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreBackupPiece<span class=\"token punctuation\">(</span>done<span class=\"token operator\">=</span><span class=\"token operator\">></span>done<span class=\"token punctuation\">,</span>handle<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/full/itpux19_ctl_db01_3_1_919281645'</span><span class=\"token punctuation\">,</span>params<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>deviceDeallocate<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">/</span> \n</code></pre>\n<ul>\n<li>2.恢复数据文件</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token string\">'sys.dbms_backup_restore.restoreDatafileTo(dfnumber=>'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">file</span><span class=\"token comment\" spellcheck=\"true\"># ||</span>\n       <span class=\"token string\">',toname=>'</span> <span class=\"token operator\">||</span>chr<span class=\"token punctuation\">(</span><span class=\"token number\">39</span><span class=\"token punctuation\">)</span><span class=\"token operator\">||</span> name <span class=\"token operator\">||</span>chr<span class=\"token punctuation\">(</span><span class=\"token number\">39</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">');'</span><span class=\"token punctuation\">,</span>\n       <span class=\"token string\">'sys.dbms_backup_restore.applySetDatafile(dfnumber=>'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">file</span><span class=\"token comment\" spellcheck=\"true\"># ||</span>\n       <span class=\"token string\">',toname=>'</span> <span class=\"token operator\">||</span>chr<span class=\"token punctuation\">(</span><span class=\"token number\">39</span><span class=\"token punctuation\">)</span><span class=\"token operator\">||</span> name <span class=\"token operator\">||</span>chr<span class=\"token punctuation\">(</span><span class=\"token number\">39</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">');'</span>\n  <span class=\"token keyword\">from</span> v$datafile<span class=\"token punctuation\">;</span> \n\n\n <span class=\"token keyword\">DECLARE</span>\n    devtype varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    done <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">BEGIN</span>\n    devtype:<span class=\"token operator\">=</span>sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>deviceAllocate <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>ident<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'t1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreSetDatafile<span class=\"token punctuation\">;</span>\n      sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/system01.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/sysaux01.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/undotbs01.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/users01.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/example01.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/scdata01.ora'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreDatafileTo<span class=\"token punctuation\">(</span>dfnumber<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span>toname<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/test/rman.dbf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>restoreBackupPiece<span class=\"token punctuation\">(</span>done<span class=\"token operator\">=</span><span class=\"token operator\">></span>done<span class=\"token punctuation\">,</span>handle<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backup/full/itpux19_full_db01_1_1_919278149'</span><span class=\"token punctuation\">,</span> params<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sys<span class=\"token punctuation\">.</span>dbms_backup_restore<span class=\"token punctuation\">.</span>deviceDeallocate<span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n <span class=\"token operator\">/</span>\n\n</code></pre>\n<ul>\n<li>3.恢复归档日志文件</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">---从备份集中还原归档日志</span>\n<span class=\"token keyword\">declare</span>\ndevtype varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndone <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">begin</span>\ndevtype :<span class=\"token operator\">=</span> dbms_backup_restore<span class=\"token punctuation\">.</span>DeviceAllocate <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>ident <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'t1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreSetArchivedLog<span class=\"token punctuation\">(</span>destination<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backu/test/archive'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">--设置恢复对话</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreArchivedLog<span class=\"token punctuation\">(</span>thread <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1</span> <span class=\"token punctuation\">,</span>sequence <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">--日志的线程号和日志号</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreBackupPiece<span class=\"token punctuation\">(</span>done <span class=\"token operator\">=</span><span class=\"token operator\">></span> done<span class=\"token punctuation\">,</span>handle <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/oracle/full/itpux19_pfile_db01_4_1_919281649'</span><span class=\"token punctuation\">,</span> params <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\" spellcheck=\"true\">--指定使用的备份集</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>DeviceDeallocate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">---从备份集中按scn范围还原归档日志</span>\n<span class=\"token keyword\">declare</span>\ndevtype varchar2<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndone <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">begin</span>\ndevtype :<span class=\"token operator\">=</span> dbms_backup_restore<span class=\"token punctuation\">.</span>DeviceAllocate <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>ident <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'t1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreSetArchivedLog<span class=\"token punctuation\">(</span>destination<span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/backu/test/archive'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">--设置恢复对话</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreArchivedLogRange<span class=\"token punctuation\">(</span>log_change <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1125933</span> <span class=\"token punctuation\">,</span>high_change <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1126275</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\" spellcheck=\"true\">--日志的线程号和日志号</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>RestoreBackupPiece<span class=\"token punctuation\">(</span>done <span class=\"token operator\">=</span><span class=\"token operator\">></span> done<span class=\"token punctuation\">,</span>handle <span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'/oracle/full/itpux19_pfile_db01_4_1_919281649'</span><span class=\"token punctuation\">,</span> params <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\" spellcheck=\"true\">--指定使用的备份集</span>\ndbms_backup_restore<span class=\"token punctuation\">.</span>DeviceDeallocate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"3-使用RMAN的BlockRecovery恢复坏块\"><a href=\"#3-使用RMAN的BlockRecovery恢复坏块\" class=\"headerlink\" title=\"3.使用RMAN的BlockRecovery恢复坏块\"></a>3.使用RMAN的BlockRecovery恢复坏块</h2><h2 id=\"4-Oracle-RMAN-Recovery-Advisor案列\"><a href=\"#4-Oracle-RMAN-Recovery-Advisor案列\" class=\"headerlink\" title=\"4. Oracle RMAN Recovery Advisor案列\"></a>4. Oracle RMAN Recovery Advisor案列</h2><h2 id=\"5-RMAN-备份压缩案列\"><a href=\"#5-RMAN-备份压缩案列\" class=\"headerlink\" title=\"5.RMAN 备份压缩案列\"></a>5.RMAN 备份压缩案列</h2><h3 id=\"5-1修改参数开启-关闭备份压缩\"><a href=\"#5-1修改参数开启-关闭备份压缩\" class=\"headerlink\" title=\"5.1修改参数开启/关闭备份压缩\"></a>5.1修改参数开启/关闭备份压缩</h3><ul>\n<li>1.开启备份压缩</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--使用COMPRESSED启用RMAN备份压缩</span>\nCONFIGURE DEVICE <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">DISK</span> <span class=\"token keyword\">BACKUP</span> <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">TO</span> COMPRESSED BACKUPSET<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>2.关闭备份压缩</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--取消COMPRESSED取消RMAN备份压缩</span>\nCONFIGURE DEVICE <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">DISK</span> <span class=\"token keyword\">BACKUP</span> <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">TO</span> BACKUPSET<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"5-2直接使用命令开启-取消备份压缩\"><a href=\"#5-2直接使用命令开启-取消备份压缩\" class=\"headerlink\" title=\"5.2直接使用命令开启/取消备份压缩\"></a>5.2直接使用命令开启/取消备份压缩</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--对整个数据库压缩备份</span>\n<span class=\"token keyword\">BACKUP</span> <span class=\"token keyword\">AS</span> COMPRESSED BACKUPSET <span class=\"token keyword\">DATABASE</span> PLUS ARCHIVELOG<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--对指定数据文件压缩备份</span>\n<span class=\"token keyword\">BACKUP</span> <span class=\"token keyword\">AS</span> COMPRESSED BACKUPSET DATAFILE <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"6-RMAN-增量备份与恢复\"><a href=\"#6-RMAN-增量备份与恢复\" class=\"headerlink\" title=\"6.RMAN 增量备份与恢复\"></a>6.RMAN 增量备份与恢复</h2><h2 id=\"7-RMAN-备份的加密\"><a href=\"#7-RMAN-备份的加密\" class=\"headerlink\" title=\"7.RMAN 备份的加密\"></a>7.RMAN 备份的加密</h2><h2 id=\"8-RMAN-克隆数据库测试\"><a href=\"#8-RMAN-克隆数据库测试\" class=\"headerlink\" title=\"8. RMAN 克隆数据库测试\"></a>8. RMAN 克隆数据库测试</h2><h2 id=\"9-生产环境-RMAN-异机恢复场景\"><a href=\"#9-生产环境-RMAN-异机恢复场景\" class=\"headerlink\" title=\"9.生产环境 RMAN 异机恢复场景\"></a>9.生产环境 RMAN 异机恢复场景</h2><h2 id=\"10-FlashBack\"><a href=\"#10-FlashBack\" class=\"headerlink\" title=\"10.FlashBack\"></a>10.FlashBack</h2><ul>\n<li>要求</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>版本大于等于<span class=\"token number\">10.2</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>数据必须开启归档\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>数据必须配置Flash recovery\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">5</span><span class=\"token punctuation\">.</span>没有特殊要求就正常闪回\n</code></pre>\n<ul>\n<li>基本步骤</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>关闭数据库\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>startup mount<span class=\"token punctuation\">[</span>exclusive模式<span class=\"token punctuation\">]</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>闪回  时间<span class=\"token operator\">/</span>SCN<span class=\"token operator\">/</span>还原点\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span> resetlogs<span class=\"token operator\">/</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">4.1</span> 打开有<span class=\"token number\">2</span>种方法\n    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span> resetlog 方法，整个数据库都都恢复到丢表之前的状态（假如丢表之后对其他表进行了某些操作也将丢失）\n    <span class=\"token number\">2</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span> <span class=\"token keyword\">read</span> only 只读打开，导标，完全恢复，在导入丢失的表。\n    也可以先把备份放到其他的数据库恢复后把丢失的表导入的目标数据库\n</code></pre>\n<ul>\n<li>具体操作</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">\n<span class=\"token comment\" spellcheck=\"true\">--SQLPLUS</span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token operator\">&lt;</span>db_name<span class=\"token operator\">></span> <span class=\"token keyword\">to</span> scn <span class=\"token operator\">&lt;</span>scn<span class=\"token operator\">></span>   <span class=\"token comment\" spellcheck=\"true\">--scn </span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token operator\">&lt;</span>db_name<span class=\"token operator\">></span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">timestamp</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">timestamp</span><span class=\"token operator\">></span> <span class=\"token comment\" spellcheck=\"true\">--time</span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> <span class=\"token operator\">&lt;</span>point_name<span class=\"token operator\">></span> <span class=\"token comment\" spellcheck=\"true\">--restore point</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--RMAN</span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> scn<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>scn<span class=\"token operator\">></span> <span class=\"token comment\" spellcheck=\"true\">--scn</span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> time<span class=\"token operator\">=</span><span class=\"token string\">\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--time</span>\nflashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> sequence<span class=\"token operator\">=</span><span class=\"token number\">88</span> thread<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--sequence</span>\n</code></pre>\n<h3 id=\"10-1-基于SCN的闪回\"><a href=\"#10-1-基于SCN的闪回\" class=\"headerlink\" title=\"10.1.基于SCN的闪回\"></a>10.1.基于SCN的闪回</h3><pre class=\" language-sql\"><code class=\"language-sql\">\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> current_scn <span class=\"token keyword\">from</span> v$<span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n\nCURRENT_SCN\n<span class=\"token comment\" spellcheck=\"true\">-----------</span>\n    <span class=\"token number\">1349018</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> v$flashback_database_log<span class=\"token punctuation\">;</span>\n\nOLDEST_FLASHBACK_SCN OLDEST_FLASHBACK_TI RETENTION_TARGET FLASHBACK_SIZE\n<span class=\"token comment\" spellcheck=\"true\">-------------------- ------------------- ---------------- --------------</span>\nESTIMATED_FLASHBACK_SIZE\n<span class=\"token comment\" spellcheck=\"true\">------------------------</span>\n             <span class=\"token number\">1345507</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">30</span> <span class=\"token number\">13</span>:<span class=\"token number\">18</span>:<span class=\"token number\">09</span>             <span class=\"token number\">1440</span>      <span class=\"token number\">104857600</span>\n               <span class=\"token number\">327008256</span>\n<span class=\"token number\">14</span>:<span class=\"token number\">13</span>:<span class=\"token number\">37</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test<span class=\"token punctuation\">;</span>\n\n        ID NAME\n<span class=\"token comment\" spellcheck=\"true\">---------- --------------------</span>\n         <span class=\"token number\">1</span> Anonycurse01\n         <span class=\"token number\">2</span> Anonycurse02\n         <span class=\"token number\">3</span> Anonycurse03\n         <span class=\"token number\">4</span> Anonycurse04\n         <span class=\"token number\">5</span> Anonycurse05\n         <span class=\"token number\">6</span> Anonycurse06\n         <span class=\"token number\">7</span> Anonycurse07\n\n<span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> selected<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">14</span>:<span class=\"token number\">13</span>:<span class=\"token number\">47</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> test <span class=\"token keyword\">where</span> id<span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> deleted<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">14</span>:<span class=\"token number\">14</span>:<span class=\"token number\">06</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Commit</span> complete<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area  <span class=\"token number\">835104768</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2257840</span> bytes\nVariable Size             <span class=\"token number\">281021520</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">549453824</span> bytes\nRedo Buffers                <span class=\"token number\">2371584</span> bytes\n<span class=\"token keyword\">Database</span> mounted<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> flashback <span class=\"token keyword\">database</span> orcl <span class=\"token keyword\">to</span> scn   <span class=\"token number\">1349018</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h3 id=\"10-2-基于时间的闪回\"><a href=\"#10-2-基于时间的闪回\" class=\"headerlink\" title=\"10.2.基于时间的闪回\"></a>10.2.基于时间的闪回</h3><ul>\n<li>步骤</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>数据库启动到MOUNT，恢复到制定时间点\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>把数据的打开导只读模式\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>把表导出\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span>重启数据库到MOUNT后恢复数据库到最新\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span>正常打开后导入表\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">SQL<span class=\"token operator\">></span> <span class=\"token keyword\">set</span> time <span class=\"token keyword\">on</span>\n<span class=\"token number\">15</span>:<span class=\"token number\">00</span>:<span class=\"token number\">12</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test<span class=\"token punctuation\">;</span>\n\n        ID NAME\n<span class=\"token comment\" spellcheck=\"true\">---------- --------------------</span>\n         <span class=\"token number\">1</span> Anonycurse01\n         <span class=\"token number\">2</span> Anonycurse02\n         <span class=\"token number\">3</span> Anonycurse03\n         <span class=\"token number\">4</span> Anonycurse04\n         <span class=\"token number\">5</span> Anonycurse05\n         <span class=\"token number\">6</span> Anonycurse06\n         <span class=\"token number\">7</span> Anonycurse07\n\n<span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> selected<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">15</span>:<span class=\"token number\">00</span>:<span class=\"token number\">17</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test01 <span class=\"token keyword\">as</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">15</span>:<span class=\"token number\">00</span>:<span class=\"token number\">41</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test01<span class=\"token punctuation\">;</span>\n\n        ID NAME\n<span class=\"token comment\" spellcheck=\"true\">---------- --------------------</span>\n         <span class=\"token number\">1</span> Anonycurse01\n         <span class=\"token number\">2</span> Anonycurse02\n         <span class=\"token number\">3</span> Anonycurse03\n         <span class=\"token number\">4</span> Anonycurse04\n         <span class=\"token number\">5</span> Anonycurse05\n         <span class=\"token number\">6</span> Anonycurse06\n         <span class=\"token number\">7</span> Anonycurse07\n\n<span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> selected<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">15</span>:<span class=\"token number\">00</span>:<span class=\"token number\">48</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Commit</span> complete<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">15</span>:<span class=\"token number\">00</span>:<span class=\"token number\">57</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> test01<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> dropped<span class=\"token punctuation\">.</span>\n\n<span class=\"token number\">15</span>:<span class=\"token number\">01</span>:<span class=\"token number\">10</span> SQL<span class=\"token operator\">></span> <span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> test<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> dropped<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> closed<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">Database</span> dismounted<span class=\"token punctuation\">.</span>\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area  <span class=\"token number\">835104768</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2257840</span> bytes\nVariable Size             <span class=\"token number\">281021520</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">549453824</span> bytes\nRedo Buffers                <span class=\"token number\">2371584</span> bytes\n<span class=\"token keyword\">Database</span> mounted<span class=\"token punctuation\">.</span>\n\nRMAN<span class=\"token operator\">></span> flashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> time<span class=\"token operator\">=</span><span class=\"token string\">\"to_date('2018-01-30 15:00:41','YYYY-MM-DD HH24:MI:SS')\"</span><span class=\"token punctuation\">;</span>\n\nStarting flashback at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">30</span> <span class=\"token number\">15</span>:<span class=\"token number\">04</span>:<span class=\"token number\">25</span>\n<span class=\"token keyword\">using</span> channel ORA_DISK_1\n\n\nstarting media recovery\nmedia recovery complete<span class=\"token punctuation\">,</span> elapsed time: <span class=\"token number\">00</span>:<span class=\"token number\">00</span>:<span class=\"token number\">07</span>\n\nFinished flashback at <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">30</span> <span class=\"token number\">15</span>:<span class=\"token number\">04</span>:<span class=\"token number\">32</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">open</span> <span class=\"token keyword\">read</span> only<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\n<span class=\"token punctuation\">[</span>oracle<span class=\"token variable\">@orcl</span>:<span class=\"token operator\">/</span>u01<span class=\"token punctuation\">]</span>$exp anonycurse<span class=\"token operator\">/</span>jia <span class=\"token keyword\">tables</span><span class=\"token operator\">=</span>test01 <span class=\"token keyword\">file</span><span class=\"token operator\">=</span><span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>test01<span class=\"token punctuation\">.</span>dmp log<span class=\"token operator\">=</span><span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>test01<span class=\"token punctuation\">.</span>log \n\nExport: <span class=\"token keyword\">Release</span> <span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span> <span class=\"token operator\">-</span> Production <span class=\"token keyword\">on</span> Tue Jan <span class=\"token number\">30</span> <span class=\"token number\">15</span>:<span class=\"token number\">22</span>:<span class=\"token number\">07</span> <span class=\"token number\">2018</span>\n\nCopyright <span class=\"token punctuation\">(</span><span class=\"token number\">c</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1982</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2011</span><span class=\"token punctuation\">,</span> Oracle <span class=\"token operator\">and</span><span class=\"token operator\">/</span><span class=\"token operator\">or</span> its affiliates<span class=\"token punctuation\">.</span>  <span class=\"token keyword\">All</span> rights reserved<span class=\"token punctuation\">.</span>\n\n\n\nConnected <span class=\"token keyword\">to</span>: Oracle <span class=\"token keyword\">Database</span> 11g Enterprise Edition <span class=\"token keyword\">Release</span> <span class=\"token number\">11.2</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span> <span class=\"token operator\">-</span> 64bit Production\n<span class=\"token keyword\">With</span> the Partitioning<span class=\"token punctuation\">,</span> OLAP<span class=\"token punctuation\">,</span> <span class=\"token keyword\">Data</span> Mining <span class=\"token operator\">and</span> <span class=\"token keyword\">Real</span> Application Testing options\nExport done <span class=\"token operator\">in</span> ZHS16GBK <span class=\"token keyword\">character set</span> <span class=\"token operator\">and</span> UTF8 <span class=\"token keyword\">NCHAR</span> <span class=\"token keyword\">character set</span>\n\nAbout <span class=\"token keyword\">to</span> export specified <span class=\"token keyword\">tables</span> via Conventional Path <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">.</span> <span class=\"token punctuation\">.</span> exporting <span class=\"token keyword\">table</span>                         TEST01          <span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> exported\nExport terminated successfully without <span class=\"token keyword\">warnings</span><span class=\"token punctuation\">.</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Database</span> closed<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">Database</span> dismounted<span class=\"token punctuation\">.</span>\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area  <span class=\"token number\">835104768</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2257840</span> bytes\nVariable Size             <span class=\"token number\">281021520</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">549453824</span> bytes\nRedo Buffers                <span class=\"token number\">2371584</span> bytes\n<span class=\"token keyword\">Database</span> mounted<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> recovery <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\nSP2<span class=\"token number\">-0734</span>: unknown command beginning <span class=\"token string\">\"recovery d...\"</span> <span class=\"token operator\">-</span> rest <span class=\"token keyword\">of</span> line ignored<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> recover <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\nMedia recovery complete<span class=\"token punctuation\">.</span>\n\n</code></pre>\n<h3 id=\"10-4-Restore-point-in-Oracle（Normal）\"><a href=\"#10-4-Restore-point-in-Oracle（Normal）\" class=\"headerlink\" title=\"10.4 Restore point in Oracle（Normal）\"></a>10.4 Restore point in Oracle（Normal）</h3><ul>\n<li>基本使用</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.创建还原点</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_normal<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.查看还原点</span>\n<span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span>time<span class=\"token punctuation\">,</span>storage_size <span class=\"token keyword\">from</span> v$restore_point<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--3.删除还原点</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_normal<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<ul>\n<li>步骤</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>创建还原点\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span>执行某操作后需要还原\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>执行还原\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">OPEN</span> RESETLOGS打开数据库\n<span class=\"token number\">5</span><span class=\"token punctuation\">.</span>删除还原点\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">SQL<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_normal<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Restore</span> <span class=\"token keyword\">point</span> created<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span>time<span class=\"token punctuation\">,</span>storage_size <span class=\"token keyword\">from</span> v$restore_point<span class=\"token punctuation\">;</span>\n\nNAME\n<span class=\"token comment\" spellcheck=\"true\">--------------------------------------------------------------------------------</span>\nTIME\n<span class=\"token comment\" spellcheck=\"true\">---------------------------------------------------------------------------</span>\nSTORAGE_SIZE\n<span class=\"token comment\" spellcheck=\"true\">------------</span>\nTEST_NORMAL\n<span class=\"token number\">30</span><span class=\"token operator\">-</span>JAN<span class=\"token number\">-18</span> <span class=\"token number\">03.46</span><span class=\"token punctuation\">.</span><span class=\"token number\">27.000000000</span> PM\n           <span class=\"token number\">0</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> table_name <span class=\"token keyword\">from</span> user_tables<span class=\"token punctuation\">;</span>\n\nTABLE_NAME\n<span class=\"token comment\" spellcheck=\"true\">------------------------------</span>\nTEST01\nTEST02\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> test01 <span class=\"token keyword\">purge</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> dropped<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate\n<span class=\"token keyword\">Database</span> closed<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">Database</span> dismounted<span class=\"token punctuation\">.</span>\nORACLE instance shut down<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span>\nORACLE instance started<span class=\"token punctuation\">.</span>\n\nTotal System <span class=\"token keyword\">Global</span> Area  <span class=\"token number\">835104768</span> bytes\n<span class=\"token keyword\">Fixed</span> Size                  <span class=\"token number\">2257840</span> bytes\nVariable Size             <span class=\"token number\">281021520</span> bytes\n<span class=\"token keyword\">Database</span> Buffers          <span class=\"token number\">549453824</span> bytes\nRedo Buffers                <span class=\"token number\">2371584</span> bytes\n<span class=\"token keyword\">Database</span> mounted<span class=\"token punctuation\">.</span>\nSQL<span class=\"token operator\">></span> flashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_normal<span class=\"token punctuation\">;</span>\n\nFlashback complete<span class=\"token punctuation\">.</span>\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">open</span>  resetlogs<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\n\nSQL<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> table_name <span class=\"token keyword\">from</span> user_tables<span class=\"token punctuation\">;</span>\n\nTABLE_NAME\n<span class=\"token comment\" spellcheck=\"true\">------------------------------</span>\nTEST01\nTEST02\n\n</code></pre>\n<h3 id=\"10-5-Restore-point-in-Oracle（Guaranteed）\"><a href=\"#10-5-Restore-point-in-Oracle（Guaranteed）\" class=\"headerlink\" title=\"10.5 Restore point in Oracle（Guaranteed）\"></a>10.5 Restore point in Oracle（Guaranteed）</h3><ul>\n<li>基本使用</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.创建还原点</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_guaranteed Guarantee flashback <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--2.</span>\n<span class=\"token comment\" spellcheck=\"true\">--3.</span>\n\n</code></pre>\n<ul>\n<li>步骤</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">和Normal基本一致\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">flashback <span class=\"token keyword\">database</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> test_guaranteed<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"10-3-日常监控\"><a href=\"#10-3-日常监控\" class=\"headerlink\" title=\"10.3 日常监控\"></a>10.3 日常监控</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.监控flashback</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> V$FLASH_RECOVERY_AREA_USAGE<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> V$RECOVERY_FILE_DEST<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--2.清理空间</span>\nrm datafile<span class=\"token number\">.dbf</span>\n\nRMAN<span class=\"token operator\">></span>\ncrosscheck <span class=\"token keyword\">backup</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">delete</span> expired <span class=\"token keyword\">backup</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">delete</span> expired archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">force</span> obsolete<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.闪回点清理</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> v$resore_point<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">restore</span> <span class=\"token keyword\">point</span> <span class=\"token operator\">&lt;</span>point_name<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--4.相关视图</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> DICTIONARY <span class=\"token keyword\">WHERE</span> table_name <span class=\"token operator\">like</span> <span class=\"token string\">'%FLASH%'</span><span class=\"token punctuation\">;</span>\n\nv$<span class=\"token keyword\">database</span>  \n    <span class=\"token keyword\">SELECT</span> FLASHBACK_ON <span class=\"token keyword\">FROM</span> v$<span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\nv$flashback_database_log\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> v$flashback_database_log<span class=\"token punctuation\">;</span>\nv$flashback_database_stat\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> v$flashback_database_stat<span class=\"token punctuation\">;</span>\nV$FLASH_RECOVERY_AREA_USAGE\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> V$FLASH_RECOVERY_AREA_USAGE<span class=\"token punctuation\">;</span>\nV$RECOVERY_FILE_DEST\n    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> V$RECOVERY_FILE_DEST<span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h2 id=\"11-回收站管理\"><a href=\"#11-回收站管理\" class=\"headerlink\" title=\"11.回收站管理\"></a>11.回收站管理</h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> dba_recyclebin<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> test <span class=\"token keyword\">purge</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\" spellcheck=\"true\">--清空回收站</span>\n<span class=\"token keyword\">purge</span> dba_recyclebin<span class=\"token punctuation\">;</span>    <span class=\"token comment\" spellcheck=\"true\">--All User</span>\n<span class=\"token keyword\">purge</span> recyclebin<span class=\"token punctuation\">;</span>    <span class=\"token comment\" spellcheck=\"true\">--Current User</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> test <span class=\"token keyword\">purge</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\" spellcheck=\"true\">--Skip</span>\n\n<span class=\"token keyword\">purge</span> <span class=\"token keyword\">tablespace</span> tbs_name<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">purge</span> <span class=\"token keyword\">tablespace</span> tbs_name <span class=\"token keyword\">user</span> user_name<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">purge</span> <span class=\"token keyword\">index</span> BIN$Y<span class=\"token operator\">/</span>nEtmKPVY3gUwEAAH92GA<span class=\"token operator\">=</span><span class=\"token operator\">=</span>$<span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--回收站还原表</span>\n<span class=\"token comment\" spellcheck=\"true\">--FlashBack</span>\nflash <span class=\"token keyword\">table</span> <span class=\"token string\">\"BIN$Y/nEtmKPVY3gUwEAAH92GA==$0\"</span> <span class=\"token keyword\">to</span> before <span class=\"token keyword\">drop</span><span class=\"token punctuation\">;</span>\nflashback <span class=\"token keyword\">table</span> test <span class=\"token keyword\">to</span> before <span class=\"token keyword\">drop</span><span class=\"token punctuation\">;</span>\nflashback <span class=\"token keyword\">table</span> test before <span class=\"token keyword\">drop</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">to</span> test<span class=\"token operator\">-</span>new<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--Change Name</span>\n<span class=\"token keyword\">SELECT</span> table_name<span class=\"token punctuation\">,</span>table_owner<span class=\"token punctuation\">,</span>indedx_name <span class=\"token keyword\">from</span> dba_indexes <span class=\"token keyword\">WHERE</span> table_owner<span class=\"token operator\">=</span><span class=\"token string\">'anonycurse'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> table_name<span class=\"token punctuation\">,</span>constraint_name <span class=\"token keyword\">from</span> dba_constraints <span class=\"token keyword\">WHERE</span> table_name<span class=\"token operator\">=</span><span class=\"token string\">'test01'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> test01 <span class=\"token keyword\">rename</span> <span class=\"token keyword\">constraint</span> <span class=\"token string\">\"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\"</span>  <span class=\"token keyword\">rename</span> <span class=\"token keyword\">to</span> test_id_pk<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">index</span> <span class=\"token string\">\"BIN$Y5intw3VMY3gUwEAAH+aYw==$0\"</span> <span class=\"token keyword\">rename</span> <span class=\"token keyword\">to</span> test_pk<span class=\"token punctuation\">;</span>\n\n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-Rman-的备份-（高级）\"><a href=\"#Oracle-Rman-的备份-（高级）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （高级）\"></a>Oracle Rman 的备份 （高级）</h1><p>[Oracle 11G R2 官方文档][1] </p>\n<h2 id=\"1-关于RMAN内存缓冲与块跟踪\"><a href=\"#1-关于RMAN内存缓冲与块跟踪\" class=\"headerlink\" title=\"1.关于RMAN内存缓冲与块跟踪\"></a>1.关于RMAN内存缓冲与块跟踪</h2><pre><code class=\"sql\">## 6.使用RMAN的dbms_backup_restore包\n</code></pre>\n<ul>\n<li>查看RMAN 备份进程</li>\n</ul>\n<pre><code class=\"sql\">select sid,serial#,context,sofar,totalwork,round(sofar/totalwork*100,2) &quot;%_COMPLETE&quot;\n     from v$session_longops\n    where opname like &#39;RMAN%&#39;\n     AND OPNAME NOT LIKE &#39;%aggregate%&#39;\n     and totalwork != 0\n     and sofar &lt;&gt;totalwork;\n</code></pre>\n<h2 id=\"2-使用RMAN的dbms-backup-restore包\"><a href=\"#2-使用RMAN的dbms-backup-restore包\" class=\"headerlink\" title=\"2.使用RMAN的dbms_backup_restore包\"></a>2.使用RMAN的dbms_backup_restore包</h2><ul>\n<li>1.恢复controlfile</li>\n</ul>\n<blockquote>\n<p>dbms_backup_restore包是一个非常强大的package，可以在数据库nomount下使用，用于从RMAN备份集中读取各类文件。</p>\n</blockquote>\n<pre><code class=\"sql\">DECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=&gt;&#39;&#39;,ident=&gt;&#39;t1&#39;);\n    sys.dbms_backup_restore.restoreSetDatafile;\n    sys.dbms_backup_restore.restoreControlfileTo(cfname=&gt;&#39;/backup/test/control01.ctl&#39;);\n    sys.dbms_backup_restore.restoreBackupPiece(done=&gt;done,handle=&gt;&#39;/backup/full/itpux19_ctl_db01_3_1_919281645&#39;,params=&gt;null);\n    sys.dbms_backup_restore.deviceDeallocate;\n   END;\n/ \n</code></pre>\n<ul>\n<li>2.恢复数据文件</li>\n</ul>\n<pre><code class=\"sql\">select &#39;sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;&#39; || file# ||\n       &#39;,toname=&gt;&#39; ||chr(39)|| name ||chr(39) || &#39;);&#39;,\n       &#39;sys.dbms_backup_restore.applySetDatafile(dfnumber=&gt;&#39; || file# ||\n       &#39;,toname=&gt;&#39; ||chr(39)|| name ||chr(39) || &#39;);&#39;\n  from v$datafile; \n\n\n DECLARE\n    devtype varchar2(256);\n    done boolean;\n    BEGIN\n    devtype:=sys.dbms_backup_restore.deviceAllocate (type=&gt;&#39;&#39;,ident=&gt;&#39;t1&#39;);\n      sys.dbms_backup_restore.restoreSetDatafile;\n      sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;1,toname=&gt;&#39;/backup/test/system01.dbf&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;2,toname=&gt;&#39;/backup/test/sysaux01.dbf&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;3,toname=&gt;&#39;/backup/test/undotbs01.dbf&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;4,toname=&gt;&#39;/backup/test/users01.dbf&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;5,toname=&gt;&#39;/backup/test/example01.dbf&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;6,toname=&gt;&#39;/backup/test/scdata01.ora&#39;);\n    sys.dbms_backup_restore.restoreDatafileTo(dfnumber=&gt;7,toname=&gt;&#39;/backup/test/rman.dbf&#39;);\n    sys.dbms_backup_restore.restoreBackupPiece(done=&gt;done,handle=&gt;&#39;/backup/full/itpux19_full_db01_1_1_919278149&#39;, params=&gt;null);\n    sys.dbms_backup_restore.deviceDeallocate;\n END;\n /\n\n</code></pre>\n<ul>\n<li>3.恢复归档日志文件</li>\n</ul>\n<pre><code class=\"sql\">---从备份集中还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =&gt;&#39;&#39;,ident =&gt; &#39;t1&#39;);\ndbms_backup_restore.RestoreSetArchivedLog(destination=&gt;&#39;/backu/test/archive&#39;);   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLog(thread =&gt;1 ,sequence =&gt;9);   --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done =&gt; done,handle =&gt;&#39;/oracle/full/itpux19_pfile_db01_4_1_919281649&#39;, params =&gt; null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n\n---从备份集中按scn范围还原归档日志\ndeclare\ndevtype varchar2(256);\ndone boolean;\nbegin\ndevtype := dbms_backup_restore.DeviceAllocate (type =&gt;&#39;&#39;,ident =&gt; &#39;t1&#39;);\ndbms_backup_restore.RestoreSetArchivedLog(destination=&gt;&#39;/backu/test/archive&#39;);   --设置恢复对话\ndbms_backup_restore.RestoreArchivedLogRange(log_change =&gt;1125933 ,high_change =&gt;1126275);  --日志的线程号和日志号\ndbms_backup_restore.RestoreBackupPiece(done =&gt; done,handle =&gt;&#39;/oracle/full/itpux19_pfile_db01_4_1_919281649&#39;, params =&gt; null);    --指定使用的备份集\ndbms_backup_restore.DeviceDeallocate;\nend;\n\n</code></pre>\n<h2 id=\"3-使用RMAN的BlockRecovery恢复坏块\"><a href=\"#3-使用RMAN的BlockRecovery恢复坏块\" class=\"headerlink\" title=\"3.使用RMAN的BlockRecovery恢复坏块\"></a>3.使用RMAN的BlockRecovery恢复坏块</h2><h2 id=\"4-Oracle-RMAN-Recovery-Advisor案列\"><a href=\"#4-Oracle-RMAN-Recovery-Advisor案列\" class=\"headerlink\" title=\"4. Oracle RMAN Recovery Advisor案列\"></a>4. Oracle RMAN Recovery Advisor案列</h2><h2 id=\"5-RMAN-备份压缩案列\"><a href=\"#5-RMAN-备份压缩案列\" class=\"headerlink\" title=\"5.RMAN 备份压缩案列\"></a>5.RMAN 备份压缩案列</h2><h3 id=\"5-1修改参数开启-关闭备份压缩\"><a href=\"#5-1修改参数开启-关闭备份压缩\" class=\"headerlink\" title=\"5.1修改参数开启/关闭备份压缩\"></a>5.1修改参数开启/关闭备份压缩</h3><ul>\n<li>1.开启备份压缩</li>\n</ul>\n<pre><code class=\"sql\">--使用COMPRESSED启用RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO COMPRESSED BACKUPSET;\n</code></pre>\n<ul>\n<li>2.关闭备份压缩</li>\n</ul>\n<pre><code class=\"sql\">--取消COMPRESSED取消RMAN备份压缩\nCONFIGURE DEVICE TYPE DISK BACKUP TYPE TO BACKUPSET;\n</code></pre>\n<h3 id=\"5-2直接使用命令开启-取消备份压缩\"><a href=\"#5-2直接使用命令开启-取消备份压缩\" class=\"headerlink\" title=\"5.2直接使用命令开启/取消备份压缩\"></a>5.2直接使用命令开启/取消备份压缩</h3><pre><code class=\"sql\">--对整个数据库压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATABASE PLUS ARCHIVELOG;\n--对指定数据文件压缩备份\nBACKUP AS COMPRESSED BACKUPSET DATAFILE 1,3,4;\n</code></pre>\n<h2 id=\"6-RMAN-增量备份与恢复\"><a href=\"#6-RMAN-增量备份与恢复\" class=\"headerlink\" title=\"6.RMAN 增量备份与恢复\"></a>6.RMAN 增量备份与恢复</h2><h2 id=\"7-RMAN-备份的加密\"><a href=\"#7-RMAN-备份的加密\" class=\"headerlink\" title=\"7.RMAN 备份的加密\"></a>7.RMAN 备份的加密</h2><h2 id=\"8-RMAN-克隆数据库测试\"><a href=\"#8-RMAN-克隆数据库测试\" class=\"headerlink\" title=\"8. RMAN 克隆数据库测试\"></a>8. RMAN 克隆数据库测试</h2><h2 id=\"9-生产环境-RMAN-异机恢复场景\"><a href=\"#9-生产环境-RMAN-异机恢复场景\" class=\"headerlink\" title=\"9.生产环境 RMAN 异机恢复场景\"></a>9.生产环境 RMAN 异机恢复场景</h2><h2 id=\"10-FlashBack\"><a href=\"#10-FlashBack\" class=\"headerlink\" title=\"10.FlashBack\"></a>10.FlashBack</h2><ul>\n<li>要求</li>\n</ul>\n<pre><code class=\"sql\">1.版本大于等于10.2\n2.数据必须开启归档\n3.数据必须配置Flash recovery\n4.\n5.没有特殊要求就正常闪回\n</code></pre>\n<ul>\n<li>基本步骤</li>\n</ul>\n<pre><code class=\"sql\">1.关闭数据库\n2.startup mount[exclusive模式]\n3.闪回  时间/SCN/还原点\n4.open resetlogs/**;\n4.1 打开有2种方法\n    1.open resetlog 方法，整个数据库都都恢复到丢表之前的状态（假如丢表之后对其他表进行了某些操作也将丢失）\n    2.open read only 只读打开，导标，完全恢复，在导入丢失的表。\n    也可以先把备份放到其他的数据库恢复后把丢失的表导入的目标数据库\n</code></pre>\n<ul>\n<li>具体操作</li>\n</ul>\n<pre><code class=\"sql\">\n--SQLPLUS\nflashback database &lt;db_name&gt; to scn &lt;scn&gt;   --scn \nflashback database &lt;db_name&gt; to timestamp &lt;timestamp&gt; --time\nflashback database to restore point &lt;point_name&gt; --restore point\n\n--RMAN\nflashback database to scn=&lt;scn&gt; --scn\nflashback database to time=&quot;to_date(&#39;2018-01-30 15:00:41&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;)&quot;; --time\nflashback database to sequence=88 thread=1; --sequence\n</code></pre>\n<h3 id=\"10-1-基于SCN的闪回\"><a href=\"#10-1-基于SCN的闪回\" class=\"headerlink\" title=\"10.1.基于SCN的闪回\"></a>10.1.基于SCN的闪回</h3><pre><code class=\"sql\">\nSQL&gt; select current_scn from v$database;\n\nCURRENT_SCN\n-----------\n    1349018\n\nSQL&gt; select * from v$flashback_database_log;\n\nOLDEST_FLASHBACK_SCN OLDEST_FLASHBACK_TI RETENTION_TARGET FLASHBACK_SIZE\n-------------------- ------------------- ---------------- --------------\nESTIMATED_FLASHBACK_SIZE\n------------------------\n             1345507 2018-01-30 13:18:09             1440      104857600\n               327008256\n14:13:37 SQL&gt; select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n14:13:47 SQL&gt; delete from test where id=7;\n\n1 row deleted.\n\n14:14:06 SQL&gt; commit;\n\nCommit complete.\n\nSQL&gt; startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL&gt; flashback database orcl to scn   1349018;\n\n</code></pre>\n<h3 id=\"10-2-基于时间的闪回\"><a href=\"#10-2-基于时间的闪回\" class=\"headerlink\" title=\"10.2.基于时间的闪回\"></a>10.2.基于时间的闪回</h3><ul>\n<li>步骤</li>\n</ul>\n<pre><code class=\"sql\">1.数据库启动到MOUNT，恢复到制定时间点\n2.把数据的打开导只读模式\n3.把表导出\n4.重启数据库到MOUNT后恢复数据库到最新\n4.正常打开后导入表\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre><code class=\"sql\">SQL&gt; set time on\n15:00:12 SQL&gt; select * from test;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:17 SQL&gt; create table test01 as select * from test;\n\nTable created.\n\n15:00:41 SQL&gt; select * from test01;\n\n        ID NAME\n---------- --------------------\n         1 Anonycurse01\n         2 Anonycurse02\n         3 Anonycurse03\n         4 Anonycurse04\n         5 Anonycurse05\n         6 Anonycurse06\n         7 Anonycurse07\n\n7 rows selected.\n\n15:00:48 SQL&gt; commit;\n\nCommit complete.\n\n15:00:57 SQL&gt; drop table test01;\n\nTable dropped.\n\n15:01:10 SQL&gt; drop table test;\n\nTable dropped.\n\nSQL&gt; shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL&gt; startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\n\nRMAN&gt; flashback database to time=&quot;to_date(&#39;2018-01-30 15:00:41&#39;,&#39;YYYY-MM-DD HH24:MI:SS&#39;)&quot;;\n\nStarting flashback at 2018-01-30 15:04:25\nusing channel ORA_DISK_1\n\n\nstarting media recovery\nmedia recovery complete, elapsed time: 00:00:07\n\nFinished flashback at 2018-01-30 15:04:32\n\nSQL&gt; alter database open read only;\n\nDatabase altered.\n\n[oracle@orcl:/u01]$exp anonycurse/jia tables=test01 file=/u01/test01.dmp log=/u01/test01.log \n\nExport: Release 11.2.0.4.0 - Production on Tue Jan 30 15:22:07 2018\n\nCopyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.\n\n\n\nConnected to: Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production\nWith the Partitioning, OLAP, Data Mining and Real Application Testing options\nExport done in ZHS16GBK character set and UTF8 NCHAR character set\n\nAbout to export specified tables via Conventional Path ...\n. . exporting table                         TEST01          7 rows exported\nExport terminated successfully without warnings.\n\n\nSQL&gt; shutdown immediate;\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL&gt; startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL&gt; recovery database;\nSP2-0734: unknown command beginning &quot;recovery d...&quot; - rest of line ignored.\nSQL&gt; recover database;\nMedia recovery complete.\n\n</code></pre>\n<h3 id=\"10-4-Restore-point-in-Oracle（Normal）\"><a href=\"#10-4-Restore-point-in-Oracle（Normal）\" class=\"headerlink\" title=\"10.4 Restore point in Oracle（Normal）\"></a>10.4 Restore point in Oracle（Normal）</h3><ul>\n<li>基本使用</li>\n</ul>\n<pre><code class=\"sql\">--1.创建还原点\ncreate restore point test_normal;\n--2.查看还原点\nselect name,time,storage_size from v$restore_point;\n--3.删除还原点\ndrop restore point test_normal;\n\n</code></pre>\n<ul>\n<li>步骤</li>\n</ul>\n<pre><code class=\"sql\">1.创建还原点\n2.执行某操作后需要还原\n3.执行还原\n4.OPEN RESETLOGS打开数据库\n5.删除还原点\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre><code class=\"sql\">SQL&gt; create restore point test_normal;\n\nRestore point created.\n\nSQL&gt; select name,time,storage_size from v$restore_point;\n\nNAME\n--------------------------------------------------------------------------------\nTIME\n---------------------------------------------------------------------------\nSTORAGE_SIZE\n------------\nTEST_NORMAL\n30-JAN-18 03.46.27.000000000 PM\n           0\n\n\nSQL&gt; select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\nSQL&gt; drop table test01 purge;\n\nTable dropped.\n\nSQL&gt; shutdown immediate\nDatabase closed.\nDatabase dismounted.\nORACLE instance shut down.\nSQL&gt; startup mount;\nORACLE instance started.\n\nTotal System Global Area  835104768 bytes\nFixed Size                  2257840 bytes\nVariable Size             281021520 bytes\nDatabase Buffers          549453824 bytes\nRedo Buffers                2371584 bytes\nDatabase mounted.\nSQL&gt; flashback database to restore point test_normal;\n\nFlashback complete.\n\nSQL&gt; alter database open  resetlogs;\n\nDatabase altered.\n\n\nSQL&gt; select table_name from user_tables;\n\nTABLE_NAME\n------------------------------\nTEST01\nTEST02\n\n</code></pre>\n<h3 id=\"10-5-Restore-point-in-Oracle（Guaranteed）\"><a href=\"#10-5-Restore-point-in-Oracle（Guaranteed）\" class=\"headerlink\" title=\"10.5 Restore point in Oracle（Guaranteed）\"></a>10.5 Restore point in Oracle（Guaranteed）</h3><ul>\n<li>基本使用</li>\n</ul>\n<pre><code class=\"sql\">--1.创建还原点\ncreate restore point test_guaranteed Guarantee flashback database;\n--2.\n--3.\n\n</code></pre>\n<ul>\n<li>步骤</li>\n</ul>\n<pre><code class=\"sql\">和Normal基本一致\n</code></pre>\n<ul>\n<li>操作</li>\n</ul>\n<pre><code class=\"sql\">flashback database to restore point test_guaranteed;\n\n</code></pre>\n<h2 id=\"10-3-日常监控\"><a href=\"#10-3-日常监控\" class=\"headerlink\" title=\"10.3 日常监控\"></a>10.3 日常监控</h2><pre><code class=\"sql\">--1.监控flashback\nSELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nSELECT * FROM V$RECOVERY_FILE_DEST;\n\n--2.清理空间\nrm datafile.dbf\n\nRMAN&gt;\ncrosscheck backup;\ncrosscheck archivelog all;\ndelete expired backup;\ndelete expired archivelog all;\ndelete force obsolete;\n\n--3.闪回点清理\nSELECT * FROM v$resore_point;\ndrop restore point &lt;point_name&gt;;\n\n--4.相关视图\nSELECT * FROM DICTIONARY WHERE table_name like &#39;%FLASH%&#39;;\n\nv$database  \n    SELECT FLASHBACK_ON FROM v$database;\nv$flashback_database_log\n    SELECT * FROM v$flashback_database_log;\nv$flashback_database_stat\n    SELECT * FROM v$flashback_database_stat;\nV$FLASH_RECOVERY_AREA_USAGE\n    SELECT * FROM V$FLASH_RECOVERY_AREA_USAGE;\nV$RECOVERY_FILE_DEST\n    SELECT * FROM V$RECOVERY_FILE_DEST;\n\n</code></pre>\n<h2 id=\"11-回收站管理\"><a href=\"#11-回收站管理\" class=\"headerlink\" title=\"11.回收站管理\"></a>11.回收站管理</h2><pre><code class=\"sql\">SELECT * FROM dba_recyclebin;\ndrop table test purge; \n--清空回收站\npurge dba_recyclebin;    --All User\npurge recyclebin;    --Current User\ndrop table test purge;    --Skip\n\npurge tablespace tbs_name;\npurge tablespace tbs_name user user_name;\npurge index BIN$Y/nEtmKPVY3gUwEAAH92GA==$0;\n\n--回收站还原表\n--FlashBack\nflash table &quot;BIN$Y/nEtmKPVY3gUwEAAH92GA==$0&quot; to before drop;\nflashback table test to before drop;\nflashback table test before drop rename to test-new;\n\n--Change Name\nSELECT table_name,table_owner,indedx_name from dba_indexes WHERE table_owner=&#39;anonycurse&#39;;\nSELECT table_name,constraint_name from dba_constraints WHERE table_name=&#39;test01&#39;;\n\nalter table test01 rename constraint &quot;BIN$Y5intw3VMY3gUwEAAH+aYw==$0&quot;  rename to test_id_pk;\nalter index &quot;BIN$Y5intw3VMY3gUwEAAH+aYw==$0&quot; rename to test_pk;\n\n</code></pre>\n"},{"title":"Oracle Rman 备份2","date":"2018-10-04T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Oracle Rman 的备份 （案列）\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.如何设计一个TB级数据库的RMAN备份策略\n### 1.1 TB以下\n* 用ORACLE即可实现（保存在磁盘上，5TB），也可以选择第三方备份软件 集中管理：\n\n>1）RMAN全备：每周，每天；开归档模式\n2）逻辑全导出：每周\n3）归档备份（第三方管理）\n\n### 1.2 TB以下\n* 用ORACLE+结合第三方软件（集中管理，带库，虚拟带库，大的备份存储，10TB）：\n\n> 1）RMAN全备：每周，开归档模式\n2）归档备份：每天\n3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。\n\n### 1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\n>1）RMAN全备：每周，开归档模式；每个月一次加每周增量。\n2）归档备份：每天\n3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。\n\n### 1.4 备份案列\n* 环境\n\n> ORACLE RMAN+存储备份（1TB）\n数据库1TB，每天的归档量50GB\n\n* 备份策略\n\n>每周5,20:00全备，保留2份。5TB\n归档保留10天。 1TB\n恢复，全备+归档。\n逻辑全导出：每周 2TB\n\n* 备份脚本 rman_full_orcl.sh\n\n```sql\nrman target / catalog rman/rman@rman msglog '/u01/backup/logs/rman_full_itpux.log' << EOF\nrun {\n\tCONFIGURE RETENTION POLICY TO REDUNDANCY 2;\n\tallocate channel d1 type disk;\n\tallocate channel d2 type disk;\n\n\tsetlimit channel d1 kbytes 102428750 maxopenfiles 32 readrate 200;\n\tsetlimit channel d2 kbytes 102428750 maxopenfiles 32 readrate 200;\n\tsql 'alter system archive log current';\n\tbackup\n\t\tincremental level 0\n\t\tskip inaccessible\n\t\ttag itpux_level0\n\t\tfilesperset 3\n\t\tformat '/u01//backup/datafile/orcl_rman_full_%s_%p_%t'\n\t\t(database);\n\trelease channel d1;\n\trelease channel d2;\n\n\tALLOCATE CHANNEL d3 TYPE disk;\n\t\tBACKUP\n\t\t\t# recommended format\n\t\t\tFORMAT '/u01//backup/orcl_rman_cntrl_%s_%p_%t'\n\t\t\tCURRENT CONTROLFILE;\n\tRELEASE CHANNEL d3;\n\n\tALLOCATE CHANNEL d4 TYPE DISK;\n\t\tcopy current controlfile to '/u01//backup/datafile/control_itpux.bak';\n\tRELEASE CHANNEL d4;\n}\n\nALLOCATE CHANNEL FOR MAINTENANCE DEVICE TYPE DISK;\nrun\n{\n\treport obsolete;\n\tDELETE noprompt EXPIRED BACKUP;\n\tDELETE noprompt EXPIRED COPY;\n\tdelete noprompt obsolete device type disk;\n}\nexit\nEOF\n```\n\n* 删除归档 rman_delarch_orcl.sh\n\n```sql\nrman target / catalog rman/rman@rman msglog '/u01/backup/logs/rman_delarch_itpux.log' <<EOF\nrun{\n\tcrosscheck archivelog all;\n\tdelete noprompt archivelog until time \"sysdate-7\";\n\tdelete noprompt expired archivelog all;\n}\nexit\n\n```\n* 设置crontab\n\n```sql\n00 5 * * * su - oracle -c /u01/backup/scripts/rman_delarch_orcl.sh\n00 18 * * 5 su - oracle -c /u01/backup/scripts/rman_full_orcl.sh\n```\n## 2.在非归档模式的RMAN备份案例\n> &emsp;&emsp;备份分为一致性备份和不完全性备份，也就是我们所说的归档模式与非归档模式的备份.创建非归档备份可以是在非归档模式下创建，并且数据库必须处于mount状态下，而且恢复的时候值能恢复到最后一次备份的状态。也就说从备份到发生故障的这段时间都将丢失\n\n* 1.1. 检查归档状态\n\n```sql\narchive log list;\n```\n\n* 1.2 将数据库启动到mount状态\n\n```sql\nshutdown immediate\nstartup mount;\n```\n\n* 1.3 执行备份\n\n```sql\nrman target /\nbackup database;\n```\n\n* 2.1 非归档模式备份\n\n```sql\nshutdown immediate;\nstartup mount;\n\nrman target /\nbackup database;\n```\n\n* 3.1 归档模式\n\n```sql\nalter database open\n```\n\n## 3.在归档模式的RMAN备份与恢复案例-丢失所有文件\n>  &emsp;&emsp;如果要创建正式库的备份，一般不建议用非归档模式备份，也不建议用很简单的命令来完成。而是更多的采用脚本实现归档模式备份，这样将可通过backup+archive log+redo有效的将数据恢复到最近一次改变的状态，可以达到数据的丢失最小化。\n\n* 创建归档模式备份\n> &emsp;&emsp; 创建归档模式备份数据库必须处于归档(archivelog)模式，因为归档模式备份的数据库文件和控制文件的SCN号可能会不一致。\n并且可以在数据库打开并不影响业务的情况下完成数据的备份工作；那么这样的备份将是归档模式的备份，那么如果要恢复可以通过backup+archive log+redo来恢复到最近一次日志切换时候的数据，而不是最后一次备份时候的数据。\n\n* 寻找dbid\n\n```sql\n--1.可以在查看数据库警告日志\nvim /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log\n--2.在备份的控制文件中查找\n\t\n--3.用BBED在备份的文件中查找\n\n--4.在备份日志中查找 \n\n--5.配置控制文件强制启动数据库\n--5.1 添加一个参数文件\n\n```\n\n\n\n## 4.RMAN恢复案例-丢失单个数据文件如何恢复\n## 5.RMAN恢复案例-丢失整个数据表空间如何恢复\n## 6.RMAN恢复案例-丢失SYSTEM表空间如何恢复\n## 7.RMAN恢复案例-丢失控制文件如何恢复\n## 8.RMAN恢复案例-丢失参数文件如何恢复\n## 9.RMAN恢复案例-丢失重做日志文件如何恢复\n## 10.RMAN恢复案例-存储损坏数据丢失如何恢复\n## 11.RMAN恢复案例-不完全恢复\n## 12.RMAN基于时间点(time)的不完全恢复\n## 13.RMAN基于系统改变号(scn)的不完全恢复\n## 14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\n## 15.RMAN基于当前重做日志丢失的cancel不完全恢复\n## 16.RMAN基于备份控制文件不完全恢复\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","source":"_posts/oracle/Oracle Rman 备份2.md","raw":"---\ntitle: Oracle Rman 备份2\ndate: 2018-10-04 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - RMAN\n---\n\n\n# Oracle Rman 的备份 （案列）\n\n[Oracle 11G R2 官方文档][1]\n\n## 1.如何设计一个TB级数据库的RMAN备份策略\n### 1.1 TB以下\n* 用ORACLE即可实现（保存在磁盘上，5TB），也可以选择第三方备份软件 集中管理：\n\n>1）RMAN全备：每周，每天；开归档模式\n2）逻辑全导出：每周\n3）归档备份（第三方管理）\n\n### 1.2 TB以下\n* 用ORACLE+结合第三方软件（集中管理，带库，虚拟带库，大的备份存储，10TB）：\n\n> 1）RMAN全备：每周，开归档模式\n2）归档备份：每天\n3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。\n\n### 1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\n>1）RMAN全备：每周，开归档模式；每个月一次加每周增量。\n2）归档备份：每天\n3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。\n\n### 1.4 备份案列\n* 环境\n\n> ORACLE RMAN+存储备份（1TB）\n数据库1TB，每天的归档量50GB\n\n* 备份策略\n\n>每周5,20:00全备，保留2份。5TB\n归档保留10天。 1TB\n恢复，全备+归档。\n逻辑全导出：每周 2TB\n\n* 备份脚本 rman_full_orcl.sh\n\n```sql\nrman target / catalog rman/rman@rman msglog '/u01/backup/logs/rman_full_itpux.log' << EOF\nrun {\n\tCONFIGURE RETENTION POLICY TO REDUNDANCY 2;\n\tallocate channel d1 type disk;\n\tallocate channel d2 type disk;\n\n\tsetlimit channel d1 kbytes 102428750 maxopenfiles 32 readrate 200;\n\tsetlimit channel d2 kbytes 102428750 maxopenfiles 32 readrate 200;\n\tsql 'alter system archive log current';\n\tbackup\n\t\tincremental level 0\n\t\tskip inaccessible\n\t\ttag itpux_level0\n\t\tfilesperset 3\n\t\tformat '/u01//backup/datafile/orcl_rman_full_%s_%p_%t'\n\t\t(database);\n\trelease channel d1;\n\trelease channel d2;\n\n\tALLOCATE CHANNEL d3 TYPE disk;\n\t\tBACKUP\n\t\t\t# recommended format\n\t\t\tFORMAT '/u01//backup/orcl_rman_cntrl_%s_%p_%t'\n\t\t\tCURRENT CONTROLFILE;\n\tRELEASE CHANNEL d3;\n\n\tALLOCATE CHANNEL d4 TYPE DISK;\n\t\tcopy current controlfile to '/u01//backup/datafile/control_itpux.bak';\n\tRELEASE CHANNEL d4;\n}\n\nALLOCATE CHANNEL FOR MAINTENANCE DEVICE TYPE DISK;\nrun\n{\n\treport obsolete;\n\tDELETE noprompt EXPIRED BACKUP;\n\tDELETE noprompt EXPIRED COPY;\n\tdelete noprompt obsolete device type disk;\n}\nexit\nEOF\n```\n\n* 删除归档 rman_delarch_orcl.sh\n\n```sql\nrman target / catalog rman/rman@rman msglog '/u01/backup/logs/rman_delarch_itpux.log' <<EOF\nrun{\n\tcrosscheck archivelog all;\n\tdelete noprompt archivelog until time \"sysdate-7\";\n\tdelete noprompt expired archivelog all;\n}\nexit\n\n```\n* 设置crontab\n\n```sql\n00 5 * * * su - oracle -c /u01/backup/scripts/rman_delarch_orcl.sh\n00 18 * * 5 su - oracle -c /u01/backup/scripts/rman_full_orcl.sh\n```\n## 2.在非归档模式的RMAN备份案例\n> &emsp;&emsp;备份分为一致性备份和不完全性备份，也就是我们所说的归档模式与非归档模式的备份.创建非归档备份可以是在非归档模式下创建，并且数据库必须处于mount状态下，而且恢复的时候值能恢复到最后一次备份的状态。也就说从备份到发生故障的这段时间都将丢失\n\n* 1.1. 检查归档状态\n\n```sql\narchive log list;\n```\n\n* 1.2 将数据库启动到mount状态\n\n```sql\nshutdown immediate\nstartup mount;\n```\n\n* 1.3 执行备份\n\n```sql\nrman target /\nbackup database;\n```\n\n* 2.1 非归档模式备份\n\n```sql\nshutdown immediate;\nstartup mount;\n\nrman target /\nbackup database;\n```\n\n* 3.1 归档模式\n\n```sql\nalter database open\n```\n\n## 3.在归档模式的RMAN备份与恢复案例-丢失所有文件\n>  &emsp;&emsp;如果要创建正式库的备份，一般不建议用非归档模式备份，也不建议用很简单的命令来完成。而是更多的采用脚本实现归档模式备份，这样将可通过backup+archive log+redo有效的将数据恢复到最近一次改变的状态，可以达到数据的丢失最小化。\n\n* 创建归档模式备份\n> &emsp;&emsp; 创建归档模式备份数据库必须处于归档(archivelog)模式，因为归档模式备份的数据库文件和控制文件的SCN号可能会不一致。\n并且可以在数据库打开并不影响业务的情况下完成数据的备份工作；那么这样的备份将是归档模式的备份，那么如果要恢复可以通过backup+archive log+redo来恢复到最近一次日志切换时候的数据，而不是最后一次备份时候的数据。\n\n* 寻找dbid\n\n```sql\n--1.可以在查看数据库警告日志\nvim /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log\n--2.在备份的控制文件中查找\n\t\n--3.用BBED在备份的文件中查找\n\n--4.在备份日志中查找 \n\n--5.配置控制文件强制启动数据库\n--5.1 添加一个参数文件\n\n```\n\n\n\n## 4.RMAN恢复案例-丢失单个数据文件如何恢复\n## 5.RMAN恢复案例-丢失整个数据表空间如何恢复\n## 6.RMAN恢复案例-丢失SYSTEM表空间如何恢复\n## 7.RMAN恢复案例-丢失控制文件如何恢复\n## 8.RMAN恢复案例-丢失参数文件如何恢复\n## 9.RMAN恢复案例-丢失重做日志文件如何恢复\n## 10.RMAN恢复案例-存储损坏数据丢失如何恢复\n## 11.RMAN恢复案例-不完全恢复\n## 12.RMAN基于时间点(time)的不完全恢复\n## 13.RMAN基于系统改变号(scn)的不完全恢复\n## 14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\n## 15.RMAN基于当前重做日志丢失的cancel不完全恢复\n## 16.RMAN基于备份控制文件不完全恢复\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/index.htm","slug":"oracle/Oracle Rman 备份2","published":1,"updated":"2019-05-03T16:05:09.166Z","_id":"cjv89q4wx003li0cdlqpdycvl","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-Rman-的备份-（案列）\"><a href=\"#Oracle-Rman-的备份-（案列）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （案列）\"></a>Oracle Rman 的备份 （案列）</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-如何设计一个TB级数据库的RMAN备份策略\"><a href=\"#1-如何设计一个TB级数据库的RMAN备份策略\" class=\"headerlink\" title=\"1.如何设计一个TB级数据库的RMAN备份策略\"></a>1.如何设计一个TB级数据库的RMAN备份策略</h2><h3 id=\"1-1-TB以下\"><a href=\"#1-1-TB以下\" class=\"headerlink\" title=\"1.1 TB以下\"></a>1.1 TB以下</h3><ul>\n<li>用ORACLE即可实现（保存在磁盘上，5TB），也可以选择第三方备份软件 集中管理：</li>\n</ul>\n<blockquote>\n<p>1）RMAN全备：每周，每天；开归档模式<br>2）逻辑全导出：每周<br>3）归档备份（第三方管理）</p>\n</blockquote>\n<h3 id=\"1-2-TB以下\"><a href=\"#1-2-TB以下\" class=\"headerlink\" title=\"1.2 TB以下\"></a>1.2 TB以下</h3><ul>\n<li>用ORACLE+结合第三方软件（集中管理，带库，虚拟带库，大的备份存储，10TB）：</li>\n</ul>\n<blockquote>\n<p>1）RMAN全备：每周，开归档模式<br>2）归档备份：每天<br>3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。</p>\n</blockquote>\n<h3 id=\"1-3-2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\"><a href=\"#1-3-2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\" class=\"headerlink\" title=\"1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\"></a>1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：</h3><blockquote>\n<p>1）RMAN全备：每周，开归档模式；每个月一次加每周增量。<br>2）归档备份：每天<br>3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。</p>\n</blockquote>\n<h3 id=\"1-4-备份案列\"><a href=\"#1-4-备份案列\" class=\"headerlink\" title=\"1.4 备份案列\"></a>1.4 备份案列</h3><ul>\n<li>环境</li>\n</ul>\n<blockquote>\n<p>ORACLE RMAN+存储备份（1TB）<br>数据库1TB，每天的归档量50GB</p>\n</blockquote>\n<ul>\n<li>备份策略</li>\n</ul>\n<blockquote>\n<p>每周5,20:00全备，保留2份。5TB<br>归档保留10天。 1TB<br>恢复，全备+归档。<br>逻辑全导出：每周 2TB</p>\n</blockquote>\n<ul>\n<li>备份脚本 rman_full_orcl.sh</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">rman target <span class=\"token operator\">/</span> catalog rman<span class=\"token operator\">/</span>rman<span class=\"token variable\">@rman</span> msglog <span class=\"token string\">'/u01/backup/logs/rman_full_itpux.log'</span> <span class=\"token operator\">&lt;&lt;</span> EOF\nrun {\n    CONFIGURE RETENTION POLICY <span class=\"token keyword\">TO</span> REDUNDANCY <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    allocate channel <span class=\"token number\">d1</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\n    allocate channel <span class=\"token number\">d2</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\n\n    setlimit channel <span class=\"token number\">d1</span> kbytes <span class=\"token number\">102428750</span> maxopenfiles <span class=\"token number\">32</span> readrate <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n    setlimit channel <span class=\"token number\">d2</span> kbytes <span class=\"token number\">102428750</span> maxopenfiles <span class=\"token number\">32</span> readrate <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n    sql <span class=\"token string\">'alter system archive log current'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">backup</span>\n        incremental level <span class=\"token number\">0</span>\n        skip inaccessible\n        tag itpux_level0\n        filesperset <span class=\"token number\">3</span>\n        format '<span class=\"token operator\">/</span>u01<span class=\"token comment\" spellcheck=\"true\">//backup/datafile/orcl_rman_full_%s_%p_%t'</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">database</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">release</span> channel <span class=\"token number\">d1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">release</span> channel <span class=\"token number\">d2</span><span class=\"token punctuation\">;</span>\n\n    ALLOCATE CHANNEL <span class=\"token number\">d3</span> <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">BACKUP</span>\n            <span class=\"token comment\" spellcheck=\"true\"># recommended format</span>\n            FORMAT '<span class=\"token operator\">/</span>u01<span class=\"token comment\" spellcheck=\"true\">//backup/orcl_rman_cntrl_%s_%p_%t'</span>\n            <span class=\"token keyword\">CURRENT</span> CONTROLFILE<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">RELEASE</span> CHANNEL <span class=\"token number\">d3</span><span class=\"token punctuation\">;</span>\n\n    ALLOCATE CHANNEL <span class=\"token number\">d4</span> <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">DISK</span><span class=\"token punctuation\">;</span>\n        copy <span class=\"token keyword\">current</span> controlfile <span class=\"token keyword\">to</span> '<span class=\"token operator\">/</span>u01<span class=\"token comment\" spellcheck=\"true\">//backup/datafile/control_itpux.bak';</span>\n    <span class=\"token keyword\">RELEASE</span> CHANNEL <span class=\"token number\">d4</span><span class=\"token punctuation\">;</span>\n}\n\nALLOCATE CHANNEL <span class=\"token keyword\">FOR</span> MAINTENANCE DEVICE <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">DISK</span><span class=\"token punctuation\">;</span>\nrun\n{\n    report obsolete<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">DELETE</span> noprompt EXPIRED <span class=\"token keyword\">BACKUP</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">DELETE</span> noprompt EXPIRED COPY<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">delete</span> noprompt obsolete device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\n}\n<span class=\"token keyword\">exit</span>\nEOF\n</code></pre>\n<ul>\n<li>删除归档 rman_delarch_orcl.sh</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">rman target <span class=\"token operator\">/</span> catalog rman<span class=\"token operator\">/</span>rman<span class=\"token variable\">@rman</span> msglog <span class=\"token string\">'/u01/backup/logs/rman_delarch_itpux.log'</span> <span class=\"token operator\">&lt;&lt;</span>EOF\nrun{\n    crosscheck archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">delete</span> noprompt archivelog until time <span class=\"token string\">\"sysdate-7\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">delete</span> noprompt expired archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n}\n<span class=\"token keyword\">exit</span>\n\n</code></pre>\n<ul>\n<li>设置crontab</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token number\">00</span> <span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> su <span class=\"token operator\">-</span> oracle <span class=\"token operator\">-</span><span class=\"token number\">c</span> <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span><span class=\"token keyword\">backup</span><span class=\"token operator\">/</span>scripts<span class=\"token operator\">/</span>rman_delarch_orcl<span class=\"token punctuation\">.</span>sh\n<span class=\"token number\">00</span> <span class=\"token number\">18</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token number\">5</span> su <span class=\"token operator\">-</span> oracle <span class=\"token operator\">-</span><span class=\"token number\">c</span> <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span><span class=\"token keyword\">backup</span><span class=\"token operator\">/</span>scripts<span class=\"token operator\">/</span>rman_full_orcl<span class=\"token punctuation\">.</span>sh\n</code></pre>\n<h2 id=\"2-在非归档模式的RMAN备份案例\"><a href=\"#2-在非归档模式的RMAN备份案例\" class=\"headerlink\" title=\"2.在非归档模式的RMAN备份案例\"></a>2.在非归档模式的RMAN备份案例</h2><blockquote>\n<p>&emsp;&emsp;备份分为一致性备份和不完全性备份，也就是我们所说的归档模式与非归档模式的备份.创建非归档备份可以是在非归档模式下创建，并且数据库必须处于mount状态下，而且恢复的时候值能恢复到最后一次备份的状态。也就说从备份到发生故障的这段时间都将丢失</p>\n</blockquote>\n<ul>\n<li>1.1. 检查归档状态</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">archive log list<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>1.2 将数据库启动到mount状态</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">shutdown</span> immediate\nstartup mount<span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>1.3 执行备份</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\">rman target <span class=\"token operator\">/</span>\n<span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>2.1 非归档模式备份</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">shutdown</span> immediate<span class=\"token punctuation\">;</span>\nstartup mount<span class=\"token punctuation\">;</span>\n\nrman target <span class=\"token operator\">/</span>\n<span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>3.1 归档模式</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">open</span>\n</code></pre>\n<h2 id=\"3-在归档模式的RMAN备份与恢复案例-丢失所有文件\"><a href=\"#3-在归档模式的RMAN备份与恢复案例-丢失所有文件\" class=\"headerlink\" title=\"3.在归档模式的RMAN备份与恢复案例-丢失所有文件\"></a>3.在归档模式的RMAN备份与恢复案例-丢失所有文件</h2><blockquote>\n<p> &emsp;&emsp;如果要创建正式库的备份，一般不建议用非归档模式备份，也不建议用很简单的命令来完成。而是更多的采用脚本实现归档模式备份，这样将可通过backup+archive log+redo有效的将数据恢复到最近一次改变的状态，可以达到数据的丢失最小化。</p>\n</blockquote>\n<ul>\n<li><p>创建归档模式备份</p>\n<blockquote>\n<p>&emsp;&emsp; 创建归档模式备份数据库必须处于归档(archivelog)模式，因为归档模式备份的数据库文件和控制文件的SCN号可能会不一致。<br>并且可以在数据库打开并不影响业务的情况下完成数据的备份工作；那么这样的备份将是归档模式的备份，那么如果要恢复可以通过backup+archive log+redo来恢复到最近一次日志切换时候的数据，而不是最后一次备份时候的数据。</p>\n</blockquote>\n</li>\n<li><p>寻找dbid</p>\n</li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--1.可以在查看数据库警告日志</span>\nvim <span class=\"token operator\">/</span>u01<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>diag<span class=\"token operator\">/</span>rdbms<span class=\"token operator\">/</span>orcl<span class=\"token operator\">/</span>orcl<span class=\"token operator\">/</span>trace<span class=\"token operator\">/</span>alert_orcl<span class=\"token punctuation\">.</span>log\n<span class=\"token comment\" spellcheck=\"true\">--2.在备份的控制文件中查找</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--3.用BBED在备份的文件中查找</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--4.在备份日志中查找 </span>\n\n<span class=\"token comment\" spellcheck=\"true\">--5.配置控制文件强制启动数据库</span>\n<span class=\"token comment\" spellcheck=\"true\">--5.1 添加一个参数文件</span>\n\n</code></pre>\n<h2 id=\"4-RMAN恢复案例-丢失单个数据文件如何恢复\"><a href=\"#4-RMAN恢复案例-丢失单个数据文件如何恢复\" class=\"headerlink\" title=\"4.RMAN恢复案例-丢失单个数据文件如何恢复\"></a>4.RMAN恢复案例-丢失单个数据文件如何恢复</h2><h2 id=\"5-RMAN恢复案例-丢失整个数据表空间如何恢复\"><a href=\"#5-RMAN恢复案例-丢失整个数据表空间如何恢复\" class=\"headerlink\" title=\"5.RMAN恢复案例-丢失整个数据表空间如何恢复\"></a>5.RMAN恢复案例-丢失整个数据表空间如何恢复</h2><h2 id=\"6-RMAN恢复案例-丢失SYSTEM表空间如何恢复\"><a href=\"#6-RMAN恢复案例-丢失SYSTEM表空间如何恢复\" class=\"headerlink\" title=\"6.RMAN恢复案例-丢失SYSTEM表空间如何恢复\"></a>6.RMAN恢复案例-丢失SYSTEM表空间如何恢复</h2><h2 id=\"7-RMAN恢复案例-丢失控制文件如何恢复\"><a href=\"#7-RMAN恢复案例-丢失控制文件如何恢复\" class=\"headerlink\" title=\"7.RMAN恢复案例-丢失控制文件如何恢复\"></a>7.RMAN恢复案例-丢失控制文件如何恢复</h2><h2 id=\"8-RMAN恢复案例-丢失参数文件如何恢复\"><a href=\"#8-RMAN恢复案例-丢失参数文件如何恢复\" class=\"headerlink\" title=\"8.RMAN恢复案例-丢失参数文件如何恢复\"></a>8.RMAN恢复案例-丢失参数文件如何恢复</h2><h2 id=\"9-RMAN恢复案例-丢失重做日志文件如何恢复\"><a href=\"#9-RMAN恢复案例-丢失重做日志文件如何恢复\" class=\"headerlink\" title=\"9.RMAN恢复案例-丢失重做日志文件如何恢复\"></a>9.RMAN恢复案例-丢失重做日志文件如何恢复</h2><h2 id=\"10-RMAN恢复案例-存储损坏数据丢失如何恢复\"><a href=\"#10-RMAN恢复案例-存储损坏数据丢失如何恢复\" class=\"headerlink\" title=\"10.RMAN恢复案例-存储损坏数据丢失如何恢复\"></a>10.RMAN恢复案例-存储损坏数据丢失如何恢复</h2><h2 id=\"11-RMAN恢复案例-不完全恢复\"><a href=\"#11-RMAN恢复案例-不完全恢复\" class=\"headerlink\" title=\"11.RMAN恢复案例-不完全恢复\"></a>11.RMAN恢复案例-不完全恢复</h2><h2 id=\"12-RMAN基于时间点-time-的不完全恢复\"><a href=\"#12-RMAN基于时间点-time-的不完全恢复\" class=\"headerlink\" title=\"12.RMAN基于时间点(time)的不完全恢复\"></a>12.RMAN基于时间点(time)的不完全恢复</h2><h2 id=\"13-RMAN基于系统改变号-scn-的不完全恢复\"><a href=\"#13-RMAN基于系统改变号-scn-的不完全恢复\" class=\"headerlink\" title=\"13.RMAN基于系统改变号(scn)的不完全恢复\"></a>13.RMAN基于系统改变号(scn)的不完全恢复</h2><h2 id=\"14-RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\"><a href=\"#14-RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\" class=\"headerlink\" title=\"14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\"></a>14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复</h2><h2 id=\"15-RMAN基于当前重做日志丢失的cancel不完全恢复\"><a href=\"#15-RMAN基于当前重做日志丢失的cancel不完全恢复\" class=\"headerlink\" title=\"15.RMAN基于当前重做日志丢失的cancel不完全恢复\"></a>15.RMAN基于当前重做日志丢失的cancel不完全恢复</h2><h2 id=\"16-RMAN基于备份控制文件不完全恢复\"><a href=\"#16-RMAN基于备份控制文件不完全恢复\" class=\"headerlink\" title=\"16.RMAN基于备份控制文件不完全恢复\"></a>16.RMAN基于备份控制文件不完全恢复</h2>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-Rman-的备份-（案列）\"><a href=\"#Oracle-Rman-的备份-（案列）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （案列）\"></a>Oracle Rman 的备份 （案列）</h1><p><a href=\"https://docs.oracle.com/cd/E11882_01/index.htm\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a></p>\n<h2 id=\"1-如何设计一个TB级数据库的RMAN备份策略\"><a href=\"#1-如何设计一个TB级数据库的RMAN备份策略\" class=\"headerlink\" title=\"1.如何设计一个TB级数据库的RMAN备份策略\"></a>1.如何设计一个TB级数据库的RMAN备份策略</h2><h3 id=\"1-1-TB以下\"><a href=\"#1-1-TB以下\" class=\"headerlink\" title=\"1.1 TB以下\"></a>1.1 TB以下</h3><ul>\n<li>用ORACLE即可实现（保存在磁盘上，5TB），也可以选择第三方备份软件 集中管理：</li>\n</ul>\n<blockquote>\n<p>1）RMAN全备：每周，每天；开归档模式<br>2）逻辑全导出：每周<br>3）归档备份（第三方管理）</p>\n</blockquote>\n<h3 id=\"1-2-TB以下\"><a href=\"#1-2-TB以下\" class=\"headerlink\" title=\"1.2 TB以下\"></a>1.2 TB以下</h3><ul>\n<li>用ORACLE+结合第三方软件（集中管理，带库，虚拟带库，大的备份存储，10TB）：</li>\n</ul>\n<blockquote>\n<p>1）RMAN全备：每周，开归档模式<br>2）归档备份：每天<br>3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。</p>\n</blockquote>\n<h3 id=\"1-3-2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\"><a href=\"#1-3-2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\" class=\"headerlink\" title=\"1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：\"></a>1.3 2TB以上（集中管理，虚拟带库，第三方备份介质，几十TB，压缩功能，重复删除）：</h3><blockquote>\n<p>1）RMAN全备：每周，开归档模式；每个月一次加每周增量。<br>2）归档备份：每天<br>3）逻辑导出：一个月只导一次结构就行了，或每天导一些重要的表。</p>\n</blockquote>\n<h3 id=\"1-4-备份案列\"><a href=\"#1-4-备份案列\" class=\"headerlink\" title=\"1.4 备份案列\"></a>1.4 备份案列</h3><ul>\n<li>环境</li>\n</ul>\n<blockquote>\n<p>ORACLE RMAN+存储备份（1TB）<br>数据库1TB，每天的归档量50GB</p>\n</blockquote>\n<ul>\n<li>备份策略</li>\n</ul>\n<blockquote>\n<p>每周5,20:00全备，保留2份。5TB<br>归档保留10天。 1TB<br>恢复，全备+归档。<br>逻辑全导出：每周 2TB</p>\n</blockquote>\n<ul>\n<li>备份脚本 rman_full_orcl.sh</li>\n</ul>\n<pre><code class=\"sql\">rman target / catalog rman/rman@rman msglog &#39;/u01/backup/logs/rman_full_itpux.log&#39; &lt;&lt; EOF\nrun {\n    CONFIGURE RETENTION POLICY TO REDUNDANCY 2;\n    allocate channel d1 type disk;\n    allocate channel d2 type disk;\n\n    setlimit channel d1 kbytes 102428750 maxopenfiles 32 readrate 200;\n    setlimit channel d2 kbytes 102428750 maxopenfiles 32 readrate 200;\n    sql &#39;alter system archive log current&#39;;\n    backup\n        incremental level 0\n        skip inaccessible\n        tag itpux_level0\n        filesperset 3\n        format &#39;/u01//backup/datafile/orcl_rman_full_%s_%p_%t&#39;\n        (database);\n    release channel d1;\n    release channel d2;\n\n    ALLOCATE CHANNEL d3 TYPE disk;\n        BACKUP\n            # recommended format\n            FORMAT &#39;/u01//backup/orcl_rman_cntrl_%s_%p_%t&#39;\n            CURRENT CONTROLFILE;\n    RELEASE CHANNEL d3;\n\n    ALLOCATE CHANNEL d4 TYPE DISK;\n        copy current controlfile to &#39;/u01//backup/datafile/control_itpux.bak&#39;;\n    RELEASE CHANNEL d4;\n}\n\nALLOCATE CHANNEL FOR MAINTENANCE DEVICE TYPE DISK;\nrun\n{\n    report obsolete;\n    DELETE noprompt EXPIRED BACKUP;\n    DELETE noprompt EXPIRED COPY;\n    delete noprompt obsolete device type disk;\n}\nexit\nEOF\n</code></pre>\n<ul>\n<li>删除归档 rman_delarch_orcl.sh</li>\n</ul>\n<pre><code class=\"sql\">rman target / catalog rman/rman@rman msglog &#39;/u01/backup/logs/rman_delarch_itpux.log&#39; &lt;&lt;EOF\nrun{\n    crosscheck archivelog all;\n    delete noprompt archivelog until time &quot;sysdate-7&quot;;\n    delete noprompt expired archivelog all;\n}\nexit\n\n</code></pre>\n<ul>\n<li>设置crontab</li>\n</ul>\n<pre><code class=\"sql\">00 5 * * * su - oracle -c /u01/backup/scripts/rman_delarch_orcl.sh\n00 18 * * 5 su - oracle -c /u01/backup/scripts/rman_full_orcl.sh\n</code></pre>\n<h2 id=\"2-在非归档模式的RMAN备份案例\"><a href=\"#2-在非归档模式的RMAN备份案例\" class=\"headerlink\" title=\"2.在非归档模式的RMAN备份案例\"></a>2.在非归档模式的RMAN备份案例</h2><blockquote>\n<p>&emsp;&emsp;备份分为一致性备份和不完全性备份，也就是我们所说的归档模式与非归档模式的备份.创建非归档备份可以是在非归档模式下创建，并且数据库必须处于mount状态下，而且恢复的时候值能恢复到最后一次备份的状态。也就说从备份到发生故障的这段时间都将丢失</p>\n</blockquote>\n<ul>\n<li>1.1. 检查归档状态</li>\n</ul>\n<pre><code class=\"sql\">archive log list;\n</code></pre>\n<ul>\n<li>1.2 将数据库启动到mount状态</li>\n</ul>\n<pre><code class=\"sql\">shutdown immediate\nstartup mount;\n</code></pre>\n<ul>\n<li>1.3 执行备份</li>\n</ul>\n<pre><code class=\"sql\">rman target /\nbackup database;\n</code></pre>\n<ul>\n<li>2.1 非归档模式备份</li>\n</ul>\n<pre><code class=\"sql\">shutdown immediate;\nstartup mount;\n\nrman target /\nbackup database;\n</code></pre>\n<ul>\n<li>3.1 归档模式</li>\n</ul>\n<pre><code class=\"sql\">alter database open\n</code></pre>\n<h2 id=\"3-在归档模式的RMAN备份与恢复案例-丢失所有文件\"><a href=\"#3-在归档模式的RMAN备份与恢复案例-丢失所有文件\" class=\"headerlink\" title=\"3.在归档模式的RMAN备份与恢复案例-丢失所有文件\"></a>3.在归档模式的RMAN备份与恢复案例-丢失所有文件</h2><blockquote>\n<p> &emsp;&emsp;如果要创建正式库的备份，一般不建议用非归档模式备份，也不建议用很简单的命令来完成。而是更多的采用脚本实现归档模式备份，这样将可通过backup+archive log+redo有效的将数据恢复到最近一次改变的状态，可以达到数据的丢失最小化。</p>\n</blockquote>\n<ul>\n<li><p>创建归档模式备份</p>\n<blockquote>\n<p>&emsp;&emsp; 创建归档模式备份数据库必须处于归档(archivelog)模式，因为归档模式备份的数据库文件和控制文件的SCN号可能会不一致。<br>并且可以在数据库打开并不影响业务的情况下完成数据的备份工作；那么这样的备份将是归档模式的备份，那么如果要恢复可以通过backup+archive log+redo来恢复到最近一次日志切换时候的数据，而不是最后一次备份时候的数据。</p>\n</blockquote>\n</li>\n<li><p>寻找dbid</p>\n</li>\n</ul>\n<pre><code class=\"sql\">--1.可以在查看数据库警告日志\nvim /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log\n--2.在备份的控制文件中查找\n\n--3.用BBED在备份的文件中查找\n\n--4.在备份日志中查找 \n\n--5.配置控制文件强制启动数据库\n--5.1 添加一个参数文件\n\n</code></pre>\n<h2 id=\"4-RMAN恢复案例-丢失单个数据文件如何恢复\"><a href=\"#4-RMAN恢复案例-丢失单个数据文件如何恢复\" class=\"headerlink\" title=\"4.RMAN恢复案例-丢失单个数据文件如何恢复\"></a>4.RMAN恢复案例-丢失单个数据文件如何恢复</h2><h2 id=\"5-RMAN恢复案例-丢失整个数据表空间如何恢复\"><a href=\"#5-RMAN恢复案例-丢失整个数据表空间如何恢复\" class=\"headerlink\" title=\"5.RMAN恢复案例-丢失整个数据表空间如何恢复\"></a>5.RMAN恢复案例-丢失整个数据表空间如何恢复</h2><h2 id=\"6-RMAN恢复案例-丢失SYSTEM表空间如何恢复\"><a href=\"#6-RMAN恢复案例-丢失SYSTEM表空间如何恢复\" class=\"headerlink\" title=\"6.RMAN恢复案例-丢失SYSTEM表空间如何恢复\"></a>6.RMAN恢复案例-丢失SYSTEM表空间如何恢复</h2><h2 id=\"7-RMAN恢复案例-丢失控制文件如何恢复\"><a href=\"#7-RMAN恢复案例-丢失控制文件如何恢复\" class=\"headerlink\" title=\"7.RMAN恢复案例-丢失控制文件如何恢复\"></a>7.RMAN恢复案例-丢失控制文件如何恢复</h2><h2 id=\"8-RMAN恢复案例-丢失参数文件如何恢复\"><a href=\"#8-RMAN恢复案例-丢失参数文件如何恢复\" class=\"headerlink\" title=\"8.RMAN恢复案例-丢失参数文件如何恢复\"></a>8.RMAN恢复案例-丢失参数文件如何恢复</h2><h2 id=\"9-RMAN恢复案例-丢失重做日志文件如何恢复\"><a href=\"#9-RMAN恢复案例-丢失重做日志文件如何恢复\" class=\"headerlink\" title=\"9.RMAN恢复案例-丢失重做日志文件如何恢复\"></a>9.RMAN恢复案例-丢失重做日志文件如何恢复</h2><h2 id=\"10-RMAN恢复案例-存储损坏数据丢失如何恢复\"><a href=\"#10-RMAN恢复案例-存储损坏数据丢失如何恢复\" class=\"headerlink\" title=\"10.RMAN恢复案例-存储损坏数据丢失如何恢复\"></a>10.RMAN恢复案例-存储损坏数据丢失如何恢复</h2><h2 id=\"11-RMAN恢复案例-不完全恢复\"><a href=\"#11-RMAN恢复案例-不完全恢复\" class=\"headerlink\" title=\"11.RMAN恢复案例-不完全恢复\"></a>11.RMAN恢复案例-不完全恢复</h2><h2 id=\"12-RMAN基于时间点-time-的不完全恢复\"><a href=\"#12-RMAN基于时间点-time-的不完全恢复\" class=\"headerlink\" title=\"12.RMAN基于时间点(time)的不完全恢复\"></a>12.RMAN基于时间点(time)的不完全恢复</h2><h2 id=\"13-RMAN基于系统改变号-scn-的不完全恢复\"><a href=\"#13-RMAN基于系统改变号-scn-的不完全恢复\" class=\"headerlink\" title=\"13.RMAN基于系统改变号(scn)的不完全恢复\"></a>13.RMAN基于系统改变号(scn)的不完全恢复</h2><h2 id=\"14-RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\"><a href=\"#14-RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\" class=\"headerlink\" title=\"14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复\"></a>14.RMAN基于部分数据文件与部分归档丢失的cancel不完全恢复</h2><h2 id=\"15-RMAN基于当前重做日志丢失的cancel不完全恢复\"><a href=\"#15-RMAN基于当前重做日志丢失的cancel不完全恢复\" class=\"headerlink\" title=\"15.RMAN基于当前重做日志丢失的cancel不完全恢复\"></a>15.RMAN基于当前重做日志丢失的cancel不完全恢复</h2><h2 id=\"16-RMAN基于备份控制文件不完全恢复\"><a href=\"#16-RMAN基于备份控制文件不完全恢复\" class=\"headerlink\" title=\"16.RMAN基于备份控制文件不完全恢复\"></a>16.RMAN基于备份控制文件不完全恢复</h2>"},{"title":"Oracle Rman 备份1","date":"2018-10-04T02:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"<!-- cover":"false -->","<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n# Oracle Rman 的备份 （基础）\n\n\n [Oracle 11G R2 官方文档][1] \n## 1. RMAN作用与体系架构\n\n## 2. nocatalog 余catalog 的介绍与catalog的配置\n\n### 2.1 nocatalog介绍\n>&emsp;&emsp;nocatalog方式 就是用control file作为catalog，每一次备份都要往控制文件里面写好多备份信息，控制文件里面会有越来越多的备份信息。因此，当使用rman nocatalog方式备份时，备份controlfile是非常重要的。\n\n>&emsp;&emsp;由于nocatalog时利用controlfile存放备份信息，建议将oracle参数文件中的control_file_record_keep_time值加大（缺省为7天）, 参数在$oracle_home/dbs/initsid.ora中，该参数control_file__record_keep_time设置备份信息保存时间，到规定时间就自动清除以前的备份信息。\n\n```sql\n--查看参数\nshow parameter control\n--修改时间为半个月\nalter system set control_file_record_keep_time=14 scope=both;\n--查看参数\nselect name,value,issys_modifiable from v$parameter where name='control_file_record_keep_time';\n```\n\n### 2.2 catalog介绍\n>&emsp;&emsp;恢复目录存储的是与rman 备份有关的元数据。在某种意义上，恢复目录可以看做是保存rman备份和恢复所需的相关信息的副本。\n>&emsp;&emsp;我们可以在oracle 数据库中在用户模式下创建恢复目录，这个恢复目录仅仅是一些数据包，表，索引和视图。\n>&emsp;&emsp;rman中的再同步命令会使得目标数据库控制文件中的内容刷新这些表中的数据。当然，区别在于恢复目录可以包含企业中所有数据库的信息，而控制文件只包含关于它自己的数据库的信息。\n\n### 2.3 catalog恢复目录的配置过程\n\n* 创建时需要的表空间\n```sql\ncreate tablespace rman_tbs \n\tdatafile '/u01/app/oracle/oradata/orcl/rman_tbs.dbf'\n\tsize 1G \n\tautoextend off;\n```\n\n* 创建用户并授权\n```sql\ncreate user rman \n\tidentified by rman \n\tdefault tablespace rman_tbs;\n\t\ngrant connect,resource,recovery_catalog_owner to rman;\n```\n\n* 创建恢复目录\n```sql\nrman catalog rman/rman\ncreate catalog tablespace rman_tbs;\n--注意这里tablespace不能为rman\n```\n* 配置rman 专用的监听\n```sql\nrman =\n\t(description =\n\t\t(address_list =\n\t\t\t(address = (protocol = tcp)(host = orcl)(port = 1521))\n\t\t)\n\t\t(connect_data =\n\t\t\t(sid = orcl)\n\t\t)\n\t)\n```\n\n## 3. 详解 RMAN 的使用\n### 3.1 设置环境变量\n\n>&emsp;&emsp;  修改oracle用户环境变量为如下，在linux系统中还有一个rman命令不是oracle的，如果在win环境下，可以直接使用cmd。\npath=$oracle_home/bin:/sbin:$path\n才可以使用rman命令\n\n### 3.2 rman命令的帮助\n```sql\nArgument     Value          Description\n-----------------------------------------------------------------------------\ntarget       quoted-string  connect-string for target database\ncatalog      quoted-string  connect-string for recovery catalog\nnocatalog    none           if specified, then no recovery catalog\ncmdfile      quoted-string  name of input command file\nlog          quoted-string  name of output message log file\ntrace        quoted-string  name of output debugging message log file\nappend       none           if specified, log is opened in append mode\ndebug        optional-args  activate debugging\nmsgno        none           show RMAN-nnnn prefix for all messages\nsend         quoted-string  send a command to the media manager\npipe         string         building block for pipe names\ntimeout      integer        number of seconds to wait for pipe input\nchecksyntax  none           check the command file for syntax errors\n-----------------------------------------------------------------------------\nBoth single and double quotes (' or \") are accepted for a quoted-string.\nQuotes are not required unless the string contains embedded white-space.\n```\n### 3.3 rman连接信息介绍\n* 连接到目标数据库\n```sql\nrman>connect target user/pwd@db_name\n```\n* 注意\n>1、connect不能简写为conn\n2、连接user必须具备sysdba权限\n3、连接的db_name必须在tnsnames.ora中有配置，且有效(即通过sqlplus可以连接）\n4、target database必须为archivelog 模式\n5、如果是本地可以采用os认证，如果是远程需要使用密码文件认证。\n6、rman工具版本与目标数据库必须是同一版本。\n\n### 3.4 在rman里执行操作系统命令\n```sql\nrman> run{host \"ls -artl\";}\nrman> run{host \"ifconfig\";}\nrman> run{host \"pwd\";}\n/home/oracle\nhost commandcomplete\nrman> run{host \"ls\";}\nrman> exit\n```\n### 3.5 在rman里执行数据库命令及sql语句\n```sql\nrman> shutdown immediate\nrman> startup\nrman> sql 'select * fromuser_tablespaces';\n```\n### 3.6 在rman中保存脚本或执行脚本\n>在RMAN中，我们可以创建一个命令文件，里面包含rman命令，然后在RMAN的中调用这个文件。如：\nRman target usr/pwd cmdfile=backup.cmd\n或者，也可以直接在RMAN 中直接运行\n\n* 创建存储的脚本\n>使用create script RMAN 命令可以在恢复目录中存储脚本。 创建每个存储的脚本时，都要为脚本指定一个名称。 可以创建执行数据库备份，恢复和维护操作的脚本。在脚本中，RMAN 允许使用comment 参数存储与存储脚本相关的注释。 注意： 必须连接到恢复目录。 如：\n```sql\nRMAN> create script my_backup_script\ncomment 'itpux'\n{\n\tbackup database plus archivelog;\n}\n```\n* 修改存储脚本\n>使用replace script 命令可以替换恢复目录中的存储脚本。\n```sql\nRMAN> replace script my_backup_script\ncomment 'bl'\n{\n\tbackup database plus archivelog delete input;\n}\n```\n* 删除存储脚本\n>使用delete script命令可以删除一个存储脚本。\n```sql\nRMAN> Delete script my_backup_script;\n```\n* 使用存储脚本\n>创建一些存储过程脚本后，可以执行execute script命令来使用这些脚本。如：\n```sql\nrun { execute script my_backup_script; }\n```\n\n* 打印存储的脚本\n```sql\nRMAN> Print script my_backup_script;\n正在打印存储的脚本: my_backup_script\n{backup database plus archivelog;}\n```\n\n>还可以使用RC_STORED_SCRIPT_LINE恢复目录视图来显示存储的脚本的内容，如：\n```sql\nSQL> select script_name,text from rc_stored_script_line order by script_name,line;\nSCRIPT_NAME TEXT\n------------------------------ -------------------------------------------------\nmy_backup_script {\n\tmy_backup_script backup database plus archivelog delete input;\nmy_backup_script }\n```\n### 3.7 查看并修改单个参数\n```sql\nrman> show all;\nusing target database control file instead of recoverycatalog\nrman configuration parameters are:\n```\n### 3.8 查看并修改单个参数\n```sql\nrman>show retention policy;\nrman>show backup optimization;\nrman>show controlfile autobackup; -----查看当前参数的值，是off。\nrman>configure controlfile autobackup on; --修改为on，自动备份控制文件\nrman> show controlfile autobackup; ---查看修改后的，已经修改成功。\nrman> configurechannel 1 device type disk format '/dbbak/bak_%d_%m_%d_%u'; --注释：配置数据文件的备份路径.\nrman> configurecontrolfile autobackup format for device type disk to '%f'; 注释：配置控制文件的备份路径\nrman> show all; ------查看所有信息，看到已经更改了默认备份路径\n```\n### 3.8 备份文件的格式\n```sql\n备份文件可定义的格式符号如下\n使用format参数时可使用的各种替换变量，如下（注意大小写）所示：\n%a：Oracle数据库的activation ID即RESETLOG_ID。\n%c：备份片段的复制数（从1开始编号，最大不超过256）。\n%d：Oracle数据库名称。\n%D：当前时间中的日，格式为DD。\n%e：归档序号。\n%f：绝对文件编号。\n%F：基于\"DBID+时间\"确定的唯一名称，格式的形式为c-IIIIIIIIII-YYYYMMDD-QQ,其中IIIIIIIIII 为该数据库的DBID，YYYYMMDD为日期，QQ是一个1～256的序列。\n%h：归档日志线程号。\n%I：Oracle数据库的DBID。\n%M：当前时间中的月，格式为MM。\n%N：表空间名称。\n%n：数据库名称，并且会在右侧用x字符进行填充，使其保持长度为8。比如数据库名JSSBOOK，则生成的名称则是JSSBOOKx。\n%p：备份集中备份片段的编号，从1开始。\n%s：备份集号。\n%t：备份集时间戳。\n%T：当前时间的年月日格式（YYYYMMDD）。\n%u：是一个由备份集编号和建立时间压缩后组成的8字符名称。利用%u可以为每个备份集生成一个唯一的名称。\n%U：默认是%u_%p_%c的简写形式，利用它可以为每一个备份片段（即磁盘文件）\n```\n### 3.9 详解整个rman全备案例\n>执行rman备份必须开启数据的归档功能：\n```sql\nsql> shutdown immediate ---关闭数据库\nsql> startup mount; ----启动数据库到mount状态\nsql> alter database archivelog; ---开启归档功能\ndatabase altered.\nsql> archivelog list; ---查看归档状态\ndatabase logmode archive mode ---归档已经打开\nautomatic archival enabled\narchive destination use_db_recovery_file_dest\noldest online logsequence 8\nnext log sequence toarchive 10\ncurrent log sequence 10\nsql>\n```\n\n\n## 4. 详解 RMAN的常用命令及日常维护\n### 4.1 rman所备份的数据库信息查看\n* 01. list incarnation\n>概述可用的备份\n>b 表示backup\na 表示archivelog、 f 表示full backup、 0,1,2 表示incremental level备份\na 表示可用avaliable、 x 表示expired\n\n>这个命令可以派生出很多类似命令，例如\n>list backup of database summary\nlist backup of archivelog all summary\nlist backup of tablespace users summary;\nlist backup of datafile n,n,n summary\n* 02. list backup summary;\n> 列出过期的备份文件\n\n* 03. list backup by file;\n> 按照文件类型分别列出\n> 分别为：数据文件列表、归档日志列表、控制文件列表、spfile列表\n\n* 04. list backup\n> 这个命令列出已有备份集的详细信息。\n\n* 05. list expired backup;\n> 列出过期的备份文件\n\n* 06. list copy;\n>列出copy文件\n```sql\nlist copy of database;\nlist copy of controlfile;\nlist copy of tablespace users;\nlist copy of datafile n,n,n;\nlist copy of archivelog all;\nlist copy of archivelog from scn 10000;\nlist copy of archivelog until sequence 12;\n```\n* 07. list backup of spfile;\n>服务器参数文件\n\n* 08. list backup of controlfile;\n> 控制文件\n\n* 09. list backup of datafle n,n,n,n;\n> 数据文件\n\n* 10. list backup of tablespace tablespace_name;\n> 表空间对应的backup\n\n* 11. 归档日志\n```sql\nlist backup of archivelog {all, from, high, like, logseq, low, scn, sequence, time, until};\nlist backup of archivelog all;\nlist backup of archivelog until time 'sysdate-1';\nlist backup of archivelog from sequence 10;\nlist backup of archivelog until sequence 10;\nlist backup of archivelog from scn 10000;\nlist backup of archivelog until scn 200000;\nlist archivelog from scn 1000;\nlist archivelog until scn 2000;\nlist archivelog from sequence 10;\nlist archivelog until sequence 12;\n```\n\n### 4.2 report常用命令\n>report用于判断数据库当前可恢复状态、以及数据库已有备份的信息。\n\n* 01.report schema\n> 报告数据库模式\n\n* 02.report obsolete;\n> 报告已丢弃的备份集(配置了保留策略)。\n\n* 03.report unrecoverable;\n> 报告当前数据库中不可恢复的数据文件(即没有这个数据文件的备份、或者该数据文件的备份已经过期)\n\n* 04.report need backup;\n> 报告需要备份的数据文件(根据条件不同)\n```sql\nreport need backup days=3;\n--最近三天没有备份的数据文件(如果出问题的话，这些数据文件将需要最近3天的归档日志才能恢复)\nreport need backup incremental=3;\n--需要多少个增量备份文件才能恢复的数据文件。(如果出问题，这些数据文件将需要3个增量备份才能恢复)\nreport need backup redundancy=3;\n--报告出冗余次数小于3的数据文件\n--例如数据文件中包含2个数据文件system01.dbf和users01.dbf.\n--在3次或都3次以上备份中都包含system01.dbf这个数据文件，而users01.dbf则小于3次\n--那么，报告出来的数据文件就是users01.dbf\n--即，报告出数据库中冗余次数小于 n 的数据文件\nreport need backup recovery window of 2 days;\n--报告出恢复需要2天归档日志的数据文件\n```\n\n### 4.3 backup常用命令\n#### 4.3.1 基本使用\n* 01.设置备份标记\n\n* 01.设置备份集大小(一次备份的所有结果为一个备份集，要注意备份集大小)\n\n* 01.设置备份片大小(磁带或文件系统限制)\n\n* 01.备份集的保存策略\n\n* 01.重写configure exclude命令\n\n* 01.检查数据库错误\n\n* 01.跳过脱机，不可存取或只读文件\n\n\n* 01.强制备份\n\n* 01.基于上次备份时间备份数据文件\n\n* 01.备份操作期间检查逻辑错误\n\n* 01.生成备份副本\n\n* 01.备份控制文件和参数文件\n\n* 01.跳过脱机的，不可读取的或者只读的数据文件\n\n* 01.数据库备份\n\n* 01.表空间备份\n\n* 01.数据文件备份\n\n* 01.归档的重做日志备份\n\n* 01.数据库，表空间和数据文件的映像副本\n\n* 01.控制文件副本\n\n* 01.Archivelog 映像副本\n\n* 01.差异备份与增量备份\n\n#### 4.3.1 差异备份与增量备份\n* 块更改跟踪文件\n>&emsp;&emsp;默认情况下，当执行增量备份时，发生任何更改的所有数据文件都将备份。 这可能使增量备份花费更长的时间，并且会增加增量备份的大小。 10g中RMAN 提供了只备份更改过的数据块的功能。 这就可以加快增量数据库备份的速度并减少其大小。 执行alter database enable block change tracking 命令可以启用块更改跟踪。\n&emsp;&emsp;如果使用Oracle管理文件（OMF），Oracle 将会创建块更改跟踪文件。 如果没有使用OMF，则必须定义块更改跟踪文件的位置和名称。 如：\nAlter database enable block change tracking using file '/oracle/backup/block.fil';\n&emsp;&emsp;如果跟踪文件已经存在，可以使用reuse参数：\nAlter database enable block change tracking using file '/oracle/backup/block.fil' reuse;\n&emsp;&emsp;使用alter database block change tracking 命令可以禁用块更改跟踪。 块更改跟踪文件的大小通常预先分片且与数据库大小和重做日志线程的数量有关。 块更改跟踪文件的大小一般是数据库大小的1/30000。 块更改跟踪文件可能会以10MB为增量增长。 块更改跟踪文件的最小尺寸是每个数据文件320k，如果有许多数据文件，则块更改跟踪文件就会较大。 Oracle 会在块更改跟踪文件中存储足够的信息，从而允许最多8天的增量备份。 显而易见，如果增量备份超过8天，则将不使用块跟踪更改跟踪文件，并且无法利用块跟踪文件的有点。\n&emsp;&emsp;可以通过检查v$block_change_tracking 视图来确定是否启用了块更改跟踪。 Status 指示了是否启用了块更改跟踪，filename 包含块更改跟踪文件的文件名。可以通过alter database rename file 命令来转移块更改跟踪文件。\n```sql\nSQL> select status,filename from v$block_change_tracking;\nSTATUS FILENAME\n---------- ------------------------------------------------------\nENABLED /oracle/BACKUP/BLOCK.FIL\n```\n* 基本备份\n>&emsp;&emsp;执行增量备份操作时，首先需要的是增量基本备份（incremental base backup）,以后所有的增量备份都基于这个基本备份。 每次执行数据库备份操作时，都可以通过backup 命令的incremental 参数来为备份指定一个增量级别标识符。 基本备份的增量级别为0，并且必须有基本备份才能够执行其他类型的增量备份操作。 如果没有生成基本备份就尝试执行增量备份操作，RMAN会自动执行基本备份操作。 示例：\n```sql\nBackup incremental level=0 database;\n```\n* 差异备份\n>&emsp;&emsp;差异备份是RMAN生成的增量备份的默认类型，对于差异备份来说，RMAN会备份自上次同级或者低级差异增量备份以来所发生变化的数据块\n```sql\nbackup incremental level=1 database;\n```\n* 累积备份\n>&emsp;&emsp;累积备份可以使备份集备份前面所有级别的备份以及此次要备份的所有发生变化的数据块。 累积备份是一个可选的备份方法，并要求在backup 命令中使用cumulative 关键字。\n```sql\nbackup incremental level =2 cumulative database;\n```\n* 增量备份选项\n>&emsp;&emsp;Oracle 不仅允许执行数据库的增量备份，还允许执行表空间，数据文件以及数据库文件副本的增量备份操作。 控制文件，归档重做日志以及备份集都不能生成增量备份。 此外，还可以在执行增量备份操作时同时备份归档的重做日志。\n```sql\nBackup incremental level=0 tablespace users;\nBackup incremental level=1 tablespace users;\nBackup incremental level=0 datafile 4;\nBackup incremental level=1 datafile 4;\nBackup incremental level=1 database plus archivelog;\n```\n* 增量备份更新备份\n>RMAN 提供了增量备份更新备份。 这种备份避免了采用数据文件的完整映像副本进行备份的开销，并且具有与映像副本相同的恢复特性。 从某种意义上来说，这种备份类似与使用映像副本的增量备份。\n```sql\nRun{\nRecover copy of database with tag 'Orcl';\nBackup incremental level 1 for recover of copy with tag 'Orcl' database;\n}\n```\n>&emsp;&emsp;示例中的recover of copy database 命令并没有真正的恢复数据库，但它使RMAN将任何增量备份应用于与列出标记（Orcl）关联的数据文件副本。 第一次运行该命令时，它将没有任何效果，因为它没有任何可用的增量备份或数据文件副本。 这并不是很严重的问题，并且RMAN 将只显示一条警告消息。 第二次运行该命令时也没有任何效果，因为没有任何增量备份可用。\n&emsp;&emsp;执行recover 命令后，就会产生一个增量备份，这个备份第一次运行时，它会创建一个基本备份（如果没有的话）。这实际上增量为1的备份。 第二次执行这个run代码块时，将通过backup 命令执行第一个增量备份。\n&emsp;&emsp;一旦该命令运行了2次，第三次执行和后面的执行就能够将前面的增量备份应用与数据文件副本。 注意，recover 和backup命令中将标记赋予相同的名称非常重要。\n\n### 4.4 configure常用命令\n\n* 01. 显示当前的配置信息\n```sql\nrman> show all;\nrman 配置参数为:\nconfigure retention policy to redundancy 1; # default\nconfigure backup optimization off; # default\nconfigure default device type to disk; # default\nconfigure controlfile autobackup off; # default\nconfigure controlfile autobackup format for device type disk to '%f'; # default\nconfigure device type disk parallelism 1 backup type to backupset; # default\nconfigure datafile backup copies for device type disk to 1; # default\nconfigure archivelog backup copies for device type disk to 1; # default\nconfigure maxsetsize to unlimited; # default\nconfigure encryption for database off; # default\nconfigure encryption algorithm 'aes128'; # default\nconfigure archivelog deletion policy to none; # default\nconfigure snapshot controlfile name to '/oracle/product/11.2.0/db_1/database/sncfitpuxdb.ora'; # default\nconfigure retention policy to redundancy 1; # default\n注释：配置redundancy配置需要保留几份备份文件，默认是1。也可以改变为其它非零的正整数值。\nconfigure backup optimization off; # default\n注释：设备备份优化打开，如果表空间是只读状态，那么在做备份的时候只是第一次会备份，以后不备份。有两个选项off关闭和on打开\nconfigure default device type to disk; # default\n注释：配置默认备份设备可以是sbt（磁带），disk（硬盘）；默认是硬盘\nconfigure controlfile autobackup off;# default\n注释：配置在备份的时候是否将控制文件一并备份，两个选项,默认是off不备份，也可以是on备份、。\nconfigure controlfile autobackupformat for device type disk to '%f'; # default\n注释：配置control file自动备份的路径和文件格式\nconfigure device type disk parallelism1 backup type to backupset; # default\n注释：配置磁盘备份的类型，默认是备份集方式（backupset）或镜像拷贝也叫文件拷贝(copy)。\n镜像拷贝值适用于磁盘备份，磁带只支持备份集。一般用备份集更多，其效率会更高\nconfigure datafile backupcopies for device type disk to 1; # default\n注释：配置生成备份集的个数，默认是1；备份集内会包括（数据文件，控制文件，参数文件）\nconfigure archivelog backupcopies for device type disk to 1; # default\n注释：配置归档日志默认的备份路径\nconfigure maxsetsize to unlimited; # default\n注释：配置单个备份集大小，缺省是不限制，我们可以配置成1g/100m/1024k or other\nconfigure encryption for database off; # default\n注释：配置备份数据加密，是10gr2推出来的新功能，设置为on后。\n可以set encryption on identifyed by youpassword only;加密备份，还原的时候需要提供密码。\nconfigureencryption algorithm 'aes128'; # default\n注释：指定备份数据加密的类型。\nconfigure archivelogdeletion policy to none; # default\n注释：配置归档日志在备份后自动删除\nconfigure snapshot controlfile name to '/oracle/product/10.2.0/db_1/dbs/snapcf_itpuxdb.f'; # default\n注释：配置控制文件快照，可以有效的提高控制文件的恢复性。\n查询rman设置中非默认值:\nsql> select name,value from v$rman_configuration;\n```\n* 01. 保存策略 (retention policy)\n```sql\nconfigure retention policy to recovery window of 7 days;\nconfigure retention policy to redundancy 5;\nconfigure retention policy clear;\nconfigure retention policy to none;\n第一种recover window是保持所有足够的备份，可以将数据库系统恢复到最近七天内的任意时刻。任何超过最近七天的数据库备份将被标记为obsolete。\n第二种redundancy 是为了保持可以恢复的最新的5份数据库备份，任何超过最新5份的备份都将被标记为redundancy。它的默认值是1份。\n第三、四：none 可以把使备份保持策略失效，clear 将恢复默认的保持策略\n一般最安全的方法是采用第二种保持策略。\n```\n* 01. 备份优化 backup optimization\n```sql\nconfigure backup optimization on;\nconfigure backup optimization off;\nconfigure backup optimization clear;\n默认值为关闭，如果打开，rman将对备份的数据文件及归档等文件进行一种优化的算法。\n```\n* 01. 默认设备 default device type\n```sql\nconfigure default device type to disk;\nconfigure default device type to stb;\nconfigure default device type clear;\n是指定所有i/o操作的设备类型是硬盘或者磁带，默认值是硬盘\n磁带的设置是configure default device type to sbt;\n```\n* 01. 控制文件 controlfile\n```sql\nconfigure controlfile autobackup on;\nconfigure controlfile autobackup format for device type disk to '/oracle/backup/conf_%F';\nconfigure controlfile autobackup clear;\nconfigrue controlfile autobackup format for device type disk clear;\nCONFIGURE SNAPSHOT CONTROLFILE NAME TO '/oracle/backup/scontrofile.snp';\n--是配置控制文件的快照文件的存放路径和文件名，这个快照文件是在备份期间产生的，用于控制文件的读一致性。\nconfigure snapshot controlfile name clear;\n强制数据库在备份文件或者执行改变数据库结构的命令之后将控制文件自动备份，默认值为关闭。这样可以避免控制文件和catalog丢失后，控制文件仍然可以恢复。\n```\n* 01. 并行数(通道数) device type disk|stb pallelism n;\n```sql\nconfigure device type disk|stb parallelism 2;\nconfigure device type disk|stb clear; --用于清除上面的信道配置\nconfigure channel device type disk format '/oracle/backup/rman_%u';\nconfigure channel device type disk maxpiecesize 100m;\nconfigure channel device type disk rate 1200k;\nconfigure channel 1 device type disk format '/oracle/backup/rman_%u';\nconfigure channel 2 device type disk format '/oracle/backup/rman_%u';\nconfigure channel 1 device type disk maxpiecesize 100m;\n配置数据库设备类型的并行度。\n```\n* 01. 生成备份副本 datafile|archivelog backup copies\n```sql\nconfigure datafile backup copies for device type disk|stb to 3;\nconfigure archivelog backup copies for device type disk|stb to 3;\n--是设置数据库的归档日志的存放设备类型\nconfigure datafile|archivelog backup copies for device type disk|stb clear\nbackup device type disk database format '/oracle/backup1/%u', '/oracle/backup2/%u', '/oracle/backup3/%u';\n是配置数据库的每次备份的copy数量，oracle的每一次备份都可以有多份完全相同的拷贝。\n```\n* 01. 排除选项 exclude\n```sql\nconfigure exclude for tablespace USERS;\nconfigure exclude for tablespace USERS clear;\n```\n* 01. 备份集大小 maxsetsize\n```sql\nconfigure maxsetsize to 1g|1000m|1000000k|unlimited;\nconfigure maxsetsize clear;\n```\n\n### 4.5 set 命令\n>&emsp;&emsp;使用set 命令可以定义只应用于当前RMAN会话的设置。 set 命令的设置不是永久的，根据实际需求，可以采用两种方式来使用set 命令。\n* 在run 代码块外，我们可是执行下面的操作：\n```sql\n（1）使用set echo 命令在消息日志中显示RMAN 命令。\n（2）使用set dbid 命令指定一个数据库的数据库标识符（database identifier： dbid）。\n```\n\n* 某些set 命令只能在run代码块的限定范围内使用，常见的有：\n>（1）set newname 命令：用于执行表空间时间点恢复（TSPITR）或者数据库复制操作。 该命令允许指定新的数据库数据文件名。 将数据库移动到新的系统中并且文件系统名不同时，我们可以使用这个命令。使用set newname 命令时还需要使用switch 命令。\n（2）set maxcorrupt for datafile: 使用该命令可以定义RMAN操作失败前锁允许的数据块讹误的最大数据。\n（3）set archivelog destination: 使用该命令可以修改存储归档的重做日志的archive_log_dest_1 目标。\n（4）set 命令和until 子句： 使用set命令和set 命令的until 子句可以定义数据库时间点恢复操作锁使用的具体时间点，SCN 或日志序列号。\n（5）set backup copies命令： 使用该命令可以定义为备份集中的每个备份片应当创建的副本数。\n（6）set command id: 使用该命令可以关联给定的服务器会话和给定的通道。\n（7）set controlfile autoback format for device type: 使用该命令可以修改用于控制文件自动备份操作的默认格式。\n\n>&emsp;&emsp;例如： 要执行一个为每个备份片创建两个副本的被操作，并且允许数据文件的最大讹误数为10. 脚本如下：\n\n```sql\nrun{\n\tset maxcorrupt for datafile 3 to 5;\n\tset backup copies=2;\n\tbackup database;\n}\nset until time \"to_date('2016-6-28 17:04:00','yyyy-mm-dd hh24:mi:ss')\";\n```\n### 4.5 crosscheck命令\n\n* 交叉效验RMAN 备份\n>&emsp;&emsp;在RMAN目录和物理备份目的地不同步的情况下，我们可以使用crosscheck命令来效验控制文件或恢复目录中的RMAN信息是否与备份介质上的实际物理备份集片相同。\n>&emsp;&emsp;使用crosscheck 命令时，我们关心每个备份集或者副本的状态。 如果使用控制文件，用于备份集片的v$backup_set 视图和用于副本的v$databfile_copy 视图中的status列列出了每个备份集或副本的状态码；如果使用恢复目录，则在备份集片的RC_BACKUP_set和副本的RC_DATAFILE_COPY中列出了每个备份集或副本的状态码。 在不同的备份状态码中，我们关心以下两种状态：\n>&emsp;&emsp;（1）A（Available:可用）：RMAN 认定该项存在于备份介质上\n&emsp;&emsp;（2）X（Expired:不可用）：这个备份集片或副本上存储的RMAN目录（即控制文件或恢复目录）中，但是并没有物理存在于备份介质上。\n>&emsp;&emsp;使用crosscheck 命令的目的是将RMAN目录的状态设置为AVAILABLE或者EXPIRED。 执行crosscheck时，RMAN检查目录中列出的每个备份集或副本并且判断他们是否存在与备份介质上。 如果备份集或副本不存在与备份介质上，它就会被标记为expired, 并且不能用于任何还原操作；如果备份集或副本存在与备份介质上，它就会维持available状态。 如果以前被标记为expired 的备份集或副本再次存在于备份介质上，crosscheck 命令就会将它标记回available。\n```sql\ncrosscheck backup;\n```\n> &emsp;&emsp;可以交叉效验数据文件备份，表空间备份，控制文件备份以及服务器参数文件备份。此外，可以通过识别与备份相关联的标记来选择要交叉效验和特定的备份。 基于使用的设备或者基于一个时间周期，我们甚至可以交叉效验所有的备份。 如：\n```sql\ncrosscheck backup of datafile 1;\ncrosscheck backup of tablespace users;\ncrosscheck backup of controlfile;\ncrosscheck backup of spfile;\ncrosscheck backup tag='TEST';\ncrosscheck backup completed after 'sysdate-2';\ncrosscheck backup completed between 'sysdate-5' and 'sysdate-2';\ncrosscheck backup device type disk;\n```\n* 交叉验证归档日志示例：\n```sql\nRMAN> crosscheck archivelog all;\n```\n>&emsp;&emsp;我们可以基于一个号码或标准（包括时间，具体的或指定范围的SCN或日志序列号）来交叉效验归档的重做日志备份，甚至还可以使用like参数与通配符来交叉效验特定的归档日志备份。 如：\n```sql\ncrosscheck archivelog like 'ARC001.log';\ncrosscheck archivelog '/oracle/arch/itpuxdb/archivelog/2016_08_02/o1_mf_1_22_cszw2d4g_.arc';\ncrosscheck archivelog like '%ARC00012.LOG';\ncrosscheck archivelog from time \"to_date('2016-08-02','yyyy-mm-dd')\";\ncrosscheck archivelog until time \"to_date('2016-08-02','yyyy-mm-dd')\";\ncrosscheck archivelog from sequence 12;\ncrosscheck archivelog until sequence 522;\n--使用crosscheck copy命令还可以交叉效验副本。 包括数据文件副本，控制文件副本，归档重做日志副本以及磁盘上的归档的重做日志。 如：\ncrosscheck copy of datafile 5;\ncrosscheck datafilecopy '/oracle/oradata/itpuxdb/rman_tbs.dbf;\n```\n\n### 4.6 RMAN 备份的验证validate\n>&emsp;&emsp;RMAN 提供的validate命令允许查看给定的备份集和进行验证以确保这个备份集能够被还原。注意，validate 命令必须要获得主键ID。 这个可以用list backup summary命令获取\n```sql\nRMAN> list backup summary;\nRMAN> validate backupset 206;\nRMAN> validate backupset 206 check logical;\n```\n### 4.7 change 命令\n>&emsp;&emsp;change 命令允许用户修改备份的状态。我们可能会遇到备份介质设备在某个时间爱你段中无效的情况（如突然断电）。这时，我们就可以使用change 命令来指示这个设备上的备份是不可用的。\n>&emsp;&emsp;解决硬件故障和修复磁盘后，额可以再次执行change 命令，将备份改为可用的状态。也可以将备份修改为不可用的状态。在还原和恢复操作期间，不会考虑哪些不可用的备份，但在执行delete expired命令期间这些备份记录不会被删除。 相关示例：\n```sql\nchange backup of database tag='TEST' unavailable;\nchange backup of database like '%TEST%' unavailable;\nchange backupset 206 unavailable;\nchange backupset 206 available;\nchange archivelog '/archivelog/arc0001.log' unavailable;\n```\n>&emsp;&emsp;可以使用change命令修改归档的重做日志备份的状态。如：将已经备份了指定次数的所有归档的重做日志备份修改为不可用的状态，也可以修改特定设备上的所有备份的状态。\n```sql\nchange archivelog all backed up 5 times to device type disk unavailable;\nchange backup of database device type disk unavailable;\n```\n>&emsp;&emsp;可是使用带有delete 参数的change 命令删除备份集，即在备份介质上的物理删除，并且从控制文件和恢复目录中删除。 前提是要知道备份集关键字，可以使用list backup 或 list copy 命令查看。\n```sql\nRMAN> list backup;\n```\n>删除备份集1：\n```sql\nRMAN> change backupset 206 delete;\n```\n* 使用通道 ORA_DISK_1\n```sql\n备份片段列表\nBP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称\n------- ------- --- --- ----------- ----------- ----------\n1 1 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK\n是否确定要删除以上对象 (输入 YES 或 NO)? yes\n已删除备份片段\n备份片段句柄=/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK RECID=1 STAMP=723758988\n1 对象已删除\n在上面的这个示例中，我们删除了备份集和它关联的备份片。 也可以删除一些备份片。 通过 list backup命令我们可以看到备份片的名称，比如：段名:/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK。\n我们也可以查看备份片的号码，用catalog 用户连接数据库后，查看rc_backup_piece 表，SQL如下：\nconn rman/rman\nSQL> select bs_key,bp_key,piece#,handle from rc_backup_piece;\nBS_KEY BP_KEY PIECE# HANDLE\n---------- ---------- ---------- -----------------------------------------------\n52 55 1 /BACKUP/ORCL_02LI47UA_1_1\n53 56 1 /BACKUP/ORCL_03LI47UF_1_1\n75 82 1 /BACKUP/ORCL_04LI4816_1_1\n删除备份片，我们可以用BP_KEY，也可以直接用段名（handle）,如：\nRMAN> change backuppiece '/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK' delete;\n使用通道 ORA_DISK_1\n备份片段列表\nBP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称\n------- ------- --- --- ----------- ----------- ----------\n2 2 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK\n是否确定要删除以上对象 (输入 YES 或 NO)? yes\n已删除备份片段\n备份片段句柄=/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK RECID=2\nSTAMP=723758997\n1 对象已删除\n使用备份集片，如：\nchange backuppiece 622 delete;\nchange archivelog until logseq=20 delete;\n最后，可以使用change backuppiece uncataog命令从目录中删除备份集片。 如果删除最后剩余的备份集片，那么它也将删除备份集记录。如：\nchange backuppiece '/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK' uncatalog;\n```\n### 4.8 delete 命令\n>&emsp;&emsp;备份集不是永远存在的。我们可以使用保存策略标记备份有效性和生存期的结束。但是，备份策略的实施不会从RMAN目录中删除备份，而只是将这些备份标记为丢弃状态。\n>&emsp;&emsp;delete 命令对备份和副本的影响很大。通过delete命令，可以删除基于保存标准被标记为丢弃的任何备份，还可以将恢复目录或控制文件中的备份从expired状态变为\n\n* deleted状态\n```sql\ndelete expired;\ndelete obsolete;\n```\n>&emsp;&emsp;执行delete命令时，RMAN会请求用户确认这个删除命令，如果确认了这个删除命令，RMAN 就会完成delete操作。\n&emsp;&emsp;注意： 如果一个备份被标记为deleted 状态，就不能恢复这个备份。 如果该备份物理可用，我们仍然可以使用dbms_backup_restore过程来恢复这个备份。\n\n### 4.9 restore命令\n> &emsp;&emsp;主要功能是从RMAN备份中还原文件，为恢复做准备。\n使用restore 命令时，该命令会在没有认识提示的情况下重写已经存在的任何文件，除非使用set newname命令。\n```sql\nset newname for datafile '/oracle/app/oradata/itpuxdb/itpux01.dbf' to 'E:/app/Administrator/oradata/orcl';\nrestore database;\n\nrestore controlfile from autobackup;\nrestore controlfile to '/backup/' from autobackup;\nrestore controlfile to '/backup';\nrestore controlfile from autobackup until time \"to_date('2016-6-27 13:25:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore controlfile from autobackup maxseq 200 maxdays 100;\nrestore spfile to pfile '/oracle/backup/spfile.restore';\nrestore spfile to '/oracle/backup/spfile.restore' from autobackup;\nrestore spfile from autobackup;\nrestore spfile from '/oracle/backup/c-1247395743-20160627-00';\nrestore tablespace tablespace_name ;\nrestore datafile 5;\nrestore datafile '/oracle/app/oradata/itpuxdb/USERS01.DBF';\nrestore database until time \"to_date('2016-6-28 17:04:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore database until SCN 1000; --注意： 该示例可以将数据库还原到SCN 1000，但是不会包含SCN.\nrestore database until sequence 100 thread 1;\n\nrestore archivelog all;\nrestore archivelog from logseq=20 thread=1;\nrestore archivelog from logseq=20 until logseq=30 thread=1;\n\nrun\n{\nset archivelog destination to \"d:/arch\";\nrestore archivelog all;\n}\n\nrestore database check readonly;\nrestore (datafile 5) from datafilecopy\n```\n### 4.10 recover命令\n>&emsp;&emsp;recover 命令用于恢复数据库。该命令可以执行数据库的完全恢复或者时间点恢复。 Recover 命令确定需要哪些归档的重做日志，并且析取和应用他们。 一旦完成重做的应用，我们就只需要使用alter database open命令打开数据库即可。\n```sql\nrecover database\nrecover database noredo; -- 如果联机日志存在，可以用recover database代替\nrecover tablespace tablespace_name ;\nrecover datafile 3;\nrecover datafile '/oracle/app/oradata/itpuxdb/USERS01.DBF';\nset until time \"to_date('2016-07-05 14:02:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore database;\nrecover database;\nalter database open resetlogs;\nrecover database until time \"to_date('2016-07-05 14:02:00','yyyy-mm-dd hh24:mi:ss')\";\nrecover database until SCN 1000;\nrecover database until sequence 100 thread 1;\n```\n### 4.10 Switch 命令\n>Switch 命令可以修改数据库控制文件中数据文件的位置，以反映Oracle数据库文件新的位置。\n```sql\nSwitch datafile all; -- 修改控制文件中数据文件位置\n```\n### 4.10 blockrecover\n>一般出现数据块错误时，都会有错误消息：\nORA-01578: ORACLE data block corrupted (file #18,block #88)\n如果没有BMR时，我们必须从一个备份中恢复这个数据文件，在恢复过程中，用户不能使用该数据块文件中的所有数据。\n用BMR恢复就很简单，只需要执行blockrecover命令即可：\n```sql\nblockrecover datafile 1 block 88;\n```\n>如果有必要，可以同时恢复多个数据文件的多个数据块。如：\n```sql\nblockrecover datafile 18 block 16,17,88,108;\nblcokrecover datafile 18 block 88 datafile 19 blcok 188;\n```\n>&emsp;&emsp;查询v$database_block_corruption视图可以查看讹误数据块的详细信息。 如下所示，使用具有corruption list restore 参数的blockrecover命令可以方便地修正v$database_block_corruption 视图中的讹误数据块。\n>&emsp;&emsp;blockrecover corruption list restore until time 'SYSDATE-5';\n这条命令将还原讹误列表中最近5天的所有讹误数据块。 在上面的命令中，还可以使用until time 和 until sequence.\n\n\n### 4.10convert命令\n>&emsp;&emsp; Oracle 10g R2以后支持手工跨平台移动数据库，即使这些平台具有不同的尾数格式（endian format）。 尾数格式与字节排序有关，它有两种不同的格式，即大尾数和小尾数。 如果在不同尾数字节格式的平台之间移动数据库，就需要手工操作，并且使用RMAN的convert datafile 或者 convert tablespace命令来将传送的数据文件转换为正确的尾数格式。\n```sql\nconvert tablespace ITPUX to platform='AIX-Based Systems (64-bit)'\ndb_file_name_convert='/oracle/app/oradata/itpux','/oracle/itpux';\nconvert datafile '/oracle/app/oradata/itpux/itpux01.DBF' from platform\n'AIX-Based Systems (64-bit)' db_file_name_convert '/oracle/app/oradata/itpux','/oracle/app/itpux';\n```\n\n\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/backup.112/e10643/preface.htm#RCMRF89959","source":"_posts/oracle/Oracle Rman 备份1.md","raw":"---\ntitle: Oracle Rman 备份1\ndate: 2018-10-04 10:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\n<!-- cover: false -->\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Oracle\ntags:\n  - Oracle\n  - RMAN\n---\n\n# Oracle Rman 的备份 （基础）\n\n\n [Oracle 11G R2 官方文档][1] \n## 1. RMAN作用与体系架构\n\n## 2. nocatalog 余catalog 的介绍与catalog的配置\n\n### 2.1 nocatalog介绍\n>&emsp;&emsp;nocatalog方式 就是用control file作为catalog，每一次备份都要往控制文件里面写好多备份信息，控制文件里面会有越来越多的备份信息。因此，当使用rman nocatalog方式备份时，备份controlfile是非常重要的。\n\n>&emsp;&emsp;由于nocatalog时利用controlfile存放备份信息，建议将oracle参数文件中的control_file_record_keep_time值加大（缺省为7天）, 参数在$oracle_home/dbs/initsid.ora中，该参数control_file__record_keep_time设置备份信息保存时间，到规定时间就自动清除以前的备份信息。\n\n```sql\n--查看参数\nshow parameter control\n--修改时间为半个月\nalter system set control_file_record_keep_time=14 scope=both;\n--查看参数\nselect name,value,issys_modifiable from v$parameter where name='control_file_record_keep_time';\n```\n\n### 2.2 catalog介绍\n>&emsp;&emsp;恢复目录存储的是与rman 备份有关的元数据。在某种意义上，恢复目录可以看做是保存rman备份和恢复所需的相关信息的副本。\n>&emsp;&emsp;我们可以在oracle 数据库中在用户模式下创建恢复目录，这个恢复目录仅仅是一些数据包，表，索引和视图。\n>&emsp;&emsp;rman中的再同步命令会使得目标数据库控制文件中的内容刷新这些表中的数据。当然，区别在于恢复目录可以包含企业中所有数据库的信息，而控制文件只包含关于它自己的数据库的信息。\n\n### 2.3 catalog恢复目录的配置过程\n\n* 创建时需要的表空间\n```sql\ncreate tablespace rman_tbs \n\tdatafile '/u01/app/oracle/oradata/orcl/rman_tbs.dbf'\n\tsize 1G \n\tautoextend off;\n```\n\n* 创建用户并授权\n```sql\ncreate user rman \n\tidentified by rman \n\tdefault tablespace rman_tbs;\n\t\ngrant connect,resource,recovery_catalog_owner to rman;\n```\n\n* 创建恢复目录\n```sql\nrman catalog rman/rman\ncreate catalog tablespace rman_tbs;\n--注意这里tablespace不能为rman\n```\n* 配置rman 专用的监听\n```sql\nrman =\n\t(description =\n\t\t(address_list =\n\t\t\t(address = (protocol = tcp)(host = orcl)(port = 1521))\n\t\t)\n\t\t(connect_data =\n\t\t\t(sid = orcl)\n\t\t)\n\t)\n```\n\n## 3. 详解 RMAN 的使用\n### 3.1 设置环境变量\n\n>&emsp;&emsp;  修改oracle用户环境变量为如下，在linux系统中还有一个rman命令不是oracle的，如果在win环境下，可以直接使用cmd。\npath=$oracle_home/bin:/sbin:$path\n才可以使用rman命令\n\n### 3.2 rman命令的帮助\n```sql\nArgument     Value          Description\n-----------------------------------------------------------------------------\ntarget       quoted-string  connect-string for target database\ncatalog      quoted-string  connect-string for recovery catalog\nnocatalog    none           if specified, then no recovery catalog\ncmdfile      quoted-string  name of input command file\nlog          quoted-string  name of output message log file\ntrace        quoted-string  name of output debugging message log file\nappend       none           if specified, log is opened in append mode\ndebug        optional-args  activate debugging\nmsgno        none           show RMAN-nnnn prefix for all messages\nsend         quoted-string  send a command to the media manager\npipe         string         building block for pipe names\ntimeout      integer        number of seconds to wait for pipe input\nchecksyntax  none           check the command file for syntax errors\n-----------------------------------------------------------------------------\nBoth single and double quotes (' or \") are accepted for a quoted-string.\nQuotes are not required unless the string contains embedded white-space.\n```\n### 3.3 rman连接信息介绍\n* 连接到目标数据库\n```sql\nrman>connect target user/pwd@db_name\n```\n* 注意\n>1、connect不能简写为conn\n2、连接user必须具备sysdba权限\n3、连接的db_name必须在tnsnames.ora中有配置，且有效(即通过sqlplus可以连接）\n4、target database必须为archivelog 模式\n5、如果是本地可以采用os认证，如果是远程需要使用密码文件认证。\n6、rman工具版本与目标数据库必须是同一版本。\n\n### 3.4 在rman里执行操作系统命令\n```sql\nrman> run{host \"ls -artl\";}\nrman> run{host \"ifconfig\";}\nrman> run{host \"pwd\";}\n/home/oracle\nhost commandcomplete\nrman> run{host \"ls\";}\nrman> exit\n```\n### 3.5 在rman里执行数据库命令及sql语句\n```sql\nrman> shutdown immediate\nrman> startup\nrman> sql 'select * fromuser_tablespaces';\n```\n### 3.6 在rman中保存脚本或执行脚本\n>在RMAN中，我们可以创建一个命令文件，里面包含rman命令，然后在RMAN的中调用这个文件。如：\nRman target usr/pwd cmdfile=backup.cmd\n或者，也可以直接在RMAN 中直接运行\n\n* 创建存储的脚本\n>使用create script RMAN 命令可以在恢复目录中存储脚本。 创建每个存储的脚本时，都要为脚本指定一个名称。 可以创建执行数据库备份，恢复和维护操作的脚本。在脚本中，RMAN 允许使用comment 参数存储与存储脚本相关的注释。 注意： 必须连接到恢复目录。 如：\n```sql\nRMAN> create script my_backup_script\ncomment 'itpux'\n{\n\tbackup database plus archivelog;\n}\n```\n* 修改存储脚本\n>使用replace script 命令可以替换恢复目录中的存储脚本。\n```sql\nRMAN> replace script my_backup_script\ncomment 'bl'\n{\n\tbackup database plus archivelog delete input;\n}\n```\n* 删除存储脚本\n>使用delete script命令可以删除一个存储脚本。\n```sql\nRMAN> Delete script my_backup_script;\n```\n* 使用存储脚本\n>创建一些存储过程脚本后，可以执行execute script命令来使用这些脚本。如：\n```sql\nrun { execute script my_backup_script; }\n```\n\n* 打印存储的脚本\n```sql\nRMAN> Print script my_backup_script;\n正在打印存储的脚本: my_backup_script\n{backup database plus archivelog;}\n```\n\n>还可以使用RC_STORED_SCRIPT_LINE恢复目录视图来显示存储的脚本的内容，如：\n```sql\nSQL> select script_name,text from rc_stored_script_line order by script_name,line;\nSCRIPT_NAME TEXT\n------------------------------ -------------------------------------------------\nmy_backup_script {\n\tmy_backup_script backup database plus archivelog delete input;\nmy_backup_script }\n```\n### 3.7 查看并修改单个参数\n```sql\nrman> show all;\nusing target database control file instead of recoverycatalog\nrman configuration parameters are:\n```\n### 3.8 查看并修改单个参数\n```sql\nrman>show retention policy;\nrman>show backup optimization;\nrman>show controlfile autobackup; -----查看当前参数的值，是off。\nrman>configure controlfile autobackup on; --修改为on，自动备份控制文件\nrman> show controlfile autobackup; ---查看修改后的，已经修改成功。\nrman> configurechannel 1 device type disk format '/dbbak/bak_%d_%m_%d_%u'; --注释：配置数据文件的备份路径.\nrman> configurecontrolfile autobackup format for device type disk to '%f'; 注释：配置控制文件的备份路径\nrman> show all; ------查看所有信息，看到已经更改了默认备份路径\n```\n### 3.8 备份文件的格式\n```sql\n备份文件可定义的格式符号如下\n使用format参数时可使用的各种替换变量，如下（注意大小写）所示：\n%a：Oracle数据库的activation ID即RESETLOG_ID。\n%c：备份片段的复制数（从1开始编号，最大不超过256）。\n%d：Oracle数据库名称。\n%D：当前时间中的日，格式为DD。\n%e：归档序号。\n%f：绝对文件编号。\n%F：基于\"DBID+时间\"确定的唯一名称，格式的形式为c-IIIIIIIIII-YYYYMMDD-QQ,其中IIIIIIIIII 为该数据库的DBID，YYYYMMDD为日期，QQ是一个1～256的序列。\n%h：归档日志线程号。\n%I：Oracle数据库的DBID。\n%M：当前时间中的月，格式为MM。\n%N：表空间名称。\n%n：数据库名称，并且会在右侧用x字符进行填充，使其保持长度为8。比如数据库名JSSBOOK，则生成的名称则是JSSBOOKx。\n%p：备份集中备份片段的编号，从1开始。\n%s：备份集号。\n%t：备份集时间戳。\n%T：当前时间的年月日格式（YYYYMMDD）。\n%u：是一个由备份集编号和建立时间压缩后组成的8字符名称。利用%u可以为每个备份集生成一个唯一的名称。\n%U：默认是%u_%p_%c的简写形式，利用它可以为每一个备份片段（即磁盘文件）\n```\n### 3.9 详解整个rman全备案例\n>执行rman备份必须开启数据的归档功能：\n```sql\nsql> shutdown immediate ---关闭数据库\nsql> startup mount; ----启动数据库到mount状态\nsql> alter database archivelog; ---开启归档功能\ndatabase altered.\nsql> archivelog list; ---查看归档状态\ndatabase logmode archive mode ---归档已经打开\nautomatic archival enabled\narchive destination use_db_recovery_file_dest\noldest online logsequence 8\nnext log sequence toarchive 10\ncurrent log sequence 10\nsql>\n```\n\n\n## 4. 详解 RMAN的常用命令及日常维护\n### 4.1 rman所备份的数据库信息查看\n* 01. list incarnation\n>概述可用的备份\n>b 表示backup\na 表示archivelog、 f 表示full backup、 0,1,2 表示incremental level备份\na 表示可用avaliable、 x 表示expired\n\n>这个命令可以派生出很多类似命令，例如\n>list backup of database summary\nlist backup of archivelog all summary\nlist backup of tablespace users summary;\nlist backup of datafile n,n,n summary\n* 02. list backup summary;\n> 列出过期的备份文件\n\n* 03. list backup by file;\n> 按照文件类型分别列出\n> 分别为：数据文件列表、归档日志列表、控制文件列表、spfile列表\n\n* 04. list backup\n> 这个命令列出已有备份集的详细信息。\n\n* 05. list expired backup;\n> 列出过期的备份文件\n\n* 06. list copy;\n>列出copy文件\n```sql\nlist copy of database;\nlist copy of controlfile;\nlist copy of tablespace users;\nlist copy of datafile n,n,n;\nlist copy of archivelog all;\nlist copy of archivelog from scn 10000;\nlist copy of archivelog until sequence 12;\n```\n* 07. list backup of spfile;\n>服务器参数文件\n\n* 08. list backup of controlfile;\n> 控制文件\n\n* 09. list backup of datafle n,n,n,n;\n> 数据文件\n\n* 10. list backup of tablespace tablespace_name;\n> 表空间对应的backup\n\n* 11. 归档日志\n```sql\nlist backup of archivelog {all, from, high, like, logseq, low, scn, sequence, time, until};\nlist backup of archivelog all;\nlist backup of archivelog until time 'sysdate-1';\nlist backup of archivelog from sequence 10;\nlist backup of archivelog until sequence 10;\nlist backup of archivelog from scn 10000;\nlist backup of archivelog until scn 200000;\nlist archivelog from scn 1000;\nlist archivelog until scn 2000;\nlist archivelog from sequence 10;\nlist archivelog until sequence 12;\n```\n\n### 4.2 report常用命令\n>report用于判断数据库当前可恢复状态、以及数据库已有备份的信息。\n\n* 01.report schema\n> 报告数据库模式\n\n* 02.report obsolete;\n> 报告已丢弃的备份集(配置了保留策略)。\n\n* 03.report unrecoverable;\n> 报告当前数据库中不可恢复的数据文件(即没有这个数据文件的备份、或者该数据文件的备份已经过期)\n\n* 04.report need backup;\n> 报告需要备份的数据文件(根据条件不同)\n```sql\nreport need backup days=3;\n--最近三天没有备份的数据文件(如果出问题的话，这些数据文件将需要最近3天的归档日志才能恢复)\nreport need backup incremental=3;\n--需要多少个增量备份文件才能恢复的数据文件。(如果出问题，这些数据文件将需要3个增量备份才能恢复)\nreport need backup redundancy=3;\n--报告出冗余次数小于3的数据文件\n--例如数据文件中包含2个数据文件system01.dbf和users01.dbf.\n--在3次或都3次以上备份中都包含system01.dbf这个数据文件，而users01.dbf则小于3次\n--那么，报告出来的数据文件就是users01.dbf\n--即，报告出数据库中冗余次数小于 n 的数据文件\nreport need backup recovery window of 2 days;\n--报告出恢复需要2天归档日志的数据文件\n```\n\n### 4.3 backup常用命令\n#### 4.3.1 基本使用\n* 01.设置备份标记\n\n* 01.设置备份集大小(一次备份的所有结果为一个备份集，要注意备份集大小)\n\n* 01.设置备份片大小(磁带或文件系统限制)\n\n* 01.备份集的保存策略\n\n* 01.重写configure exclude命令\n\n* 01.检查数据库错误\n\n* 01.跳过脱机，不可存取或只读文件\n\n\n* 01.强制备份\n\n* 01.基于上次备份时间备份数据文件\n\n* 01.备份操作期间检查逻辑错误\n\n* 01.生成备份副本\n\n* 01.备份控制文件和参数文件\n\n* 01.跳过脱机的，不可读取的或者只读的数据文件\n\n* 01.数据库备份\n\n* 01.表空间备份\n\n* 01.数据文件备份\n\n* 01.归档的重做日志备份\n\n* 01.数据库，表空间和数据文件的映像副本\n\n* 01.控制文件副本\n\n* 01.Archivelog 映像副本\n\n* 01.差异备份与增量备份\n\n#### 4.3.1 差异备份与增量备份\n* 块更改跟踪文件\n>&emsp;&emsp;默认情况下，当执行增量备份时，发生任何更改的所有数据文件都将备份。 这可能使增量备份花费更长的时间，并且会增加增量备份的大小。 10g中RMAN 提供了只备份更改过的数据块的功能。 这就可以加快增量数据库备份的速度并减少其大小。 执行alter database enable block change tracking 命令可以启用块更改跟踪。\n&emsp;&emsp;如果使用Oracle管理文件（OMF），Oracle 将会创建块更改跟踪文件。 如果没有使用OMF，则必须定义块更改跟踪文件的位置和名称。 如：\nAlter database enable block change tracking using file '/oracle/backup/block.fil';\n&emsp;&emsp;如果跟踪文件已经存在，可以使用reuse参数：\nAlter database enable block change tracking using file '/oracle/backup/block.fil' reuse;\n&emsp;&emsp;使用alter database block change tracking 命令可以禁用块更改跟踪。 块更改跟踪文件的大小通常预先分片且与数据库大小和重做日志线程的数量有关。 块更改跟踪文件的大小一般是数据库大小的1/30000。 块更改跟踪文件可能会以10MB为增量增长。 块更改跟踪文件的最小尺寸是每个数据文件320k，如果有许多数据文件，则块更改跟踪文件就会较大。 Oracle 会在块更改跟踪文件中存储足够的信息，从而允许最多8天的增量备份。 显而易见，如果增量备份超过8天，则将不使用块跟踪更改跟踪文件，并且无法利用块跟踪文件的有点。\n&emsp;&emsp;可以通过检查v$block_change_tracking 视图来确定是否启用了块更改跟踪。 Status 指示了是否启用了块更改跟踪，filename 包含块更改跟踪文件的文件名。可以通过alter database rename file 命令来转移块更改跟踪文件。\n```sql\nSQL> select status,filename from v$block_change_tracking;\nSTATUS FILENAME\n---------- ------------------------------------------------------\nENABLED /oracle/BACKUP/BLOCK.FIL\n```\n* 基本备份\n>&emsp;&emsp;执行增量备份操作时，首先需要的是增量基本备份（incremental base backup）,以后所有的增量备份都基于这个基本备份。 每次执行数据库备份操作时，都可以通过backup 命令的incremental 参数来为备份指定一个增量级别标识符。 基本备份的增量级别为0，并且必须有基本备份才能够执行其他类型的增量备份操作。 如果没有生成基本备份就尝试执行增量备份操作，RMAN会自动执行基本备份操作。 示例：\n```sql\nBackup incremental level=0 database;\n```\n* 差异备份\n>&emsp;&emsp;差异备份是RMAN生成的增量备份的默认类型，对于差异备份来说，RMAN会备份自上次同级或者低级差异增量备份以来所发生变化的数据块\n```sql\nbackup incremental level=1 database;\n```\n* 累积备份\n>&emsp;&emsp;累积备份可以使备份集备份前面所有级别的备份以及此次要备份的所有发生变化的数据块。 累积备份是一个可选的备份方法，并要求在backup 命令中使用cumulative 关键字。\n```sql\nbackup incremental level =2 cumulative database;\n```\n* 增量备份选项\n>&emsp;&emsp;Oracle 不仅允许执行数据库的增量备份，还允许执行表空间，数据文件以及数据库文件副本的增量备份操作。 控制文件，归档重做日志以及备份集都不能生成增量备份。 此外，还可以在执行增量备份操作时同时备份归档的重做日志。\n```sql\nBackup incremental level=0 tablespace users;\nBackup incremental level=1 tablespace users;\nBackup incremental level=0 datafile 4;\nBackup incremental level=1 datafile 4;\nBackup incremental level=1 database plus archivelog;\n```\n* 增量备份更新备份\n>RMAN 提供了增量备份更新备份。 这种备份避免了采用数据文件的完整映像副本进行备份的开销，并且具有与映像副本相同的恢复特性。 从某种意义上来说，这种备份类似与使用映像副本的增量备份。\n```sql\nRun{\nRecover copy of database with tag 'Orcl';\nBackup incremental level 1 for recover of copy with tag 'Orcl' database;\n}\n```\n>&emsp;&emsp;示例中的recover of copy database 命令并没有真正的恢复数据库，但它使RMAN将任何增量备份应用于与列出标记（Orcl）关联的数据文件副本。 第一次运行该命令时，它将没有任何效果，因为它没有任何可用的增量备份或数据文件副本。 这并不是很严重的问题，并且RMAN 将只显示一条警告消息。 第二次运行该命令时也没有任何效果，因为没有任何增量备份可用。\n&emsp;&emsp;执行recover 命令后，就会产生一个增量备份，这个备份第一次运行时，它会创建一个基本备份（如果没有的话）。这实际上增量为1的备份。 第二次执行这个run代码块时，将通过backup 命令执行第一个增量备份。\n&emsp;&emsp;一旦该命令运行了2次，第三次执行和后面的执行就能够将前面的增量备份应用与数据文件副本。 注意，recover 和backup命令中将标记赋予相同的名称非常重要。\n\n### 4.4 configure常用命令\n\n* 01. 显示当前的配置信息\n```sql\nrman> show all;\nrman 配置参数为:\nconfigure retention policy to redundancy 1; # default\nconfigure backup optimization off; # default\nconfigure default device type to disk; # default\nconfigure controlfile autobackup off; # default\nconfigure controlfile autobackup format for device type disk to '%f'; # default\nconfigure device type disk parallelism 1 backup type to backupset; # default\nconfigure datafile backup copies for device type disk to 1; # default\nconfigure archivelog backup copies for device type disk to 1; # default\nconfigure maxsetsize to unlimited; # default\nconfigure encryption for database off; # default\nconfigure encryption algorithm 'aes128'; # default\nconfigure archivelog deletion policy to none; # default\nconfigure snapshot controlfile name to '/oracle/product/11.2.0/db_1/database/sncfitpuxdb.ora'; # default\nconfigure retention policy to redundancy 1; # default\n注释：配置redundancy配置需要保留几份备份文件，默认是1。也可以改变为其它非零的正整数值。\nconfigure backup optimization off; # default\n注释：设备备份优化打开，如果表空间是只读状态，那么在做备份的时候只是第一次会备份，以后不备份。有两个选项off关闭和on打开\nconfigure default device type to disk; # default\n注释：配置默认备份设备可以是sbt（磁带），disk（硬盘）；默认是硬盘\nconfigure controlfile autobackup off;# default\n注释：配置在备份的时候是否将控制文件一并备份，两个选项,默认是off不备份，也可以是on备份、。\nconfigure controlfile autobackupformat for device type disk to '%f'; # default\n注释：配置control file自动备份的路径和文件格式\nconfigure device type disk parallelism1 backup type to backupset; # default\n注释：配置磁盘备份的类型，默认是备份集方式（backupset）或镜像拷贝也叫文件拷贝(copy)。\n镜像拷贝值适用于磁盘备份，磁带只支持备份集。一般用备份集更多，其效率会更高\nconfigure datafile backupcopies for device type disk to 1; # default\n注释：配置生成备份集的个数，默认是1；备份集内会包括（数据文件，控制文件，参数文件）\nconfigure archivelog backupcopies for device type disk to 1; # default\n注释：配置归档日志默认的备份路径\nconfigure maxsetsize to unlimited; # default\n注释：配置单个备份集大小，缺省是不限制，我们可以配置成1g/100m/1024k or other\nconfigure encryption for database off; # default\n注释：配置备份数据加密，是10gr2推出来的新功能，设置为on后。\n可以set encryption on identifyed by youpassword only;加密备份，还原的时候需要提供密码。\nconfigureencryption algorithm 'aes128'; # default\n注释：指定备份数据加密的类型。\nconfigure archivelogdeletion policy to none; # default\n注释：配置归档日志在备份后自动删除\nconfigure snapshot controlfile name to '/oracle/product/10.2.0/db_1/dbs/snapcf_itpuxdb.f'; # default\n注释：配置控制文件快照，可以有效的提高控制文件的恢复性。\n查询rman设置中非默认值:\nsql> select name,value from v$rman_configuration;\n```\n* 01. 保存策略 (retention policy)\n```sql\nconfigure retention policy to recovery window of 7 days;\nconfigure retention policy to redundancy 5;\nconfigure retention policy clear;\nconfigure retention policy to none;\n第一种recover window是保持所有足够的备份，可以将数据库系统恢复到最近七天内的任意时刻。任何超过最近七天的数据库备份将被标记为obsolete。\n第二种redundancy 是为了保持可以恢复的最新的5份数据库备份，任何超过最新5份的备份都将被标记为redundancy。它的默认值是1份。\n第三、四：none 可以把使备份保持策略失效，clear 将恢复默认的保持策略\n一般最安全的方法是采用第二种保持策略。\n```\n* 01. 备份优化 backup optimization\n```sql\nconfigure backup optimization on;\nconfigure backup optimization off;\nconfigure backup optimization clear;\n默认值为关闭，如果打开，rman将对备份的数据文件及归档等文件进行一种优化的算法。\n```\n* 01. 默认设备 default device type\n```sql\nconfigure default device type to disk;\nconfigure default device type to stb;\nconfigure default device type clear;\n是指定所有i/o操作的设备类型是硬盘或者磁带，默认值是硬盘\n磁带的设置是configure default device type to sbt;\n```\n* 01. 控制文件 controlfile\n```sql\nconfigure controlfile autobackup on;\nconfigure controlfile autobackup format for device type disk to '/oracle/backup/conf_%F';\nconfigure controlfile autobackup clear;\nconfigrue controlfile autobackup format for device type disk clear;\nCONFIGURE SNAPSHOT CONTROLFILE NAME TO '/oracle/backup/scontrofile.snp';\n--是配置控制文件的快照文件的存放路径和文件名，这个快照文件是在备份期间产生的，用于控制文件的读一致性。\nconfigure snapshot controlfile name clear;\n强制数据库在备份文件或者执行改变数据库结构的命令之后将控制文件自动备份，默认值为关闭。这样可以避免控制文件和catalog丢失后，控制文件仍然可以恢复。\n```\n* 01. 并行数(通道数) device type disk|stb pallelism n;\n```sql\nconfigure device type disk|stb parallelism 2;\nconfigure device type disk|stb clear; --用于清除上面的信道配置\nconfigure channel device type disk format '/oracle/backup/rman_%u';\nconfigure channel device type disk maxpiecesize 100m;\nconfigure channel device type disk rate 1200k;\nconfigure channel 1 device type disk format '/oracle/backup/rman_%u';\nconfigure channel 2 device type disk format '/oracle/backup/rman_%u';\nconfigure channel 1 device type disk maxpiecesize 100m;\n配置数据库设备类型的并行度。\n```\n* 01. 生成备份副本 datafile|archivelog backup copies\n```sql\nconfigure datafile backup copies for device type disk|stb to 3;\nconfigure archivelog backup copies for device type disk|stb to 3;\n--是设置数据库的归档日志的存放设备类型\nconfigure datafile|archivelog backup copies for device type disk|stb clear\nbackup device type disk database format '/oracle/backup1/%u', '/oracle/backup2/%u', '/oracle/backup3/%u';\n是配置数据库的每次备份的copy数量，oracle的每一次备份都可以有多份完全相同的拷贝。\n```\n* 01. 排除选项 exclude\n```sql\nconfigure exclude for tablespace USERS;\nconfigure exclude for tablespace USERS clear;\n```\n* 01. 备份集大小 maxsetsize\n```sql\nconfigure maxsetsize to 1g|1000m|1000000k|unlimited;\nconfigure maxsetsize clear;\n```\n\n### 4.5 set 命令\n>&emsp;&emsp;使用set 命令可以定义只应用于当前RMAN会话的设置。 set 命令的设置不是永久的，根据实际需求，可以采用两种方式来使用set 命令。\n* 在run 代码块外，我们可是执行下面的操作：\n```sql\n（1）使用set echo 命令在消息日志中显示RMAN 命令。\n（2）使用set dbid 命令指定一个数据库的数据库标识符（database identifier： dbid）。\n```\n\n* 某些set 命令只能在run代码块的限定范围内使用，常见的有：\n>（1）set newname 命令：用于执行表空间时间点恢复（TSPITR）或者数据库复制操作。 该命令允许指定新的数据库数据文件名。 将数据库移动到新的系统中并且文件系统名不同时，我们可以使用这个命令。使用set newname 命令时还需要使用switch 命令。\n（2）set maxcorrupt for datafile: 使用该命令可以定义RMAN操作失败前锁允许的数据块讹误的最大数据。\n（3）set archivelog destination: 使用该命令可以修改存储归档的重做日志的archive_log_dest_1 目标。\n（4）set 命令和until 子句： 使用set命令和set 命令的until 子句可以定义数据库时间点恢复操作锁使用的具体时间点，SCN 或日志序列号。\n（5）set backup copies命令： 使用该命令可以定义为备份集中的每个备份片应当创建的副本数。\n（6）set command id: 使用该命令可以关联给定的服务器会话和给定的通道。\n（7）set controlfile autoback format for device type: 使用该命令可以修改用于控制文件自动备份操作的默认格式。\n\n>&emsp;&emsp;例如： 要执行一个为每个备份片创建两个副本的被操作，并且允许数据文件的最大讹误数为10. 脚本如下：\n\n```sql\nrun{\n\tset maxcorrupt for datafile 3 to 5;\n\tset backup copies=2;\n\tbackup database;\n}\nset until time \"to_date('2016-6-28 17:04:00','yyyy-mm-dd hh24:mi:ss')\";\n```\n### 4.5 crosscheck命令\n\n* 交叉效验RMAN 备份\n>&emsp;&emsp;在RMAN目录和物理备份目的地不同步的情况下，我们可以使用crosscheck命令来效验控制文件或恢复目录中的RMAN信息是否与备份介质上的实际物理备份集片相同。\n>&emsp;&emsp;使用crosscheck 命令时，我们关心每个备份集或者副本的状态。 如果使用控制文件，用于备份集片的v$backup_set 视图和用于副本的v$databfile_copy 视图中的status列列出了每个备份集或副本的状态码；如果使用恢复目录，则在备份集片的RC_BACKUP_set和副本的RC_DATAFILE_COPY中列出了每个备份集或副本的状态码。 在不同的备份状态码中，我们关心以下两种状态：\n>&emsp;&emsp;（1）A（Available:可用）：RMAN 认定该项存在于备份介质上\n&emsp;&emsp;（2）X（Expired:不可用）：这个备份集片或副本上存储的RMAN目录（即控制文件或恢复目录）中，但是并没有物理存在于备份介质上。\n>&emsp;&emsp;使用crosscheck 命令的目的是将RMAN目录的状态设置为AVAILABLE或者EXPIRED。 执行crosscheck时，RMAN检查目录中列出的每个备份集或副本并且判断他们是否存在与备份介质上。 如果备份集或副本不存在与备份介质上，它就会被标记为expired, 并且不能用于任何还原操作；如果备份集或副本存在与备份介质上，它就会维持available状态。 如果以前被标记为expired 的备份集或副本再次存在于备份介质上，crosscheck 命令就会将它标记回available。\n```sql\ncrosscheck backup;\n```\n> &emsp;&emsp;可以交叉效验数据文件备份，表空间备份，控制文件备份以及服务器参数文件备份。此外，可以通过识别与备份相关联的标记来选择要交叉效验和特定的备份。 基于使用的设备或者基于一个时间周期，我们甚至可以交叉效验所有的备份。 如：\n```sql\ncrosscheck backup of datafile 1;\ncrosscheck backup of tablespace users;\ncrosscheck backup of controlfile;\ncrosscheck backup of spfile;\ncrosscheck backup tag='TEST';\ncrosscheck backup completed after 'sysdate-2';\ncrosscheck backup completed between 'sysdate-5' and 'sysdate-2';\ncrosscheck backup device type disk;\n```\n* 交叉验证归档日志示例：\n```sql\nRMAN> crosscheck archivelog all;\n```\n>&emsp;&emsp;我们可以基于一个号码或标准（包括时间，具体的或指定范围的SCN或日志序列号）来交叉效验归档的重做日志备份，甚至还可以使用like参数与通配符来交叉效验特定的归档日志备份。 如：\n```sql\ncrosscheck archivelog like 'ARC001.log';\ncrosscheck archivelog '/oracle/arch/itpuxdb/archivelog/2016_08_02/o1_mf_1_22_cszw2d4g_.arc';\ncrosscheck archivelog like '%ARC00012.LOG';\ncrosscheck archivelog from time \"to_date('2016-08-02','yyyy-mm-dd')\";\ncrosscheck archivelog until time \"to_date('2016-08-02','yyyy-mm-dd')\";\ncrosscheck archivelog from sequence 12;\ncrosscheck archivelog until sequence 522;\n--使用crosscheck copy命令还可以交叉效验副本。 包括数据文件副本，控制文件副本，归档重做日志副本以及磁盘上的归档的重做日志。 如：\ncrosscheck copy of datafile 5;\ncrosscheck datafilecopy '/oracle/oradata/itpuxdb/rman_tbs.dbf;\n```\n\n### 4.6 RMAN 备份的验证validate\n>&emsp;&emsp;RMAN 提供的validate命令允许查看给定的备份集和进行验证以确保这个备份集能够被还原。注意，validate 命令必须要获得主键ID。 这个可以用list backup summary命令获取\n```sql\nRMAN> list backup summary;\nRMAN> validate backupset 206;\nRMAN> validate backupset 206 check logical;\n```\n### 4.7 change 命令\n>&emsp;&emsp;change 命令允许用户修改备份的状态。我们可能会遇到备份介质设备在某个时间爱你段中无效的情况（如突然断电）。这时，我们就可以使用change 命令来指示这个设备上的备份是不可用的。\n>&emsp;&emsp;解决硬件故障和修复磁盘后，额可以再次执行change 命令，将备份改为可用的状态。也可以将备份修改为不可用的状态。在还原和恢复操作期间，不会考虑哪些不可用的备份，但在执行delete expired命令期间这些备份记录不会被删除。 相关示例：\n```sql\nchange backup of database tag='TEST' unavailable;\nchange backup of database like '%TEST%' unavailable;\nchange backupset 206 unavailable;\nchange backupset 206 available;\nchange archivelog '/archivelog/arc0001.log' unavailable;\n```\n>&emsp;&emsp;可以使用change命令修改归档的重做日志备份的状态。如：将已经备份了指定次数的所有归档的重做日志备份修改为不可用的状态，也可以修改特定设备上的所有备份的状态。\n```sql\nchange archivelog all backed up 5 times to device type disk unavailable;\nchange backup of database device type disk unavailable;\n```\n>&emsp;&emsp;可是使用带有delete 参数的change 命令删除备份集，即在备份介质上的物理删除，并且从控制文件和恢复目录中删除。 前提是要知道备份集关键字，可以使用list backup 或 list copy 命令查看。\n```sql\nRMAN> list backup;\n```\n>删除备份集1：\n```sql\nRMAN> change backupset 206 delete;\n```\n* 使用通道 ORA_DISK_1\n```sql\n备份片段列表\nBP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称\n------- ------- --- --- ----------- ----------- ----------\n1 1 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK\n是否确定要删除以上对象 (输入 YES 或 NO)? yes\n已删除备份片段\n备份片段句柄=/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK RECID=1 STAMP=723758988\n1 对象已删除\n在上面的这个示例中，我们删除了备份集和它关联的备份片。 也可以删除一些备份片。 通过 list backup命令我们可以看到备份片的名称，比如：段名:/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK。\n我们也可以查看备份片的号码，用catalog 用户连接数据库后，查看rc_backup_piece 表，SQL如下：\nconn rman/rman\nSQL> select bs_key,bp_key,piece#,handle from rc_backup_piece;\nBS_KEY BP_KEY PIECE# HANDLE\n---------- ---------- ---------- -----------------------------------------------\n52 55 1 /BACKUP/ORCL_02LI47UA_1_1\n53 56 1 /BACKUP/ORCL_03LI47UF_1_1\n75 82 1 /BACKUP/ORCL_04LI4816_1_1\n删除备份片，我们可以用BP_KEY，也可以直接用段名（handle）,如：\nRMAN> change backuppiece '/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK' delete;\n使用通道 ORA_DISK_1\n备份片段列表\nBP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称\n------- ------- --- --- ----------- ----------- ----------\n2 2 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK\n是否确定要删除以上对象 (输入 YES 或 NO)? yes\n已删除备份片段\n备份片段句柄=/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK RECID=2\nSTAMP=723758997\n1 对象已删除\n使用备份集片，如：\nchange backuppiece 622 delete;\nchange archivelog until logseq=20 delete;\n最后，可以使用change backuppiece uncataog命令从目录中删除备份集片。 如果删除最后剩余的备份集片，那么它也将删除备份集记录。如：\nchange backuppiece '/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK' uncatalog;\n```\n### 4.8 delete 命令\n>&emsp;&emsp;备份集不是永远存在的。我们可以使用保存策略标记备份有效性和生存期的结束。但是，备份策略的实施不会从RMAN目录中删除备份，而只是将这些备份标记为丢弃状态。\n>&emsp;&emsp;delete 命令对备份和副本的影响很大。通过delete命令，可以删除基于保存标准被标记为丢弃的任何备份，还可以将恢复目录或控制文件中的备份从expired状态变为\n\n* deleted状态\n```sql\ndelete expired;\ndelete obsolete;\n```\n>&emsp;&emsp;执行delete命令时，RMAN会请求用户确认这个删除命令，如果确认了这个删除命令，RMAN 就会完成delete操作。\n&emsp;&emsp;注意： 如果一个备份被标记为deleted 状态，就不能恢复这个备份。 如果该备份物理可用，我们仍然可以使用dbms_backup_restore过程来恢复这个备份。\n\n### 4.9 restore命令\n> &emsp;&emsp;主要功能是从RMAN备份中还原文件，为恢复做准备。\n使用restore 命令时，该命令会在没有认识提示的情况下重写已经存在的任何文件，除非使用set newname命令。\n```sql\nset newname for datafile '/oracle/app/oradata/itpuxdb/itpux01.dbf' to 'E:/app/Administrator/oradata/orcl';\nrestore database;\n\nrestore controlfile from autobackup;\nrestore controlfile to '/backup/' from autobackup;\nrestore controlfile to '/backup';\nrestore controlfile from autobackup until time \"to_date('2016-6-27 13:25:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore controlfile from autobackup maxseq 200 maxdays 100;\nrestore spfile to pfile '/oracle/backup/spfile.restore';\nrestore spfile to '/oracle/backup/spfile.restore' from autobackup;\nrestore spfile from autobackup;\nrestore spfile from '/oracle/backup/c-1247395743-20160627-00';\nrestore tablespace tablespace_name ;\nrestore datafile 5;\nrestore datafile '/oracle/app/oradata/itpuxdb/USERS01.DBF';\nrestore database until time \"to_date('2016-6-28 17:04:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore database until SCN 1000; --注意： 该示例可以将数据库还原到SCN 1000，但是不会包含SCN.\nrestore database until sequence 100 thread 1;\n\nrestore archivelog all;\nrestore archivelog from logseq=20 thread=1;\nrestore archivelog from logseq=20 until logseq=30 thread=1;\n\nrun\n{\nset archivelog destination to \"d:/arch\";\nrestore archivelog all;\n}\n\nrestore database check readonly;\nrestore (datafile 5) from datafilecopy\n```\n### 4.10 recover命令\n>&emsp;&emsp;recover 命令用于恢复数据库。该命令可以执行数据库的完全恢复或者时间点恢复。 Recover 命令确定需要哪些归档的重做日志，并且析取和应用他们。 一旦完成重做的应用，我们就只需要使用alter database open命令打开数据库即可。\n```sql\nrecover database\nrecover database noredo; -- 如果联机日志存在，可以用recover database代替\nrecover tablespace tablespace_name ;\nrecover datafile 3;\nrecover datafile '/oracle/app/oradata/itpuxdb/USERS01.DBF';\nset until time \"to_date('2016-07-05 14:02:00','yyyy-mm-dd hh24:mi:ss')\";\nrestore database;\nrecover database;\nalter database open resetlogs;\nrecover database until time \"to_date('2016-07-05 14:02:00','yyyy-mm-dd hh24:mi:ss')\";\nrecover database until SCN 1000;\nrecover database until sequence 100 thread 1;\n```\n### 4.10 Switch 命令\n>Switch 命令可以修改数据库控制文件中数据文件的位置，以反映Oracle数据库文件新的位置。\n```sql\nSwitch datafile all; -- 修改控制文件中数据文件位置\n```\n### 4.10 blockrecover\n>一般出现数据块错误时，都会有错误消息：\nORA-01578: ORACLE data block corrupted (file #18,block #88)\n如果没有BMR时，我们必须从一个备份中恢复这个数据文件，在恢复过程中，用户不能使用该数据块文件中的所有数据。\n用BMR恢复就很简单，只需要执行blockrecover命令即可：\n```sql\nblockrecover datafile 1 block 88;\n```\n>如果有必要，可以同时恢复多个数据文件的多个数据块。如：\n```sql\nblockrecover datafile 18 block 16,17,88,108;\nblcokrecover datafile 18 block 88 datafile 19 blcok 188;\n```\n>&emsp;&emsp;查询v$database_block_corruption视图可以查看讹误数据块的详细信息。 如下所示，使用具有corruption list restore 参数的blockrecover命令可以方便地修正v$database_block_corruption 视图中的讹误数据块。\n>&emsp;&emsp;blockrecover corruption list restore until time 'SYSDATE-5';\n这条命令将还原讹误列表中最近5天的所有讹误数据块。 在上面的命令中，还可以使用until time 和 until sequence.\n\n\n### 4.10convert命令\n>&emsp;&emsp; Oracle 10g R2以后支持手工跨平台移动数据库，即使这些平台具有不同的尾数格式（endian format）。 尾数格式与字节排序有关，它有两种不同的格式，即大尾数和小尾数。 如果在不同尾数字节格式的平台之间移动数据库，就需要手工操作，并且使用RMAN的convert datafile 或者 convert tablespace命令来将传送的数据文件转换为正确的尾数格式。\n```sql\nconvert tablespace ITPUX to platform='AIX-Based Systems (64-bit)'\ndb_file_name_convert='/oracle/app/oradata/itpux','/oracle/itpux';\nconvert datafile '/oracle/app/oradata/itpux/itpux01.DBF' from platform\n'AIX-Based Systems (64-bit)' db_file_name_convert '/oracle/app/oradata/itpux','/oracle/app/itpux';\n```\n\n\n\n\n\n\n  [1]: https://docs.oracle.com/cd/E11882_01/backup.112/e10643/preface.htm#RCMRF89959","slug":"oracle/Oracle Rman 备份1","published":1,"updated":"2019-05-03T16:08:56.581Z","_id":"cjv89uuc4003ri0cdvwnmt5vt","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Oracle-Rman-的备份-（基础）\"><a href=\"#Oracle-Rman-的备份-（基础）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （基础）\"></a>Oracle Rman 的备份 （基础）</h1><p> <a href=\"https://docs.oracle.com/cd/E11882_01/backup.112/e10643/preface.htm#RCMRF89959\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-RMAN作用与体系架构\"><a href=\"#1-RMAN作用与体系架构\" class=\"headerlink\" title=\"1. RMAN作用与体系架构\"></a>1. RMAN作用与体系架构</h2><h2 id=\"2-nocatalog-余catalog-的介绍与catalog的配置\"><a href=\"#2-nocatalog-余catalog-的介绍与catalog的配置\" class=\"headerlink\" title=\"2. nocatalog 余catalog 的介绍与catalog的配置\"></a>2. nocatalog 余catalog 的介绍与catalog的配置</h2><h3 id=\"2-1-nocatalog介绍\"><a href=\"#2-1-nocatalog介绍\" class=\"headerlink\" title=\"2.1 nocatalog介绍\"></a>2.1 nocatalog介绍</h3><blockquote>\n<p>&emsp;&emsp;nocatalog方式 就是用control file作为catalog，每一次备份都要往控制文件里面写好多备份信息，控制文件里面会有越来越多的备份信息。因此，当使用rman nocatalog方式备份时，备份controlfile是非常重要的。</p>\n</blockquote>\n<blockquote>\n<p>&emsp;&emsp;由于nocatalog时利用controlfile存放备份信息，建议将oracle参数文件中的control_file_record_keep_time值加大（缺省为7天）, 参数在$oracle_home/dbs/initsid.ora中，该参数control_file__record_keep_time设置备份信息保存时间，到规定时间就自动清除以前的备份信息。</p>\n</blockquote>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--查看参数</span>\n<span class=\"token keyword\">show</span> parameter control\n<span class=\"token comment\" spellcheck=\"true\">--修改时间为半个月</span>\n<span class=\"token keyword\">alter</span> system <span class=\"token keyword\">set</span> control_file_record_keep_time<span class=\"token operator\">=</span><span class=\"token number\">14</span> scope<span class=\"token operator\">=</span>both<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--查看参数</span>\n<span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span>issys_modifiable <span class=\"token keyword\">from</span> v$parameter <span class=\"token keyword\">where</span> name<span class=\"token operator\">=</span><span class=\"token string\">'control_file_record_keep_time'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"2-2-catalog介绍\"><a href=\"#2-2-catalog介绍\" class=\"headerlink\" title=\"2.2 catalog介绍\"></a>2.2 catalog介绍</h3><blockquote>\n<p>&emsp;&emsp;恢复目录存储的是与rman 备份有关的元数据。在某种意义上，恢复目录可以看做是保存rman备份和恢复所需的相关信息的副本。<br>&emsp;&emsp;我们可以在oracle 数据库中在用户模式下创建恢复目录，这个恢复目录仅仅是一些数据包，表，索引和视图。<br>&emsp;&emsp;rman中的再同步命令会使得目标数据库控制文件中的内容刷新这些表中的数据。当然，区别在于恢复目录可以包含企业中所有数据库的信息，而控制文件只包含关于它自己的数据库的信息。</p>\n</blockquote>\n<h3 id=\"2-3-catalog恢复目录的配置过程\"><a href=\"#2-3-catalog恢复目录的配置过程\" class=\"headerlink\" title=\"2.3 catalog恢复目录的配置过程\"></a>2.3 catalog恢复目录的配置过程</h3><ul>\n<li><p>创建时需要的表空间</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">tablespace</span> rman_tbs \n  datafile <span class=\"token string\">'/u01/app/oracle/oradata/orcl/rman_tbs.dbf'</span>\n  size 1G \n  autoextend <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n<li><p>创建用户并授权<br><code>`</code>sql<br>create user rman<br>  identified by rman<br>  default tablespace rman_tbs;</p>\n</li>\n</ul>\n<p>grant connect,resource,recovery_catalog_owner to rman;</p>\n<pre><code>\n* 创建恢复目录\n```sql\nrman catalog rman/rman\ncreate catalog tablespace rman_tbs;\n--注意这里tablespace不能为rman\n</code></pre><ul>\n<li>配置rman 专用的监听<pre class=\" language-sql\"><code class=\"language-sql\">rman <span class=\"token operator\">=</span>\n  <span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">(</span>address_list <span class=\"token operator\">=</span>\n          <span class=\"token punctuation\">(</span>address <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>protocol <span class=\"token operator\">=</span> tcp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>host <span class=\"token operator\">=</span> orcl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>port <span class=\"token operator\">=</span> <span class=\"token number\">1521</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span>connect_data <span class=\"token operator\">=</span>\n          <span class=\"token punctuation\">(</span>sid <span class=\"token operator\">=</span> orcl<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n</code></pre>\n</li>\n</ul>\n<h2 id=\"3-详解-RMAN-的使用\"><a href=\"#3-详解-RMAN-的使用\" class=\"headerlink\" title=\"3. 详解 RMAN 的使用\"></a>3. 详解 RMAN 的使用</h2><h3 id=\"3-1-设置环境变量\"><a href=\"#3-1-设置环境变量\" class=\"headerlink\" title=\"3.1 设置环境变量\"></a>3.1 设置环境变量</h3><blockquote>\n<p>&emsp;&emsp;  修改oracle用户环境变量为如下，在linux系统中还有一个rman命令不是oracle的，如果在win环境下，可以直接使用cmd。<br>path=$oracle_home/bin:/sbin:$path<br>才可以使用rman命令</p>\n</blockquote>\n<h3 id=\"3-2-rman命令的帮助\"><a href=\"#3-2-rman命令的帮助\" class=\"headerlink\" title=\"3.2 rman命令的帮助\"></a>3.2 rman命令的帮助</h3><pre class=\" language-sql\"><code class=\"language-sql\">Argument     <span class=\"token keyword\">Value</span>          Description\n<span class=\"token comment\" spellcheck=\"true\">-----------------------------------------------------------------------------</span>\ntarget       quoted<span class=\"token operator\">-</span>string  <span class=\"token keyword\">connect</span><span class=\"token operator\">-</span>string <span class=\"token keyword\">for</span> target <span class=\"token keyword\">database</span>\ncatalog      quoted<span class=\"token operator\">-</span>string  <span class=\"token keyword\">connect</span><span class=\"token operator\">-</span>string <span class=\"token keyword\">for</span> recovery catalog\nnocatalog    none           <span class=\"token keyword\">if</span> specified<span class=\"token punctuation\">,</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">no</span> recovery catalog\ncmdfile      quoted<span class=\"token operator\">-</span>string  name <span class=\"token keyword\">of</span> input command <span class=\"token keyword\">file</span>\nlog          quoted<span class=\"token operator\">-</span>string  name <span class=\"token keyword\">of</span> output message log <span class=\"token keyword\">file</span>\ntrace        quoted<span class=\"token operator\">-</span>string  name <span class=\"token keyword\">of</span> output debugging message log <span class=\"token keyword\">file</span>\nappend       none           <span class=\"token keyword\">if</span> specified<span class=\"token punctuation\">,</span> log <span class=\"token operator\">is</span> opened <span class=\"token operator\">in</span> append mode\ndebug        optional<span class=\"token operator\">-</span>args  activate debugging\nmsgno        none           <span class=\"token keyword\">show</span> RMAN<span class=\"token operator\">-</span>nnnn prefix <span class=\"token keyword\">for</span> <span class=\"token keyword\">all</span> messages\nsend         quoted<span class=\"token operator\">-</span>string  send <span class=\"token number\">a</span> command <span class=\"token keyword\">to</span> the media manager\npipe         string         building block <span class=\"token keyword\">for</span> pipe names\ntimeout      <span class=\"token keyword\">integer</span>        number <span class=\"token keyword\">of</span> seconds <span class=\"token keyword\">to</span> wait <span class=\"token keyword\">for</span> pipe input\nchecksyntax  none           <span class=\"token keyword\">check</span> the command <span class=\"token keyword\">file</span> <span class=\"token keyword\">for</span> syntax <span class=\"token keyword\">errors</span>\n<span class=\"token comment\" spellcheck=\"true\">-----------------------------------------------------------------------------</span>\nBoth single <span class=\"token operator\">and</span> <span class=\"token keyword\">double</span> quotes <span class=\"token punctuation\">(</span>' <span class=\"token operator\">or</span> \"<span class=\"token punctuation\">)</span> are accepted <span class=\"token keyword\">for</span> <span class=\"token number\">a</span> quoted<span class=\"token operator\">-</span>string<span class=\"token punctuation\">.</span>\nQuotes are <span class=\"token operator\">not</span> required unless the string <span class=\"token keyword\">contains</span> embedded white<span class=\"token operator\">-</span>space<span class=\"token punctuation\">.</span>\n</code></pre>\n<h3 id=\"3-3-rman连接信息介绍\"><a href=\"#3-3-rman连接信息介绍\" class=\"headerlink\" title=\"3.3 rman连接信息介绍\"></a>3.3 rman连接信息介绍</h3><ul>\n<li>连接到目标数据库<pre class=\" language-sql\"><code class=\"language-sql\">rman<span class=\"token operator\">></span><span class=\"token keyword\">connect</span> target <span class=\"token keyword\">user</span><span class=\"token operator\">/</span>pwd<span class=\"token variable\">@db_name</span>\n</code></pre>\n</li>\n<li>注意<blockquote>\n<p>1、connect不能简写为conn<br>2、连接user必须具备sysdba权限<br>3、连接的db_name必须在tnsnames.ora中有配置，且有效(即通过sqlplus可以连接）<br>4、target database必须为archivelog 模式<br>5、如果是本地可以采用os认证，如果是远程需要使用密码文件认证。<br>6、rman工具版本与目标数据库必须是同一版本。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"3-4-在rman里执行操作系统命令\"><a href=\"#3-4-在rman里执行操作系统命令\" class=\"headerlink\" title=\"3.4 在rman里执行操作系统命令\"></a>3.4 在rman里执行操作系统命令</h3><pre class=\" language-sql\"><code class=\"language-sql\">rman<span class=\"token operator\">></span> run{host <span class=\"token string\">\"ls -artl\"</span><span class=\"token punctuation\">;</span>}\nrman<span class=\"token operator\">></span> run{host <span class=\"token string\">\"ifconfig\"</span><span class=\"token punctuation\">;</span>}\nrman<span class=\"token operator\">></span> run{host <span class=\"token string\">\"pwd\"</span><span class=\"token punctuation\">;</span>}\n<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>oracle\nhost commandcomplete\nrman<span class=\"token operator\">></span> run{host <span class=\"token string\">\"ls\"</span><span class=\"token punctuation\">;</span>}\nrman<span class=\"token operator\">></span> <span class=\"token keyword\">exit</span>\n</code></pre>\n<h3 id=\"3-5-在rman里执行数据库命令及sql语句\"><a href=\"#3-5-在rman里执行数据库命令及sql语句\" class=\"headerlink\" title=\"3.5 在rman里执行数据库命令及sql语句\"></a>3.5 在rman里执行数据库命令及sql语句</h3><pre class=\" language-sql\"><code class=\"language-sql\">rman<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate\nrman<span class=\"token operator\">></span> startup\nrman<span class=\"token operator\">></span> sql <span class=\"token string\">'select * fromuser_tablespaces'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"3-6-在rman中保存脚本或执行脚本\"><a href=\"#3-6-在rman中保存脚本或执行脚本\" class=\"headerlink\" title=\"3.6 在rman中保存脚本或执行脚本\"></a>3.6 在rman中保存脚本或执行脚本</h3><blockquote>\n<p>在RMAN中，我们可以创建一个命令文件，里面包含rman命令，然后在RMAN的中调用这个文件。如：<br>Rman target usr/pwd cmdfile=backup.cmd<br>或者，也可以直接在RMAN 中直接运行</p>\n</blockquote>\n<ul>\n<li>创建存储的脚本<blockquote>\n<p>使用create script RMAN 命令可以在恢复目录中存储脚本。 创建每个存储的脚本时，都要为脚本指定一个名称。 可以创建执行数据库备份，恢复和维护操作的脚本。在脚本中，RMAN 允许使用comment 参数存储与存储脚本相关的注释。 注意： 必须连接到恢复目录。 如：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> <span class=\"token keyword\">create</span> script my_backup_script\n<span class=\"token keyword\">comment</span> <span class=\"token string\">'itpux'</span>\n{\n  <span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span> plus archivelog<span class=\"token punctuation\">;</span>\n}\n</code></pre>\n</blockquote>\n</li>\n<li>修改存储脚本<blockquote>\n<p>使用replace script 命令可以替换恢复目录中的存储脚本。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> replace script my_backup_script\n<span class=\"token keyword\">comment</span> <span class=\"token string\">'bl'</span>\n{\n  <span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span> plus archivelog <span class=\"token keyword\">delete</span> input<span class=\"token punctuation\">;</span>\n}\n</code></pre>\n</blockquote>\n</li>\n<li>删除存储脚本<blockquote>\n<p>使用delete script命令可以删除一个存储脚本。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> <span class=\"token keyword\">Delete</span> script my_backup_script<span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n<li><p>使用存储脚本</p>\n<blockquote>\n<p>创建一些存储过程脚本后，可以执行execute script命令来使用这些脚本。如：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">run { <span class=\"token keyword\">execute</span> script my_backup_script<span class=\"token punctuation\">;</span> }\n</code></pre>\n</blockquote>\n</li>\n<li><p>打印存储的脚本</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> <span class=\"token keyword\">Print</span> script my_backup_script<span class=\"token punctuation\">;</span>\n正在打印存储的脚本: my_backup_script\n{<span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span> plus archivelog<span class=\"token punctuation\">;</span>}\n</code></pre>\n</li>\n</ul>\n<blockquote>\n<p>还可以使用RC_STORED_SCRIPT_LINE恢复目录视图来显示存储的脚本的内容，如：<br><code>`</code>sql<br>SQL&gt; select script_name,text from rc_stored_script_line order by script_name,line;<br>SCRIPT_NAME TEXT</p>\n</blockquote>\n<hr>\n<p>my_backup_script {<br>    my_backup_script backup database plus archivelog delete input;<br>my_backup_script }</p>\n<pre><code>### 3.7 查看并修改单个参数\n```sql\nrman&gt; show all;\nusing target database control file instead of recoverycatalog\nrman configuration parameters are:\n</code></pre><h3 id=\"3-8-查看并修改单个参数\"><a href=\"#3-8-查看并修改单个参数\" class=\"headerlink\" title=\"3.8 查看并修改单个参数\"></a>3.8 查看并修改单个参数</h3><pre class=\" language-sql\"><code class=\"language-sql\">rman<span class=\"token operator\">></span><span class=\"token keyword\">show</span> retention policy<span class=\"token punctuation\">;</span>\nrman<span class=\"token operator\">></span><span class=\"token keyword\">show</span> <span class=\"token keyword\">backup</span> optimization<span class=\"token punctuation\">;</span>\nrman<span class=\"token operator\">></span><span class=\"token keyword\">show</span> controlfile autobackup<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">-----查看当前参数的值，是off。</span>\nrman<span class=\"token operator\">></span>configure controlfile autobackup <span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--修改为on，自动备份控制文件</span>\nrman<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> controlfile autobackup<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">---查看修改后的，已经修改成功。</span>\nrman<span class=\"token operator\">></span> configurechannel <span class=\"token number\">1</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> format <span class=\"token string\">'/dbbak/bak_%d_%m_%d_%u'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--注释：配置数据文件的备份路径.</span>\nrman<span class=\"token operator\">></span> configurecontrolfile autobackup format <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token string\">'%f'</span><span class=\"token punctuation\">;</span> 注释：配置控制文件的备份路径\nrman<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">------查看所有信息，看到已经更改了默认备份路径</span>\n</code></pre>\n<h3 id=\"3-8-备份文件的格式\"><a href=\"#3-8-备份文件的格式\" class=\"headerlink\" title=\"3.8 备份文件的格式\"></a>3.8 备份文件的格式</h3><pre class=\" language-sql\"><code class=\"language-sql\">备份文件可定义的格式符号如下\n使用format参数时可使用的各种替换变量，如下（注意大小写）所示：\n<span class=\"token operator\">%</span><span class=\"token number\">a</span>：Oracle数据库的activation ID即RESETLOG_ID。\n<span class=\"token operator\">%</span><span class=\"token number\">c</span>：备份片段的复制数（从<span class=\"token number\">1</span>开始编号，最大不超过<span class=\"token number\">256</span>）。\n<span class=\"token operator\">%</span><span class=\"token number\">d</span>：Oracle数据库名称。\n<span class=\"token operator\">%</span>D：当前时间中的日，格式为DD。\n<span class=\"token operator\">%</span><span class=\"token number\">e</span>：归档序号。\n<span class=\"token operator\">%</span><span class=\"token number\">f</span>：绝对文件编号。\n<span class=\"token operator\">%</span>F：基于<span class=\"token string\">\"DBID+时间\"</span>确定的唯一名称，格式的形式为<span class=\"token number\">c</span><span class=\"token operator\">-</span>IIIIIIIIII<span class=\"token operator\">-</span>YYYYMMDD<span class=\"token operator\">-</span>QQ<span class=\"token punctuation\">,</span>其中IIIIIIIIII 为该数据库的DBID，YYYYMMDD为日期，QQ是一个<span class=\"token number\">1</span>～<span class=\"token number\">256</span>的序列。\n<span class=\"token operator\">%</span>h：归档日志线程号。\n<span class=\"token operator\">%</span>I：Oracle数据库的DBID。\n<span class=\"token operator\">%</span>M：当前时间中的月，格式为MM。\n<span class=\"token operator\">%</span>N：表空间名称。\n<span class=\"token operator\">%</span>n：数据库名称，并且会在右侧用x字符进行填充，使其保持长度为<span class=\"token number\">8</span>。比如数据库名JSSBOOK，则生成的名称则是JSSBOOKx。\n<span class=\"token operator\">%</span>p：备份集中备份片段的编号，从<span class=\"token number\">1</span>开始。\n<span class=\"token operator\">%</span>s：备份集号。\n<span class=\"token operator\">%</span>t：备份集时间戳。\n<span class=\"token operator\">%</span>T：当前时间的年月日格式（YYYYMMDD）。\n<span class=\"token operator\">%</span>u：是一个由备份集编号和建立时间压缩后组成的<span class=\"token number\">8</span>字符名称。利用<span class=\"token operator\">%</span>u可以为每个备份集生成一个唯一的名称。\n<span class=\"token operator\">%</span>U：默认是<span class=\"token operator\">%</span>u_<span class=\"token operator\">%</span>p_<span class=\"token operator\">%</span><span class=\"token number\">c</span>的简写形式，利用它可以为每一个备份片段（即磁盘文件）\n</code></pre>\n<h3 id=\"3-9-详解整个rman全备案例\"><a href=\"#3-9-详解整个rman全备案例\" class=\"headerlink\" title=\"3.9 详解整个rman全备案例\"></a>3.9 详解整个rman全备案例</h3><blockquote>\n<p>执行rman备份必须开启数据的归档功能：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">sql<span class=\"token operator\">></span> <span class=\"token keyword\">shutdown</span> immediate <span class=\"token comment\" spellcheck=\"true\">---关闭数据库</span>\nsql<span class=\"token operator\">></span> startup mount<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">----启动数据库到mount状态</span>\nsql<span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> archivelog<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">---开启归档功能</span>\n<span class=\"token keyword\">database</span> altered<span class=\"token punctuation\">.</span>\nsql<span class=\"token operator\">></span> archivelog list<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">---查看归档状态</span>\n<span class=\"token keyword\">database</span> logmode archive mode <span class=\"token comment\" spellcheck=\"true\">---归档已经打开</span>\nautomatic archival enabled\narchive destination use_db_recovery_file_dest\noldest online logsequence <span class=\"token number\">8</span>\n<span class=\"token keyword\">next</span> log sequence toarchive <span class=\"token number\">10</span>\n<span class=\"token keyword\">current</span> log sequence <span class=\"token number\">10</span>\nsql<span class=\"token operator\">></span>\n</code></pre>\n</blockquote>\n<h2 id=\"4-详解-RMAN的常用命令及日常维护\"><a href=\"#4-详解-RMAN的常用命令及日常维护\" class=\"headerlink\" title=\"4. 详解 RMAN的常用命令及日常维护\"></a>4. 详解 RMAN的常用命令及日常维护</h2><h3 id=\"4-1-rman所备份的数据库信息查看\"><a href=\"#4-1-rman所备份的数据库信息查看\" class=\"headerlink\" title=\"4.1 rman所备份的数据库信息查看\"></a>4.1 rman所备份的数据库信息查看</h3><ul>\n<li><ol>\n<li>list incarnation<blockquote>\n<p>概述可用的备份<br>b 表示backup<br>a 表示archivelog、 f 表示full backup、 0,1,2 表示incremental level备份<br>a 表示可用avaliable、 x 表示expired</p>\n</blockquote>\n</li>\n</ol>\n</li>\n</ul>\n<blockquote>\n<p>这个命令可以派生出很多类似命令，例如<br>list backup of database summary<br>list backup of archivelog all summary<br>list backup of tablespace users summary;<br>list backup of datafile n,n,n summary</p>\n<ul>\n<li><ol start=\"2\">\n<li>list backup summary;<br>列出过期的备份文件</li>\n</ol>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li><ol start=\"3\">\n<li>list backup by file;<blockquote>\n<p>按照文件类型分别列出<br>分别为：数据文件列表、归档日志列表、控制文件列表、spfile列表</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>list backup<blockquote>\n<p>这个命令列出已有备份集的详细信息。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>list expired backup;<blockquote>\n<p>列出过期的备份文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>list copy;<blockquote>\n<p>列出copy文件</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">list copy <span class=\"token keyword\">of</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> controlfile<span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> <span class=\"token keyword\">tablespace</span> users<span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> datafile n<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> archivelog <span class=\"token keyword\">from</span> scn <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span>\nlist copy <span class=\"token keyword\">of</span> archivelog until sequence <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"7\">\n<li>list backup of spfile;<blockquote>\n<p>服务器参数文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"8\">\n<li>list backup of controlfile;<blockquote>\n<p>控制文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"9\">\n<li>list backup of datafle n,n,n,n;<blockquote>\n<p>数据文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"10\">\n<li>list backup of tablespace tablespace_name;<blockquote>\n<p>表空间对应的backup</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"11\">\n<li>归档日志<pre class=\" language-sql\"><code class=\"language-sql\">list <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog {<span class=\"token keyword\">all</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> high<span class=\"token punctuation\">,</span> <span class=\"token operator\">like</span><span class=\"token punctuation\">,</span> logseq<span class=\"token punctuation\">,</span> low<span class=\"token punctuation\">,</span> scn<span class=\"token punctuation\">,</span> sequence<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">,</span> until}<span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog until time <span class=\"token string\">'sysdate-1'</span><span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog <span class=\"token keyword\">from</span> sequence <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog until sequence <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog <span class=\"token keyword\">from</span> scn <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span>\nlist <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> archivelog until scn <span class=\"token number\">200000</span><span class=\"token punctuation\">;</span>\nlist archivelog <span class=\"token keyword\">from</span> scn <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\nlist archivelog until scn <span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>\nlist archivelog <span class=\"token keyword\">from</span> sequence <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\nlist archivelog until sequence <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"4-2-report常用命令\"><a href=\"#4-2-report常用命令\" class=\"headerlink\" title=\"4.2 report常用命令\"></a>4.2 report常用命令</h3><blockquote>\n<p>report用于判断数据库当前可恢复状态、以及数据库已有备份的信息。</p>\n</blockquote>\n<ul>\n<li><p>01.report schema</p>\n<blockquote>\n<p>报告数据库模式</p>\n</blockquote>\n</li>\n<li><p>02.report obsolete;</p>\n<blockquote>\n<p>报告已丢弃的备份集(配置了保留策略)。</p>\n</blockquote>\n</li>\n<li><p>03.report unrecoverable;</p>\n<blockquote>\n<p>报告当前数据库中不可恢复的数据文件(即没有这个数据文件的备份、或者该数据文件的备份已经过期)</p>\n</blockquote>\n</li>\n<li><p>04.report need backup;</p>\n<blockquote>\n<p>报告需要备份的数据文件(根据条件不同)</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">report need <span class=\"token keyword\">backup</span> days<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--最近三天没有备份的数据文件(如果出问题的话，这些数据文件将需要最近3天的归档日志才能恢复)</span>\nreport need <span class=\"token keyword\">backup</span> incremental<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--需要多少个增量备份文件才能恢复的数据文件。(如果出问题，这些数据文件将需要3个增量备份才能恢复)</span>\nreport need <span class=\"token keyword\">backup</span> redundancy<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--报告出冗余次数小于3的数据文件</span>\n<span class=\"token comment\" spellcheck=\"true\">--例如数据文件中包含2个数据文件system01.dbf和users01.dbf.</span>\n<span class=\"token comment\" spellcheck=\"true\">--在3次或都3次以上备份中都包含system01.dbf这个数据文件，而users01.dbf则小于3次</span>\n<span class=\"token comment\" spellcheck=\"true\">--那么，报告出来的数据文件就是users01.dbf</span>\n<span class=\"token comment\" spellcheck=\"true\">--即，报告出数据库中冗余次数小于 n 的数据文件</span>\nreport need <span class=\"token keyword\">backup</span> recovery window <span class=\"token keyword\">of</span> <span class=\"token number\">2</span> days<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--报告出恢复需要2天归档日志的数据文件</span>\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-3-backup常用命令\"><a href=\"#4-3-backup常用命令\" class=\"headerlink\" title=\"4.3 backup常用命令\"></a>4.3 backup常用命令</h3><h4 id=\"4-3-1-基本使用\"><a href=\"#4-3-1-基本使用\" class=\"headerlink\" title=\"4.3.1 基本使用\"></a>4.3.1 基本使用</h4><ul>\n<li><p>01.设置备份标记</p>\n</li>\n<li><p>01.设置备份集大小(一次备份的所有结果为一个备份集，要注意备份集大小)</p>\n</li>\n<li><p>01.设置备份片大小(磁带或文件系统限制)</p>\n</li>\n<li><p>01.备份集的保存策略</p>\n</li>\n<li><p>01.重写configure exclude命令</p>\n</li>\n<li><p>01.检查数据库错误</p>\n</li>\n<li><p>01.跳过脱机，不可存取或只读文件</p>\n</li>\n</ul>\n<ul>\n<li><p>01.强制备份</p>\n</li>\n<li><p>01.基于上次备份时间备份数据文件</p>\n</li>\n<li><p>01.备份操作期间检查逻辑错误</p>\n</li>\n<li><p>01.生成备份副本</p>\n</li>\n<li><p>01.备份控制文件和参数文件</p>\n</li>\n<li><p>01.跳过脱机的，不可读取的或者只读的数据文件</p>\n</li>\n<li><p>01.数据库备份</p>\n</li>\n<li><p>01.表空间备份</p>\n</li>\n<li><p>01.数据文件备份</p>\n</li>\n<li><p>01.归档的重做日志备份</p>\n</li>\n<li><p>01.数据库，表空间和数据文件的映像副本</p>\n</li>\n<li><p>01.控制文件副本</p>\n</li>\n<li><p>01.Archivelog 映像副本</p>\n</li>\n<li><p>01.差异备份与增量备份</p>\n</li>\n</ul>\n<h4 id=\"4-3-1-差异备份与增量备份\"><a href=\"#4-3-1-差异备份与增量备份\" class=\"headerlink\" title=\"4.3.1 差异备份与增量备份\"></a>4.3.1 差异备份与增量备份</h4><ul>\n<li>块更改跟踪文件<blockquote>\n<p>&emsp;&emsp;默认情况下，当执行增量备份时，发生任何更改的所有数据文件都将备份。 这可能使增量备份花费更长的时间，并且会增加增量备份的大小。 10g中RMAN 提供了只备份更改过的数据块的功能。 这就可以加快增量数据库备份的速度并减少其大小。 执行alter database enable block change tracking 命令可以启用块更改跟踪。<br>&emsp;&emsp;如果使用Oracle管理文件（OMF），Oracle 将会创建块更改跟踪文件。 如果没有使用OMF，则必须定义块更改跟踪文件的位置和名称。 如：<br>Alter database enable block change tracking using file ‘/oracle/backup/block.fil’;<br>&emsp;&emsp;如果跟踪文件已经存在，可以使用reuse参数：<br>Alter database enable block change tracking using file ‘/oracle/backup/block.fil’ reuse;<br>&emsp;&emsp;使用alter database block change tracking 命令可以禁用块更改跟踪。 块更改跟踪文件的大小通常预先分片且与数据库大小和重做日志线程的数量有关。 块更改跟踪文件的大小一般是数据库大小的1/30000。 块更改跟踪文件可能会以10MB为增量增长。 块更改跟踪文件的最小尺寸是每个数据文件320k，如果有许多数据文件，则块更改跟踪文件就会较大。 Oracle 会在块更改跟踪文件中存储足够的信息，从而允许最多8天的增量备份。 显而易见，如果增量备份超过8天，则将不使用块跟踪更改跟踪文件，并且无法利用块跟踪文件的有点。<br>&emsp;&emsp;可以通过检查v$block_change_tracking 视图来确定是否启用了块更改跟踪。 Status 指示了是否启用了块更改跟踪，filename 包含块更改跟踪文件的文件名。可以通过alter database rename file 命令来转移块更改跟踪文件。<br><code>`</code>sql<br>SQL&gt; select status,filename from v$block_change_tracking;<br>STATUS FILENAME</p>\n</blockquote>\n</li>\n</ul>\n<hr>\n<p>ENABLED /oracle/BACKUP/BLOCK.FIL</p>\n<pre><code>* 基本备份\n&gt;&amp;emsp;&amp;emsp;执行增量备份操作时，首先需要的是增量基本备份（incremental base backup）,以后所有的增量备份都基于这个基本备份。 每次执行数据库备份操作时，都可以通过backup 命令的incremental 参数来为备份指定一个增量级别标识符。 基本备份的增量级别为0，并且必须有基本备份才能够执行其他类型的增量备份操作。 如果没有生成基本备份就尝试执行增量备份操作，RMAN会自动执行基本备份操作。 示例：\n```sql\nBackup incremental level=0 database;\n</code></pre><ul>\n<li>差异备份<blockquote>\n<p>&emsp;&emsp;差异备份是RMAN生成的增量备份的默认类型，对于差异备份来说，RMAN会备份自上次同级或者低级差异增量备份以来所发生变化的数据块</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n<li>累积备份<blockquote>\n<p>&emsp;&emsp;累积备份可以使备份集备份前面所有级别的备份以及此次要备份的所有发生变化的数据块。 累积备份是一个可选的备份方法，并要求在backup 命令中使用cumulative 关键字。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">backup</span> incremental level <span class=\"token operator\">=</span><span class=\"token number\">2</span> cumulative <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n<li>增量备份选项<blockquote>\n<p>&emsp;&emsp;Oracle 不仅允许执行数据库的增量备份，还允许执行表空间，数据文件以及数据库文件副本的增量备份操作。 控制文件，归档重做日志以及备份集都不能生成增量备份。 此外，还可以在执行增量备份操作时同时备份归档的重做日志。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">Backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token keyword\">tablespace</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">tablespace</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">0</span> datafile <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">1</span> datafile <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Backup</span> incremental level<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">database</span> plus archivelog<span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n<li>增量备份更新备份<blockquote>\n<p>RMAN 提供了增量备份更新备份。 这种备份避免了采用数据文件的完整映像副本进行备份的开销，并且具有与映像副本相同的恢复特性。 从某种意义上来说，这种备份类似与使用映像副本的增量备份。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">Run{\nRecover copy <span class=\"token keyword\">of</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">with</span> tag <span class=\"token string\">'Orcl'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Backup</span> incremental level <span class=\"token number\">1</span> <span class=\"token keyword\">for</span> recover <span class=\"token keyword\">of</span> copy <span class=\"token keyword\">with</span> tag <span class=\"token string\">'Orcl'</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n}\n</code></pre>\n<p>&emsp;&emsp;示例中的recover of copy database 命令并没有真正的恢复数据库，但它使RMAN将任何增量备份应用于与列出标记（Orcl）关联的数据文件副本。 第一次运行该命令时，它将没有任何效果，因为它没有任何可用的增量备份或数据文件副本。 这并不是很严重的问题，并且RMAN 将只显示一条警告消息。 第二次运行该命令时也没有任何效果，因为没有任何增量备份可用。<br>&emsp;&emsp;执行recover 命令后，就会产生一个增量备份，这个备份第一次运行时，它会创建一个基本备份（如果没有的话）。这实际上增量为1的备份。 第二次执行这个run代码块时，将通过backup 命令执行第一个增量备份。<br>&emsp;&emsp;一旦该命令运行了2次，第三次执行和后面的执行就能够将前面的增量备份应用与数据文件副本。 注意，recover 和backup命令中将标记赋予相同的名称非常重要。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-4-configure常用命令\"><a href=\"#4-4-configure常用命令\" class=\"headerlink\" title=\"4.4 configure常用命令\"></a>4.4 configure常用命令</h3><ul>\n<li><ol>\n<li>显示当前的配置信息<pre class=\" language-sql\"><code class=\"language-sql\">rman<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\nrman 配置参数为:\nconfigure retention policy <span class=\"token keyword\">to</span> redundancy <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure <span class=\"token keyword\">backup</span> optimization <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure controlfile autobackup <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure controlfile autobackup format <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token string\">'%f'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> parallelism <span class=\"token number\">1</span> <span class=\"token keyword\">backup</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> backupset<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure datafile <span class=\"token keyword\">backup</span> copies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure archivelog <span class=\"token keyword\">backup</span> copies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure maxsetsize <span class=\"token keyword\">to</span> unlimited<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure encryption <span class=\"token keyword\">for</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure encryption <span class=\"token keyword\">algorithm</span> <span class=\"token string\">'aes128'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure archivelog deletion policy <span class=\"token keyword\">to</span> none<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure <span class=\"token keyword\">snapshot</span> controlfile name <span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/product/11.2.0/db_1/database/sncfitpuxdb.ora'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\nconfigure retention policy <span class=\"token keyword\">to</span> redundancy <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置redundancy配置需要保留几份备份文件，默认是<span class=\"token number\">1</span>。也可以改变为其它非零的正整数值。\nconfigure <span class=\"token keyword\">backup</span> optimization <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：设备备份优化打开，如果表空间是只读状态，那么在做备份的时候只是第一次会备份，以后不备份。有两个选项<span class=\"token keyword\">off</span>关闭和<span class=\"token keyword\">on</span>打开\nconfigure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置默认备份设备可以是sbt（磁带），<span class=\"token keyword\">disk</span>（硬盘）；默认是硬盘\nconfigure controlfile autobackup <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置在备份的时候是否将控制文件一并备份，两个选项<span class=\"token punctuation\">,</span>默认是<span class=\"token keyword\">off</span>不备份，也可以是<span class=\"token keyword\">on</span>备份、。\nconfigure controlfile autobackupformat <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token string\">'%f'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置control <span class=\"token keyword\">file</span>自动备份的路径和文件格式\nconfigure device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> parallelism1 <span class=\"token keyword\">backup</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> backupset<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置磁盘备份的类型，默认是备份集方式（backupset）或镜像拷贝也叫文件拷贝<span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span>。\n镜像拷贝值适用于磁盘备份，磁带只支持备份集。一般用备份集更多，其效率会更高\nconfigure datafile backupcopies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置生成备份集的个数，默认是<span class=\"token number\">1</span>；备份集内会包括（数据文件，控制文件，参数文件）\nconfigure archivelog backupcopies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置归档日志默认的备份路径\nconfigure maxsetsize <span class=\"token keyword\">to</span> unlimited<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置单个备份集大小，缺省是不限制，我们可以配置成1g<span class=\"token operator\">/</span>100m<span class=\"token operator\">/</span>1024k <span class=\"token operator\">or</span> other\nconfigure encryption <span class=\"token keyword\">for</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置备份数据加密，是10gr2推出来的新功能，设置为<span class=\"token keyword\">on</span>后。\n可以<span class=\"token keyword\">set</span> encryption <span class=\"token keyword\">on</span> identifyed <span class=\"token keyword\">by</span> youpassword only<span class=\"token punctuation\">;</span>加密备份，还原的时候需要提供密码。\nconfigureencryption <span class=\"token keyword\">algorithm</span> <span class=\"token string\">'aes128'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：指定备份数据加密的类型。\nconfigure archivelogdeletion policy <span class=\"token keyword\">to</span> none<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置归档日志在备份后自动删除\nconfigure <span class=\"token keyword\">snapshot</span> controlfile name <span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/product/10.2.0/db_1/dbs/snapcf_itpuxdb.f'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\"># default</span>\n注释：配置控制文件快照，可以有效的提高控制文件的恢复性。\n查询rman设置中非默认值:\nsql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span><span class=\"token keyword\">value</span> <span class=\"token keyword\">from</span> v$rman_configuration<span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>保存策略 (retention policy)<pre class=\" language-sql\"><code class=\"language-sql\">configure retention policy <span class=\"token keyword\">to</span> recovery window <span class=\"token keyword\">of</span> <span class=\"token number\">7</span> days<span class=\"token punctuation\">;</span>\nconfigure retention policy <span class=\"token keyword\">to</span> redundancy <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\nconfigure retention policy clear<span class=\"token punctuation\">;</span>\nconfigure retention policy <span class=\"token keyword\">to</span> none<span class=\"token punctuation\">;</span>\n第一种recover window是保持所有足够的备份，可以将数据库系统恢复到最近七天内的任意时刻。任何超过最近七天的数据库备份将被标记为obsolete。\n第二种redundancy 是为了保持可以恢复的最新的<span class=\"token number\">5</span>份数据库备份，任何超过最新<span class=\"token number\">5</span>份的备份都将被标记为redundancy。它的默认值是<span class=\"token number\">1</span>份。\n第三、四：none 可以把使备份保持策略失效，clear 将恢复默认的保持策略\n一般最安全的方法是采用第二种保持策略。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>备份优化 backup optimization<pre class=\" language-sql\"><code class=\"language-sql\">configure <span class=\"token keyword\">backup</span> optimization <span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\nconfigure <span class=\"token keyword\">backup</span> optimization <span class=\"token keyword\">off</span><span class=\"token punctuation\">;</span>\nconfigure <span class=\"token keyword\">backup</span> optimization clear<span class=\"token punctuation\">;</span>\n默认值为关闭，如果打开，rman将对备份的数据文件及归档等文件进行一种优化的算法。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>默认设备 default device type<pre class=\" language-sql\"><code class=\"language-sql\">configure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\nconfigure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> stb<span class=\"token punctuation\">;</span>\nconfigure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> clear<span class=\"token punctuation\">;</span>\n是指定所有i<span class=\"token operator\">/</span>o操作的设备类型是硬盘或者磁带，默认值是硬盘\n磁带的设置是configure <span class=\"token keyword\">default</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">to</span> sbt<span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>控制文件 controlfile<pre class=\" language-sql\"><code class=\"language-sql\">configure controlfile autobackup <span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\nconfigure controlfile autobackup format <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">to</span> <span class=\"token string\">'/oracle/backup/conf_%F'</span><span class=\"token punctuation\">;</span>\nconfigure controlfile autobackup clear<span class=\"token punctuation\">;</span>\nconfigrue controlfile autobackup format <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> clear<span class=\"token punctuation\">;</span>\nCONFIGURE <span class=\"token keyword\">SNAPSHOT</span> CONTROLFILE NAME <span class=\"token keyword\">TO</span> <span class=\"token string\">'/oracle/backup/scontrofile.snp'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--是配置控制文件的快照文件的存放路径和文件名，这个快照文件是在备份期间产生的，用于控制文件的读一致性。</span>\nconfigure <span class=\"token keyword\">snapshot</span> controlfile name clear<span class=\"token punctuation\">;</span>\n强制数据库在备份文件或者执行改变数据库结构的命令之后将控制文件自动备份，默认值为关闭。这样可以避免控制文件和catalog丢失后，控制文件仍然可以恢复。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>并行数(通道数) device type disk|stb pallelism n;<pre class=\" language-sql\"><code class=\"language-sql\">configure device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token operator\">|</span>stb parallelism <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\nconfigure device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token operator\">|</span>stb clear<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">--用于清除上面的信道配置</span>\nconfigure channel device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> format <span class=\"token string\">'/oracle/backup/rman_%u'</span><span class=\"token punctuation\">;</span>\nconfigure channel device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> maxpiecesize 100m<span class=\"token punctuation\">;</span>\nconfigure channel device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> rate 1200k<span class=\"token punctuation\">;</span>\nconfigure channel <span class=\"token number\">1</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> format <span class=\"token string\">'/oracle/backup/rman_%u'</span><span class=\"token punctuation\">;</span>\nconfigure channel <span class=\"token number\">2</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> format <span class=\"token string\">'/oracle/backup/rman_%u'</span><span class=\"token punctuation\">;</span>\nconfigure channel <span class=\"token number\">1</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> maxpiecesize 100m<span class=\"token punctuation\">;</span>\n配置数据库设备类型的并行度。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>生成备份副本 datafile|archivelog backup copies<pre class=\" language-sql\"><code class=\"language-sql\">configure datafile <span class=\"token keyword\">backup</span> copies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token operator\">|</span>stb <span class=\"token keyword\">to</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\nconfigure archivelog <span class=\"token keyword\">backup</span> copies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token operator\">|</span>stb <span class=\"token keyword\">to</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--是设置数据库的归档日志的存放设备类型</span>\nconfigure datafile<span class=\"token operator\">|</span>archivelog <span class=\"token keyword\">backup</span> copies <span class=\"token keyword\">for</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token operator\">|</span>stb clear\n<span class=\"token keyword\">backup</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> <span class=\"token keyword\">database</span> format <span class=\"token string\">'/oracle/backup1/%u'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/oracle/backup2/%u'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/oracle/backup3/%u'</span><span class=\"token punctuation\">;</span>\n是配置数据库的每次备份的copy数量，oracle的每一次备份都可以有多份完全相同的拷贝。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>排除选项 exclude<pre class=\" language-sql\"><code class=\"language-sql\">configure exclude <span class=\"token keyword\">for</span> <span class=\"token keyword\">tablespace</span> USERS<span class=\"token punctuation\">;</span>\nconfigure exclude <span class=\"token keyword\">for</span> <span class=\"token keyword\">tablespace</span> USERS clear<span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>备份集大小 maxsetsize<pre class=\" language-sql\"><code class=\"language-sql\">configure maxsetsize <span class=\"token keyword\">to</span> 1g<span class=\"token operator\">|</span>1000m<span class=\"token operator\">|</span>1000000k<span class=\"token operator\">|</span>unlimited<span class=\"token punctuation\">;</span>\nconfigure maxsetsize clear<span class=\"token punctuation\">;</span>\n</code></pre>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"4-5-set-命令\"><a href=\"#4-5-set-命令\" class=\"headerlink\" title=\"4.5 set 命令\"></a>4.5 set 命令</h3><blockquote>\n<p>&emsp;&emsp;使用set 命令可以定义只应用于当前RMAN会话的设置。 set 命令的设置不是永久的，根据实际需求，可以采用两种方式来使用set 命令。</p>\n<ul>\n<li>在run 代码块外，我们可是执行下面的操作：<pre class=\" language-sql\"><code class=\"language-sql\">（<span class=\"token number\">1</span>）使用<span class=\"token keyword\">set</span> echo 命令在消息日志中显示RMAN 命令。\n（<span class=\"token number\">2</span>）使用<span class=\"token keyword\">set</span> dbid 命令指定一个数据库的数据库标识符（<span class=\"token keyword\">database</span> identifier： dbid）。\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li>某些set 命令只能在run代码块的限定范围内使用，常见的有：<blockquote>\n<p>（1）set newname 命令：用于执行表空间时间点恢复（TSPITR）或者数据库复制操作。 该命令允许指定新的数据库数据文件名。 将数据库移动到新的系统中并且文件系统名不同时，我们可以使用这个命令。使用set newname 命令时还需要使用switch 命令。<br>（2）set maxcorrupt for datafile: 使用该命令可以定义RMAN操作失败前锁允许的数据块讹误的最大数据。<br>（3）set archivelog destination: 使用该命令可以修改存储归档的重做日志的archive_log_dest_1 目标。<br>（4）set 命令和until 子句： 使用set命令和set 命令的until 子句可以定义数据库时间点恢复操作锁使用的具体时间点，SCN 或日志序列号。<br>（5）set backup copies命令： 使用该命令可以定义为备份集中的每个备份片应当创建的副本数。<br>（6）set command id: 使用该命令可以关联给定的服务器会话和给定的通道。<br>（7）set controlfile autoback format for device type: 使用该命令可以修改用于控制文件自动备份操作的默认格式。</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>&emsp;&emsp;例如： 要执行一个为每个备份片创建两个副本的被操作，并且允许数据文件的最大讹误数为10. 脚本如下：</p>\n</blockquote>\n<pre class=\" language-sql\"><code class=\"language-sql\">run{\n    <span class=\"token keyword\">set</span> maxcorrupt <span class=\"token keyword\">for</span> datafile <span class=\"token number\">3</span> <span class=\"token keyword\">to</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">set</span> <span class=\"token keyword\">backup</span> copies<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">backup</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">;</span>\n}\n<span class=\"token keyword\">set</span> until time <span class=\"token string\">\"to_date('2016-6-28 17:04:00','yyyy-mm-dd hh24:mi:ss')\"</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"4-5-crosscheck命令\"><a href=\"#4-5-crosscheck命令\" class=\"headerlink\" title=\"4.5 crosscheck命令\"></a>4.5 crosscheck命令</h3><ul>\n<li>交叉效验RMAN 备份<blockquote>\n<p>&emsp;&emsp;在RMAN目录和物理备份目的地不同步的情况下，我们可以使用crosscheck命令来效验控制文件或恢复目录中的RMAN信息是否与备份介质上的实际物理备份集片相同。<br>&emsp;&emsp;使用crosscheck 命令时，我们关心每个备份集或者副本的状态。 如果使用控制文件，用于备份集片的v$backup_set 视图和用于副本的v$databfile_copy 视图中的status列列出了每个备份集或副本的状态码；如果使用恢复目录，则在备份集片的RC_BACKUP_set和副本的RC_DATAFILE_COPY中列出了每个备份集或副本的状态码。 在不同的备份状态码中，我们关心以下两种状态：<br>&emsp;&emsp;（1）A（Available:可用）：RMAN 认定该项存在于备份介质上<br>&emsp;&emsp;（2）X（Expired:不可用）：这个备份集片或副本上存储的RMAN目录（即控制文件或恢复目录）中，但是并没有物理存在于备份介质上。<br>&emsp;&emsp;使用crosscheck 命令的目的是将RMAN目录的状态设置为AVAILABLE或者EXPIRED。 执行crosscheck时，RMAN检查目录中列出的每个备份集或副本并且判断他们是否存在与备份介质上。 如果备份集或副本不存在与备份介质上，它就会被标记为expired, 并且不能用于任何还原操作；如果备份集或副本存在与备份介质上，它就会维持available状态。 如果以前被标记为expired 的备份集或副本再次存在于备份介质上，crosscheck 命令就会将它标记回available。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">crosscheck <span class=\"token keyword\">backup</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;可以交叉效验数据文件备份，表空间备份，控制文件备份以及服务器参数文件备份。此外，可以通过识别与备份相关联的标记来选择要交叉效验和特定的备份。 基于使用的设备或者基于一个时间周期，我们甚至可以交叉效验所有的备份。 如：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">crosscheck <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> datafile <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> <span class=\"token keyword\">tablespace</span> users<span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> controlfile<span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> spfile<span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> tag<span class=\"token operator\">=</span><span class=\"token string\">'TEST'</span><span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> completed <span class=\"token keyword\">after</span> <span class=\"token string\">'sysdate-2'</span><span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> completed <span class=\"token operator\">between</span> <span class=\"token string\">'sysdate-5'</span> <span class=\"token operator\">and</span> <span class=\"token string\">'sysdate-2'</span><span class=\"token punctuation\">;</span>\ncrosscheck <span class=\"token keyword\">backup</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n<li>交叉验证归档日志示例：<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> crosscheck archivelog <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<blockquote>\n<p>&emsp;&emsp;我们可以基于一个号码或标准（包括时间，具体的或指定范围的SCN或日志序列号）来交叉效验归档的重做日志备份，甚至还可以使用like参数与通配符来交叉效验特定的归档日志备份。 如：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">crosscheck archivelog <span class=\"token operator\">like</span> <span class=\"token string\">'ARC001.log'</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog <span class=\"token string\">'/oracle/arch/itpuxdb/archivelog/2016_08_02/o1_mf_1_22_cszw2d4g_.arc'</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog <span class=\"token operator\">like</span> <span class=\"token string\">'%ARC00012.LOG'</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog <span class=\"token keyword\">from</span> time <span class=\"token string\">\"to_date('2016-08-02','yyyy-mm-dd')\"</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog until time <span class=\"token string\">\"to_date('2016-08-02','yyyy-mm-dd')\"</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog <span class=\"token keyword\">from</span> sequence <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\ncrosscheck archivelog until sequence <span class=\"token number\">522</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">--使用crosscheck copy命令还可以交叉效验副本。 包括数据文件副本，控制文件副本，归档重做日志副本以及磁盘上的归档的重做日志。 如：</span>\ncrosscheck copy <span class=\"token keyword\">of</span> datafile <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\ncrosscheck datafilecopy '<span class=\"token operator\">/</span>oracle<span class=\"token operator\">/</span>oradata<span class=\"token operator\">/</span>itpuxdb<span class=\"token operator\">/</span>rman_tbs<span class=\"token number\">.dbf</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-6-RMAN-备份的验证validate\"><a href=\"#4-6-RMAN-备份的验证validate\" class=\"headerlink\" title=\"4.6 RMAN 备份的验证validate\"></a>4.6 RMAN 备份的验证validate</h3><blockquote>\n<p>&emsp;&emsp;RMAN 提供的validate命令允许查看给定的备份集和进行验证以确保这个备份集能够被还原。注意，validate 命令必须要获得主键ID。 这个可以用list backup summary命令获取</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> list <span class=\"token keyword\">backup</span> summary<span class=\"token punctuation\">;</span>\nRMAN<span class=\"token operator\">></span> validate backupset <span class=\"token number\">206</span><span class=\"token punctuation\">;</span>\nRMAN<span class=\"token operator\">></span> validate backupset <span class=\"token number\">206</span> <span class=\"token keyword\">check</span> logical<span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n<h3 id=\"4-7-change-命令\"><a href=\"#4-7-change-命令\" class=\"headerlink\" title=\"4.7 change 命令\"></a>4.7 change 命令</h3><blockquote>\n<p>&emsp;&emsp;change 命令允许用户修改备份的状态。我们可能会遇到备份介质设备在某个时间爱你段中无效的情况（如突然断电）。这时，我们就可以使用change 命令来指示这个设备上的备份是不可用的。<br>&emsp;&emsp;解决硬件故障和修复磁盘后，额可以再次执行change 命令，将备份改为可用的状态。也可以将备份修改为不可用的状态。在还原和恢复操作期间，不会考虑哪些不可用的备份，但在执行delete expired命令期间这些备份记录不会被删除。 相关示例：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">change <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> <span class=\"token keyword\">database</span> tag<span class=\"token operator\">=</span><span class=\"token string\">'TEST'</span> unavailable<span class=\"token punctuation\">;</span>\nchange <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> <span class=\"token keyword\">database</span> <span class=\"token operator\">like</span> <span class=\"token string\">'%TEST%'</span> unavailable<span class=\"token punctuation\">;</span>\nchange backupset <span class=\"token number\">206</span> unavailable<span class=\"token punctuation\">;</span>\nchange backupset <span class=\"token number\">206</span> available<span class=\"token punctuation\">;</span>\nchange archivelog <span class=\"token string\">'/archivelog/arc0001.log'</span> unavailable<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;可以使用change命令修改归档的重做日志备份的状态。如：将已经备份了指定次数的所有归档的重做日志备份修改为不可用的状态，也可以修改特定设备上的所有备份的状态。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">change archivelog <span class=\"token keyword\">all</span> backed up <span class=\"token number\">5</span> times <span class=\"token keyword\">to</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> unavailable<span class=\"token punctuation\">;</span>\nchange <span class=\"token keyword\">backup</span> <span class=\"token keyword\">of</span> <span class=\"token keyword\">database</span> device <span class=\"token keyword\">type</span> <span class=\"token keyword\">disk</span> unavailable<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;可是使用带有delete 参数的change 命令删除备份集，即在备份介质上的物理删除，并且从控制文件和恢复目录中删除。 前提是要知道备份集关键字，可以使用list backup 或 list copy 命令查看。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> list <span class=\"token keyword\">backup</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>删除备份集1：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">RMAN<span class=\"token operator\">></span> change backupset <span class=\"token number\">206</span> <span class=\"token keyword\">delete</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<ul>\n<li>使用通道 ORA_DISK_1<br><code>`</code>sql<br>备份片段列表<br>BP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称</li>\n</ul>\n</blockquote>\n<hr>\n<p>1 1 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK<br>是否确定要删除以上对象 (输入 YES 或 NO)? yes<br>已删除备份片段<br>备份片段句柄=/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK RECID=1 STAMP=723758988<br>1 对象已删除<br>在上面的这个示例中，我们删除了备份集和它关联的备份片。 也可以删除一些备份片。 通过 list backup命令我们可以看到备份片的名称，比如：段名:/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK。<br>我们也可以查看备份片的号码，用catalog 用户连接数据库后，查看rc_backup_piece 表，SQL如下：<br>conn rman/rman<br>SQL&gt; select bs_key,bp_key,piece#,handle from rc_backup_piece;<br>BS_KEY BP_KEY PIECE# HANDLE</p>\n<hr>\n<p>52 55 1 /BACKUP/ORCL_02LI47UA_1_1<br>53 56 1 /BACKUP/ORCL_03LI47UF_1_1<br>75 82 1 /BACKUP/ORCL_04LI4816_1_1<br>删除备份片，我们可以用BP_KEY，也可以直接用段名（handle）,如：<br>RMAN&gt; change backuppiece ‘/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK’ delete;<br>使用通道 ORA_DISK_1<br>备份片段列表<br>BP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称</p>\n<hr>\n<p>2 2 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK<br>是否确定要删除以上对象 (输入 YES 或 NO)? yes<br>已删除备份片段<br>备份片段句柄=/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK RECID=2<br>STAMP=723758997<br>1 对象已删除<br>使用备份集片，如：<br>change backuppiece 622 delete;<br>change archivelog until logseq=20 delete;<br>最后，可以使用change backuppiece uncataog命令从目录中删除备份集片。 如果删除最后剩余的备份集片，那么它也将删除备份集记录。如：<br>change backuppiece ‘/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK’ uncatalog;</p>\n<pre><code>### 4.8 delete 命令\n&gt;&amp;emsp;&amp;emsp;备份集不是永远存在的。我们可以使用保存策略标记备份有效性和生存期的结束。但是，备份策略的实施不会从RMAN目录中删除备份，而只是将这些备份标记为丢弃状态。\n&gt;&amp;emsp;&amp;emsp;delete 命令对备份和副本的影响很大。通过delete命令，可以删除基于保存标准被标记为丢弃的任何备份，还可以将恢复目录或控制文件中的备份从expired状态变为\n\n* deleted状态\n```sql\ndelete expired;\ndelete obsolete;\n</code></pre><blockquote>\n<p>&emsp;&emsp;执行delete命令时，RMAN会请求用户确认这个删除命令，如果确认了这个删除命令，RMAN 就会完成delete操作。<br>&emsp;&emsp;注意： 如果一个备份被标记为deleted 状态，就不能恢复这个备份。 如果该备份物理可用，我们仍然可以使用dbms_backup_restore过程来恢复这个备份。</p>\n</blockquote>\n<h3 id=\"4-9-restore命令\"><a href=\"#4-9-restore命令\" class=\"headerlink\" title=\"4.9 restore命令\"></a>4.9 restore命令</h3><blockquote>\n<p>&emsp;&emsp;主要功能是从RMAN备份中还原文件，为恢复做准备。<br>使用restore 命令时，该命令会在没有认识提示的情况下重写已经存在的任何文件，除非使用set newname命令。<br><code>`</code>sql<br>set newname for datafile ‘/oracle/app/oradata/itpuxdb/itpux01.dbf’ to ‘E:/app/Administrator/oradata/orcl’;<br>restore database;</p>\n</blockquote>\n<p>restore controlfile from autobackup;<br>restore controlfile to ‘/backup/‘ from autobackup;<br>restore controlfile to ‘/backup’;<br>restore controlfile from autobackup until time “to_date(‘2016-6-27 13:25:00’,’yyyy-mm-dd hh24:mi:ss’)”;<br>restore controlfile from autobackup maxseq 200 maxdays 100;<br>restore spfile to pfile ‘/oracle/backup/spfile.restore’;<br>restore spfile to ‘/oracle/backup/spfile.restore’ from autobackup;<br>restore spfile from autobackup;<br>restore spfile from ‘/oracle/backup/c-1247395743-20160627-00’;<br>restore tablespace tablespace_name ;<br>restore datafile 5;<br>restore datafile ‘/oracle/app/oradata/itpuxdb/USERS01.DBF’;<br>restore database until time “to_date(‘2016-6-28 17:04:00’,’yyyy-mm-dd hh24:mi:ss’)”;<br>restore database until SCN 1000; –注意： 该示例可以将数据库还原到SCN 1000，但是不会包含SCN.<br>restore database until sequence 100 thread 1;</p>\n<p>restore archivelog all;<br>restore archivelog from logseq=20 thread=1;<br>restore archivelog from logseq=20 until logseq=30 thread=1;</p>\n<p>run<br>{<br>set archivelog destination to “d:/arch”;<br>restore archivelog all;<br>}</p>\n<p>restore database check readonly;<br>restore (datafile 5) from datafilecopy</p>\n<pre><code>### 4.10 recover命令\n&gt;&amp;emsp;&amp;emsp;recover 命令用于恢复数据库。该命令可以执行数据库的完全恢复或者时间点恢复。 Recover 命令确定需要哪些归档的重做日志，并且析取和应用他们。 一旦完成重做的应用，我们就只需要使用alter database open命令打开数据库即可。\n```sql\nrecover database\nrecover database noredo; -- 如果联机日志存在，可以用recover database代替\nrecover tablespace tablespace_name ;\nrecover datafile 3;\nrecover datafile &#39;/oracle/app/oradata/itpuxdb/USERS01.DBF&#39;;\nset until time &quot;to_date(&#39;2016-07-05 14:02:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)&quot;;\nrestore database;\nrecover database;\nalter database open resetlogs;\nrecover database until time &quot;to_date(&#39;2016-07-05 14:02:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)&quot;;\nrecover database until SCN 1000;\nrecover database until sequence 100 thread 1;\n</code></pre><h3 id=\"4-10-Switch-命令\"><a href=\"#4-10-Switch-命令\" class=\"headerlink\" title=\"4.10 Switch 命令\"></a>4.10 Switch 命令</h3><blockquote>\n<p>Switch 命令可以修改数据库控制文件中数据文件的位置，以反映Oracle数据库文件新的位置。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">Switch datafile <span class=\"token keyword\">all</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">-- 修改控制文件中数据文件位置</span>\n</code></pre>\n</blockquote>\n<h3 id=\"4-10-blockrecover\"><a href=\"#4-10-blockrecover\" class=\"headerlink\" title=\"4.10 blockrecover\"></a>4.10 blockrecover</h3><blockquote>\n<p>一般出现数据块错误时，都会有错误消息：<br>ORA-01578: ORACLE data block corrupted (file #18,block #88)<br>如果没有BMR时，我们必须从一个备份中恢复这个数据文件，在恢复过程中，用户不能使用该数据块文件中的所有数据。<br>用BMR恢复就很简单，只需要执行blockrecover命令即可：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">blockrecover datafile <span class=\"token number\">1</span> block <span class=\"token number\">88</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>如果有必要，可以同时恢复多个数据文件的多个数据块。如：</p>\n<pre class=\" language-sql\"><code class=\"language-sql\">blockrecover datafile <span class=\"token number\">18</span> block <span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token number\">17</span><span class=\"token punctuation\">,</span><span class=\"token number\">88</span><span class=\"token punctuation\">,</span><span class=\"token number\">108</span><span class=\"token punctuation\">;</span>\nblcokrecover datafile <span class=\"token number\">18</span> block <span class=\"token number\">88</span> datafile <span class=\"token number\">19</span> blcok <span class=\"token number\">188</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;查询v$database_block_corruption视图可以查看讹误数据块的详细信息。 如下所示，使用具有corruption list restore 参数的blockrecover命令可以方便地修正v$database_block_corruption 视图中的讹误数据块。<br>&emsp;&emsp;blockrecover corruption list restore until time ‘SYSDATE-5’;<br>这条命令将还原讹误列表中最近5天的所有讹误数据块。 在上面的命令中，还可以使用until time 和 until sequence.</p>\n</blockquote>\n<h3 id=\"4-10convert命令\"><a href=\"#4-10convert命令\" class=\"headerlink\" title=\"4.10convert命令\"></a>4.10convert命令</h3><blockquote>\n<p>&emsp;&emsp; Oracle 10g R2以后支持手工跨平台移动数据库，即使这些平台具有不同的尾数格式（endian format）。 尾数格式与字节排序有关，它有两种不同的格式，即大尾数和小尾数。 如果在不同尾数字节格式的平台之间移动数据库，就需要手工操作，并且使用RMAN的convert datafile 或者 convert tablespace命令来将传送的数据文件转换为正确的尾数格式。</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">convert</span> <span class=\"token keyword\">tablespace</span> ITPUX <span class=\"token keyword\">to</span> platform<span class=\"token operator\">=</span><span class=\"token string\">'AIX-Based Systems (64-bit)'</span>\ndb_file_name_convert<span class=\"token operator\">=</span><span class=\"token string\">'/oracle/app/oradata/itpux'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/oracle/itpux'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">convert</span> datafile <span class=\"token string\">'/oracle/app/oradata/itpux/itpux01.DBF'</span> <span class=\"token keyword\">from</span> platform\n<span class=\"token string\">'AIX-Based Systems (64-bit)'</span> db_file_name_convert <span class=\"token string\">'/oracle/app/oradata/itpux'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'/oracle/app/itpux'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n</blockquote>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Oracle-Rman-的备份-（基础）\"><a href=\"#Oracle-Rman-的备份-（基础）\" class=\"headerlink\" title=\"Oracle Rman 的备份 （基础）\"></a>Oracle Rman 的备份 （基础）</h1><p> <a href=\"https://docs.oracle.com/cd/E11882_01/backup.112/e10643/preface.htm#RCMRF89959\" target=\"_blank\" rel=\"noopener\">Oracle 11G R2 官方文档</a> </p>\n<h2 id=\"1-RMAN作用与体系架构\"><a href=\"#1-RMAN作用与体系架构\" class=\"headerlink\" title=\"1. RMAN作用与体系架构\"></a>1. RMAN作用与体系架构</h2><h2 id=\"2-nocatalog-余catalog-的介绍与catalog的配置\"><a href=\"#2-nocatalog-余catalog-的介绍与catalog的配置\" class=\"headerlink\" title=\"2. nocatalog 余catalog 的介绍与catalog的配置\"></a>2. nocatalog 余catalog 的介绍与catalog的配置</h2><h3 id=\"2-1-nocatalog介绍\"><a href=\"#2-1-nocatalog介绍\" class=\"headerlink\" title=\"2.1 nocatalog介绍\"></a>2.1 nocatalog介绍</h3><blockquote>\n<p>&emsp;&emsp;nocatalog方式 就是用control file作为catalog，每一次备份都要往控制文件里面写好多备份信息，控制文件里面会有越来越多的备份信息。因此，当使用rman nocatalog方式备份时，备份controlfile是非常重要的。</p>\n</blockquote>\n<blockquote>\n<p>&emsp;&emsp;由于nocatalog时利用controlfile存放备份信息，建议将oracle参数文件中的control_file_record_keep_time值加大（缺省为7天）, 参数在$oracle_home/dbs/initsid.ora中，该参数control_file__record_keep_time设置备份信息保存时间，到规定时间就自动清除以前的备份信息。</p>\n</blockquote>\n<pre><code class=\"sql\">--查看参数\nshow parameter control\n--修改时间为半个月\nalter system set control_file_record_keep_time=14 scope=both;\n--查看参数\nselect name,value,issys_modifiable from v$parameter where name=&#39;control_file_record_keep_time&#39;;\n</code></pre>\n<h3 id=\"2-2-catalog介绍\"><a href=\"#2-2-catalog介绍\" class=\"headerlink\" title=\"2.2 catalog介绍\"></a>2.2 catalog介绍</h3><blockquote>\n<p>&emsp;&emsp;恢复目录存储的是与rman 备份有关的元数据。在某种意义上，恢复目录可以看做是保存rman备份和恢复所需的相关信息的副本。<br>&emsp;&emsp;我们可以在oracle 数据库中在用户模式下创建恢复目录，这个恢复目录仅仅是一些数据包，表，索引和视图。<br>&emsp;&emsp;rman中的再同步命令会使得目标数据库控制文件中的内容刷新这些表中的数据。当然，区别在于恢复目录可以包含企业中所有数据库的信息，而控制文件只包含关于它自己的数据库的信息。</p>\n</blockquote>\n<h3 id=\"2-3-catalog恢复目录的配置过程\"><a href=\"#2-3-catalog恢复目录的配置过程\" class=\"headerlink\" title=\"2.3 catalog恢复目录的配置过程\"></a>2.3 catalog恢复目录的配置过程</h3><ul>\n<li><p>创建时需要的表空间</p>\n<pre><code class=\"sql\">create tablespace rman_tbs \n  datafile &#39;/u01/app/oracle/oradata/orcl/rman_tbs.dbf&#39;\n  size 1G \n  autoextend off;\n</code></pre>\n</li>\n<li><p>创建用户并授权<br><code>`</code>sql<br>create user rman<br>  identified by rman<br>  default tablespace rman_tbs;</p>\n</li>\n</ul>\n<p>grant connect,resource,recovery_catalog_owner to rman;</p>\n<pre><code>\n* 创建恢复目录\n```sql\nrman catalog rman/rman\ncreate catalog tablespace rman_tbs;\n--注意这里tablespace不能为rman\n</code></pre><ul>\n<li>配置rman 专用的监听<pre><code class=\"sql\">rman =\n  (description =\n      (address_list =\n          (address = (protocol = tcp)(host = orcl)(port = 1521))\n      )\n      (connect_data =\n          (sid = orcl)\n      )\n  )\n</code></pre>\n</li>\n</ul>\n<h2 id=\"3-详解-RMAN-的使用\"><a href=\"#3-详解-RMAN-的使用\" class=\"headerlink\" title=\"3. 详解 RMAN 的使用\"></a>3. 详解 RMAN 的使用</h2><h3 id=\"3-1-设置环境变量\"><a href=\"#3-1-设置环境变量\" class=\"headerlink\" title=\"3.1 设置环境变量\"></a>3.1 设置环境变量</h3><blockquote>\n<p>&emsp;&emsp;  修改oracle用户环境变量为如下，在linux系统中还有一个rman命令不是oracle的，如果在win环境下，可以直接使用cmd。<br>path=$oracle_home/bin:/sbin:$path<br>才可以使用rman命令</p>\n</blockquote>\n<h3 id=\"3-2-rman命令的帮助\"><a href=\"#3-2-rman命令的帮助\" class=\"headerlink\" title=\"3.2 rman命令的帮助\"></a>3.2 rman命令的帮助</h3><pre><code class=\"sql\">Argument     Value          Description\n-----------------------------------------------------------------------------\ntarget       quoted-string  connect-string for target database\ncatalog      quoted-string  connect-string for recovery catalog\nnocatalog    none           if specified, then no recovery catalog\ncmdfile      quoted-string  name of input command file\nlog          quoted-string  name of output message log file\ntrace        quoted-string  name of output debugging message log file\nappend       none           if specified, log is opened in append mode\ndebug        optional-args  activate debugging\nmsgno        none           show RMAN-nnnn prefix for all messages\nsend         quoted-string  send a command to the media manager\npipe         string         building block for pipe names\ntimeout      integer        number of seconds to wait for pipe input\nchecksyntax  none           check the command file for syntax errors\n-----------------------------------------------------------------------------\nBoth single and double quotes (&#39; or &quot;) are accepted for a quoted-string.\nQuotes are not required unless the string contains embedded white-space.\n</code></pre>\n<h3 id=\"3-3-rman连接信息介绍\"><a href=\"#3-3-rman连接信息介绍\" class=\"headerlink\" title=\"3.3 rman连接信息介绍\"></a>3.3 rman连接信息介绍</h3><ul>\n<li>连接到目标数据库<pre><code class=\"sql\">rman&gt;connect target user/pwd@db_name\n</code></pre>\n</li>\n<li>注意<blockquote>\n<p>1、connect不能简写为conn<br>2、连接user必须具备sysdba权限<br>3、连接的db_name必须在tnsnames.ora中有配置，且有效(即通过sqlplus可以连接）<br>4、target database必须为archivelog 模式<br>5、如果是本地可以采用os认证，如果是远程需要使用密码文件认证。<br>6、rman工具版本与目标数据库必须是同一版本。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"3-4-在rman里执行操作系统命令\"><a href=\"#3-4-在rman里执行操作系统命令\" class=\"headerlink\" title=\"3.4 在rman里执行操作系统命令\"></a>3.4 在rman里执行操作系统命令</h3><pre><code class=\"sql\">rman&gt; run{host &quot;ls -artl&quot;;}\nrman&gt; run{host &quot;ifconfig&quot;;}\nrman&gt; run{host &quot;pwd&quot;;}\n/home/oracle\nhost commandcomplete\nrman&gt; run{host &quot;ls&quot;;}\nrman&gt; exit\n</code></pre>\n<h3 id=\"3-5-在rman里执行数据库命令及sql语句\"><a href=\"#3-5-在rman里执行数据库命令及sql语句\" class=\"headerlink\" title=\"3.5 在rman里执行数据库命令及sql语句\"></a>3.5 在rman里执行数据库命令及sql语句</h3><pre><code class=\"sql\">rman&gt; shutdown immediate\nrman&gt; startup\nrman&gt; sql &#39;select * fromuser_tablespaces&#39;;\n</code></pre>\n<h3 id=\"3-6-在rman中保存脚本或执行脚本\"><a href=\"#3-6-在rman中保存脚本或执行脚本\" class=\"headerlink\" title=\"3.6 在rman中保存脚本或执行脚本\"></a>3.6 在rman中保存脚本或执行脚本</h3><blockquote>\n<p>在RMAN中，我们可以创建一个命令文件，里面包含rman命令，然后在RMAN的中调用这个文件。如：<br>Rman target usr/pwd cmdfile=backup.cmd<br>或者，也可以直接在RMAN 中直接运行</p>\n</blockquote>\n<ul>\n<li>创建存储的脚本<blockquote>\n<p>使用create script RMAN 命令可以在恢复目录中存储脚本。 创建每个存储的脚本时，都要为脚本指定一个名称。 可以创建执行数据库备份，恢复和维护操作的脚本。在脚本中，RMAN 允许使用comment 参数存储与存储脚本相关的注释。 注意： 必须连接到恢复目录。 如：</p>\n<pre><code class=\"sql\">RMAN&gt; create script my_backup_script\ncomment &#39;itpux&#39;\n{\n  backup database plus archivelog;\n}\n</code></pre>\n</blockquote>\n</li>\n<li>修改存储脚本<blockquote>\n<p>使用replace script 命令可以替换恢复目录中的存储脚本。</p>\n<pre><code class=\"sql\">RMAN&gt; replace script my_backup_script\ncomment &#39;bl&#39;\n{\n  backup database plus archivelog delete input;\n}\n</code></pre>\n</blockquote>\n</li>\n<li>删除存储脚本<blockquote>\n<p>使用delete script命令可以删除一个存储脚本。</p>\n<pre><code class=\"sql\">RMAN&gt; Delete script my_backup_script;\n</code></pre>\n</blockquote>\n</li>\n<li><p>使用存储脚本</p>\n<blockquote>\n<p>创建一些存储过程脚本后，可以执行execute script命令来使用这些脚本。如：</p>\n<pre><code class=\"sql\">run { execute script my_backup_script; }\n</code></pre>\n</blockquote>\n</li>\n<li><p>打印存储的脚本</p>\n<pre><code class=\"sql\">RMAN&gt; Print script my_backup_script;\n正在打印存储的脚本: my_backup_script\n{backup database plus archivelog;}\n</code></pre>\n</li>\n</ul>\n<blockquote>\n<p>还可以使用RC_STORED_SCRIPT_LINE恢复目录视图来显示存储的脚本的内容，如：<br><code>`</code>sql<br>SQL&gt; select script_name,text from rc_stored_script_line order by script_name,line;<br>SCRIPT_NAME TEXT</p>\n</blockquote>\n<hr>\n<p>my_backup_script {<br>    my_backup_script backup database plus archivelog delete input;<br>my_backup_script }</p>\n<pre><code>### 3.7 查看并修改单个参数\n```sql\nrman&gt; show all;\nusing target database control file instead of recoverycatalog\nrman configuration parameters are:\n</code></pre><h3 id=\"3-8-查看并修改单个参数\"><a href=\"#3-8-查看并修改单个参数\" class=\"headerlink\" title=\"3.8 查看并修改单个参数\"></a>3.8 查看并修改单个参数</h3><pre><code class=\"sql\">rman&gt;show retention policy;\nrman&gt;show backup optimization;\nrman&gt;show controlfile autobackup; -----查看当前参数的值，是off。\nrman&gt;configure controlfile autobackup on; --修改为on，自动备份控制文件\nrman&gt; show controlfile autobackup; ---查看修改后的，已经修改成功。\nrman&gt; configurechannel 1 device type disk format &#39;/dbbak/bak_%d_%m_%d_%u&#39;; --注释：配置数据文件的备份路径.\nrman&gt; configurecontrolfile autobackup format for device type disk to &#39;%f&#39;; 注释：配置控制文件的备份路径\nrman&gt; show all; ------查看所有信息，看到已经更改了默认备份路径\n</code></pre>\n<h3 id=\"3-8-备份文件的格式\"><a href=\"#3-8-备份文件的格式\" class=\"headerlink\" title=\"3.8 备份文件的格式\"></a>3.8 备份文件的格式</h3><pre><code class=\"sql\">备份文件可定义的格式符号如下\n使用format参数时可使用的各种替换变量，如下（注意大小写）所示：\n%a：Oracle数据库的activation ID即RESETLOG_ID。\n%c：备份片段的复制数（从1开始编号，最大不超过256）。\n%d：Oracle数据库名称。\n%D：当前时间中的日，格式为DD。\n%e：归档序号。\n%f：绝对文件编号。\n%F：基于&quot;DBID+时间&quot;确定的唯一名称，格式的形式为c-IIIIIIIIII-YYYYMMDD-QQ,其中IIIIIIIIII 为该数据库的DBID，YYYYMMDD为日期，QQ是一个1～256的序列。\n%h：归档日志线程号。\n%I：Oracle数据库的DBID。\n%M：当前时间中的月，格式为MM。\n%N：表空间名称。\n%n：数据库名称，并且会在右侧用x字符进行填充，使其保持长度为8。比如数据库名JSSBOOK，则生成的名称则是JSSBOOKx。\n%p：备份集中备份片段的编号，从1开始。\n%s：备份集号。\n%t：备份集时间戳。\n%T：当前时间的年月日格式（YYYYMMDD）。\n%u：是一个由备份集编号和建立时间压缩后组成的8字符名称。利用%u可以为每个备份集生成一个唯一的名称。\n%U：默认是%u_%p_%c的简写形式，利用它可以为每一个备份片段（即磁盘文件）\n</code></pre>\n<h3 id=\"3-9-详解整个rman全备案例\"><a href=\"#3-9-详解整个rman全备案例\" class=\"headerlink\" title=\"3.9 详解整个rman全备案例\"></a>3.9 详解整个rman全备案例</h3><blockquote>\n<p>执行rman备份必须开启数据的归档功能：</p>\n<pre><code class=\"sql\">sql&gt; shutdown immediate ---关闭数据库\nsql&gt; startup mount; ----启动数据库到mount状态\nsql&gt; alter database archivelog; ---开启归档功能\ndatabase altered.\nsql&gt; archivelog list; ---查看归档状态\ndatabase logmode archive mode ---归档已经打开\nautomatic archival enabled\narchive destination use_db_recovery_file_dest\noldest online logsequence 8\nnext log sequence toarchive 10\ncurrent log sequence 10\nsql&gt;\n</code></pre>\n</blockquote>\n<h2 id=\"4-详解-RMAN的常用命令及日常维护\"><a href=\"#4-详解-RMAN的常用命令及日常维护\" class=\"headerlink\" title=\"4. 详解 RMAN的常用命令及日常维护\"></a>4. 详解 RMAN的常用命令及日常维护</h2><h3 id=\"4-1-rman所备份的数据库信息查看\"><a href=\"#4-1-rman所备份的数据库信息查看\" class=\"headerlink\" title=\"4.1 rman所备份的数据库信息查看\"></a>4.1 rman所备份的数据库信息查看</h3><ul>\n<li><ol>\n<li>list incarnation<blockquote>\n<p>概述可用的备份<br>b 表示backup<br>a 表示archivelog、 f 表示full backup、 0,1,2 表示incremental level备份<br>a 表示可用avaliable、 x 表示expired</p>\n</blockquote>\n</li>\n</ol>\n</li>\n</ul>\n<blockquote>\n<p>这个命令可以派生出很多类似命令，例如<br>list backup of database summary<br>list backup of archivelog all summary<br>list backup of tablespace users summary;<br>list backup of datafile n,n,n summary</p>\n<ul>\n<li><ol start=\"2\">\n<li>list backup summary;<br>列出过期的备份文件</li>\n</ol>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li><ol start=\"3\">\n<li>list backup by file;<blockquote>\n<p>按照文件类型分别列出<br>分别为：数据文件列表、归档日志列表、控制文件列表、spfile列表</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>list backup<blockquote>\n<p>这个命令列出已有备份集的详细信息。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>list expired backup;<blockquote>\n<p>列出过期的备份文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>list copy;<blockquote>\n<p>列出copy文件</p>\n<pre><code class=\"sql\">list copy of database;\nlist copy of controlfile;\nlist copy of tablespace users;\nlist copy of datafile n,n,n;\nlist copy of archivelog all;\nlist copy of archivelog from scn 10000;\nlist copy of archivelog until sequence 12;\n</code></pre>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"7\">\n<li>list backup of spfile;<blockquote>\n<p>服务器参数文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"8\">\n<li>list backup of controlfile;<blockquote>\n<p>控制文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"9\">\n<li>list backup of datafle n,n,n,n;<blockquote>\n<p>数据文件</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"10\">\n<li>list backup of tablespace tablespace_name;<blockquote>\n<p>表空间对应的backup</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"11\">\n<li>归档日志<pre><code class=\"sql\">list backup of archivelog {all, from, high, like, logseq, low, scn, sequence, time, until};\nlist backup of archivelog all;\nlist backup of archivelog until time &#39;sysdate-1&#39;;\nlist backup of archivelog from sequence 10;\nlist backup of archivelog until sequence 10;\nlist backup of archivelog from scn 10000;\nlist backup of archivelog until scn 200000;\nlist archivelog from scn 1000;\nlist archivelog until scn 2000;\nlist archivelog from sequence 10;\nlist archivelog until sequence 12;\n</code></pre>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"4-2-report常用命令\"><a href=\"#4-2-report常用命令\" class=\"headerlink\" title=\"4.2 report常用命令\"></a>4.2 report常用命令</h3><blockquote>\n<p>report用于判断数据库当前可恢复状态、以及数据库已有备份的信息。</p>\n</blockquote>\n<ul>\n<li><p>01.report schema</p>\n<blockquote>\n<p>报告数据库模式</p>\n</blockquote>\n</li>\n<li><p>02.report obsolete;</p>\n<blockquote>\n<p>报告已丢弃的备份集(配置了保留策略)。</p>\n</blockquote>\n</li>\n<li><p>03.report unrecoverable;</p>\n<blockquote>\n<p>报告当前数据库中不可恢复的数据文件(即没有这个数据文件的备份、或者该数据文件的备份已经过期)</p>\n</blockquote>\n</li>\n<li><p>04.report need backup;</p>\n<blockquote>\n<p>报告需要备份的数据文件(根据条件不同)</p>\n<pre><code class=\"sql\">report need backup days=3;\n--最近三天没有备份的数据文件(如果出问题的话，这些数据文件将需要最近3天的归档日志才能恢复)\nreport need backup incremental=3;\n--需要多少个增量备份文件才能恢复的数据文件。(如果出问题，这些数据文件将需要3个增量备份才能恢复)\nreport need backup redundancy=3;\n--报告出冗余次数小于3的数据文件\n--例如数据文件中包含2个数据文件system01.dbf和users01.dbf.\n--在3次或都3次以上备份中都包含system01.dbf这个数据文件，而users01.dbf则小于3次\n--那么，报告出来的数据文件就是users01.dbf\n--即，报告出数据库中冗余次数小于 n 的数据文件\nreport need backup recovery window of 2 days;\n--报告出恢复需要2天归档日志的数据文件\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-3-backup常用命令\"><a href=\"#4-3-backup常用命令\" class=\"headerlink\" title=\"4.3 backup常用命令\"></a>4.3 backup常用命令</h3><h4 id=\"4-3-1-基本使用\"><a href=\"#4-3-1-基本使用\" class=\"headerlink\" title=\"4.3.1 基本使用\"></a>4.3.1 基本使用</h4><ul>\n<li><p>01.设置备份标记</p>\n</li>\n<li><p>01.设置备份集大小(一次备份的所有结果为一个备份集，要注意备份集大小)</p>\n</li>\n<li><p>01.设置备份片大小(磁带或文件系统限制)</p>\n</li>\n<li><p>01.备份集的保存策略</p>\n</li>\n<li><p>01.重写configure exclude命令</p>\n</li>\n<li><p>01.检查数据库错误</p>\n</li>\n<li><p>01.跳过脱机，不可存取或只读文件</p>\n</li>\n</ul>\n<ul>\n<li><p>01.强制备份</p>\n</li>\n<li><p>01.基于上次备份时间备份数据文件</p>\n</li>\n<li><p>01.备份操作期间检查逻辑错误</p>\n</li>\n<li><p>01.生成备份副本</p>\n</li>\n<li><p>01.备份控制文件和参数文件</p>\n</li>\n<li><p>01.跳过脱机的，不可读取的或者只读的数据文件</p>\n</li>\n<li><p>01.数据库备份</p>\n</li>\n<li><p>01.表空间备份</p>\n</li>\n<li><p>01.数据文件备份</p>\n</li>\n<li><p>01.归档的重做日志备份</p>\n</li>\n<li><p>01.数据库，表空间和数据文件的映像副本</p>\n</li>\n<li><p>01.控制文件副本</p>\n</li>\n<li><p>01.Archivelog 映像副本</p>\n</li>\n<li><p>01.差异备份与增量备份</p>\n</li>\n</ul>\n<h4 id=\"4-3-1-差异备份与增量备份\"><a href=\"#4-3-1-差异备份与增量备份\" class=\"headerlink\" title=\"4.3.1 差异备份与增量备份\"></a>4.3.1 差异备份与增量备份</h4><ul>\n<li>块更改跟踪文件<blockquote>\n<p>&emsp;&emsp;默认情况下，当执行增量备份时，发生任何更改的所有数据文件都将备份。 这可能使增量备份花费更长的时间，并且会增加增量备份的大小。 10g中RMAN 提供了只备份更改过的数据块的功能。 这就可以加快增量数据库备份的速度并减少其大小。 执行alter database enable block change tracking 命令可以启用块更改跟踪。<br>&emsp;&emsp;如果使用Oracle管理文件（OMF），Oracle 将会创建块更改跟踪文件。 如果没有使用OMF，则必须定义块更改跟踪文件的位置和名称。 如：<br>Alter database enable block change tracking using file ‘/oracle/backup/block.fil’;<br>&emsp;&emsp;如果跟踪文件已经存在，可以使用reuse参数：<br>Alter database enable block change tracking using file ‘/oracle/backup/block.fil’ reuse;<br>&emsp;&emsp;使用alter database block change tracking 命令可以禁用块更改跟踪。 块更改跟踪文件的大小通常预先分片且与数据库大小和重做日志线程的数量有关。 块更改跟踪文件的大小一般是数据库大小的1/30000。 块更改跟踪文件可能会以10MB为增量增长。 块更改跟踪文件的最小尺寸是每个数据文件320k，如果有许多数据文件，则块更改跟踪文件就会较大。 Oracle 会在块更改跟踪文件中存储足够的信息，从而允许最多8天的增量备份。 显而易见，如果增量备份超过8天，则将不使用块跟踪更改跟踪文件，并且无法利用块跟踪文件的有点。<br>&emsp;&emsp;可以通过检查v$block_change_tracking 视图来确定是否启用了块更改跟踪。 Status 指示了是否启用了块更改跟踪，filename 包含块更改跟踪文件的文件名。可以通过alter database rename file 命令来转移块更改跟踪文件。<br><code>`</code>sql<br>SQL&gt; select status,filename from v$block_change_tracking;<br>STATUS FILENAME</p>\n</blockquote>\n</li>\n</ul>\n<hr>\n<p>ENABLED /oracle/BACKUP/BLOCK.FIL</p>\n<pre><code>* 基本备份\n&gt;&amp;emsp;&amp;emsp;执行增量备份操作时，首先需要的是增量基本备份（incremental base backup）,以后所有的增量备份都基于这个基本备份。 每次执行数据库备份操作时，都可以通过backup 命令的incremental 参数来为备份指定一个增量级别标识符。 基本备份的增量级别为0，并且必须有基本备份才能够执行其他类型的增量备份操作。 如果没有生成基本备份就尝试执行增量备份操作，RMAN会自动执行基本备份操作。 示例：\n```sql\nBackup incremental level=0 database;\n</code></pre><ul>\n<li>差异备份<blockquote>\n<p>&emsp;&emsp;差异备份是RMAN生成的增量备份的默认类型，对于差异备份来说，RMAN会备份自上次同级或者低级差异增量备份以来所发生变化的数据块</p>\n<pre><code class=\"sql\">backup incremental level=1 database;\n</code></pre>\n</blockquote>\n</li>\n<li>累积备份<blockquote>\n<p>&emsp;&emsp;累积备份可以使备份集备份前面所有级别的备份以及此次要备份的所有发生变化的数据块。 累积备份是一个可选的备份方法，并要求在backup 命令中使用cumulative 关键字。</p>\n<pre><code class=\"sql\">backup incremental level =2 cumulative database;\n</code></pre>\n</blockquote>\n</li>\n<li>增量备份选项<blockquote>\n<p>&emsp;&emsp;Oracle 不仅允许执行数据库的增量备份，还允许执行表空间，数据文件以及数据库文件副本的增量备份操作。 控制文件，归档重做日志以及备份集都不能生成增量备份。 此外，还可以在执行增量备份操作时同时备份归档的重做日志。</p>\n<pre><code class=\"sql\">Backup incremental level=0 tablespace users;\nBackup incremental level=1 tablespace users;\nBackup incremental level=0 datafile 4;\nBackup incremental level=1 datafile 4;\nBackup incremental level=1 database plus archivelog;\n</code></pre>\n</blockquote>\n</li>\n<li>增量备份更新备份<blockquote>\n<p>RMAN 提供了增量备份更新备份。 这种备份避免了采用数据文件的完整映像副本进行备份的开销，并且具有与映像副本相同的恢复特性。 从某种意义上来说，这种备份类似与使用映像副本的增量备份。</p>\n<pre><code class=\"sql\">Run{\nRecover copy of database with tag &#39;Orcl&#39;;\nBackup incremental level 1 for recover of copy with tag &#39;Orcl&#39; database;\n}\n</code></pre>\n<p>&emsp;&emsp;示例中的recover of copy database 命令并没有真正的恢复数据库，但它使RMAN将任何增量备份应用于与列出标记（Orcl）关联的数据文件副本。 第一次运行该命令时，它将没有任何效果，因为它没有任何可用的增量备份或数据文件副本。 这并不是很严重的问题，并且RMAN 将只显示一条警告消息。 第二次运行该命令时也没有任何效果，因为没有任何增量备份可用。<br>&emsp;&emsp;执行recover 命令后，就会产生一个增量备份，这个备份第一次运行时，它会创建一个基本备份（如果没有的话）。这实际上增量为1的备份。 第二次执行这个run代码块时，将通过backup 命令执行第一个增量备份。<br>&emsp;&emsp;一旦该命令运行了2次，第三次执行和后面的执行就能够将前面的增量备份应用与数据文件副本。 注意，recover 和backup命令中将标记赋予相同的名称非常重要。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-4-configure常用命令\"><a href=\"#4-4-configure常用命令\" class=\"headerlink\" title=\"4.4 configure常用命令\"></a>4.4 configure常用命令</h3><ul>\n<li><ol>\n<li>显示当前的配置信息<pre><code class=\"sql\">rman&gt; show all;\nrman 配置参数为:\nconfigure retention policy to redundancy 1; # default\nconfigure backup optimization off; # default\nconfigure default device type to disk; # default\nconfigure controlfile autobackup off; # default\nconfigure controlfile autobackup format for device type disk to &#39;%f&#39;; # default\nconfigure device type disk parallelism 1 backup type to backupset; # default\nconfigure datafile backup copies for device type disk to 1; # default\nconfigure archivelog backup copies for device type disk to 1; # default\nconfigure maxsetsize to unlimited; # default\nconfigure encryption for database off; # default\nconfigure encryption algorithm &#39;aes128&#39;; # default\nconfigure archivelog deletion policy to none; # default\nconfigure snapshot controlfile name to &#39;/oracle/product/11.2.0/db_1/database/sncfitpuxdb.ora&#39;; # default\nconfigure retention policy to redundancy 1; # default\n注释：配置redundancy配置需要保留几份备份文件，默认是1。也可以改变为其它非零的正整数值。\nconfigure backup optimization off; # default\n注释：设备备份优化打开，如果表空间是只读状态，那么在做备份的时候只是第一次会备份，以后不备份。有两个选项off关闭和on打开\nconfigure default device type to disk; # default\n注释：配置默认备份设备可以是sbt（磁带），disk（硬盘）；默认是硬盘\nconfigure controlfile autobackup off;# default\n注释：配置在备份的时候是否将控制文件一并备份，两个选项,默认是off不备份，也可以是on备份、。\nconfigure controlfile autobackupformat for device type disk to &#39;%f&#39;; # default\n注释：配置control file自动备份的路径和文件格式\nconfigure device type disk parallelism1 backup type to backupset; # default\n注释：配置磁盘备份的类型，默认是备份集方式（backupset）或镜像拷贝也叫文件拷贝(copy)。\n镜像拷贝值适用于磁盘备份，磁带只支持备份集。一般用备份集更多，其效率会更高\nconfigure datafile backupcopies for device type disk to 1; # default\n注释：配置生成备份集的个数，默认是1；备份集内会包括（数据文件，控制文件，参数文件）\nconfigure archivelog backupcopies for device type disk to 1; # default\n注释：配置归档日志默认的备份路径\nconfigure maxsetsize to unlimited; # default\n注释：配置单个备份集大小，缺省是不限制，我们可以配置成1g/100m/1024k or other\nconfigure encryption for database off; # default\n注释：配置备份数据加密，是10gr2推出来的新功能，设置为on后。\n可以set encryption on identifyed by youpassword only;加密备份，还原的时候需要提供密码。\nconfigureencryption algorithm &#39;aes128&#39;; # default\n注释：指定备份数据加密的类型。\nconfigure archivelogdeletion policy to none; # default\n注释：配置归档日志在备份后自动删除\nconfigure snapshot controlfile name to &#39;/oracle/product/10.2.0/db_1/dbs/snapcf_itpuxdb.f&#39;; # default\n注释：配置控制文件快照，可以有效的提高控制文件的恢复性。\n查询rman设置中非默认值:\nsql&gt; select name,value from v$rman_configuration;\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>保存策略 (retention policy)<pre><code class=\"sql\">configure retention policy to recovery window of 7 days;\nconfigure retention policy to redundancy 5;\nconfigure retention policy clear;\nconfigure retention policy to none;\n第一种recover window是保持所有足够的备份，可以将数据库系统恢复到最近七天内的任意时刻。任何超过最近七天的数据库备份将被标记为obsolete。\n第二种redundancy 是为了保持可以恢复的最新的5份数据库备份，任何超过最新5份的备份都将被标记为redundancy。它的默认值是1份。\n第三、四：none 可以把使备份保持策略失效，clear 将恢复默认的保持策略\n一般最安全的方法是采用第二种保持策略。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>备份优化 backup optimization<pre><code class=\"sql\">configure backup optimization on;\nconfigure backup optimization off;\nconfigure backup optimization clear;\n默认值为关闭，如果打开，rman将对备份的数据文件及归档等文件进行一种优化的算法。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>默认设备 default device type<pre><code class=\"sql\">configure default device type to disk;\nconfigure default device type to stb;\nconfigure default device type clear;\n是指定所有i/o操作的设备类型是硬盘或者磁带，默认值是硬盘\n磁带的设置是configure default device type to sbt;\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>控制文件 controlfile<pre><code class=\"sql\">configure controlfile autobackup on;\nconfigure controlfile autobackup format for device type disk to &#39;/oracle/backup/conf_%F&#39;;\nconfigure controlfile autobackup clear;\nconfigrue controlfile autobackup format for device type disk clear;\nCONFIGURE SNAPSHOT CONTROLFILE NAME TO &#39;/oracle/backup/scontrofile.snp&#39;;\n--是配置控制文件的快照文件的存放路径和文件名，这个快照文件是在备份期间产生的，用于控制文件的读一致性。\nconfigure snapshot controlfile name clear;\n强制数据库在备份文件或者执行改变数据库结构的命令之后将控制文件自动备份，默认值为关闭。这样可以避免控制文件和catalog丢失后，控制文件仍然可以恢复。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>并行数(通道数) device type disk|stb pallelism n;<pre><code class=\"sql\">configure device type disk|stb parallelism 2;\nconfigure device type disk|stb clear; --用于清除上面的信道配置\nconfigure channel device type disk format &#39;/oracle/backup/rman_%u&#39;;\nconfigure channel device type disk maxpiecesize 100m;\nconfigure channel device type disk rate 1200k;\nconfigure channel 1 device type disk format &#39;/oracle/backup/rman_%u&#39;;\nconfigure channel 2 device type disk format &#39;/oracle/backup/rman_%u&#39;;\nconfigure channel 1 device type disk maxpiecesize 100m;\n配置数据库设备类型的并行度。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>生成备份副本 datafile|archivelog backup copies<pre><code class=\"sql\">configure datafile backup copies for device type disk|stb to 3;\nconfigure archivelog backup copies for device type disk|stb to 3;\n--是设置数据库的归档日志的存放设备类型\nconfigure datafile|archivelog backup copies for device type disk|stb clear\nbackup device type disk database format &#39;/oracle/backup1/%u&#39;, &#39;/oracle/backup2/%u&#39;, &#39;/oracle/backup3/%u&#39;;\n是配置数据库的每次备份的copy数量，oracle的每一次备份都可以有多份完全相同的拷贝。\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>排除选项 exclude<pre><code class=\"sql\">configure exclude for tablespace USERS;\nconfigure exclude for tablespace USERS clear;\n</code></pre>\n</li>\n</ol>\n</li>\n<li><ol>\n<li>备份集大小 maxsetsize<pre><code class=\"sql\">configure maxsetsize to 1g|1000m|1000000k|unlimited;\nconfigure maxsetsize clear;\n</code></pre>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"4-5-set-命令\"><a href=\"#4-5-set-命令\" class=\"headerlink\" title=\"4.5 set 命令\"></a>4.5 set 命令</h3><blockquote>\n<p>&emsp;&emsp;使用set 命令可以定义只应用于当前RMAN会话的设置。 set 命令的设置不是永久的，根据实际需求，可以采用两种方式来使用set 命令。</p>\n<ul>\n<li>在run 代码块外，我们可是执行下面的操作：<pre><code class=\"sql\">（1）使用set echo 命令在消息日志中显示RMAN 命令。\n（2）使用set dbid 命令指定一个数据库的数据库标识符（database identifier： dbid）。\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<ul>\n<li>某些set 命令只能在run代码块的限定范围内使用，常见的有：<blockquote>\n<p>（1）set newname 命令：用于执行表空间时间点恢复（TSPITR）或者数据库复制操作。 该命令允许指定新的数据库数据文件名。 将数据库移动到新的系统中并且文件系统名不同时，我们可以使用这个命令。使用set newname 命令时还需要使用switch 命令。<br>（2）set maxcorrupt for datafile: 使用该命令可以定义RMAN操作失败前锁允许的数据块讹误的最大数据。<br>（3）set archivelog destination: 使用该命令可以修改存储归档的重做日志的archive_log_dest_1 目标。<br>（4）set 命令和until 子句： 使用set命令和set 命令的until 子句可以定义数据库时间点恢复操作锁使用的具体时间点，SCN 或日志序列号。<br>（5）set backup copies命令： 使用该命令可以定义为备份集中的每个备份片应当创建的副本数。<br>（6）set command id: 使用该命令可以关联给定的服务器会话和给定的通道。<br>（7）set controlfile autoback format for device type: 使用该命令可以修改用于控制文件自动备份操作的默认格式。</p>\n</blockquote>\n</li>\n</ul>\n<blockquote>\n<p>&emsp;&emsp;例如： 要执行一个为每个备份片创建两个副本的被操作，并且允许数据文件的最大讹误数为10. 脚本如下：</p>\n</blockquote>\n<pre><code class=\"sql\">run{\n    set maxcorrupt for datafile 3 to 5;\n    set backup copies=2;\n    backup database;\n}\nset until time &quot;to_date(&#39;2016-6-28 17:04:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)&quot;;\n</code></pre>\n<h3 id=\"4-5-crosscheck命令\"><a href=\"#4-5-crosscheck命令\" class=\"headerlink\" title=\"4.5 crosscheck命令\"></a>4.5 crosscheck命令</h3><ul>\n<li>交叉效验RMAN 备份<blockquote>\n<p>&emsp;&emsp;在RMAN目录和物理备份目的地不同步的情况下，我们可以使用crosscheck命令来效验控制文件或恢复目录中的RMAN信息是否与备份介质上的实际物理备份集片相同。<br>&emsp;&emsp;使用crosscheck 命令时，我们关心每个备份集或者副本的状态。 如果使用控制文件，用于备份集片的v$backup_set 视图和用于副本的v$databfile_copy 视图中的status列列出了每个备份集或副本的状态码；如果使用恢复目录，则在备份集片的RC_BACKUP_set和副本的RC_DATAFILE_COPY中列出了每个备份集或副本的状态码。 在不同的备份状态码中，我们关心以下两种状态：<br>&emsp;&emsp;（1）A（Available:可用）：RMAN 认定该项存在于备份介质上<br>&emsp;&emsp;（2）X（Expired:不可用）：这个备份集片或副本上存储的RMAN目录（即控制文件或恢复目录）中，但是并没有物理存在于备份介质上。<br>&emsp;&emsp;使用crosscheck 命令的目的是将RMAN目录的状态设置为AVAILABLE或者EXPIRED。 执行crosscheck时，RMAN检查目录中列出的每个备份集或副本并且判断他们是否存在与备份介质上。 如果备份集或副本不存在与备份介质上，它就会被标记为expired, 并且不能用于任何还原操作；如果备份集或副本存在与备份介质上，它就会维持available状态。 如果以前被标记为expired 的备份集或副本再次存在于备份介质上，crosscheck 命令就会将它标记回available。</p>\n<pre><code class=\"sql\">crosscheck backup;\n</code></pre>\n<p>&emsp;&emsp;可以交叉效验数据文件备份，表空间备份，控制文件备份以及服务器参数文件备份。此外，可以通过识别与备份相关联的标记来选择要交叉效验和特定的备份。 基于使用的设备或者基于一个时间周期，我们甚至可以交叉效验所有的备份。 如：</p>\n<pre><code class=\"sql\">crosscheck backup of datafile 1;\ncrosscheck backup of tablespace users;\ncrosscheck backup of controlfile;\ncrosscheck backup of spfile;\ncrosscheck backup tag=&#39;TEST&#39;;\ncrosscheck backup completed after &#39;sysdate-2&#39;;\ncrosscheck backup completed between &#39;sysdate-5&#39; and &#39;sysdate-2&#39;;\ncrosscheck backup device type disk;\n</code></pre>\n</blockquote>\n</li>\n<li>交叉验证归档日志示例：<pre><code class=\"sql\">RMAN&gt; crosscheck archivelog all;\n</code></pre>\n<blockquote>\n<p>&emsp;&emsp;我们可以基于一个号码或标准（包括时间，具体的或指定范围的SCN或日志序列号）来交叉效验归档的重做日志备份，甚至还可以使用like参数与通配符来交叉效验特定的归档日志备份。 如：</p>\n<pre><code class=\"sql\">crosscheck archivelog like &#39;ARC001.log&#39;;\ncrosscheck archivelog &#39;/oracle/arch/itpuxdb/archivelog/2016_08_02/o1_mf_1_22_cszw2d4g_.arc&#39;;\ncrosscheck archivelog like &#39;%ARC00012.LOG&#39;;\ncrosscheck archivelog from time &quot;to_date(&#39;2016-08-02&#39;,&#39;yyyy-mm-dd&#39;)&quot;;\ncrosscheck archivelog until time &quot;to_date(&#39;2016-08-02&#39;,&#39;yyyy-mm-dd&#39;)&quot;;\ncrosscheck archivelog from sequence 12;\ncrosscheck archivelog until sequence 522;\n--使用crosscheck copy命令还可以交叉效验副本。 包括数据文件副本，控制文件副本，归档重做日志副本以及磁盘上的归档的重做日志。 如：\ncrosscheck copy of datafile 5;\ncrosscheck datafilecopy &#39;/oracle/oradata/itpuxdb/rman_tbs.dbf;\n</code></pre>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"4-6-RMAN-备份的验证validate\"><a href=\"#4-6-RMAN-备份的验证validate\" class=\"headerlink\" title=\"4.6 RMAN 备份的验证validate\"></a>4.6 RMAN 备份的验证validate</h3><blockquote>\n<p>&emsp;&emsp;RMAN 提供的validate命令允许查看给定的备份集和进行验证以确保这个备份集能够被还原。注意，validate 命令必须要获得主键ID。 这个可以用list backup summary命令获取</p>\n<pre><code class=\"sql\">RMAN&gt; list backup summary;\nRMAN&gt; validate backupset 206;\nRMAN&gt; validate backupset 206 check logical;\n</code></pre>\n</blockquote>\n<h3 id=\"4-7-change-命令\"><a href=\"#4-7-change-命令\" class=\"headerlink\" title=\"4.7 change 命令\"></a>4.7 change 命令</h3><blockquote>\n<p>&emsp;&emsp;change 命令允许用户修改备份的状态。我们可能会遇到备份介质设备在某个时间爱你段中无效的情况（如突然断电）。这时，我们就可以使用change 命令来指示这个设备上的备份是不可用的。<br>&emsp;&emsp;解决硬件故障和修复磁盘后，额可以再次执行change 命令，将备份改为可用的状态。也可以将备份修改为不可用的状态。在还原和恢复操作期间，不会考虑哪些不可用的备份，但在执行delete expired命令期间这些备份记录不会被删除。 相关示例：</p>\n<pre><code class=\"sql\">change backup of database tag=&#39;TEST&#39; unavailable;\nchange backup of database like &#39;%TEST%&#39; unavailable;\nchange backupset 206 unavailable;\nchange backupset 206 available;\nchange archivelog &#39;/archivelog/arc0001.log&#39; unavailable;\n</code></pre>\n<p>&emsp;&emsp;可以使用change命令修改归档的重做日志备份的状态。如：将已经备份了指定次数的所有归档的重做日志备份修改为不可用的状态，也可以修改特定设备上的所有备份的状态。</p>\n<pre><code class=\"sql\">change archivelog all backed up 5 times to device type disk unavailable;\nchange backup of database device type disk unavailable;\n</code></pre>\n<p>&emsp;&emsp;可是使用带有delete 参数的change 命令删除备份集，即在备份介质上的物理删除，并且从控制文件和恢复目录中删除。 前提是要知道备份集关键字，可以使用list backup 或 list copy 命令查看。</p>\n<pre><code class=\"sql\">RMAN&gt; list backup;\n</code></pre>\n<p>删除备份集1：</p>\n<pre><code class=\"sql\">RMAN&gt; change backupset 206 delete;\n</code></pre>\n<ul>\n<li>使用通道 ORA_DISK_1<br><code>`</code>sql<br>备份片段列表<br>BP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称</li>\n</ul>\n</blockquote>\n<hr>\n<p>1 1 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK<br>是否确定要删除以上对象 (输入 YES 或 NO)? yes<br>已删除备份片段<br>备份片段句柄=/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK RECID=1 STAMP=723758988<br>1 对象已删除<br>在上面的这个示例中，我们删除了备份集和它关联的备份片。 也可以删除一些备份片。 通过 list backup命令我们可以看到备份片的名称，比如：段名:/oracle/BACKUP/ITPUX_01LI7BSC_1_1.BAK。<br>我们也可以查看备份片的号码，用catalog 用户连接数据库后，查看rc_backup_piece 表，SQL如下：<br>conn rman/rman<br>SQL&gt; select bs_key,bp_key,piece#,handle from rc_backup_piece;<br>BS_KEY BP_KEY PIECE# HANDLE</p>\n<hr>\n<p>52 55 1 /BACKUP/ORCL_02LI47UA_1_1<br>53 56 1 /BACKUP/ORCL_03LI47UF_1_1<br>75 82 1 /BACKUP/ORCL_04LI4816_1_1<br>删除备份片，我们可以用BP_KEY，也可以直接用段名（handle）,如：<br>RMAN&gt; change backuppiece ‘/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK’ delete;<br>使用通道 ORA_DISK_1<br>备份片段列表<br>BP 关键字 BS 关键字 Pc# Cp# 状态 设备类型段名称</p>\n<hr>\n<p>2 2 1 1 AVAILABLE DISK /oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK<br>是否确定要删除以上对象 (输入 YES 或 NO)? yes<br>已删除备份片段<br>备份片段句柄=/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK RECID=2<br>STAMP=723758997<br>1 对象已删除<br>使用备份集片，如：<br>change backuppiece 622 delete;<br>change archivelog until logseq=20 delete;<br>最后，可以使用change backuppiece uncataog命令从目录中删除备份集片。 如果删除最后剩余的备份集片，那么它也将删除备份集记录。如：<br>change backuppiece ‘/oracle/BACKUP/ITPUX_02LI7BSK_1_1.BAK’ uncatalog;</p>\n<pre><code>### 4.8 delete 命令\n&gt;&amp;emsp;&amp;emsp;备份集不是永远存在的。我们可以使用保存策略标记备份有效性和生存期的结束。但是，备份策略的实施不会从RMAN目录中删除备份，而只是将这些备份标记为丢弃状态。\n&gt;&amp;emsp;&amp;emsp;delete 命令对备份和副本的影响很大。通过delete命令，可以删除基于保存标准被标记为丢弃的任何备份，还可以将恢复目录或控制文件中的备份从expired状态变为\n\n* deleted状态\n```sql\ndelete expired;\ndelete obsolete;\n</code></pre><blockquote>\n<p>&emsp;&emsp;执行delete命令时，RMAN会请求用户确认这个删除命令，如果确认了这个删除命令，RMAN 就会完成delete操作。<br>&emsp;&emsp;注意： 如果一个备份被标记为deleted 状态，就不能恢复这个备份。 如果该备份物理可用，我们仍然可以使用dbms_backup_restore过程来恢复这个备份。</p>\n</blockquote>\n<h3 id=\"4-9-restore命令\"><a href=\"#4-9-restore命令\" class=\"headerlink\" title=\"4.9 restore命令\"></a>4.9 restore命令</h3><blockquote>\n<p>&emsp;&emsp;主要功能是从RMAN备份中还原文件，为恢复做准备。<br>使用restore 命令时，该命令会在没有认识提示的情况下重写已经存在的任何文件，除非使用set newname命令。<br><code>`</code>sql<br>set newname for datafile ‘/oracle/app/oradata/itpuxdb/itpux01.dbf’ to ‘E:/app/Administrator/oradata/orcl’;<br>restore database;</p>\n</blockquote>\n<p>restore controlfile from autobackup;<br>restore controlfile to ‘/backup/‘ from autobackup;<br>restore controlfile to ‘/backup’;<br>restore controlfile from autobackup until time “to_date(‘2016-6-27 13:25:00’,’yyyy-mm-dd hh24:mi:ss’)”;<br>restore controlfile from autobackup maxseq 200 maxdays 100;<br>restore spfile to pfile ‘/oracle/backup/spfile.restore’;<br>restore spfile to ‘/oracle/backup/spfile.restore’ from autobackup;<br>restore spfile from autobackup;<br>restore spfile from ‘/oracle/backup/c-1247395743-20160627-00’;<br>restore tablespace tablespace_name ;<br>restore datafile 5;<br>restore datafile ‘/oracle/app/oradata/itpuxdb/USERS01.DBF’;<br>restore database until time “to_date(‘2016-6-28 17:04:00’,’yyyy-mm-dd hh24:mi:ss’)”;<br>restore database until SCN 1000; –注意： 该示例可以将数据库还原到SCN 1000，但是不会包含SCN.<br>restore database until sequence 100 thread 1;</p>\n<p>restore archivelog all;<br>restore archivelog from logseq=20 thread=1;<br>restore archivelog from logseq=20 until logseq=30 thread=1;</p>\n<p>run<br>{<br>set archivelog destination to “d:/arch”;<br>restore archivelog all;<br>}</p>\n<p>restore database check readonly;<br>restore (datafile 5) from datafilecopy</p>\n<pre><code>### 4.10 recover命令\n&gt;&amp;emsp;&amp;emsp;recover 命令用于恢复数据库。该命令可以执行数据库的完全恢复或者时间点恢复。 Recover 命令确定需要哪些归档的重做日志，并且析取和应用他们。 一旦完成重做的应用，我们就只需要使用alter database open命令打开数据库即可。\n```sql\nrecover database\nrecover database noredo; -- 如果联机日志存在，可以用recover database代替\nrecover tablespace tablespace_name ;\nrecover datafile 3;\nrecover datafile &#39;/oracle/app/oradata/itpuxdb/USERS01.DBF&#39;;\nset until time &quot;to_date(&#39;2016-07-05 14:02:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)&quot;;\nrestore database;\nrecover database;\nalter database open resetlogs;\nrecover database until time &quot;to_date(&#39;2016-07-05 14:02:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)&quot;;\nrecover database until SCN 1000;\nrecover database until sequence 100 thread 1;\n</code></pre><h3 id=\"4-10-Switch-命令\"><a href=\"#4-10-Switch-命令\" class=\"headerlink\" title=\"4.10 Switch 命令\"></a>4.10 Switch 命令</h3><blockquote>\n<p>Switch 命令可以修改数据库控制文件中数据文件的位置，以反映Oracle数据库文件新的位置。</p>\n<pre><code class=\"sql\">Switch datafile all; -- 修改控制文件中数据文件位置\n</code></pre>\n</blockquote>\n<h3 id=\"4-10-blockrecover\"><a href=\"#4-10-blockrecover\" class=\"headerlink\" title=\"4.10 blockrecover\"></a>4.10 blockrecover</h3><blockquote>\n<p>一般出现数据块错误时，都会有错误消息：<br>ORA-01578: ORACLE data block corrupted (file #18,block #88)<br>如果没有BMR时，我们必须从一个备份中恢复这个数据文件，在恢复过程中，用户不能使用该数据块文件中的所有数据。<br>用BMR恢复就很简单，只需要执行blockrecover命令即可：</p>\n<pre><code class=\"sql\">blockrecover datafile 1 block 88;\n</code></pre>\n<p>如果有必要，可以同时恢复多个数据文件的多个数据块。如：</p>\n<pre><code class=\"sql\">blockrecover datafile 18 block 16,17,88,108;\nblcokrecover datafile 18 block 88 datafile 19 blcok 188;\n</code></pre>\n<p>&emsp;&emsp;查询v$database_block_corruption视图可以查看讹误数据块的详细信息。 如下所示，使用具有corruption list restore 参数的blockrecover命令可以方便地修正v$database_block_corruption 视图中的讹误数据块。<br>&emsp;&emsp;blockrecover corruption list restore until time ‘SYSDATE-5’;<br>这条命令将还原讹误列表中最近5天的所有讹误数据块。 在上面的命令中，还可以使用until time 和 until sequence.</p>\n</blockquote>\n<h3 id=\"4-10convert命令\"><a href=\"#4-10convert命令\" class=\"headerlink\" title=\"4.10convert命令\"></a>4.10convert命令</h3><blockquote>\n<p>&emsp;&emsp; Oracle 10g R2以后支持手工跨平台移动数据库，即使这些平台具有不同的尾数格式（endian format）。 尾数格式与字节排序有关，它有两种不同的格式，即大尾数和小尾数。 如果在不同尾数字节格式的平台之间移动数据库，就需要手工操作，并且使用RMAN的convert datafile 或者 convert tablespace命令来将传送的数据文件转换为正确的尾数格式。</p>\n<pre><code class=\"sql\">convert tablespace ITPUX to platform=&#39;AIX-Based Systems (64-bit)&#39;\ndb_file_name_convert=&#39;/oracle/app/oradata/itpux&#39;,&#39;/oracle/itpux&#39;;\nconvert datafile &#39;/oracle/app/oradata/itpux/itpux01.DBF&#39; from platform\n&#39;AIX-Based Systems (64-bit)&#39; db_file_name_convert &#39;/oracle/app/oradata/itpux&#39;,&#39;/oracle/app/itpux&#39;;\n</code></pre>\n</blockquote>\n"},{"title":"Nginx配置文件详解","date":"2019-04-07T01:25:00.000Z","author":"Kyle Liu","<!-- img":"/source/images/xxx.jpg -->","top":false,"cover":false,"<!-- coverImg":"/images/1.jpg -->","password":"8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92","toc":true,"mathjax":true,"summary":"这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要","_content":"\n\n# Nginx配置文件详解\n```\n# 运行用户\nuser    www;\n\n# 启动进程,通常设置成和cpu的数量相等,或设置为auto\nworker_processes    1;\n\n# 设置全局错误日志存储位置\n# error_log     /var/wwwlogs/error.log;\n# error_log     /var/wwwlogs/error.log  notice;\n# error_log     /var/wwwlogs/error.log  info;\n\n# 设置pid文件存储位置\n# pid   /var/wwwlogs/nginx.pid;\n\n# 工作模式及连接数上限\nevents {\n\n    # epoll是多路复用IO(I/O Multiplexing)中的一种方式\n    use   epoll; \n\n    # 单个后台worker process进程的最大并发链接数    \n    worker_connections  1024;\n\n    # 最大客户连接数，由于浏览器默认使用两个并发连接，注意：此值不是一个nginx参数！！！！！！！！！！！\n    # 作为普通HTTP服务器\n    # max_clients = worker_processes * worker_connections / 2\n    # 作为反向代理服务器\n    # max_clients = worker_processes * worker_connections / 4\n\n}\n\n\nhttp {\n\n    # 设定mime类型,类型由mime.type文件定义\n    include         mime.types;\n    default_type    application/octet-stream;\n\n    # 设定日志格式\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    # 日志存储路径与格式\n    access_log  /var/wwwlogs/access.log  main;\n\n    # sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，\n    # 对于普通应用，必须设为 on,\n    # 如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，\n    # 以平衡磁盘与网络I/O处理速度，降低系统的uptime.\n    sendfile        on;\n    # tcp_nopush    on;\n\n    # 连接超时时间\n    keepalive_timeout   60;\n    tcp_nodelay         on;\n\n    # 开启gzip压缩\n    gzip                on;\n    gzip_min_length     1k;\n    gzip_buffers        4 16k;\n    gzip_http_version   1.0;\n    gzip_comp_level     2;\n    gzip_types          text/plain application/x-javascript text/css application/xml;\n    gzip_vary           on;\n\n    # 设定请求缓冲\n    client_header_buffer_size    128k;\n    large_client_header_buffers  4 128k;\n\n    # 设定虚拟主机配置\n    server {\n\n        # 监听80端口\n        listen    80;\n\n        # 定义域名 www.test.com 多个使用空格隔开\n        server_name  www.test.com;\n\n        # 默认网站根目录位置\n        root html;\n\n        # 定义首页索引文件的名称\n        index index.php index.html index.htm;\n\n        # 设定本虚拟主机的访问日志\n        access_log /var/wwwlogs/nginx.access.log    main;\n\n        # 默认请求\n        location / {\n            # 定义首页索引文件的名称\n            index   index.php index.html index.htm;\n        }\n\n        # 定义错误提示页面\n        error_page  500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n        # 静态文件，nginx自己处理\n        location ~ ^/(images|javascript|js|css|flash|media|static)/ {\n            # 过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。\n            expires 30d;\n        }\n\n        # PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.\n        location ~ .php$ {\n            fastcgi_pass    127.0.0.1:9000;\n            fastcgi_index   index.php;\n            fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            include         fastcgi_params;\n        }\n\n        # 禁止访问 .tpl 文件\n        location ~ /.tpl {\n            deny    all;\n        }\n\n    }\n}\n```","source":"_posts/linux/Nginx配置文件详解.md","raw":"---\ntitle: Nginx配置文件详解\ndate: 2019-04-07 09:25:00\nauthor: Kyle Liu\n<!-- img: /source/images/xxx.jpg -->\ntop: false\ncover: false\n<!-- coverImg: /images/1.jpg -->\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: true\nmathjax: true\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Linux\ntags:\n  - Linux\n  - Nginx\n---\n\n\n# Nginx配置文件详解\n```\n# 运行用户\nuser    www;\n\n# 启动进程,通常设置成和cpu的数量相等,或设置为auto\nworker_processes    1;\n\n# 设置全局错误日志存储位置\n# error_log     /var/wwwlogs/error.log;\n# error_log     /var/wwwlogs/error.log  notice;\n# error_log     /var/wwwlogs/error.log  info;\n\n# 设置pid文件存储位置\n# pid   /var/wwwlogs/nginx.pid;\n\n# 工作模式及连接数上限\nevents {\n\n    # epoll是多路复用IO(I/O Multiplexing)中的一种方式\n    use   epoll; \n\n    # 单个后台worker process进程的最大并发链接数    \n    worker_connections  1024;\n\n    # 最大客户连接数，由于浏览器默认使用两个并发连接，注意：此值不是一个nginx参数！！！！！！！！！！！\n    # 作为普通HTTP服务器\n    # max_clients = worker_processes * worker_connections / 2\n    # 作为反向代理服务器\n    # max_clients = worker_processes * worker_connections / 4\n\n}\n\n\nhttp {\n\n    # 设定mime类型,类型由mime.type文件定义\n    include         mime.types;\n    default_type    application/octet-stream;\n\n    # 设定日志格式\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    # 日志存储路径与格式\n    access_log  /var/wwwlogs/access.log  main;\n\n    # sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，\n    # 对于普通应用，必须设为 on,\n    # 如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，\n    # 以平衡磁盘与网络I/O处理速度，降低系统的uptime.\n    sendfile        on;\n    # tcp_nopush    on;\n\n    # 连接超时时间\n    keepalive_timeout   60;\n    tcp_nodelay         on;\n\n    # 开启gzip压缩\n    gzip                on;\n    gzip_min_length     1k;\n    gzip_buffers        4 16k;\n    gzip_http_version   1.0;\n    gzip_comp_level     2;\n    gzip_types          text/plain application/x-javascript text/css application/xml;\n    gzip_vary           on;\n\n    # 设定请求缓冲\n    client_header_buffer_size    128k;\n    large_client_header_buffers  4 128k;\n\n    # 设定虚拟主机配置\n    server {\n\n        # 监听80端口\n        listen    80;\n\n        # 定义域名 www.test.com 多个使用空格隔开\n        server_name  www.test.com;\n\n        # 默认网站根目录位置\n        root html;\n\n        # 定义首页索引文件的名称\n        index index.php index.html index.htm;\n\n        # 设定本虚拟主机的访问日志\n        access_log /var/wwwlogs/nginx.access.log    main;\n\n        # 默认请求\n        location / {\n            # 定义首页索引文件的名称\n            index   index.php index.html index.htm;\n        }\n\n        # 定义错误提示页面\n        error_page  500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n        # 静态文件，nginx自己处理\n        location ~ ^/(images|javascript|js|css|flash|media|static)/ {\n            # 过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。\n            expires 30d;\n        }\n\n        # PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.\n        location ~ .php$ {\n            fastcgi_pass    127.0.0.1:9000;\n            fastcgi_index   index.php;\n            fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            include         fastcgi_params;\n        }\n\n        # 禁止访问 .tpl 文件\n        location ~ /.tpl {\n            deny    all;\n        }\n\n    }\n}\n```","slug":"linux/Nginx配置文件详解","published":1,"updated":"2019-05-03T16:10:48.559Z","_id":"cjv89xfcx003vi0cdgftkgaiy","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Nginx配置文件详解\"><a href=\"#Nginx配置文件详解\" class=\"headerlink\" title=\"Nginx配置文件详解\"></a>Nginx配置文件详解</h1><pre><code># 运行用户\nuser    www;\n\n# 启动进程,通常设置成和cpu的数量相等,或设置为auto\nworker_processes    1;\n\n# 设置全局错误日志存储位置\n# error_log     /var/wwwlogs/error.log;\n# error_log     /var/wwwlogs/error.log  notice;\n# error_log     /var/wwwlogs/error.log  info;\n\n# 设置pid文件存储位置\n# pid   /var/wwwlogs/nginx.pid;\n\n# 工作模式及连接数上限\nevents {\n\n    # epoll是多路复用IO(I/O Multiplexing)中的一种方式\n    use   epoll; \n\n    # 单个后台worker process进程的最大并发链接数    \n    worker_connections  1024;\n\n    # 最大客户连接数，由于浏览器默认使用两个并发连接，注意：此值不是一个nginx参数！！！！！！！！！！！\n    # 作为普通HTTP服务器\n    # max_clients = worker_processes * worker_connections / 2\n    # 作为反向代理服务器\n    # max_clients = worker_processes * worker_connections / 4\n\n}\n\n\nhttp {\n\n    # 设定mime类型,类型由mime.type文件定义\n    include         mime.types;\n    default_type    application/octet-stream;\n\n    # 设定日志格式\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39; &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39; &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    # 日志存储路径与格式\n    access_log  /var/wwwlogs/access.log  main;\n\n    # sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，\n    # 对于普通应用，必须设为 on,\n    # 如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，\n    # 以平衡磁盘与网络I/O处理速度，降低系统的uptime.\n    sendfile        on;\n    # tcp_nopush    on;\n\n    # 连接超时时间\n    keepalive_timeout   60;\n    tcp_nodelay         on;\n\n    # 开启gzip压缩\n    gzip                on;\n    gzip_min_length     1k;\n    gzip_buffers        4 16k;\n    gzip_http_version   1.0;\n    gzip_comp_level     2;\n    gzip_types          text/plain application/x-javascript text/css application/xml;\n    gzip_vary           on;\n\n    # 设定请求缓冲\n    client_header_buffer_size    128k;\n    large_client_header_buffers  4 128k;\n\n    # 设定虚拟主机配置\n    server {\n\n        # 监听80端口\n        listen    80;\n\n        # 定义域名 www.test.com 多个使用空格隔开\n        server_name  www.test.com;\n\n        # 默认网站根目录位置\n        root html;\n\n        # 定义首页索引文件的名称\n        index index.php index.html index.htm;\n\n        # 设定本虚拟主机的访问日志\n        access_log /var/wwwlogs/nginx.access.log    main;\n\n        # 默认请求\n        location / {\n            # 定义首页索引文件的名称\n            index   index.php index.html index.htm;\n        }\n\n        # 定义错误提示页面\n        error_page  500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n        # 静态文件，nginx自己处理\n        location ~ ^/(images|javascript|js|css|flash|media|static)/ {\n            # 过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。\n            expires 30d;\n        }\n\n        # PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.\n        location ~ .php$ {\n            fastcgi_pass    127.0.0.1:9000;\n            fastcgi_index   index.php;\n            fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            include         fastcgi_params;\n        }\n\n        # 禁止访问 .tpl 文件\n        location ~ /.tpl {\n            deny    all;\n        }\n\n    }\n}\n</code></pre>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/1_qq_27922023.jpg","name":"码酱","introduction":"我不是大佬，只是在追寻大佬的脚步","url":"http://luokangyuan.com/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"},{"avatar":"http://image.luokangyuan.com/avatar.jpg","name":"ja_rome","introduction":"平凡的脚步也可以走出伟大的行程","url":"ttps://me.csdn.net/jlh912008548","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Nginx配置文件详解\"><a href=\"#Nginx配置文件详解\" class=\"headerlink\" title=\"Nginx配置文件详解\"></a>Nginx配置文件详解</h1><pre><code># 运行用户\nuser    www;\n\n# 启动进程,通常设置成和cpu的数量相等,或设置为auto\nworker_processes    1;\n\n# 设置全局错误日志存储位置\n# error_log     /var/wwwlogs/error.log;\n# error_log     /var/wwwlogs/error.log  notice;\n# error_log     /var/wwwlogs/error.log  info;\n\n# 设置pid文件存储位置\n# pid   /var/wwwlogs/nginx.pid;\n\n# 工作模式及连接数上限\nevents {\n\n    # epoll是多路复用IO(I/O Multiplexing)中的一种方式\n    use   epoll; \n\n    # 单个后台worker process进程的最大并发链接数    \n    worker_connections  1024;\n\n    # 最大客户连接数，由于浏览器默认使用两个并发连接，注意：此值不是一个nginx参数！！！！！！！！！！！\n    # 作为普通HTTP服务器\n    # max_clients = worker_processes * worker_connections / 2\n    # 作为反向代理服务器\n    # max_clients = worker_processes * worker_connections / 4\n\n}\n\n\nhttp {\n\n    # 设定mime类型,类型由mime.type文件定义\n    include         mime.types;\n    default_type    application/octet-stream;\n\n    # 设定日志格式\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39; &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39; &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    # 日志存储路径与格式\n    access_log  /var/wwwlogs/access.log  main;\n\n    # sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，\n    # 对于普通应用，必须设为 on,\n    # 如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，\n    # 以平衡磁盘与网络I/O处理速度，降低系统的uptime.\n    sendfile        on;\n    # tcp_nopush    on;\n\n    # 连接超时时间\n    keepalive_timeout   60;\n    tcp_nodelay         on;\n\n    # 开启gzip压缩\n    gzip                on;\n    gzip_min_length     1k;\n    gzip_buffers        4 16k;\n    gzip_http_version   1.0;\n    gzip_comp_level     2;\n    gzip_types          text/plain application/x-javascript text/css application/xml;\n    gzip_vary           on;\n\n    # 设定请求缓冲\n    client_header_buffer_size    128k;\n    large_client_header_buffers  4 128k;\n\n    # 设定虚拟主机配置\n    server {\n\n        # 监听80端口\n        listen    80;\n\n        # 定义域名 www.test.com 多个使用空格隔开\n        server_name  www.test.com;\n\n        # 默认网站根目录位置\n        root html;\n\n        # 定义首页索引文件的名称\n        index index.php index.html index.htm;\n\n        # 设定本虚拟主机的访问日志\n        access_log /var/wwwlogs/nginx.access.log    main;\n\n        # 默认请求\n        location / {\n            # 定义首页索引文件的名称\n            index   index.php index.html index.htm;\n        }\n\n        # 定义错误提示页面\n        error_page  500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n        # 静态文件，nginx自己处理\n        location ~ ^/(images|javascript|js|css|flash|media|static)/ {\n            # 过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。\n            expires 30d;\n        }\n\n        # PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.\n        location ~ .php$ {\n            fastcgi_pass    127.0.0.1:9000;\n            fastcgi_index   index.php;\n            fastcgi_param   SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            include         fastcgi_params;\n        }\n\n        # 禁止访问 .tpl 文件\n        location ~ /.tpl {\n            deny    all;\n        }\n\n    }\n}\n</code></pre>"}],"PostAsset":[],"PostCategory":[{"post_id":"cjv88f7bd0004i0cde0o4q5sn","category_id":"cjv88f7bn0006i0cdp04w8h1y","_id":"cjv88f7bt000ai0cd523f5606"},{"post_id":"cjv88f7bl0005i0cdvdngg1bl","category_id":"cjv88f7br0008i0cdhcnnswiy","_id":"cjv88f7bv000ci0cdu5o44ypw"},{"post_id":"cjv88f7ca000mi0cdrb8colqu","category_id":"cjv88f7cc000ni0cdk2koyfxz","_id":"cjv88f7cd000qi0cdz382chx6"},{"post_id":"cjv88taa5001ai0cdmu793yqw","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv88tlvk001di0cd6om0sji4"},{"post_id":"cjv88xbb1001ki0cdl4yxl2eh","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv88xhp3001ni0cdap4wf6z4"},{"post_id":"cjv8901zt001si0cdfpulodj2","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv8901zw001vi0cdci2bd3oc"},{"post_id":"cjv890wc9001zi0cdw7o8anjj","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv8911ph0022i0cdquaiy96z"},{"post_id":"cjv894o560029i0cddjl3443m","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv8954x3002ci0cdxwfi3473"},{"post_id":"cjv898bqp002gi0cdpuuvmyb0","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv898gqa002ji0cdu5tib3af"},{"post_id":"cjv89bjfw002li0cd8edkr8ui","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89c0rx002oi0cd7th1z229"},{"post_id":"cjv89en3f002xi0cdqjbci7kl","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89fhf10030i0cdyb61am26"},{"post_id":"cjv89h3jq0037i0cdgpurj3r7","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89hp86003ai0cdiww2pue9"},{"post_id":"cjv89lll5003fi0cdrdocs6sb","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89lzzb003ii0cd7qkq8w8h"},{"post_id":"cjv89q4wx003li0cdlqpdycvl","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89qfq8003qi0cdlmuo8z8i"},{"post_id":"cjv89uuc4003ri0cdvwnmt5vt","category_id":"cjv88jaul000zi0cd8vi2pbvq","_id":"cjv89vbkh003ui0cdploo8ze9"},{"post_id":"cjv89xfcx003vi0cdgftkgaiy","category_id":"cjv88f7br0008i0cdhcnnswiy","_id":"cjv89xuys003yi0cd34d0g3wm"}],"PostTag":[{"post_id":"cjv88f7bd0004i0cde0o4q5sn","tag_id":"cjv88f7bp0007i0cd7ssrtbrq","_id":"cjv88f7bv000ei0cd7xt9u9je"},{"post_id":"cjv88f7bd0004i0cde0o4q5sn","tag_id":"cjv88f7br0009i0cdfy6sikgj","_id":"cjv88f7bw000fi0cd37jki1ot"},{"post_id":"cjv88f7bd0004i0cde0o4q5sn","tag_id":"cjv88f7bu000bi0cdzny5mpcx","_id":"cjv88f7bw000hi0cdqc6ex6xx"},{"post_id":"cjv88f7bl0005i0cdvdngg1bl","tag_id":"cjv88f7bv000di0cdnuuu7ojf","_id":"cjv88f7by000ji0cdijvd3655"},{"post_id":"cjv88f7bl0005i0cdvdngg1bl","tag_id":"cjv88f7bw000gi0cdqse1eqse","_id":"cjv88f7by000ki0cd0ta9xrj8"},{"post_id":"cjv88f7bl0005i0cdvdngg1bl","tag_id":"cjv88f7bx000ii0cd47i3bgm0","_id":"cjv88f7bz000li0cd7dhfs0fz"},{"post_id":"cjv88f7ca000mi0cdrb8colqu","tag_id":"cjv88f7cc000oi0cd7har3t2e","_id":"cjv88f7ce000ri0cdo8v73ds1"},{"post_id":"cjv88f7ca000mi0cdrb8colqu","tag_id":"cjv88f7cd000pi0cd2pif96d2","_id":"cjv88f7ce000si0cdscn8xpbs"},{"post_id":"cjv88taa5001ai0cdmu793yqw","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv88tlvj001bi0cdt18zlx3e"},{"post_id":"cjv88taa5001ai0cdmu793yqw","tag_id":"cjv88jy2i0017i0cd6cg42byd","_id":"cjv88tlvk001ei0cdk1mxzcvi"},{"post_id":"cjv88taa5001ai0cdmu793yqw","tag_id":"cjv88uc89001fi0cd3sqkcgux","_id":"cjv88uc8a001hi0cd7zokp581"},{"post_id":"cjv88taa5001ai0cdmu793yqw","tag_id":"cjv88uc89001gi0cdzyhgb6ha","_id":"cjv88uc8a001ii0cd7s7qlg37"},{"post_id":"cjv88xbb1001ki0cdl4yxl2eh","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv88xhp2001li0cdl6xx1d14"},{"post_id":"cjv88xbb1001ki0cdl4yxl2eh","tag_id":"cjv88zknb001qi0cddqnaqk0o","_id":"cjv88zknb001ri0cd1mgihbi6"},{"post_id":"cjv8901zt001si0cdfpulodj2","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv8901zv001ti0cdmyw1vz9d"},{"post_id":"cjv8901zt001si0cdfpulodj2","tag_id":"cjv88jy2i0017i0cd6cg42byd","_id":"cjv8901zw001wi0cddcdqevlr"},{"post_id":"cjv8901zt001si0cdfpulodj2","tag_id":"cjv8906ux001xi0cdscnvbluj","_id":"cjv8906uy001yi0cdjvu21ddu"},{"post_id":"cjv890wc9001zi0cdw7o8anjj","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv8911pg0020i0cd1kh03361"},{"post_id":"cjv890wc9001zi0cdw7o8anjj","tag_id":"cjv88zknb001qi0cddqnaqk0o","_id":"cjv8923qg0025i0cd0y8hl4iz"},{"post_id":"cjv890wc9001zi0cdw7o8anjj","tag_id":"cjv8925ar0026i0cdte3y1vxb","_id":"cjv8925at0027i0cdpgk64bq0"},{"post_id":"cjv894o560029i0cddjl3443m","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv8954x3002ai0cdb325qbz6"},{"post_id":"cjv894o560029i0cddjl3443m","tag_id":"cjv88zknb001qi0cddqnaqk0o","_id":"cjv8954x3002bi0cdxra42bgd"},{"post_id":"cjv894o560029i0cddjl3443m","tag_id":"cjv895b1t002ei0cdwr8uvjna","_id":"cjv895b1t002fi0cd6jz8p2s2"},{"post_id":"cjv898bqp002gi0cdpuuvmyb0","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv898gq6002hi0cd68zj5263"},{"post_id":"cjv898bqp002gi0cdpuuvmyb0","tag_id":"cjv88zknb001qi0cddqnaqk0o","_id":"cjv898gq9002ii0cd06ghbxkw"},{"post_id":"cjv898bqp002gi0cdpuuvmyb0","tag_id":"cjv8925ar0026i0cdte3y1vxb","_id":"cjv898gqb002ki0cd6i1sveg8"},{"post_id":"cjv89bjfw002li0cd8edkr8ui","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89c0rw002mi0cdxan0gru2"},{"post_id":"cjv89bjfw002li0cd8edkr8ui","tag_id":"cjv89dktc002si0cduq74jimg","_id":"cjv89dktd002ti0cdxn8tdr1z"},{"post_id":"cjv89bjfw002li0cd8edkr8ui","tag_id":"cjv89dnml002ui0cdjbwhbkeh","_id":"cjv89dnmm002vi0cd9co7pu7n"},{"post_id":"cjv89bjfw002li0cd8edkr8ui","tag_id":"cjv88jy2i0017i0cd6cg42byd","_id":"cjv89dxxz002wi0cdp5twpmwt"},{"post_id":"cjv89en3f002xi0cdqjbci7kl","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89fhez002yi0cdys0z8o6z"},{"post_id":"cjv89en3f002xi0cdqjbci7kl","tag_id":"cjv88jy2i0017i0cd6cg42byd","_id":"cjv89fhf10032i0cdzrmzjqcj"},{"post_id":"cjv89en3f002xi0cdqjbci7kl","tag_id":"cjv89fr7y0033i0cd9ox20ere","_id":"cjv89fr810035i0cdbrf71j55"},{"post_id":"cjv89en3f002xi0cdqjbci7kl","tag_id":"cjv89fr800034i0cdnj4jyxwa","_id":"cjv89fr820036i0cdyibmym0x"},{"post_id":"cjv89h3jq0037i0cdgpurj3r7","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89hp860038i0cdvwxaj09i"},{"post_id":"cjv89h3jq0037i0cdgpurj3r7","tag_id":"cjv89i1s8003bi0cd9gese0gj","_id":"cjv89i1sa003di0cdvwzqi4zv"},{"post_id":"cjv89h3jq0037i0cdgpurj3r7","tag_id":"cjv89i1s9003ci0cdu9fr3y4v","_id":"cjv89i1sa003ei0cd1fnisi2p"},{"post_id":"cjv89lll5003fi0cdrdocs6sb","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89lzz9003gi0cdtdj4aqkz"},{"post_id":"cjv89lll5003fi0cdrdocs6sb","tag_id":"cjv89qd0j003mi0cd09pjjd17","_id":"cjv89qd0l003ni0cdz4rotiso"},{"post_id":"cjv89q4wx003li0cdlqpdycvl","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89qfq7003oi0cdhlaqx8q9"},{"post_id":"cjv89q4wx003li0cdlqpdycvl","tag_id":"cjv89qd0j003mi0cd09pjjd17","_id":"cjv89qfq8003pi0cdbpage7at"},{"post_id":"cjv89uuc4003ri0cdvwnmt5vt","tag_id":"cjv88jdka0011i0cd2lnq2exs","_id":"cjv89vbkf003si0cd4j3kowph"},{"post_id":"cjv89uuc4003ri0cdvwnmt5vt","tag_id":"cjv89qd0j003mi0cd09pjjd17","_id":"cjv89vbkh003ti0cdb01b4exe"},{"post_id":"cjv89xfcx003vi0cdgftkgaiy","tag_id":"cjv88f7bv000di0cdnuuu7ojf","_id":"cjv89xuyp003wi0cdxk76hxc4"},{"post_id":"cjv89xfcx003vi0cdgftkgaiy","tag_id":"cjv89yqu90040i0cdb8l1iktm","_id":"cjv89yqub0041i0cd6u7u5zaj"}],"Tag":[{"name":"PHP","_id":"cjv88f7bp0007i0cd7ssrtbrq"},{"name":"Laravel","_id":"cjv88f7br0009i0cdfy6sikgj"},{"name":"MySQL","_id":"cjv88f7bu000bi0cdzny5mpcx"},{"name":"Linux","_id":"cjv88f7bv000di0cdnuuu7ojf"},{"name":"Apache","_id":"cjv88f7bw000gi0cdqse1eqse"},{"name":"SSL","_id":"cjv88f7bx000ii0cd47i3bgm0"},{"name":"Golang","_id":"cjv88f7cc000oi0cd7har3t2e"},{"name":"Gin","_id":"cjv88f7cd000pi0cd2pif96d2"},{"name":"Oracle","_id":"cjv88jdka0011i0cd2lnq2exs"},{"name":"Goldengate","_id":"cjv88jrtd0013i0cd17pk5rq8"},{"name":"北方容灾","_id":"cjv88jrte0014i0cdog08opp2"},{"name":"备份容灾","_id":"cjv88jy2i0017i0cd6cg42byd"},{"name":"RAC","_id":"cjv88uc89001fi0cd3sqkcgux"},{"name":"DataGuard","_id":"cjv88uc89001gi0cdzyhgb6ha"},{"name":"SQL","_id":"cjv88zknb001qi0cddqnaqk0o"},{"name":"GoldenGate","_id":"cjv8906ux001xi0cdscnvbluj"},{"name":"DML","_id":"cjv8925ar0026i0cdte3y1vxb"},{"name":"DDL","_id":"cjv895b1t002ei0cdwr8uvjna"},{"name":"Exdp","_id":"cjv89di7v002qi0cdnarmu2tb"},{"name":"Expdp","_id":"cjv89dktc002si0cduq74jimg"},{"name":"Impdp","_id":"cjv89dnml002ui0cdjbwhbkeh"},{"name":"Exp","_id":"cjv89fr7y0033i0cd9ox20ere"},{"name":"Imp","_id":"cjv89fr800034i0cdnj4jyxwa"},{"name":"LogMiner","_id":"cjv89i1s8003bi0cd9gese0gj"},{"name":"日志分析","_id":"cjv89i1s9003ci0cdu9fr3y4v"},{"name":"RMAN","_id":"cjv89qd0j003mi0cd09pjjd17"},{"name":"Nginx","_id":"cjv89yqu90040i0cdb8l1iktm"}]}}